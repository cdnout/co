const EventEmitter=require("events"),ZXing=require("./zxing")(),Visibility=require("visibilityjs"),StateMachine=require("fsm-as-promised");class ScanProvider{constructor(t,e,i,s,a){this.scanPeriod=s,this.captureImage=i,this.refractoryPeriod=a,this._emitter=t,this._frameCount=0,this._analyzer=e,this._lastResult=null,this._active=!1}start(){this._active=!0,requestAnimationFrame(()=>this._scan())}stop(){this._active=!1}scan(){return this._analyze(!1)}_analyze(t){let e=this._analyzer.analyze();if(!e)return null;let{result:i,canvas:s}=e;if(!i)return null;if(t&&i===this._lastResult)return null;clearTimeout(this.refractoryTimeout),this.refractoryTimeout=setTimeout(()=>{this._lastResult=null},this.refractoryPeriod);let a=this.captureImage?s.toDataURL("image/webp",.8):null;this._lastResult=i;let r={content:i};return a&&(r.image=a),r}_scan(){if(!this._active)return;if(requestAnimationFrame(()=>this._scan()),++this._frameCount!==this.scanPeriod)return;this._frameCount=0;let t=this._analyze(!0);t&&setTimeout(()=>{this._emitter.emit("scan",t.content,t.image||null)},0)}}class Analyzer{constructor(t){this.video=t,this.imageBuffer=null,this.sensorLeft=null,this.sensorTop=null,this.sensorWidth=null,this.sensorHeight=null,this.canvas=document.createElement("canvas"),this.canvas.style.display="none",this.canvasContext=null,this.decodeCallback=ZXing.Runtime.addFunction(function(t,e,i,s){var a=new Uint8Array(ZXing.HEAPU8.buffer,t,e),r=String.fromCharCode.apply(null,a);0===i&&(window.zxDecodeResult=""),window.zxDecodeResult+=r})}analyze(){if(!this.video.videoWidth)return null;if(!this.imageBuffer){let t=this.video.videoWidth,e=this.video.videoHeight;return this.sensorWidth=t,this.sensorHeight=e,this.sensorLeft=Math.floor(t/2-this.sensorWidth/2),this.sensorTop=Math.floor(e/2-this.sensorHeight/2),this.canvas.width=this.sensorWidth,this.canvas.height=this.sensorHeight,this.canvasContext=this.canvas.getContext("2d"),this.imageBuffer=ZXing._resize(this.sensorWidth,this.sensorHeight),null}this.canvasContext.drawImage(this.video,this.sensorLeft,this.sensorTop,this.sensorWidth,this.sensorHeight);let t=this.canvasContext.getImageData(0,0,this.sensorWidth,this.sensorHeight).data;for(var e=0,i=0;e<t.length;e+=4,i++){let[s,a,r]=[t[e],t[e+1],t[e+2]];ZXing.HEAPU8[this.imageBuffer+i]=Math.trunc((s+a+r)/3)}if(ZXing._decode_qr(this.decodeCallback))return null;let s=window.zxDecodeResult;return null!=s?{result:s,canvas:this.canvas}:null}}class Scanner extends EventEmitter{constructor(t){super(),this.video=this._configureVideo(t),this.mirror=!1!==t.mirror,this.backgroundScan=t.backgroundScan||!1,this._continuous=!1!==t.continuous,this._analyzer=new Analyzer(this.video),this._camera=null;let e=t.captureImage||!1,i=t.scanPeriod||1,s=t.refractoryPeriod||5e3;this._scanner=new ScanProvider(this,this._analyzer,e,i,s),this._fsm=this._createStateMachine(),Visibility.change((t,e)=>{"visible"===e?setTimeout(()=>{this._fsm.can("activate")&&this._fsm.activate()},0):!this.backgroundScan&&this._fsm.can("deactivate")&&this._fsm.deactivate()}),this.addListener("active",()=>{this.video.classList.remove("inactive"),this.video.classList.add("active")}),this.addListener("inactive",()=>{this.video.classList.remove("active"),this.video.classList.add("inactive")}),this.emit("inactive")}scan(){return this._scanner.scan()}async start(t=null){this._fsm.can("start")?await this._fsm.start(t):(await this._fsm.stop(),await this._fsm.start(t))}async stop(){this._fsm.can("stop")&&await this._fsm.stop()}set captureImage(t){this._scanner.captureImage=t}get captureImage(){return this._scanner.captureImage}set scanPeriod(t){this._scanner.scanPeriod=t}get scanPeriod(){return this._scanner.scanPeriod}set refractoryPeriod(t){this._scanner.refractoryPeriod=t}get refractoryPeriod(){return this._scanner.refractoryPeriod}set continuous(t){this._continuous=t,t&&"active"===this._fsm.current?this._scanner.start():this._scanner.stop()}get continuous(){return this._continuous}set mirror(t){this._mirror=t,t?(this.video.style.MozTransform="scaleX(-1)",this.video.style.webkitTransform="scaleX(-1)",this.video.style.OTransform="scaleX(-1)",this.video.style.msFilter="FlipH",this.video.style.filter="FlipH",this.video.style.transform="scaleX(-1)"):(this.video.style.MozTransform=null,this.video.style.webkitTransform=null,this.video.style.OTransform=null,this.video.style.msFilter=null,this.video.style.filter=null,this.video.style.transform=null)}get mirror(){return this._mirror}async _enableScan(t){if(this._camera=t||this._camera,!this._camera)throw new Error("Camera is not defined.");let e=await this._camera.start();this.video.src=e,this._continuous&&this._scanner.start()}_disableScan(){this.video.src="",this._scanner&&this._scanner.stop(),this._camera&&this._camera.stop()}_configureVideo(t){if(t.video&&"VIDEO"!==t.video.tagName)throw new Error("Video must be a <video> element.");var e=t.video||document.createElement("video");return e.setAttribute("autoplay","autoplay"),e}_createStateMachine(){return StateMachine.create({initial:"stopped",events:[{name:"start",from:"stopped",to:"started"},{name:"stop",from:["started","active","inactive"],to:"stopped"},{name:"activate",from:["started","inactive"],to:["active","inactive"],condition:function(t){return"visible"===Visibility.state()||this.backgroundScan?"active":"inactive"}},{name:"deactivate",from:["started","active"],to:"inactive"}],callbacks:{onenteractive:async t=>{await this._enableScan(t.args[0]),this.emit("active")},onleaveactive:()=>{this._disableScan(),this.emit("inactive")},onenteredstarted:async t=>{await this._fsm.activate(t.args[0])}}})}}module.exports=Scanner;