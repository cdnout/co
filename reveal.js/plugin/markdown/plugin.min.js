import marked from"marked";const DEFAULT_SLIDE_SEPARATOR="^\r?\n---\r?\n$",DEFAULT_NOTES_SEPARATOR="notes?:",DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR="\\.element\\s*?(.+?)$",DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR="\\.slide:\\s*?(\\S.+?)$",SCRIPT_END_PLACEHOLDER="__SCRIPT_END__",CODE_LINE_NUMBER_REGEX=/\[([\s\d,|-]*)\]/,HTML_ESCAPE_MAP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Plugin=()=>{let t;function e(t){var e=(t.querySelector("[data-template]")||t.querySelector("script")||t).textContent,r=(e=e.replace(new RegExp(SCRIPT_END_PLACEHOLDER,"g"),"<\/script>")).match(/^\n?(\s*)/)[1].length,a=e.match(/^\n?(\t*)/)[1].length;return a>0?e=e.replace(new RegExp("\\n?\\t{"+a+"}","g"),"\n"):r>1&&(e=e.replace(new RegExp("\\n? {"+r+"}","g"),"\n")),e}function r(t){for(var e=t.attributes,r=[],a=0,n=e.length;a<n;a++){var o=e[a].name,s=e[a].value;/data\-(markdown|separator|vertical|notes)/gi.test(o)||(s?r.push(o+'="'+s+'"'):r.push(o))}return r.join(" ")}function a(t){return(t=t||{}).separator=t.separator||DEFAULT_SLIDE_SEPARATOR,t.notesSeparator=t.notesSeparator||DEFAULT_NOTES_SEPARATOR,t.attributes=t.attributes||"",t}function n(t,e){e=a(e);var r=t.split(new RegExp(e.notesSeparator,"mgi"));return 2===r.length&&(t=r[0]+'<aside class="notes">'+marked(r[1].trim())+"</aside>"),'<script type="text/template">'+(t=t.replace(/<\/script>/g,SCRIPT_END_PLACEHOLDER))+"<\/script>"}function o(t,e){e=a(e);for(var r,o,s,i=new RegExp(e.separator+(e.verticalSeparator?"|"+e.verticalSeparator:""),"mg"),u=new RegExp(e.separator),d=0,l=!0,c=[];r=i.exec(t);){!(o=u.test(r[0]))&&l&&c.push([]),s=t.substring(d,r.index),o&&l?c.push(s):c[c.length-1].push(s),d=i.lastIndex,l=o}(l?c:c[c.length-1]).push(t.substring(d));for(var E="",p=0,A=c.length;p<A;p++)c[p]instanceof Array?(E+="<section "+e.attributes+">",c[p].forEach(function(t){E+="<section data-markdown>"+n(t,e)+"</section>"}),E+="</section>"):E+="<section "+e.attributes+" data-markdown>"+n(c[p],e)+"</section>";return E}function s(t){return new Promise(function(a){var s=[];[].slice.call(t.querySelectorAll("[data-markdown]:not([data-markdown-parsed])")).forEach(function(t,a){t.getAttribute("data-markdown").length?s.push(function(t){return new Promise(function(e,r){var a=new XMLHttpRequest,n=t.getAttribute("data-markdown"),o=t.getAttribute("data-charset");null!=o&&""!=o&&a.overrideMimeType("text/html; charset="+o),a.onreadystatechange=function(t,a){4===a.readyState&&(a.status>=200&&a.status<300||0===a.status?e(a,n):r(a,n))}.bind(this,t,a),a.open("GET",n,!0);try{a.send()}catch(t){console.warn("Failed to get the Markdown file "+n+". Make sure that the presentation and the file are served by a HTTP server and the file can be found there. "+t),e(a,n)}})}(t).then(function(e,a){t.outerHTML=o(e.responseText,{separator:t.getAttribute("data-separator"),verticalSeparator:t.getAttribute("data-separator-vertical"),notesSeparator:t.getAttribute("data-separator-notes"),attributes:r(t)})},function(e,r){t.outerHTML='<section data-state="alert">ERROR: The attempt to fetch '+r+" failed with HTTP status "+e.status+".Check your browser's JavaScript console for more details.<p>Remember that you need to serve the presentation HTML from a HTTP server.</p></section>"})):t.getAttribute("data-separator")||t.getAttribute("data-separator-vertical")||t.getAttribute("data-separator-notes")?t.outerHTML=o(e(t),{separator:t.getAttribute("data-separator"),verticalSeparator:t.getAttribute("data-separator-vertical"),notesSeparator:t.getAttribute("data-separator-notes"),attributes:r(t)}):t.innerHTML=n(e(t))}),Promise.all(s).then(a)})}function i(t,e,r){var a,n,o=new RegExp(r,"mg"),s=new RegExp('([^"= ]+?)="([^"]+?)"|(data-[^"= ]+?)(?=[" ])',"mg"),i=t.nodeValue;if(a=o.exec(i)){var u=a[1];for(i=i.substring(0,a.index)+i.substring(o.lastIndex),t.nodeValue=i;n=s.exec(u);)n[2]?e.setAttribute(n[1],n[2]):e.setAttribute(n[3],"");return!0}return!1}function u(){var r=t.getRevealElement().querySelectorAll("[data-markdown]:not([data-markdown-parsed])");return[].slice.call(r).forEach(function(t){t.setAttribute("data-markdown-parsed",!0);var r=t.querySelector("aside.notes"),a=e(t);t.innerHTML=marked(a),function t(e,r,a,n,o){if(null!=r&&null!=r.childNodes&&r.childNodes.length>0)for(var s=r,u=0;u<r.childNodes.length;u++){var d=r.childNodes[u];if(u>0)for(var l=u-1;l>=0;){var c=r.childNodes[l];if("function"==typeof c.setAttribute&&"BR"!=c.tagName){s=c;break}l-=1}var E=e;"section"==d.nodeName&&(E=d,s=d),"function"!=typeof d.setAttribute&&d.nodeType!=Node.COMMENT_NODE||t(E,d,s,n,o)}r.nodeType==Node.COMMENT_NODE&&0==i(r,a,n)&&i(r,e,o)}(t,t,null,t.getAttribute("data-element-attributes")||t.parentNode.getAttribute("data-element-attributes")||DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR,t.getAttribute("data-attributes")||t.parentNode.getAttribute("data-attributes")||DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR),r&&t.appendChild(r)}),Promise.resolve()}return{id:"markdown",init:function(e){t=e;let r=new marked.Renderer;return r.code=((t,e)=>{let r="";return CODE_LINE_NUMBER_REGEX.test(e)&&(r=`data-line-numbers="${r=e.match(CODE_LINE_NUMBER_REGEX)[1].trim()}"`,e=e.replace(CODE_LINE_NUMBER_REGEX,"").trim()),`<pre><code ${r} class="${e}">${t=function(t){return t.replace(/([&<>'"])/g,t=>HTML_ESCAPE_MAP[t])}(t)}</code></pre>`}),marked.setOptions({renderer:r,...t.getConfig().markdown}),s(t.getRevealElement()).then(u)},processSlides:s,convertSlides:u,slidify:o,marked:marked}};export default Plugin;