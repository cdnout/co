!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet"],e):e((t=t||self).GeoSearch={},t.L)}(this,function(t,u){function a(){return(a=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n,r=arguments[e];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function o(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}function i(t,e){return(i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e,n){return(s=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(t){return}}}()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);r=new(Function.bind.apply(t,r));return n&&i(r,n.prototype),r}).apply(null,arguments)}function c(t,e,n,r){void 0===e&&(e=""),void 0===r&&(r={});var o=document.createElement(t);return e&&(o.className=e),Object.keys(r).forEach(function(t){var e;"function"==typeof r[t]?(e=0===t.indexOf("on")?t.substr(2).toLowerCase():t,o.addEventListener(e,r[t])):"html"===t?o.innerHTML=r[t]:"text"===t?o.innerText=r[t]:o.setAttribute(t,r[t])}),n&&n.appendChild(o),o}function l(t){t.preventDefault(),t.stopPropagation()}u=u&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u;function h(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return e.filter(Boolean).join(" ").trim()}function p(e,t){e&&e.classList&&(Array.isArray(t)?t:[t]).forEach(function(t){e.classList.contains(t)||e.classList.add(t)})}function r(e,t){e&&e.classList&&(Array.isArray(t)?t:[t]).forEach(function(t){e.classList.contains(t)&&e.classList.remove(t)})}var d,f=13,m=40,v=38,y=[f,27,m,v,37,39],n=((U=k.prototype).onFocus=function(){p(this.form,"active")},U.onBlur=function(){r(this.form,"active")},U.onSubmit=function(t){try{var e=this;return l(t),r(n=e.container,"error"),p(n,"pending"),Promise.resolve(e.handleSubmit({query:e.input.value})).then(function(){r(e.container,"pending")})}catch(t){return Promise.reject(t)}var n},U.onInput=function(){this.hasError&&(r(this.container,"error"),this.hasError=!1)},U.onKeyUp=function(t){27===t.keyCode&&(r(this.container,["pending","active"]),this.input.value="",document.body.focus(),document.body.blur())},U.onKeyPress=function(t){t.keyCode===f&&this.onSubmit(t)},U.setQuery=function(t){this.input.value=t},k),g=((q=L.prototype).render=function(t,r){var o=this;void 0===t&&(t=[]),this.clear(),t.forEach(function(t,e){var n=o.resultItem.cloneNode(!0);n.setAttribute("data-key",""+e),n.innerHTML=r({result:t}),o.container.appendChild(n)}),0<t.length&&(p(this.container.parentElement,"open"),p(this.container,"active")),this.results=t},q.select=function(n){return Array.from(this.container.children).forEach(function(t,e){return(e===n?p:r)(t,"active")}),this.selected=n,this.results[n]},q.count=function(){return this.results?this.results.length:0},q.clear=function(){for(this.selected=-1;this.container.lastChild;)this.container.removeChild(this.container.lastChild);r(this.container.parentElement,"open"),r(this.container,"active")},L),e={position:"topleft",style:"button",showMarker:!0,showPopup:!1,popupFormat:function(t){return""+t.result.label},resultFormat:function(t){return""+t.result.label},marker:{icon:u&&u.Icon?new u.Icon.Default:void 0,draggable:!1},maxMarkers:1,maxSuggestions:5,retainZoomLevel:!1,animateZoom:!0,searchLabel:"Enter address",notFoundMessage:"Sorry, that address could not be found.",messageHideDelay:3e3,zoomLevel:18,classNames:{container:"leaflet-bar leaflet-control leaflet-control-geosearch",button:"leaflet-bar-part leaflet-bar-part-single",resetButton:"reset",msgbox:"leaflet-bar message",form:"",input:""},autoComplete:!0,autoCompleteDelay:250,autoClose:!1,keepResult:!1,updateMap:!0},b="Leaflet must be loaded before instantiating the GeoSearch control",E={options:a({},e),classNames:a({},e.classNames),initialize:function(t){var r,o,i,s,e=this;if(!u)throw new Error(b);if(!t.provider)throw new Error("Provider is missing from options");this.options=a({},this.options,{},t),this.classNames=a({},this.classNames,{},t.classNames),this.markers=new u.FeatureGroup,this.classNames.container+=" leaflet-geosearch-"+this.options.style,this.searchElement=new n({searchLabel:this.options.searchLabel,classNames:{container:this.classNames.container,form:this.classNames.form,input:this.classNames.input},handleSubmit:function(t){return e.onSubmit(t)}}),this.button=c("a",this.classNames.button,this.searchElement.container,{title:this.options.searchLabel,href:"#",onClick:function(t){return e.onClick(t)}}),u.DomEvent.disableClickPropagation(this.button),this.resetButton=c("a",this.classNames.resetButton,this.searchElement.form,{text:"Ã—",href:"#",onClick:function(){return e.clearResults(null,!0)}}),u.DomEvent.disableClickPropagation(this.resetButton),this.options.autoComplete&&(this.resultList=new g({handleClick:function(t){t=t.result;e.searchElement.input.value=t.label,e.onSubmit({query:t.label,data:t})}}),this.searchElement.form.appendChild(this.resultList.container),this.searchElement.input.addEventListener("keyup",(r=function(t){return e.autoSearch(t)},void 0===(o=this.options.autoCompleteDelay)&&(o=250),void 0===i&&(i=!1),function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];s&&clearTimeout(s),s=setTimeout(function(){s=null,i||r.apply(void 0,e)},o),i&&!s&&r.apply(void 0,e)}),!0),this.searchElement.input.addEventListener("keydown",function(t){return e.selectResult(t)},!0),this.searchElement.input.addEventListener("keydown",function(t){return e.clearResults(t,!0)},!0)),this.searchElement.form.addEventListener("click",function(t){t.preventDefault()},!1)},onAdd:function(t){var e=this.options,n=e.showMarker,e=e.style;return this.map=t,n&&this.markers.addTo(t),"bar"===e&&(t=t.getContainer().querySelector(".leaflet-control-container"),this.container=c("div","leaflet-control-geosearch leaflet-geosearch-bar"),this.container.appendChild(this.searchElement.form),t.appendChild(this.container)),u.DomEvent.disableClickPropagation(this.searchElement.form),this.searchElement.container},onRemove:function(){var t;return null==(t=this.container)||t.remove(),this},onClick:function(t){t.preventDefault(),t.stopPropagation();var e=this.searchElement,t=e.container,e=e.input;t.classList.contains("active")?(r(t,"active"),this.clearResults()):(p(t,"active"),e.focus())},selectResult:function(t){var e,n;-1!==[f,m,v].indexOf(t.keyCode)&&(t.preventDefault(),t.keyCode!==f?(e=this.resultList.count()-1)<0||(n=this.resultList.selected,n=t.keyCode===m?n+1:n-1,n=this.resultList.select(n<0?e:e<n?0:n),this.searchElement.input.value=n.label):(n=this.resultList.select(this.resultList.selected),this.onSubmit({query:this.searchElement.input.value,data:n})))},clearResults:function(t,e){var n;void 0===e&&(e=!1),t&&27!==t.keyCode||(t=(n=this.options).autoComplete,!e&&n.keepResult||(this.searchElement.input.value="",this.markers.clearLayers()),t&&this.resultList.clear())},autoSearch:function(t){try{var e=this;if(-1<y.indexOf(t.keyCode))return Promise.resolve();var n=t.target.value,r=e.options.provider,n=n.length?Promise.resolve(r.search({query:n})).then(function(t){t=t.slice(0,e.options.maxSuggestions),e.resultList.render(t,e.options.resultFormat)}):void e.resultList.clear();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},onSubmit:function(e){try{var n=this;return Promise.resolve(n.options.provider.search(e)).then(function(t){t&&0<t.length&&n.showResult(t[0],e)})}catch(e){return Promise.reject(e)}},showResult:function(t,e){var n=this.options,r=n.autoClose,o=n.updateMap,n=this.markers.getLayers();n.length>=this.options.maxMarkers&&this.markers.removeLayer(n[0]);e=this.addMarker(t,e);o&&this.centerMap(t),this.map.fireEvent("geosearch/showlocation",{location:t,marker:e}),r&&this.closeResults()},closeResults:function(){var t=this.searchElement.container;t.classList.contains("active")&&r(t,"active"),this.clearResults()},addMarker:function(t,e){var n=this,r=this.options,o=r.marker,i=r.showPopup,s=r.popupFormat,a=new u.Marker([t.y,t.x],o),r=t.label;return"function"==typeof s&&(r=s({query:e,result:t})),a.bindPopup(r),this.markers.addLayer(a),i&&a.openPopup(),o.draggable&&a.on("dragend",function(t){n.map.fireEvent("geosearch/marker/dragend",{location:a.getLatLng(),event:t})}),a},centerMap:function(t){var e=this.options,n=e.retainZoomLevel,r=e.animateZoom,e=t.bounds?new u.LatLngBounds(t.bounds):new u.LatLng(t.y,t.x).toBounds(10),t=e.isValid()?e:this.markers.getBounds();!n&&e.isValid()?this.map.fitBounds(t,{animate:r}):this.map.setView(t.getCenter(),this.getZoom(),{animate:r})},getZoom:function(){var t=this.options,e=t.zoomLevel;return t.retainZoomLevel?this.map.getZoom():e}};function L(t){var e=this,n=t.handleClick,t=t.classNames,t=void 0===t?{}:t;this.selected=-1,this.results=[],this.onClick=function(t){"function"!=typeof e.handleClick||(t=t.target)&&e.container.contains(t)&&t.hasAttribute("data-key")&&(t=Number(t.getAttribute("data-key")),e.clear(),e.handleClick({result:e.results[t]}))},this.handleClick=n,this.container=c("div",h("results",t.container)),this.container.addEventListener("click",this.onClick,!0),this.resultItem=c("div",h(t.item))}function k(t){var e=this,n=t.handleSubmit,r=t.searchLabel,t=t.classNames,t=void 0===t?{}:t;this.hasError=!1,this.container=c("div",h("geosearch",t.container)),this.form=c("form",["",t.form].join(" "),this.container,{autocomplete:"none",onClick:l,onDblClick:l,touchStart:l,touchEnd:l}),this.input=c("input",["glass",t.input].join(" "),this.form,{type:"text",placeholder:r||"search",onInput:this.onInput,onKeyUp:function(t){return e.onKeyUp(t)},onKeyPress:function(t){return e.onKeyPress(t)},onFocus:this.onFocus,onBlur:this.onBlur,onClick:function(){e.input.focus(),e.input.dispatchEvent(new Event("focus"))}}),this.handleSubmit=n}function w(){if(!u)throw new Error(b);for(var t=u.Control.extend(E),e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return s(t,n)}(N=d=d||{})[N.SEARCH=0]="SEARCH",N[N.REVERSE=1]="REVERSE";var C,x,P=((x=B.prototype).getParamString=function(t){void 0===t&&(t={});var e=a({},this.options.params,{},t);return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")},x.getUrl=function(t,e){return t+"?"+this.getParamString(e)},x.search=function(t){try{var e=this,n=e.endpoint({query:t.query,type:d.SEARCH});return Promise.resolve(fetch(n)).then(function(t){return Promise.resolve(t.json()).then(function(t){return e.parse({data:t})})})}catch(t){return Promise.reject(t)}},B),S=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var n=e.prototype;return n.endpoint=function(){return"https://places-dsn.algolia.net/1/places/query"},n.findBestMatchLevelIndex=function(t){var e=t.find(function(t){return"full"===t.matchLevel})||t.find(function(t){return"partial"===t.matchLevel});return e?t.indexOf(e):0},n.getLabel=function(t){var e;return[null==(e=t.locale_names)?void 0:e.default[this.findBestMatchLevelIndex(t._highlightResult.locale_names.default)],null==(e=t.city)?void 0:e.default[this.findBestMatchLevelIndex(t._highlightResult.city.default)],t.administrative[this.findBestMatchLevelIndex(t._highlightResult.administrative)],null==(e=t.postcode)?void 0:e[this.findBestMatchLevelIndex(t._highlightResult.postcode)],null==(t=t.country)?void 0:t.default].filter(Boolean).join(", ")},n.parse=function(t){var e=this;return t.data.hits.map(function(t){return{x:t._geoloc.lng,y:t._geoloc.lat,label:e.getLabel(t),bounds:null,raw:t}})},n.search=function(t){var e=t.query;try{var n=this,r="string"==typeof e?{query:e}:e;return Promise.resolve(fetch(n.endpoint(),{method:"POST",body:JSON.stringify(a({},n.options.params,{},r))})).then(function(t){return Promise.resolve(t.json()).then(function(t){return n.parse({data:t})})})}catch(t){return Promise.reject(t)}},e}(P),R=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).searchUrl="https://dev.virtualearth.net/REST/v1/Locations",t}o(t,e);var n=t.prototype;return n.endpoint=function(t){var e=t.query,e="string"==typeof e?{q:e}:e;return e.jsonp=t.jsonp,this.getUrl(this.searchUrl,e)},n.parse=function(t){return 0===t.data.resourceSets.length?[]:t.data.resourceSets[0].resources.map(function(t){return{x:t.point.coordinates[1],y:t.point.coordinates[0],label:t.address.formattedAddress,bounds:[[t.bbox[0],t.bbox[1]],[t.bbox[2],t.bbox[3]]],raw:t}})},n.search=function(t){var n,r,o,e=t.query;try{var i=this,s="BING_JSONP_CB_"+Date.now();return Promise.resolve((n=i.endpoint({query:e,jsonp:s}),r=s,(o=c("script",null,document.body)).setAttribute("type","text/javascript"),new Promise(function(e){window[r]=function(t){o.remove(),delete window[r],e(t)},o.setAttribute("src",n)}))).then(function(t){return i.parse({data:t})})}catch(t){return Promise.reject(t)}},t}(P),j=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).searchUrl="https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/find",t}o(t,e);var n=t.prototype;return n.endpoint=function(t){t=t.query,t="string"==typeof t?{text:t}:t;return t.f="json",this.getUrl(this.searchUrl,t)},n.parse=function(t){return t.data.locations.map(function(t){return{x:t.feature.geometry.x,y:t.feature.geometry.y,label:t.name,bounds:[[t.extent.ymin,t.extent.xmin],[t.extent.ymax,t.extent.xmax]],raw:t}})},t}(P),U=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).searchUrl="https://maps.googleapis.com/maps/api/geocode/json",t}o(t,e);var n=t.prototype;return n.endpoint=function(t){t=t.query;return this.getUrl(this.searchUrl,"string"==typeof t?{address:t}:t)},n.parse=function(t){return t.data.results.map(function(t){return{x:t.geometry.location.lng,y:t.geometry.location.lat,label:t.formatted_address,bounds:[[t.geometry.viewport.southwest.lat,t.geometry.viewport.southwest.lng],[t.geometry.viewport.northeast.lat,t.geometry.viewport.northeast.lng]],raw:t}})},t}(P),q=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).searchUrl="https://geocode.search.hereapi.com/v1/geocode",t}o(t,e);var n=t.prototype;return n.endpoint=function(t){t=t.query;return this.getUrl(this.searchUrl,"string"==typeof t?{q:t}:t)},n.parse=function(t){return t.data.items.map(function(t){return{x:t.position.lng,y:t.position.lat,label:t.address.label,bounds:null,raw:t}})},t}(P),e=function(r){function t(t){var e;void 0===t&&(t={});var n="https://nominatim.openstreetmap.org";return(e=r.call(this,t)||this).searchUrl=t.searchUrl||n+"/search",e.reverseUrl=t.reverseUrl||n+"/reverse",e}o(t,r);var e=t.prototype;return e.endpoint=function(t){var e=t.query,t=t.type,e="string"==typeof e?{q:e}:e;return e.format="json",t!==d.REVERSE?this.getUrl(this.searchUrl,e):this.getUrl(this.reverseUrl,e)},e.parse=function(t){return(Array.isArray(t.data)?t.data:[t.data]).map(function(t){return{x:Number(t.lon),y:Number(t.lat),label:t.display_name,bounds:[[parseFloat(t.boundingbox[0]),parseFloat(t.boundingbox[2])],[parseFloat(t.boundingbox[1]),parseFloat(t.boundingbox[3])]],raw:t}})},t}(P),N=(o(A,C=e),A),x=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).searchUrl="https://api.opencagedata.com/geocode/v1/json",t}o(t,e);var n=t.prototype;return n.endpoint=function(t){t=t.query,t="string"==typeof t?{q:t}:t;return t.format="json",this.getUrl(this.searchUrl,t)},n.parse=function(t){return t.data.results.map(function(t){return{x:t.geometry.lng,y:t.geometry.lat,label:t.formatted,bounds:[[t.bounds.southwest.lat,t.bounds.southwest.lng],[t.bounds.northeast.lat,t.bounds.northeast.lng]],raw:t}})},n.search=function(t){try{return Promise.resolve(t.query.length<2?[]:e.prototype.search.call(this,t))}catch(t){return Promise.reject(t)}},t}(P);function A(t){return C.call(this,a({},t,{searchUrl:"https://locationiq.org/v1/search.php",reverseUrl:"https://locationiq.org/v1/reverse.php"}))||this}function B(t){void 0===t&&(t={}),this.options=t}t.AlgoliaProvider=S,t.BingProvider=R,t.EsriProvider=j,t.GeoSearchControl=w,t.GoogleProvider=U,t.HereProvider=q,t.JsonProvider=P,t.LocationIQProvider=N,t.OpenCageProvider=x,t.OpenStreetMapProvider=e,t.SearchControl=w,t.SearchElement=n});