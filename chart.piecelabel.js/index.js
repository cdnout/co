/**
 * [Chart.PieceLabel.js]{@link https://github.com/emn178/Chart.PieceLabel.js}
 *
 * @version 0.15.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2017-2018
 * @license MIT
 */
(function(){function m(){this.drawDataset=this.drawDataset.bind(this)}function r(a,c){if(a.options.pieceLabel){var b=1;Array.isArray(a.options.pieceLabel)&&(b=a.options.pieceLabel.length);if(!a.pieceLabel||b!==a.pieceLabel.length){a.pieceLabel=[];for(var g=0;g<b;++g)a.pieceLabel.push(new m)}}else a.pieceLabel&&delete a.pieceLabel;if(a.pieceLabel)for(b=0;b<a.pieceLabel.length;++b)a.pieceLabel[b][c](a,b)}"undefined"===typeof Chart?console.warn("Can not find Chart object."):(Array.isArray||(Array.isArray=
function(a){return"[object Array]"===Object.prototype.toString.call(a)}),m.prototype.beforeDatasetsUpdate=function(a,c){this.parseOptions(a,c);if("outside"===this.position){var b=1.5*this.fontSize+this.outsidePadding;a.chartArea.top+=b;a.chartArea.bottom-=b}},m.prototype.afterDatasetsDraw=function(a,c){this.parseOptions(a,c);this.labelBounds=[];a.config.data.datasets.forEach(this.drawDataset)},m.prototype.drawDataset=function(a){var c=this.ctx,b=this.chartInstance,g=a._meta[Object.keys(a._meta)[0]];
this.totalPercentage=0;this.total=null;for(var f=0;f<g.data.length;f++){var l=g.data[f],d=l._view;if(this.shouldRenderData(d)){switch(this.render){case "value":var e=a.data[f];this.format&&(e=this.format(e));e=e.toString();break;case "label":e=b.config.data.labels[f];break;case "image":e=this.images[f]?this.loadImage(this.images[f]):"";break;default:percentage=this.getPercentage(d,a,f),e=percentage+"%"}"function"===typeof this.render&&(e=this.render({label:b.config.data.labels[f],value:a.data[f],
percentage:percentage,dataset:a,index:f}),e=null===e||void 0===e?"":"object"===typeof e?this.loadImage(e):e.toString());if(e){c.save();c.beginPath();c.font=Chart.helpers.fontString(this.fontSize,this.fontStyle,this.fontFamily);var k=0;if("outside"===this.position||"border"===this.position){var n=d.outerRadius/2;var h=this.fontSize+this.textMargin;var p=d.startAngle+(d.endAngle-d.startAngle)/2;if("border"===this.position)var m=(d.outerRadius-n)/2+n;else"outside"===this.position&&(this.arc||(h=this.textMargin),
m=d.outerRadius-n+n+h);p={x:d.x+Math.cos(p)*m,y:d.y+Math.sin(p)*m};"outside"===this.position&&(this.arc||(h+=this.measureText(e).width/2),p.x=p.x<d.x?p.x-h:p.x+h,k=d.outerRadius+h)}else n=d.innerRadius,p=l.tooltipPosition();h=this.fontColor;"function"===typeof h?h=h({label:b.config.data.labels[f],value:a.data[f],percentage:percentage,text:e,backgroundColor:a.backgroundColor[f],dataset:a,index:f}):"string"!==typeof h&&(h=h[f]||this.options.defaultFontColor);if(this.arc)k||(k=(n+d.outerRadius)/2),c.fillStyle=
h,c.textBaseline="middle",this.drawArcText(e,k,d,this.overlap);else{var q=this.measureText(e);d=p.x-q.width/2;n=p.x+q.width/2;k=p.y-q.height/2;q=p.y+q.height/2;(this.overlap||("outside"===this.position?this.checkTextBound(d,n,k,q):l.inRange(d,k)&&l.inRange(d,q)&&l.inRange(n,k)&&l.inRange(n,q)))&&this.fillText(e,p,h)}c.restore()}}}},m.prototype.shouldRenderData=function(a){return"polarArea"===this.chartInstance.config.type?0!==a.outerRadius:0!==a.circumference||this.showZero},m.prototype.getPercentage=
function(a,c,b){if("polarArea"===this.chartInstance.config.type){if(null===this.total)for(a=this.total=0;a<c.data.length;++a)this.total+=c.data[a];c=c.data[b]/this.total*100}else c=a.circumference/this.options.circumference*100;c=parseFloat(c.toFixed(this.precision));this.showActualPercentages||(this.totalPercentage+=c,100<this.totalPercentage&&(c-=this.totalPercentage-100,c=parseFloat(c.toFixed(this.precision))));return c},m.prototype.parseOptions=function(a,c){var b=a.options.pieceLabel;Array.isArray(b)&&
(b=b[c]);this.chartInstance=a;this.ctx=a.chart.ctx;this.options=a.config.options;this.render=b.render||b.mode;this.position=b.position||"default";this.arc=b.arc;this.format=b.format;this.precision=b.precision||0;this.fontSize=b.fontSize||this.options.defaultFontSize;this.fontColor=b.fontColor||this.options.defaultFontColor;this.fontStyle=b.fontStyle||this.options.defaultFontStyle;this.fontFamily=b.fontFamily||this.options.defaultFontFamily;this.shadowOffsetX=b.shadowOffsetX||3;this.shadowOffsetY=
b.shadowOffsetY||3;this.shadowColor=b.shadowColor||"rgba(0,0,0,0.3)";this.shadowBlur=b.shadowBlur||6;this.textShadow=b.textShadow||!1;this.hasTooltip=a.tooltip._active&&a.tooltip._active.length;this.showZero=b.showZero;this.overlap=b.overlap;this.images=b.images||[];this.outsidePadding=b.outsidePadding||2;this.textMargin=b.textMargin||2;this.showActualPercentages=b.showActualPercentages||!1},m.prototype.checkTextBound=function(a,c,b,g){for(var f=this.labelBounds,l=0;l<f.length;++l){for(var d=f[l],
e=[[a,b],[a,g],[c,b],[c,g]],k=0;k<e.length;++k){var n=e[k][0],h=e[k][1];if(n>=d.left&&n<=d.right&&h>=d.top&&h<=d.bottom)return!1}e=[[d.left,d.top],[d.left,d.bottom],[d.right,d.top],[d.right,d.bottom]];for(k=0;k<e.length;++k)if(n=e[k][0],h=e[k][1],n>=a&&n<=c&&h>=b&&h<=g)return!1}f.push({left:a,right:c,top:b,bottom:g});return!0},m.prototype.measureText=function(a){if("object"===typeof a)return{width:a.width,height:a.height};var c=0;a=a.split("\n");for(var b=0;b<a.length;++b){var g=this.ctx.measureText(a[b]);
g.width>c&&(c=g.width)}return{width:c,height:this.fontSize*a.length}},m.prototype.fillText=function(a,c,b){var g=this.ctx;if("object"===typeof a)g.drawImage(a,c.x-a.width/2,c.y-a.height/2,a.width,a.height);else{g.save();g.fillStyle=b;g.textBaseline="top";g.textAlign="center";this.textShadow&&(g.shadowOffsetX=this.shadowOffsetX,g.shadowOffsetY=this.shadowOffsetY,g.shadowColor=this.shadowColor,g.shadowBlur=this.shadowBlur);a=a.split("\n");for(b=0;b<a.length;b++)g.fillText(a[b],c.x,c.y-this.fontSize/
2*a.length+this.fontSize*b);g.restore()}},m.prototype.loadImage=function(a){var c=new Image;c.src=a.src;c.width=a.width;c.height=a.height;return c},m.prototype.drawArcText=function(a,c,b,g){var f=this.ctx,l=b.x,d=b.y,e=b.startAngle;b=b.endAngle;f.save();f.translate(l,d);f.textAlign="left";d=b-e;e+=Math.PI/2;b+=Math.PI/2;var k=e;l=this.measureText(a);e+=(b-(l.width/c+e))/2;if(g||!(b-e>d))if("string"===typeof a){f.rotate(e);a=a.split("\n");g=0;e=[];b=0;"border"===this.position&&(b=(a.length-1)*this.fontSize/
2);for(d=0;d<a.length;++d)l=f.measureText(a[d]),l.width>g&&(g=l.width),e.push(l.width);for(d=0;d<a.length;++d){k=a[d];var n=(a.length-1-d)*-this.fontSize+b;f.save();f.rotate((g-e[d])/2/c);for(var h=0;h<k.length;h++){var m=k.charAt(h);l=f.measureText(m);f.save();f.translate(0,-1*c);f.fillText(m,0,n);f.restore();f.rotate(l.width/c)}f.restore()}}else f.rotate((k+b)/2),f.translate(0,-1*c),this.fillText(a,{x:0,y:0});f.restore()},Chart.pluginService.register({name:"PieceLabel",beforeDatasetsUpdate:function(a){r(a,
"beforeDatasetsUpdate")},afterDatasetsDraw:function(a){r(a,"afterDatasetsDraw")}}))})();
