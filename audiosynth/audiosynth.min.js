var Synth,AudioSynth,AudioSynthInstrument;!function(){var a=window.URL||window.webkitURL,b=window.Blob;if(!a||!b)throw new Error("This browser does not support AudioSynth");var c=!1,d=null,e=function(a,b){return[new Uint8Array([b,b>>8]),new Uint8Array([b,b>>8,b>>16,b>>24])][a]},g=function(a,b,c,d){Object.defineProperty(this,a,{value:b,writable:!!c,enumerable:!!d})},h=function(a,b,c){g.call(this,a,b,c,!0)};AudioSynthInstrument=function(){this.__init__.apply(this,arguments)};var i=g.bind(AudioSynthInstrument.prototype),j=h.bind(AudioSynthInstrument.prototype);i("__init__",function(a,b,d){if(!c)throw new Error("AudioSynthInstrument can only be instantiated from the createInstrument method of the AudioSynth object.");g.call(this,"_parent",a),h.call(this,"name",b),g.call(this,"_soundID",d)}),j("play",function(a,b,c){return this._parent.play(this._soundID,a,b,c)}),j("generate",function(a,b,c){return this._parent.generate(this._soundID,a,b,c)}),AudioSynth=function l(){return d instanceof l?d:(this.__init__(),this)},i=g.bind(AudioSynth.prototype),j=h.bind(AudioSynth.prototype),i("_debug",!1,!0),i("_bitsPerSample",16),i("_channels",1),i("_sampleRate",44100,!0),j("setSampleRate",function(a){return this._sampleRate=Math.max(Math.min(0|a,44100),4e3),this._clearCache(),this._sampleRate}),j("getSampleRate",function(){return this._sampleRate}),i("_volume",32768,!0),j("setVolume",function(a){return a=parseFloat(a),isNaN(a)&&(a=0),a=Math.round(32768*a),this._volume=Math.max(Math.min(0|a,32768),0),this._clearCache(),this._volume}),j("getVolume",function(){return Math.round(1e4*(this._volume/32768))/1e4}),i("_notes",{C:261.63,"C#":277.18,D:293.66,"D#":311.13,E:329.63,F:346.23,"F#":369.99,G:392,"G#":415.3,A:440,"A#":466.16,B:493.88}),i("_fileCache",[],!0),i("_temp",{},!0),i("_sounds",[],!0),i("_mod",[function(a,b,c,d){return Math.sin(2*Math.PI*(a/b)*c+d)}]),i("_resizeCache",function(){for(var a=this._fileCache,b=this._sounds.length;a.length<b;){for(var c=[],d=0;8>d;d++){var e={};for(var f in this._notes)e[f]={};c.push(e)}a.push(c)}}),i("_clearCache",function(){this._fileCache=[],this._resizeCache()}),j("generate",function(c,d,f,g){var h=this._sounds[c];if(!h)for(var i=0;i<this._sounds.length;i++)if(this._sounds[i].name==c){h=this._sounds[i],c=i;break}if(!h)throw new Error("Invalid sound or sound ID: "+c);var j=(new Date).valueOf();this._temp={},f|=0,f=Math.min(8,Math.max(1,f));var k=g?parseFloat(g):2;if("undefined"==typeof this._notes[d])throw new Error(d+" is not a valid note.");if("undefined"!=typeof this._fileCache[c][f-1][d][k])return this._debug&&console.log((new Date).valueOf()-j,"ms to retrieve (cached)"),this._fileCache[c][f-1][d][k];for(var l=this._notes[d]*Math.pow(2,f-4),m=this._sampleRate,n=this._volume,o=this._channels,p=this._bitsPerSample,q=h.attack(m,l,n),r=h.dampen(m,l,n),s=h.wave,t={modulate:this._mod,vars:this._temp},u=0,w=new Uint8Array(new ArrayBuffer(Math.ceil(2*m*k))),x=0|m*q,y=0|m*k,i=0;i!==x;i++)u=n*(i/(m*q))*s.call(t,i,m,l,n),w[i<<1]=u,w[(i<<1)+1]=u>>8;for(;i!==y;i++)u=n*Math.pow(1-(i-m*q)/(m*(k-q)),r)*s.call(t,i,m,l,n),w[i<<1]=u,w[(i<<1)+1]=u>>8;var z=["RIFF",e(1,52),"WAVE","fmt ",e(1,16),e(0,1),e(0,o),e(1,m),e(1,m*o*p/8),e(0,o*p/8),e(0,p),"data",e(1,w.length*o*p/8),w],A=new b(z,{type:"audio/wav"}),B=a.createObjectURL(A);return this._fileCache[c][f-1][d][k]=B,this._debug&&console.log((new Date).valueOf()-j,"ms to generate"),B}),j("play",function(a,b,c,d){var e=this.generate(a,b,c,d),f=new Audio(e);return f.play(),!0}),j("debug",function(){this._debug=!0}),j("createInstrument",function(a){var b=0,d=!1;if("string"==typeof a){for(var e=0;e<this._sounds.length;e++)if(this._sounds[e].name==a){d=!0,b=e;break}}else this._sounds[a]&&(b=a,a=this._sounds[b].name,d=!0);if(!d)throw new Error("Invalid sound or sound ID: "+a);c=!0;var f=new AudioSynthInstrument(this,a,b);return c=!1,f}),j("listSounds",function(){for(var a=[],b=0;b<this._sounds.length;b++)a.push(this._sounds[b].name);return a}),i("__init__",function(){this._resizeCache()}),j("loadSoundProfile",function(){for(var a=0,b=arguments.length;b>a;a++){if(o=arguments[a],!(o instanceof Object))throw new Error("Invalid sound profile.");this._sounds.push(o)}return this._resizeCache(),!0}),j("loadModulationFunction",function(){for(var a=0,b=arguments.length;b>a;a++){if(f=arguments[a],"function"!=typeof f)throw new Error("Invalid modulation function.");this._mod.push(f)}return!0}),d=new AudioSynth,Synth=d}(),Synth.loadModulationFunction(function(a,b,c,d){return 1*Math.sin(2*Math.PI*a/b*c+d)},function(a,b,c,d){return 1*Math.sin(4*Math.PI*a/b*c+d)},function(a,b,c,d){return 1*Math.sin(8*Math.PI*a/b*c+d)},function(a,b,c,d){return 1*Math.sin(.5*Math.PI*a/b*c+d)},function(a,b,c,d){return 1*Math.sin(.25*Math.PI*a/b*c+d)},function(a,b,c,d){return.5*Math.sin(2*Math.PI*a/b*c+d)},function(a,b,c,d){return.5*Math.sin(4*Math.PI*a/b*c+d)},function(a,b,c,d){return.5*Math.sin(8*Math.PI*a/b*c+d)},function(a,b,c,d){return.5*Math.sin(.5*Math.PI*a/b*c+d)},function(a,b,c,d){return.5*Math.sin(.25*Math.PI*a/b*c+d)}),Synth.loadSoundProfile({name:"piano",attack:function(){return.002},dampen:function(a,b,c){return Math.pow(.5*Math.log(b*c/a),2)},wave:function(a,b,c){var e=this.modulate[0];return this.modulate[1](a,b,c,Math.pow(e(a,b,c,0),2)+.75*e(a,b,c,.25)+.1*e(a,b,c,.5))}},{name:"organ",attack:function(){return.3},dampen:function(a,b){return 1+.01*b},wave:function(a,b,c){var d=this.modulate[0];return this.modulate[1](a,b,c,d(a,b,c,0)+.5*d(a,b,c,.25)+.25*d(a,b,c,.5))}},{name:"acoustic",attack:function(){return.002},dampen:function(){return 1},wave:function(a,b,c){var d=this.vars;d.valueTable=d.valueTable?d.valueTable:[],"undefined"==typeof d.playVal&&(d.playVal=0),"undefined"==typeof d.periodCount&&(d.periodCount=0);var e=d.valueTable,f=d.playVal,g=d.periodCount,h=b/c,i=Math.floor(100*(h-Math.floor(h))),j=!1;if(e.length<=Math.ceil(h))return e.push(2*Math.round(Math.random())-1),e[e.length-1];e[f]=.5*(e[f>=e.length-1?0:f+1]+e[f]),f>=Math.floor(h)&&(f<Math.ceil(h)?g%100>=i&&(j=!0,e[f+1]=.5*(e[0]+e[f+1]),d.periodCount++):j=!0);var k=e[f];return j?d.playVal=0:d.playVal++,k}},{name:"edm",attack:function(){return.002},dampen:function(){return 1},wave:function(a,b,c){var d=this.modulate[0],e=this.modulate.slice(1);return e[0](a,b,c,e[9](a,b,c,e[2](a,b,c,Math.pow(d(a,b,c,0),3)+Math.pow(d(a,b,c,.5),5)+Math.pow(d(a,b,c,1),7)))+e[8](a,b,c,d(a,b,c,1.75)))}});