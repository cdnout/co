"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),path=require("path"),fs=require("fs-plus"),colors=require("colors"),glob=require("glob"),Svgo=require("svgo"),camelcase_1=require("camelcase");function build(d){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(e){return[2,new Promise(function(p,g){fs.removeSync(d.targetPath);var e=d.tpl?path.join(process.cwd(),d.tpl):path.join(__dirname,"../../default/icon.tpl"+(d.es6?".es6":"")+".txt"),f=fs.readFileSync(e,"utf8"),h=new Svgo(getSvgoConfig(d.svgo));glob(path.join(d.sourcePath,"**/*.svg"),function(e,u){var t=this;e?g(e):(u=u.map(function(e){return path.normalize(e)})).forEach(function(s,c){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,r,n,i,a,o,l;return tslib_1.__generator(this,function(e){switch(e.label){case 0:return t=path.basename(s).split(".")[0],r=fs.readFileSync(s,"utf-8"),n=getFilePath(d.sourcePath,s),[4,h.optimize(r)];case 1:i=e.sent(),a=i.data.replace(/<svg[^>]+>/gi,"").replace(/<\/svg>/gi,""),o=getViewBox(i),a=(a=changeId(a=renameStyle(a=addPid(a)),n,t,d.idSP)).replace(/\'/g,"\\'"),l=compile(f,{name:""+n+t,width:parseFloat(i.info.width)||16,height:parseFloat(i.info.height)||16,viewBox:"'"+o+"'",data:a});try{fs.writeFileSync(path.join(d.targetPath,n,t+("."+d.ext)),l,"utf-8"),console.log(colors.yellow("Generated icon: "+n+t)),c===u.length-1&&(generateIndex(d,u),p())}catch(e){g(e)}return[2]}})})})})})]})})}function compile(e,r){return e.replace(/\${(\w+)}/gi,function(e,t){return r[t]?r[t]:""})}function getFilePath(e,t,r){void 0===r&&(r="");var n=t.replace(path.resolve(e),"").replace(path.basename(t),"");return r&&(n=n.replace(r+path.sep,"")),/^[\/\\]/.test(n)&&(n=n.substr(1)),n.replace(/\\/g,"/")}function generateIndex(o,e,l){void 0===l&&(l="");var s=o.export,c=o.es6,u="",p={};switch(o.ext){case"js":u+="/* eslint-disable */\n";break;case"ts":u+="/* tslint:disable */\n"}for(var t in e.forEach(function(e){var t,r,n=path.basename(e).split(".")[0],i=getFilePath(o.sourcePath,e,l),a=i.split("/")[0];a?(p[a]||(p[a]=[],s?(t=camelcase_1.default(a,{pascalCase:!0}),u+=c?"export * as  "+t+" from './"+a+"'\n":"module.exports."+t+" = require('./"+a+"')\n"):u+=c?"import './"+a+"'\n":"require('./"+a+"')\n"),p[a].push(e)):s?(r=camelcase_1.default(n,{pascalCase:!0}),u+=c?"export "+r+" from './"+i+n+"'\n":"module.exports."+r+" = require('./"+i+n+"')\n"):u+=c?"import './"+i+n+"'\n":"require('./"+i+n+"')\n"}),fs.writeFileSync(path.join(o.targetPath,l,"index."+o.ext),u,"utf-8"),console.log(colors.green("Generated "+(l?l+path.sep:"")+"index."+o.ext)),p)generateIndex(o,p[t],path.join(l,t))}function getSvgoConfig(e){return e?"string"==typeof e?require(path.join(process.cwd(),e)):e:require("../../default/svgo")}function getViewBox(e){var t=e.data.match(/viewBox="([-\d\.]+\s[-\d\.]+\s[-\d\.]+\s[-\d\.]+)"/),r="0 0 200 200";return t&&1<t.length?r=t[1]:e.info.height&&e.info.width&&(r="0 0 "+e.info.width+" "+e.info.height),r}function addPid(e){var t=0;return e=e.replace(/<(path|rect|circle|polygon|line|polyline|ellipse)\s/gi,function(e){return e+('pid="'+t++)+'" '})}function renameStyle(e){var t=/fill=\"|stroke="/gi;return e=e.replace(/<(path|rect|circle|polygon|line|polyline|g|ellipse).+>/gi,function(e){return e.replace(t,function(e){return"_"+e})})}function changeId(e,r,n,i){void 0===i&&(i="_");return e=e.replace(/svgicon(\w+)/g,function(e,t){return"svgicon"+i+r.replace(/[\\\/]/g,i)+n+i+t})}exports.default=build;