!function(e){var t=/[\-\[\]{}()*+?.,\\\^$|#\s]/g;filterRules={contains:"{{term}}",beginsWith:"^{{term}}",endsWith:"{{term}}$",exactMatch:"^{{term}}$",containsNumber:"d",isNumeric:"^d+$",isNonNumeric:"^D+$"},e.widget("ech.multiselectfilter",{options:{label:"Filter:",placeholder:"Enter keywords",filterRule:"contains",searchGroups:!1,autoReset:!1,width:null,debounceMS:250},_create:function(){var t,i,s,l,n=this.options,a=this.element;this.instance=a.multiselect().data("ech-multiselect"),this.$header=this.instance.$menu.find(".ui-multiselect-header").addClass("ui-multiselect-hasfilter"),this.$input=e(document.createElement("input")).attr({placeholder:n.placeholder,type:"search"}).css({width:/\d/.test(n.width)?n.width+"px":null}).on({keydown:function(t){if(13===t.which)t.preventDefault();else if(27===t.which)a.multiselect("close"),t.preventDefault();else if(9===t.which&&t.shiftKey)a.multiselect("close"),t.preventDefault();else if(t.altKey)switch(t.which){case 82:t.preventDefault(),e(this).val("").trigger("input","");break;case 65:a.multiselect("checkAll");break;case 85:a.multiselect("uncheckAll");break;case 70:a.multiselect("flipAll");break;case 76:a.multiselect("instance").$labels.first().trigger("mouseenter")}},input:e.proxy((t=this._handler,i=n.debounceMS,function(){var e=this,n=arguments,a=s&&!l;clearTimeout(l),l=setTimeout(function(){l=null,s||t.apply(e,n)},i),a&&t.apply(e,n)}),this),search:e.proxy(this._handler,this)}),this.options.autoReset&&a.on("multiselectclose",e.proxy(this._reset,this));var c=e(document.createElement("label")).text(n.label).append(this.$input);this.$wrapper=e(document.createElement("div")).addClass(" ui-multiselect-filter").append(c).prependTo(this.$header),this.instance._isOpen&&this.instance._setMenuHeight(!0),this.updateCache();var r=this.instance,h=this.$input[0];r._oldToggleChecked=r._toggleChecked,r._toggleChecked=function(e,t){r._oldToggleChecked(e,t,!!h.value)}},_handler:function(i){var s=this.$input[0].value.toLowerCase().replace(/^\s+|\s+$/g,""),l=this.options.filterRule||"contains",n=new RegExp((filterRules[l]||l).replace("{{term}}",s.replace(t,"\\$&")),"i"),a=!!this.options.searchGroups,c=this.instance.$checkboxes,r=this.cache,h="ui-multiselect-excluded";this.$rows.toggleClass(h,!!s);var u=c.children().map(function(t){var i=e(this),s=i,l=!1;if(i.hasClass("ui-multiselect-optgroup")){s=i.find("li");if(a&&n.test(r[t]))return i.removeClass(h),s.removeClass(h),s.find("input").get()}return s.map(function(s){var a=e(this);return n.test(r[t+"."+s])?(l||(i.removeClass(h),l=!0),a.removeClass(h),this.getElementsByTagName("input")[0]):null})});s&&this._trigger("filter",i,u),this.instance.options.listbox||this.instance._setMenuHeight(!0)},_reset:function(){this.$input.val("").trigger("input","")},updateCache:function(t){var i={};this.instance.$checkboxes.children().each(function(t){var s=e(this);s.hasClass("ui-multiselect-optgroup")&&(i[t]=s.children("a").text(),s=s.find("li")),s.each(function(s){i[t+"."+s]=e(this).text()})}),this.cache=i,this.$rows=this.instance.$checkboxes.find("li"),t&&this._handler()},widget:function(){return this.$wrapper},destroy:function(){e.Widget.prototype.destroy.call(this),this.$input.val("").trigger("keyup").off("keydown input search"),this.instance.$menu.find(".ui-multiselect-header").removeClass("ui-multiselect-hasfilter"),this.$wrapper.remove()}})}(jQuery);