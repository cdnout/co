"use strict";var utils=require("@daybrush/utils"),EventEmitter=require("@scena/event-emitter"),OrderMap=require("order-map"),styled=require("css-styled"),extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};function __extends(t,e){function i(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function __decorate(t,e,i,r){var n,s=arguments.length,a=s<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var o=t.length-1;0<=o;o--)(n=t[o])&&(a=(s<3?n(a):3<s?n(e,i,a):n(e,i))||a);return 3<s&&a&&Object.defineProperty(e,i,a),a}function __spreadArrays(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;for(var r=Array(t),n=0,e=0;e<i;e++)for(var s=arguments[e],a=0,o=s.length;a<o;a++,n++)r[n]=s[a];return r}function cubic(t,e,i){var r=1-i;return i*i*i+3*i*i*r*e+3*i*r*r*t}function solveFromX(t,e,i){for(var r=i,n=1;.001<Math.abs(n);){if(n=cubic(t,e,r)-i,Math.abs(n)<.001)return r;r-=n/2}return r}function bezier(e,i,r,n){function t(t){return t=solveFromX(e,r,utils.between(t,0,1)),cubic(i,n,t)}return t.easingName="cubic-bezier("+e+","+i+","+r+","+n+")",t}function steps(i,r){function t(t){var e=1/i;return 1<=t?1:("start"===r?e:0)+Math.floor(t/e)*e}return t.easingName="steps("+i+", "+r+")",t}var _a,STEP_START=steps(1,"start"),STEP_END=steps(1,"end"),LINEAR=bezier(0,0,1,1),EASE=bezier(.25,.1,.25,1),EASE_IN=bezier(.42,0,1,1),EASE_OUT=bezier(0,0,.58,1),EASE_IN_OUT=bezier(.42,0,.58,1),PREFIX="__SCENEJS_",DATA_SCENE_ID="data-scene-id",TIMING_FUNCTION="animation-timing-function",ROLES={transform:{},filter:{},attribute:{},html:!0},ALIAS={easing:[TIMING_FUNCTION]},FIXED=((_a={})[TIMING_FUNCTION]=!0,_a.contents=!0,_a.html=!0,_a),MAXIMUM=1e6,THRESHOLD=1e-6,DURATION="duration",FILL_MODE="fillMode",DIRECTION="direction",ITERATION_COUNT="iterationCount",DELAY="delay",EASING="easing",PLAY_SPEED="playSpeed",EASING_NAME="easingName",ITERATION_TIME="iterationTime",PAUSED="paused",ENDED="ended",TIMEUPDATE="timeupdate",ANIMATE="animate",PLAY="play",RUNNING="running",ITERATION="iteration",START_ANIMATION="startAnimation",PAUSE_ANIMATION="pauseAnimation",ALTERNATE="alternate",REVERSE="reverse",ALTERNATE_REVERSE="alternate-reverse",NORMAL="normal",INFINITE="infinite",PLAY_STATE="playState",PLAY_CSS="playCSS",PREV_TIME="prevTime",TICK_TIME="tickTime",CURRENT_TIME="currentTime",SELECTOR="selector",TRANSFORM_NAME="transform",EASINGS={linear:LINEAR,ease:EASE,"ease-in":EASE_IN,"ease-out":EASE_OUT,"ease-in-out":EASE_IN_OUT,"step-start":STEP_START,"step-end":STEP_END},NAME_SEPARATOR="_///_",OPTIONS=[DURATION,FILL_MODE,DIRECTION,ITERATION_COUNT,DELAY,EASING,PLAY_SPEED],EVENTS=[PAUSED,ENDED,TIMEUPDATE,ANIMATE,PLAY,ITERATION],PropertyObject=function(){function s(t,e){this.prefix="",this.suffix="",this.model="",this.type="",this.separator=",",e&&this.setOptions(e),this.value=utils.isString(t)?t.split(this.separator):t}var t=s.prototype;return t.setOptions=function(t){for(var e in t)this[e]=t[e];return this},t.size=function(){return this.value.length},t.get=function(t){return this.value[t]},t.set=function(t,e){return this.value[t]=e,this},t.clone=function(){var t=this,e=t.separator,i=t.prefix,r=t.suffix,n=t.model,t=t.type;return new s(this.value.map(function(t){return t instanceof s?t.clone():t}),{separator:e,prefix:i,suffix:r,model:n,type:t})},t.toValue=function(){return this.prefix+this.join()+this.suffix},t.join=function(){return this.value.map(function(t){return t instanceof s?t.toValue():t}).join(this.separator)},t.forEach=function(t){return this.value.forEach(t),this},s}();function splitStyle(t){for(var e=utils.splitText(t,";"),i={},r=e.length,n=r,s=0;s<r;++s){var a=utils.splitText(e[s],":");a.length<2||!a[1]?--n:i[a[0].trim()]=toPropertyObject(a[1].trim())}return{styles:i,length:n}}function arrayToColorObject(t){var e=utils.RGBA;return 3===t.length&&(t[3]=1),new PropertyObject(t,{model:e,separator:",",type:"color",prefix:e+"(",suffix:")"})}function stringToBracketObject(t){var e=utils.splitBracket(t),i=e.prefix,r=e.value,n=e.suffix;if(void 0===r)return t;if(-1<utils.COLOR_MODELS.indexOf(i))return arrayToColorObject(utils.stringToRGBA(t));var s=toPropertyObject(r,i),e=[r],t=",",r=i+"(",n=")"+n;return s instanceof PropertyObject&&(t=s.separator,e=s.value,r+=s.prefix,n=s.suffix+n),new PropertyObject(e,{separator:t,model:i,prefix:r,suffix:n})}function arrayToPropertyObject(t,e){return new PropertyObject(t,{type:"array",separator:e})}function stringToColorObject(t){var e=utils.stringToRGBA(t);return e?arrayToColorObject(e):t}function toPropertyObject(t,e){if(!utils.isString(t))return utils.isArray(t)?arrayToPropertyObject(t,","):t;var i=utils.splitComma(t);return 1<i.length?arrayToPropertyObject(i.map(function(t){return toPropertyObject(t)}),","):1<(i=utils.splitSpace(t)).length?arrayToPropertyObject(i.map(function(t){return toPropertyObject(t)})," "):(i=/^(['"])([^'"]*)(['"])$/g.exec(t))&&i[1]===i[3]?new PropertyObject([toPropertyObject(i[2])],{prefix:i[1],suffix:i[1]}):-1!==t.indexOf("(")?stringToBracketObject(t):"#"===t.charAt(0)&&"url"!==e?stringToColorObject(t):t}function toObject(t,e){void 0===e&&(e={});var i,r=t.model;return r?(t.setOptions({model:"",suffix:"",prefix:""}),i=1<t.size()?t:t.get(0),e[r]=i):t.forEach(function(t){toObject(t,e)}),e}function isPropertyObject(t){return t instanceof PropertyObject}function setAlias(t,e){ALIAS[t]=e}function setRole(t,e,i){for(var r=t.length,n=ROLES,s=FIXED,a=0;a<r-1;++a)n[t[a]]||(n[t[a]]={}),n=n[t[a]],i&&(s[t[a]]||(s[t[a]]={}),s=s[t[a]]);i&&(s[t[r-1]]=!0),n[t[r-1]]=!!e||{}}function getType(t){var e=typeof t;if(e===utils.OBJECT){if(utils.isArray(t))return utils.ARRAY;if(isPropertyObject(t))return utils.PROPERTY}else if(e===utils.STRING||e===utils.NUMBER)return"value";return e}function isPureObject(t){return utils.isObject(t)&&t.constructor===Object}function getNames(t,e){var i=[];if(isPureObject(t))for(var r in t)e.push(r),i=i.concat(getNames(t[r],e)),e.pop();else i.push(e.slice());return i}function updateFrame(t,e){for(var i in e)isPureObject(e[i])?(utils.isObject(t[i])||(t[i]={}),updateFrame(t[i],e[i])):t[i]=!0;return t}function toFixed(t){return Math.round(t*MAXIMUM)/MAXIMUM}function getValueByNames(t,e,i){void 0===i&&(i=t.length);for(var r=e,n=0;n<i;++n){if(!utils.isObject(r)||null==r)return;r=r[t[n]]}return r}function isInProperties(t,e,i){var r=e.length,n=t;if(0===r)return!1;for(var s=0;s<r;++s){if(!0===n)return!1;if(!(n=n[e[s]])||!i&&!0===n)return!1}return!0}function isRole(t,e){return isInProperties(ROLES,t,e)}function isFixed(t){return isInProperties(FIXED,t,!0)}function setPlayCSS(t,e){t.state[PLAY_CSS]=e}function isPausedCSS(t){return t.state[PLAY_CSS]&&t.isPaused()}function isEndedCSS(t){return!t.isEnded()&&t.state[PLAY_CSS]}function makeId(t){for(;;){var e=""+Math.floor(1e7*Math.random());if(!utils.IS_WINDOW||!t)return e;if(!utils.$('[data-scene-id="'+e+'"]'))return e}}function getRealId(t){return t.getId()||t.setId(makeId(!1)).getId()}function toId(t){return(""+t).match(/[0-9a-zA-Z]+/g).join("")}function playCSS(t,e,i,r){if(void 0===r&&(r={}),utils.ANIMATION&&t.getPlayState()!==RUNNING){i=i||START_ANIMATION;if(isPausedCSS(t))t.addPlayClass(!0,i,r);else{t.isEnded()&&t.setTime(0),e&&t.exportCSS({className:i});r=t.addPlayClass(!1,i,r);if(!r)return;addAnimationEvent(t,r),setPlayCSS(t,!0)}t.setPlayState(RUNNING)}}function addAnimationEvent(i,t){function e(){setPlayCSS(i,!1),i.finish()}function r(){i.trigger(PLAY),utils.addEvent(t,"animationcancel",e),utils.addEvent(t,"animationend",e),utils.addEvent(t,"animationiteration",o)}var n=i.state,s=i.getDuration(),a=!s||!isFinite(s);i.once(ENDED,function(){utils.removeEvent(t,"animationcancel",e),utils.removeEvent(t,"animationend",e),utils.removeEvent(t,"animationiteration",o),utils.removeEvent(t,"animationstart",r)});var o=function(t){var e=t.elapsedTime,t=a?0:e/s;n[CURRENT_TIME]=e,i.setIteration(t)};utils.addEvent(t,"animationstart",r)}function getEasing(t){var e;if(utils.isString(t))if(t in EASINGS)e=EASINGS[t];else{var i=toPropertyObject(t);if(utils.isString(i))return 0;if("cubic-bezier"===i.model)e=bezier((t=i.value.map(function(t){return parseFloat(t)}))[0],t[1],t[2],t[3]);else{if("steps"!==i.model)return 0;e=steps(parseFloat(i.value[0]),i.value[1])}}else e=utils.isArray(t)?bezier(t[0],t[1],t[2],t[3]):t;return e}function GetterSetter(e,r,n){return function(t){var i=t.prototype;e.forEach(function(t){i[utils.camelize("get "+t)]=function(){return this[n][t]}}),r.forEach(function(e){i[utils.camelize("set "+e)]=function(t){return this[n][e]=t,this}})}}function isDirectionReverse(t,e,i){return i===REVERSE||(e!==INFINITE&&t===e&&e%1==0?i===(1<=t%2?ALTERNATE_REVERSE:ALTERNATE):i===(1<=t%2?ALTERNATE:ALTERNATE_REVERSE))}var setters=["id",ITERATION_COUNT,DELAY,FILL_MODE,DIRECTION,PLAY_SPEED,DURATION,PLAY_SPEED,ITERATION_TIME,PLAY_STATE],getters=__spreadArrays(setters,[EASING,EASING_NAME]),Animator=function(i){function t(t){var e=i.call(this)||this;return e.timerId=0,e.state={id:"",easing:0,easingName:"linear",iterationCount:1,delay:0,fillMode:"forwards",direction:NORMAL,playSpeed:1,currentTime:0,iterationTime:-1,iteration:0,tickTime:0,prevTime:0,playState:PAUSED,duration:0},e.setOptions(t),e}__extends(t,i);var e=t.prototype;return e.setEasing=function(t){var e=getEasing(t),i=e&&e[EASING_NAME]||"linear",t=this.state;return t[EASING]=e,t[EASING_NAME]=i,this},e.setOptions=function(t){for(var e in void 0===t&&(t={}),t){var i=t[e];e!==EASING?e!==DURATION?-1<OPTIONS.indexOf(e)&&(this.state[e]=i):i&&this.setDuration(i):this.setEasing(i)}return this},e.getTotalDuration=function(){return this.getActiveDuration(!0)},e.getActiveDuration=function(t){var e=this.state,i=e[ITERATION_COUNT];return i===INFINITE?1/0:(t?e[DELAY]:0)+this.getDuration()*i},e.isEnded=function(){return 0===this.state[TICK_TIME]&&this.state[PLAY_STATE]===PAUSED||!(this.getTime()<this.getActiveDuration())},e.isPaused=function(){return this.state[PLAY_STATE]===PAUSED},e.start=function(t){void 0===t&&(t=this.state[DELAY]);var e=this.state;return e[PLAY_STATE]=RUNNING,e[TICK_TIME]>=t&&(this.trigger(PLAY),!0)},e.play=function(e){var i=this,r=this.state,t=r[DELAY],n=this.getTime();return r[PLAY_STATE]=RUNNING,this.isEnded()&&(0===n||n>=this.getActiveDuration())&&this.setTime(-t,!0),this.timerId=utils.requestAnimationFrame(function(t){r[PREV_TIME]=t,i.tick(t,e)}),this.start(),this},e.pause=function(){var t=this.state;return t[PLAY_STATE]!==PAUSED&&(t[PLAY_STATE]=PAUSED,this.trigger(PAUSED)),utils.cancelAnimationFrame(this.timerId),this},e.finish=function(){return this.setTime(0),this.state[TICK_TIME]=0,this.end(),this},e.end=function(){return this.pause(),this.trigger(ENDED),this},e.setTime=function(t,e,i){var r=this.getActiveDuration(),n=this.state,s=n[TICK_TIME],a=n[DELAY],o=e?t:this.getUnitTime(t);if(n[TICK_TIME]=a+o,o<0?o=0:r<o&&(o=r),n[CURRENT_TIME]=o,this.calculate(),e&&!i){i=n[TICK_TIME];if(s<a&&0<=t&&this.start(0),i<s||this.isEnded())return void this.end()}return this.isDelay()||this.trigger(TIMEUPDATE,{currentTime:o,time:this.getIterationTime(),iterationCount:n[ITERATION]}),this},e.getTime=function(){return this.state[CURRENT_TIME]},e.getUnitTime=function(t){if(utils.isString(t)){var e=this.getDuration()||100;if("from"===t)return 0;if("to"===t)return e;var i=utils.splitUnit(t),r=i.unit,i=i.value;return"%"===r?(this.getDuration()||this.setDuration(e),toFixed(parseFloat(t)/100*e)):">"===r?i+THRESHOLD:i}return toFixed(t)},e.isDelay=function(){var t=this.state,e=t[DELAY],t=t[TICK_TIME];return 0<e&&t<e},e.setIteration=function(t){var e=this.state,i=Math.floor(t),r=e[ITERATION_COUNT]===INFINITE?1/0:e[ITERATION_COUNT];return e[ITERATION]<i&&i<r&&this.trigger(ITERATION,{currentTime:e[CURRENT_TIME],iterationCount:i}),e[ITERATION]=t,this},e.calculate=function(){var t=this.state,e=t[ITERATION_COUNT],i=t[FILL_MODE],r=t[DIRECTION],n=this.getDuration(),s=this.getTime(),a=0===n?0:s/n,t=n?s%n:0;if(!n)return this.setIterationTime(0),this;this.setIteration(a);s=isDirectionReverse(a,e,r),r=isFinite(n);return r&&s&&(t=n-t),r&&e!==INFINITE&&e<=a&&(t=n*("both"===i||"forwards"===i?e%1||1:0),s&&(t=n-t)),this.setIterationTime(t),this},e.tick=function(t,e){var i,r,n,s,a=this;this.isPaused()||(s=(i=this.state)[PLAY_SPEED],r=i[PREV_TIME],n=i[DELAY],s=i[TICK_TIME]+Math.min(1e3,t-r)/1e3*s,i[PREV_TIME]=t,this.setTime(s-n,!0),e&&1e3*e<t&&this.pause(),i[PLAY_STATE]!==PAUSED&&(this.timerId=utils.requestAnimationFrame(function(t){a.tick(t,e)})))},__decorate([GetterSetter(getters,setters,"state")],t)}(EventEmitter);function toInnerProperties(e,t){if(void 0===t&&(t=[]),!e)return"";var i=[],r=utils.getKeys(e);return utils.sortOrders(r,t),r.forEach(function(t){i.push(t.replace(/\d$/g,"")+"("+e[t]+")")}),i.join(" ")}function clone(t,e){return void 0===e&&(e=!1),merge({},t,e)}function merge(t,e,i){for(var r in void 0===i&&(i=!1),e){var n=e[r],s=getType(n);s===utils.PROPERTY?t[r]=i?n.toValue():n.clone():s===utils.FUNCTION?t[r]=i?getValue([r],n):n:s===utils.ARRAY?t[r]=n.slice():s===utils.OBJECT?utils.isObject(t[r])&&!isPropertyObject(t[r])?merge(t[r],n,i):t[r]=clone(n,i):t[r]=e[r]}return t}function getPropertyName(t){return t[0]in ALIAS?ALIAS[t[0]]:t}function getValue(t,e){var i=getType(e);if(i===utils.PROPERTY)return e.toValue();if(i===utils.FUNCTION){if(t[0]!==TIMING_FUNCTION)return getValue(t,e())}else if(i===utils.OBJECT)return clone(e,!0);return e}var Frame=function(){function c(t){void 0===t&&(t={}),this.properties={},this.orderMap=new OrderMap(NAME_SEPARATOR),this.properties={},this.set(t)}var t=c.prototype;return t.get=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this.raw.apply(this,t);return getValue(getPropertyName(t),i)},t.getOrders=function(t){return this.orderMap.get(t)},t.setOrders=function(t,e){return this.orderMap.set(t,e)},t.getOrderObject=function(){return this.orderMap.getObject()},t.setOrderObject=function(t){this.orderMap.setObject(t)},t.getKeys=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this.raw.apply(this,t),i=getType(i)===utils.OBJECT?utils.getKeys(i):[];return utils.sortOrders(i,this.orderMap.get(t)),i},t.gets=function(){for(var e=this,i=[],t=0;t<arguments.length;t++)i[t]=arguments[t];var r=this.get.apply(this,i);return this.getKeys.apply(this,i).map(function(t){return{key:t,value:r[t],children:e.gets.apply(e,__spreadArrays(i,[t]))}})},t.raw=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return getValueByNames(getPropertyName(t),this.properties)},t.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=getPropertyName(t),r=i.length;if(!r)return this;this.orderMap.remove(i);var n=getValueByNames(i,this.properties,r-1);return utils.isObject(n)&&delete n[i[r-1]],this},t.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this,r=t.length,n=t.slice(0,-1),s=t[r-1],a=n[0];if(1===r&&s instanceof c)i.merge(s);else if(a in ALIAS)i._set(ALIAS[a],s);else if(2===r&&utils.isArray(a))i._set(a,s);else if(isPropertyObject(s))isRole(n)?i.set.apply(i,__spreadArrays(n,[toObject(s)])):i._set(n,s);else if(utils.isArray(s))i._set(n,s);else if(utils.isObject(s))for(var o in!i.has.apply(i,n)&&isRole(n)&&i._set(n,{}),s)i.set.apply(i,__spreadArrays(n,[o,s[o]]));else if(utils.isString(s)){if(isRole(n,!0))return isFixed(n)||!isRole(n)?this._set(n,s):(u=toPropertyObject(s),utils.isObject(u)&&i.set.apply(i,__spreadArrays(n,[u]))),this;var u=splitStyle(s),l=u.styles,u=u.length;for(o in l)i.set.apply(i,__spreadArrays(n,[o,l[o]]));if(u)return this;i._set(n,s)}else i._set(n,s);return i},t.getNames=function(){return getNames(this.properties,[])},t.has=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=getPropertyName(t),r=i.length;return!!r&&!utils.isUndefined(getValueByNames(i,this.properties,r))},t.clone=function(){var t=new c;return t.setOrderObject(this.orderMap.orderMap),t.merge(this)},t.merge=function(t){var e=this.properties,t=t.properties;return t&&merge(e,t),this},t.toCSSObject=function(){var t,e,i=this.get(),r={};for(t in i)isRole([t],!0)||(e=i[t],t===TIMING_FUNCTION?r[TIMING_FUNCTION.replace("animation",utils.ANIMATION)]=(utils.isString(e)?e:e[EASING_NAME])||"initial":r[t]=e);var n=toInnerProperties(i[TRANSFORM_NAME],this.orderMap.get([TRANSFORM_NAME])),s=toInnerProperties(i.filter,this.orderMap.get([utils.FILTER]));return utils.TRANSFORM&&n&&(r[utils.TRANSFORM]=n),utils.FILTER&&s&&(r[utils.FILTER]=s),r},t.toCSS=function(){var e=this.toCSSObject(),i=[],t=utils.getKeys(e);return utils.sortOrders(t,this.orderMap.get([])),t.forEach(function(t){i.push(t+":"+e[t]+";")}),i.join("")},t.clear=function(){return this.properties={},this.orderMap.clear(),this},t._set=function(t,e){for(var i,r=this.properties,n=t.length,s=0;s<n-1;++s){var a=t[s];a in r||(r[a]={}),r=r[a]}n&&(i=t[n-1],this.orderMap.add(t),r[i]=1===n&&i===TIMING_FUNCTION?getEasing(e):utils.isString(e)&&!isFixed(t)?toPropertyObject(e,i):e)},c}();function dotArray(t,i,r,n){var s=i.length;return t.map(function(t,e){return s<=e?t:dot(t,i[e],r,n)})}function dotColor(t,e,i,r){var n=t.value,s=e.value,a=t.model;if(a!==e.model)return dot(t.toValue(),e.toValue(),i,r);3===n.length&&(n[3]=1),3===s.length&&(s[3]=1);for(var o=dotArray(n,s,i,r),a=a,u=0;u<3;++u)o[u]=parseInt(o[u],10);return new PropertyObject(o,{type:"color",model:a,prefix:a+"(",suffix:")"})}function dotObject(t,e,i,r){var n=t.type;if("color"===n)return dotColor(t,e,i,r);r=dotArray(t.value,e.value,i,r);return new PropertyObject(r,{type:n,separator:t.separator||e.separator,prefix:t.prefix||e.prefix,suffix:t.suffix||e.suffix,model:t.model||e.model})}function dot(t,e,i,r){if(0===r)return e;if(0===i||i+r===0)return t;var n=getType(t),s=getType(e),a=n===utils.FUNCTION,o=s===utils.FUNCTION;if(a||o)return function(){return dot(a?toPropertyObject(t()):t,o?toPropertyObject(e()):e,i,r)};if(n!==s)return t;if(n===utils.PROPERTY)return dotObject(t,e,i,r);if(n===utils.ARRAY)return dotArray(t,e,i,r);if("value"!==n)return t;var u=utils.splitUnit(""+t),l=utils.splitUnit(""+e);if(isNaN(u.value)||isNaN(l.value))return t;s=utils.dot(u.value,l.value,i,r);n=u.prefix||l.prefix,l=u.unit||l.unit;return n||l?n+s+l:s}function dotValue(t,e,i,r,n,s){if(t===e)return r;if(t===i)return n;if(!s)return dot(r,n,t-e,i-t);e=s((t-e)/(i-e));return dot(r,n,e,1-e)}function getNearTimeIndex(t,e){for(var i=t.length,r=0;r<i;++r){if(t[r]===e)return[r,r];if(t[r]>e)return[0<r?r-1:0,r]}return[i-1,i-1]}function makeAnimationProperties(t){var e,i=[];for(e in t)i.push(utils.ANIMATION+"-"+utils.decamelize(e)+":"+t[e]+";");return i.join("")}function addTime(t,e){for(var i=t.length,r=0;r<i;++r)if(e<t[r])return void t.splice(r,0,e);t[i]=e}function addEntry(t,e,i){var r=t[t.length-1];r&&r[0]===e&&r[1]===i||t.push([toFixed(e),toFixed(i)])}function getEntries(t,e){var m=t.map(function(t){return[t,t]}),T=[];return e.forEach(function(t){for(var e=t[ITERATION_COUNT],i=t[DELAY],r=t[PLAY_SPEED],n=t[DIRECTION],s=Math.ceil(e),a=m[m.length-1][0],o=m.length,u=a*e,l=0;l<s;++l)for(var c=n===REVERSE||n===ALTERNATE&&l%2||n===ALTERNATE_REVERSE&&!(l%2),h=0;h<o;++h){var f=m[c?o-h-1:h],E=f[1],d=a*l+(c?a-f[0]:f[0]),p=m[c?o-h:h-1];if(u<d){0!==h&&(f=a*l+(c?a-p[0]:p[0]),f=utils.dot(p[1],E,u-f,d-u),addEntry(T,(i+a*e)/r,f));break}if(d===u&&T.length&&T[T.length-1][0]===u+i)break;addEntry(T,(i+d)/r,E)}i&&T.unshift([0,T[0][1]]),m=T,T=[]}),m}var SceneItem=function(s){function h(t,e){var i=s.call(this)||this;return i.times=[],i.items={},i.nameMap=new OrderMap(NAME_SEPARATOR),i.elements=[],i.needUpdate=!0,i.load(t,e),i}__extends(h,s);var t=h.prototype;return t.getDuration=function(){var t=this.times,e=t.length;return(0===e?0:t[e-1])||this.state[DURATION]},t.size=function(){return this.times.length},t.setDuration=function(t){if(!t)return this;var i,r,n,e=this.getDuration();return 0<e?(i=t/e,e=this.times,r=this.items,n={},this.times=e.map(function(t){var e=toFixed(t*i);return n[e]=r[t],e}),this.items=n):this.newFrame(t),this},t.setId=function(t){var e,i=this.state,r=this.elements,n=r.length;return i.id=t||makeId(!!n),n&&!i[SELECTOR]&&(e=toId(this.getId()),i[SELECTOR]="["+DATA_SCENE_ID+'="'+e+'"]',r.forEach(function(t){t.setAttribute(DATA_SCENE_ID,e)})),this},t.set=function(e){for(var u,l=this,c=[],t=1;t<arguments.length;t++)c[t-1]=arguments[t];if(e instanceof h)return this.set(0,e);if(utils.isArray(e))for(var i=e.length,r=0;r<i;++r){var n=1===i?0:this.getUnitTime(r/(i-1)*100+"%");this.set(n,e[r])}else if(utils.isObject(e))for(n in e)!function(t){var a=e[t];utils.splitComma(t).forEach(function(t){var e=l.getUnitTime(t);isNaN(e)?getNames(a,[t]).forEach(function(t){for(var e,i=getValueByNames(t.slice(1),a),r=utils.isArray(i)?i:[getValueByNames(t,l.target),i],n=r.length,s=0;s<n;++s)(e=l.newFrame(s/(n-1)*100+"%")).set.apply(e,__spreadArrays(t,[r[s]]))}):l.set(e,a)})}(n);else utils.isUndefined(e)||(u=c[0],utils.splitComma(e+"").forEach(function(t){var e=l.getUnitTime(t);if(u instanceof h){var i,r=u.getDelay(),n=u.toObject(!l.hasFrame(e+r)),s=u.getDuration(),a=-1<u.getDirection().indexOf("reverse");for(i in n){var o=a?s-parseFloat(i):parseFloat(i);l.set(e+o,n[i])}}else 1===c.length&&utils.isArray(u)?u.forEach(function(t){l.set(e,t)}):(r=l.newFrame(e)).set.apply(r,c)}));return this.needUpdate=!0,this},t.get=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];t=this.getFrame(t);return t&&t.get.apply(t,e)},t.getOrders=function(t){return this.needUpdate&&this.update(),this.nameMap.get(t)},t.setOrders=function(t,e){this.needUpdate&&this.update();e=this.nameMap.set(t,e);return this.updateFrameOrders(),e},t.getOrderObject=function(){return this.nameMap.getObject()},t.setOrderObject=function(t){this.nameMap.setObject(t),this.updateFrameOrders()},t.remove=function(t){for(var e,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];return i.length?(e=this.getFrame(t))&&e.remove.apply(e,i):this.removeFrame(t),this.needUpdate=!0,this},t.append=function(t){return t instanceof h?this.set(this.getDuration(),t):this.append(new h(t)),this},t.prepend=function(t){var e,i;return t instanceof h?(e=t.getDuration()+t.getDelay(),i=this.getFrame(0),this.removeFrame(0),this.unshift(e),this.set(0,t),this.set(e+THRESHOLD,i)):this.prepend(new h(t)),this},t.unshift=function(i){var t=this.times,r=this.items,n={};return this.times=t.map(function(t){var e=toFixed(i+t);return n[e]=r[t],e}),this.items=n,this},t.toObject=function(i){void 0===i&&(i=!0);var r={},n=this.getDelay();return this.forEach(function(t,e){r[(e||i?0:THRESHOLD)+n+e]=t.clone()}),r},t.setSelector=function(t){return utils.isFunction(t)?this.setElement(t(this.getId())):this.setElement(t),this},t.getElements=function(){return this.elements},t.setElements=function(t){return this.setElement(t)},t.setElement=function(t){var e,i,s=this.state,a=[];return t?(!0===t||utils.isString(t)?(e=!0===t?""+s.id:t,i=/([\s\S]+)(:+[a-zA-Z]+)$/g.exec(e),a=utils.toArray(utils.$(i?i[1]:e,!0)),s[SELECTOR]=e):a=t instanceof Element?[t]:utils.toArray(t),a.length&&(this.elements=a,this.setId(this.getId()),this.target=a[0].style,this.targetFunc=function(t){var e,i=t.get("attribute");if(i)for(var r in i)!function(e){a.forEach(function(t){t.setAttribute(e,i[e])})}(r);t.has("html")&&(e=t.get("html"),a.forEach(function(t){t.innerHTML=e}));var n=t.toCSS();if(s.cssText!==n)return s.cssText=n,a.forEach(function(t){t.style.cssText+=n}),t}),this):this},t.setTarget=function(r){return this.target=r,this.targetFunc=function(t){var e,i=t.get();for(e in i)r[e]=i[e]},this},t.setCSS=function(t,e){return void 0===e&&(e=[]),this.set(t,utils.fromCSS(this.elements,e)),this},t.setTime=function(t,e,i,r){s.prototype.setTime.call(this,t,e,i);e=this.getIterationTime(),i=this.getEasing()||r,r=this.getNowFrame(e,i),i=this.getTime();return this.temp=r,this.trigger("animate",{frame:r,currentTime:i,time:e}),this.targetFunc&&this.targetFunc(r),this},t.update=function(){var e=this.nameMap,i={};this.forEach(function(t){updateFrame(i,t.properties)});var s=new OrderMap(NAME_SEPARATOR);return function i(r,n){var t=utils.getKeys(r);utils.sortOrders(t,e.get(n)),s.set(n,t),t.forEach(function(t){var e=r[t];utils.isObject(e)&&i(e,__spreadArrays(n,[t]))})}(i,[]),this.nameMap=s,this.forEach(function(t){t.setOrderObject(s.orderMap)}),this.needUpdate=!1,this},t.newFrame=function(t){var e=this.getFrame(t);return e||(e=new Frame,this.setFrame(t,e),e)},t.setFrame=function(t,e){t=this.getUnitTime(t);return this.items[t]=e,addTime(this.times,t),this.needUpdate=!0,this},t.getFrame=function(t){return this.items[this.getUnitTime(t)]},t.removeFrame=function(t){var e=this.getUnitTime(t),i=this.items,t=this.times.indexOf(e);return delete i[e],-1<t&&this.times.splice(t,1),this.needUpdate=!0,this},t.hasFrame=function(t){return this.getUnitTime(t)in this.items},t.hasName=function(t){return this.needUpdate&&this.update(),!!this.nameMap.get(t)},t.mergeFrame=function(t,e){return e&&this.newFrame(t).merge(e),this},t.getNowFrame=function(i,t,r){var n=this;this.needUpdate&&this.update();var s=new Frame,e=getNearTimeIndex(this.times,i),a=e[0],o=e[1],u=this.getEasing()||t,l=this.nameMap;if(this.hasName([TIMING_FUNCTION])&&(d=this.getNowValue(i,[TIMING_FUNCTION],a,o,!1,0,!0),utils.isFunction(d)&&(u=d)),r){var c,h=this.getFrame(i),f=h.orderMap.filter([],function(t){return h.has.apply(h,t)});for(c in ROLES){var E=l.get([c]);f.get([c])&&E&&f.set([c],E)}l=f}var d=l.gets([]);return s.setOrderObject(l.orderMap),d.forEach(function(t){var e=n.getNowValue(i,t,a,o,r,u,isFixed(t));utils.isUndefined(e)||s.set(t,e)}),s},t.load=function(t,e){var i;if(void 0===t&&(t={}),void 0===e&&(e=t.options),e&&this.setOptions(e),utils.isArray(t))this.set(t);else if(t.keyframes)this.set(t.keyframes);else for(var r in t)"options"!==r&&this.set(((i={})[r]=t[r],i));return e&&e[DURATION]&&this.setDuration(e[DURATION]),this},t.clone=function(){var i=new h;return i.setOptions(this.state),i.setOrderObject(this.nameMap.orderMap),this.forEach(function(t,e){i.setFrame(e,t.clone())}),i},t.forEach=function(e){var t=this.times,i=this.items;return t.forEach(function(t){e(i[t],t,i)}),this},t.setOptions=function(t){void 0===t&&(t={}),s.prototype.setOptions.call(this,t);var e=t.id,i=t.selector,r=t.elements,n=t.element,t=t.target;return e&&this.setId(e),t?this.setTarget(t):i?this.setSelector(i):(r||n)&&this.setElement(r||n),this},t.toCSS=function(t,e,i){void 0===t&&(t={className:START_ANIMATION}),void 0===e&&(e=this.getDuration()),void 0===i&&(i=[]);var r=this.state,n=r[SELECTOR];if(!n)return"";var s=this.getDuration();r[DURATION]=s,i.push(r);var a=utils.toArray(i).reverse(),o=toId(getRealId(this)),u=i[0],l=utils.findIndex(a,function(t){return t[ITERATION_COUNT]===INFINITE||!isFinite(t[DURATION])},i.length-1),c=a.slice(0,l),h=e||c.reduce(function(t,e){return(e[DELAY]+t*e[ITERATION_COUNT])/e[PLAY_SPEED]},s),i=a.slice(l).reduce(function(t,e){return(t+e[DELAY])/e[PLAY_SPEED]},0),e=utils.find(a,function(t){return t[EASING]&&t[EASING_NAME]},r)[EASING_NAME],s=a[l][ITERATION_COUNT],r=u[FILL_MODE],l=a[l][DIRECTION],u=makeAnimationProperties({fillMode:r,direction:l,iterationCount:s,delay:i+"s",name:PREFIX+"KEYFRAMES_"+o,duration:h/u[PLAY_SPEED]+"s",timingFunction:e}),e=utils.splitComma(n).map(function(t){var e=/([\s\S]+)(:+[a-zA-Z]+)$/g.exec(t);return e?[e[1],e[2]]:[t,""]}),f=t.className,t=t.selector;return"\n    "+((utils.isFunction(t)?t(this,n):t)||e.map(function(t){var e=t[0],t=t[1];return e+"."+f+t}))+" {"+u+"}\n    "+e.map(function(t){var e=t[0],t=t[1];return e+"."+PAUSE_ANIMATION+t})+" {"+utils.ANIMATION+"-play-state: paused;}\n    @"+utils.KEYFRAMES+" "+PREFIX+"KEYFRAMES_"+o+"{"+this._toKeyframes(h,c,l)+"}"},t.exportCSS=function(t,e,i){if(!this.elements.length)return"";e=this.toCSS(t,e,i);return i&&!utils.isUndefined(i[ITERATION_COUNT])||(this.styledInjector&&(this.styledInjector.destroy(),this.styledInjector=null),this.styled=styled(e),this.styledInjector=this.styled.inject(this.getAnimationElement(),{original:!0})),this},t.pause=function(){return s.prototype.pause.call(this),isPausedCSS(this)&&this.pauseCSS(),this},t.pauseCSS=function(){return this.elements.forEach(function(t){utils.addClass(t,PAUSE_ANIMATION)}),this},t.endCSS=function(){return this.elements.forEach(function(t){utils.removeClass(t,PAUSE_ANIMATION),utils.removeClass(t,START_ANIMATION)}),setPlayCSS(this,!1),this},t.end=function(){return isEndedCSS(this)&&this.endCSS(),s.prototype.end.call(this),this},t.playCSS=function(t,e,i){return void 0===t&&(t=!0),void 0===i&&(i={}),playCSS(this,t,e,i),this},t.getAnimationElement=function(){return this.elements[0]},t.addPlayClass=function(t,e,i){void 0===i&&(i={});var r=this.elements,n=r.length,s=makeAnimationProperties(i);if(n)return t?r.forEach(function(t){utils.removeClass(t,PAUSE_ANIMATION)}):(r.forEach(function(t){t.style.cssText+=s,utils.hasClass(t,START_ANIMATION)&&utils.removeClass(t,START_ANIMATION)}),r.forEach(function(t){t.clientWidth}),r.forEach(function(t){utils.addClass(t,START_ANIMATION)})),r[0]},t.clear=function(){return this.times=[],this.items={},this.nameMap=new OrderMap(NAME_SEPARATOR),this.styledInjector&&this.styledInjector.destroy(),this.styled=null,this.styledInjector=null,this.temp=null,this.needUpdate=!0,this},t.getNowValue=function(t,e,i,r,n,s,a){var o,u,l,c,h,f=this.times,E=f.length,d=utils.isUndefined(i),p=utils.isUndefined(r);(d||p)&&(h=getNearTimeIndex(f,t),d&&(i=h[0]),p&&(r=h[1]));for(var m=i;0<=m;--m)if((T=this.getFrame(f[m])).has.apply(T,e)){o=f[m],l=T;break}i=l&&l.raw.apply(l,e);if(n&&!isRole([e[0]]))return o===t?i:void 0;if(a)return i;for(var T,m=r;m<E;++m)if((T=this.getFrame(f[m])).has.apply(T,e)){u=f[m],c=T;break}r=c&&c.raw.apply(c,e);return!l||utils.isUndefined(i)?r:!c||utils.isUndefined(r)||i===r?i:dotValue(t,Math.max(o,0),u,i,r,s)},t._toKeyframes=function(r,t,n){var s=this,a={},e=this.times.slice();if(!e.length)return"";var o=this.getDuration();this.getFrame(0)||e.unshift(0),this.getFrame(o)||e.push(o);e=getEntries(e,t),t=e[e.length-1];t[0]<r&&addEntry(e,r,t[1]);var u=-1;return e.map(function(t){var e=t[0],i=t[1];a[i]||(a[i]=(s.hasFrame(i)&&0!==i&&i!==o?s.getNowFrame(i,0,!0):s.getNowFrame(i)).toCSS());t=e/r*100;return t-u<THRESHOLD&&(t+=THRESHOLD),u=t,Math.min(t,100)+"%{\n                "+(0!==e||isDirectionReverse(0,1,n)?a[i]:"")+"\n            }"}).join("")},t.updateFrameOrders=function(){var e=this.nameMap.orderMap;this.forEach(function(t){t.setOrderObject(e)})},h}(Animator),Scene=function(o){function c(t,e){var i=o.call(this)||this;return i.items={},i.orderMap=new OrderMap(NAME_SEPARATOR),i.load(t,e),i}__extends(c,o);var t=c.prototype;return t.getDuration=function(){var e=0;return this.forEach(function(t){e=Math.max(e,t.getTotalDuration()/t.getPlaySpeed())}),e||this.state[DURATION]},t.setDuration=function(e){this.items;var i,t=this.getDuration();return 0!==e&&isFinite(t)&&(0===t?this.forEach(function(t){t.setDuration(e)}):(i=e/t,this.forEach(function(t){t.setDelay(t.getDelay()*i),t.setDuration(t.getDuration()*i)})),o.prototype.setDuration.call(this,e)),this},t.getItem=function(t){return this.items[t]},t.newItem=function(t,e){if(void 0===e&&(e={}),this.items[t])return this.items[t];var i=new SceneItem;return this.setItem(t,i),i.setOptions(e),i},t.removeItem=function(t){return delete this.items[t],this.orderMap.remove([t]),this},t.setItem=function(t,e){return e.setId(t),this.items[t]=e,this.orderMap.add([t]),this},t.setTime=function(t,e,i,r){o.prototype.setTime.call(this,t,e,i);var n=this.getIterationTime(),s=this.getEasing()||r,a={};return this.forEach(function(t){t.setTime(n*t.getPlaySpeed()-t.getDelay(),e,!0,s),a[t.getId()]=t.temp}),this.temp=a,this.trigger("animate",{frames:a,currentTime:this.getTime(),time:n}),this},t.forEach=function(i){var r=this.items;return this.getOrders().forEach(function(t,e){i(r[t],t,e,r)}),this},t.toCSS=function(e,t,i){void 0===t&&(t=this.getDuration()),void 0===i&&(i=[]);var r=t&&isFinite(t)?t:0,n=[],s=this.state;return s[DURATION]=this.getDuration(),this.forEach(function(t){n.push(t.toCSS(e,r,i.concat(s)))}),n.join("")},t.exportCSS=function(t,e,i){e=this.toCSS(t,e,i);return i&&i.length||(this.styledInjector&&(this.styledInjector.destroy(),this.styledInjector=null),this.styled=styled(e),this.styledInjector=this.styled.inject(this.getAnimationElement(),{original:!0})),this},t.append=function(t){t.setDelay(t.getDelay()+this.getDuration()),this.setItem(getRealId(t),t)},t.pauseCSS=function(){return this.forEach(function(t){t.pauseCSS()})},t.pause=function(){return o.prototype.pause.call(this),isPausedCSS(this)&&this.pauseCSS(),this.forEach(function(t){t.pause()}),this},t.endCSS=function(){this.forEach(function(t){t.endCSS()}),setPlayCSS(this,!1)},t.end=function(){return isEndedCSS(this)&&this.endCSS(),o.prototype.end.call(this),this},t.getOrders=function(){return this.orderMap.get([])||[]},t.setOrders=function(t){return this.orderMap.set([],t)},t.getAnimationElement=function(){var e;return this.forEach(function(t){t=t.getAnimationElement();e=e||t}),e},t.addPlayClass=function(e,i,r){var n;return void 0===r&&(r={}),this.forEach(function(t){t=t.addPlayClass(e,i,r);n=n||t}),n},t.playCSS=function(t,e,i){return void 0===t&&(t=!0),void 0===i&&(i={}),playCSS(this,t,e,i),this},t.set=function(t){return this.load(t),this},t.clear=function(){this.finish(),this.items={},this.orderMap=new OrderMap(NAME_SEPARATOR),this.styledInjector&&this.styledInjector.destroy(),this.styled=null,this.styledInjector=null},t.load=function(t,e){if(void 0===t&&(t={}),void 0===e&&(e=t.options),!t)return this;var i,r=e&&e[SELECTOR]||this.state[SELECTOR];for(i in t)if("options"!==i){var n=t[i],s=void 0;if(n instanceof c||n instanceof SceneItem)this.setItem(i,n),s=n;else{if(utils.isFunction(n)&&r){for(var a=utils.IS_WINDOW?utils.$(""+(utils.isFunction(r)?r(i):i),!0):[],o=a.length,u=new c,l=0;l<o;++l)u.newItem(l).setId().setElement(a[l]).load(n(l,a[l]));this.setItem(i,u);continue}(s=this.newItem(i)).load(n)}r&&s.setSelector(r)}this.setOptions(e)},t.setOptions=function(t){void 0===t&&(t={}),o.prototype.setOptions.call(this,t);t=t.selector;return t&&(this.state[SELECTOR]=t),this},t.setSelector=function(i){var t=this.state,r=i||t[SELECTOR];t[SELECTOR]=r;var n=utils.isFunction(i);return r&&this.forEach(function(t,e){t.setSelector(n?i(e):r)}),this},t.start=function(t){void 0===t&&(t=this.state[DELAY]);t=o.prototype.start.call(this,t);return t?this.forEach(function(t){t.start(0)}):this.forEach(function(t){t.setPlayState(RUNNING)}),t},c.VERSION="1.5.0",c}(Animator);function animate(t,e){return new Scene(t,e).play()}function animateItem(t,e){return new SceneItem(t,e).play()}var name,others={__proto__:null,SceneItem:SceneItem,Frame:Frame,Animator:Animator,default:Scene,OPTIONS:OPTIONS,EVENTS:EVENTS,FIXED:FIXED,ROLES:ROLES,NAME_SEPARATOR:NAME_SEPARATOR,setRole:setRole,setAlias:setAlias,isRole:isRole,bezier:bezier,steps:steps,STEP_START:STEP_START,STEP_END:STEP_END,LINEAR:LINEAR,EASE:EASE,EASE_IN:EASE_IN,EASE_OUT:EASE_OUT,EASE_IN_OUT:EASE_IN_OUT,animate:animate,animateItem:animateItem};for(name in others)Scene[name]=others[name];module.exports=Scene;