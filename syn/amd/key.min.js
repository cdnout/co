define(["require","exports","module","./synthetic","./typeable","./browsers"],function(e,t,n){var d=e("./synthetic");e("./typeable"),e("./browsers");function o(e){var t;try{t=void 0!==e.selectionStart&&null!==e.selectionStart}catch(e){t=!1}return t}function h(t){var e,n,r;if(o(t))return document.activeElement&&document.activeElement!==t&&t.selectionStart===t.selectionEnd&&0===t.selectionStart?{start:t.value.length,end:t.value.length}:{start:t.selectionStart,end:t.selectionEnd};try{if("input"===t.nodeName.toLowerCase())return e=f.getWindow(t).document.selection.createRange(),(n=t.createTextRange()).setEndPoint("EndToStart",e),{start:r=n.text.length,end:r+e.text.length};n=(e=f.getWindow(t).document.selection.createRange()).duplicate();var s=e.duplicate(),i=e.duplicate();s.collapse(),i.collapse(!1),s.moveStart("character",-1),i.moveStart("character",-1),n.moveToElementText(t),n.setEndPoint("EndToEnd",e),r=n.text.length-e.text.length;var a=n.text.length;return 0!==r&&""===s.text&&(r+=2),0!==a&&""===i.text&&(a+=2),{start:r,end:a}}catch(e){var c=l.test(t.nodeName)?"value":"textContent";return{start:t[c].length,end:t[c].length}}}function u(e){return l.test(e.nodeName)?e.value:e[r]}function y(e,t){l.test(e.nodeName)?e.value=t:e[r]=t}var f=d.helpers,l=/input|textarea/i,r=null!=document.createElement("span").textContent?"textContent":"innerText";f.extend(d,{keycodes:{"\b":8,"\t":9,"\r":13,shift:16,ctrl:17,alt:18,meta:91,"pause-break":19,caps:20,escape:27,"num-lock":144,"scroll-lock":145,print:44,"page-up":33,"page-down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46," ":32,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,subtract:109,decimal:110,divide:111,";":186,"=":187,",":188,dash:189,"-":189,period:190,".":190,"forward-slash":191,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222,"left window key":91,"right window key":92,"select key":93,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},selectText:function(e,t,n){var r;o(e)?n?(e.selectionStart=t,e.selectionEnd=n):(d.__tryFocus(e),e.setSelectionRange(t,t)):e.createTextRange&&((r=e.createTextRange()).moveStart("character",t),n=n||t,r.moveEnd("character",n-e.value.length),r.select())},getText:function(e){if(d.typeable.test(e)){var t=h(e);return e.value.substring(t.start,t.end)}var n=d.helpers.getWindow(e);return n.getSelection?n.getSelection().toString():n.document.getSelection?n.document.getSelection().toString():n.document.selection.createRange().text},getSelection:h}),f.extend(d.key,{data:function(e){if(d.key.browser[e])return d.key.browser[e];for(var t in d.key.kinds)if(-1<f.inArray(e,d.key.kinds[t]))return d.key.browser[t];return d.key.browser.character},isSpecial:function(e){for(var t=d.key.kinds.special,n=0;n<t.length;n++)if(d.keycodes[t[n]]===e)return t[n]},options:function(e,t){var n=d.key.data(e);if(!n[t])return null;var r=n[t][0],s=n[t][1],i={key:e};return i.keyCode="key"===s?d.keycodes[e]:"char"===s?e.charCodeAt(0):s,"char"===r?i.charCode=e.charCodeAt(0):null!==r&&(i.charCode=r),i.keyCode?i.which=i.keyCode:i.which=i.charCode,i},kinds:{special:["shift","ctrl","alt","meta","caps"],specialChars:["\b"],navigation:["page-up","page-down","end","home","left","up","right","down","insert","delete"],function:["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12"]},getDefault:function(e){if(d.key.defaults[e])return d.key.defaults[e];for(var t in d.key.kinds)if(-1<f.inArray(e,d.key.kinds[t])&&d.key.defaults[t])return d.key.defaults[t];return d.key.defaults.character},defaults:{character:function(e,t,n,r,s){var i,a,c,o,l;/num\d+/.test(n)&&(n=n.match(/\d+/)[0]),(r||!d.support.keyCharacters&&d.typeable.test(this))&&(a=(i=u(this)).substr(0,s.start),c=i.substr(s.end),y(this,a+(o=n)+c),l="\n"===o&&d.support.textareaCarriage?2:o.length,d.selectText(this,a.length+l))},c:function(e,t,n,r,s){d.key.ctrlKey?d.key.clipboard=d.getText(this):d.key.defaults.character.apply(this,arguments)},v:function(e,t,n,r,s){d.key.ctrlKey?d.key.defaults.character.call(this,e,t,d.key.clipboard,!0,s):d.key.defaults.character.apply(this,arguments)},a:function(e,t,n,r,s){d.key.ctrlKey?d.selectText(this,0,u(this).length):d.key.defaults.character.apply(this,arguments)},home:function(){d.onParents(this,function(e){if(e.scrollHeight!==e.clientHeight)return e.scrollTop=0,!1})},end:function(){d.onParents(this,function(e){if(e.scrollHeight!==e.clientHeight)return e.scrollTop=e.scrollHeight,!1})},"page-down":function(){d.onParents(this,function(e){if(e.scrollHeight!==e.clientHeight){var t=e.clientHeight;return e.scrollTop+=t,!1}})},"page-up":function(){d.onParents(this,function(e){if(e.scrollHeight!==e.clientHeight){var t=e.clientHeight;return e.scrollTop-=t,!1}})},"\b":function(e,t,n,r,s){var i,a,c;!d.support.backspaceWorks&&d.typeable.test(this)&&(a=(i=u(this)).substr(0,s.start),c=i.substr(s.end),s.start===s.end&&0<s.start?(y(this,a.substring(0,a.length-1)+c),d.selectText(this,s.start-1)):(y(this,a+c),d.selectText(this,s.start)))},delete:function(e,t,n,r,s){var i,a,c;!d.support.backspaceWorks&&d.typeable.test(this)&&(a=(i=u(this)).substr(0,s.start),c=i.substr(s.end),s.start===s.end&&s.start<=u(this).length-1?y(this,a+c.substring(1)):y(this,a+c),d.selectText(this,s.start))},"\r":function(e,t,n,r,s){var i,a=this.nodeName.toLowerCase();"input"===a&&d.trigger(this,"change",{}),d.support.keypressSubmits||"input"!==a||(i=d.closest(this,"form"))&&d.trigger(i,"submit",{}),d.support.keyCharacters||"textarea"!==a||d.key.defaults.character.call(this,e,t,"\n",void 0,s),d.support.keypressOnAnchorClicks||"a"!==a||d.trigger(this,"click",{})},"\t":function(e,t){for(var n=function(e){for(var t=f.getWindow(e).document,n=[],r=t.getElementsByTagName("*"),s=r.length,i=0;i<s;i++)d.isFocusable(r[i])&&r[i]!==t.documentElement&&n.push(r[i]);return n}(this),r=null,s=0,i=[];s<n.length;s++)i.push([n[s],s]);i.sort(function(e,t){var n=e[0],r=t[0],s=d.tabIndex(n)||0,i=d.tabIndex(r)||0;return s===i?e[1]-t[1]:0===s?1:0===i?-1:s-i});for(var a,c=i.length,s=0;s<c;s++){this===i[s][0]&&(a=s,r=d.key.shiftKey?0<=--a&&i[a][0]||i[c-1][0]:++a<c&&i[a][0]||i[0][0])}return r?d.__tryFocus(r):r=void 0,r},left:function(e,t,n,r,s){d.typeable.test(this)&&(d.key.shiftKey?d.selectText(this,0===s.start?0:s.start-1,s.end):d.selectText(this,0===s.start?0:s.start-1))},right:function(e,t,n,r,s){d.typeable.test(this)&&(d.key.shiftKey?d.selectText(this,s.start,s.end+1>u(this).length?u(this).length:s.end+1):d.selectText(this,s.end+1>u(this).length?u(this).length:s.end+1))},up:function(){/select/i.test(this.nodeName)&&(this.selectedIndex=this.selectedIndex?this.selectedIndex-1:0)},down:function(){/select/i.test(this.nodeName)&&(d.changeOnBlur(this,"selectedIndex",this.selectedIndex),this.selectedIndex=this.selectedIndex+1)},shift:function(){return null},ctrl:function(){return null},alt:function(){return null},meta:function(){return null}}}),f.extend(d.create,{keydown:{setup:function(e,t,n){-1!==f.inArray(t,d.key.kinds.special)&&(d.key[t+"Key"]=n)}},keypress:{setup:function(e,t,n){d.support.keyCharacters&&!d.support.keysOnNotFocused&&d.__tryFocus(n)}},keyup:{setup:function(e,t,n){-1!==f.inArray(t,d.key.kinds.special)&&(d.key[t+"Key"]=null)}},key:{options:function(e,t,n){return t="object"!=typeof t?{character:t}:t,(t=f.extend({},t)).character&&(f.extend(t,d.key.options(t.character,e)),delete t.character),t=f.extend({ctrlKey:!!d.key.ctrlKey,altKey:!!d.key.altKey,shiftKey:!!d.key.shiftKey,metaKey:!!d.key.metaKey},t)},event:function(t,n,e){var r,s=f.getWindow(e).document||document;if("undefined"!=typeof KeyboardEvent){var i=d.key.keyboardEventKeys;return n.key&&i[n.key]&&(n.key=i[n.key]),(r=new KeyboardEvent(t,n)).synthetic=!0,r}if(s.createEvent){try{(r=s.createEvent("KeyEvents")).initKeyEvent(t,!0,!0,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode)}catch(e){r=f.createBasicStandardEvent(t,n,s)}return r.synthetic=!0,r}try{r=f.createEventObject.apply(this,arguments),f.extend(r,n)}catch(e){}return r}}});var p={enter:"\r",backspace:"\b",tab:"\t",space:" "};f.extend(d.init.prototype,{_key:function(e,t,n){if(/-up$/.test(t)&&-1!==f.inArray(t.replace("-up",""),d.key.kinds.special))return d.trigger(e,"keyup",t.replace("-up","")),n(!0,e);var r,s=f.getWindow(e).document.activeElement,i=d.typeable.test(e)&&h(e),a=p[t]||t,c=d.trigger(e,"keydown",a),o=d.key.getDefault,l=d.key.browser.prevent,u=d.key.options(a,"keypress");return c?u?(s!==f.getWindow(e).document.activeElement&&(e=f.getWindow(e).document.activeElement),(c=d.trigger(e,"keypress",u))&&(r=o(a).call(e,u,f.getWindow(e),a,void 0,i))):r=o(a).call(e,u,f.getWindow(e),a,void 0,i):u&&-1===f.inArray("keypress",l.keydown)&&(s!==f.getWindow(e).document.activeElement&&(e=f.getWindow(e).document.activeElement),d.trigger(e,"keypress",u)),r&&r.nodeName&&(e=r),null!==r?d.schedule(function(){"\r"===a&&"input"===e.nodeName.toLowerCase()||d.support.oninput&&d.trigger(e,"input",d.key.options(a,"input")),d.trigger(e,"keyup",d.key.options(a,"keyup")),n(c,e)},1):n(c,e),e},_type:function(r,e,s){var i=(e+"").match(/(\[[^\]]+\])|([^\[])/g),a=this,c=function(e,t){var n=i.shift();n?(t=t||r,1<n.length&&(n=n.substr(1,n.length-2)),a._key(t,n,c)):s(e,t)};c()}})});