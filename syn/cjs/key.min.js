var syn=require("./synthetic.js");require("./typeable.js"),require("./browsers.js");var h=syn.helpers,formElExp=/input|textarea/i,supportsSelection=function(e){var t;try{t=void 0!==e.selectionStart&&null!==e.selectionStart}catch(e){t=!1}return t},getSelection=function(t){var e,n,s;if(supportsSelection(t))return document.activeElement&&document.activeElement!==t&&t.selectionStart===t.selectionEnd&&0===t.selectionStart?{start:t.value.length,end:t.value.length}:{start:t.selectionStart,end:t.selectionEnd};try{if("input"===t.nodeName.toLowerCase())return e=h.getWindow(t).document.selection.createRange(),(n=t.createTextRange()).setEndPoint("EndToStart",e),{start:s=n.text.length,end:s+e.text.length};n=(e=h.getWindow(t).document.selection.createRange()).duplicate();var r=e.duplicate(),i=e.duplicate();r.collapse(),i.collapse(!1),r.moveStart("character",-1),i.moveStart("character",-1),n.moveToElementText(t),n.setEndPoint("EndToEnd",e),s=n.text.length-e.text.length;var a=n.text.length;return 0!==s&&""===r.text&&(s+=2),0!==a&&""===i.text&&(a+=2),{start:s,end:a}}catch(e){var c=formElExp.test(t.nodeName)?"value":"textContent";return{start:t[c].length,end:t[c].length}}},getFocusable=function(e){for(var t=h.getWindow(e).document,n=[],s=t.getElementsByTagName("*"),r=s.length,i=0;i<r;i++)syn.isFocusable(s[i])&&s[i]!==t.documentElement&&n.push(s[i]);return n},textProperty=null!=document.createElement("span").textContent?"textContent":"innerText",getText=function(e){return formElExp.test(e.nodeName)?e.value:e[textProperty]},setText=function(e,t){formElExp.test(e.nodeName)?e.value=t:e[textProperty]=t};h.extend(syn,{keycodes:{"\b":8,"\t":9,"\r":13,shift:16,ctrl:17,alt:18,meta:91,"pause-break":19,caps:20,escape:27,"num-lock":144,"scroll-lock":145,print:44,"page-up":33,"page-down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46," ":32,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,subtract:109,decimal:110,divide:111,";":186,"=":187,",":188,dash:189,"-":189,period:190,".":190,"forward-slash":191,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222,"left window key":91,"right window key":92,"select key":93,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},selectText:function(e,t,n){var s;supportsSelection(e)?n?(e.selectionStart=t,e.selectionEnd=n):(syn.__tryFocus(e),e.setSelectionRange(t,t)):e.createTextRange&&((s=e.createTextRange()).moveStart("character",t),n=n||t,s.moveEnd("character",n-e.value.length),s.select())},getText:function(e){if(syn.typeable.test(e)){var t=getSelection(e);return e.value.substring(t.start,t.end)}var n=syn.helpers.getWindow(e);return n.getSelection?n.getSelection().toString():n.document.getSelection?n.document.getSelection().toString():n.document.selection.createRange().text},getSelection:getSelection}),h.extend(syn.key,{data:function(e){if(syn.key.browser[e])return syn.key.browser[e];for(var t in syn.key.kinds)if(-1<h.inArray(e,syn.key.kinds[t]))return syn.key.browser[t];return syn.key.browser.character},isSpecial:function(e){for(var t=syn.key.kinds.special,n=0;n<t.length;n++)if(syn.keycodes[t[n]]===e)return t[n]},options:function(e,t){var n=syn.key.data(e);if(!n[t])return null;var s=n[t][0],r=n[t][1],i={key:e};return i.keyCode="key"===r?syn.keycodes[e]:"char"===r?e.charCodeAt(0):r,"char"===s?i.charCode=e.charCodeAt(0):null!==s&&(i.charCode=s),i.keyCode?i.which=i.keyCode:i.which=i.charCode,i},kinds:{special:["shift","ctrl","alt","meta","caps"],specialChars:["\b"],navigation:["page-up","page-down","end","home","left","up","right","down","insert","delete"],function:["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12"]},getDefault:function(e){if(syn.key.defaults[e])return syn.key.defaults[e];for(var t in syn.key.kinds)if(-1<h.inArray(e,syn.key.kinds[t])&&syn.key.defaults[t])return syn.key.defaults[t];return syn.key.defaults.character},defaults:{character:function(e,t,n,s,r){var i,a,c,o,y;/num\d+/.test(n)&&(n=n.match(/\d+/)[0]),(s||!syn.support.keyCharacters&&syn.typeable.test(this))&&(a=(i=getText(this)).substr(0,r.start),c=i.substr(r.end),setText(this,a+(o=n)+c),y="\n"===o&&syn.support.textareaCarriage?2:o.length,syn.selectText(this,a.length+y))},c:function(e,t,n,s,r){syn.key.ctrlKey?syn.key.clipboard=syn.getText(this):syn.key.defaults.character.apply(this,arguments)},v:function(e,t,n,s,r){syn.key.ctrlKey?syn.key.defaults.character.call(this,e,t,syn.key.clipboard,!0,r):syn.key.defaults.character.apply(this,arguments)},a:function(e,t,n,s,r){syn.key.ctrlKey?syn.selectText(this,0,getText(this).length):syn.key.defaults.character.apply(this,arguments)},home:function(){syn.onParents(this,function(e){if(e.scrollHeight!==e.clientHeight)return e.scrollTop=0,!1})},end:function(){syn.onParents(this,function(e){if(e.scrollHeight!==e.clientHeight)return e.scrollTop=e.scrollHeight,!1})},"page-down":function(){syn.onParents(this,function(e){if(e.scrollHeight!==e.clientHeight){var t=e.clientHeight;return e.scrollTop+=t,!1}})},"page-up":function(){syn.onParents(this,function(e){if(e.scrollHeight!==e.clientHeight){var t=e.clientHeight;return e.scrollTop-=t,!1}})},"\b":function(e,t,n,s,r){var i,a,c;!syn.support.backspaceWorks&&syn.typeable.test(this)&&(a=(i=getText(this)).substr(0,r.start),c=i.substr(r.end),r.start===r.end&&0<r.start?(setText(this,a.substring(0,a.length-1)+c),syn.selectText(this,r.start-1)):(setText(this,a+c),syn.selectText(this,r.start)))},delete:function(e,t,n,s,r){var i,a,c;!syn.support.backspaceWorks&&syn.typeable.test(this)&&(a=(i=getText(this)).substr(0,r.start),c=i.substr(r.end),r.start===r.end&&r.start<=getText(this).length-1?setText(this,a+c.substring(1)):setText(this,a+c),syn.selectText(this,r.start))},"\r":function(e,t,n,s,r){var i,a=this.nodeName.toLowerCase();"input"===a&&syn.trigger(this,"change",{}),syn.support.keypressSubmits||"input"!==a||(i=syn.closest(this,"form"))&&syn.trigger(i,"submit",{}),syn.support.keyCharacters||"textarea"!==a||syn.key.defaults.character.call(this,e,t,"\n",void 0,r),syn.support.keypressOnAnchorClicks||"a"!==a||syn.trigger(this,"click",{})},"\t":function(e,t){for(var n=getFocusable(this),s=null,r=0,i=[];r<n.length;r++)i.push([n[r],r]);i.sort(function(e,t){var n=e[0],s=t[0],r=syn.tabIndex(n)||0,i=syn.tabIndex(s)||0;return r===i?e[1]-t[1]:0===r?1:0===i?-1:r-i});for(var a,c=i.length,r=0;r<c;r++){this===i[r][0]&&(a=r,s=syn.key.shiftKey?0<=--a&&i[a][0]||i[c-1][0]:++a<c&&i[a][0]||i[0][0])}return s?syn.__tryFocus(s):s=void 0,s},left:function(e,t,n,s,r){syn.typeable.test(this)&&(syn.key.shiftKey?syn.selectText(this,0===r.start?0:r.start-1,r.end):syn.selectText(this,0===r.start?0:r.start-1))},right:function(e,t,n,s,r){syn.typeable.test(this)&&(syn.key.shiftKey?syn.selectText(this,r.start,r.end+1>getText(this).length?getText(this).length:r.end+1):syn.selectText(this,r.end+1>getText(this).length?getText(this).length:r.end+1))},up:function(){/select/i.test(this.nodeName)&&(this.selectedIndex=this.selectedIndex?this.selectedIndex-1:0)},down:function(){/select/i.test(this.nodeName)&&(syn.changeOnBlur(this,"selectedIndex",this.selectedIndex),this.selectedIndex=this.selectedIndex+1)},shift:function(){return null},ctrl:function(){return null},alt:function(){return null},meta:function(){return null}}}),h.extend(syn.create,{keydown:{setup:function(e,t,n){-1!==h.inArray(t,syn.key.kinds.special)&&(syn.key[t+"Key"]=n)}},keypress:{setup:function(e,t,n){syn.support.keyCharacters&&!syn.support.keysOnNotFocused&&syn.__tryFocus(n)}},keyup:{setup:function(e,t,n){-1!==h.inArray(t,syn.key.kinds.special)&&(syn.key[t+"Key"]=null)}},key:{options:function(e,t,n){return t="object"!=typeof t?{character:t}:t,(t=h.extend({},t)).character&&(h.extend(t,syn.key.options(t.character,e)),delete t.character),t=h.extend({ctrlKey:!!syn.key.ctrlKey,altKey:!!syn.key.altKey,shiftKey:!!syn.key.shiftKey,metaKey:!!syn.key.metaKey},t)},event:function(t,n,e){var s,r=h.getWindow(e).document||document;if("undefined"!=typeof KeyboardEvent){var i=syn.key.keyboardEventKeys;return n.key&&i[n.key]&&(n.key=i[n.key]),(s=new KeyboardEvent(t,n)).synthetic=!0,s}if(r.createEvent){try{(s=r.createEvent("KeyEvents")).initKeyEvent(t,!0,!0,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode)}catch(e){s=h.createBasicStandardEvent(t,n,r)}return s.synthetic=!0,s}try{s=h.createEventObject.apply(this,arguments),h.extend(s,n)}catch(e){}return s}}});var convert={enter:"\r",backspace:"\b",tab:"\t",space:" "};h.extend(syn.init.prototype,{_key:function(e,t,n){if(/-up$/.test(t)&&-1!==h.inArray(t.replace("-up",""),syn.key.kinds.special))return syn.trigger(e,"keyup",t.replace("-up","")),n(!0,e);var s,r=h.getWindow(e).document.activeElement,i=syn.typeable.test(e)&&getSelection(e),a=convert[t]||t,c=syn.trigger(e,"keydown",a),o=syn.key.getDefault,y=syn.key.browser.prevent,l=syn.key.options(a,"keypress");return c?l?(r!==h.getWindow(e).document.activeElement&&(e=h.getWindow(e).document.activeElement),(c=syn.trigger(e,"keypress",l))&&(s=o(a).call(e,l,h.getWindow(e),a,void 0,i))):s=o(a).call(e,l,h.getWindow(e),a,void 0,i):l&&-1===h.inArray("keypress",y.keydown)&&(r!==h.getWindow(e).document.activeElement&&(e=h.getWindow(e).document.activeElement),syn.trigger(e,"keypress",l)),s&&s.nodeName&&(e=s),null!==s?syn.schedule(function(){"\r"===a&&"input"===e.nodeName.toLowerCase()||syn.support.oninput&&syn.trigger(e,"input",syn.key.options(a,"input")),syn.trigger(e,"keyup",syn.key.options(a,"keyup")),n(c,e)},1):n(c,e),e},_type:function(s,e,r){var i=(e+"").match(/(\[[^\]]+\])|([^\[])/g),a=this,c=function(e,t){var n=i.shift();n?(t=t||s,1<n.length&&(n=n.substr(1,n.length-2)),a._key(t,n,c)):r(e,t)};c()}});