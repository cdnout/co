!function(e,t){"object"==typeof module&&"object"==typeof module.exports?module.exports=t():e.jsfx=t()}(this,function(){"use strict";String.fromCharCode;var c=2*+Math.PI,u=16,s=1,l=Math.sin,r=Math.pow,t=Math.abs,f=1e-6,p={},h=window.AudioContext||window.webkitAudioContext;p.SampleRate=0,p.Sec=0,p.SetSampleRate=function(e){p.SampleRate=0|e,p.Sec=0|e},p.SetSampleRate(function(){if(void 0!==h)return(new h).sampleRate;return 44100}()),p.Sound=function(e){var t=new d(e,p.DefaultModules),a=q(t.getSamplesLeft());return t.generate(a),v(a)},p.Sounds=function(a,r,n){var o={},i={};i._audio=o;var u=[];D(a,function(e,t){i[t]=function(){void 0!==o[t]&&(o[t].currentTime=0,o[t].play())},u.push(t)});var s=0,l=u.length;return function e(){if(0!=u.length){var t=u.shift();o[t]=p.Sound(a[t]),s++,n&&n(t,s,l),window.setTimeout(e,30)}else r&&r(sounds)}(),i},p.SoundsImmediate=function(e){var a={},r={};return r._audio=a,D(e,function(e,t){a[t]=p.Sound(e),r[t]=function(){void 0!==a[t]&&(a[t].currentTime=0,a[t].play())}}),r},p.FloatBuffer=function(e,t){var a=new d(e,p.DefaultModules),r=q(a.getSamplesLeft());return a.generate(r),r},void 0!==h?(p.Node=function(e,t,a,r,n){var o=e.createScriptProcessor(r,0,1),i=new d(t,a||p.DefaultModules);return o.onaudioprocess=function(e){var t=e.outputBuffer.getChannelData(0);i.generate(t),!n&&i.finished&&setTimeout(function(){o.disconnect()},30)},o},p.AudioBuffer=function(e,t,a){var r=new d(t,a||p.DefaultModules),n=e.createBuffer(s,r.getSamplesLeft(),p.SampleRate),o=n.getChannelData(0);return r.generate(o),n},p.Live=function(e,a,r){r=r||2048;var n={},o=new h,i=o.createGain();return i.connect(o.destination),n._context=o,n._volume=i,D(e,function(e,t){n[t]=function(){p.Node(o,e,a,r).connect(i)}}),n._close=function(){o.close()},n._play=function(e){p.Node(o,e,a,r).connect(i)},n}):p.Live=p.Sounds,p.Module={},p.G={};var e=p.stage={PhaseSpeed:0,PhaseSpeedMod:10,Generator:20,SampleMod:30,Volume:40};function n(e,t){return e.stage-t.stage}function o(e,t){for(var a=0;a<t.length;a+=1){var r=t[a],n=e[r.name]||{};D(r.params,function(e,t){void 0===n[t]&&(n[t]=e.D)}),e[r.name]=n}}function d(e,t){e=e||{},t=t||p.DefaultModules,e="function"==typeof e?e():JSON.parse(JSON.stringify(e)),this.finished=!1,this.state={SampleRate:e.SampleRate||p.SampleRate},(t=t.slice()).sort(n),o(e,this.modules=t);for(var a=0;a<this.modules.length;a+=1){var r=this.modules[a];this.modules[a].setup(this.state,e[r.name])}}p.InitDefaultParams=o,(p.Processor=d).prototype={generate:function(e){for(var t=0;t<e.length;t+=1)e[t]=0;if(!this.finished){var a=this.state,r=0|e.length;for(t=0;t<this.modules.length;t+=1){var n=0|this.modules[t].process(a,e.subarray(0,r));r=Math.min(r,n)}r<e.length&&(this.finished=!0);for(t=r;t<e.length;t++)e[t]=0}},getSamplesLeft:function(){for(var e=0,t=0;t<this.state.envelopes.length;t+=1)e+=this.state.envelopes[t].N;return 0===e&&(e=3*this.state.SampleRate),e}},p.Module.Frequency={name:"Frequency",params:{Start:{L:30,H:1800,D:440},Min:{L:30,H:1800,D:30},Max:{L:30,H:1800,D:1800},Slide:{L:-1,H:1,D:0},DeltaSlide:{L:-1,H:1,D:0},RepeatSpeed:{L:0,H:3,D:0},ChangeAmount:{L:-12,H:12,D:0},ChangeSpeed:{L:0,H:1,D:0}},stage:e.PhaseSpeed,setup:function(e,t){var a=e.SampleRate;e.phaseParams=t,e.phaseSpeed=t.Start*c/a,e.phaseSpeedMax=t.Max*c/a,e.phaseSpeedMin=t.Min*c/a,e.phaseSpeedMin=Math.min(e.phaseSpeedMin,e.phaseSpeed),e.phaseSpeedMax=Math.max(e.phaseSpeedMax,e.phaseSpeed),e.phaseSlide=1+64*r(t.Slide,3)/a,e.phaseDeltaSlide=r(t.DeltaSlide,3)/(1e3*a),e.repeatTime=0,e.repeatLimit=1/0,0<t.RepeatSpeed&&(e.repeatLimit=t.RepeatSpeed*a),e.arpeggiatorTime=0,e.arpeggiatorLimit=t.ChangeSpeed*a,0==t.ChangeAmount&&(e.arpeggiatorLimit=1/0),e.arpeggiatorMod=1+t.ChangeAmount/12},process:function(e,t){for(var a=+e.phaseSpeed,r=+e.phaseSpeedMin,n=+e.phaseSpeedMax,o=+e.phaseSlide,i=+e.phaseDeltaSlide,u=e.repeatTime,s=e.repeatLimit,l=e.arpeggiatorTime,p=e.arpeggiatorLimit,h=e.arpeggiatorMod,d=0;d<t.length;d++){if(a=(a*=o+=i)<r?r:n<a?n:a,s<u)return this.setup(e,e.phaseParams),d+this.process(e,t.subarray(d))-1;u++,p<l&&(a*=h,p=1/(l=0)),l++,t[d]+=a}return e.repeatTime=u,e.arpeggiatorTime=l,e.arpeggiatorLimit=p,e.phaseSpeed=a,e.phaseSlide=o,t.length}},p.Module.Vibrato={name:"Vibrato",params:{Depth:{L:0,H:1,D:0},DepthSlide:{L:-1,H:1,D:0},Frequency:{L:.01,H:48,D:0},FrequencySlide:{L:-1,H:1,D:0}},stage:e.PhaseSpeedMod,setup:function(e,t){var a=e.SampleRate;e.vibratoPhase=0,e.vibratoDepth=t.Depth,e.vibratoPhaseSpeed=t.Frequency*c/a,e.vibratoPhaseSpeedSlide=1+3*r(t.FrequencySlide,3)/a,e.vibratoDepthSlide=t.DepthSlide/a},process:function(e,t){var a=+e.vibratoPhase,r=+e.vibratoDepth,n=+e.vibratoPhaseSpeed,o=+e.vibratoPhaseSpeedSlide,i=+e.vibratoDepthSlide;if(0==r&&i<=0)return t.length;for(var u=0;u<t.length;u++)c<(a+=n)&&(a-=c),t[u]+=t[u]*l(a)*r,n*=o,r=A(r+=i);return e.vibratoPhase=a,e.vibratoDepth=r,e.vibratoPhaseSpeed=n,t.length}},p.Module.Generator={name:"Generator",params:{Func:{C:p.G,D:"square"},A:{L:0,H:1,D:0},B:{L:0,H:1,D:0},ASlide:{L:-1,H:1,D:0},BSlide:{L:-1,H:1,D:0}},stage:e.Generator,setup:function(e,t){e.generatorPhase=0,"string"==typeof t.Func?e.generator=p.G[t.Func]:e.generator=t.Func,"object"==typeof e.generator&&(e.generator=e.generator.create()),L("function"==typeof e.generator,"generator must be a function"),e.generatorA=t.A,e.generatorASlide=t.ASlide,e.generatorB=t.B,e.generatorBSlide=t.BSlide},process:function(e,t){return e.generator(e,t)}};p.Module.Guitar={name:"Guitar",params:{A:{L:0,H:1,D:1},B:{L:0,H:1,D:1},C:{L:0,H:1,D:1}},stage:e.Generator,setup:function(e,t){e.guitarA=t.A,e.guitarB=t.B,e.guitarC=t.C,e.guitarBuffer=q(65536),e.guitarHead=0;for(var a=e.guitarBuffer,r=0;r<a.length;r++)a[r]=2*Math.random()-1},process:function(e,t){for(var a=65536,r=a-1,n=+e.guitarA,o=+e.guitarB,i=+e.guitarC,u=n+o+i,s=e.guitarHead,l=e.guitarBuffer,p=0;p<t.length;p++){var h=c/t[p]|0,d=s-(h=a<h?a:h)+a&r;l[s]=(l[d-0+a&r]*n+l[d-1+a&r]*o+l[d-2+a&r]*i)/u,t[p]=l[s],s=s+1&r}return e.guitarHead=s,t.length}},p.Module.Filter={name:"Filter",params:{LP:{L:0,H:1,D:1},LPSlide:{L:-1,H:1,D:0},LPResonance:{L:0,H:1,D:0},HP:{L:0,H:1,D:0},HPSlide:{L:-1,H:1,D:0}},stage:e.SampleMod+0,setup:function(e,t){e.FilterEnabled=t.HP>f||t.LP<1-f,e.LPEnabled=t.LP<1-f,e.LP=r(t.LP,3)/10,e.LPSlide=1+100*t.LPSlide/e.SampleRate,e.LPPos=0,e.LPPosSlide=0,e.LPDamping=5/(1+20*r(t.LPResonance,2))*(.01+t.LP),e.LPDamping=1-Math.min(e.LPDamping,.8),e.HP=r(t.HP,2)/10,e.HPPos=0,e.HPSlide=1+100*t.HPSlide/e.SampleRate},enabled:function(e){return e.FilterEnabled},process:function(e,t){if(!this.enabled(e))return t.length;for(var a=+e.LP,r=+e.LPPos,n=+e.LPPosSlide,o=+e.LPSlide,i=+e.LPDamping,u=+e.LPEnabled,s=+e.HP,l=+e.HPPos,p=+e.HPSlide,h=0;h<t.length;h++){(f<s||s<-f)&&(s=(s*=p)<f?f:.1<s?.1:s);var d=r;a=(a*=o)<0?a=0:.1<a?.1:a;var c=t[h];u?(n+=(c-r)*a,n*=i):(r=c,n=0),l+=(r+=n)-d,l*=1-s,t[h]=l}return e.LPPos=r,e.LPPosSlide=n,e.LP=a,e.HP=s,e.HPPos=l,t.length}};var a=1024;function i(){return D(p.Module,function(){return{}})}function S(e){for(var t in e)0==b(e[t]).length&&delete e[t]}p.Module.Phaser={name:"Phaser",params:{Offset:{L:-1,H:1,D:0},Sweep:{L:-1,H:1,D:0}},stage:e.SampleMod+1,setup:function(e,t){e.phaserBuffer=q(a),e.phaserPos=0,e.phaserOffset=r(t.Offset,2)*(a-4),e.phaserOffsetSlide=4e3*r(t.Sweep,3)/e.SampleRate},enabled:function(e){return t(e.phaserOffsetSlide)>f||t(e.phaserOffset)>f},process:function(e,t){if(!this.enabled(e))return t.length;for(var a=e.phaserBuffer,r=0|e.phaserPos,n=+e.phaserOffset,o=+e.phaserOffsetSlide,i=0;i<t.length;i++){(n+=o)<0&&(n=-n,o=-o),1023<n&&(n=1023,o=0),a[r]=t[i];var u=r-(0|n)+1024&1023;t[i]+=a[u],r=r+1&1023|0}return e.phaserPos=r,e.phaserOffset=n,t.length}},p.Module.Volume={name:"Volume",params:{Master:{L:0,H:1,D:.5},Attack:{L:.001,H:1,D:.01},Sustain:{L:0,H:2,D:.3},Punch:{L:0,H:3,D:1},Decay:{L:.001,H:2,D:1}},stage:e.Volume,setup:function(e,t){var a=e.SampleRate,r=t.Master,n=r*(1+t.Punch);e.envelopes=[{S:0,E:r,N:t.Attack*a|0},{S:n,E:r,N:t.Sustain*a|0},{S:r,E:0,N:t.Decay*a|0}];for(var o=0;o<e.envelopes.length;o+=1){var i=e.envelopes[o];i.G=(i.E-i.S)/i.N}},process:function(e,t){for(var a=0;0<e.envelopes.length&&a<t.length;){for(var r=e.envelopes[0],n=r.S,o=r.G,i=0|Math.min(t.length-a,r.N),u=a+i|0;a<u;a+=1)t[a]*=n,n=M(n+=o,0,10);r.S=n,r.N-=i,r.N<=0&&e.envelopes.shift()}return a}},p.DefaultModules=[p.Module.Frequency,p.Module.Vibrato,p.Module.Generator,p.Module.Filter,p.Module.Phaser,p.Module.Volume],p.DefaultModules.sort(n),p.EmptyParams=i,p._RemoveEmptyParams=S,p.Preset={Reset:function(){return i()},Coin:function(){var e=i();return e.Frequency.Start=F(880,660),e.Volume.Sustain=F(.1),e.Volume.Decay=F(.4,.1),e.Volume.Punch=F(.3,.3),F()<.5&&(e.Frequency.ChangeSpeed=F(.15,.1),e.Frequency.ChangeAmount=F(8,4)),S(e),e},Laser:function(){var e=i();return e.Generator.Func=H(["square","saw","sine"]),F()<.33?(e.Frequency.Start=F(880,440),e.Frequency.Min=F(.1),e.Frequency.Slide=F(.3,-.8)):(e.Frequency.Start=F(1200,440),e.Frequency.Min=e.Frequency.Start-F(880,440),e.Frequency.Min<110&&(e.Frequency.Min=110),e.Frequency.Slide=F(.3,-1)),F()<.5?(e.Generator.A=F(.5),e.Generator.ASlide=F(.2)):(e.Generator.A=F(.5,.4),e.Generator.ASlide=F(.7)),e.Volume.Sustain=F(.2,.1),e.Volume.Decay=F(.4),F()<.5&&(e.Volume.Punch=F(.3)),F()<.33&&(e.Phaser.Offset=F(.2),e.Phaser.Sweep=F(.2)),F()<.5&&(e.Filter.HP=F(.3)),S(e),e},Explosion:function(){var e=i();return e.Generator.Func="noise",F()<.5?(e.Frequency.Start=F(440,40),e.Frequency.Slide=F(.4,-.1)):(e.Frequency.Start=F(1600,220),e.Frequency.Slide=F(-.2,-.2)),F()<.2&&(e.Frequency.Slide=0),F()<.3&&(e.Frequency.RepeatSpeed=F(.5,.3)),e.Volume.Sustain=F(.3,.1),e.Volume.Decay=F(.5),e.Volume.Punch=F(.6,.2),F()<.5&&(e.Phaser.Offset=F(.9,-.3),e.Phaser.Sweep=F(-.3)),F()<.33&&(e.Frequency.ChangeSpeed=F(.3,.6),e.Frequency.ChangeAmount=F(24,-12)),S(e),e},Powerup:function(){var e=i();return F()<.5?e.Generator.Func="saw":e.Generator.A=F(.6),e.Frequency.Start=F(220,440),F()<.5?(e.Frequency.Slide=F(.5,.2),e.Frequency.RepeatSpeed=F(.4,.4)):(e.Frequency.Slide=F(.2,.05),F()<.5&&(e.Vibrato.Depth=F(.6,.1),e.Vibrato.Frequency=F(30,10))),e.Volume.Sustain=F(.4),e.Volume.Decay=F(.4,.1),S(e),e},Hit:function(){var e=i();return e.Generator.Func=H(["square","saw","noise"]),e.Generator.A=F(.6),e.Generator.ASlide=F(1,-.5),e.Frequency.Start=F(880,220),e.Frequency.Slide=-F(.4,.3),e.Volume.Sustain=F(.1),e.Volume.Decay=F(.2,.1),F()<.5&&(e.Filter.HP=F(.3)),S(e),e},Jump:function(){var e=i();return e.Generator.Func="square",e.Generator.A=F(.6),e.Frequency.Start=F(330,330),e.Frequency.Slide=F(.4,.2),e.Volume.Sustain=F(.3,.1),e.Volume.Decay=F(.2,.1),F()<.5&&(e.Filter.HP=F(.3)),F()<.3&&(e.Filter.LP=F(-.6,1)),S(e),e},Select:function(){var e=i();return e.Generator.Func=H(["square","saw"]),e.Generator.A=F(.6),e.Frequency.Start=F(660,220),e.Volume.Sustain=F(.1,.1),e.Volume.Decay=F(.2),e.Filter.HP=.2,S(e),e},Lucky:function(){var e=i();return D(e,function(r,e){D(p.Module[e].params,function(e,t){if(e.C){var a=b(e.C);r[t]=a[a.length*Math.random()|0]}else r[t]=Math.random()*(e.H-e.L)+e.L})}),e.Volume.Master=.4,e.Filter={},S(e),e}},p.G.unoise=g("sample = Math.random();"),p.G.sine=g("sample = Math.sin(phase);"),p.G.saw=g("sample = 2*(phase/TAU - ((phase/TAU + 0.5)|0));"),p.G.triangle=g("sample = Math.abs(4 * ((phase/TAU - 0.25)%1) - 2) - 1;"),p.G.square=g("var s = Math.sin(phase); sample = s > A ? 1.0 : s < A ? -1.0 : A;"),p.G.synth=g("sample = Math.sin(phase) + .5*Math.sin(phase/2) + .3*Math.sin(phase/4);");function g(e){return new Function("$","block","var TAU = Math.PI * 2;\nvar sample;\nvar phase = +$.generatorPhase,\n\tA = +$.generatorA, ASlide = +$.generatorASlide,\n\tB = +$.generatorB, BSlide = +$.generatorBSlide;\n\nfor(var i = 0; i < block.length; i++){\n\tvar phaseSpeed = block[i];\n\tphase += phaseSpeed;\n\tif(phase > TAU){ phase -= TAU };\n\tA += ASlide; B += BSlide;\n   A = A < 0 ? 0 : A > 1 ? 1 : A;\n   B = B < 0 ? 0 : B > 1 ? 1 : B;\n"+e+"\tblock[i] = sample;\n}\n\n$.generatorPhase = phase;\n$.generatorA = A;\n$.generatorB = B;\nreturn block.length;\n")}function m(e){"undefined"!=typeof Float32Array&&L(e instanceof Float32Array,"data must be an Float32Array");var t=s*u>>3,a=p.SampleRate*t,r=function(e){if("undefined"==typeof Uint8Array)for(var t=new Array(e),a=0;a<t.length;a++)t[a]=0;return new Uint8Array(e)}(44+2*e.length),n=0;function o(e){for(var t=0;t<e.length;t+=1)r[n]=e.charCodeAt(t),n++}function i(e,t){t<=0||(r[n]=255&e,n++,i(e>>8,t-1))}return o("RIFF"),i(36+2*e.length,4),o("WAVEfmt "),i(16,4),i(1,2),i(s,2),i(p.SampleRate,4),i(a,4),i(t,2),i(u,2),o("data"),i(2*e.length,4),P(r.subarray(n),e),r}function v(e){var t=m(e);return new Audio("data:audio/wav;base64,"+y(t))}function P(e,t){L(e.length/2==t.length,"the target buffer must be twice as large as the iinput");for(var a=0,r=0;r<t.length;r++){var n=32767*+t[r]|0;n=n<-32768?-32768:32767<n?32767:n,n+=n<0?65536:0,e[a]=255&n,e[++a]=n>>8,a++}}function y(e){for(var t="",a=0;a<e.length;a+=32768){var r=Math.min(a+32768,e.length);t+=String.fromCharCode.apply(null,e.subarray(a,r))}return btoa(t)}function L(e,t){if(!e)throw new Error(t)}function M(e,t,a){return a=+a,(e=+e)<(t=+t)?+t:a<e?+a:+e}function A(e){return(e=+e)<0?0:1<e?1:+e}function D(e,t){var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t(e[r],r));return a}function F(e,t){var a=Math.random();return void 0!==e&&(a*=e),void 0!==t&&(a+=t),a}function H(e){return e[e.length*Math.random()|0]}function b(e){var t=[];for(var a in e)t.push(a);return t}function q(e){if("undefined"==typeof Float32Array)for(var t=new Array(e),a=0;a<t.length;a++)t[a]=0;return new Float32Array(e)}return p.G.noise=g("if(phase % TAU < 4){__noiseLast = Math.random() * 2 - 1;} sample = __noiseLast;"),p.G.string={create:function(){for(var d=65536,c=d-1,f=q(d),e=0;e<f.length;e++)f[e]=2*Math.random()-1;var S=0;return function(e,t){for(var a=2*Math.PI,r=+e.generatorA,n=+e.generatorASlide,o=+e.generatorB,i=+e.generatorBSlide,u=f,s=0;s<t.length;s++){var l=t[s];r=(r+=n)<0?0:1<r?1:r,o=(o+=i)<0?0:1<o?1:o;var p=S-(a/l|0)+d&c,h=(1*u[p-0+d&c]+u[p-1+d&c]*r+u[p-2+d&c]*o)/(1+r+o);u[S]=h,t[s]=u[S],S=S+1&c}return e.generatorA=r,e.generatorB=o,t.length}}},p.CreateWave=m,p.CreateAudio=v,p.DownloadAsFile=function(e){L(e instanceof Audio,"input must be an Audio object"),document.location.href=e.src},p.Util={},p.Util.CopyFToU8=P,p.Util.U8ToB64=y,p._createFloatArray=q,p});