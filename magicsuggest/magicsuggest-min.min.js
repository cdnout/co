!function(h){"use strict";function s(e,t){var l=this,n=h.extend({},t),c=h.extend(!0,{},{allowFreeEntries:!0,allowDuplicates:!1,ajaxConfig:{},autoSelect:!0,selectFirst:!1,queryParam:"query",beforeSend:function(){},cls:"",data:null,dataUrlParams:{},disabled:!1,disabledField:null,displayField:"name",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(e){return"Please reduce your entry by "+e+" character"+(1<e?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(e){return"You cannot choose more than "+e+" item"+(1<e?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(e){return"Please type "+e+" more character"+(1<e?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",renderer:null,required:!1,resultAsString:!1,resultAsStringDelimiter:",",resultsField:"results",selectionCls:"",selectionContainer:null,selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useZebraStyle:!1,value:null,valueField:"id",vregex:null,vtype:null},n);this.addToSelection=function(e,t){var n;(!c.maxSelection||d.length<c.maxSelection)&&(h.isArray(e)||(e=[e]),n=!1,h.each(e,function(e,t){!c.allowDuplicates&&-1!==h.inArray(t[c.valueField],l.getValue())||(d.push(t),n=!0)}),!0===n&&(m._renderSelection(),this.empty(),!0!==t&&h(this).trigger("selectionchange",[this,this.getSelection()]))),this.input.attr("placeholder","inner"===c.selectionPosition&&0<this.getValue().length?"":c.placeholder)},this.clear=function(e){this.removeFromSelection(d.slice(0),e)},this.collapse=function(){!0===c.expanded&&(this.combobox.detach(),c.expanded=!1,h(this).trigger("collapse",[this]))},this.disable=function(){this.container.addClass("ms-ctn-disabled"),c.disabled=!0,l.input.attr("disabled",!0)},this.empty=function(){this.input.val("")},this.enable=function(){this.container.removeClass("ms-ctn-disabled"),c.disabled=!1,l.input.attr("disabled",!1)},this.expand=function(){!c.expanded&&(this.input.val().length>=c.minChars||0<this.combobox.children().length)&&(this.combobox.appendTo(this.container),m._processSuggestions(),c.expanded=!0,h(this).trigger("expand",[this]))},this.isDisabled=function(){return c.disabled},this.isValid=function(){var n=!1===c.required||0<d.length;return(c.vtype||c.vregex)&&h.each(d,function(e,t){n=n&&m._validateSingleItem(t[c.valueField])}),n},this.getDataUrlParams=function(){return c.dataUrlParams},this.getName=function(){return c.name},this.getSelection=function(){return d},this.getRawValue=function(){return l.input.val()},this.getValue=function(){return h.map(d,function(e){return e[c.valueField]})},this.removeFromSelection=function(e,t){h.isArray(e)||(e=[e]);var i=!1;h.each(e,function(e,t){var n=h.inArray(t[c.valueField],l.getValue());-1<n&&(d.splice(n,1),i=!0)}),!0===i&&(m._renderSelection(),!0!==t&&h(this).trigger("selectionchange",[this,this.getSelection()]),c.expandOnFocus&&l.expand(),c.expanded&&m._processSuggestions()),this.input.attr("placeholder","inner"===c.selectionPosition&&0<this.getValue().length?"":c.placeholder)},this.getData=function(){return o},this.setData=function(e){c.data=e,m._processSuggestions()},this.setName=function(e){(c.name=e)&&(c.name+=0<e.indexOf("[]")?"":"[]"),l._valueContainer&&h.each(l._valueContainer.children(),function(e,t){t.name=c.name})},this.setSelection=function(e){this.clear(),this.addToSelection(e)},this.setValue=function(e){var a=[];h.each(e,function(e,n){var t,i=!1;h.each(o,function(e,t){if(t[c.valueField]==n)return a.push(t),!(i=!0)}),i||("object"==typeof n?a.push(n):((t={})[c.valueField]=n,t[c.displayField]=n,a.push(t)))}),0<a.length&&this.addToSelection(a)},this.setDataUrlParams=function(e){c.dataUrlParams=h.extend({},e)},this.setMaxSelection=function(e){e<0&&(e=null),null!==e&&d.length>e&&this.removeFromSelection(d.slice(e)),c.maxSelection=e};var s,d=[],u=0,i=!1,r=null,o=[],g=!1,m={_displaySuggestions:function(e){l.combobox.show(),l.combobox.empty();var t,n=0,i=0;if(null===r)m._renderComboItems(e),n=u*e.length;else{for(var a in r)i+=1,h("<div/>",{class:"ms-res-group",html:a}).appendTo(l.combobox),m._renderComboItems(r[a].items,!0);var s,o=l.combobox.find(".ms-res-group").outerHeight();n=null!==o?(s=i*o,u*e.length+s):u*(e.length+i)}n<l.combobox.height()||n<=c.maxDropHeight?l.combobox.height(n):n>=l.combobox.height()&&n>c.maxDropHeight&&l.combobox.height(c.maxDropHeight),1===e.length&&!0===c.autoSelect&&l.combobox.children().filter(":not(.ms-res-item-disabled):last").addClass("ms-res-item-active"),!0===c.selectFirst&&l.combobox.children().filter(":not(.ms-res-item-disabled):first").addClass("ms-res-item-active"),0===e.length&&""!==l.getRawValue()&&(t=c.noSuggestionText.replace(/\{\{.*\}\}/,l.input.val()),m._updateHelper(t),l.collapse()),!1===c.allowFreeEntries&&(0===e.length?(h(l.input).addClass(c.invalidCls),l.combobox.hide()):h(l.input).removeClass(c.invalidCls))},_getEntriesFromStringArray:function(e){var i=[];return h.each(e,function(e,t){var n={};n[c.displayField]=n[c.valueField]=h.trim(t),i.push(n)}),i},_highlightSuggestion:function(e){var n=l.input.val();if(h.each(["^","$","*","+","?",".","(",")",":","!","|","{","}","[","]"],function(e,t){n=n.replace(t,"\\"+t)}),0===n.length)return e;var t=!0===c.matchCase?"g":"gi";return e.replace(new RegExp("("+n+")(?!([^<]+)?>)",t),"<em>$1</em>")},_moveSelectedRow:function(e){var t,n,i,a;c.expanded||l.expand(),t=l.combobox.find(".ms-res-item:not(.ms-res-item-disabled)"),n="down"===e?t.eq(0):t.filter(":last"),0<(i=l.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first")).length&&("down"===e?(0===(n=i.nextAll(".ms-res-item:not(.ms-res-item-disabled)").first()).length&&(n=t.eq(0)),a=l.combobox.scrollTop(),l.combobox.scrollTop(0),n[0].offsetTop+n.outerHeight()>l.combobox.height()&&l.combobox.scrollTop(a+u)):(0===(n=i.prevAll(".ms-res-item:not(.ms-res-item-disabled)").first()).length&&(n=t.filter(":last"),l.combobox.scrollTop(u*t.length)),n[0].offsetTop<l.combobox.scrollTop()&&l.combobox.scrollTop(l.combobox.scrollTop()-u))),t.removeClass("ms-res-item-active"),n.addClass("ms-res-item-active")},_processSuggestions:function(e){var t=null,n=e||c.data;if(null!==n){if("function"==typeof n&&(n=n.call(l,l.getRawValue())),"string"==typeof n){h(l).trigger("beforeload",[l]);var i={};i[c.queryParam]=l.input.val();var a=h.extend(i,c.dataUrlParams);return void h.ajax(h.extend({type:c.method,url:n,data:a,beforeSend:c.beforeSend,success:function(e){t="string"==typeof e?JSON.parse(e):e,m._processSuggestions(t),h(l).trigger("load",[l,t]),m._asyncValues&&(l.setValue("string"==typeof m._asyncValues?JSON.parse(m._asyncValues):m._asyncValues),m._renderSelection(),delete m._asyncValues)},error:function(e,t,n){h(l).trigger("error",[l,e,t,n])}},c.ajaxConfig))}o=0<n.length&&"string"==typeof n[0]?m._getEntriesFromStringArray(n):n[c.resultsField]||n;var s="remote"===c.mode?o:m._sortAndTrim(o);m._displaySuggestions(m._group(s))}},_render:function(e){if(l.setName(c.name),l.container=h("<div/>",{class:"ms-ctn form-control "+(c.resultAsString?"ms-as-string ":"")+c.cls+(h(e).hasClass("input-lg")?" input-lg":"")+(h(e).hasClass("input-sm")?" input-sm":"")+(!0===c.disabled?" ms-ctn-disabled":"")+(!0===c.editable?"":" ms-ctn-readonly")+(!1===c.hideTrigger?"":" ms-no-trigger"),style:c.style,id:c.id}),l.container.on("focus",h.proxy(p._onFocus,this)),l.container.on("blur",h.proxy(p._onBlur,this)),l.container.on("keydown",h.proxy(p._onKeyDown,this)),l.container.on("keyup",h.proxy(p._onKeyUp,this)),l.input=h("<input/>",h.extend({type:"text",class:!0===c.editable?"":" ms-input-readonly",readonly:!c.editable,placeholder:c.placeholder,disabled:c.disabled},c.inputCfg)),l.input.on("focus",h.proxy(p._onInputFocus,this)),l.input.on("click",h.proxy(p._onInputClick,this)),l.combobox=h("<div/>",{class:"ms-res-ctn dropdown-menu"}).height(c.maxDropHeight),l.combobox.on("click","div.ms-res-item",h.proxy(p._onComboItemSelected,this)),l.combobox.on("mouseover","div.ms-res-item",h.proxy(p._onComboItemMouseOver,this)),c.selectionContainer?(l.selectionContainer=c.selectionContainer,h(l.selectionContainer).addClass("ms-sel-ctn")):l.selectionContainer=h("<div/>",{class:"ms-sel-ctn"}),l.selectionContainer.on("click",h.proxy(p._onFocus,this)),"inner"!==c.selectionPosition||c.selectionContainer?l.container.append(l.input):l.selectionContainer.append(l.input),l.helper=h("<span/>",{class:"ms-helper "+c.infoMsgCls}),m._updateHelper(),l.container.append(l.helper),h(e).replaceWith(l.container),!c.selectionContainer)switch(c.selectionPosition){case"bottom":l.selectionContainer.insertAfter(l.container),!0===c.selectionStacked&&(l.selectionContainer.width(l.container.width()),l.selectionContainer.addClass("ms-stacked"));break;case"right":l.selectionContainer.insertAfter(l.container),l.container.css("float","left");break;default:l.container.append(l.selectionContainer)}!1===c.hideTrigger&&(l.trigger=h("<div/>",{class:"ms-trigger",html:'<div class="ms-trigger-ico"></div>'}),l.trigger.on("click",h.proxy(p._onTriggerClick,this)),l.container.append(l.trigger)),h(window).on("resize",h.proxy(p._onWindowResized,this)),null===c.value&&null===c.data||("string"==typeof c.data?(m._asyncValues=c.value,m._processSuggestions()):(m._processSuggestions(),null!==c.value&&(l.setValue(c.value),m._renderSelection()))),h("body").on("click",function(e){l.container.hasClass("ms-ctn-focus")&&0===l.container.has(e.target).length&&e.target.className.indexOf("ms-res-item")<0&&e.target.className.indexOf("ms-close-btn")<0&&l.container[0]!==e.target&&p._onBlur()}),!0===c.expanded&&(c.expanded=!1,l.expand())},_renderComboItems:function(e,s){var o=this,r="";h.each(e,function(e,t){var n=null!==c.renderer?c.renderer.call(o,t):t[c.displayField],i=null!==c.disabledField&&!0===t[c.disabledField],a=h("<div/>",{class:"ms-res-item "+(s?"ms-res-item-grouped ":"")+(i?"ms-res-item-disabled ":"")+(e%2==1&&!0===c.useZebraStyle?"ms-res-odd":""),html:!0===c.highlight?m._highlightSuggestion(n):n,"data-json":JSON.stringify(t)});r+=h("<div/>").append(a).html()}),l.combobox.append(r),u=l.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var s=this,e=0,t=0,o=[],r=!0===c.resultAsString&&!i;l.selectionContainer.find(".ms-sel-item").remove(),void 0!==l._valueContainer&&l._valueContainer.remove(),h.each(d,function(e,t){var n,i=null!==c.selectionRenderer?c.selectionRenderer.call(s,t):t[c.displayField],a=m._validateSingleItem(t[c.displayField])?"":" ms-sel-invalid";!0==r?n=h("<div/>",{class:"ms-sel-item ms-sel-text "+c.selectionCls+a,html:i+(e===d.length-1?"":c.resultAsStringDelimiter)}).data("json",t):(n=h("<div/>",{class:"ms-sel-item "+c.selectionCls+a,html:i}).data("json",t),!1===c.disabled&&h("<span/>",{class:"ms-close-btn"}).data("json",t).prependTo(n).on("click",h.proxy(p._onTagTriggerClick,s))),o.push(n)}),l.selectionContainer.prepend(o),l._valueContainer=h("<div/>",{style:"display: none;"}),h.each(l.getValue(),function(e,t){h("<input/>",{type:"hidden",name:c.name,value:t}).appendTo(l._valueContainer)}),l._valueContainer.appendTo(l.selectionContainer),"inner"!==c.selectionPosition||c.selectionContainer||(l.input.width(0),t=l.input.offset().left-l.selectionContainer.offset().left,e=l.container.width()-t-42,l.input.width(e)),d.length===c.maxSelection?m._updateHelper(c.maxSelectionRenderer.call(this,d.length)):l.helper.hide()},_selectItem:function(e){1===c.maxSelection&&(d=[]),l.addToSelection(e.data("json")),e.removeClass("ms-res-item-active"),!1!==c.expandOnFocus&&d.length!==c.maxSelection||l.collapse(),i?i&&(c.expandOnFocus||g)&&(m._processSuggestions(),g&&l.expand()):l.input.trigger("focus")},_sortAndTrim:function(e){var i=l.getRawValue(),a=[],n=[],s=l.getValue();return 0<i.length?h.each(e,function(e,t){var n=t[c.displayField];(!0===c.matchCase&&-1<n.indexOf(i)||!1===c.matchCase&&-1<n.toLowerCase().indexOf(i.toLowerCase()))&&(!1!==c.strictSuggest&&0!==n.toLowerCase().indexOf(i.toLowerCase())||a.push(t))}):a=e,h.each(a,function(e,t){!c.allowDuplicates&&-1!==h.inArray(t[c.valueField],s)||n.push(t)}),null!==c.sortOrder&&n.sort(function(e,t){return e[c.sortOrder]<t[c.sortOrder]?"asc"===c.sortDir?-1:1:e[c.sortOrder]>t[c.sortOrder]?"asc"===c.sortDir?1:-1:0}),c.maxSuggestions&&0<c.maxSuggestions&&(n=n.slice(0,c.maxSuggestions)),n},_group:function(e){return null!==c.groupBy&&(r={},h.each(e,function(e,t){var n=-1<c.groupBy.indexOf(".")?c.groupBy.split("."):c.groupBy,i=t[c.groupBy];if("string"!=typeof n)for(i=t;0<n.length;)i=i[n.shift()];void 0===r[i]?r[i]={title:i,items:[t]}:r[i].items.push(t)})),e},_updateHelper:function(e){l.helper.html(e),l.helper.is(":visible")||l.helper.fadeIn()},_validateSingleItem:function(e){if(null!==c.vregex&&c.vregex instanceof RegExp)return c.vregex.test(e);if(null!==c.vtype)switch(c.vtype){case"alpha":return/^[a-zA-Z_]+$/.test(e);case"alphanum":return/^[a-zA-Z0-9_]+$/.test(e);case"email":return/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.test(e);case"url":return/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.test(e);case"ipaddress":return/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(e)}return!0}},p={_onBlur:function(){var e;l.container.removeClass("ms-ctn-focus"),l.collapse(),i=!1,""!==l.getRawValue()&&!0===c.allowFreeEntries&&((e={})[c.displayField]=e[c.valueField]=h.trim(l.getRawValue()),l.addToSelection(e)),m._renderSelection(),!1===l.isValid()?l.container.addClass(c.invalidCls):""!==l.input.val()&&!1===c.allowFreeEntries&&(l.empty(),m._updateHelper("")),h(l).trigger("blur",[l])},_onComboItemMouseOver:function(e){var t=h(e.currentTarget);t.hasClass("ms-res-item-disabled")||(l.combobox.children().removeClass("ms-res-item-active"),t.addClass("ms-res-item-active"))},_onComboItemSelected:function(e){h(e.currentTarget).hasClass("ms-res-item-disabled")||m._selectItem(h(e.currentTarget))},_onFocus:function(){l.input.trigger("focus")},_onInputClick:function(){!1===l.isDisabled()&&i&&!0===c.toggleOnClick&&(c.expanded?l.collapse():l.expand())},_onInputFocus:function(){var e;!1!==l.isDisabled()||i||(i=!0,l.container.addClass("ms-ctn-focus"),l.container.removeClass(c.invalidCls),e=l.getRawValue().length,!0===c.expandOnFocus&&l.expand(),d.length===c.maxSelection?m._updateHelper(c.maxSelectionRenderer.call(this,d.length)):e<c.minChars&&m._updateHelper(c.minCharsRenderer.call(this,c.minChars-e)),m._renderSelection(),h(l).trigger("focus",[l]))},_onKeyDown:function(e){var t=l.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),n=l.input.val();if(h(l).trigger("keydown",[l,e]),9!==e.keyCode||!1!==c.useTabKey&&(!0!==c.useTabKey||0!==t.length||0!==l.input.val().length))switch(e.keyCode){case 8:0===n.length&&0<l.getSelection().length&&"inner"===c.selectionPosition&&(d.pop(),m._renderSelection(),h(l).trigger("selectionchange",[l,l.getSelection()]),l.input.attr("placeholder","inner"===c.selectionPosition&&0<l.getValue().length?"":c.placeholder),l.input.trigger("focus"),e.preventDefault());break;case 9:case 27:e.preventDefault();break;case 13:""===n&&!c.expanded||e.preventDefault();break;case 188:!0===c.useCommaKey&&e.preventDefault();break;case 17:g=!0;break;case 40:e.preventDefault(),m._moveSelectedRow("down");break;case 38:e.preventDefault(),m._moveSelectedRow("up");break;default:d.length===c.maxSelection&&e.preventDefault()}else p._onBlur()},_onKeyUp:function(e){var t,n=l.getRawValue(),i=0<h.trim(l.input.val()).length&&(!c.maxEntryLength||h.trim(l.input.val()).length<=c.maxEntryLength),a={};if(h(l).trigger("keyup",[l,e]),clearTimeout(s),27===e.keyCode&&c.expanded&&l.combobox.hide(),9===e.keyCode&&!1===c.useTabKey||13<e.keyCode&&e.keyCode<32)17===e.keyCode&&(g=!1);else switch(e.keyCode){case 38:case 40:e.preventDefault();break;case 13:case 9:case 188:if(188!==e.keyCode||!0===c.useCommaKey){if(e.preventDefault(),!0===c.expanded&&0<(t=l.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first")).length)return void m._selectItem(t);!0==i&&!0===c.allowFreeEntries&&(a[c.displayField]=a[c.valueField]=h.trim(n),l.addToSelection(a),l.collapse(),l.input.trigger("focus"));break}default:d.length===c.maxSelection?m._updateHelper(c.maxSelectionRenderer.call(this,d.length)):n.length<c.minChars?(m._updateHelper(c.minCharsRenderer.call(this,c.minChars-n.length)),!0===c.expanded&&l.collapse()):c.maxEntryLength&&n.length>c.maxEntryLength?(m._updateHelper(c.maxEntryRenderer.call(this,n.length-c.maxEntryLength)),!0===c.expanded&&l.collapse()):(l.helper.hide(),c.minChars<=n.length&&(s=setTimeout(function(){!0===c.expanded?m._processSuggestions():l.expand()},c.typeDelay)))}},_onTagTriggerClick:function(e){l.removeFromSelection(h(e.currentTarget).data("json"))},_onTriggerClick:function(){var e;!1!==l.isDisabled()||!0===c.expandOnFocus&&d.length===c.maxSelection||(h(l).trigger("triggerclick",[l]),!0===c.expanded?l.collapse():(e=l.getRawValue().length)>=c.minChars?(l.input.trigger("focus"),l.expand()):m._updateHelper(c.minCharsRenderer.call(this,c.minChars-e)))},_onWindowResized:function(){m._renderSelection()}};null!==e&&m._render(e)}h.fn.magicSuggest=function(a){var e=h(this);return 1===e.length&&e.data("magicSuggest")?e.data("magicSuggest"):(e.each(function(e){var n,t,i=h(this);i.data("magicSuggest")||("select"===this.nodeName.toLowerCase()&&(a.data=[],a.value=[],h.each(this.children,function(e,t){t.nodeName&&"option"===t.nodeName.toLowerCase()&&(a.data.push({id:t.value,name:t.text}),h(t).attr("selected")&&a.value.push(t.value))})),n={},h.each(this.attributes,function(e,t){n[t.name]="value"===t.name&&""!==t.value?JSON.parse(t.value):t.value}),t=new s(this,h.extend([],h.fn.magicSuggest.defaults,a,n)),i.data("magicSuggest",t),t.container.data("magicSuggest",t))}),1===e.length?e.data("magicSuggest"):e)},h.fn.magicSuggest.defaults={}}(jQuery);