!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../../mode/sql/sql")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],t):t(CodeMirror)}(function(u){"use strict";var d,g,f,h,v={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},x=u.Pos,m=u.cmpPos;function c(t){return"[object Array]"==Object.prototype.toString.call(t)}function p(t){return"string"==typeof t?t:t.text}function b(t,e){return c(e)&&(e={columns:e}),e.text||(e.text=t),e}function y(t){return d[t.toUpperCase()]}function C(t){var e,r={};for(e in t)t.hasOwnProperty(e)&&(r[e]=t[e]);return r}function a(t,e){var r=t.length,r=p(e).substr(0,r);return t.toUpperCase()===r.toUpperCase()}function A(t,e,r,n){if(c(r))for(var o=0;o<r.length;o++)a(e,r[o])&&t.push(n(r[o]));else for(var i in r){var s;!r.hasOwnProperty(i)||a(e,s=(s=r[i])&&!0!==s?s.displayText?{text:s.text,displayText:s.displayText}:s.text:i)&&t.push(n(s))}}function q(t){for(var e=p(t).split("."),r=0;r<e.length;r++)e[r]=h+e[r].replace(new RegExp(h,"g"),h+h)+h;var n=e.join(".");return"string"==typeof t?n:((t=C(t)).text=n,t)}function U(t,e,r,n){for(var o=!1,i=[],s=e.start,a=!0;a;)a="."==e.string.charAt(0),o=o||e.string.charAt(0)==h,s=e.start,i.unshift(function(t){"."==t.charAt(0)&&(t=t.substr(1));for(var e=t.split(h+h),r=0;r<e.length;r++)e[r]=e[r].replace(new RegExp(h,"g"),"");return e.join(h)}(e.string)),"."==(e=n.getTokenAt(x(t.line,e.start))).string&&(a=!0,e=n.getTokenAt(x(t.line,e.start)));var l=i.join(".");A(r,l,d,function(t){return o?q(t):t}),A(r,l,g,function(t){return o?q(t):t}),l=i.pop();var u=i.join("."),f=!1,c=u;y(u)||(u=j(p=u,n))!==p&&(f=!0);var p=y(u);return p&&p.columns&&(p=p.columns),p&&A(r,l,p,function(t){var e=1==f?c:u;return"string"==typeof t?t=e+"."+t:(t=C(t)).text=e+"."+t.text,o?q(t):t}),s}function j(t,e){for(var r=e.doc,n=r.getValue(),o=t.toUpperCase(),i="",s="",a=[],l={start:x(0,0),end:x(e.lastLine(),e.getLineHandle(e.lastLine()).length)},u=n.indexOf(v.QUERY_DIV);-1!=u;)a.push(r.posFromIndex(u)),u=n.indexOf(v.QUERY_DIV,u+1);a.unshift(x(0,0)),a.push(x(e.lastLine(),e.getLineHandle(e.lastLine()).text.length));for(var f=null,c=e.getCursor(),p=0;p<a.length;p++){if((null==f||0<m(c,f))&&m(c,a[p])<=0){l={start:f,end:a[p]};break}f=a[p]}if(l.start)for(var d=r.getRange(l.start,l.end,!1),p=0;p<d.length;p++)if(!function(t,e){for(var r=t.split(/\s+/),n=0;n<r.length;n++)r[n]&&e(r[n].replace(/[`,;]/g,""))}(d[p],function(t){var e=t.toUpperCase();e===o&&y(i)&&(s=i),e!==v.ALIAS_KEYWORD&&(i=t)}),s)break;return s}u.registerHelper("hint","sql",function(t,e){d=function(t){var e={};if(c(t))for(var r=t.length-1;0<=r;r--){var n=t[r];e[p(n).toUpperCase()]=b(p(n),n)}else if(t)for(var o in t)e[o.toUpperCase()]=b(o,t[o]);return e}(e&&e.tables);var r=e&&e.defaultTable,n=e&&e.disableKeywords;g=r&&y(r),"sql"===(l=(l=t).doc.modeOption)&&(l="text/x-sql"),f=u.resolveMode(l).keywords,"sql"===(e=(e=t).doc.modeOption)&&(e="text/x-sql"),h=u.resolveMode(e).identifierQuote||"`",r&&!g&&(g=j(r,t)),(g=g||[]).columns&&(g=g.columns);var o,i,s,a,l=t.getCursor(),e=[],r=t.getTokenAt(l);return r.end>l.ch&&(r.end=l.ch,r.string=r.string.slice(0,l.ch-r.start)),r.string.match(/^[.`"'\w@][\w$#]*$/g)?(s=r.string,o=r.start,i=r.end):(o=i=l.ch,s=""),"."==s.charAt(0)||s.charAt(0)==h?o=U(l,r,e,t):(a=function(t,e){return"object"==typeof t?t.className=e:t={text:t,className:e},t},A(e,s,g,function(t){return a(t,"CodeMirror-hint-table CodeMirror-hint-default-table")}),A(e,s,d,function(t){return a(t,"CodeMirror-hint-table")}),n||A(e,s,f,function(t){return a(t.toUpperCase(),"CodeMirror-hint-keyword")})),{list:e,from:x(l.line,o),to:x(l.line,i)}})});