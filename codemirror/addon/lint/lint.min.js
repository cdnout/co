!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(h){"use strict";var g="CodeMirror-lint-markers";function u(t){t.parentNode&&t.parentNode.removeChild(t)}function v(t,e,n,o){var r,i=(t=t,e=e,n=n,(r=document.createElement("div")).className="CodeMirror-lint-tooltip cm-s-"+t.options.theme,r.appendChild(n.cloneNode(!0)),(t.state.lint.options.selfContain?t.getWrapperElement():document.body).appendChild(r),h.on(document,"mousemove",a),a(e),null!=r.style.opacity&&(r.style.opacity=1),r);function a(t){if(!r.parentNode)return h.off(document,"mousemove",a);r.style.top=Math.max(0,t.clientY-r.offsetHeight-5)+"px",r.style.left=t.clientX+5+"px"}function s(){var t;h.off(o,"mouseout",s),i&&((t=i).parentNode&&(null==t.style.opacity&&u(t),t.style.opacity=0,setTimeout(function(){u(t)},600)),i=null)}var l=setInterval(function(){if(i)for(var t=o;;t=t.parentNode){if(t&&11==t.nodeType&&(t=t.host),t==document.body)return;if(!t){s();break}}if(!i)return clearInterval(l)},400);h.on(o,"mouseout",s)}function a(e,t,n){this.marked=[],this.options=t,this.timeout=null,this.hasGutter=n,this.onMouseOver=function(t){!function(t,e){var n=e.target||e.srcElement;if(!/\bCodeMirror-lint-mark-/.test(n.className))return;for(var o=n.getBoundingClientRect(),n=(o.left+o.right)/2,o=(o.top+o.bottom)/2,r=t.findMarksAt(t.coordsChar({left:n,top:o},"client")),i=[],a=0;a<r.length;++a){var s=r[a].__annotation;s&&i.push(s)}i.length&&function(t,e,n){for(var o=n.target||n.srcElement,r=document.createDocumentFragment(),i=0;i<e.length;i++){var a=e[i];r.appendChild(y(a))}v(t,n,r,o)}(t,i,e)}(e,t)},this.waitingFor=0}function C(t){var e=t.state.lint;e.hasGutter&&t.clearGutter(g);for(var n=0;n<e.marked.length;++n)e.marked[n].clear();e.marked.length=0}function y(t){var e=(e=t.severity)||"error",n=document.createElement("div");return n.className="CodeMirror-lint-message CodeMirror-lint-message-"+e,void 0!==t.messageHTML?n.innerHTML=t.messageHTML:n.appendChild(document.createTextNode(t.message)),n}function s(e){var t,n,o,r,i,a=e.state.lint.options,s=a.options||a,l=a.getAnnotations||e.getHelper(h.Pos(0,0),"lint");function u(){i=-1,n.off("change",u)}l&&(a.async||l.async?(o=l,a=s,r=(n=e).state.lint,i=++r.waitingFor,n.on("change",u),o(n.getValue(),function(t,e){n.off("change",u),r.waitingFor==i&&(e&&t instanceof h&&(t=e),n.operation(function(){c(n,t)}))},a,n)):(t=l(e.getValue(),s,e))&&(t.then?t.then(function(t){e.operation(function(){c(e,t)})}):e.operation(function(){c(e,t)})))}function c(t,e){C(t);for(var n,o,r=t.state.lint,i=r.options,a=function(t){for(var e=[],n=0;n<t.length;++n){var o=t[n],r=o.from.line;(e[r]||(e[r]=[])).push(o)}return e}(e),s=0;s<a.length;++s)if(u=a[s]){for(var l=[],u=u.filter(function(t){return!(-1<l.indexOf(t.message))&&l.push(t.message)}),c=null,f=r.hasGutter&&document.createDocumentFragment(),m=0;m<u.length;++m){var d=u[m],p=d.severity;o=p=p||"error",c="error"==(n=c)?n:o,i.formatAnnotation&&(d=i.formatAnnotation(d)),r.hasGutter&&f.appendChild(y(d)),d.to&&r.marked.push(t.markText(d.from,d.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+p,__annotation:d}))}r.hasGutter&&t.setGutterMarker(s,g,function(e,n,t,o,r){var i=document.createElement("div"),a=i;return i.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+t,o&&((a=i.appendChild(document.createElement("div"))).className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),0!=r&&h.on(a,"mouseover",function(t){v(e,t,n,a)}),i}(t,f,c,1<a[s].length,r.options.tooltips))}i.onUpdateLinting&&i.onUpdateLinting(e,a,t)}function l(t){var e=t.state.lint;e&&(clearTimeout(e.timeout),e.timeout=setTimeout(function(){s(t)},e.options.delay||500))}h.defineOption("lint",!1,function(t,e,n){if(n&&n!=h.Init&&(C(t),!1!==t.state.lint.options.lintOnChange&&t.off("change",l),h.off(t.getWrapperElement(),"mouseover",t.state.lint.onMouseOver),clearTimeout(t.state.lint.timeout),delete t.state.lint),e){for(var o=t.getOption("gutters"),r=!1,i=0;i<o.length;++i)o[i]==g&&(r=!0);e=t.state.lint=new a(t,(e=e)instanceof Function?{getAnnotations:e}:(e&&!0!==e||(e={}),e),r);!1!==e.options.lintOnChange&&t.on("change",l),0!=e.options.tooltips&&"gutter"!=e.options.tooltips&&h.on(t.getWrapperElement(),"mouseover",e.onMouseOver),s(t)}}),h.defineExtension("performLint",function(){this.state.lint&&s(this)})});