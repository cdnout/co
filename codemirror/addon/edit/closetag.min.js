!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],e):e(CodeMirror)}(function(C){C.defineOption("autoCloseTags",!1,function(e,t,n){n!=C.Init&&n&&e.removeKeyMap("autoCloseTags"),t&&(n={name:"autoCloseTags"},"object"==typeof t&&!1===t.whenClosing||(n["'/'"]=function(e){return(e=e).getOption("disableInput")?C.Pass:o(e,!0)}),"object"==typeof t&&!1===t.whenOpening||(n["'>'"]=function(e){if(e.getOption("disableInput"))return C.Pass;for(var t=e.listSelections(),n=[],o=e.getOption("autoCloseTags"),r=0;r<t.length;r++){if(!t[r].empty())return C.Pass;var i=t[r].head,a=e.getTokenAt(i),l=C.innerMode(e.getMode(),a.state),s=l.state,d=l.mode.xmlCurrentTag&&l.mode.xmlCurrentTag(s),c=d&&d.name;if(!c)return C.Pass;var f="html"==l.mode.configuration,g="object"==typeof o&&o.dontCloseTags||f&&b,u="object"==typeof o&&o.indentTags||f&&y;a.end>i.ch&&(c=c.slice(0,c.length-a.end+i.ch));f=c.toLowerCase();if(!c||"string"==a.type&&(a.end!=i.ch||!/[\"\']/.test(a.string.charAt(a.string.length-1))||1==a.string.length)||"tag"==a.type&&d.close||a.string.indexOf("/")==i.ch-a.start-1||g&&-1<x(g,f)||v(e,l.mode.xmlCurrentContext&&l.mode.xmlCurrentContext(s)||[],c,i,!0))return C.Pass;s="object"==typeof o&&o.emptyTags;s&&-1<x(s,c)?n[r]={text:"/>",newPos:C.Pos(i.line,i.ch+2)}:(f=u&&-1<x(u,f),n[r]={indent:f,text:">"+(f?"\n\n":"")+"</"+c+">",newPos:f?C.Pos(i.line+1,0):C.Pos(i.line,i.ch+1)})}for(var m="object"==typeof o&&o.dontIndentOnAutoClose,r=t.length-1;0<=r;r--){var h=n[r];e.replaceRange(h.text,t[r].head,t[r].anchor,"+insert");var p=e.listSelections().slice(0);p[r]={head:h.newPos,anchor:h.newPos},e.setSelections(p),!m&&h.indent&&(e.indentLine(h.newPos.line,null,!0),e.indentLine(h.newPos.line+1,null,!0))}}),e.addKeyMap(n))});var b=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],y=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function o(e,t){for(var n=e.listSelections(),o=[],r=t?"/":"</",i=e.getOption("autoCloseTags"),i="object"==typeof i&&i.dontIndentOnSlash,a=0;a<n.length;a++){if(!n[a].empty())return C.Pass;var l=n[a].head,s=e.getTokenAt(l),d=C.innerMode(e.getMode(),s.state),c=d.state;if(t&&("string"==s.type||"<"!=s.string.charAt(0)||s.start!=l.ch-1))return C.Pass;var f,g="xml"!=d.mode.name&&"htmlmixed"==e.getMode().name;if(g&&"javascript"==d.mode.name)f=r+"script";else if(g&&"css"==d.mode.name)f=r+"style";else{d=d.mode.xmlCurrentContext&&d.mode.xmlCurrentContext(c),c=d.length?d[d.length-1]:"";if(!d||d.length&&v(e,d,c,l))return C.Pass;f=r+c}">"!=e.getLine(l.line).charAt(s.end)&&(f+=">"),o[a]=f}if(e.replaceSelections(o),n=e.listSelections(),!i)for(a=0;a<n.length;a++)(a==n.length-1||n[a].head.line<n[a+1].head.line)&&e.indentLine(n[a].head.line)}function x(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,o=e.length;n<o;++n)if(e[n]==t)return n;return-1}function v(e,t,n,o,r){if(C.scanForClosingTag){var i=Math.min(e.lastLine()+1,o.line+500),a=C.scanForClosingTag(e,o,null,i);if(a&&a.tag==n){for(var l=r?1:0,s=t.length-1;0<=s&&t[s]==n;s--)++l;o=a.to;for(s=1;s<l;s++){var d=C.scanForClosingTag(e,o,null,i);if(!d||d.tag!=n)return;o=d.to}return 1}}}C.commands.closeTag=function(e){return o(e)}});