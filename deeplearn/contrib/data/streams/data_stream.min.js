"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(a,i,o,s){return new(o=o||Promise)(function(t,e){function r(t){try{u(s.next(t))}catch(t){e(t)}}function n(t){try{u(s.throw(t))}catch(t){e(t)}}function u(e){e.done?t(e.value):new o(function(t){t(e.value)}).then(r,n)}u((s=s.apply(a,i||[])).next())})},__generator=this&&this.__generator||function(r,n){var u,a,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(u)throw new TypeError("Generator is already executing.");for(;o;)try{if(u=1,a&&(i=a[2&e[0]?"return":e[0]?"throw":"next"])&&!(i=i.call(a,e[1])).done)return i;switch(a=0,i&&(e=[0,i.value]),e[0]){case 0:case 1:i=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,a=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(i=0<(i=o.trys).length&&i[i.length-1])&&(6===e[0]||2===e[0])){o=0;continue}if(3===e[0]&&(!i||e[1]>i[0]&&e[1]<i[3])){o.label=e[1];break}if(6===e[0]&&o.label<i[1]){o.label=i[1],i=e;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(e);break}i[2]&&o.ops.pop(),o.trys.pop();continue}e=n.call(r,o)}catch(t){e=[6,t],a=0}finally{u=i=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),globals_1=require("../../../globals"),util_1=require("../../../util"),growing_ring_buffer_1=require("../util/growing_ring_buffer"),ring_buffer_1=require("../util/ring_buffer");function streamFromItems(t){return new ArrayStream(t)}function streamFromIncrementing(t){var e=t;return streamFromFunction(function(){return{value:e++,done:!1}})}function streamFromFunction(t){return new FunctionCallStream(t)}function streamFromConcatenated(t){return ChainedStream.create(t)}function streamFromConcatenatedFunction(t,e){return streamFromConcatenated(streamFromFunction(t).take(e))}exports.streamFromItems=streamFromItems,exports.streamFromIncrementing=streamFromIncrementing,exports.streamFromFunction=streamFromFunction,exports.streamFromConcatenated=streamFromConcatenated,exports.streamFromConcatenatedFunction=streamFromConcatenatedFunction;var DataStream=function(){function t(){}return t.prototype.collectRemaining=function(){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return e=[],[4,this.next()];case 1:r=t.sent(),t.label=2;case 2:return r.done?[3,4]:(e.push(r.value),[4,this.next()]);case 3:return r=t.sent(),[3,2];case 4:return[2,e]}})})},t.prototype.resolveFully=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.next()];case 1:e=t.sent(),t.label=2;case 2:return e.done?[3,4]:[4,this.next()];case 3:return e=t.sent(),[3,2];case 4:return[2]}})})},t.prototype.filter=function(t){return new FilterStream(this,t)},t.prototype.map=function(t){return new MapStream(this,t)},t.prototype.forEach=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.map(e).resolveFully()]})})},t.prototype.batch=function(t,e){return void 0===e&&(e=!0),new BatchStream(this,t,e)},t.prototype.concatenate=function(t){return ChainedStream.create(streamFromItems([this,t]))},t.prototype.take=function(t){return t<0||null==t?this:new TakeStream(this,t)},t.prototype.skip=function(t){return t<0||null==t?this:new SkipStream(this,t)},t.prototype.prefetch=function(t){return new PrefetchStream(this,t)},t.prototype.shuffle=function(t,e){return new ShuffleStream(this,t,e)},t}(),ArrayStream=function(r){function t(t){var e=r.call(this)||this;return e.items=t,e.trav=0,e}return __extends(t,r),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){return this.trav>=this.items.length?[2,{value:null,done:!0}]:(e=this.items[this.trav],this.trav++,[2,{value:e,done:!1}])})})},t}(exports.DataStream=DataStream),FunctionCallStream=function(r){function t(t){var e=r.call(this)||this;return e.nextFn=t,e}return __extends(t,r),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.nextFn()]})})},t}(DataStream),SkipStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.maxCount=e,r.count=0,r}return __extends(t,n),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.count++<this.maxCount?[4,this.upstream.next()]:[3,2];case 1:return(e=t.sent()).done?[2,e]:(globals_1.dispose(e.value),[3,0]);case 2:return[2,this.upstream.next()]}})})},t}(DataStream),TakeStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.maxCount=e,r.count=0,r}return __extends(t,n),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.count++>=this.maxCount?[2,{value:null,done:!0}]:[2,this.upstream.next()]})})},t}(DataStream),QueueStream=function(e){function t(){var t=e.call(this)||this;return t.outputQueue=new growing_ring_buffer_1.GrowingRingBuffer,t}return __extends(t,e),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return 0!==this.outputQueue.length()?[3,2]:[4,this.pump()];case 1:return t.sent()?[3,0]:[2,{value:null,done:!0}];case 2:return[2,{value:this.outputQueue.shift(),done:!1}]}})})},t}(DataStream),BatchStream=function(u){function t(t,e,r){void 0===r&&(r=!0);var n=u.call(this)||this;return n.upstream=t,n.batchSize=e,n.enableSmallLastBatch=r,n.currentBatch=[],n}return __extends(t,u),t.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.upstream.next()];case 1:return(e=t.sent()).done?this.enableSmallLastBatch&&0<this.currentBatch.length?(this.outputQueue.push(this.currentBatch),this.currentBatch=[],[2,!0]):[2,!1]:(this.currentBatch.push(e.value),this.currentBatch.length===this.batchSize&&(this.outputQueue.push(this.currentBatch),this.currentBatch=[]),[2,!0])}})})},t}(exports.QueueStream=QueueStream),FilterStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.predicate=e,r}return __extends(t,n),t.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.upstream.next()];case 1:return(e=t.sent()).done?[2,!1]:(this.predicate(e.value)?this.outputQueue.push(e.value):globals_1.dispose(e.value),[2,!0])}})})},t}(QueueStream),MapStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.transform=e,r}return __extends(t,n),t.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var e,r,n,u,a,i,o;return __generator(this,function(t){switch(t.label){case 0:return[4,this.upstream.next()];case 1:if((e=t.sent()).done)return[2,!1];for(r=util_1.extractTensorsFromAny(e.value),n=this.transform(e.value),u=util_1.extractTensorsFromAny(n),a=0,i=r;a<i.length;a++)o=i[a],util_1.isTensorInList(o,u)||o.dispose();return this.outputQueue.push(n),[2,!0]}})})},t}(QueueStream),ChainedStream=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.stream=null,t.lastRead=null,t}return __extends(r,e),r.create=function(t){var e=new r;return e.moreStreams=t,e},r.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.lastRead=this.readFromChain(this.lastRead),[2,this.lastRead]})})},r.prototype.readFromChain=function(n){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return[4,n];case 1:return t.sent(),null!=this.stream?[3,3]:[4,this.moreStreams.next()];case 2:if((e=t.sent()).done)return[2,{value:null,done:!0}];this.stream=e.value,t.label=3;case 3:return[4,this.stream.next()];case 4:return(r=t.sent()).done?(this.stream=null,[2,this.readFromChain(n)]):[2,r]}})})},r}(DataStream);exports.ChainedStream=ChainedStream;var PrefetchStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.bufferSize=e,r.total=0,r.buffer=new ring_buffer_1.RingBuffer(e),r}return __extends(t,n),t.prototype.refill=function(){for(;!this.buffer.isFull();){var t=this.upstream.next();this.buffer.push(t)}},t.prototype.next=function(){return this.refill(),this.buffer.shift()},t}(DataStream),ShuffleStream=function(u){function t(t,e,r){var n=u.call(this,t,e)||this;return n.upstream=t,n.windowSize=e,n.upstreamExhausted=!1,n.random=seedrandom(r),n}return __extends(t,u),t.prototype.randomInt=function(t){return Math.floor(this.random()*t)},t.prototype.chooseIndex=function(){return this.randomInt(this.buffer.length())},t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:this.upstreamExhausted||this.refill(),t.label=1;case 1:return this.buffer.isEmpty()?[3,3]:(e=this.chooseIndex(),[4,this.buffer.shuffleExcise(e)]);case 2:return(r=t.sent()).done?(this.upstreamExhausted=!0,[3,1]):(this.refill(),[2,r]);case 3:return[2,{value:null,done:!0}]}})})},t}(exports.PrefetchStream=PrefetchStream);exports.ShuffleStream=ShuffleStream;