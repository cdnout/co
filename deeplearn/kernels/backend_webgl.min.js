"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(o,p,u,i){return new(u=u||Promise)(function(e,t){function r(e){try{a(i.next(e))}catch(e){t(e)}}function n(e){try{a(i.throw(e))}catch(e){t(e)}}function a(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(r,n)}a((i=i.apply(o,p||[])).next())})},__generator=this&&this.__generator||function(r,n){var a,o,p,u={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;u;)try{if(a=1,o&&(p=o[2&t[0]?"return":t[0]?"throw":"next"])&&!(p=p.call(o,t[1])).done)return p;switch(o=0,p&&(t=[0,p.value]),t[0]){case 0:case 1:p=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(p=0<(p=u.trys).length&&p[p.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!p||t[1]>p[0]&&t[1]<p[3])){u.label=t[1];break}if(6===t[0]&&u.label<p[1]){u.label=p[1],p=t;break}if(p&&u.label<p[2]){u.label=p[2],u.ops.push(t);break}p[2]&&u.ops.pop(),u.trys.pop();continue}t=n.call(r,u)}catch(e){t=[6,e],o=0}finally{a=p=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),math_1=require("../math"),axis_util=require("../ops/axis_util"),reduce_util=require("../ops/reduce_util"),tensor_1=require("../tensor"),types=require("../types"),util=require("../util"),argminmax_gpu_1=require("./webgl/argminmax_gpu"),avg_pool_backprop_gpu_1=require("./webgl/avg_pool_backprop_gpu"),batchnorm_gpu_1=require("./webgl/batchnorm_gpu"),binaryop_gpu=require("./webgl/binaryop_gpu"),binaryop_gpu_1=require("./webgl/binaryop_gpu"),clip_gpu_1=require("./webgl/clip_gpu"),concat_gpu_1=require("./webgl/concat_gpu"),conv_backprop_gpu_1=require("./webgl/conv_backprop_gpu"),conv_gpu_1=require("./webgl/conv_gpu"),conv_gpu_depthwise_1=require("./webgl/conv_gpu_depthwise"),from_pixels_gpu_1=require("./webgl/from_pixels_gpu"),gather_gpu_1=require("./webgl/gather_gpu"),gpgpu_context_1=require("./webgl/gpgpu_context"),gpgpu_math=require("./webgl/gpgpu_math"),logical_gpu_1=require("./webgl/logical_gpu"),lrn_gpu_1=require("./webgl/lrn_gpu"),max_pool_backprop_gpu_1=require("./webgl/max_pool_backprop_gpu"),mulmat_gpu_1=require("./webgl/mulmat_gpu"),multinomial_gpu_1=require("./webgl/multinomial_gpu"),onehot_gpu_1=require("./webgl/onehot_gpu"),pad_gpu_1=require("./webgl/pad_gpu"),pool_gpu_1=require("./webgl/pool_gpu"),reduce_gpu_1=require("./webgl/reduce_gpu"),resize_bilinear_gpu_1=require("./webgl/resize_bilinear_gpu"),reverse_gpu_1=require("./webgl/reverse_gpu"),slice_gpu_1=require("./webgl/slice_gpu"),tex_util_1=require("./webgl/tex_util"),texture_manager_1=require("./webgl/texture_manager"),tile_gpu_1=require("./webgl/tile_gpu"),transpose_gpu_1=require("./webgl/transpose_gpu"),unary_op=require("./webgl/unaryop_gpu"),unaryop_gpu_1=require("./webgl/unaryop_gpu"),webgl_util=require("./webgl/webgl_util"),MathBackendWebGL=function(){function e(e,t){if(void 0===t&&(t=!0),this.gpgpu=e,this.delayedStorage=t,this.texData=new WeakMap,this.uploadWaitMs=0,this.downloadWaitMs=0,this.binaryCache={},this.disposed=!1,environment_1.ENV.get("WEBGL_VERSION")<1)throw new Error("WebGL is not supported on this device");null==e?(this.gpgpu=new gpgpu_context_1.GPGPUContext,this.gpgpuCreatedLocally=!0):this.gpgpuCreatedLocally=!1,"undefined"!=typeof document&&(this.canvas=document.createElement("canvas")),this.textureManager=new texture_manager_1.TextureManager(this.gpgpu)}return e.prototype.register=function(e,t,r){if(this.texData.has(e))throw new Error("Data buffer is already registered");this.texData.set(e,{shape:t,dtype:r,values:null,texture:null,texShape:null,texType:tex_util_1.TextureType.FLOAT})},e.prototype.fromPixels=function(e,t){if(null==e)throw new Error("MathBackendWebGL.writePixels(): pixels can not be null");var r=[e.height,e.width],n=[e.height,e.width,t];if(e instanceof HTMLVideoElement){if(null==this.canvas)throw new Error("Can't read pixels from HTMLImageElement outside the browser.");this.canvas.width=e.width,this.canvas.height=e.height,this.canvas.getContext("2d").drawImage(e,0,0,e.width,e.height),e=this.canvas}var a=tensor_1.Tensor.make(r,{},"int32");this.texData.get(a.dataId).texType=tex_util_1.TextureType.UNSIGNED_BYTE,this.gpgpu.uploadPixelDataToTexture(this.getTexture(a.dataId),e);var o=new from_pixels_gpu_1.FromPixelsProgram(n),p=this.compileAndRun(o,[a]);return a.dispose(),p},e.prototype.write=function(e,t){if(null==t)throw new Error("MathBackendWebGL.write(): values can not be null");this.throwIfNoData(e);var r=this.texData.get(e),n=r.texture,a=r.texShape,o=r.texType;null!=n&&(this.textureManager.releaseTexture(n,a,o),r.texture=null,r.texShape=null),r.values=t,this.delayedStorage||this.uploadToGPU(e)},e.prototype.readSync=function(e){this.throwIfNoData(e);var t=this.texData.get(e),r=t.texture,n=t.values,a=t.texShape;if(null!=n)return this.cacheOnCPU(e),n;var o,p=null!=this.activeTimers;p&&(o=performance.now());var u=this.gpgpu.downloadMatrixFromTexture(r,a[0],a[1]);return p&&(this.downloadWaitMs+=performance.now()-o),this.cacheOnCPU(e,u),t.values},e.prototype.read=function(p){return __awaiter(this,void 0,void 0,function(){var t,r,n,a,o;return __generator(this,function(e){switch(e.label){case 0:return this.throwIfNoData(p),t=this.texData.get(p),r=t.texture,n=t.values,a=t.texShape,null!=n?(this.cacheOnCPU(p),[2,n]):environment_1.ENV.get("WEBGL_GET_BUFFER_SUB_DATA_ASYNC_EXTENSION_ENABLED")?[4,this.gpgpu.downloadMatrixFromTextureAsync(r,a[0],a[1])]:[3,2];case 1:return o=e.sent(),this.cacheOnCPU(p,o),[2,t.values];case 2:return 0===environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?[2,this.readSync(p)]:[4,this.gpgpu.runQuery(function(){})];case 3:return e.sent(),[2,this.readSync(p)]}})})},e.prototype.time=function(u){return __awaiter(this,void 0,void 0,function(){var t,r,n,a,o,p;return __generator(this,function(e){switch(e.label){case 0:return t=this.activeTimers,n=!(r=[]),null==this.programTimersStack?(this.programTimersStack=r,n=!0):this.activeTimers.push(r),this.activeTimers=r,u(),a=util.flatten(this.activeTimers),this.activeTimers=t,n&&(this.programTimersStack=null),[4,Promise.all(a).then(function(e){var t=0;return e.forEach(function(e){return t+=e}),t})];case 1:return o=e.sent(),p={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:o,wallMs:null},this.uploadWaitMs=0,this.downloadWaitMs=0,[2,p]}})})},e.prototype.memory=function(){return{unreliable:!1}},e.prototype.startTimer=function(){return 0<environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?this.gpgpu.beginQuery():{startMs:performance.now(),endMs:null}},e.prototype.endTimer=function(e){return 0<environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?this.gpgpu.endQuery():e.endMs=performance.now(),e},e.prototype.getQueryTime=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return 0<environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?[2,this.gpgpu.pollQueryTime(t)]:[2,t.endMs-t.startMs]})})},e.prototype.disposeData=function(e){var t,r,n,a;this.texData.has(e)&&(r=(t=this.texData.get(e)).texture,n=t.texShape,a=t.texType,null!=r&&this.textureManager.releaseTexture(r,n,a),this.texData.delete(e))},e.prototype.getTexture=function(e){return this.uploadToGPU(e),this.texData.get(e).texture},e.prototype.getTextureData=function(e){return this.uploadToGPU(e),this.texData.get(e)},e.prototype.getGPGPUContext=function(){return this.gpgpu},e.prototype.slice=function(e,t,r){var n=new slice_gpu_1.SliceProgram(r),a=n.getCustomSetupFunc(t);return this.compileAndRun(n,[e],null,a)},e.prototype.reverse=function(e,t){var r=new reverse_gpu_1.ReverseProgram(e.shape,t);return this.compileAndRun(r,[e])},e.prototype.concat=function(e,t){var r=new concat_gpu_1.ConcatProgram(e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.neg=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.NEG);return this.compileAndRun(t,[e])},e.prototype.matMul=function(e,t,r,n){var a=new mulmat_gpu_1.MatMulProgram(e.shape,t.shape,r,n);return this.compileAndRun(a,[e,t])},e.prototype.multiply=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MUL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,types.upcastType(e.dtype,t.dtype));return this.compileAndRun(r,[e,t],n)},e.prototype.batchNormalization4D=function(e,t,r,n,a,o){var p=[e,t,r],u=null;null!=o&&(u=o.shape,p.push(o));var i=null;null!=a&&(i=a.shape,p.push(a));var s=new batchnorm_gpu_1.BatchNormProgram(e.shape,t.shape,r.shape,u,i,n);return this.compileAndRun(s,p)},e.prototype.localResponseNormalization4D=function(e,t,r,n,a,o){var p=new lrn_gpu_1.LRNProgram(e.shape,t,r,n,a,o);return this.compileAndRun(p,[e])},e.prototype.tile=function(e,t){var r=new tile_gpu_1.TileProgram(e.shape,t);return this.compileAndRun(r,[e])},e.prototype.pad=function(e,t,r){var n=new pad_gpu_1.PadProgram(e.shape,t,r);return this.compileAndRun(n,[e])},e.prototype.transpose=function(e,t){var r=new transpose_gpu_1.TransposeProgram(e.shape,t);return this.compileAndRun(r,[e])},e.prototype.gather=function(e,t,r){var n=new gather_gpu_1.GatherProgram(e.shape,t.size,r);return this.compileAndRun(n,[e,t])},e.prototype.reduce=function(e,t,r){var n=e.shape[0],a=e.shape[1],o={windowSize:reduce_util.computeOptimalWindowSize(a),inSize:a,batchSize:n},p=new reduce_gpu_1.ReduceProgram(o,t),u=p.outputShape,i=u[0],s=u[1],h=this.makeOutputArray([i,s],r);return this.compileAndRun(p,[e],h),1===h.shape[1]?h:this.reduce(h,t,r)},e.prototype.argReduce=function(e,t,r){void 0===r&&(r=null);var n=e.shape[0],a=e.shape[1];null!=r&&(n=r.shape[0],a=r.shape[1]);var o={windowSize:reduce_util.computeOptimalWindowSize(a),inSize:a,batchSize:n},p=new argminmax_gpu_1.ArgMinMaxProgram(o,t,null==r),u=p.outputShape,i=u[0],s=u[1],h=this.makeOutputArray([i,s],"int32"),l=[e];return null!=r&&l.push(r),this.compileAndRun(p,l,h),1===h.shape[1]?h:this.argReduce(e,t,h)},e.prototype.sum=function(e,t){axis_util.assertAxesAreInnerMostDims("sum",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],o=util.sizeFromShape(a),p=e.as2D(-1,o),u=types.sumOutType(e.dtype);return this.reduce(p,"sum",u).reshape(n)},e.prototype.argMin=function(e,t){axis_util.assertAxesAreInnerMostDims("argMin",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],o=util.sizeFromShape(a),p=e.as2D(-1,o);return this.argReduce(p,"min").reshape(n)},e.prototype.argMax=function(e,t){axis_util.assertAxesAreInnerMostDims("argMax",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],o=util.sizeFromShape(a),p=e.as2D(-1,o);return this.argReduce(p,"max").reshape(n)},e.prototype.equal=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.EQUAL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.notEqual=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.NOT_EQUAL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.less=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.lessEqual=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS_EQUAL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.greater=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.greaterEqual=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER_EQUAL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.logicalNot=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.LOGICAL_NOT);return this.compileAndRun(t,[e])},e.prototype.logicalAnd=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_AND,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.logicalOr=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_OR,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.logicalXor=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_XOR,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.where=function(e,t,r,n){var a=new logical_gpu_1.WhereProgram(e.rank,t.shape,t.rank),o=this.makeOutputArray(a.outputShape,n);return this.compileAndRun(a,[e,t,r],o)},e.prototype.topKValues=function(e,t){throw new Error("topKValues GPU not yet implemented!")},e.prototype.topKIndices=function(e,t){throw new Error("topKIndices GPU not yet implemented!")},e.prototype.min=function(e,t){axis_util.assertAxesAreInnerMostDims("min",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],o=util.sizeFromShape(a),p=e.as2D(-1,o);return this.reduce(p,"min",p.dtype).reshape(n)},e.prototype.minimum=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MIN,e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.max=function(e,t){axis_util.assertAxesAreInnerMostDims("max",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],o=util.sizeFromShape(a),p=e.as2D(-1,o);return this.reduce(p,"max",p.dtype).reshape(n)},e.prototype.maximum=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MAX,e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.divide=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.DIV,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"float32");return this.compileAndRun(r,[e,t],n)},e.prototype.add=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ADD,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,types.upcastType(e.dtype,t.dtype));return this.compileAndRun(r,[e,t],n)},e.prototype.subtract=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.SUB,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,types.upcastType(e.dtype,t.dtype));return this.compileAndRun(r,[e,t],n)},e.prototype.pow=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.POW,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,types.upcastType(e.dtype,t.dtype));return this.compileAndRun(r,[e,t],n)},e.prototype.ceil=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.CEIL);return this.compileAndRun(t,[e])},e.prototype.floor=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.FLOOR);return this.compileAndRun(t,[e])},e.prototype.exp=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.EXP);return this.compileAndRun(t,[e])},e.prototype.log=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.LOG);return this.compileAndRun(t,[e])},e.prototype.sqrt=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SQRT);return this.compileAndRun(t,[e])},e.prototype.square=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SQUARE);return this.compileAndRun(t,[e])},e.prototype.relu=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.RELU);return this.compileAndRun(t,[e])},e.prototype.elu=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ELU);return this.compileAndRun(t,[e])},e.prototype.eluDer=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ELU_DER);return this.compileAndRun(t,[e])},e.prototype.selu=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SELU);return this.compileAndRun(t,[e])},e.prototype.leakyRelu=function(e,t){var r=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.LEAKY_RELU(t));return this.compileAndRun(r,[e])},e.prototype.prelu=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.PRELU,e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.preluDer=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.PRELU_DER,e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.int=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.TO_INT),r=this.makeOutputArray(t.outputShape,"int32");return this.compileAndRun(t,[e],r)},e.prototype.clip=function(e,t,r){var n=new clip_gpu_1.ClipProgram(e.shape,t,r);return this.compileAndRun(n,[e])},e.prototype.abs=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ABS);return this.compileAndRun(t,[e])},e.prototype.sigmoid=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SIGMOID);return this.compileAndRun(t,[e])},e.prototype.sin=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SIN);return this.compileAndRun(t,[e])},e.prototype.cos=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.COS);return this.compileAndRun(t,[e])},e.prototype.tan=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.TAN);return this.compileAndRun(t,[e])},e.prototype.asin=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ASIN);return this.compileAndRun(t,[e])},e.prototype.acos=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ACOS);return this.compileAndRun(t,[e])},e.prototype.atan=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ATAN);return this.compileAndRun(t,[e])},e.prototype.sinh=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SINH);return this.compileAndRun(t,[e])},e.prototype.cosh=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.COSH);return this.compileAndRun(t,[e])},e.prototype.tanh=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.TANH);return this.compileAndRun(t,[e])},e.prototype.step=function(e,t){var r=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.STEP(t));return this.compileAndRun(r,[e])},e.prototype.conv2d=function(e,t,r){var n=new conv_gpu_1.Conv2DProgram(r);return this.compileAndRun(n,[e,t])},e.prototype.conv2dDerInput=function(e,t,r){var n=new conv_backprop_gpu_1.Conv2DDerInputProgram(r);return this.compileAndRun(n,[e,t])},e.prototype.conv2dDerFilter=function(e,t,r){var n=new conv_backprop_gpu_1.Conv2DDerFilterProgram(r);return this.compileAndRun(n,[e,t])},e.prototype.depthwiseConv2D=function(e,t,r){var n=new conv_gpu_depthwise_1.DepthwiseConv2DProgram(r);return this.compileAndRun(n,[e,t])},e.prototype.maxPool=function(e,t){var r=new pool_gpu_1.Pool2DProgram(t,"max",!1),n=this.makeOutputArray(r.outputShape,e.dtype);return this.compileAndRun(r,[e],n)},e.prototype.minPool=function(e,t){var r=new pool_gpu_1.Pool2DProgram(t,"min",!1),n=this.makeOutputArray(r.outputShape,e.dtype);return this.compileAndRun(r,[e],n)},e.prototype.avgPool=function(e,t){var r=new pool_gpu_1.Pool2DProgram(t,"avg",!1),n=this.makeOutputArray(r.outputShape,"float32");return this.compileAndRun(r,[e],n)},e.prototype.maxPoolBackprop=function(e,t,r){var n=new pool_gpu_1.Pool2DProgram(r,"max",!0),a=this.compileAndRun(n,[t]),o=new max_pool_backprop_gpu_1.MaxPool2DBackpropProgram(r),p=this.makeOutputArray(o.outputShape,t.dtype),u=this.compileAndRun(o,[e,a],p);return a.dispose(),u},e.prototype.avgPoolBackprop=function(e,t,r){var n=new avg_pool_backprop_gpu_1.AvgPool2DBackpropProgram(r),a=this.makeOutputArray(n.outputShape,t.dtype);return this.compileAndRun(n,[e],a)},e.prototype.resizeBilinear=function(e,t,r,n){var a=new resize_bilinear_gpu_1.ResizeBilinearProgram(e.shape,t,r,n);return this.compileAndRun(a,[e])},e.prototype.multinomial=function(e,t,r){var n=e.shape[0],a=e.shape[1],o=new multinomial_gpu_1.MultinomialProgram(n,a,t),p=this.makeOutputArray(o.outputShape,"int32"),u=o.getCustomSetupFunc(r);return this.compileAndRun(o,[e],p,u)},e.prototype.oneHot=function(e,t,r,n){var a=new onehot_gpu_1.OneHotProgram(e.size,t,r,n);return this.compileAndRun(a,[e])},e.prototype.makeOutputArray=function(e,t){return tensor_1.Tensor.make(e,{},t)},e.prototype.compileAndRun=function(e,t,r,n){var a=this;null==r&&(r=this.makeOutputArray(e.outputShape,t[0].dtype));var o=t.map(function(e){return a.uploadToGPU(e.dataId),{tensor:e,texData:a.texData.get(e.dataId)}});this.uploadToGPU(r.dataId);var p,u={tensor:r,texData:this.texData.get(r.dataId)},i=gpgpu_math.makeShaderKey(e,o,u),s=this.getAndSaveBinary(i,function(){return gpgpu_math.compileProgram(a.gpgpu,e,o,u)}),h=null!=this.activeTimers;return h&&(p=this.startTimer()),gpgpu_math.runProgram(s,o,u,n),h&&(p=this.endTimer(p),this.activeTimers.push(this.getQueryTime(p))),r},e.prototype.getAndSaveBinary=function(e,t){return e in this.binaryCache||(this.binaryCache[e]=t()),this.binaryCache[e]},e.prototype.getTextureManager=function(){return this.textureManager},e.prototype.dispose=function(){if(!this.disposed){for(var e in this.binaryCache)this.gpgpu.deleteProgram(this.binaryCache[e].webGLProgram);this.textureManager.dispose(),this.canvas.remove(),this.gpgpuCreatedLocally&&this.gpgpu.dispose(),this.disposed=!0}},e.prototype.throwIfNoData=function(e){if(!this.texData.has(e))throw new Error("WebGL backend: No data found for this tensor. Did you change your backend in the middle of the program? New backends can't use Tensors created with previous backends")},e.prototype.uploadToGPU=function(e){this.throwIfNoData(e);var t,r,n,a,o=this.texData.get(e),p=o.shape,u=o.values,i=o.texture,s=o.dtype,h=o.texType;null==i&&((t=null!=this.activeTimers)&&(r=performance.now()),n=webgl_util.getTextureShapeFromLogicalShape(this.gpgpu.gl,p),o.texShape=n,a=this.textureManager.acquireTexture(n,h),o.texture=a,null!=u&&(this.gpgpu.uploadMatrixToTexture(a,n[0],n[1],typedArrayToFloat32(u,s)),o.values=null,t&&(this.uploadWaitMs+=performance.now()-r)))},e.prototype.cacheOnCPU=function(e,t){var r=this.delayedStorage,n=this.texData.get(e),a=n.texture,o=n.texShape,p=n.dtype,u=n.texType;r&&null!=a&&(this.textureManager.releaseTexture(a,o,u),n.texture=null,n.texShape=null),null!=t&&(n.values=float32ToTypedArray(t,p))},e}();exports.MathBackendWebGL=MathBackendWebGL,environment_1.ENV.registerBackend("webgl",function(){return new MathBackendWebGL});var NDArrayMathGPU=function(r){function e(e,t){void 0===t&&(t=!1);return console.warn("new NDArrayMathGPU() is deprecated. Please use dl.setBackend('webgl')."),r.call(this,new MathBackendWebGL(e),t)||this}return __extends(e,r),e}(math_1.NDArrayMath);function float32ToTypedArray(e,t){if("float32"===t)return e;if("int32"!==t&&"bool"!==t)throw new Error("Unknown dtype "+t);for(var r=new("int32"===t?Int32Array:Uint8Array)(e.length),n=0;n<r.length;++n){var a=e[n],a=isNaN(a)?util.getNaN(t):Math.round(a);r[n]=a}return r}function typedArrayToFloat32(e,t){if(e instanceof Float32Array)return e;for(var r=new Float32Array(e.length),n=0;n<r.length;n++){var a=e[n];r[n]=util.isValNaN(a,t)?NaN:a}return r}exports.NDArrayMathGPU=NDArrayMathGPU;