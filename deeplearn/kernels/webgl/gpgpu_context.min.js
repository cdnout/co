"use strict";var __awaiter=this&&this.__awaiter||function(n,u,l,a){return new(l=l||Promise)(function(t,e){function r(t){try{o(a.next(t))}catch(t){e(t)}}function i(t){try{o(a.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new l(function(t){t(e.value)}).then(r,i)}o((a=a.apply(n,u||[])).next())})},__generator=this&&this.__generator||function(r,i){var o,n,u,l={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;l;)try{if(o=1,n&&(u=n[2&e[0]?"return":e[0]?"throw":"next"])&&!(u=u.call(n,e[1])).done)return u;switch(n=0,u&&(e=[0,u.value]),e[0]){case 0:case 1:u=e;break;case 4:return l.label++,{value:e[1],done:!1};case 5:l.label++,n=e[1],e=[0];continue;case 7:e=l.ops.pop(),l.trys.pop();continue;default:if(!(u=0<(u=l.trys).length&&u[u.length-1])&&(6===e[0]||2===e[0])){l=0;continue}if(3===e[0]&&(!u||e[1]>u[0]&&e[1]<u[3])){l.label=e[1];break}if(6===e[0]&&l.label<u[1]){l.label=u[1],u=e;break}if(u&&l.label<u[2]){l.label=u[2],l.ops.push(e);break}u[2]&&l.ops.pop(),l.trys.pop();continue}e=i.call(r,l)}catch(t){e=[6,t],n=0}finally{o=u=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),gpgpu_util=require("./gpgpu_util"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util"),GPGPUContext=function(){function t(t){this.outputTexture=null,this.program=null,this.disposed=!1,this.autoDebugValidate=!1,this.firstProgram=!0,this.gl=null!=t?t:gpgpu_util.createWebGLContext(),1===environment_1.ENV.get("WEBGL_VERSION")?(this.textureFloatExtension=webgl_util.getExtensionOrThrow(this.gl,"OES_texture_float"),this.colorBufferFloatExtension=this.gl.getExtension("WEBGL_color_buffer_float")):this.colorBufferFloatExtension=webgl_util.getExtensionOrThrow(this.gl,"EXT_color_buffer_float"),this.loseContextExtension=webgl_util.getExtensionOrThrow(this.gl,"WEBGL_lose_context"),environment_1.ENV.get("WEBGL_GET_BUFFER_SUB_DATA_ASYNC_EXTENSION_ENABLED")&&(this.getBufferSubDataAsyncExtension=this.gl.getExtension("WEBGL_get_buffer_sub_data_async")),this.vertexBuffer=gpgpu_util.createVertexBuffer(this.gl),this.indexBuffer=gpgpu_util.createIndexBuffer(this.gl),this.framebuffer=webgl_util.createFramebuffer(this.gl)}return t.prototype.dispose=function(){var t,e=this;this.disposed||(null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing."),t=this.gl,webgl_util.callAndCheck(t,function(){return t.finish()}),webgl_util.callAndCheck(t,function(){return t.bindFramebuffer(t.FRAMEBUFFER,null)}),webgl_util.callAndCheck(t,function(){return t.deleteFramebuffer(e.framebuffer)}),webgl_util.callAndCheck(t,function(){return t.bindBuffer(t.ARRAY_BUFFER,null)}),webgl_util.callAndCheck(t,function(){return t.deleteBuffer(e.vertexBuffer)}),webgl_util.callAndCheck(t,function(){return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}),webgl_util.callAndCheck(t,function(){return t.deleteBuffer(e.indexBuffer)}),this.loseContextExtension.loseContext(),this.disposed=!0)},t.prototype.enableAutomaticDebugValidation=function(t){this.autoDebugValidate=t,webgl_util.enableDebugWebGLErrorChecking(t)},t.prototype.createMatrixTexture=function(t,e){return this.throwIfDisposed(),gpgpu_util.createMatrixTexture(this.gl,t,e)},t.prototype.uploadPixelDataToTexture=function(t,e){this.throwIfDisposed(),gpgpu_util.uploadPixelDataToTexture(this.gl,t,e)},t.prototype.createPackedMatrixTexture=function(t,e){return this.throwIfDisposed(),gpgpu_util.createPackedMatrixTexture(this.gl,t,e)},t.prototype.deleteMatrixTexture=function(t){var e=this;this.throwIfDisposed(),this.outputTexture===t&&(webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.framebuffer),this.outputTexture=null),webgl_util.callAndCheck(this.gl,function(){return e.gl.deleteTexture(t)})},t.prototype.uploadMatrixToTexture=function(t,e,r,i){this.throwIfDisposed();return gpgpu_util.uploadMatrixToTexture(this.gl,t,e,r,i,1)},t.prototype.uploadMatrixToPackedTexture=function(t,e,r,i){return this.throwIfDisposed(),gpgpu_util.uploadMatrixToPackedTexture(this.gl,t,e,r,i)},t.prototype.downloadMatrixFromTexture=function(t,e,r){var i=this;return this.downloadMatrixDriver(t,function(){return gpgpu_util.downloadMatrixFromOutputTexture(i.gl,e,r)})},t.prototype.downloadMatrixFromTextureAsync=function(r,i,o){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(t){if(null==this.getBufferSubDataAsyncExtension)throw new Error("Cannot download matrix from output texture asynchronously, WEBGL_get_buffer_sub_data_async is not enabled.");return[2,this.downloadMatrixDriverAsync(r,function(){return gpgpu_util.downloadMatrixFromOutputTextureAsync(e.gl,e.getBufferSubDataAsyncExtension,i,o)})]})})},t.prototype.downloadMatrixFromRGBAColorTexture=function(t,e,r,i){var o=this;return this.downloadMatrixDriver(t,function(){return gpgpu_util.downloadMatrixFromRGBAColorTexture(o.gl,e,r,i)})},t.prototype.downloadMatrixFromPackedTexture=function(t,e,r){var i=this;return this.downloadMatrixDriver(t,function(){return gpgpu_util.downloadMatrixFromPackedOutputTexture(i.gl,e,r)})},t.prototype.createProgram=function(t){this.throwIfDisposed();var e=this.gl,r=webgl_util.createFragmentShader(e,t),i=gpgpu_util.createVertexShader(e),o=webgl_util.createProgram(e);return webgl_util.callAndCheck(e,function(){return e.attachShader(o,i)}),webgl_util.callAndCheck(e,function(){return e.attachShader(o,r)}),webgl_util.linkProgram(e,o),this.autoDebugValidate&&webgl_util.validateProgram(e,o),this.firstProgram&&(this.firstProgram=!1,this.setProgram(o),gpgpu_util.bindVertexProgramAttributeStreams(e,this.program,this.vertexBuffer)),o},t.prototype.deleteProgram=function(t){var e=this;this.throwIfDisposed(),t===this.program&&(this.program=null),null!=t&&webgl_util.callAndCheck(this.gl,function(){return e.gl.deleteProgram(t)})},t.prototype.setProgram=function(t){var e=this;this.throwIfDisposed(),this.program=t,null!=this.program&&this.autoDebugValidate&&webgl_util.validateProgram(this.gl,this.program),webgl_util.callAndCheck(this.gl,function(){return e.gl.useProgram(t)})},t.prototype.getUniformLocation=function(t,e,r){return void 0===r&&(r=!0),this.throwIfDisposed(),r?webgl_util.getProgramUniformLocationOrThrow(this.gl,t,e):webgl_util.getProgramUniformLocation(this.gl,t,e)},t.prototype.getAttributeLocation=function(t,e){var r=this;return this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,function(){return r.gl.getAttribLocation(t,e)})},t.prototype.getUniformLocationNoThrow=function(t,e){return this.throwIfDisposed(),this.gl.getUniformLocation(t,e)},t.prototype.setInputMatrixTexture=function(t,e,r){this.throwIfDisposed(),this.throwIfNoProgram(),webgl_util.bindTextureToProgramUniformSampler(this.gl,this.program,t,e,r)},t.prototype.setOutputMatrixTexture=function(t,e,r){this.setOutputMatrixTextureDriver(t,r,e)},t.prototype.setOutputPackedMatrixTexture=function(t,e,r){this.throwIfDisposed();var i=tex_util.getPackedMatrixTextureShapeWidthHeight(e,r),o=i[0],n=i[1];this.setOutputMatrixTextureDriver(t,o,n)},t.prototype.setOutputMatrixWriteRegion=function(t,e,r,i){this.setOutputMatrixWriteRegionDriver(r,t,i,e)},t.prototype.setOutputPackedMatrixWriteRegion=function(t,e,r,i){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},t.prototype.debugValidate=function(){null!=this.program&&webgl_util.validateProgram(this.gl,this.program),webgl_util.validateFramebuffer(this.gl)},t.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var t=this.gl;this.autoDebugValidate&&this.debugValidate(),webgl_util.callAndCheck(t,function(){return t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0)})},t.prototype.blockUntilAllProgramsCompleted=function(){var t=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,function(){return t.gl.finish()})},t.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=webgl_util.getExtensionOrThrow(this.gl,2===environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},t.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},t.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},t.prototype.runQuery=function(t){var e=this.beginQuery();return t(),this.endQuery(),this.pollQueryTime(e)},t.prototype.beginQuery=function(){if(2===environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var t=this.gl,e=this.getQueryTimerExtensionWebGL2(),r=t.createQuery();return t.beginQuery(e.TIME_ELAPSED_EXT,r),r}var i=this.getQueryTimerExtensionWebGL1(),o=i.createQueryEXT();return i.beginQueryEXT(i.TIME_ELAPSED_EXT,o),o},t.prototype.endQuery=function(){var t,e,r;2!==environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?(t=this.getQueryTimerExtensionWebGL1()).endQueryEXT(t.TIME_ELAPSED_EXT):(e=this.gl,r=this.getQueryTimerExtensionWebGL2(),e.endQuery(r.TIME_ELAPSED_EXT))},t.prototype.isQueryAvailable=function(t,e){if(0===e)return!0;if(2===e){var r=this.gl,i=this.getQueryTimerExtensionWebGL2(),o=r.getQueryParameter(t,r.QUERY_RESULT_AVAILABLE),n=this.gl.getParameter(i.GPU_DISJOINT_EXT);return o&&!n}o=(i=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(t,i.QUERY_RESULT_AVAILABLE_EXT),n=this.gl.getParameter(i.GPU_DISJOINT_EXT);return o&&!n},t.prototype.pollQueryTime=function(i){var o=this;return new Promise(function(t,e){var r=environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION");util.repeatedTry(function(){return o.isQueryAvailable(i,r)}).then(function(){return t(o.getQueryTime(i,r))}).catch(function(){console.warn("Disjoint query timer never available."),t(-1)})})},t.prototype.getQueryTime=function(t,e){if(0===e)return null;if(2===e){var r=this.gl;return r.getQueryParameter(t,r.QUERY_RESULT)/1e6}var i=this.getQueryTimerExtensionWebGL1();return i.getQueryObjectEXT(t,i.QUERY_RESULT_EXT)/1e6},t.prototype.downloadMatrixDriverSetup=function(t){this.throwIfDisposed(),webgl_util.bindColorTextureToFramebuffer(this.gl,t,this.framebuffer),this.autoDebugValidate&&webgl_util.validateFramebuffer(this.gl)},t.prototype.downloadMatrixDriverTeardown=function(){null!=this.outputTexture?(webgl_util.bindColorTextureToFramebuffer(this.gl,this.outputTexture,this.framebuffer),this.autoDebugValidate&&webgl_util.validateFramebuffer(this.gl)):webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.framebuffer)},t.prototype.downloadMatrixDriver=function(t,e){this.downloadMatrixDriverSetup(t);var r=e();return this.downloadMatrixDriverTeardown(),r},t.prototype.downloadMatrixDriverAsync=function(r,i){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.downloadMatrixDriverSetup(r),[4,i()];case 1:return e=t.sent(),this.downloadMatrixDriverTeardown(),[2,e]}})})},t.prototype.setOutputMatrixTextureDriver=function(t,e,r){this.throwIfDisposed();var i=this.gl;webgl_util.bindColorTextureToFramebuffer(i,t,this.framebuffer),this.autoDebugValidate&&webgl_util.validateFramebuffer(i),this.outputTexture=t,webgl_util.callAndCheck(i,function(){return i.viewport(0,0,e,r)}),webgl_util.callAndCheck(i,function(){return i.scissor(0,0,e,r)})},t.prototype.setOutputMatrixWriteRegionDriver=function(t,e,r,i){var o=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,function(){return o.gl.scissor(t,e,r,i)})},t.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},t.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},t}();exports.GPGPUContext=GPGPUContext;