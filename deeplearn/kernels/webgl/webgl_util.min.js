"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MAX_TEXTURE_SIZE=null,util=require("../../util"),environment_1=require("../../environment");function createWebGLRenderingContext(e){var r=document.createElement("canvas");return r.width=1,r.height=1,createWebGLRenderingContextFromCanvas(r,e)}function createWebGLRenderingContextFromCanvas(e,r){var t,n=environment_1.ENV.get("WEBGL_VERSION");if(2===n?t=e.getContext("webgl2",r):1===n&&(t=e.getContext("webgl",r)||e.getContext("experimental-webgl",r)),0===n||null==t)throw new Error("This browser does not support WebGL.");return t}function callAndCheck(e,r){var t=r();return checkWebGLError(e),t}exports.createWebGLRenderingContext=createWebGLRenderingContext,exports.createWebGLRenderingContextFromCanvas=createWebGLRenderingContextFromCanvas,exports.callAndCheck=callAndCheck;var webGLDebugErrorCheckingEnabled=!1;function enableDebugWebGLErrorChecking(e){webGLDebugErrorCheckingEnabled=e}function checkWebGLError(e){if(webGLDebugErrorCheckingEnabled){var r=e.getError();if(r!==e.NO_ERROR)throw new Error("WebGL Error: "+getWebGLErrorMessage(e,r))}}function getWebGLErrorMessage(e,r){switch(r){case e.NO_ERROR:return"NO_ERROR";case e.INVALID_ENUM:return"INVALID_ENUM";case e.INVALID_VALUE:return"INVALID_VALUE";case e.INVALID_OPERATION:return"INVALID_OPERATION";case e.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case e.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case e.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+r}}function getExtensionOrThrow(e,r){return throwIfNull(e,function(){return e.getExtension(r)},'Extension "'+r+'" not supported on this browser.')}function createVertexShader(e,r){var t=throwIfNull(e,function(){return e.createShader(e.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(callAndCheck(e,function(){return e.shaderSource(t,r)}),callAndCheck(e,function(){return e.compileShader(t)}),!1===e.getShaderParameter(t,e.COMPILE_STATUS))throw console.log(e.getShaderInfoLog(t)),new Error("Failed to compile vertex shader.");return t}function createFragmentShader(e,r){var t=throwIfNull(e,function(){return e.createShader(e.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(callAndCheck(e,function(){return e.shaderSource(t,r)}),callAndCheck(e,function(){return e.compileShader(t)}),!1===e.getShaderParameter(t,e.COMPILE_STATUS))throw logShaderSourceAndInfoLog(r,e.getShaderInfoLog(t)),new Error("Failed to compile fragment shader.");return t}exports.enableDebugWebGLErrorChecking=enableDebugWebGLErrorChecking,exports.checkWebGLError=checkWebGLError,exports.getWebGLErrorMessage=getWebGLErrorMessage,exports.getExtensionOrThrow=getExtensionOrThrow,exports.createVertexShader=createVertexShader,exports.createFragmentShader=createFragmentShader;var lineNumberRegex=/ERROR: [0-9]+:([0-9]+):/g;function logShaderSourceAndInfoLog(e,r){var t=lineNumberRegex.exec(r);if(null==t)return console.log("Couldn't parse line number in error: "+r),void console.log(e);for(var n=+t[1],o=e.split("\n"),a=o.length.toString().length+2,u=o.map(function(e,r){return util.rightPad((r+1).toString(),a)+e}),i=0,c=0;c<u.length;c++)i=Math.max(u[c].length,i);var f=u.slice(0,n-1),l=u.slice(n-1,n),E=u.slice(n);console.log(f.join("\n")),console.log(r.split("\n")[0]),console.log("%c "+util.rightPad(l[0],i),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(E.join("\n"))}function createProgram(e){return throwIfNull(e,function(){return e.createProgram()},"Unable to create WebGLProgram.")}function linkProgram(e,r){if(callAndCheck(e,function(){return e.linkProgram(r)}),!1===e.getProgramParameter(r,e.LINK_STATUS))throw console.log(e.getProgramInfoLog(r)),new Error("Failed to link vertex and fragment shaders.")}function validateProgram(e,r){if(callAndCheck(e,function(){return e.validateProgram(r)}),!1===e.getProgramParameter(r,e.VALIDATE_STATUS))throw console.log(e.getProgramInfoLog(r)),new Error("Shader program validation failed.")}function createStaticVertexBuffer(e,r){var t=throwIfNull(e,function(){return e.createBuffer()},"Unable to create WebGLBuffer");return callAndCheck(e,function(){return e.bindBuffer(e.ARRAY_BUFFER,t)}),callAndCheck(e,function(){return e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW)}),t}function createStaticIndexBuffer(e,r){var t=throwIfNull(e,function(){return e.createBuffer()},"Unable to create WebGLBuffer");return callAndCheck(e,function(){return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t)}),callAndCheck(e,function(){return e.bufferData(e.ELEMENT_ARRAY_BUFFER,r,e.STATIC_DRAW)}),t}function queryMaxTextureSize(e){return null!=MAX_TEXTURE_SIZE?MAX_TEXTURE_SIZE:MAX_TEXTURE_SIZE=callAndCheck(e,function(){return e.getParameter(e.MAX_TEXTURE_SIZE)})}function getChannelsPerTexture(){return environment_1.ENV.get("WEBGL_FLOAT_TEXTURE_ENABLED")&&2===environment_1.ENV.get("WEBGL_VERSION")?1:4}function createTexture(e){return throwIfNull(e,function(){return e.createTexture()},"Unable to create WebGLTexture.")}function validateTextureSize(e,r,t){var n=queryMaxTextureSize(e);if(r<=0||t<=0){var o="["+r+"x"+t+"]";throw new Error("Requested texture size "+o+" is invalid.")}if(n<r||n<t){o="["+r+"x"+t+"]";throw new Error("Requested texture size "+o+" greater than WebGL maximum on this browser / GPU "+("["+n+"x"+n+"]")+".")}}function createFramebuffer(e){return throwIfNull(e,function(){return e.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function bindVertexBufferToProgramAttribute(e,r,t,n,o,a,u){var i=e.getAttribLocation(r,t);-1!==i&&(callAndCheck(e,function(){return e.bindBuffer(e.ARRAY_BUFFER,n)}),callAndCheck(e,function(){return e.vertexAttribPointer(i,o,e.FLOAT,!1,a,u)}),callAndCheck(e,function(){return e.enableVertexAttribArray(i)}))}function bindTextureUnit(e,r,t){validateTextureUnit(e,t),callAndCheck(e,function(){return e.activeTexture(e.TEXTURE0+t)}),callAndCheck(e,function(){return e.bindTexture(e.TEXTURE_2D,r)})}function unbindTextureUnit(e,r){validateTextureUnit(e,r),callAndCheck(e,function(){return e.activeTexture(e.TEXTURE0+r)}),callAndCheck(e,function(){return e.bindTexture(e.TEXTURE_2D,null)})}function getProgramUniformLocationOrThrow(e,r,t){return throwIfNull(e,function(){return e.getUniformLocation(r,t)},'uniform "'+t+'" not present in program.')}function getProgramUniformLocation(e,r,t){return e.getUniformLocation(r,t)}function bindTextureToProgramUniformSampler(e,r,t,n,o){callAndCheck(e,function(){return bindTextureUnit(e,t,o)}),callAndCheck(e,function(){return e.uniform1i(n,o)})}function bindCanvasToFramebuffer(e){callAndCheck(e,function(){return e.bindFramebuffer(e.FRAMEBUFFER,null)}),callAndCheck(e,function(){return e.viewport(0,0,e.canvas.width,e.canvas.height)}),callAndCheck(e,function(){return e.scissor(0,0,e.canvas.width,e.canvas.height)})}function bindColorTextureToFramebuffer(e,r,t){callAndCheck(e,function(){return e.bindFramebuffer(e.FRAMEBUFFER,t)}),callAndCheck(e,function(){return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)})}function unbindColorTextureFromFramebuffer(e,r){callAndCheck(e,function(){return e.bindFramebuffer(e.FRAMEBUFFER,r)}),callAndCheck(e,function(){return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,null,0)})}function validateFramebuffer(e){var r=e.checkFramebufferStatus(e.FRAMEBUFFER);if(r!==e.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+getFramebufferErrorMessage(e,r))}function getFramebufferErrorMessage(e,r){switch(r){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case e.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+r}}function throwIfNull(e,r,t){var n=callAndCheck(e,function(){return r()});if(null==n)throw new Error(t);return n}function validateTextureUnit(e,r){var t=e.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,n=r+e.TEXTURE0;if(n<e.TEXTURE0||t<n)throw new Error("textureUnit must be in "+("[gl.TEXTURE0, gl.TEXTURE"+t+"]")+".")}function getTextureShapeFromLogicalShape(e,r){2!==r.length&&(r=util.squeezeShape(r).newShape);var t=queryMaxTextureSize(e),n=util.sizeFromShape(r);return r.length<=1&&n<=t?[n,1]:2===r.length&&r[0]<=t&&r[1]<=t?r:3===r.length&&r[0]<=t&&r[1]*r[2]<=t?[r[0],r[1]*r[2]]:4===r.length&&r[0]<=t&&r[1]*r[2]*r[3]<=t?[r[0],r[1]*r[2]*r[3]]:util.sizeToSquarishShape(n)}exports.createProgram=createProgram,exports.linkProgram=linkProgram,exports.validateProgram=validateProgram,exports.createStaticVertexBuffer=createStaticVertexBuffer,exports.createStaticIndexBuffer=createStaticIndexBuffer,exports.queryMaxTextureSize=queryMaxTextureSize,exports.getChannelsPerTexture=getChannelsPerTexture,exports.createTexture=createTexture,exports.validateTextureSize=validateTextureSize,exports.createFramebuffer=createFramebuffer,exports.bindVertexBufferToProgramAttribute=bindVertexBufferToProgramAttribute,exports.bindTextureUnit=bindTextureUnit,exports.unbindTextureUnit=unbindTextureUnit,exports.getProgramUniformLocationOrThrow=getProgramUniformLocationOrThrow,exports.getProgramUniformLocation=getProgramUniformLocation,exports.bindTextureToProgramUniformSampler=bindTextureToProgramUniformSampler,exports.bindCanvasToFramebuffer=bindCanvasToFramebuffer,exports.bindColorTextureToFramebuffer=bindColorTextureToFramebuffer,exports.unbindColorTextureFromFramebuffer=unbindColorTextureFromFramebuffer,exports.validateFramebuffer=validateFramebuffer,exports.getFramebufferErrorMessage=getFramebufferErrorMessage,exports.getTextureShapeFromLogicalShape=getTextureShapeFromLogicalShape;