"use strict";var __awaiter=this&&this.__awaiter||function(u,i,l,o){return new(l=l||Promise)(function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function n(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){t.done?e(t.value):new l(function(e){e(t.value)}).then(r,n)}a((o=o.apply(u,i||[])).next())})},__generator=this&&this.__generator||function(r,n){var a,u,i,l={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,u&&(i=u[2&t[0]?"return":t[0]?"throw":"next"])&&!(i=i.call(u,t[1])).done)return i;switch(u=0,i&&(t=[0,i.value]),t[0]){case 0:case 1:i=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,u=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(i=0<(i=l.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){l.label=t[1];break}if(6===t[0]&&l.label<i[1]){l.label=i[1],i=t;break}if(i&&l.label<i[2]){l.label=i[2],l.ops.push(t);break}i[2]&&l.ops.pop(),l.trys.pop();continue}t=n.call(r,l)}catch(e){t=[6,e],u=0}finally{a=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util");function getWebGLContextAttributes(){return{alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0}}function createWebGLContext(e){var t=getWebGLContextAttributes(),r=null!=e?webgl_util.createWebGLRenderingContextFromCanvas(e,t):webgl_util.createWebGLRenderingContext(t);return webgl_util.callAndCheck(r,function(){return r.disable(r.DEPTH_TEST)}),webgl_util.callAndCheck(r,function(){return r.disable(r.STENCIL_TEST)}),webgl_util.callAndCheck(r,function(){return r.disable(r.BLEND)}),webgl_util.callAndCheck(r,function(){return r.disable(r.DITHER)}),webgl_util.callAndCheck(r,function(){return r.disable(r.POLYGON_OFFSET_FILL)}),webgl_util.callAndCheck(r,function(){return r.disable(r.SAMPLE_COVERAGE)}),webgl_util.callAndCheck(r,function(){return r.enable(r.SCISSOR_TEST)}),webgl_util.callAndCheck(r,function(){return r.enable(r.CULL_FACE)}),webgl_util.callAndCheck(r,function(){return r.cullFace(r.BACK)}),r}function createVertexShader(e){return webgl_util.createVertexShader(e,"\n    precision highp float;\n    attribute vec3 clipSpacePos;\n    attribute vec2 uv;\n    varying vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")}function createVertexBuffer(e){var t=new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]);return webgl_util.createStaticVertexBuffer(e,t)}function createIndexBuffer(e){var t=new Uint16Array([0,1,2,2,1,3]);return webgl_util.createStaticIndexBuffer(e,t)}function getTextureInternalFormat(e,t){return environment_1.ENV.get("WEBGL_FLOAT_TEXTURE_ENABLED")&&2===environment_1.ENV.get("WEBGL_VERSION")?4===t?e.RGBA32F:e.R32F:e.RGBA}function getTextureFormat(e,t){return!environment_1.ENV.get("WEBGL_FLOAT_TEXTURE_ENABLED")||2!==environment_1.ENV.get("WEBGL_VERSION")||4===t?e.RGBA:e.RED}function getTextureType(e){return environment_1.ENV.get("WEBGL_FLOAT_TEXTURE_ENABLED")?e.FLOAT:e.UNSIGNED_BYTE}function createAndConfigureTexture(e,t,r,n){webgl_util.validateTextureSize(e,t,r);var a=webgl_util.createTexture(e),u=e.TEXTURE_2D,i=getTextureInternalFormat(e,n),l=getTextureFormat(e,n);return webgl_util.callAndCheck(e,function(){return e.bindTexture(u,a)}),webgl_util.callAndCheck(e,function(){return e.texParameteri(u,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE)}),webgl_util.callAndCheck(e,function(){return e.texParameteri(u,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}),webgl_util.callAndCheck(e,function(){return e.texParameteri(u,e.TEXTURE_MIN_FILTER,e.NEAREST)}),webgl_util.callAndCheck(e,function(){return e.texParameteri(u,e.TEXTURE_MAG_FILTER,e.NEAREST)}),webgl_util.callAndCheck(e,function(){return e.texImage2D(u,0,i,t,r,0,l,getTextureType(e),null)}),webgl_util.callAndCheck(e,function(){return e.bindTexture(e.TEXTURE_2D,null)}),a}function createMatrixTexture(e,t,r){var n=tex_util.getUnpackedMatrixTextureShapeWidthHeight(t,r);return createAndConfigureTexture(e,n[0],n[1],1)}function createColorMatrixTexture(e,t,r){var n=tex_util.getColorMatrixTextureShapeWidthHeight(t,r);return createAndConfigureTexture(e,n[0],n[1],4)}function createPackedMatrixTexture(e,t,r){var n=tex_util.getPackedMatrixTextureShapeWidthHeight(t,r);return createAndConfigureTexture(e,n[0],n[1],4)}function bindVertexProgramAttributeStreams(e,t,r){webgl_util.callAndCheck(e,function(){return e.bindBuffer(e.ARRAY_BUFFER,r)}),webgl_util.bindVertexBufferToProgramAttribute(e,t,"clipSpacePos",r,3,20,0),webgl_util.bindVertexBufferToProgramAttribute(e,t,"uv",r,2,20,12)}function uploadPixelDataToTexture(e,t,r){webgl_util.callAndCheck(e,function(){return e.bindTexture(e.TEXTURE_2D,t)}),webgl_util.callAndCheck(e,function(){return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r)}),webgl_util.callAndCheck(e,function(){return e.bindTexture(e.TEXTURE_2D,null)})}function uploadDataToTexture(e,t,r,n,a,u){var i=getTextureFormat(e,u);webgl_util.validateTextureSize(e,r,n),webgl_util.callAndCheck(e,function(){return e.bindTexture(e.TEXTURE_2D,t)}),webgl_util.callAndCheck(e,function(){return e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,i,getTextureType(e),a)}),webgl_util.callAndCheck(e,function(){return e.bindTexture(e.TEXTURE_2D,null)})}function uploadMatrixToTexture(e,t,r,n,a,u){var i,l,o=tex_util.getUnpackedMatrixTextureShapeWidthHeight(r,n),c=o[0],x=o[1];environment_1.ENV.get("WEBGL_FLOAT_TEXTURE_ENABLED")?1===(l=1===u?webgl_util.getChannelsPerTexture():u)?i=a:(i=new Float32Array(tex_util.getUnpackedArraySizeFromMatrixSize(a.length,l)),tex_util.encodeMatrixToUnpackedArray(a,i,l)):i=tex_util.encodeFloatArray(a),uploadDataToTexture(e,t,c,x,i,u)}function uploadMatrixToPackedTexture(e,t,r,n,a){var u=tex_util.getPackedMatrixTextureShapeWidthHeight(r,n),i=u[0],l=u[1],o=new Float32Array(tex_util.getPackedRGBAArraySizeFromMatrixShape(r,n));tex_util.encodeMatrixToPackedRGBA(a,r,n,o);uploadDataToTexture(e,t,i,l,o,4)}function getDownloadTargetArrayBuffer(e,t,r){var n=environment_1.ENV.get("WEBGL_FLOAT_TEXTURE_ENABLED")?new Float32Array(tex_util.getUnpackedArraySizeFromMatrixSize(e*t,r)):new Uint8Array(e*t*r);return n}function decodeDownloadTargetArrayBuffer(e,t,r,n){if(environment_1.ENV.get("WEBGL_FLOAT_TEXTURE_ENABLED")){var a=new Float32Array(t*r);return tex_util.decodeMatrixFromUnpackedArray(e,a,n),a}return tex_util.decodeToFloatArray(e)}function downloadMatrixFromOutputTextureAsync(i,l,o,c){return __awaiter(this,void 0,void 0,function(){var t,r,n,a,u;return __generator(this,function(e){switch(e.label){case 0:return t=i,n=getDownloadTargetArrayBuffer(o,c,r=4),a=n instanceof Float32Array?4*n.length:n,u=i.createBuffer(),webgl_util.callAndCheck(i,function(){return i.bindBuffer(t.PIXEL_PACK_BUFFER,u)}),webgl_util.callAndCheck(i,function(){return i.bufferData(t.PIXEL_PACK_BUFFER,a,i.STATIC_DRAW)}),webgl_util.callAndCheck(i,function(){return t.readPixels(0,0,c,o,i.RGBA,getTextureType(i),0)}),[4,l.getBufferSubDataAsync(t.PIXEL_PACK_BUFFER,0,n)];case 1:return e.sent(),[2,decodeDownloadTargetArrayBuffer(n,o,c,r)]}})})}function downloadMatrixFromOutputTexture(e,t,r){var n=tex_util.getUnpackedMatrixTextureShapeWidthHeight(t,r),a=n[0],u=n[1],i=getDownloadTargetArrayBuffer(t,r,4);return webgl_util.callAndCheck(e,function(){return e.readPixels(0,0,a,u,e.RGBA,getTextureType(e),i)}),decodeDownloadTargetArrayBuffer(i,t,r,4)}function downloadMatrixFromRGBAColorTexture(e,t,r,n){var a=t*r*4,u=new Uint8Array(a);webgl_util.callAndCheck(e,function(){return e.readPixels(0,0,r,t,e.RGBA,e.UNSIGNED_BYTE,u)});for(var i=new Float32Array(a),l=0;l<u.length;l++)i[l]=u[l];var o=new Float32Array(t*r*n);return tex_util.decodeMatrixFromUnpackedColorRGBAArray(i,o,n),o}function downloadMatrixFromPackedOutputTexture(e,t,r){var n=tex_util.getPackedMatrixTextureShapeWidthHeight(t,r),a=n[0],u=n[1],i=new Float32Array(tex_util.getPackedRGBAArraySizeFromMatrixShape(t,r));webgl_util.callAndCheck(e,function(){return e.readPixels(0,0,a,u,e.RGBA,getTextureType(e),i)});var l=new Float32Array(t*r);return tex_util.decodeMatrixFromPackedRGBA(i,t,r,l)}exports.getWebGLContextAttributes=getWebGLContextAttributes,exports.createWebGLContext=createWebGLContext,exports.createVertexShader=createVertexShader,exports.createVertexBuffer=createVertexBuffer,exports.createIndexBuffer=createIndexBuffer,exports.createMatrixTexture=createMatrixTexture,exports.createColorMatrixTexture=createColorMatrixTexture,exports.createPackedMatrixTexture=createPackedMatrixTexture,exports.bindVertexProgramAttributeStreams=bindVertexProgramAttributeStreams,exports.uploadPixelDataToTexture=uploadPixelDataToTexture,exports.uploadMatrixToTexture=uploadMatrixToTexture,exports.uploadMatrixToPackedTexture=uploadMatrixToPackedTexture,exports.downloadMatrixFromOutputTextureAsync=downloadMatrixFromOutputTextureAsync,exports.downloadMatrixFromOutputTexture=downloadMatrixFromOutputTexture,exports.downloadMatrixFromRGBAColorTexture=downloadMatrixFromRGBAColorTexture,exports.downloadMatrixFromPackedOutputTexture=downloadMatrixFromPackedOutputTexture;