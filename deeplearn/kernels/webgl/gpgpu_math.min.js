"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),shader_compiler=require("./shader_compiler"),NAN_UNIFORM_NAME="NaN";function shouldUploadNaNUniform(){return!environment_1.ENV.get("WEBGL_FLOAT_TEXTURE_ENABLED")}function compileProgram(e,t,r,a){for(var o=t.userCode,n=r.map(function(e,r){var a={logicalShape:e.tensor.shape,texShape:e.texData.texShape};return{name:t.variableNames[r],shapeInfo:a}}),i=n.map(function(e){return e.shapeInfo}),u={logicalShape:a.tensor.shape,texShape:a.texData.texShape},s=shader_compiler.makeShader(n,u,o,!0===t.supportsBroadcasting),p=e.createProgram(s),h={},m=0;m<t.variableNames.length;m++){var c=t.variableNames[m];h[c]=e.getUniformLocation(p,c)}return shouldUploadNaNUniform()&&(h[NAN_UNIFORM_NAME]=e.getUniformLocation(p,NAN_UNIFORM_NAME,!1)),{program:t,source:s,webGLProgram:p,uniformLocations:h,gpgpu:e,inShapeInfos:i,outShapeInfo:u}}function validateBinaryAndProgram(e,i){if(e.length!==i.length)throw Error("Binary was compiled with "+e.length+" inputs, but was executed with "+i.length+" inputs");e.forEach(function(e,r){var a=e.logicalShape,t=e.texShape,o=i[r].tensor.shape,n=i[r].texData.texShape;if(!util.arraysEqual(a,o))throw Error("Binary was compiled with different shapes than the current args. Shapes "+a+" and "+o+" must match");if(!util.arraysEqual(t,n))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+t+" and "+n+" must match")})}function runProgram(n,e,r,a){validateBinaryAndProgram(n.inShapeInfos,e),validateBinaryAndProgram([n.outShapeInfo],[r]);var t=r.texData.texture,o=r.texData.texShape,i=n.gpgpu;i.setOutputMatrixTexture(t,o[0],o[1]),i.setProgram(n.webGLProgram),e.forEach(function(e,r){var a=e.texData.texture,t=n.program.variableNames[r],o=n.uniformLocations[t];i.setInputMatrixTexture(a,o,r)}),shouldUploadNaNUniform()&&i.gl.uniform1f(n.uniformLocations[NAN_UNIFORM_NAME],NaN),null!=a&&a(i,n.webGLProgram),i.executeProgram()}function makeShaderKey(e,r,a){var t="";r.concat(a).forEach(function(e){t+=e.tensor.shape+"_"+e.texData.texShape});var o=e.userCode,n=(!0===e.supportsBroadcasting).toString(),i=e.constructor.name;return i+="_"+n+"_"+t+"_"+o}exports.compileProgram=compileProgram,exports.runProgram=runProgram,exports.makeShaderKey=makeShaderKey;