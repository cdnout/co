"use strict";var __decorate=this&&this.__decorate||function(n,o,e,r){var a,t=arguments.length,i=t<3?o:null===r?r=Object.getOwnPropertyDescriptor(o,e):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(n,o,e,r);else for(var u=n.length-1;0<=u;u--)(a=n[u])&&(i=(t<3?a(i):3<t?a(o,e,i):a(o,e))||i);return 3<t&&i&&Object.defineProperty(o,e,i),i};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),environment_1=require("../environment"),util=require("../util"),conv_util=require("./conv_util"),operation_1=require("./operation"),PoolOps=function(){function p(){}return p.maxPool=function(n,o,e,r,a){var t=n,i=!1;3===n.rank&&(i=!0,t=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===t.rank,"Error in maxPool: input must be rank 4 but got rank "+t.rank+"."),null!=a&&util.assert(util.isInt(r),"Error in maxPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+".");var u=conv_util.computePool2DInfo(t.shape,o,e,r,a),s=environment_1.ENV.engine.runKernel(function(n){return n.maxPool(t,u)},{x:t},function(n){return{x:function(){return p.maxPoolBackprop(n,t,o,e,r)}}});return i?s.as3D(s.shape[1],s.shape[2],s.shape[3]):s},p.maxPoolBackprop=function(n,o,e,r,a,t){util.assert(o.rank===n.rank,"Rank of input ("+o.rank+") does not match rank of dy ("+n.rank+")");var i=o,u=n,s=!1;3===o.rank&&(s=!0,i=o.as4D(1,o.shape[0],o.shape[1],o.shape[2]),u=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===u.rank,"Error in maxPoolBackprop: dy must be rank 4 but got rank "+u.rank+"."),util.assert(4===i.rank,"Error in maxPoolBackprop: input must be rank 4 but got rank "+i.rank+"."),null!=t&&util.assert(util.isInt(a),"Error in maxPoolBackprop: pad must be an integer when using, dimRoundingMode "+t+" but got pad "+a+".");var p=conv_util.computePool2DInfo(i.shape,e,r,a,t),l=environment_1.ENV.engine.runKernel(function(n){return n.maxPoolBackprop(u,i,p)},{dy4D:u,input4D:i});return s?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l},p.minPool=function(n,o,e,r,a){var t=n,i=!1;3===n.rank&&(i=!0,t=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===t.rank,"Error in minPool: x must be rank 4 but got rank "+t.rank+"."),null!=a&&util.assert(util.isInt(r),"Error in minPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+".");var u=conv_util.computePool2DInfo(t.shape,o,e,r,a),s=environment_1.ENV.engine.runKernel(function(n){return n.minPool(t,u)},{input4D:t});return i?s.as3D(s.shape[1],s.shape[2],s.shape[3]):s},p.avgPool=function(n,o,e,r,a){var t=n,i=!1;3===n.rank&&(i=!0,t=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===t.rank,"Error in avgPool: x must be rank 4 but got rank "+t.rank+"."),null!=a&&util.assert(util.isInt(r),"Error in avgPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+".");var u=conv_util.computePool2DInfo(t.shape,o,e,r),s=environment_1.ENV.engine.runKernel(function(n){return n.avgPool(t,u)},{x:t},function(n){return{x:function(){return p.avgPoolBackprop(n,t,o,e,r)}}});return i?s.as3D(s.shape[1],s.shape[2],s.shape[3]):s},p.avgPoolBackprop=function(n,o,e,r,a){util.assert(o.rank===n.rank,"Rank of input ("+o.rank+") does not match rank of dy ("+n.rank+")");var t=o,i=n,u=!1;3===o.rank&&(u=!0,t=o.as4D(1,o.shape[0],o.shape[1],o.shape[2]),i=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===i.rank,"Error in avgPoolBackprop: dy must be rank 4 but got rank "+i.rank+"."),util.assert(4===t.rank,"Error in avgPoolBackprop: input must be rank 4 but got rank "+t.rank+".");var s=conv_util.computePool2DInfo(t.shape,e,r,a),p=environment_1.ENV.engine.runKernel(function(n){return n.avgPoolBackprop(i,t,s)},{dy4D:i,input4D:t});return u?p.as3D(p.shape[1],p.shape[2],p.shape[3]):p},__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],p,"maxPool",null),__decorate([operation_1.operation],p,"maxPoolBackprop",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],p,"minPool",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],p,"avgPool",null),__decorate([operation_1.operation],p,"avgPoolBackprop",null),p}();exports.PoolOps=PoolOps;