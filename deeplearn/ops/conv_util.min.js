"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function computePool2DInfo(t,e,o,n,r,a){void 0===a&&(a="channelsLast");var u,i=parseTupleParam(e),p=i[0],l=i[1];if("channelsLast"===a)u=[p,l,t[3],t[3]];else{if("channelsFirst"!==a)throw new Error("Unknown dataFormat "+a);u=[p,l,t[1],t[1]]}return computeConv2DInfo(t,u,o,1,n,r,!1,a)}function computeConv2DInfo(t,e,o,n,r,a,u,i){void 0===u&&(u=!1),void 0===i&&(i="channelsLast");var p=[-1,-1,-1,-1],l=p[0],h=p[1],s=p[2],c=p[3];if("channelsLast"===i)l=t[0],h=t[1],s=t[2],c=t[3];else{if("channelsFirst"!==i)throw new Error("Unknown dataFormat "+i);l=t[0],c=t[1],h=t[2],s=t[3]}var f,d=e[0],m=e[1],g=e[3],D=parseTupleParam(o),v=D[0],I=D[1],P=parseTupleParam(n),S=P[0],w=P[1],M=getPadAndOutInfo(r,h,s,v,I,getEffectiveFilterSize(d,S),getEffectiveFilterSize(m,w),a),C=M.padInfo,b=M.outHeight,F=M.outWidth,W=u?g*c:g;return"channelsFirst"===i?f=[l,W,b,F]:"channelsLast"===i&&(f=[l,b,F,W]),{batchSize:l,dataFormat:i,inHeight:h,inWidth:s,inChannels:c,outHeight:b,outWidth:F,outChannels:W,padInfo:C,strideHeight:v,strideWidth:I,filterHeight:d,filterWidth:m,inShape:t,outShape:f,filterShape:e}}function computeOutputShape3D(t,e,o,n,r,a){null==r&&(r=computeDefaultPad(t,e,n));var u=t[0],i=t[1],p=conditionalRound((u-e+2*r)/n+1,a);util.assert(util.isInt(p),"The output # of rows ("+p+") must be an integer. Change the stride and/or zero pad parameters");var l=conditionalRound((i-e+2*r)/n+1,a);return util.assert(util.isInt(l),"The output # of columns ("+l+") must be an integer. Change the stride and/or zero pad parameters"),[p,l,o]}function computeDefaultPad(t,e,o){return Math.floor((t[0]*(o-1)-o+e)/2)}function computeWeightsShape4D(t,e,o,n){return[o,n,t,e]}function computeDilatedRC(t,e){return[(t[0]-1)*e+1,(t[1]-1)*e+1]}function parseTupleParam(t){return"number"==typeof t?[t,t]:t}function getEffectiveFilterSize(t,e){return e<=1?t:t+(t-1)*(e-1)}function getPadAndOutInfo(t,e,o,n,r,a,u,i){if("number"==typeof t){g={top:t,bottom:t,left:t,right:t};var p=computeOutputShape3D([e,o,1],a,1,n,t,i),l=p[0],h=p[1]}else if("same"===t)var s=((l=Math.ceil(e/n))-1)*n+a-e,c=((h=Math.ceil(o/r))-1)*r+u-o,f=Math.floor(s/2),d=s-f,m=Math.floor(c/2),g={top:f,bottom:d,left:m,right:c-m};else{if("valid"!==t)throw Error("Unknown padding parameter: "+t);g={top:0,bottom:0,left:0,right:0},l=Math.ceil((e-a+1)/n),h=Math.ceil((o-u+1)/r)}return{padInfo:g,outHeight:l,outWidth:h}}function conditionalRound(t,e){if(!e)return t;switch(e){case"round":return Math.round(t);case"ceil":return Math.ceil(t);case"floor":return Math.floor(t);default:throw new Error("Unknown roundingMode "+e)}}exports.computePool2DInfo=computePool2DInfo,exports.computeConv2DInfo=computeConv2DInfo,exports.computeOutputShape3D=computeOutputShape3D,exports.computeDefaultPad=computeDefaultPad,exports.computeWeightsShape4D=computeWeightsShape4D,exports.computeDilatedRC=computeDilatedRC;