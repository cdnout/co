"use strict";var __decorate=this&&this.__decorate||function(e,n,t,r){var a,o=arguments.length,i=o<3?n:null===r?r=Object.getOwnPropertyDescriptor(n,t):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,n,t,r);else for(var s=e.length-1;0<=s;s--)(a=e[s])&&(i=(o<3?a(i):3<o?a(n,t,i):a(n,t))||i);return 3<o&&i&&Object.defineProperty(n,t,i),i};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),environment_1=require("../environment"),util=require("../util"),conv_util=require("./conv_util"),operation_1=require("./operation"),ConvOps=function(){function h(){}return h.conv1d=function(e,n,t,r,a){var o=e,i=!1;2===e.rank&&(i=!0,o=e.as3D(1,e.shape[0],e.shape[1])),util.assert(3===o.rank,"Error in conv1d: input must be rank 3, but got rank "+o.rank+"."),util.assert(3===n.rank,"Error in conv1d: filter must be rank 3, but got rank "+n.rank+"."),null!=a&&util.assert(util.isInt(r),"Error in conv1d: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+"."),util.assert(o.shape[2]===n.shape[1],"Error in conv1d: depth of input ("+o.shape[2]+") must match  input depth for filter "+n.shape[1]+".");var s=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]),u=o.as4D(o.shape[0],1,o.shape[1],o.shape[2]),p=h.conv2d(u,s,[1,t],r,a);return i?p.as2D(p.shape[2],p.shape[3]):p.as3D(p.shape[0],p.shape[2],p.shape[3])},h.conv2d=function(e,n,t,r,a){var o=e,i=!1;3===e.rank&&(i=!0,o=e.as4D(1,e.shape[0],e.shape[1],e.shape[2])),util.assert(4===o.rank,"Error in conv2d: input must be rank 4, but got rank "+o.rank+"."),util.assert(4===n.rank,"Error in conv2d: filter must be rank 4, but got rank "+n.rank+"."),null!=a&&util.assert(util.isInt(r),"Error in conv2d: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+"."),util.assert(o.shape[3]===n.shape[2],"Error in conv2d: depth of input ("+o.shape[3]+") must match  input depth for filter "+n.shape[2]+".");var s=conv_util.computeConv2DInfo(o.shape,n.shape,t,1,r,a),u=environment_1.ENV.engine.runKernel(function(e){return e.conv2d(o,n,s)},{x:o,filter:n},function(e){return{x:function(){return h.conv2dDerInput(o.shape,e,n,t,r)},filter:function(){return h.conv2dDerFilter(o,e,n.shape,t,r)}}});return i?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u},h.conv2dDerInput=function(e,n,t,r,a,o){util.assert(e.length===n.rank,"Length of inShape ("+e.length+") and rank of dy ("+n.rank+") must match");var i=e,s=n,u=!1;3===n.rank&&(u=!0,s=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]),i=[1,e[0],e[1],e[2]]);var p=i[3],h=s.shape[3];util.assert(4===i.length,"Error in conv2dDerInput: inShape must be length 4, but got length "+i.length+"."),util.assert(4===s.rank,"Error in conv2dDerInput: dy must be rank 4, but got rank "+s.rank),util.assert(4===t.rank,"Error in conv2dDerInput: filter must be rank 4, but got rank "+t.rank),util.assert(p===t.shape[2],"Error in conv2dDerInput: depth of input ("+p+") must match input depth for filter "+t.shape[2]+"."),util.assert(h===t.shape[3],"Error in conv2dDerInput: depth of output ("+h+") mustmatch output depth for filter "+t.shape[3]+"."),null!=o&&util.assert(util.isInt(a),"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+a+".");var d=conv_util.computeConv2DInfo(i,t.shape,r,1,a,o),l=environment_1.ENV.engine.runKernel(function(e){return e.conv2dDerInput(s,t,d)},{dy4D:s});return u?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l},h.conv2dDerFilter=function(e,n,t,r,a,o){var i=e;3===e.rank&&(i=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]));var s=n;3===s.rank&&(s=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===i.rank,"Error in conv2dDerFilter: input must be rank 4, but got shape "+i.shape+"."),util.assert(4===s.rank,"Error in conv2dDerFilter: dy must be rank 4, but got shape "+s.shape+"."),util.assert(4===t.length,"Error in conv2dDerFilter: filterShape must be length 4, but got "+t+"."),util.assert(i.shape[3]===t[2],"Error in conv2dDerFilter: depth of input "+i.shape[3]+") must match input depth in filter ("+t[2]+"."),util.assert(s.shape[3]===t[3],"Error in conv2dDerFilter: depth of dy ("+s.shape[3]+") must match output depth for filter ("+t[3]+")."),null!=o&&util.assert(util.isInt(a),"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+a+".");var u=conv_util.computeConv2DInfo(i.shape,t,r,1,a,o);return environment_1.ENV.engine.runKernel(function(e){return e.conv2dDerFilter(i,s,u)},{x4D:i,dy4D:s})},h.conv2dTranspose=function(e,n,t,r,a,o){return h.conv2dDerInput(t,e,n,r,a,o)},h.depthwiseConv2d=function(e,n,t,r,a,o){void 0===a&&(a=[1,1]);var i=e,s=!1;3===e.rank&&(s=!0,i=e.as4D(1,e.shape[0],e.shape[1],e.shape[2])),util.assert(4===i.rank,"Error in depthwiseConv2D: input must be rank 4, but got rank "+i.rank+"."),util.assert(4===n.rank,"Error in depthwiseConv2D: filter must be rank 4, but got rank "+n.rank+"."),util.assert(i.shape[3]===n.shape[2],"Error in depthwiseConv2D: number of input channels ("+i.shape[3]+") must match the inChannels dimension in filter "+n.shape[2]+"."),null==a&&(a=[1,1]);var u=parseTupleParam(a),p=u[0],h=u[1];util.assert(1===p&&1===h,"Error in depthwiseConv2D: dilation rates greater than 1 are not yet supported. Got dilations '"+a+"'"),null!=o&&util.assert(util.isInt(r),"Error in depthwiseConv2D: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+".");var d=conv_util.computeConv2DInfo(i.shape,n.shape,t,a,r,o,!0),l=environment_1.ENV.engine.runKernel(function(e){return e.depthwiseConv2D(i,n,d)},{input4D:i,filter:n});return s?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l},__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],h,"conv1d",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],h,"conv2d",null),__decorate([operation_1.operation],h,"conv2dDerInput",null),__decorate([operation_1.operation],h,"conv2dDerFilter",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],h,"conv2dTranspose",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],h,"depthwiseConv2d",null),h}();function parseTupleParam(e){return"number"==typeof e?[e,e]:e}exports.ConvOps=ConvOps;