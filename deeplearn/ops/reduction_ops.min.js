"use strict";var __decorate=this&&this.__decorate||function(e,n,a,r){var i,t=arguments.length,o=t<3?n:null===r?r=Object.getOwnPropertyDescriptor(n,a):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,n,a,r);else for(var u=e.length-1;0<=u;u--)(i=e[u])&&(o=(t<3?i(o):3<t?i(n,a,o):i(n,a))||o);return 3<t&&o&&Object.defineProperty(n,a,o),o};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),environment_1=require("../environment"),globals_1=require("../globals"),tensor_1=require("../tensor"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),ops=require("./ops"),ReductionOps=function(){function e(){}return e.logSumExp=function(e,n,a){void 0===n&&(n=null),void 0===a&&(a=!1);var r=axis_util.parseAxisParam(n,e.shape),i=e.max(r,!0),t=e.sub(i).exp().sum(r).log(),o=i.reshape(t.shape).add(t);if(a){var u=axis_util.expandShapeToKeepDim(o.shape,r);return o.reshape(u)}return o},e.sum=function(e,n,o){void 0===n&&(n=null),void 0===o&&(o=!1);var u=axis_util.parseAxisParam(n,e.shape);return globals_1.customGrad(function(a){var e=axis_util.getAxesPermutation(u,a.rank),n=u,r=a;null!=e&&(r=a.transpose(e),n=axis_util.getInnerMostAxes(n.length,a.rank));var i,t=environment_1.ENV.engine.runKernel(function(e){return e.sum(r,n)},{permutedX:r});o&&(i=axis_util.expandShapeToKeepDim(t.shape,u),t=t.reshape(i));return{value:t,gradFunc:function(e){var n=a.shape.slice();return u.forEach(function(e){n[e]=1}),e.reshape(n).mul(tensor_1.Tensor.ones(a.shape,"float32"))}}})(e)},e.mean=function(e,n,i){void 0===n&&(n=null),void 0===i&&(i=!1);var t=axis_util.parseAxisParam(n,e.shape),a=axis_util.computeOutAndReduceShapes(e.shape,t)[1],o=util.sizeFromShape(a);return globals_1.customGrad(function(a){var r=ops.scalar(o);return{value:a.div(r).sum(n,i),gradFunc:function(e){var n=a.shape.slice();return t.forEach(function(e){n[e]=1}),e.reshape(n).mul(tensor_1.Tensor.ones(a.shape,"float32")).div(r)}}})(e)},e.min=function(n,e,a){void 0===e&&(e=null),void 0===a&&(a=!1);var r=axis_util.parseAxisParam(e,n.shape),i=r,t=axis_util.getAxesPermutation(i,n.rank);null!=t&&(n=n.transpose(t),i=axis_util.getInnerMostAxes(i.length,n.rank));var o=environment_1.ENV.engine.runKernel(function(e){return e.min(n,i)},{x:n});if(a){var u=axis_util.expandShapeToKeepDim(o.shape,r);return o.reshape(u)}return o},e.max=function(n,e,a){void 0===e&&(e=null),void 0===a&&(a=!1);var r=axis_util.parseAxisParam(e,n.shape),i=r,t=axis_util.getAxesPermutation(i,n.rank);null!=t&&(n=n.transpose(t),i=axis_util.getInnerMostAxes(i.length,n.rank));var o=environment_1.ENV.engine.runKernel(function(e){return e.max(n,i)},{x:n});if(a){var u=axis_util.expandShapeToKeepDim(o.shape,r);return o.reshape(u)}return o},e.argMin=function(n,e){void 0===e&&(e=null);var a=axis_util.parseAxisParam(e,n.shape),r=axis_util.getAxesPermutation(a,n.rank);return null!=r&&(n=n.transpose(r),a=axis_util.getInnerMostAxes(a.length,n.rank)),environment_1.ENV.engine.runKernel(function(e){return e.argMin(n,a)},{x:n})},e.argMax=function(n,e){void 0===e&&(e=null);var a=axis_util.parseAxisParam(e,n.shape),r=axis_util.getAxesPermutation(a,n.rank);return null!=r&&(n=n.transpose(r),a=axis_util.getInnerMostAxes(a.length,n.rank)),environment_1.ENV.engine.runKernel(function(e){return e.argMax(n,a)},{x:n})},e.moments=function(e,n,a){void 0===n&&(n=null),void 0===a&&(a=!1);var r=axis_util.parseAxisParam(n,e.shape),i=e.mean(r,a),t=i.shape;a||(t=axis_util.expandShapeToKeepDim(i.shape,r));var o=e.toFloat().sub(i.reshape(t)).square();return{mean:i,variance:o.mean(r,a)}},__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"logSumExp",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"sum",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"mean",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"min",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"max",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"argMin",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"argMax",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Normalization"}),operation_1.operation],e,"moments",null),e}();exports.ReductionOps=ReductionOps;