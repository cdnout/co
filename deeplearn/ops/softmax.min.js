"use strict";var __decorate=this&&this.__decorate||function(o,e,r,t){var a,n=arguments.length,s=n<3?e:null===t?t=Object.getOwnPropertyDescriptor(e,r):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(o,e,r,t);else for(var i=o.length-1;0<=i;i--)(a=o[i])&&(s=(n<3?a(s):3<n?a(e,r,s):a(e,r))||s);return 3<n&&s&&Object.defineProperty(e,r,s),s};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),globals_1=require("../globals"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),ops=require("./ops"),SoftmaxOps=function(){function o(){}return o.softmax=function(o,t){if(void 0===t&&(t=-1),-1===t&&(t=o.rank-1),t!==o.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+o.rank+" and dim was "+t);return globals_1.customGrad(function(o){var e=o.logSumExp([t],!0),r=o.toFloat().sub(e).exp();return{value:r,gradFunc:function(o){var e=o.mul(r);return e.sub(e.sum([t],!0).mul(r))}}})(o)},o.softmaxCrossEntropy=function(o,e,a){if(void 0===a&&(a=-1),util.assertShapesMatch(o.shape,e.shape,"Error in softmaxCrossEntropy: "),-1===a&&(a=e.rank-1),a!==e.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+e.rank+" and dim was "+a);return globals_1.customGrad(function(r,o){var t=o.softmax(a);return{value:ops.scalar(1e-5).add(t).log().mul(r).neg().sum([a]),gradFunc:function(o){var e=axis_util.expandShapeToKeepDim(o.shape,[a]);return[o.reshape(e).mul(r.toFloat().sub(t)),o.reshape(e).mul(t.sub(r.toFloat()))]}}})(o,e)},__decorate([doc_1.doc({heading:"Operations",subheading:"Normalization"}),operation_1.operation],o,"softmax",null),__decorate([doc_1.doc({heading:"Training",subheading:"Losses",namespace:"losses"}),operation_1.operation],o,"softmaxCrossEntropy",null),o}();exports.SoftmaxOps=SoftmaxOps;