"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("../tensor"),util=require("../util"),STATS_SAMPLE_PERCENTAGE=.1,InMemoryDataset=function(){function t(t){this.dataShapes=t,this.normalizationInfo={}}return t.prototype.getDataShape=function(t){return this.dataShapes[t]},t.prototype.getData=function(){return this.dataset},t.prototype.getStats=function(){var a=this;if(null==this.dataset)throw new Error("Data is null.");return this.dataset.map(function(t){return a.getStatsForData(t)})},t.prototype.getStatsForData=function(t){var a=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,o=t.map(function(t,a){return a});util.shuffle(o),o=o.slice(o.length*STATS_SAMPLE_PERCENTAGE);for(var i=0;i<o.length;i++)for(var r=t[o[i]].dataSync(),e=0;e<r.length;e++)a=Math.min(a,r[e]),n=Math.max(n,r[e]);return{inputMin:a,inputMax:n,exampleCount:t.length,shape:t[0].shape}},t.prototype.normalizeExamplesToRange=function(t,l,u,h,m){var f=u instanceof Float32Array&&l instanceof Float32Array,p=h instanceof Float32Array&&m instanceof Float32Array,d=util.sizeFromShape(t[0].shape),I=[];return t.forEach(function(t){for(var a=t.dataSync(),n=new Float32Array(d),o=0;o<d;o++){var i=f?l[o]:l,r=(f?u[o]:u)-i,e=p?h[o]:h,s=(p?m[o]:m)-e;n[o]=0==r?e:e+s*(a[o]-i)/r}I.push(tensor_1.Tensor.make(t.shape,{values:n},"float32"))}),I},t.prototype.computeBounds=function(o){var i=this;if(null==this.dataset)throw new Error("Data is null.");var r=util.sizeFromShape(this.dataset[o][0].shape);this.normalizationInfo[o]={isNormalized:!1,minValues:new Float32Array(r),maxValues:new Float32Array(r)};for(var t=0;t<r;t++)this.normalizationInfo[o].minValues[t]=Number.POSITIVE_INFINITY,this.normalizationInfo[o].maxValues[t]=Number.NEGATIVE_INFINITY;this.dataset[o].forEach(function(t){for(var a=t.dataSync(),n=0;n<r;n++)i.normalizationInfo[o].minValues[n]=Math.min(i.normalizationInfo[o].minValues[n],a[n]),i.normalizationInfo[o].maxValues[n]=Math.max(i.normalizationInfo[o].maxValues[n],a[n])})},t.prototype.normalizeWithinBounds=function(t,a,n){if(null==this.dataset)throw new Error("Data is null.");if(t>=this.dataset.length)throw new Error("dataIndex out of bounds.");var o,i;null==this.normalizationInfo[t]&&this.computeBounds(t),i=this.normalizationInfo[t].isNormalized?(o=this.normalizationInfo[t].lowerBound,this.normalizationInfo[t].upperBound):(o=this.normalizationInfo[t].minValues,this.normalizationInfo[t].maxValues),this.dataset[t]=this.normalizeExamplesToRange(this.dataset[t],o,i,a,n),this.normalizationInfo[t].isNormalized=!0,this.normalizationInfo[t].lowerBound=a,this.normalizationInfo[t].upperBound=n},t.prototype.isNormalized=function(t){return null!=this.normalizationInfo&&this.normalizationInfo[t].isNormalized},t.prototype.removeNormalization=function(t){if(null==this.dataset)throw new Error("Training or test data is null.");this.isNormalized(t)&&(this.dataset[t]=this.normalizeExamplesToRange(this.dataset[t],this.normalizationInfo[t].lowerBound,this.normalizationInfo[t].upperBound,this.normalizationInfo[t].minValues,this.normalizationInfo[t].maxValues),this.normalizationInfo[t].isNormalized=!1)},t.prototype.unnormalizeExamples=function(t,a){return this.isNormalized(a)?this.normalizeExamplesToRange(t,this.normalizationInfo[a].lowerBound,this.normalizationInfo[a].upperBound,this.normalizationInfo[a].minValues,this.normalizationInfo[a].maxValues):t},t.prototype.dispose=function(){if(null!=this.dataset){for(var t=0;t<this.dataset.length;t++)for(var a=0;a<this.dataset[t].length;a++)this.dataset[t][a].dispose();this.dataset=[]}},t}();exports.InMemoryDataset=InMemoryDataset;