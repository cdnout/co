"use strict";var __awaiter=this&&this.__awaiter||function(a,o,u,s){return new(u=u||Promise)(function(e,t){function n(e){try{i(s.next(e))}catch(e){t(e)}}function r(e){try{i(s.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(n,r)}i((s=s.apply(a,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var i,a,o,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,a&&(o=a[2&t[0]?"return":t[0]?"throw":"next"])&&!(o=o.call(a,t[1])).done)return o;switch(a=0,o&&(t=[0,o.value]),t[0]){case 0:case 1:o=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,a=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(o=0<(o=u.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){u.label=t[1];break}if(6===t[0]&&u.label<o[1]){u.label=o[1],o=t;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(t);break}o[2]&&u.ops.pop(),u.trys.pop();continue}t=r.call(n,u)}catch(e){t=[6,e],a=0}finally{i=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var ops_1=require("./ops/ops"),util=require("./util"),DTYPE_VALUE_SIZE_MAP={float32:4,int32:4};function loadWeights(p,s,y){return void 0===s&&(s=""),__awaiter(this,void 0,void 0,function(){var a,f,o,u,t,n,r,i,c,l,h;return __generator(this,function(e){switch(e.label){case 0:if(a=p.map(function(){return!1}),f={},o=null!=y?y.map(function(){return!1}):[],u=[],p.forEach(function(e,t){var i=0;e.weights.forEach(function(n){function r(){a[t]=!0,null==f[t]&&(f[t]=[]),f[t].push({manifestEntry:n,groupOffset:i,sizeBytes:e})}var e=DTYPE_VALUE_SIZE_MAP[n.dtype]*util.sizeFromShape(n.shape);null!=y?y.forEach(function(e,t){e===n.name&&(r(),o[t]=!0)}):r(),u.push(n.name),i+=e})}),!o.every(function(e){return e}))throw t=y.filter(function(e,t){return!o[t]}),new Error("Could not find weights in manifest with names: "+t.join(", ")+". \nManifest JSON has weights with names: "+u.join(", ")+".");return n=a.reduce(function(e,t,n){return t&&e.push(n),e},[]),r=[],n.forEach(function(e){p[e].paths.forEach(function(e){var t=s+(s.endsWith("/")?"":"/")+e;r.push(fetch(t))})}),[4,Promise.all(r)];case 1:return i=e.sent(),[4,Promise.all(i.map(function(e){return e.arrayBuffer()}))];case 2:return c=e.sent(),l={},h=0,n.forEach(function(e){for(var t=p[e].paths.length,n=0,r=0;r<t;r++)n+=c[h+r].byteLength;for(var i=new ArrayBuffer(n),a=new Uint8Array(i),o=0,u=0;u<t;u++){var s=new Uint8Array(c[h+u]);a.set(s,o),o+=s.byteLength}f[e].forEach(function(e){var t,n=i.slice(e.groupOffset,e.groupOffset+e.sizeBytes);if("float32"===e.manifestEntry.dtype)t=new Float32Array(n);else{if("int32"!==e.manifestEntry.dtype)throw new Error("Weight "+e.manifestEntry.name+" has unknown dtype "+e.manifestEntry.dtype+".");t=new Int32Array(n)}var r=e.manifestEntry.name;if(null!=l[r])throw new Error("Duplicate weight with name "+r+". Please make sure weights names are unique in the manifest JSON.");l[r]=ops_1.tensor(t,e.manifestEntry.shape,e.manifestEntry.dtype)}),h+=t}),[2,l]}})})}exports.loadWeights=loadWeights;