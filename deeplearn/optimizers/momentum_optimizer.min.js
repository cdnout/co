"use strict";var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),globals_1=require("../globals"),tensor_array_map_1=require("../graph/tensor_array_map"),ops_1=require("../ops/ops"),tensor_1=require("../tensor"),sgd_optimizer_1=require("./sgd_optimizer"),MomentumOptimizer=function(s){function e(e,t,r,i){void 0===i&&(i=!1);var o=s.call(this,e,r)||this;return o.learningRate=e,o.momentum=t,o.useNesterov=i,o.m=ops_1.scalar(o.momentum),o.accumulations={},o}return __extends(e,s),e.prototype.applyGradients=function(e){function t(r){var i=environment_1.ENV.engine.registeredVariables[r];null==n.accumulations[r]&&globals_1.tidy(function(){s.accumulations[r]=ops_1.zerosLike(i).variable(!1)});var o=n.accumulations[r],a=e[r];globals_1.tidy(function(){var e=s.m.mul(o).add(a),t=s.useNesterov?s.c.mul(a.add(e.mul(s.m))).add(i):s.c.mul(e).add(i);s.accumulations[r].assign(e),i.assign(t)})}var s=this,n=this;for(var r in e)t(r)},e.prototype.beforeBatch=function(e,t,r,i,o){var a=this;null==this.variableVelocitiesGraph&&(this.variableVelocitiesGraph=new tensor_array_map_1.TensorArrayMap),s.prototype.beforeBatch.call(this,e,t,r,i,o),0===this.variableVelocitiesGraph.size()&&this.variableNodes.forEach(function(e){a.variableVelocitiesGraph.set(e.output,tensor_1.Tensor.zeros(e.output.shape))})},e.prototype.afterBatch=function(e,t,r,s,i){var n=this;globals_1.tidy(function(){n.variableNodes.forEach(function(e){var t=s.get(e.output),r=n.variableGradients.get(e.output),i=n.variableVelocitiesGraph.get(e.output),o=n.m.mul(i).add(r),a=n.useNesterov?n.cGraph.mul(r.add(o.mul(n.m))).add(t):n.cGraph.mul(o).add(t);n.variableVelocitiesGraph.set(e.output,globals_1.keep(o)),s.set(e.output,globals_1.keep(a)),e.data=a,t.dispose(),i.dispose()})}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},e.prototype.dispose=function(){if(s.prototype.dispose.call(this),this.m.dispose(),null!=this.variableVelocitiesGraph&&this.variableVelocitiesGraph.dispose(),null!=this.accumulations)for(var e in this.accumulations)this.accumulations[e].dispose()},e.prototype.setMomentum=function(e){this.momentum=e},e}(sgd_optimizer_1.SGDOptimizer);exports.MomentumOptimizer=MomentumOptimizer;