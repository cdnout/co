"use strict";var __extends=this&&this.__extends||function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,a){e.__proto__=a}||function(e,a){for(var t in a)a.hasOwnProperty(t)&&(e[t]=a[t])};return function(e,a){function t(){this.constructor=e}s(e,a),e.prototype=null===a?Object.create(a):(t.prototype=a.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),globals_1=require("../globals"),session_util=require("../graph/session_util"),tensor_array_map_1=require("../graph/tensor_array_map"),ops_1=require("../ops/ops"),tensor_1=require("../tensor"),optimizer_1=require("./optimizer"),RMSPropOptimizer=function(u){function e(e,a,t,s,r){void 0===a&&(a=.9),void 0===t&&(t=0),void 0===r&&(r=1e-8);var o=u.call(this,e,s)||this;return o.learningRate=e,o.accumulatedMeanSquares={},o.accumulatedMoments={},o.accumulatedMeanSquaredGraph=new tensor_array_map_1.TensorArrayMap,o.accumulatedMomentGraph=new tensor_array_map_1.TensorArrayMap,o.c=globals_1.keep(ops_1.scalar(e)),o.epsilon=globals_1.keep(ops_1.scalar(r)),o.decay=globals_1.keep(ops_1.scalar(a)),o.momentum=globals_1.keep(ops_1.scalar(t)),o.oneMinusDecay=globals_1.keep(ops_1.scalar(1-a)),o}return __extends(e,u),e.prototype.applyGradients=function(e){function a(s){var r=environment_1.ENV.engine.registeredVariables[s];null==t.accumulatedMeanSquares[s]&&globals_1.tidy(function(){n.accumulatedMeanSquares[s]=ops_1.zerosLike(r).variable(!1)}),null==t.accumulatedMoments[s]&&globals_1.tidy(function(){n.accumulatedMoments[s]=ops_1.zerosLike(r).variable(!1)});var o=t.accumulatedMeanSquares[s],u=t.accumulatedMoments[s],i=e[s];globals_1.tidy(function(){var e=n.decay.mul(o).add(n.oneMinusDecay.mul(i.square())),a=n.momentum.mul(u).add(n.c.mul(i).div(e.add(n.epsilon).sqrt()));n.accumulatedMeanSquares[s].assign(e),n.accumulatedMoments[s].assign(a);var t=r.sub(a);r.assign(t)})}var n=this,t=this;for(var s in e)a(s)},e.prototype.beforeBatch=function(a,e,t,s,r){var o=this;this.variableNodes=null==this.specifiedVariableNodes?session_util.getVariableNodesFromEvaluationSet(t.nodes):this.specifiedVariableNodes,e!==this.prevBatchSize&&(null!=this.cGraph&&this.cGraph.dispose(),this.prevBatchSize=e,this.cGraph=a.keep(ops_1.scalar(this.learningRate/e))),this.variableNodes.forEach(function(e){return o.variableGradients.set(e.output,a.keep(tensor_1.Tensor.zeros(e.output.shape)))}),0===this.accumulatedMeanSquaredGraph.size()&&this.variableNodes.forEach(function(e){o.accumulatedMeanSquaredGraph.set(e.output,tensor_1.Tensor.zeros(e.output.shape)),o.accumulatedMomentGraph.set(e.output,tensor_1.Tensor.zeros(e.output.shape))})},e.prototype.afterBatch=function(n,e,a,c,t){var p=this;globals_1.tidy(function(){p.variableNodes.forEach(function(e){var a=c.get(e.output),t=p.variableGradients.get(e.output),s=p.accumulatedMeanSquaredGraph.get(e.output),r=p.accumulatedMomentGraph.get(e.output),o=n.scaledArrayAdd(p.decay,s,p.oneMinusDecay,t.square()),u=n.scaledArrayAdd(p.momentum,r,p.cGraph,t.div(o.add(p.epsilon).sqrt())),i=a.sub(u);p.accumulatedMeanSquaredGraph.set(e.output,globals_1.keep(o)),p.accumulatedMomentGraph.set(e.output,globals_1.keep(u)),c.set(e.output,globals_1.keep(i)),e.data=i,a.dispose(),s.dispose(),r.dispose()})}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},e.prototype.dispose=function(){var a=this;u.prototype.dispose.call(this),this.c.dispose(),this.epsilon.dispose(),this.decay.dispose(),this.momentum.dispose(),this.oneMinusDecay.dispose(),null!=this.accumulatedMeanSquaredGraph&&this.accumulatedMeanSquaredGraph.dispose(),null!=this.accumulatedMomentGraph&&this.accumulatedMomentGraph.dispose(),null!=this.accumulatedMeanSquares&&Object.keys(this.accumulatedMeanSquares).forEach(function(e){return a.accumulatedMeanSquares[e].dispose()}),null!=this.accumulatedMoments&&Object.keys(this.accumulatedMoments).forEach(function(e){return a.accumulatedMoments[e].dispose()})},e}(optimizer_1.Optimizer);exports.RMSPropOptimizer=RMSPropOptimizer;