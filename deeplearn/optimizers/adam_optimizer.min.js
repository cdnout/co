"use strict";var __extends=this&&this.__extends||function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])};return function(e,t){function a(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),globals_1=require("../globals"),tensor_array_map_1=require("../graph/tensor_array_map"),ops_1=require("../ops/ops"),tensor_1=require("../tensor"),optimizer_1=require("./optimizer"),AdamOptimizer=function(n){function e(e,t,a,s,o){void 0===s&&(s=1e-8);var r=n.call(this,e,o)||this;return r.learningRate=e,r.accumulatedFirstMoment={},r.accumulatedSecondMoment={},r.firstMomentGraph=new tensor_array_map_1.TensorArrayMap,r.secondMomentGraph=new tensor_array_map_1.TensorArrayMap,r.c=globals_1.keep(ops_1.scalar(-e)),r.eps=globals_1.keep(ops_1.scalar(s)),r.beta1=globals_1.keep(ops_1.scalar(t)),r.beta2=globals_1.keep(ops_1.scalar(a)),globals_1.tidy(function(){r.accBeta1=ops_1.scalar(t).variable(),r.accBeta2=ops_1.scalar(a).variable()}),r.oneMinusBeta1=globals_1.keep(ops_1.scalar(1-t)),r.oneMinusBeta2=globals_1.keep(ops_1.scalar(1-a)),r.one=globals_1.keep(ops_1.scalar(1)),r}return __extends(e,n),e.prototype.applyGradients=function(m){var _=this;globals_1.tidy(function(){var e=_.one.sub(_.accBeta1),t=_.one.sub(_.accBeta2);for(var a in m){var s,o=environment_1.ENV.engine.registeredVariables[a];null==_.accumulatedFirstMoment[a]&&(s=!1,_.accumulatedFirstMoment[a]=ops_1.zerosLike(o).variable(s)),null==_.accumulatedSecondMoment[a]&&(s=!1,_.accumulatedSecondMoment[a]=ops_1.zerosLike(o).variable(s));var r=m[a],n=_.accumulatedFirstMoment[a],i=_.accumulatedSecondMoment[a],c=_.beta1.mul(n).add(_.oneMinusBeta1.mul(r)),p=_.beta2.mul(i).add(_.oneMinusBeta2.mul(r.square())),u=c.div(e),l=p.div(t);_.accumulatedFirstMoment[a].assign(c),_.accumulatedSecondMoment[a].assign(p);var d=_.c.mul(u.div(_.eps.add(l.sqrt()))).add(o);o.assign(d)}_.accBeta1.assign(_.accBeta1.mul(_.beta1)),_.accBeta2.assign(_.accBeta2.mul(_.beta2))})},e.prototype.beforeBatch=function(e,t,a,s,o){var r=this;n.prototype.beforeBatch.call(this,e,t,a,s,o),0===this.firstMomentGraph.size()&&this.variableNodes.forEach(function(e){r.firstMomentGraph.set(e.output,tensor_1.Tensor.zeros(e.output.shape))}),0===this.secondMomentGraph.size()&&this.variableNodes.forEach(function(e){r.secondMomentGraph.set(e.output,tensor_1.Tensor.zeros(e.output.shape))})},e.prototype.afterBatch=function(d,e,t,m,a){var _=this;globals_1.tidy(function(){var u=_.one.sub(_.accBeta1),l=_.one.sub(_.accBeta2);_.variableNodes.forEach(function(e){var t=m.get(e.output),a=_.variableGradients.get(e.output),s=_.firstMomentGraph.get(e.output),o=_.secondMomentGraph.get(e.output),r=d.scaledArrayAdd(_.beta1,s,_.oneMinusBeta1,a),n=d.scaledArrayAdd(_.beta2,o,_.oneMinusBeta2,a.square()),i=r.div(u),c=n.div(l),p=d.scaledArrayAdd(_.cGraph,i.div(_.eps.add(c.sqrt())),_.one,t);m.set(e.output,globals_1.keep(p)),e.data=p,_.firstMomentGraph.set(e.output,globals_1.keep(r)),_.secondMomentGraph.set(e.output,globals_1.keep(n)),t.dispose(),a.dispose(),s.dispose(),o.dispose()}),_.accBeta1.assign(_.accBeta1.mul(_.beta1)),_.accBeta2.assign(_.accBeta2.mul(_.beta2))}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},e.prototype.dispose=function(){var t=this;n.prototype.dispose.call(this),this.c.dispose(),this.eps.dispose(),this.beta1.dispose(),this.beta2.dispose(),this.accBeta1.dispose(),this.accBeta2.dispose(),this.oneMinusBeta1.dispose(),this.oneMinusBeta2.dispose(),this.one.dispose(),null!=this.firstMomentGraph&&this.firstMomentGraph.dispose(),null!=this.secondMomentGraph&&this.secondMomentGraph.dispose(),null!=this.accumulatedFirstMoment&&Object.keys(this.accumulatedFirstMoment).forEach(function(e){return t.accumulatedFirstMoment[e].dispose()}),null!=this.accumulatedSecondMoment&&Object.keys(this.accumulatedSecondMoment).forEach(function(e){return t.accumulatedSecondMoment[e].dispose()})},e}(optimizer_1.Optimizer);exports.AdamOptimizer=AdamOptimizer;