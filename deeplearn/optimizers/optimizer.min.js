"use strict";var __decorate=this&&this.__decorate||function(e,t,i,r){var a,s=arguments.length,o=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var n=e.length-1;0<=n;n--)(a=e[n])&&(o=(s<3?a(o):3<s?a(t,i,o):a(t,i))||o);return 3<s&&o&&Object.defineProperty(t,i,o),o};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),globals_1=require("../globals"),session_util=require("../graph/session_util"),tensor_array_map_1=require("../graph/tensor_array_map"),ops=require("../ops/ops"),tensor_1=require("../tensor"),Optimizer=function(){function e(e,t){this.learningRate=e,this.variableGradients=new tensor_array_map_1.TensorArrayMap,null!=t&&(this.specifiedVariableNodes=t)}return e.prototype.minimize=function(e,t,i){void 0===t&&(t=!1);var r=this.computeGradients(e,i),a=r.value,s=r.grads;return this.applyGradients(s),Object.keys(s).forEach(function(e){return s[e].dispose()}),t?a:(a.dispose(),null)},e.prototype.computeGradients=function(e,t){return globals_1.variableGrads(e,t)},e.prototype.beforeBatch=function(t,e,i,r,a){var s=this;this.variableNodes=null==this.specifiedVariableNodes?session_util.getVariableNodesFromEvaluationSet(i.nodes):this.specifiedVariableNodes,e!==this.prevBatchSize&&(null!=this.cGraph&&this.cGraph.dispose(),this.prevBatchSize=e,this.cGraph=t.keep(ops.scalar(-this.learningRate/e))),this.variableNodes.forEach(function(e){return s.variableGradients.set(e.output,t.keep(tensor_1.Tensor.zeros(e.output.shape)))})},e.prototype.afterExample=function(r,e,t,a){var s=this;globals_1.tidy(function(){s.variableNodes.forEach(function(e){var t=a.get(e.output),i=s.variableGradients.get(e.output);s.variableGradients.set(e.output,globals_1.keep(r.add(t,i))),i.dispose()})})},e.prototype.dispose=function(){null!=this.cGraph&&this.cGraph.dispose(),null!=this.variableNodes&&this.variableNodes.forEach(function(e){e.data.dispose()}),null!=this.specifiedVariableNodes&&this.specifiedVariableNodes.forEach(function(e){e.data.dispose()})},__decorate([doc_1.doc({heading:"Training",subheading:"Optimizers"})],e.prototype,"minimize",null),e=__decorate([doc_1.doc({heading:"Training",subheading:"Classes",namespace:"train"})],e)}();exports.Optimizer=Optimizer;