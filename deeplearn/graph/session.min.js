"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var CostReduction,globals_1=require("../globals"),tensor_1=require("../tensor"),util=require("../util"),operation_emitter=require("./operation_emitter"),session_util=require("./session_util"),tensor_array_map_1=require("./tensor_array_map"),FeedDictionary=function(t){var e=this;this.dict={},t&&t.forEach(function(t){return e.dict[t.tensor.id]=t})};exports.FeedDictionary=FeedDictionary,function(t){t[t.NONE=0]="NONE",t[t.SUM=1]="SUM",t[t.MEAN=2]="MEAN"}(CostReduction=exports.CostReduction||(exports.CostReduction={}));var Session=function(){function t(t,e){this.math=e,this.activationArrayMap=new tensor_array_map_1.TensorArrayMap,this.runtimeCache={},this.oneScalar=tensor_1.Scalar.new(1),this.gradientArrayMap=new tensor_array_map_1.SummedTensorArrayMap(this.math)}return t.prototype.dispose=function(){var r=this;this.activationArrayMap.dispose(),Object.keys(this.runtimeCache).forEach(function(t){var e=r.runtimeCache[t];e.operations&&e.operations.forEach(function(t){return t.dispose()})}),this.runtimeCache={},null!=this.batchSizeScalar&&this.batchSizeScalar.dispose(),this.oneScalar.dispose()},t.prototype.evalAll=function(a,o){var s=this;return globals_1.tidy(function(){var t=new FeedDictionary(o),e=s.getOrCreateRuntime(a,t),r=s.activationArrayMap;session_util.disposeAndInitializeOperationOutputs(e.nodes,r),session_util.disposeTransientOperationArrays(e.operations,s.activationArrayMap,s.gradientArrayMap),session_util.addPersistentArraysToTensorArrayMap(e.nodes,r),session_util.loadInputsFromFeedDictionaryToTensorArrayMap(t,r,s.math),e.operations.forEach(function(t){return t.feedForward(s.math,r)});var i=a.map(function(t){return r.get(t)});return a.forEach(function(t){return r.delete(t)}),session_util.releaseFeedDictionaryInputsFromTensorArrayMap(t,r,s.math),i})},t.prototype.eval=function(t,e){return this.evalAll([t],e)[0]},t.prototype.train=function(r,t,i,a,o){var s=this;void 0===o&&(o=CostReduction.NONE),util.assert(util.isScalarShape(r.shape),"Cost tensor for training must be a scalar value."),this.prevBatchSize!==i&&(this.prevBatchSize=i,null!=this.batchSizeScalar&&this.batchSizeScalar.dispose(),this.batchSizeScalar=this.math.keep(tensor_1.Scalar.new(i)));var n=new FeedDictionary(t);session_util.throwIfFeedDictionaryContainsNDArrays(n);var u=this.getOrCreateRuntime([r],n),c=u.operations,p=u.operations.slice().reverse(),h=this.activationArrayMap,d=this.gradientArrayMap;return d.nullify(r),d.add(r,this.oneScalar),session_util.addPersistentArraysToTensorArrayMap(u.nodes,h),a.beforeBatch(this.math,i,u,h,d),globals_1.tidy(function(){for(var t=tensor_1.Scalar.new(0),e=0;e<i;++e)session_util.disposeAndInitializeOperationOutputs(u.nodes,h),session_util.disposeAndInitializeOperationInputGradients(u.nodes,d),session_util.disposeTransientOperationArrays(u.operations,h,d),session_util.loadInputsFromFeedDictionaryToTensorArrayMap(n,h,s.math),c.forEach(function(t){return t.feedForward(s.math,h)}),p.forEach(function(t){return t.backProp(s.math,h,d)}),a.afterExample(s.math,u,h,d),session_util.releaseFeedDictionaryInputsFromTensorArrayMap(n,h,s.math),t=s.updateCostForExample(t,h.get(r),o);return a.afterBatch(s.math,i,u,h,d),s.updateCostForBatch(t,o)})},t.prototype.updateCostForExample=function(t,e,r){return r===CostReduction.MEAN||r===CostReduction.SUM?this.math.add(t,e):t},t.prototype.updateCostForBatch=function(t,e){return e===CostReduction.MEAN?this.math.divide(t,this.batchSizeScalar):t},t.prototype.getOrCreateRuntime=function(t,e){var r,i=this.makeRuntimeCacheKey(t,e),a=this.runtimeCache[i];return void 0===a&&(r=session_util.getOrderedEvaluationSetFromEvalTensor(t,e),session_util.removeFeedDictionaryNodesFromEvaluationSet(e,r),session_util.throwErrorIfEvaluationSetContainsPlaceholderNodes(r),a={nodes:r,operations:operation_emitter.emitFromGraphNodes(r)},this.runtimeCache[i]=a),a},t.prototype.makeRuntimeCacheKey=function(t,e){return t.map(function(t){return t.id}).sort().join("_")+"__"+Object.keys(e.dict).sort().join("_")},t}();exports.Session=Session;