"use strict";var __extends=this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var globals_1=require("../../globals"),ops_1=require("../../ops/ops"),optimizer_1=require("../../optimizers/optimizer"),tensor_1=require("../../tensor"),tensor_array_map_1=require("../tensor_array_map"),AdamaxOptimizer=function(i){function e(e,t,r,o){var s=i.call(this,e,o)||this;return s.learningRate=e,s.beta1=t,s.beta2=r,s.firstMoment=new tensor_array_map_1.TensorArrayMap,s.weightedInfNorm=new tensor_array_map_1.TensorArrayMap,s.eps=tensor_1.Scalar.new(1e-8),s.b1=ops_1.scalar(s.beta1),s.b2=ops_1.scalar(s.beta2),s.accB1=ops_1.scalar(s.beta1),s.one=ops_1.scalar(1),s}return __extends(e,i),e.prototype.applyGradients=function(e){throw new Error("Adamax optimizer not yet implemented for eager mode.")},e.prototype.beforeBatch=function(e,t,r,o,s){var a=this;i.prototype.beforeBatch.call(this,e,t,r,o,s),0===this.firstMoment.size()&&this.variableNodes.forEach(function(e){a.firstMoment.set(e.output,tensor_1.Tensor.zeros(e.output.shape))}),0===this.weightedInfNorm.size()&&this.variableNodes.forEach(function(e){a.weightedInfNorm.set(e.output,tensor_1.Tensor.zeros(e.output.shape))})},e.prototype.afterBatch=function(u,e,t,d,r){var _=this;globals_1.tidy(function(){_.variableNodes.forEach(function(e){var t=d.get(e.output),r=_.variableGradients.get(e.output),o=_.firstMoment.get(e.output),s=_.weightedInfNorm.get(e.output),a=u.scaledArrayAdd(_.b1,o,u.subtract(_.one,_.b1),r),i=u.multiply(_.b2,s),p=u.abs(r),n=u.add(u.relu(u.subtract(i,p)),p),c=u.scaledArrayAdd(_.one,t,u.divideStrict(_.cGraph,u.subtract(_.one,_.accB1)),u.divide(a,u.add(_.eps,n)));d.set(e.output,globals_1.keep(c)),e.data=c,_.firstMoment.set(e.output,globals_1.keep(a)),_.weightedInfNorm.set(e.output,globals_1.keep(n)),t.dispose(),r.dispose(),o.dispose(),s.dispose()});var e=_.accB1;_.accB1=globals_1.keep(u.multiply(_.accB1,_.b1)),e.dispose()}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},e.prototype.dispose=function(){i.prototype.dispose.call(this),this.firstMoment.dispose(),this.weightedInfNorm.dispose(),this.eps.dispose(),this.accB1.dispose(),this.b1.dispose(),this.b2.dispose()},e}(optimizer_1.Optimizer);exports.AdamaxOptimizer=AdamaxOptimizer;