"use strict";var __extends=this&&this.__extends||function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(e,t){function o(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}();Object.defineProperty(exports,"__esModule",{value:!0});var globals_1=require("../../globals"),ops_1=require("../../ops/ops"),optimizer_1=require("../../optimizers/optimizer"),tensor_1=require("../../tensor"),tensor_array_map_1=require("../tensor_array_map"),AdamOptimizer=function(i){function e(e,t,o,s){var r=i.call(this,e,s)||this;return r.learningRate=e,r.beta1=t,r.beta2=o,r.firstMoment=new tensor_array_map_1.TensorArrayMap,r.secondMoment=new tensor_array_map_1.TensorArrayMap,r.eps=ops_1.scalar(1e-8),r.b1=ops_1.scalar(r.beta1),r.b2=ops_1.scalar(r.beta2),r.accB1=ops_1.scalar(r.beta1),r.accB2=ops_1.scalar(r.beta2),r.one=ops_1.scalar(1),r}return __extends(e,i),e.prototype.applyGradients=function(e){throw new Error("Adam optimizer not yet implemented for eager mode.")},e.prototype.beforeBatch=function(e,t,o,s,r){var a=this;i.prototype.beforeBatch.call(this,e,t,o,s,r),0===this.firstMoment.size()&&this.variableNodes.forEach(function(e){a.firstMoment.set(e.output,tensor_1.Tensor.zeros(e.output.shape))}),0===this.secondMoment.size()&&this.variableNodes.forEach(function(e){a.secondMoment.set(e.output,tensor_1.Tensor.zeros(e.output.shape))})},e.prototype.afterBatch=function(u,e,t,l,o){var _=this;globals_1.tidy(function(){_.variableNodes.forEach(function(e){var t=l.get(e.output),o=_.variableGradients.get(e.output),s=_.firstMoment.get(e.output),r=_.secondMoment.get(e.output),a=u.scaledArrayAdd(_.b1,s,u.subtract(_.one,_.b1),o),i=u.multiply(o,o),p=u.scaledArrayAdd(_.b2,r,u.subtract(_.one,_.b2),i),n=u.divide(a,u.subtract(_.one,_.accB1)),c=u.divide(p,u.subtract(_.one,_.accB2)),d=u.scaledArrayAdd(_.cGraph,u.divide(n,u.add(u.sqrt(c),_.eps)),_.one,t);l.set(e.output,globals_1.keep(d)),e.data=d,_.firstMoment.set(e.output,globals_1.keep(a)),_.secondMoment.set(e.output,globals_1.keep(p)),t.dispose(),o.dispose(),s.dispose(),r.dispose()});var e=_.accB1,t=_.accB2;_.accB1=globals_1.keep(u.multiply(_.accB1,_.b1)),_.accB2=globals_1.keep(u.multiply(_.accB2,_.b2)),e.dispose(),t.dispose()}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},e.prototype.dispose=function(){i.prototype.dispose.call(this),this.firstMoment.dispose(),this.secondMoment.dispose(),this.eps.dispose(),this.b1.dispose(),this.b2.dispose(),this.accB1.dispose(),this.accB2.dispose()},e}(optimizer_1.Optimizer);exports.AdamOptimizer=AdamOptimizer;