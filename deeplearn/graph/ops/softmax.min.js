"use strict";var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var e in o)o.hasOwnProperty(e)&&(t[e]=o[e])};return function(t,o){function e(){this.constructor=t}r(t,o),t.prototype=null===o?Object.create(o):(e.prototype=o.prototype,new e)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),globals_1=require("../../globals"),tensor_1=require("../../tensor"),util=require("../../util"),graph_1=require("../graph"),graph_util=require("../graph_util"),op_1=require("./op"),Softmax=function(r){function t(t,o){var e=r.call(this)||this;return e.logitsTensor=t,e.output=o,e}return __extends(t,r),t.prototype.feedForward=function(t,o){var e=this,r=o.get(this.logitsTensor);return globals_1.tidy(function(){o.set(e.output,globals_1.keep(t.softmax(r)))})},t.prototype.backProp=function(o,t,e){var r=this,s=t.get(this.output),n=e.get(this.output);globals_1.tidy(function(){var t;graph_util.shouldBackProp(r.logitsTensor)&&(t=o.elementWiseMul(o.subtract(n,o.sum(o.elementWiseMul(n,s))),s),e.add(r.logitsTensor,t))})},t}(op_1.Operation);exports.Softmax=Softmax;var SoftmaxCrossEntropyCost=function(s){function t(t,o,e){var r=s.call(this)||this;return r.logitsTensor=t,r.labelTensor=o,r.yTensor=e,r.softmaxTensor=new graph_1.SymbolicTensor(t.shape),r.epsilon=environment_1.ENV.math.keep(tensor_1.Scalar.new(1e-5)),r}return __extends(t,s),t.prototype.feedForward=function(o,e){var r=this,s=e.get(this.logitsTensor),n=e.get(this.labelTensor);globals_1.tidy(function(){var t=o.softmax(s);e.set(r.softmaxTensor,globals_1.keep(t)),e.set(r.yTensor,globals_1.keep(crossEntropyCost(o,t,n,r.epsilon)))})},t.prototype.backProp=function(t,o,e){var r=this,s=o.get(this.softmaxTensor),n=o.get(this.labelTensor);globals_1.tidy(function(){e.add(r.logitsTensor,t.subtract(s,n))})},t.prototype.disposeTransientArrays=function(t,o){t.disposeArray(this.softmaxTensor)},t.prototype.dispose=function(){this.epsilon.dispose()},t}(op_1.Operation);function crossEntropyCost(s,n,i,a){return util.assert(n.size===i.size,"The output and target must be the same size"),globals_1.tidy(function(){var t=s.scalarPlusArray(a,n),o=s.log(t),e=s.elementWiseMul(i,o),r=s.neg(e);return s.sum(r)})}exports.SoftmaxCrossEntropyCost=SoftmaxCrossEntropyCost,exports.crossEntropyCost=crossEntropyCost;