"use strict";var __decorate=this&&this.__decorate||function(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var E=e.length-1;0<=E;E--)(i=e[E])&&(a=(o<3?i(a):3<o?i(t,n,a):i(t,n))||a);return 3<o&&a&&Object.defineProperty(t,n,a),a};Object.defineProperty(exports,"__esModule",{value:!0});var Type,device_util=require("./device_util"),doc_1=require("./doc"),engine_1=require("./engine"),math_1=require("./math"),util=require("./util");function hasExtension(e,t){return null!=e.getExtension(t)}function getWebGLRenderingContext(e){if(0===e)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var t=document.createElement("canvas");return 1===e?t.getContext("webgl")||t.getContext("experimental-webgl"):t.getContext("webgl2")}function loseContext(e){if(null!=e){var t=e.getExtension("WEBGL_lose_context");if(null==t)throw new Error("Extension WEBGL_lose_context not supported on this browser.");t.loseContext()}}function isWebGLVersionEnabled(e){var t=getWebGLRenderingContext(e);return null!=t&&(loseContext(t),!0)}function getWebGLDisjointQueryTimerVersion(e){if(0===e)return 0;var t=getWebGLRenderingContext(e),n=hasExtension(t,"EXT_disjoint_timer_query_webgl2")&&2===e?2:hasExtension(t,"EXT_disjoint_timer_query")?1:0;return null!=t&&loseContext(t),n}function isFloatTextureReadPixelsEnabled(e){if(0===e)return!1;var t=getWebGLRenderingContext(e);if(1===e){if(!hasExtension(t,"OES_texture_float"))return!1}else if(!hasExtension(t,"EXT_color_buffer_float"))return!1;var n=t.createFramebuffer(),r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);var i=2===e?t.RGBA32F:t.RGBA;t.texImage2D(t.TEXTURE_2D,0,i,1,1,0,t.RGBA,t.FLOAT,null),t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);var o=t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE;t.readPixels(0,0,1,1,t.RGBA,t.FLOAT,new Float32Array(4));var a=t.getError()===t.NO_ERROR;return loseContext(t),o&&a}function isWebGLGetBufferSubDataAsyncExtensionEnabled(e){if(2!==e)return!1;var t=getWebGLRenderingContext(e),n=hasExtension(t,"WEBGL_get_buffer_sub_data_async");return loseContext(t),n}!function(e){e[e.NUMBER=0]="NUMBER",e[e.BOOLEAN=1]="BOOLEAN",e[e.STRING=2]="STRING"}(Type=exports.Type||(exports.Type={})),exports.URL_PROPERTIES=[{name:"DEBUG",type:Type.BOOLEAN},{name:"WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",type:Type.NUMBER},{name:"WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",type:Type.BOOLEAN},{name:"WEBGL_VERSION",type:Type.NUMBER},{name:"WEBGL_FLOAT_TEXTURE_ENABLED",type:Type.BOOLEAN},{name:"WEBGL_GET_BUFFER_SUB_DATA_ASYNC_EXTENSION_ENABLED",type:Type.BOOLEAN},{name:"BACKEND",type:Type.STRING}];var SUPPORTED_BACKENDS=["webgl","cpu"],Environment=function(){function e(e){this.features={},this.BACKEND_REGISTRY={},this.backends=this.BACKEND_REGISTRY,null!=e&&(this.features=e),this.get("DEBUG")&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}return e.setBackend=function(e,t){if(void 0===t&&(t=!1),!(e in exports.ENV.backends))throw new Error("Backend type '"+e+"' not found in registry");exports.ENV.globalMath=new math_1.NDArrayMath(e,t)},e.getBackend=function(){return exports.ENV.initEngine(),exports.ENV.currentBackendType},e.memory=function(){return exports.ENV.engine.memory()},e.prototype.get=function(e){return e in this.features||(this.features[e]=this.evaluateFeature(e)),this.features[e]},e.prototype.set=function(e,t){this.features[e]=t},e.prototype.getBestBackendType=function(){for(var e=0;e<SUPPORTED_BACKENDS.length;++e){var t=SUPPORTED_BACKENDS[e];if(t in this.backends)return t}throw new Error("No backend found in registry.")},e.prototype.evaluateFeature=function(e){if("DEBUG"===e)return!1;if("BACKEND"===e)return this.getBestBackendType();if("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"===e){var t=this.get("WEBGL_VERSION");return 0===t?0:getWebGLDisjointQueryTimerVersion(t)}if("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE"===e)return 0<this.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")&&!device_util.isMobile();if("WEBGL_VERSION"===e)return isWebGLVersionEnabled(2)?2:isWebGLVersionEnabled(1)?1:0;if("WEBGL_FLOAT_TEXTURE_ENABLED"===e)return isFloatTextureReadPixelsEnabled(this.get("WEBGL_VERSION"));if("WEBGL_GET_BUFFER_SUB_DATA_ASYNC_EXTENSION_ENABLED"===e)return isWebGLGetBufferSubDataAsyncExtensionEnabled(this.get("WEBGL_VERSION"));throw new Error("Unknown feature "+e+".")},e.prototype.setFeatures=function(e){this.reset(),this.features=e,this.backends={}},e.prototype.reset=function(){if(this.features=getFeaturesFromURL(),null!=this.globalMath&&(this.globalMath.dispose(),this.globalMath=null,this.globalEngine=null),this.backends!==this.BACKEND_REGISTRY){for(var e in this.backends)this.backends[e].dispose();this.backends=this.BACKEND_REGISTRY}},e.prototype.setMath=function(e,t,n){var r;void 0===n&&(n=!1),this.globalMath!==e&&(r=!1,"string"==typeof t?(this.currentBackendType=t,t=exports.ENV.findBackend(t)):(r=!0,this.currentBackendType="custom"),this.globalEngine=new engine_1.Engine(t,r,n),this.globalMath=e)},e.prototype.findBackend=function(e){return this.backends[e]},e.prototype.addCustomBackend=function(e,t){if(e in this.backends)throw new Error(e+" backend was already registered");try{var n=t();return this.backends[e]=n,!0}catch(e){return!1}},e.prototype.registerBackend=function(e,t){if(e in this.BACKEND_REGISTRY)throw new Error(e+" backend was already registered as global");try{var n=t();return this.BACKEND_REGISTRY[e]=n,!0}catch(e){return!1}},Object.defineProperty(e.prototype,"math",{get:function(){return this.initEngine(),this.globalMath},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"engine",{get:function(){return this.initEngine(),this.globalEngine},enumerable:!0,configurable:!0}),e.prototype.initEngine=function(){null==this.globalEngine&&(this.globalMath=new math_1.NDArrayMath(exports.ENV.get("BACKEND"),!1))},__decorate([doc_1.doc({heading:"Environment"})],e,"setBackend",null),__decorate([doc_1.doc({heading:"Environment"})],e,"getBackend",null),__decorate([doc_1.doc({heading:"Performance",subheading:"Memory"})],e,"memory",null),e}();exports.Environment=Environment;var DEEPLEARNJS_FLAGS_PREFIX="dljsflags";function getFeaturesFromURL(){var t={};if("undefined"==typeof window)return t;var i,e=util.getQueryParams(window.location.search);return DEEPLEARNJS_FLAGS_PREFIX in e&&(i={},e[DEEPLEARNJS_FLAGS_PREFIX].split(",").forEach(function(e){var t=e.split(":"),n=t[0],r=t[1];i[n]=r}),exports.URL_PROPERTIES.forEach(function(e){e.name in i&&(console.log("Setting feature override from URL "+e.name+": "+i[e.name]),e.type===Type.NUMBER?t[e.name]=+i[e.name]:e.type===Type.BOOLEAN?t[e.name]="true"===i[e.name]:e.type===Type.STRING?t[e.name]=i[e.name]:console.warn("Unknown URL param: "+e.name+"."))})),t}function getGlobalNamespace(){var e;if("undefined"!=typeof window)e=window;else{if("undefined"==typeof global)throw new Error("Could not find a global object");e=global}return e}function getOrMakeEnvironment(){var e=getGlobalNamespace();return e.ENV=e.ENV||new Environment(getFeaturesFromURL()),e.ENV}exports.ENV=getOrMakeEnvironment();