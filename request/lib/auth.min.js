"use strict";var caseless=require("caseless"),uuid=require("uuid/v4"),helpers=require("./helpers"),md5=helpers.md5,toBase64=helpers.toBase64;function Auth(e){this.request=e,this.hasAuth=!1,this.sentAuth=!1,this.bearerToken=null,this.user=null,this.pass=null}Auth.prototype.basic=function(e,r,t){var s=this;if(("string"!=typeof e||void 0!==r&&"string"!=typeof r)&&s.request.emit("error",new Error("auth() received invalid user or password")),s.user=e,s.pass=r,s.hasAuth=!0,t||void 0===t){var a="Basic "+toBase64(e+":"+(r||""));return s.sentAuth=!0,a}},Auth.prototype.bearer=function(e,r){var t=this;if(t.bearerToken=e,t.hasAuth=!0,r||void 0===r){"function"==typeof e&&(e=e());var s="Bearer "+(e||"");return t.sentAuth=!0,s}},Auth.prototype.digest=function(e,r,t){for(var s=this,a={},u=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/gi;;){var o=u.exec(t);if(!o)break;a[o[1]]=o[2]||o[3]}var i,n,h,p,c,d,l,v=/(^|,)\s*auth\s*($|,)/.test(a.qop)&&"auth",m=v&&"00000001",f=v&&uuid().replace(/-/g,""),A=(i=a.algorithm,n=s.user,h=a.realm,p=s.pass,c=a.nonce,d=f,l=md5(n+":"+h+":"+p),i&&"md5-sess"===i.toLowerCase()?md5(l+":"+c+":"+d):l),g=md5(e+":"+r),q=md5(v?A+":"+a.nonce+":"+m+":"+f+":"+v+":"+g:A+":"+a.nonce+":"+g),b={username:s.user,realm:a.realm,nonce:a.nonce,uri:r,qop:v,response:q,nc:m,cnonce:f,algorithm:a.algorithm,opaque:a.opaque};for(var w in t=[],b)b[w]&&("qop"===w||"nc"===w||"algorithm"===w?t.push(w+"="+b[w]):t.push(w+'="'+b[w]+'"'));return t="Digest "+t.join(", "),s.sentAuth=!0,t},Auth.prototype.onRequest=function(e,r,t,s){var a,u=this,o=u.request;void 0===s&&void 0===e?u.request.emit("error",new Error("no auth mechanism defined")):a=void 0!==s?u.bearer(s,t):u.basic(e,r,t),a&&o.setHeader("authorization",a)},Auth.prototype.onResponse=function(e){var r=this,t=r.request;if(!r.hasAuth||r.sentAuth)return null;var s=caseless(e.headers).get("www-authenticate"),a=s&&s.split(" ")[0].toLowerCase();switch(t.debug("reauth",a),a){case"basic":return r.basic(r.user,r.pass,!0);case"bearer":return r.bearer(r.bearerToken,!0);case"digest":return r.digest(t.method,t.path,s)}},exports.Auth=Auth;