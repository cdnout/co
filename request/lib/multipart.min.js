"use strict";var uuid=require("uuid/v4"),CombinedStream=require("combined-stream"),isstream=require("isstream"),Buffer=require("safe-buffer").Buffer;function Multipart(e){this.request=e,this.boundary=uuid(),this.chunked=!1,this.body=null}Multipart.prototype.isChunked=function(e){var r=this,t=!1,n=e.data||e;return n.forEach||r.request.emit("error",new Error("Argument error, options.multipart.")),void 0!==e.chunked&&(t=e.chunked),"chunked"===r.request.getHeader("transfer-encoding")&&(t=!0),t||n.forEach(function(e){void 0===e.body&&r.request.emit("error",new Error("Body attribute missing in multipart.")),isstream(e.body)&&(t=!0)}),t},Multipart.prototype.setHeaders=function(e){var r=this;e&&!r.request.hasHeader("transfer-encoding")&&r.request.setHeader("transfer-encoding","chunked");var t=r.request.getHeader("content-type");t&&-1!==t.indexOf("multipart")?-1!==t.indexOf("boundary")?r.boundary=t.replace(/.*boundary=([^\s;]+).*/,"$1"):r.request.setHeader("content-type",t+"; boundary="+r.boundary):r.request.setHeader("content-type","multipart/related; boundary="+r.boundary)},Multipart.prototype.build=function(e,r){var n=this,t=r?new CombinedStream:[];function u(e){return"number"==typeof e&&(e=e.toString()),r?t.append(e):t.push(Buffer.from(e))}return n.request.preambleCRLF&&u("\r\n"),e.forEach(function(r){var t="--"+n.boundary+"\r\n";Object.keys(r).forEach(function(e){"body"!==e&&(t+=e+": "+r[e]+"\r\n")}),u(t+="\r\n"),u(r.body),u("\r\n")}),u("--"+n.boundary+"--"),n.request.postambleCRLF&&u("\r\n"),t},Multipart.prototype.onRequest=function(e){var r=this,t=r.isChunked(e),n=e.data||e;r.setHeaders(t),r.chunked=t,r.body=r.build(n,t)},exports.Multipart=Multipart;