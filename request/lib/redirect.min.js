"use strict";var url=require("url"),isUrl=/^https?:/;function Redirect(e){this.request=e,this.followRedirect=!0,this.followRedirects=!0,this.followAllRedirects=!1,this.followOriginalHttpMethod=!1,this.allowRedirect=function(){return!0},this.maxRedirects=10,this.redirects=[],this.redirectsFollowed=0,this.removeRefererHeader=!1}Redirect.prototype.onRequest=function(e){var r=this;void 0!==e.maxRedirects&&(r.maxRedirects=e.maxRedirects),"function"==typeof e.followRedirect&&(r.allowRedirect=e.followRedirect),void 0!==e.followRedirect&&(r.followRedirects=!!e.followRedirect),void 0!==e.followAllRedirects&&(r.followAllRedirects=e.followAllRedirects),(r.followRedirects||r.followAllRedirects)&&(r.redirects=r.redirects||[]),void 0!==e.removeRefererHeader&&(r.removeRefererHeader=e.removeRefererHeader),void 0!==e.followOriginalHttpMethod&&(r.followOriginalHttpMethod=e.followOriginalHttpMethod)},Redirect.prototype.redirectTo=function(e){var r=this,t=r.request,o=null;if(300<=e.statusCode&&e.statusCode<400&&e.caseless.has("location")){var i=e.caseless.get("location");if(t.debug("redirect",i),r.followAllRedirects)o=i;else if(r.followRedirects)switch(t.method){case"PATCH":case"PUT":case"POST":case"DELETE":break;default:o=i}}else if(401===e.statusCode){var l=t._auth.onResponse(e);l&&(t.setHeader("authorization",l),o=t.uri)}return o},Redirect.prototype.onResponse=function(e){var r=this,t=r.request,o=r.redirectTo(e);if(!o||!r.allowRedirect.call(t,e))return!1;if(t.debug("redirect to",o),e.resume&&e.resume(),r.redirectsFollowed>=r.maxRedirects)return t.emit("error",new Error("Exceeded maxRedirects. Probably stuck in a redirect loop "+t.uri.href)),!1;r.redirectsFollowed+=1,isUrl.test(o)||(o=url.resolve(t.uri.href,o));var i=t.uri;return t.uri=url.parse(o),t.uri.protocol!==i.protocol&&delete t.agent,r.redirects.push({statusCode:e.statusCode,redirectUri:o}),r.followAllRedirects&&"HEAD"!==t.method&&401!==e.statusCode&&307!==e.statusCode&&(t.method=r.followOriginalHttpMethod?t.method:"GET"),delete t.src,delete t.req,delete t._started,401!==e.statusCode&&307!==e.statusCode&&(delete t.body,delete t._form,t.headers&&(t.removeHeader("host"),t.removeHeader("content-type"),t.removeHeader("content-length"),t.uri.hostname!==t.originalHost.split(":")[0]&&t.removeHeader("authorization"))),r.removeRefererHeader||t.setHeader("referer",i.href),t.emit("redirect"),t.init(),!0},exports.Redirect=Redirect;