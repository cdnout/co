"use strict";var fs=require("fs"),qs=require("querystring"),validate=require("har-validator"),extend=require("extend");function Har(e){this.request=e}Har.prototype.reducer=function(e,t){if(void 0===e[t.name])return e[t.name]=t.value,e;var a=[e[t.name],t.value];return e[t.name]=a,e},Har.prototype.prep=function(t){if(t.queryObj={},t.headersObj={},t.postData.jsonObj=!1,t.postData.paramsObj=!1,t.queryString&&t.queryString.length&&(t.queryObj=t.queryString.reduce(this.reducer,{})),t.headers&&t.headers.length&&(t.headersObj=t.headers.reduceRight(function(e,t){return e[t.name]=t.value,e},{})),t.cookies&&t.cookies.length){var e=t.cookies.map(function(e){return e.name+"="+e.value});e.length&&(t.headersObj.cookie=e.join("; "))}function a(e){return e.some(function(e){return 0===t.postData.mimeType.indexOf(e)})}if(a(["multipart/mixed","multipart/related","multipart/form-data","multipart/alternative"]))t.postData.mimeType="multipart/form-data";else if(a(["application/x-www-form-urlencoded"]))t.postData.params?(t.postData.paramsObj=t.postData.params.reduce(this.reducer,{}),t.postData.text=qs.stringify(t.postData.paramsObj)):t.postData.text="";else if(a(["text/json","text/x-json","application/json","application/x-json"])&&(t.postData.mimeType="application/json",t.postData.text))try{t.postData.jsonObj=JSON.parse(t.postData.text)}catch(e){this.request.debug(e),t.postData.mimeType="text/plain"}return t},Har.prototype.options=function(a){if(!a.har)return a;var e={};if(extend(e,a.har),e.log&&e.log.entries&&(e=e.log.entries[0]),e.url=e.url||a.url||a.uri||a.baseUrl||"/",e.httpVersion=e.httpVersion||"HTTP/1.1",e.queryString=e.queryString||[],e.headers=e.headers||[],e.cookies=e.cookies||[],e.postData=e.postData||{},e.postData.mimeType=e.postData.mimeType||"application/octet-stream",e.bodySize=0,e.headersSize=0,e.postData.size=0,!validate.request(e))return a;var t=this.prep(e);function r(e){return 0===t.postData.mimeType.indexOf(e)}return t.url&&(a.url=t.url),t.method&&(a.method=t.method),Object.keys(t.queryObj).length&&(a.qs=t.queryObj),Object.keys(t.headersObj).length&&(a.headers=t.headersObj),r("application/x-www-form-urlencoded")?a.form=t.postData.paramsObj:r("application/json")?t.postData.jsonObj&&(a.body=t.postData.jsonObj,a.json=!0):r("multipart/form-data")?(a.formData={},t.postData.params.forEach(function(e){var t={};e.fileName||e.contentType?(e.fileName&&!e.value?t.value=fs.createReadStream(e.fileName):e.value&&(t.value=e.value),e.fileName&&(t.options={filename:e.fileName,contentType:e.contentType?e.contentType:null}),a.formData[e.name]=t):a.formData[e.name]=e.value})):t.postData.text&&(a.body=t.postData.text),a},exports.Har=Har;