"use strict";var url=require("url"),tunnel=require("tunnel-agent"),defaultProxyHeaderWhiteList=["accept","accept-charset","accept-encoding","accept-language","accept-ranges","cache-control","content-encoding","content-language","content-location","content-md5","content-range","content-type","connection","date","expect","max-forwards","pragma","referer","te","user-agent","via"],defaultProxyHeaderExclusiveList=["proxy-authorization"];function constructProxyHost(e){var t=e.port,r=e.protocol,n=e.hostname+":";return n+=t||("https:"===r?"443":"80")}function constructProxyHeaderWhiteList(r,e){var t=e.reduce(function(e,t){return e[t.toLowerCase()]=!0,e},{});return Object.keys(r).filter(function(e){return t[e.toLowerCase()]}).reduce(function(e,t){return e[t]=r[t],e},{})}function constructTunnelOptions(e,t){var r=e.proxy;return{proxy:{host:r.hostname,port:+r.port,proxyAuth:r.auth,headers:t},headers:e.headers,ca:e.ca,cert:e.cert,key:e.key,passphrase:e.passphrase,pfx:e.pfx,ciphers:e.ciphers,rejectUnauthorized:e.rejectUnauthorized,secureOptions:e.secureOptions,secureProtocol:e.secureProtocol}}function constructTunnelFnName(e,t){return["https:"===e.protocol?"https":"http","https:"===t.protocol?"Https":"Http"].join("Over")}function getTunnelFn(e){var t=constructTunnelFnName(e.uri,e.proxy);return tunnel[t]}function Tunnel(e){this.request=e,this.proxyHeaderWhiteList=defaultProxyHeaderWhiteList,this.proxyHeaderExclusiveList=[],void 0!==e.tunnel&&(this.tunnelOverride=e.tunnel)}Tunnel.prototype.isEnabled=function(){var e=this,t=e.request;return void 0!==e.tunnelOverride?e.tunnelOverride:"https:"===t.uri.protocol},Tunnel.prototype.setup=function(e){var t=this,r=t.request;if(e=e||{},"string"==typeof r.proxy&&(r.proxy=url.parse(r.proxy)),!r.proxy||!r.tunnel)return!1;e.proxyHeaderWhiteList&&(t.proxyHeaderWhiteList=e.proxyHeaderWhiteList),e.proxyHeaderExclusiveList&&(t.proxyHeaderExclusiveList=e.proxyHeaderExclusiveList);var n=t.proxyHeaderExclusiveList.concat(defaultProxyHeaderExclusiveList),o=t.proxyHeaderWhiteList.concat(n),u=constructProxyHeaderWhiteList(r.headers,o);u.host=constructProxyHost(r.uri),n.forEach(r.removeHeader,r);var s=getTunnelFn(r),c=constructTunnelOptions(r,u);return r.agent=s(c),!0},Tunnel.defaultProxyHeaderWhiteList=defaultProxyHeaderWhiteList,Tunnel.defaultProxyHeaderExclusiveList=defaultProxyHeaderExclusiveList,exports.Tunnel=Tunnel;