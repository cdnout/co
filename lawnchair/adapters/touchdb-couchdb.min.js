Lawnchair.adapter("touchdb-couchdb",function(){function a(t,n){var i,o,r,e=[];if(n){if($.isArray(n)){if("object"==typeof n[n.length-1]){for(i in o=n[n.length-1],n=n.slice(0,n.length-1),o)v=-1!==["startkey","endkey","start_key","end_key","key"].indexOf(i)?JSON.stringify(o[i]):o[i],e.push(encodeURIComponent(i)+"="+encodeURIComponent(v.toString()));e=e.join("&")}return r=n.map(encodeURIComponent).join("/"),e.toString()&&(r=r+"?"+e.toString()),t+"/"+r}return t+"/"+n}return t}function r(o,r,e){JSON.stringify(r),o.post("_all_docs",{keys:r.map(function(t){return t._id})},function(t,n){if(t)return e(t);for(var i=0;i<n.rows.length;i++)n.rows[i].value&&(r[i]._rev=n.rows[i].value.rev);o.post("_bulk_docs",{docs:r},function(t,n){if(t)return e(t);for(var i=0;i<n.length;i++)r[i]._rev=n[i].rev;e(null,r)})})}return{valid:function(){return!(!$||"function"!=typeof $.ajax)||(console.log("touchdb-couchdb Lawnchair adapter requires Zepto or jQuery for $.ajax()"),!1)},init:function(t,i){var n,o=this;function r(){var o,t={contentType:"application/json",type:this};return"function"==typeof arguments[0]?(o=arguments[0],t.url=a(n)):"function"==typeof arguments[1]?(o=arguments[1],t.url=a(n,arguments[0])):(o=arguments[2],t.url=a(n,arguments[0]),t.data=JSON.stringify(arguments[1])),t.complete=function(n,t){var i;try{i=JSON.parse(n.responseText)}catch(t){i=n.responseText}400<=n.status?i.error?o(i,n):o(n.status,i,n):o(null,i)},$.ajax(t)}function e(){return r.apply("GET",arguments)}return this.name=t.name,this.db=(n=this.name,n="file:"===location.protocol?(console.log("file:// url, so assume TouchDB-iOS is whitelisted at http://localhost.touchdb./"),"http://localhost.touchdb./"+n):(console.log("assume CouchDB is reachable at "+location.origin),"/"+n),"get put post head del".split(" ").forEach(function(n){e[n]=function(){var t="del"==n?"DELETE":n.toUpperCase();return r.apply(t,arguments)}}),e),this.db.put(function(t,n){if(t&&"file_exists"!==t.error)throw t;o.fn(o.name,i).call(o,o)}),this},keys:function(o){var r=this;return this.db("_all_docs",function(t,n){var i=[];!t&&n.rows&&(i=n.rows.map(function(t){return t.id})),r.fn("keys",o).call(this,i)}),this},save:function(n,i){n._id=n.key=n.key||this.uuid();var o=this;return r(o.db,[n],function(t){if(t)throw t;i&&o.lambda(i).call(o,n)}),this},batch:function(n,i){var o=this;return n=n.map(function(t){return t._id=t.key=t.key||o.uuid(),t}),r(o.db,n,function(t){if(t)throw t;i&&o.lambda(i).call(o,n)}),this},get:function(o,r){var e=this,t=this.isArray(o)?o:[o];return this.db.post(["_all_docs",{include_docs:!0}],{keys:t},function(t,n){if(t)throw t;var i=[];n.rows.forEach(function(t){i.push(t.doc||null)}),r&&(e.isArray(o)?e.lambda(r).call(e,i):e.lambda(r).call(e,i[0]))}),this},exists:function(t,n){return this.get(t,function(t){this.lambda(n).call(this,!!t)}),this},all:function(o){var r=this;return this.db(["_all_docs",{include_docs:!0}],function(t,n){var i=[];!t&&n.rows&&(i=n.rows.map(function(t){return t.doc})),r.fn(r.name,o).call(r,i)}),this},remove:function(t,n){var i=this.isArray(t)?t:[t],o=this,i=i.map(function(t){return{_id:t.key||t,_deleted:!0}});return r(this.db,i,function(t){if(t)throw t;n&&o.lambda(n).call(o)}),this},nuke:function(i){var o=this;return this.db.del(function(t,n){if(t)throw t;o.db.put(function(t,n){if(t&&"file_exists"!=t.error)throw t;i&&o.lambda(i).call(o)})}),this}}}());