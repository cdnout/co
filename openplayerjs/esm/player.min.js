import"core-js/features/array/find";import"core-js/features/array/from";import"core-js/features/object/assign";import"core-js/features/object/keys";import"core-js/features/promise";import"custom-event-polyfill";import"element-closest/browser";import Controls from"./controls";import Media from"./media";import Ads from"./media/ads";import{EVENT_OPTIONS,IS_ANDROID,IS_IOS,IS_IPHONE}from"./utils/constants";import{addEvent}from"./utils/events";import{isAudio,isVideo,removeElement}from"./utils/general";import{isAutoplaySupported}from"./utils/media";class Player{constructor(t,e){return this.uid="",this.events={},this.autoplay=!1,this.volume=1,this.canAutoplay=!1,this.canAutoplayMuted=!1,this.processedAutoplay=!1,this.options={},this.customControlItems=[],this.defaultOptions={controls:{alwaysVisible:!1,layers:{left:["play","time","volume"],middle:["progress"],right:["captions","settings","fullscreen"]}},defaultLevel:null,detachMenus:!1,forceNative:!0,height:0,hidePlayBtnTimer:350,labels:{auto:"Auto",captions:"CC/Subtitles",click:"Click to unmute",fullscreen:"Fullscreen",lang:{en:"English"},levels:"Quality Levels",live:"Live Broadcast",mediaLevels:"Change Quality",mute:"Mute",off:"Off",pause:"Pause",play:"Play",progressRail:"Time Rail",progressSlider:"Time Slider",settings:"Player Settings",speed:"Speed",speedNormal:"Normal",tap:"Tap to unmute",toggleCaptions:"Toggle Captions",unmute:"Unmute",volume:"Volume",volumeControl:"Volume Control",volumeSlider:"Volume Slider"},live:{showLabel:!0,showProgress:!1},mode:"responsive",onError:()=>{},progress:{duration:0},showLoaderOnInit:!1,startTime:0,startVolume:1,step:0,width:0},this.element=t instanceof HTMLMediaElement?t:document.getElementById(t),this.element&&(this.autoplay=this.element.autoplay||!1,"string"==typeof e||Array.isArray(e)||this._mergeOptions(e),this.element.volume=this.options.startVolume,this.options.ads&&this.options.ads.src&&(this.ads=this.options.ads.src),this.options.startTime>0&&(this.element.currentTime=this.options.startTime),this.volume=this.element.volume),this}static init(){Player.instances={};const t=document.querySelectorAll("video.op-player, audio.op-player");for(let e=0,s=t.length;e<s;e++){const s=t[e],i=s.getAttribute("data-op-settings"),a=i?JSON.parse(i):{};new Player(s,a).init()}}static addMedia(t,e,s,i){Player.customMedia.media[e]=i,Player.customMedia.optionsKey[e]=t,Player.customMedia.rules.push(s)}init(){this._isValid()&&(this._wrapInstance(),this._prepareMedia(),this._createPlayButton(),this._createUID(),this._createControls(),this._setEvents(),Player.instances[this.id]=this)}load(){this.isMedia()&&this.media.load()}play(){return this.media&&!this.media.loaded&&(this.media.load(),this.media.loaded=!0),this.adsInstance?this.adsInstance.play():this.media.play()}pause(){this.adsInstance?this.adsInstance.pause():this.media.pause()}destroy(){this.adsInstance&&(this.adsInstance.pause(),this.adsInstance.destroy());const t=this.element;this.media.destroy(),Object.keys(this.events).forEach(e=>{t.removeEventListener(e,this.events[e])}),this.autoplay&&!this.processedAutoplay&&isVideo(this.element)&&t.removeEventListener("canplay",this._autoplay.bind(this)),this.controls.destroy(),isVideo(this.element)&&(removeElement(this.playBtn),removeElement(this.loader)),t.controls=!0,t.setAttribute("id",this.uid),t.removeAttribute("op-live__enabled"),t.removeAttribute("op-dvr__enabled");const e=t.parentElement;e&&e.parentNode&&e.parentNode.replaceChild(t,e);const s=addEvent("playerdestroyed");t.dispatchEvent(s)}getContainer(){return this.element.parentElement||this.element}getControls(){return this.controls}getCustomControls(){return this.customControlItems}getElement(){return this.element}getEvents(){return this.events}getOptions(){return this.options}activeElement(){return this.adsInstance&&this.adsInstance.adsStarted?this.adsInstance:this.media}isMedia(){return this.activeElement()instanceof Media}isAd(){return this.activeElement()instanceof Ads}getMedia(){return this.media}getAd(){return this.adsInstance}addCaptions(t){if(t.default){const t=this.element.querySelectorAll("track");for(let e=0,s=t.length;e<s;e++)t[e].default=!1}const e=this.element;let s=e.querySelector(`track[srclang="${t.srclang}"][kind="${t.kind}"]`);s?(s.src=t.src,s.label=t.label,s.default=t.default||!1):((s=document.createElement("track")).srclang=t.srclang,s.src=t.src,s.kind=t.kind,s.label=t.label,s.default=t.default||!1,e.appendChild(s));const i=addEvent("controlschanged");e.dispatchEvent(i)}addControl(t){t.custom=!0,this.customControlItems.push(t);const e=addEvent("controlschanged");this.element.dispatchEvent(e)}removeControl(t){const{layers:e}=this.getOptions().controls;Object.keys(e).forEach(s=>{e[s].forEach((i,a)=>{i===t&&e[s].splice(a,1)})}),this.customControlItems.forEach((e,s)=>{e.id===t&&this.customControlItems.splice(s,1)});const s=addEvent("controlschanged");this.element.dispatchEvent(s)}_prepareMedia(){try{this.element.addEventListener("playererror",this.options.onError,EVENT_OPTIONS),this.autoplay&&isVideo(this.element)&&this.element.addEventListener("canplay",this._autoplay.bind(this),EVENT_OPTIONS),this.media=new Media(this.element,this.options,this.autoplay,Player.customMedia);const t=this.element.getAttribute("preload");if(!this.ads&&t&&"none"===t||(this.media.load(),this.media.loaded=!0),!this.autoplay&&this.ads){const t=this.options&&this.options.ads?this.options.ads:void 0;this.adsInstance=new Ads(this,this.ads,!1,!1,t)}}catch(t){console.error(t)}}set src(t){this.media instanceof Media&&(this.media.mediaFiles=[],this.media.src=t)}get src(){return this.media.src}get id(){return this.uid}_isValid(){const t=this.element;return t instanceof HTMLElement!=!1&&(!(!isAudio(t)&&!isVideo(t))&&!!t.classList.contains("op-player__media"))}_wrapInstance(){const t=document.createElement("div");if(t.className="op-player op-player__keyboard--inactive",t.className+=isAudio(this.element)?" op-player__audio":" op-player__video",t.tabIndex=0,this.element.classList.remove("op-player"),this.element.parentElement&&this.element.parentElement.insertBefore(t,this.element),t.appendChild(this.element),t.addEventListener("keydown",()=>{t.classList.contains("op-player__keyboard--inactive")&&t.classList.remove("op-player__keyboard--inactive")},EVENT_OPTIONS),t.addEventListener("click",()=>{t.classList.contains("op-player__keyboard--inactive")||t.classList.add("op-player__keyboard--inactive")},EVENT_OPTIONS),"fill"!==this.options.mode||isAudio(this.element)||IS_IPHONE)if("fit"!==this.options.mode||isAudio(this.element)){let e="";if(this.options.width){e+=`width: ${"number"==typeof this.options.width?`${this.options.width}px`:this.options.width} !important;`}if(this.options.height){e+=`height: ${"number"==typeof this.options.height?`${this.options.height}px`:this.options.height} !important;`}e&&t.setAttribute("style",e)}else{const t=this.getContainer();if(t.parentElement){const e=document.createElement("div");e.className="op-player__fit--wrapper",e.tabIndex=0,t.parentElement.insertBefore(e,t),e.appendChild(t),t.classList.add("op-player__fit")}}else this.getContainer().classList.add("op-player__full")}_createControls(){IS_IPHONE&&isVideo(this.element)&&this.getContainer().classList.add("op-player__ios--iphone"),this.controls=new Controls(this),this.controls.create()}_createUID(){if(this.element.id)this.uid=this.element.id,this.element.removeAttribute("id");else{let t;do{t=`op_${Math.random().toString(36).substr(2,9)}`}while(void 0!==Player.instances[t]);this.uid=t}this.element.parentElement&&(this.element.parentElement.id=this.uid)}_createPlayButton(){isAudio(this.element)||(this.playBtn=document.createElement("button"),this.playBtn.className="op-player__play",this.playBtn.tabIndex=0,this.playBtn.title=this.options.labels.play,this.playBtn.innerHTML=`<span>${this.options.labels.play}</span>`,this.playBtn.setAttribute("aria-pressed","false"),this.playBtn.setAttribute("aria-hidden","false"),this.loader=document.createElement("span"),this.loader.className="op-player__loader",this.loader.tabIndex=-1,this.loader.setAttribute("aria-hidden","true"),this.element.parentElement&&(this.element.parentElement.insertBefore(this.loader,this.element),this.element.parentElement.insertBefore(this.playBtn,this.element)),this.playBtn.addEventListener("click",()=>{this.adsInstance&&(this.adsInstance.playRequested=this.activeElement().paused),this.activeElement().paused?this.activeElement().play():this.activeElement().pause()},EVENT_OPTIONS))}_setEvents(){isVideo(this.element)&&(this.events.loadedmetadata=(()=>{const t=this.activeElement();!this.options.showLoaderOnInit||IS_IOS||IS_ANDROID?(this.loader.setAttribute("aria-hidden","true"),this.playBtn.setAttribute("aria-hidden","false")):(this.loader.setAttribute("aria-hidden","false"),this.playBtn.setAttribute("aria-hidden","true")),t.paused&&(this.playBtn.classList.remove("op-player__play--paused"),this.playBtn.setAttribute("aria-pressed","false"))}),this.events.waiting=(()=>{this.playBtn.setAttribute("aria-hidden","true"),this.loader.setAttribute("aria-hidden","false")}),this.events.seeking=(()=>{const t=this.activeElement();this.playBtn.setAttribute("aria-hidden","true"),this.loader.setAttribute("aria-hidden",t instanceof Media?"false":"true")}),this.events.seeked=(()=>{const t=this.activeElement();0===Math.round(t.currentTime)?(this.playBtn.setAttribute("aria-hidden","true"),this.loader.setAttribute("aria-hidden","false")):(this.playBtn.setAttribute("aria-hidden",t instanceof Media?"false":"true"),this.loader.setAttribute("aria-hidden","true"))}),this.events.play=(()=>{this.playBtn.classList.add("op-player__play--paused"),this.playBtn.title=this.options.labels.pause,this.loader.setAttribute("aria-hidden","true"),this.options.showLoaderOnInit?this.playBtn.setAttribute("aria-hidden","true"):setTimeout(()=>{this.playBtn.setAttribute("aria-hidden","true")},this.options.hidePlayBtnTimer)}),this.events.playing=(()=>{this.loader.setAttribute("aria-hidden","true"),this.playBtn.setAttribute("aria-hidden","true")}),this.events.pause=(()=>{const t=this.activeElement();this.playBtn.classList.remove("op-player__play--paused"),this.playBtn.title=this.options.labels.play,this.options.showLoaderOnInit&&0===Math.round(t.currentTime)?(this.playBtn.setAttribute("aria-hidden","true"),this.loader.setAttribute("aria-hidden","false")):(this.playBtn.setAttribute("aria-hidden","false"),this.loader.setAttribute("aria-hidden","true"))}),this.events.ended=(()=>{this.loader.setAttribute("aria-hidden","true"),this.playBtn.setAttribute("aria-hidden","true")})),Object.keys(this.events).forEach(t=>{this.element.addEventListener(t,this.events[t],EVENT_OPTIONS)})}_autoplay(){this.processedAutoplay||(this.processedAutoplay=!0,this.element.removeEventListener("canplay",this._autoplay.bind(this)),isAutoplaySupported(this.element,t=>{this.canAutoplay=t},t=>{this.canAutoplayMuted=t},()=>{if(this.canAutoplayMuted){this.activeElement().muted=!0,this.activeElement().volume=0;const t=addEvent("volumechange");this.element.dispatchEvent(t);const e=document.createElement("div"),s=IS_IOS||IS_ANDROID?this.options.labels.tap:this.options.labels.click;e.className="op-player__unmute",e.innerHTML=`<span>${s}</span>`,e.tabIndex=0,e.addEventListener("click",()=>{this.activeElement().muted=!1,this.activeElement().volume=this.volume;const t=addEvent("volumechange");this.element.dispatchEvent(t),removeElement(e)},EVENT_OPTIONS);const i=this.getContainer();i.insertBefore(e,i.firstChild)}else this.activeElement().muted=this.element.muted,this.activeElement().volume=this.volume;if(this.ads){const t=this.options&&this.options.ads?this.options.ads:void 0;this.adsInstance=new Ads(this,this.ads,this.canAutoplay,this.canAutoplayMuted,t)}else if(this.canAutoplay||this.canAutoplayMuted)return this.play()}))}_mergeOptions(t){if(this.options=Object.assign(Object.assign({},this.defaultOptions),t),t){["labels","controls"].forEach(e=>{this.options[e]=t[e]&&Object.keys(t[e]).length?Object.assign(Object.assign({},this.defaultOptions[e]),t[e]):this.defaultOptions[e]})}}}Player.instances={},Player.customMedia={media:{},optionsKey:{},rules:[]};export default Player;"undefined"!=typeof window&&(window.OpenPlayer=Player,window.OpenPlayerJS=Player,Player.init());