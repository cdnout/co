import DashMedia from"./media/dash";import FlvMedia from"./media/flv";import HlsMedia from"./media/hls";import HTML5Media from"./media/html5";import*as source from"./utils/media";class Media{constructor(e,t,i=!1,s){return this.mediaLoaded=!1,this.customMedia={media:{},optionsKey:{},rules:[]},this.element=e,this.options=t,this.mediaFiles=this._getMediaFiles(),this.customMedia=s,this.autoplay=i,this}canPlayType(e){return this.media.canPlayType(e)}load(){if(!this.mediaFiles.length)throw new TypeError("Media not set");if(this.media&&"function"==typeof this.media.destroy){1===this.mediaFiles.length&&this.mediaFiles[0].src===this.media.media.src||this.media.destroy()}this.mediaFiles.some(e=>{try{this.media=this._invoke(e)}catch(t){this.media=new HTML5Media(this.element,e)}return this.media.canPlayType(e.type)});try{if(null===this.media)throw new TypeError("Media cannot be played with any valid media type");return this.media.promise.then(()=>{this.media.load()})}catch(e){throw this.media.destroy(),e}}play(){if(!this.loaded){this.loaded=!0;const e=this.load();if(e)return this.loaded=!0,e.then(()=>{this.media.play()})}return this.promisePlay=new Promise(e=>{e({})}).then(this.media.promise.then(this.media.play())),this.promisePlay}pause(){void 0!==this.promisePlay?this.promisePlay.then(()=>{this.media.pause()}):this.media.pause()}destroy(){this.media.destroy()}set src(e){"string"==typeof e?this.mediaFiles.push({src:e,type:source.predictType(e)}):Array.isArray(e)?this.mediaFiles=e:"object"==typeof e&&this.mediaFiles.push(e),this.mediaFiles.some(e=>this.canPlayType(e.type)),this.element.src&&this.element.setAttribute("data-op-file",this.mediaFiles[0].src),this.element.src=this.mediaFiles[0].src,this.media.src=this.mediaFiles[0]}get src(){return this.mediaFiles}set volume(e){this.media&&(this.media.volume=e)}get volume(){return this.media?this.media.volume:this.element.volume}set muted(e){this.media&&(this.media.muted=e)}get muted(){return this.media?this.media.muted:this.element.muted}set playbackRate(e){this.media&&(this.media.playbackRate=e)}get playbackRate(){return this.media?this.media.playbackRate:this.element.playbackRate}set defaultPlaybackRate(e){this.media&&(this.media.defaultPlaybackRate=e)}get defaultPlaybackRate(){return this.media?this.media.defaultPlaybackRate:this.element.defaultPlaybackRate}set currentTime(e){this.media&&(this.media.currentTime=e)}get currentTime(){return this.media?this.media.currentTime:this.element.currentTime}get duration(){const e=this.media?this.media.duration:this.element.duration;return e===1/0&&this.element.seekable&&this.element.seekable.length?this.element.seekable.end(0):e}get paused(){return this.media?this.media.paused:this.element.paused}get ended(){return this.media?this.media.ended:this.element.ended}set loaded(e){this.mediaLoaded=e}get loaded(){return this.mediaLoaded}set level(e){this.media&&(this.media.level=e)}get level(){return this.media?this.media.level:-1}get levels(){return this.media?this.media.levels:[]}get instance(){return this.media?this.media.instance:null}_getMediaFiles(){const e=[],t=this.element.querySelectorAll("source"),i=this.element.src;i&&e.push({src:i,type:this.element.getAttribute("type")||source.predictType(i)});for(let i=0,s=t.length;i<s;i++){const s=t[i],a=s.src;e.push({src:a,type:s.getAttribute("type")||source.predictType(a)})}return e.length||e.push({src:"",type:source.predictType("")}),e}_invoke(e){const t=this.element.canPlayType("application/vnd.apple.mpegurl")||this.element.canPlayType("application/x-mpegURL");let i=!1;if(Object.keys(this.options.controls.layers).forEach(e=>{this.options.controls.layers[e].indexOf("levels")>-1&&(i=!0)}),Object.keys(this.customMedia.media).length){let t;return this.customMedia.rules.forEach(i=>{const s=i(e.src);if(s){const i=this.customMedia.media[s],a=this.options[this.customMedia.optionsKey[s]]||void 0;t=i(this.element,e,this.autoplay,a)}}),t?(t.create(),t):new HTML5Media(this.element,e)}if(source.isHlsSource(e)){if(t&&this.options.forceNative&&!i)return new HTML5Media(this.element,e);const s=this.options&&this.options.hls?this.options.hls:void 0;return new HlsMedia(this.element,e,this.autoplay,s)}if(source.isDashSource(e)){const t=this.options&&this.options.dash?this.options.dash:void 0;return new DashMedia(this.element,e,t)}if(source.isFlvSource(e)){const t=this.options&&this.options.flv?this.options.flv:{debug:!1,type:"flv",url:e.src};return new FlvMedia(this.element,e,t)}return new HTML5Media(this.element,e)}}export default Media;