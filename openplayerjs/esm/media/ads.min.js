import{EVENT_OPTIONS,IS_ANDROID,IS_IOS,IS_IPHONE}from"../utils/constants";import{addEvent}from"../utils/events";import{isVideo,isXml,loadScript,removeElement}from"../utils/general";class Ads{constructor(e,t,s,i,a){this.adsEnded=!1,this.adsDone=!1,this.adsActive=!1,this.adsStarted=!1,this.intervalTimer=0,this.adsMuted=!1,this.adsDuration=0,this.adsCurrentTime=0,this.adsManager=null,this.events=[],this.autoStart=!1,this.autoStartMuted=!1,this.playTriggered=!1,this.currentAdsIndex=0,this.lastTimePaused=0,this.mediaSources=[],this.mediaStarted=!1;this.player=e,this.ads=t,this.media=e.getMedia(),this.element=e.getElement(),this.autoStart=s||!1,this.autoStartMuted=i||!1,this.adsOptions=Object.assign(Object.assign({},{autoPlayAdBreaks:!0,debug:!1,enablePreloading:!1,language:"en",loop:!1,numRedirects:4,sdkPath:"https://imasdk.googleapis.com/js/sdkloader/ima3.js",src:[]}),a),this.playTriggered=!1,this.originalVolume=this.element.volume,this.adsVolume=this.originalVolume;const d=this.adsOptions.debug?this.adsOptions.sdkPath.replace(/(\.js$)/,"_debug.js"):this.adsOptions.sdkPath;return this.promise="undefined"==typeof google||void 0===google.ima?loadScript(d):new Promise(e=>{e({})}),this.promise.then(this.load.bind(this)),this}load(e=!1){if(!this.adsOptions.autoPlayAdBreaks&&!e)return;const t=this.player.getContainer().querySelector(".op-ads");t&&t.parentNode&&t.parentNode.removeChild(t),this.adsStarted=!0,this.adsContainer=document.createElement("div"),this.adsContainer.className="op-ads",this.adsContainer.tabIndex=-1,this.element.parentElement&&this.element.parentElement.insertBefore(this.adsContainer,this.element.nextSibling),this.mediaSources=this.media.src,google.ima.settings.setVpaidMode(google.ima.ImaSdkSettings.VpaidMode.ENABLED),google.ima.settings.setDisableCustomPlaybackForIOS10Plus(!0),google.ima.settings.setAutoPlayAdBreaks(this.adsOptions.autoPlayAdBreaks),google.ima.settings.setNumRedirects(this.adsOptions.numRedirects),google.ima.settings.setLocale(this.adsOptions.language),this.adDisplayContainer=new google.ima.AdDisplayContainer(this.adsContainer,this.element),this.adsLoader=new google.ima.AdsLoader(this.adDisplayContainer),this.adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,this._loaded.bind(this),EVENT_OPTIONS),this.adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,this._error.bind(this),EVENT_OPTIONS),"undefined"!=typeof window&&window.addEventListener("resize",()=>{this.resizeAds()},EVENT_OPTIONS),this.element.addEventListener("loadedmetadata",()=>{this.resizeAds()},EVENT_OPTIONS),!0!==this.autoStart&&!0!==this.autoStartMuted&&!0!==e&&!0!==this.adsOptions.enablePreloading||(this.adsDone||(this.adsDone=!0,this.adDisplayContainer.initialize()),this._requestAds())}play(){return new Promise(e=>{e({})}).then(()=>{if(this.adsDone){if(this.adsManager){this.intervalTimer||!1!==this.adsActive?this.adsManager.resume():this.adsManager.start(),this.adsActive=!0;const e=addEvent("play");this.element.dispatchEvent(e)}}else this._initNotDoneAds()})}pause(){if(this.adsManager){this.adsActive=!1,this.adsManager.pause();const e=addEvent("pause");this.element.dispatchEvent(e)}}destroy(){this.events&&this.events.forEach(e=>{this.adsManager.removeEventListener(e,this._assign.bind(this))}),this.events=[];const e=this.player.getControls(),t=e?e.events.mouse:{};Object.keys(t).forEach(e=>{this.adsContainer&&this.adsContainer.removeEventListener(e,t[e])}),this.adsLoader&&(this.adsLoader.removeEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,this._error.bind(this)),this.adsLoader.removeEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,this._loaded.bind(this)));const s=!Array.isArray(this.ads)||this.currentAdsIndex>this.ads.length;this.adsManager&&s&&this.adsManager.destroy(),(IS_IOS||IS_ANDROID)&&this.element.removeEventListener("loadedmetadata",this._contentLoadedAction.bind(this)),this.element.removeEventListener("loadedmetadata",()=>{this.resizeAds.bind(this)}),this.element.removeEventListener("ended",this._contentEndedListener.bind(this)),"undefined"!=typeof window&&window.removeEventListener("resize",()=>{this.resizeAds.bind(this)}),removeElement(this.adsContainer)}resizeAds(e,t){if(this.adsManager){const s=this.element,i="true"===s.getAttribute("data-fullscreen")?google.ima.ViewMode.FULLSCREEN:google.ima.ViewMode.NORMAL;let a;a&&"undefined"!=typeof window&&window.cancelAnimationFrame(a),"undefined"!=typeof window&&(a=window.requestAnimationFrame(()=>{this.adsManager.resize(e||s.offsetWidth,t||s.offsetHeight,i)}))}}set playRequested(e){this.playTriggered=e}set volume(e){this.adsManager&&(this.adsVolume=e,this.adsManager.setVolume(e),this._setMediaVolume(e),this.adsMuted=0===e)}get volume(){return this.adsManager.getVolume()}set muted(e){this.adsManager&&(e?(this.adsManager.setVolume(0),this.adsMuted=!0,this._setMediaVolume(0)):(this.adsManager.setVolume(this.adsVolume),this.adsMuted=!1,this._setMediaVolume(this.adsVolume)))}get muted(){return this.adsMuted}set currentTime(e){this.adsCurrentTime=e}get currentTime(){return this.adsCurrentTime}get duration(){return this.adsDuration}get paused(){return!this.adsActive}get ended(){return this.adsEnded}_assign(e){const t=e.getAd();switch(e.type){case google.ima.AdEvent.Type.LOADED:if(t.isLinear()){if(IS_IPHONE&&isVideo(this.element)&&(this.element.controls=!1),this.adsDuration=t.getDuration(),this.adsCurrentTime=t.getDuration(),!this.mediaStarted&&!IS_IOS&&!IS_ANDROID){const e=addEvent("waiting");this.element.dispatchEvent(e);const t=addEvent("loadedmetadata");this.element.dispatchEvent(t),this.resizeAds()}}else this._onContentResumeRequested();break;case google.ima.AdEvent.Type.STARTED:if(t.isLinear()){this.element.parentElement&&!this.element.parentElement.classList.contains("op-ads--active")&&this.element.parentElement.classList.add("op-ads--active"),this.media.paused||this.media.pause(),this.adsActive=!0;const e=addEvent("play");let t;if(this.element.dispatchEvent(e),t||(this.resizeAds(),t=!0),this.media.ended){this.adsEnded=!1;const e=addEvent("adsmediaended");this.element.dispatchEvent(e)}"undefined"!=typeof window&&(this.intervalTimer=window.setInterval(()=>{if(!0===this.adsActive){this.adsCurrentTime=Math.round(this.adsManager.getRemainingTime());const e=addEvent("timeupdate");this.element.dispatchEvent(e)}},350))}break;case google.ima.AdEvent.Type.COMPLETE:case google.ima.AdEvent.Type.SKIPPED:if(t.isLinear()){if(e.type===google.ima.AdEvent.Type.SKIPPED){const e=addEvent("adsskipped");this.element.dispatchEvent(e)}this.element.parentElement&&this.element.parentElement.classList.remove("op-ads--active"),this.adsActive=!1,clearInterval(this.intervalTimer)}break;case google.ima.AdEvent.Type.VOLUME_CHANGED:this._setMediaVolume(this.volume);case google.ima.AdEvent.Type.VOLUME_MUTED:if(t.isLinear()){const e=addEvent("volumechange");this.element.dispatchEvent(e)}break;case google.ima.AdEvent.Type.ALL_ADS_COMPLETED:if(t.isLinear()&&(this.adsActive=!1,this.adsEnded=!0,this.intervalTimer=0,this.adsMuted=!1,this.adsStarted=!1,this.adsDuration=0,this.adsCurrentTime=0,this.element.parentElement&&this.element.parentElement.classList.remove("op-ads--active"),this.destroy(),this.element.currentTime>=this.element.duration)){const e=addEvent("ended");this.element.dispatchEvent(e)}}if(e.type===google.ima.AdEvent.Type.LOG){const t=e.getAdData();if(t.adError){const e=t.adError.getMessage();console.warn(`Ad warning: Non-fatal error occurred: ${e}`);const s={detail:{data:t.adError,message:e,type:"Ads"}},i=addEvent("playererror",s);this.element.dispatchEvent(i)}}else{const t=addEvent(`ads${e.type}`);this.element.dispatchEvent(t)}}_error(e){const t=e.getError(),s={detail:{data:t,message:t.toString(),type:"Ads"}},i=addEvent("playererror",s);this.element.dispatchEvent(i);const a=[100,101,102,300,301,302,303,400,401,402,403,405,406,407,408,409,410,500,501,502,503,900,901,1005];Array.isArray(this.ads)&&this.ads.length>1&&this.currentAdsIndex<=this.ads.length-1?(this.currentAdsIndex<this.ads.length-1&&this.currentAdsIndex++,this.playTriggered=!0,this.adsStarted=!0,this.adsDone=!1,this.destroy(),this.load(!0),console.warn(`Ad warning: ${t.toString()}`)):(a.indexOf(t.getErrorCode())>-1?(this.adsManager&&this.adsManager.destroy(),console.error(`Ad error: ${t.toString()}`)):console.warn(`Ad warning: ${t.toString()}`),!0!==this.autoStart&&!0!==this.autoStartMuted&&!0!==this.adsStarted||(this.adsActive=!1,this._resumeMedia()))}_loaded(e){const t=new google.ima.AdsRenderingSettings;t.restoreCustomPlaybackStateOnAdBreakComplete=!1,t.enablePreloading=this.adsOptions.enablePreloading,this.adsManager=e.getAdsManager(this.element,t),this._start(this.adsManager)}_start(e){e.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,this._onContentPauseRequested.bind(this),EVENT_OPTIONS),e.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,this._onContentResumeRequested.bind(this),EVENT_OPTIONS),this.events=[google.ima.AdEvent.Type.ALL_ADS_COMPLETED,google.ima.AdEvent.Type.CLICK,google.ima.AdEvent.Type.VIDEO_CLICKED,google.ima.AdEvent.Type.VIDEO_ICON_CLICKED,google.ima.AdEvent.Type.AD_PROGRESS,google.ima.AdEvent.Type.AD_BUFFERING,google.ima.AdEvent.Type.IMPRESSION,google.ima.AdEvent.Type.DURATION_CHANGE,google.ima.AdEvent.Type.USER_CLOSE,google.ima.AdEvent.Type.LINEAR_CHANGED,google.ima.AdEvent.Type.SKIPPABLE_STATE_CHANGED,google.ima.AdEvent.Type.AD_METADATA,google.ima.AdEvent.Type.INTERACTION,google.ima.AdEvent.Type.COMPLETE,google.ima.AdEvent.Type.FIRST_QUARTILE,google.ima.AdEvent.Type.LOADED,google.ima.AdEvent.Type.MIDPOINT,google.ima.AdEvent.Type.PAUSED,google.ima.AdEvent.Type.RESUMED,google.ima.AdEvent.Type.USER_CLOSE,google.ima.AdEvent.Type.STARTED,google.ima.AdEvent.Type.THIRD_QUARTILE,google.ima.AdEvent.Type.SKIPPED,google.ima.AdEvent.Type.VOLUME_CHANGED,google.ima.AdEvent.Type.VOLUME_MUTED,google.ima.AdEvent.Type.LOG],this.adsOptions.autoPlayAdBreaks||this.events.push(google.ima.AdEvent.Type.AD_BREAK_READY);const t=this.player.getControls(),s=t?t.events.mouse:{};if(Object.keys(s).forEach(e=>{this.adsContainer&&this.adsContainer.addEventListener(e,s[e],EVENT_OPTIONS)}),this.events.forEach(t=>{e.addEventListener(t,this._assign.bind(this),EVENT_OPTIONS)}),!0===this.autoStart||!0===this.playTriggered){if(this.playTriggered=!1,!this.adsDone)return void this._initNotDoneAds();e.init(this.element.offsetWidth,this.element.offsetHeight,this.element.parentElement&&"true"===this.element.parentElement.getAttribute("data-fullscreen")?google.ima.ViewMode.FULLSCREEN:google.ima.ViewMode.NORMAL),e.start();const t=addEvent("play");this.element.dispatchEvent(t);const s=addEvent("playing");this.element.dispatchEvent(s)}else!0===this.adsOptions.enablePreloading&&e.init(this.element.offsetWidth,this.element.offsetHeight,this.element.parentElement&&"true"===this.element.parentElement.getAttribute("data-fullscreen")?google.ima.ViewMode.FULLSCREEN:google.ima.ViewMode.NORMAL)}_initNotDoneAds(){this.adsDone=!0,this.adDisplayContainer.initialize(),IS_IOS||IS_ANDROID?(this.preloadContent=this._contentLoadedAction,this.element.addEventListener("loadedmetadata",this._contentLoadedAction.bind(this),EVENT_OPTIONS),this.element.load()):this._contentLoadedAction()}_contentEndedListener(){this.adsEnded=!0,this.adsActive=!1,this.adsStarted=!1,this.adsLoader.contentComplete()}_onContentPauseRequested(){this.element.removeEventListener("ended",this._contentEndedListener.bind(this)),this.lastTimePaused=this.media.currentTime,this.adsStarted?this.media.pause():this.adsStarted=!0;const e=addEvent("play");this.element.dispatchEvent(e)}_onContentResumeRequested(){if(this.adsOptions.loop)Array.isArray(this.ads)&&(this.currentAdsIndex===this.ads.length-1?this.currentAdsIndex=0:this.currentAdsIndex++),this.destroy(),this.adsLoader.contentComplete(),this.playTriggered=!0,this.adsStarted=!0,this.adsDone=!1,this.load(!0);else if(this.element.addEventListener("ended",this._contentEndedListener.bind(this),EVENT_OPTIONS),this.element.addEventListener("loadedmetadata",this._loadedMetadataHandler.bind(this),EVENT_OPTIONS),IS_IOS||IS_ANDROID)this.media.src=this.mediaSources,this.media.load(),this._prepareMedia(),this.element.parentElement&&this.element.parentElement.classList.add("op-ads--active");else{const e=addEvent("loadedmetadata");this.element.dispatchEvent(e)}}_loadedMetadataHandler(){Array.isArray(this.ads)?(this.currentAdsIndex++,this.currentAdsIndex<=this.ads.length-1?(this.adsManager&&this.adsManager.destroy(),this.adsLoader.contentComplete(),this.playTriggered=!0,this.adsStarted=!0,this.adsDone=!1,this._requestAds()):(this.adsOptions.autoPlayAdBreaks||this._resetAdsAfterManualBreak(),this._prepareMedia())):this.element.seekable.length?this.element.seekable.end(0)>this.lastTimePaused&&(this.adsOptions.autoPlayAdBreaks||this._resetAdsAfterManualBreak(),this._prepareMedia()):setTimeout(this._loadedMetadataHandler.bind(this),100)}_resumeMedia(){this.intervalTimer=0,this.adsMuted=!1,this.adsStarted=!1,this.adsDuration=0,this.adsCurrentTime=0,this.element.parentElement&&this.element.parentElement.classList.remove("op-ads--active");const e=e=>{const t=addEvent(e);this.element.dispatchEvent(t)};((e,t)=>new Promise((s,i)=>{if(t)return i();setTimeout(s,e)}))(50,this.media.ended).then(()=>this.media.play().then(()=>e("play"))).catch(()=>e("ended"))}_requestAds(){this.adsRequest=new google.ima.AdsRequest;const e=Array.isArray(this.ads)?this.ads[this.currentAdsIndex]:this.ads;isXml(e)?this.adsRequest.adsResponse=e:this.adsRequest.adTagUrl=e;const t=this.element.parentElement?this.element.parentElement.offsetWidth:0,s=this.element.parentElement?this.element.parentElement.offsetHeight:0;this.adsRequest.linearAdSlotWidth=t,this.adsRequest.linearAdSlotHeight=s,this.adsRequest.nonLinearAdSlotWidth=t,this.adsRequest.nonLinearAdSlotHeight=s/3,this.adsRequest.setAdWillAutoPlay(this.autoStart),this.adsRequest.setAdWillPlayMuted(this.autoStartMuted),this.adsLoader.requestAds(this.adsRequest)}_contentLoadedAction(){this.preloadContent&&(this.element.removeEventListener("loadedmetadata",this.preloadContent.bind(this)),this.preloadContent=null),this._requestAds()}_resetAdsAfterManualBreak(){this.adsManager&&this.adsManager.destroy(),this.adsLoader.contentComplete(),this.adsDone=!1,this.playTriggered=!0}_prepareMedia(){this.media.currentTime=this.lastTimePaused,this.element.removeEventListener("loadedmetadata",this._loadedMetadataHandler.bind(this)),this._resumeMedia()}_setMediaVolume(e){this.media.volume=e,this.media.muted=0===e}}export default Ads;