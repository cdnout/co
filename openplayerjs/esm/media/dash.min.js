import{HAS_MSE}from"../utils/constants";import{addEvent}from"../utils/events";import{loadScript}from"../utils/general";import{isDashSource}from"../utils/media";import Native from"./native";class DashMedia extends Native{constructor(e,t,s){return super(e,t),this.events={},this.options={},this.options=s,this.promise="undefined"==typeof dashjs?loadScript("https://cdn.dashjs.org/latest/dash.all.min.js"):new Promise(e=>{e({})}),this.promise.then(()=>{this.player=dashjs.MediaPlayer().create(),this.instance=this.player}),this}canPlayType(e){return HAS_MSE&&"application/dash+xml"===e}load(){this._preparePlayer(),this.player.attachSource(this.media.src);const e=addEvent("loadedmetadata");this.element.dispatchEvent(e),this.events||(this.events=dashjs.MediaPlayer.events,Object.keys(this.events).forEach(e=>{this.player.on(this.events[e],this._assign.bind(this))}))}destroy(){this._revoke()}set src(e){isDashSource(e)&&(this._revoke(),this.player=dashjs.MediaPlayer().create(),this._preparePlayer(),this.player.attachSource(e.src),this.events=dashjs.MediaPlayer.events,Object.keys(this.events).forEach(e=>{this.player.on(this.events[e],this._assign.bind(this))}))}get levels(){const e=[];if(this.player){const t=this.player.getBitrateInfoListFor("video");t.length&&t.forEach(s=>{if(t[s]){const{height:i,name:a}=t[s],r={height:i,id:s,label:a||null};e.push(r)}})}return e}set level(e){0===e?this.player.setAutoSwitchQuality(!0):(this.player.setAutoSwitchQuality(!1),this.player.setQualityFor("video",e))}get level(){return this.player?this.player.getQualityFor("video"):-1}_assign(e){if("error"===e.type){const t=addEvent("playererror",{detail:{message:e,type:"M(PEG)-DASH"}});this.element.dispatchEvent(t)}else{const t=addEvent(e.type,e);this.element.dispatchEvent(t)}}_revoke(){this.events&&(Object.keys(this.events).forEach(e=>{this.player.off(this.events[e],this._assign.bind(this))}),this.events=[]),this.player.reset()}_preparePlayer(){void 0===this.player.getDebug().setLogToBrowserConsole?this.player.updateSettings({debug:{logLevel:dashjs.Debug.LOG_LEVEL_NONE},streaming:{fastSwitchEnabled:!0,scheduleWhilePaused:!1}}):(this.player.getDebug().setLogToBrowserConsole(!1),this.player.setScheduleWhilePaused(!1),this.player.setFastSwitchEnabled(!0)),this.player.initialize(),this.player.attachView(this.element),this.player.setAutoPlay(!1),this.options&&"object"==typeof this.options.drm&&Object.keys(this.options.drm).length&&(this.player.setProtectionData(this.options.drm),this.options.robustnessLevel&&this.options.robustnessLevel&&this.player.getProtectionController().setRobustnessLevel(this.options.robustnessLevel))}}export default DashMedia;