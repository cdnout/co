import{EVENT_OPTIONS,IS_ANDROID,IS_IOS}from"../utils/constants";import{addEvent}from"../utils/events";import{isAudio,removeElement}from"../utils/general";class Volume{constructor(t,e,s){return this.events={button:{},media:{},slider:{}},this.player=t,this.labels=t.getOptions().labels,this.volume=this.player.getMedia().volume,this.position=e,this.layer=s,this}create(){this.container=document.createElement("div"),this.container.className=`op-controls__volume op-control__${this.position}`,this.container.tabIndex=0,this.container.setAttribute("aria-valuemin","0"),this.container.setAttribute("aria-valuemax","100"),this.container.setAttribute("aria-valuenow",`${this.volume}`),this.container.setAttribute("aria-valuetext",`${this.labels.volume}: ${this.volume}`),this.container.setAttribute("aria-orientation","vertical"),this.container.setAttribute("aria-label",this.labels.volumeSlider),this.slider=document.createElement("input"),this.slider.type="range",this.slider.className="op-controls__volume--input",this.slider.tabIndex=-1,this.slider.value=this.player.getMedia().volume.toString(),this.slider.setAttribute("min","0"),this.slider.setAttribute("max","1"),this.slider.setAttribute("step","0.1"),this.slider.setAttribute("aria-label",this.labels.volumeControl),this.display=document.createElement("progress"),this.display.className="op-controls__volume--display",this.display.setAttribute("max","10"),this.display.setAttribute("role","presentation"),this.display.value=10*this.player.getMedia().volume,this.container.appendChild(this.slider),this.container.appendChild(this.display),this.button=document.createElement("button"),this.button.type="button",this.button.className="op-controls__mute",this.button.tabIndex=0,this.button.title=this.labels.mute,this.button.setAttribute("aria-controls",this.player.id),this.button.setAttribute("aria-pressed","false"),this.button.setAttribute("aria-label",this.labels.mute),this.button.innerHTML=`<span class="op-sr">${this.labels.mute}</span>`;const t=t=>{const e=1*t.volume,s=Math.floor(100*e);this.slider.value=`${t.volume}`,this.display.value=10*e,this.container.setAttribute("aria-valuenow",`${s}`),this.container.setAttribute("aria-valuetext",`${this.labels.volume}: ${s}`)},e=t=>{const e=t.volume;e<=.5&&e>0?(this.button.classList.remove("op-controls__mute--muted"),this.button.classList.add("op-controls__mute--half")):0===e?(this.button.classList.add("op-controls__mute--muted"),this.button.classList.remove("op-controls__mute--half")):(this.button.classList.remove("op-controls__mute--muted"),this.button.classList.remove("op-controls__mute--half"))},s=t=>{const e=this.player.activeElement(),s=parseFloat(t.target.value);e.volume=s,e.muted=0===e.volume,this.volume=s;const i=this.player.getContainer().querySelector(".op-player__unmute");!e.muted&&i&&removeElement(i);const n=addEvent("volumechange");this.player.getElement().dispatchEvent(n)};if(this.events.media.volumechange=(()=>{const s=this.player.activeElement();t(s),e(s)}),this.events.media.timeupdate=(()=>{isAudio(this.player.getElement())&&(this.player.activeElement().duration===1/0||this.player.getElement().getAttribute("op-live__enabled"))&&this.button.classList.add("op-control__right")}),this.events.media.loadedmetadata=(()=>{const t=this.player.activeElement();t.muted&&(t.volume=0);const e=addEvent("volumechange");this.player.getElement().dispatchEvent(e)}),this.events.slider.input=s.bind(this),this.events.slider.change=s.bind(this),this.events.button.click=(()=>{this.button.setAttribute("aria-pressed","true");const t=this.player.activeElement();t.muted=!t.muted,t.muted?(t.volume=0,this.button.title=this.labels.unmute,this.button.setAttribute("aria-label",this.labels.unmute)):(t.volume=this.volume,this.button.title=this.labels.mute,this.button.setAttribute("aria-label",this.labels.mute));const e=addEvent("volumechange");this.player.getElement().dispatchEvent(e)}),this.button.addEventListener("click",this.events.button.click,EVENT_OPTIONS),Object.keys(this.events.media).forEach(t=>{this.player.getElement().addEventListener(t,this.events.media[t],EVENT_OPTIONS)}),Object.keys(this.events.slider).forEach(t=>{this.slider.addEventListener(t,this.events.slider[t],EVENT_OPTIONS)}),this.player.getContainer().addEventListener("keydown",this._keydownEvent.bind(this),EVENT_OPTIONS),!IS_ANDROID&&!IS_IOS){const t=this.player.getControls().getLayer(this.layer);t.appendChild(this.button),t.appendChild(this.container)}}destroy(){this.button.removeEventListener("click",this.events.button.click),Object.keys(this.events.media).forEach(t=>{this.player.getElement().removeEventListener(t,this.events.media[t])}),Object.keys(this.events.slider).forEach(t=>{this.slider.removeEventListener(t,this.events.slider[t])}),this.player.getContainer().removeEventListener("keydown",this._keydownEvent.bind(this)),removeElement(this.slider),removeElement(this.display),removeElement(this.container)}_keydownEvent(t){const e=t.which||t.keyCode||0,s=this.player.activeElement();if(38===e||40===e){const i=38===e?Math.min(s.volume+.1,1):Math.max(s.volume-.1,0);s.volume=i,s.muted=!(i>0),t.preventDefault()}}}export default Volume;