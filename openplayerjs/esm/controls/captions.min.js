import{EVENT_OPTIONS,IS_ANDROID,IS_IOS}from"../utils/constants";import{addEvent}from"../utils/events";import{getAbsoluteUrl,hasClass,removeElement,request}from"../utils/general";import{timeToSeconds}from"../utils/time";class Captions{constructor(t,e,s){this.events={button:{},global:{},media:{}},this.tracks={},this.trackUrlList={},this.default="off",this.player=t,this.labels=t.getOptions().labels,this.detachMenu=t.getOptions().detachMenus,this.position=e,this.layer=s;const i=this.player.getElement().textTracks,n=[];for(let t=0,e=i.length;t<e;t++){const e=[`track[kind="subtitles"][srclang="${i[t].language}"][label="${i[t].label}"]`,`track[kind="captions"][srclang="${i[t].language}"][label="${i[t].label}"]`];this.player.getElement().querySelector(e.join(", "))&&n.push(i[t])}if(!n.length)for(let t=0,e=i.length;t<e;t++)n.push(i[t]);return this.trackList=n,this.hasTracks=!!this.trackList.length,this}create(){if(!this.hasTracks)return;this.button=document.createElement("button"),this.button.className=`op-controls__captions op-control__${this.position}`,this.button.tabIndex=0,this.button.title=this.labels.toggleCaptions,this.button.setAttribute("aria-controls",this.player.id),this.button.setAttribute("aria-pressed","false"),this.button.setAttribute("aria-label",this.labels.toggleCaptions),this.button.setAttribute("data-active-captions","off"),this.button.innerHTML=`<span class="op-sr">${this.labels.toggleCaptions}</span>`,this.detachMenu&&(this.button.classList.add("op-control--no-hover"),this.menu=document.createElement("div"),this.menu.className="op-settings op-captions__menu",this.menu.setAttribute("aria-hidden","true"),this.button.classList.add("op-control--no-hover"),this.menu=document.createElement("div"),this.menu.className="op-settings op-captions__menu",this.menu.setAttribute("aria-hidden","true"),this.menu.innerHTML=`<div class="op-settings__menu" role="menu" id="menu-item-captions">\n                <div class="op-settings__submenu-item" tabindex="0" role="menuitemradio" aria-checked="${"off"===this.default?"true":"false"}">\n                    <div class="op-settings__submenu-label op-subtitles__option" data-value="captions-off">${this.labels.off}</div>\n                </div>\n            </div>`,this.player.getControls().getLayer(this.layer).appendChild(this.menu));for(let t=0,e=this.player.getElement().querySelectorAll("track"),s=e.length;t<s;t++){const s=e[t];if("subtitles"===s.kind||"captions"===s.kind){s.default&&(this.default=s.srclang,this.button.setAttribute("data-active-captions",s.srclang));const e=getAbsoluteUrl(s.src),i=this.trackList[t];i&&i.language===s.srclang&&(i.cues&&i.cues.length>0?(this.tracks[s.srclang]=this._getNativeCues(this.trackList[t]),this._prepareTrack(t,s.srclang,e,s.default||!1)):request(e,"text",i=>{if(this.tracks[s.srclang]=this._getCuesFromText(i),this._prepareTrack(t,s.srclang,e,s.default||!1),this.menu&&!this.menu.querySelector(`.op-subtitles__option[data-value="captions-${this.trackList[t].language}"]`)){const e=document.createElement("div");e.className="op-settings__submenu-item",e.tabIndex=0,e.setAttribute("role","menuitemradio"),e.setAttribute("aria-checked",this.default===this.trackList[t].language?"true":"false"),e.innerHTML=`<div class="op-settings__submenu-label op-subtitles__option"\n                                        data-value="captions-${this.trackList[t].language}">\n                                        ${this.labels.lang[this.trackList[t].language]||this.trackList[t].label}\n                                    </div>`,this.menu.appendChild(e)}}))}}this.captions=document.createElement("div"),this.captions.className="op-captions",this.captions.innerHTML="<span></span>";const t=this.captions.querySelector("span");if(this.events.media.timeupdate=(()=>{if(this.player.isMedia())if(this.current){const e=this.tracks[this.current.language];if(t&&void 0!==e){const s=this._search(e,this.player.getMedia().currentTime);t.innerHTML="",s>-1&&hasClass(this.button,"op-controls__captions--on")?(this.captions.classList.add("op-captions--on"),t.innerHTML=this._sanitize(e[s].text)):this._hide()}}else this._hide();else this._hide()}),this.events.button.click=(t=>{const e=t.target;if(this.detachMenu){const t=this.player.getContainer().querySelectorAll(".op-settings");for(let e=0,s=t.length;e<s;++e)t[e]!==this.menu&&t[e].setAttribute("aria-hidden","true");"true"===this.menu.getAttribute("aria-hidden")?this.menu.setAttribute("aria-hidden","false"):this.menu.setAttribute("aria-hidden","true")}else e.setAttribute("aria-pressed","true"),hasClass(e,"op-controls__captions--on")?(this._hide(),e.classList.remove("op-controls__captions--on"),e.setAttribute("data-active-captions","off")):(this.current||(this.current=this.trackList[0]),this._show(),e.classList.add("op-controls__captions--on"),e.setAttribute("data-active-captions",this.current.language))}),this.events.button.mouseover=(()=>{if(!IS_IOS&&!IS_ANDROID&&this.detachMenu){const t=this.player.getContainer().querySelectorAll(".op-settings");for(let e=0,s=t.length;e<s;++e)t[e]!==this.menu&&t[e].setAttribute("aria-hidden","true");"true"===this.menu.getAttribute("aria-hidden")&&this.menu.setAttribute("aria-hidden","false")}}),this.events.button.mouseout=(()=>{if(!IS_IOS&&!IS_ANDROID&&this.detachMenu){const t=this.player.getContainer().querySelectorAll(".op-settings");for(let e=0,s=t.length;e<s;++e)t[e].setAttribute("aria-hidden","true");"false"===this.menu.getAttribute("aria-hidden")&&this.menu.setAttribute("aria-hidden","true")}}),this.hasTracks){const t=this.player.getContainer();t.insertBefore(this.captions,t.firstChild),this.player.getControls().getLayer(this.layer).appendChild(this.button),this.button.addEventListener("click",this.events.button.click,EVENT_OPTIONS)}this.trackList.length<=1&&!this.detachMenu||!this.trackList.length&&this.detachMenu||(this.events.global.click=(t=>{const e=t.target;if(e.closest(`#${this.player.id}`)&&hasClass(e,"op-subtitles__option")){const t=e.getAttribute("data-value"),s=t?t.replace("captions-",""):"",i=Array.from(this.trackList).filter(t=>t.language===s);if(this.current=i?i.pop():void 0,this.detachMenu){if(hasClass(this.button,"op-controls__captions--on")?(this._hide(),this.button.classList.remove("op-controls__captions--on"),this.button.setAttribute("data-active-captions","off")):(this._show(),this.button.classList.add("op-controls__captions--on"),this.button.setAttribute("data-active-captions",s)),e.parentElement&&e.parentElement.parentElement){const t=e.parentElement.parentElement.querySelectorAll(".op-settings__submenu-item");for(let e=0,s=t.length;e<s;++e)t[e].setAttribute("aria-checked","false")}e.parentElement&&e.parentElement.setAttribute("aria-checked","true"),this.menu.setAttribute("aria-hidden","false")}else this._show(),this.button.setAttribute("data-active-captions",s);const n=addEvent("captionschanged");this.player.getElement().dispatchEvent(n)}}),this.detachMenu&&(this.button.addEventListener("mouseover",this.events.button.mouseover,EVENT_OPTIONS),this.menu.addEventListener("mouseover",this.events.button.mouseover,EVENT_OPTIONS),this.menu.addEventListener("mouseout",this.events.button.mouseout,EVENT_OPTIONS),this.player.getElement().addEventListener("controlshidden",this.events.button.mouseout,EVENT_OPTIONS)),void 0!==this.events.global.click&&document.addEventListener("click",this.events.global.click,EVENT_OPTIONS))}destroy(){void 0!==this.events.global.click&&document.removeEventListener("click",this.events.global.click),this.hasTracks&&(this.button.removeEventListener("click",this.events.button.click),this.detachMenu&&(this.button.removeEventListener("mouseover",this.events.button.mouseover),this.menu.removeEventListener("mouseover",this.events.button.mouseover),this.menu.removeEventListener("mouseout",this.events.button.mouseout),this.player.getElement().removeEventListener("controlshidden",this.events.button.mouseout),removeElement(this.menu)),this.player.getElement().removeEventListener("timeupdate",this.events.media.timeupdate),removeElement(this.button),removeElement(this.captions))}addSettings(){if(this.detachMenu||this.trackList.length<=1)return{};const t=this._formatMenuItems();return t.length>2?{className:"op-subtitles__option",default:this.default||"off",key:"captions",name:this.labels.captions,subitems:t}:{}}_getCuesFromText(t){const e=t.split(/\r?\n/),s=[],i=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;let n="^((?:[0-9]{1,2}:)?[0-9]{2}:[0-9]{2}([,.][0-9]{1,3})?) --\x3e ";n+="((?:[0-9]{1,2}:)?[0-9]{2}:[0-9]{2}([,.][0-9]{3})?)(.*?)$";const a=new RegExp("^((?:[0-9]{1,2}:)?[0-9]{2}:[0-9]{2}([,.][0-9]{1,3})?) --\x3e ((?:[0-9]{1,2}:)?[0-9]{2}:[0-9]{2}([,.][0-9]{3})?)(.*?)$");let o;function r(t){t="string"!=typeof t?JSON.stringify(t):t;try{t=JSON.parse(t)}catch(t){return!1}return"object"==typeof t&&null!==t}for(let t=0,n=e.length;t<n;t++){const n=a.exec(e[t]);if(n&&t<e.length){t-1>=0&&""!==e[t-1]&&(o=e[t-1]);let a=e[++t];for(t++;""!==e[t]&&t<e.length;)a=`${a}\n${e[t]}`,t++;a=a.trim().replace(i,"<a href='$1' target='_blank'>$1</a>");const l=timeToSeconds(n[1]);s.push({endTime:timeToSeconds(n[3]),identifier:o||"",settings:r(n[5])?JSON.parse(n[5]):{},startTime:0===l?.2:l,text:a})}o=""}return s}_getNativeCues(t){const e=[],s=t.cues;return Object.keys(s).forEach(t=>{const i=parseInt(t,10),n=s[i];e.push({endTime:n.endTime,identifier:n.id,settings:{},startTime:n.startTime,text:n.text})}),e}_show(){if(!this.captions||!this.current||void 0===this.current.cues)return;const t=this.captions.querySelector("span");t&&(t.innerHTML=""),this.player.getElement().addEventListener("timeupdate",this.events.media.timeupdate,EVENT_OPTIONS)}_hide(){this.captions.classList.remove("op-captions--on"),this.current||(this.button.classList.remove("op-controls__captions--on"),this.button.setAttribute("data-active-captions","off"))}_search(t,e){let s=0,i=t.length-1;for(;s<=i;){const n=s+i>>1,a=t[n].startTime,o=t[n].endTime;if(e>=a&&e<o)return n;a<e?s=n+1:a>e&&(i=n-1)}return-1}_sanitize(t){const e=document.createElement("div");e.innerHTML=t;const s=e.getElementsByTagName("script");let i=s.length;for(;i--;)removeElement(s[i]);const n=e.getElementsByTagName("*");for(let t=0,e=n.length;t<e;t++){const e=n[t].attributes,s=Array.prototype.slice.call(e);for(let e=0,i=s.length;e<i;e++)/^(on|javascript:)/.test(s[e].name)?removeElement(n[t]):"style"===s[e].name&&n[t].removeAttribute(s[e].name)}return e.innerHTML}_prepareTrack(t,e,s,i=!1){this.trackUrlList[e]=s,this.trackList[t].mode="disabled",i&&(this.default=e,this.button.classList.add("op-controls__captions--on"),this.button.setAttribute("data-active-captions",e),this.current=Array.from(this.trackList).filter(t=>t.language===this.default).pop(),this._show(),this.player.getContainer().classList.contains("op-captions--detected")||this.player.getContainer().classList.add("op-captions--detected"))}_formatMenuItems(){let t=[{key:"off",label:this.labels.off}];for(let e=0,s=this.trackList.length;e<s;e++){const s=this.trackList[e];(t=t.filter(t=>t.key!==s.language)).push({key:s.language,label:this.labels.lang[s.language]||this.trackList[e].label})}return t}}export default Captions;