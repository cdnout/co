import{EVENT_OPTIONS,IS_ANDROID,IS_IOS,NAV}from"../utils/constants";import{addEvent}from"../utils/events";import{hasClass,removeElement}from"../utils/general";import{isDashSource,isHlsSource}from"../utils/media";class Levels{constructor(e,t,s){return this.events={button:{},global:{},media:{}},this.levels=[],this.default="",this.player=e,this.labels=e.getOptions().labels,this.detachMenu=e.getOptions().detachMenus,this.position=t,this.layer=s,this}create(){const e=null!==this.player.getOptions().defaultLevel?parseInt(this.player.getOptions().defaultLevel,10):this.player.getMedia().level;this.default=`${e}`;const t=this._formatMenuItems(),s=t.length?t.find(e=>e.key===this.default):null,i=s?s.label:this.labels.auto;let n=!1;this.button=document.createElement("button"),this.button.className=`op-controls__levels op-control__${this.position}`,this.button.tabIndex=0,this.button.title=this.labels.mediaLevels,this.button.setAttribute("aria-controls",this.player.id),this.button.setAttribute("aria-label",this.labels.mediaLevels),this.button.setAttribute("data-active-level",this.default),this.button.innerHTML=`<span>${i}</span>`;const l=()=>{this.levels.length?n||(this.player.getMedia().level=e,n=!0):(this._gatherLevels.bind(this),setTimeout(()=>{this.player.getMedia().level=e;const t=addEvent("controlschanged");this.player.getElement().dispatchEvent(t)},0))};this.events.media.loadedmetadata=l.bind(this),this.events.media.manifestLoaded=l.bind(this),this.events.media.hlsManifestParsed=l.bind(this),this.detachMenu&&(this._buildMenu(),this.events.button.click=(()=>{if(this.detachMenu){const e=this.player.getContainer().querySelectorAll(".op-settings");for(let t=0,s=e.length;t<s;++t)e[t]!==this.menu&&e[t].setAttribute("aria-hidden","true");"true"===this.menu.getAttribute("aria-hidden")?this.menu.setAttribute("aria-hidden","false"):this.menu.setAttribute("aria-hidden","true")}}),this.events.button.mouseover=(()=>{if(!IS_IOS&&!IS_ANDROID){const e=this.player.getContainer().querySelectorAll(".op-settings");for(let t=0,s=e.length;t<s;++t)e[t]!==this.menu&&e[t].setAttribute("aria-hidden","true");"true"===this.menu.getAttribute("aria-hidden")&&this.menu.setAttribute("aria-hidden","false")}}),this.events.button.mouseout=(()=>{if(!IS_IOS&&!IS_ANDROID){const e=this.player.getContainer().querySelectorAll(".op-settings");for(let t=0,s=e.length;t<s;++t)e[t].setAttribute("aria-hidden","true");"false"===this.menu.getAttribute("aria-hidden")&&this.menu.setAttribute("aria-hidden","true")}}),this.button.addEventListener("click",this.events.button.click,EVENT_OPTIONS),this.button.addEventListener("mouseover",this.events.button.mouseover,EVENT_OPTIONS),this.menu.addEventListener("mouseover",this.events.button.mouseover,EVENT_OPTIONS),this.menu.addEventListener("mouseout",this.events.button.mouseout,EVENT_OPTIONS),this.player.getElement().addEventListener("controlshidden",this.events.button.mouseout,EVENT_OPTIONS)),this.events.global.click=(e=>{const t=e.target,s=this.player.getMedia().currentTime,i=this.player.getMedia().paused;if(t.closest(`#${this.player.id}`)&&hasClass(t,"op-levels__option")){const n=t.getAttribute("data-value"),l=parseInt(n?n.replace("levels-",""):"-1",10);if(this.default=`${l}`,this.detachMenu){this.button.setAttribute("data-active-level",`${l}`),this.button.innerHTML=`<span>${t.innerText}</span>`;const e=t.parentElement&&t.parentElement.parentElement?t.parentElement.parentElement.querySelectorAll(".op-settings__submenu-item"):[];for(let t=0,s=e.length;t<s;++t)e[t].setAttribute("aria-checked","false");t.parentElement&&t.parentElement.setAttribute("aria-checked","true"),this.menu.setAttribute("aria-hidden","false")}this.player.getMedia().level=l,this.player.getMedia().currentTime=s,i||this.player.play();const a=addEvent("levelchanged",{detail:{label:t.innerText.trim(),level:l}});this.player.getElement().dispatchEvent(a),e.preventDefault()}});const a=NAV.connection||NAV.mozConnection||NAV.webkitConnection;this.events.global.connection=(()=>{const e=this.player.getMedia().media.media;if(!isDashSource(e)&&!isHlsSource(e)){let e=a.effectiveType;const t=this.levels.map(e=>Object.assign(Object.assign({},e),{resolution:parseInt(e.label.replace("p",""),10)}));let s=t.find(e=>e.resolution<360);"4g"===e?s=t.find(e=>e.resolution>=720):"3g"===e&&(s=t.find(e=>e.resolution>=360&&e.resolution<720)),s&&(this.player.pause(),this.player.getMedia().level=s.id,this.player.play()),e=a.effectiveType}}),Object.keys(this.events.media).forEach(e=>{this.player.getElement().addEventListener(e,this.events.media[e],EVENT_OPTIONS)}),document.addEventListener("click",this.events.global.click,EVENT_OPTIONS),a&&a.addEventListener("change",this.events.global.connection,EVENT_OPTIONS)}destroy(){const e=NAV.connection||NAV.mozConnection||NAV.webkitConnection;Object.keys(this.events.media).forEach(e=>{this.player.getElement().removeEventListener(e,this.events.media[e])}),document.removeEventListener("click",this.events.global.click),e&&e.removeEventListener("change",this.events.global.connection),this.detachMenu&&(this.button.removeEventListener("click",this.events.button.click),removeElement(this.button),this.button.removeEventListener("mouseover",this.events.button.mouseover),this.menu.removeEventListener("mouseover",this.events.button.mouseover),this.menu.removeEventListener("mouseout",this.events.button.mouseout),this.player.getElement().removeEventListener("controlshidden",this.events.button.mouseout),removeElement(this.menu))}addSettings(){if(this.detachMenu)return{};const e=this._formatMenuItems();return e.length>2?{className:"op-levels__option",default:this.default||"-1",key:"levels",name:this.labels.levels,subitems:e}:{}}_formatMenuItems(){const e=this._gatherLevels(),t=e.length;let s=t?[{key:"-1",label:this.labels.auto}]:[];for(let i=0;i<t;i++){const t=e[i];(s=s.filter(e=>e.key!==t.id)).push({key:t.id,label:t.label})}return s=s.reduce((e,t)=>{return e.find(e=>e.label===t.label)?e:e.concat([t])},[]).sort((e,t)=>parseInt(e.label,10)>parseInt(t.label,10)?1:-1)}_getResolutionsLabel(e){return e>=4320?"8K":e>=2160?"4K":e>=1440?"1440p":e>=1080?"1080p":e>=720?"720p":e>=480?"480p":e>=360?"360p":e>=240?"240p":e>=144?"144p":this.labels.auto}_gatherLevels(){return this.levels.length||this.player.getMedia().levels.forEach(e=>{this.levels.push(Object.assign(Object.assign({},e),{label:e.label||this._getResolutionsLabel(e.height)}))}),this.levels}_buildMenu(){if(this.detachMenu){this.button.classList.add("op-control--no-hover"),this.menu=document.createElement("div"),this.menu.className="op-settings op-levels__menu",this.menu.setAttribute("aria-hidden","true");const e="op-levels__option",t=`<div class="op-settings__menu" role="menu" id="menu-item-levels">\n                ${this._formatMenuItems().map(t=>`\n                <div class="op-settings__submenu-item" tabindex="0" role="menuitemradio"\n                    aria-checked="${this.default===t.key?"true":"false"}">\n                    <div class="op-settings__submenu-label ${e||""}" data-value="levels-${t.key}">${t.label}</div>\n                </div>`).join("")}\n            </div>`;this.menu.innerHTML=t;const s=document.createElement("div");s.className=`op-controls__container op-control__${this.position}`,s.appendChild(this.button),s.appendChild(this.menu),this.player.getControls().getLayer(this.layer).appendChild(s)}}}export default Levels;