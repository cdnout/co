import{EVENT_OPTIONS,IS_ANDROID,IS_IOS}from"../utils/constants";import{hasClass,offset,removeElement}from"../utils/general";import{formatTime}from"../utils/time";class Progress{constructor(e,t,s){return this.events={container:{},controls:{},global:{},media:{},slider:{}},this.player=e,this.labels=e.getOptions().labels,this.forcePause=!1,this.position=t,this.layer=s,this}create(){this.progress=document.createElement("div"),this.progress.className=`op-controls__progress op-control__${this.position}`,this.progress.tabIndex=0,this.progress.setAttribute("aria-label",this.labels.progressSlider),this.progress.setAttribute("aria-valuemin","0"),this.slider=document.createElement("input"),this.slider.type="range",this.slider.className="op-controls__progress--seek",this.slider.tabIndex=-1,this.slider.setAttribute("min","0"),this.slider.setAttribute("max","0"),this.slider.setAttribute("step","0.1"),this.slider.value="0",this.slider.setAttribute("aria-label",this.labels.progressRail),this.slider.setAttribute("role","slider"),this.buffer=document.createElement("progress"),this.buffer.className="op-controls__progress--buffer",this.buffer.setAttribute("max","100"),this.buffer.value=0,this.played=document.createElement("progress"),this.played.className="op-controls__progress--played",this.played.setAttribute("max","100"),this.played.setAttribute("role","presentation"),this.played.value=0,this.progress.appendChild(this.slider),this.progress.appendChild(this.played),this.progress.appendChild(this.buffer),IS_IOS||IS_ANDROID||(this.tooltip=document.createElement("span"),this.tooltip.className="op-controls__tooltip",this.tooltip.tabIndex=-1,this.tooltip.innerHTML="00:00",this.progress.appendChild(this.tooltip));const e=()=>{const e=this.player.activeElement();if(e.duration===1/0||this.player.getElement().getAttribute("op-live__enabled")||this.player.getElement().getAttribute("op-dvr__enabled"))this.player.getElement().getAttribute("op-dvr__enabled")?(this.slider.setAttribute("max","1"),this.slider.value="1",this.slider.style.backgroundSize="100% 100%",this.played.value=1,this.progress.setAttribute("aria-valuemax","1"),this.progress.setAttribute("aria-hidden","false")):this.player.getElement().getAttribute("op-live__enabled")&&!this.player.getOptions().live.showProgress&&this.progress.setAttribute("aria-hidden","true");else{this.slider.setAttribute("max",`${e.duration}`);const t=this.player.isMedia()?e.currentTime:e.duration-e.currentTime;this.slider.value=t.toString(),this.progress.setAttribute("aria-valuemax",e.duration.toString())}};let t=0;this.events.media.loadedmetadata=e.bind(this),this.events.controls.controlschanged=e.bind(this),this.events.media.progress=(e=>{const t=e.target;if(t.duration===1/0||this.player.getElement().getAttribute("op-live__enabled"))this.player.getElement().getAttribute("op-dvr__enabled")||"false"!==this.progress.getAttribute("aria-hidden")||this.progress.setAttribute("aria-hidden","true");else if(t.duration>0)for(let e=0,s=t.buffered.length;e<s;e++)if(t.buffered.start(t.buffered.length-1-e)<t.currentTime){this.buffer.value=t.buffered.end(t.buffered.length-1-e)/t.duration*100;break}}),this.events.media.pause=(()=>{const e=this.player.activeElement();if(e.duration!==1/0&&!this.player.getElement().getAttribute("op-live__enabled")){const t=e.currentTime;this.progress.setAttribute("aria-valuenow",t.toString()),this.progress.setAttribute("aria-valuetext",formatTime(t))}}),this.events.media.play=(()=>{this.player.activeElement().duration===1/0||this.player.getElement().getAttribute("op-live__enabled")||(this.progress.removeAttribute("aria-valuenow"),this.progress.removeAttribute("aria-valuetext"))}),this.events.media.timeupdate=(()=>{const e=this.player.activeElement();if(e.duration===1/0||this.player.getElement().getAttribute("op-live__enabled")&&!this.player.getElement().getAttribute("op-dvr__enabled"))this.player.getElement().getAttribute("op-dvr__enabled")||"false"!==this.progress.getAttribute("aria-hidden")||this.progress.setAttribute("aria-hidden","true");else{this.slider.getAttribute("max")&&"0"!==this.slider.getAttribute("max")&&parseFloat(this.slider.getAttribute("max")||"-1")===e.duration||(this.slider.setAttribute("max",`${e.duration}`),this.progress.setAttribute("aria-hidden","false"));const s=this.player.isMedia()?e.currentTime:e.duration-e.currentTime+1>=100?100:e.duration-e.currentTime+1,i=parseFloat(this.slider.min),r=parseFloat(this.slider.max);this.slider.value=s.toString(),this.slider.style.backgroundSize=`${100*(s-i)/(r-i)}% 100%`,this.played.value=e.duration<=0||isNaN(e.duration)||!isFinite(e.duration)?this.player.getOptions().progress.duration:s/e.duration*100,this.player.getElement().getAttribute("op-dvr__enabled")&&Math.floor(this.played.value)>=99&&(t=e.currentTime,this.progress.setAttribute("aria-hidden","false"))}}),this.events.media.durationchange=(()=>{const e=this.player.activeElement(),t=this.player.isMedia()?e.currentTime:e.duration-e.currentTime;this.slider.setAttribute("max",`${e.duration}`),this.progress.setAttribute("aria-valuemax",e.duration.toString()),this.played.value=e.duration<=0||isNaN(e.duration)||!isFinite(e.duration)?this.player.getOptions().progress.duration:t/e.duration*100}),this.events.media.ended=(()=>{this.slider.style.backgroundSize="0% 100%",this.slider.setAttribute("max","0"),this.buffer.value=0,this.played.value=0});const s=e=>{if(hasClass(this.slider,"op-progress--pressed"))return;const s=e.target;this.slider.classList.add(".op-progress--pressed");const i=this.player.activeElement(),r=parseFloat(s.min),a=parseFloat(s.max),o=parseFloat(s.value);this.slider.style.backgroundSize=`${100*(o-r)/(a-r)}% 100%`,this.played.value=i.duration<=0||isNaN(i.duration)||!isFinite(i.duration)?this.player.getOptions().progress.duration:o/i.duration*100,this.player.getElement().getAttribute("op-dvr__enabled")?i.currentTime=Math.round(this.played.value)>=99?t:o:i.currentTime=o,this.slider.classList.remove(".op-progress--pressed"),e.preventDefault()},i=e=>{const t=this.player.activeElement();1!==e.which&&0!==e.which||!this.player.isMedia()||t.paused||t.play().then(()=>{t.pause.bind(this),this.forcePause=!0})},r=()=>{const e=this.player.activeElement();!0===this.forcePause&&this.player.isMedia()&&e.paused&&(e.play(),this.forcePause=!1)};this.events.slider.input=s.bind(this),this.events.slider.change=s.bind(this),this.events.slider.mousedown=i.bind(this),this.events.slider.mouseup=r.bind(this),this.events.slider.touchstart=(e=>{const t=this.player.activeElement();if(t.duration===1/0)return!0;const r=e.originalEvent?e.originalEvent.changedTouches:e.changedTouches,a=((r?r[0].pageX:e.pageX)-offset(this.progress).left)/this.progress.offsetWidth*t.duration;this.slider.value=a.toString(),s(e),i(e),e.preventDefault()}).bind(this),this.events.slider.touchend=r.bind(this),IS_IOS||IS_ANDROID||(this.events.container.mousemove=(e=>{const t=this.player.activeElement();if(t.duration===1/0||this.player.isAd())return!0;const s=e.originalEvent&&e.originalEvent.changedTouches?e.originalEvent.changedTouches[0].pageX:e.pageX;let i=s-offset(this.progress).left;const r=this.tooltip.offsetWidth/2,a=i/this.progress.offsetWidth,o=a*t.duration,n=this.player.getContainer(),l=n.offsetWidth-this.tooltip.offsetWidth;i<=0||s-offset(n).left<=r?i=0:s-offset(n).left>=l?i=l-offset(this.slider).left-10:i-=r,a>=0&&a<=1?this.tooltip.classList.add("op-controls__tooltip--visible"):this.tooltip.classList.remove("op-controls__tooltip--visible"),this.tooltip.style.left=`${i}px`,this.tooltip.innerHTML=isNaN(o)?"00:00":formatTime(o)}),this.events.global.mousemove=(e=>{e.target.closest(".op-controls__progress")&&!this.player.isAd()||this.tooltip.classList.remove("op-controls__tooltip--visible")})),Object.keys(this.events.media).forEach(e=>{this.player.getElement().addEventListener(e,this.events.media[e],EVENT_OPTIONS)}),Object.keys(this.events.slider).forEach(e=>{this.slider.addEventListener(e,this.events.slider[e],EVENT_OPTIONS)}),this.progress.addEventListener("keydown",this.player.getEvents().keydown,EVENT_OPTIONS),this.progress.addEventListener("mousemove",this.events.container.mousemove,EVENT_OPTIONS),document.addEventListener("mousemove",this.events.global.mousemove,EVENT_OPTIONS),this.player.getContainer().addEventListener("keydown",this._keydownEvent.bind(this),EVENT_OPTIONS),this.player.getControls().getContainer().addEventListener("controlschanged",this.events.controls.controlschanged,EVENT_OPTIONS),this.player.getControls().getLayer(this.layer).appendChild(this.progress)}destroy(){Object.keys(this.events).forEach(e=>{this.player.getElement().removeEventListener(e,this.events[e])}),Object.keys(this.events.slider).forEach(e=>{this.slider.removeEventListener(e,this.events.slider[e])}),this.progress.removeEventListener("keydown",this.player.getEvents().keydown),this.progress.removeEventListener("mousemove",this.events.container.mousemove),document.removeEventListener("mousemove",this.events.global.mousemove),this.player.getContainer().removeEventListener("keydown",this._keydownEvent.bind(this)),this.player.getControls().getContainer().removeEventListener("controlschanged",this.events.controls.controlschanged),removeElement(this.buffer),removeElement(this.played),removeElement(this.slider),IS_IOS||IS_ANDROID||removeElement(this.tooltip),removeElement(this.progress)}_keydownEvent(e){const t=this.player.activeElement(),s=this.player.isAd(),i=e.which||e.keyCode||0,r=this.player.getOptions().step?this.player.getOptions().step:.05*t.duration,a=t.duration!==1/0?r:this.player.getOptions().progress.duration;35!==i||s?36!==i||s?37!==i&&39!==i||s||t.duration===1/0||(t.currentTime+=37===i?-1*a:a,t.currentTime<0?t.currentTime=0:t.currentTime>=t.duration&&(t.currentTime=t.duration),e.preventDefault()):(t.currentTime=0,e.preventDefault()):(t.currentTime=t.duration,e.preventDefault())}}export default Progress;