import Captions from"./controls/captions";import Fullscreen from"./controls/fullscreen";import Levels from"./controls/levels";import Play from"./controls/play";import Progress from"./controls/progress";import Settings from"./controls/settings";import Time from"./controls/time";import Volume from"./controls/volume";import{EVENT_OPTIONS,IS_ANDROID,IS_IOS}from"./utils/constants";import{addEvent}from"./utils/events";import{isAudio,isVideo,removeElement}from"./utils/general";class Controls{constructor(e){return this.events={media:{},mouse:{}},this.timer=0,this.controlEls={Captions:Captions,Fullscreen:Fullscreen,Levels:Levels,Play:Play,Progress:Progress,Settings:Settings,Time:Time,Volume:Volume},this.player=e,this._setElements(),this}create(){this.player.getElement().controls=!1;const e=isVideo(this.player.getElement());this._createControlsLayer(),this._buildElements(),this.events.controlschanged=(()=>{this.destroy(),this._setElements(),this.create()}),this.events.ended=(()=>{this.player.getContainer().classList.remove("op-controls--hidden")}),this.player.getElement().addEventListener("controlschanged",this.events.controlschanged,EVENT_OPTIONS),this.player.getElement().addEventListener("ended",this.events.ended,EVENT_OPTIONS);const{alwaysVisible:t}=this.player.getOptions().controls;t||IS_ANDROID||IS_IOS||(this.events.mouse.mouseenter=(()=>{e&&!this.player.activeElement().paused&&(this._stopControlTimer(),this.player.activeElement().currentTime?(this.player.playBtn.setAttribute("aria-hidden",this.player.isMedia()?"false":"true"),this.player.loader.setAttribute("aria-hidden","true")):this.player.getOptions().showLoaderOnInit&&(this.player.playBtn.setAttribute("aria-hidden","true"),this.player.loader.setAttribute("aria-hidden","false")),this.player.getContainer().classList.remove("op-controls--hidden"),this._startControlTimer(2500))}),this.events.mouse.mousemove=(()=>{e&&(this.player.activeElement().currentTime?(this.player.loader.setAttribute("aria-hidden","true"),this.player.playBtn.setAttribute("aria-hidden",this.player.isMedia()?"false":"true")):(this.player.playBtn.setAttribute("aria-hidden",this.player.getOptions().showLoaderOnInit?"true":"false"),this.player.loader.setAttribute("aria-hidden",this.player.getOptions().showLoaderOnInit?"false":"true")),this.player.getContainer().classList.remove("op-controls--hidden"),this._startControlTimer(2500))}),this.events.mouse.mouseleave=(()=>{e&&!this.player.activeElement().paused&&this._startControlTimer(1e3)}),this.events.media.play=(()=>{e&&this._startControlTimer(this.player.getOptions().hidePlayBtnTimer)}),this.events.media.pause=(()=>{this.player.getContainer().classList.remove("op-controls--hidden"),this._stopControlTimer()}),Object.keys(this.events.media).forEach(e=>{this.player.getElement().addEventListener(e,this.events.media[e],EVENT_OPTIONS)}),Object.keys(this.events.mouse).forEach(e=>{this.player.getContainer().addEventListener(e,this.events.mouse[e],EVENT_OPTIONS)}),this._startControlTimer(3e3))}destroy(){IS_ANDROID||IS_IOS||(Object.keys(this.events.mouse).forEach(e=>{this.player.getContainer().removeEventListener(e,this.events.mouse[e])}),Object.keys(this.events.media).forEach(e=>{this.player.getElement().removeEventListener(e,this.events.media[e])}),this._stopControlTimer()),this.player.getElement().removeEventListener("controlschanged",this.events.controlschanged),this.player.getElement().removeEventListener("ended",this.events.ended),Object.keys(this.items).forEach(e=>{this.items[e].forEach(e=>{e.custom?this._destroyCustomControl(e):"function"==typeof e.destroy&&e.destroy()})}),removeElement(this.controls)}getContainer(){return this.controls}getLayer(e){return this.controls.querySelector(`.op-controls-layer__${e}`)||this.controls}_createControlsLayer(){this.controls&&this.player.getContainer().querySelector(".op-controls")||(this.controls=document.createElement("div"),this.controls.className="op-controls",this.player.getContainer().appendChild(this.controls))}_startControlTimer(e){const t=this.player.activeElement();this._stopControlTimer(),"undefined"!=typeof window&&(this.timer=window.setTimeout(()=>{if((!t.paused||!t.ended)&&isVideo(this.player.getElement())){this.player.getContainer().classList.add("op-controls--hidden"),this.player.playBtn.setAttribute("aria-hidden","true"),this._stopControlTimer();const e=addEvent("controlshidden");this.player.getElement().dispatchEvent(e)}},e))}_stopControlTimer(){0!==this.timer&&(clearTimeout(this.timer),this.timer=0)}_setElements(){const e=this.player.getOptions().controls.layers;this.items={"bottom-left":[],"bottom-middle":[],"bottom-right":[],left:[],main:[],middle:[],right:[],"top-left":[],"top-middle":[],"top-right":[]};const t=isVideo(this.player.getElement()),s=isAudio(this.player.getElement()),i=Object.keys(e),o=i.find(e=>/^(top|bottom)/.test(e));this._createControlsLayer(),i.forEach(i=>{const[n,r]=i.split("-");if(r){const e=`op-controls-layer__${n}`;if(!this.controls.querySelector(`.${e}`)){const t=document.createElement("div");t.className=e,this.controls.appendChild(t)}}else if(o){const e="op-controls-layer__center";if(!this.controls.querySelector(`.${e}`)){const t=document.createElement("div");t.className=e,this.controls.appendChild(t)}}e[i].filter((e,t,s)=>s.indexOf(e)===t).forEach(e=>{const l=o&&!r?"center":n,a=`${e.charAt(0).toUpperCase()}${e.slice(1)}`,c=new this.controlEls[a](this.player,r||n,l);"settings"===e&&(this.settings=c),(t||"fullscreen"!==e&&s)&&this.items[i].push(c)})}),this.player.getCustomControls().forEach(e=>{const[t,s]=e.position.split("-"),i=o&&!s?"center":t;e.layer=i,e.position=s||t,"right"===e.position?this.items[e.position].unshift(e):this.items[e.position].push(e)})}_buildElements(){Object.keys(this.items).forEach(e=>{this.items[e].forEach(e=>{e.custom?this._createCustomControl(e):e.create()})}),Object.keys(this.items).forEach(e=>{this.items[e].forEach(e=>{if((!this.player.getOptions().detachMenus||e instanceof Settings)&&!e.custom&&"function"==typeof e.addSettings){const t=e.addSettings();this.settings&&Object.keys(t).length&&this.settings.addItem(t.name,t.key,t.default,t.subitems,t.className)}})});const e=addEvent("controlschanged");this.controls.dispatchEvent(e)}_hideCustomMenu(e){let t;t&&"undefined"!=typeof window&&window.cancelAnimationFrame(t),"undefined"!=typeof window&&(t=window.requestAnimationFrame(()=>{e.setAttribute("aria-hidden","true")}))}_toggleCustomMenu(e,t,s){this.player.getContainer().querySelectorAll(".op-settings").forEach(e=>{"false"===e.getAttribute("aria-hidden")&&e.id!==t.id&&e.setAttribute("aria-hidden","true")}),t.setAttribute("aria-hidden","true"===t.getAttribute("aria-hidden")?"false":"true"),"function"==typeof s.click&&s.click(e)}_createCustomControl(e){const t=document.createElement("button"),s=/\.(jpg|png|svg|gif)$/.test(e.icon)?`<img src="${e.icon}">`:e.icon;if(t.className=`op-controls__${e.id} op-control__${e.position} ${e.showInAds?"":"op-control__hide-in-ad"}`,t.tabIndex=0,t.id=e.id,t.title=e.title,t.innerHTML=`${s} <span class="op-sr">${e.title}</span>`,e.subitems&&Array.isArray(e.subitems)&&e.subitems.length>0){const s=document.createElement("div");s.className="op-settings op-settings__custom",s.id=`${e.id}-menu`,s.setAttribute("aria-hidden","true");const i=e.subitems.map(t=>{let s="";return t.icon&&(s=/\.(jpg|png|svg|gif)$/.test(t.icon)?`<img src="${t.icon}">`:t.icon),`<div class="op-settings__menu-item" tabindex="0" ${t.title?`title="${t.title}"`:""} role="menuitemradio">\n                    <div class="op-settings__menu-label" id="${t.id}" data-value="${e.id}-${t.id}">${s} ${t.label}</div>\n                </div>`});s.innerHTML=`<div class="op-settings__menu" role="menu">${i.join("")}</div>`,this.player.getContainer().appendChild(s),e.subitems.forEach(e=>{const t=s.querySelector(`#${e.id}`);t&&e.click&&"function"==typeof e.click&&t.addEventListener("click",e.click,EVENT_OPTIONS)}),t.addEventListener("click",t=>this._toggleCustomMenu(t,s,e),EVENT_OPTIONS),this.player.getElement().addEventListener("controlshidden",()=>this._hideCustomMenu(s),EVENT_OPTIONS)}else"function"==typeof e.click&&t.addEventListener("click",e.click,EVENT_OPTIONS);e.layer&&("main"===e.layer?this.player.getContainer().appendChild(t):this.getLayer(e.layer).appendChild(t))}_destroyCustomControl(e){const t=e.title.toLowerCase().replace(" ","-"),s=this.getContainer().querySelector(`.op-controls__${t}`);if(s){if(e.subitems&&Array.isArray(e.subitems)&&e.subitems.length>0){const t=this.player.getContainer().querySelector(`#${e.id}-menu`);t&&(e.subitems.forEach(e=>{const s=t.querySelector(`#${e.id}`);s&&e.click&&"function"==typeof e.click&&s.removeEventListener("click",e.click)}),s.removeEventListener("click",s=>this._toggleCustomMenu(s,t,e)),this.player.getElement().removeEventListener("controlshidden",()=>this._hideCustomMenu(t)),removeElement(t))}"function"==typeof e.click&&s.removeEventListener("click",e.click),removeElement(s)}}}export default Controls;