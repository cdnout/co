import Captions from"./controls/captions";import Fullscreen from"./controls/fullscreen";import Levels from"./controls/levels";import Play from"./controls/play";import Progress from"./controls/progress";import Settings from"./controls/settings";import Time from"./controls/time";import Volume from"./controls/volume";import{EVENT_OPTIONS,IS_ANDROID,IS_IOS}from"./utils/constants";import{addEvent}from"./utils/events";import{isAudio,isVideo,removeElement}from"./utils/general";class Controls{constructor(t){return this.events={media:{},mouse:{}},this.timer=0,this.controlEls={Captions:Captions,Fullscreen:Fullscreen,Levels:Levels,Play:Play,Progress:Progress,Settings:Settings,Time:Time,Volume:Volume},this.player=t,this._setElements(),this}create(){this.player.getElement().controls=!1;const t=isVideo(this.player.getElement());this._createControlsLayer(),this._buildElements(),this.events.controlschanged=(()=>{this.destroy(),this._setElements(),this.create()}),this.events.ended=(()=>{this.player.getContainer().classList.remove("op-controls--hidden")}),this.player.getElement().addEventListener("controlschanged",this.events.controlschanged,EVENT_OPTIONS),this.player.getElement().addEventListener("ended",this.events.ended,EVENT_OPTIONS);const{alwaysVisible:e}=this.player.getOptions().controls;e||IS_ANDROID||IS_IOS||(this.events.mouse.mouseenter=(()=>{t&&!this.player.activeElement().paused&&(this._stopControlTimer(),this.player.activeElement().currentTime?(this.player.playBtn.setAttribute("aria-hidden",this.player.isMedia()?"false":"true"),this.player.loader.setAttribute("aria-hidden","true")):this.player.getOptions().showLoaderOnInit&&(this.player.playBtn.setAttribute("aria-hidden","true"),this.player.loader.setAttribute("aria-hidden","false")),this.player.getContainer().classList.remove("op-controls--hidden"),this._startControlTimer(2500))}),this.events.mouse.mousemove=(()=>{t&&(this.player.activeElement().currentTime?(this.player.loader.setAttribute("aria-hidden","true"),this.player.playBtn.setAttribute("aria-hidden",this.player.isMedia()?"false":"true")):(this.player.playBtn.setAttribute("aria-hidden",this.player.getOptions().showLoaderOnInit?"true":"false"),this.player.loader.setAttribute("aria-hidden",this.player.getOptions().showLoaderOnInit?"false":"true")),this.player.getContainer().classList.remove("op-controls--hidden"),this._startControlTimer(2500))}),this.events.mouse.mouseleave=(()=>{t&&!this.player.activeElement().paused&&this._startControlTimer(1e3)}),this.events.media.play=(()=>{t&&this._startControlTimer(this.player.getOptions().hidePlayBtnTimer)}),this.events.media.pause=(()=>{this.player.getContainer().classList.remove("op-controls--hidden"),this._stopControlTimer()}),Object.keys(this.events.media).forEach(t=>{this.player.getElement().addEventListener(t,this.events.media[t],EVENT_OPTIONS)}),Object.keys(this.events.mouse).forEach(t=>{this.player.getContainer().addEventListener(t,this.events.mouse[t],EVENT_OPTIONS)}),this._startControlTimer(3e3))}destroy(){IS_ANDROID||IS_IOS||(Object.keys(this.events.mouse).forEach(t=>{this.player.getContainer().removeEventListener(t,this.events.mouse[t])}),Object.keys(this.events.media).forEach(t=>{this.player.getElement().removeEventListener(t,this.events.media[t])}),this._stopControlTimer()),this.player.getElement().removeEventListener("controlschanged",this.events.controlschanged),this.player.getElement().removeEventListener("ended",this.events.ended),Object.keys(this.items).forEach(t=>{this.items[t].forEach(t=>{t.custom?this._destroyCustomControl(t):"function"==typeof t.destroy&&t.destroy()})}),removeElement(this.controls)}getContainer(){return this.controls}getLayer(t){return this.controls.querySelector(`.op-controls-layer__${t}`)||this.controls}_createControlsLayer(){this.controls&&this.player.getContainer().querySelector(".op-controls")||(this.controls=document.createElement("div"),this.controls.className="op-controls",this.player.getContainer().appendChild(this.controls))}_startControlTimer(t){const e=this.player.activeElement();this._stopControlTimer(),"undefined"!=typeof window&&(this.timer=window.setTimeout(()=>{if((!e.paused||!e.ended)&&isVideo(this.player.getElement())){this.player.getContainer().classList.add("op-controls--hidden"),this.player.playBtn.setAttribute("aria-hidden","true"),this._stopControlTimer();const t=addEvent("controlshidden");this.player.getElement().dispatchEvent(t)}},t))}_stopControlTimer(){0!==this.timer&&(clearTimeout(this.timer),this.timer=0)}_setElements(){const t=this.player.getOptions().controls.layers;this.items={"bottom-left":[],"bottom-middle":[],"bottom-right":[],left:[],main:[],middle:[],right:[],"top-left":[],"top-middle":[],"top-right":[]};const e=isVideo(this.player.getElement()),s=isAudio(this.player.getElement()),i=Object.keys(t),o=i.find(t=>/^(top|bottom)/.test(t));this._createControlsLayer(),i.forEach(i=>{const[r,n]=i.split("-");if(n){const t=`op-controls-layer__${r}`;if(!this.controls.querySelector(`.${t}`)){const e=document.createElement("div");e.className=t,this.controls.appendChild(e)}}else if(o){const t="op-controls-layer__center";if(!this.controls.querySelector(`.${t}`)){const e=document.createElement("div");e.className=t,this.controls.appendChild(e)}}t[i].filter((t,e,s)=>s.indexOf(t)===e).forEach(t=>{const l=o&&!n?"center":r,a=`${t.charAt(0).toUpperCase()}${t.slice(1)}`,h=new this.controlEls[a](this.player,n||r,l);"settings"===t&&(this.settings=h),(e||"fullscreen"!==t&&s)&&this.items[i].push(h)})}),this.player.getCustomControls().forEach(t=>{const[e,s]=t.position.split("-"),i=o&&!s?"center":e;t.layer=i,t.position=s||e,"right"===t.position?this.items[t.position].unshift(t):this.items[t.position].push(t)})}_buildElements(){Object.keys(this.items).forEach(t=>{this.items[t].forEach(t=>{t.custom?this._createCustomControl(t):t.create()})}),Object.keys(this.items).forEach(t=>{this.items[t].forEach(t=>{if((!this.player.getOptions().detachMenus||t instanceof Settings)&&!t.custom&&"function"==typeof t.addSettings){const e=t.addSettings();this.settings&&Object.keys(e).length&&this.settings.addItem(e.name,e.key,e.default,e.subitems,e.className)}})});const t=addEvent("controlschanged");this.controls.dispatchEvent(t)}_createCustomControl(t){const e=document.createElement("button"),s=/\.(jpg|png|svg|gif)$/.test(t.icon)?`<img src="${t.icon}">`:t.icon;e.className=`op-controls__${t.id} op-control__${t.position} ${t.showInAds?"":"op-control__hide-in-ad"}`,e.tabIndex=0,e.id=t.id,e.title=t.title,e.innerHTML=`${s} <span class="op-sr">${t.title}</span>`,e.addEventListener("click",t.click,EVENT_OPTIONS),t.layer&&("main"===t.layer?this.player.getContainer().appendChild(e):this.getLayer(t.layer).appendChild(e))}_destroyCustomControl(t){const e=t.title.toLowerCase().replace(" ","-"),s=this.getContainer().querySelector(`.op-controls__${e}`);s&&(s.removeEventListener("click",t.click),removeElement(s))}}export default Controls;