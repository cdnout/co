import{canUseDOM}from"fbjs/lib/ExecutionEnvironment";import createCSSStyleSheet from"./createCSSStyleSheet";import createCompileableStyle from"./createCompileableStyle";import createOrderedCSSStyleSheet from"./createOrderedCSSStyleSheet";import flattenArray from"../../modules/flattenArray";import flattenStyle from"./flattenStyle";import I18nManager from"../I18nManager";import i18nStyle from"./i18nStyle";import{atomic,classic,inline,stringifyValueWithProperty}from"./compile";import initialRules from"./initialRules";import modality from"./modality";import{STYLE_ELEMENT_ID,STYLE_GROUPS}from"./constants";export default function createStyleResolver(){var e,t,r,n={css:{},ltr:{},rtl:{},rtlNoSwap:{}},a=function(){e={css:{},ltr:{},rtl:{},rtlNoSwap:{}},t=createOrderedCSSStyleSheet(createCSSStyleSheet(STYLE_ELEMENT_ID)),r={},modality(function(e){return t.insert(e,STYLE_GROUPS.modality)}),initialRules.forEach(function(e){t.insert(e,STYLE_GROUPS.reset)})};function i(n){var a=I18nManager.doLeftAndRightSwapInRTL,i=I18nManager.isRTL?a?"rtl":"rtlNoSwap":"ltr";if(!e[i][n]){var l=createCompileableStyle(i18nStyle(flattenStyle(n))),o=atomic(l);Object.keys(o).forEach(function(e){var n=o[e],a=n.identifier,i=n.property,l=n.rules,s=n.value;!function(e,t,n){r[t]||(r[t]={}),r[t][n]=e}(a,i,s),l.forEach(function(e){var r=STYLE_GROUPS.custom[i]||STYLE_GROUPS.atomic;t.insert(e,r)})}),e[i][n]=!0}}function l(e,a){var i=I18nManager.doLeftAndRightSwapInRTL,l=I18nManager.isRTL?i?"rtl":"rtlNoSwap":"ltr";if(null!=a&&null!=n[l][a])return n[l][a];var o=flattenStyle(e),s=createCompileableStyle(i18nStyle(o)),c=Object.keys(s).sort().reduce(function(e,n){var a=s[n];if(null!=a){var i=function(e,t){var n=stringifyValueWithProperty(t,e);return r[e]&&r[e].hasOwnProperty(n)&&r[e][n]}(n,a);if(i)e.classList.push(i);else if("animationKeyframes"===n||"placeholderTextColor"===n||"pointerEvents"===n||"scrollbarWidth"===n){var l,o=atomic(((l={})[n]=a,l));Object.keys(o).forEach(function(r){var n=o[r],a=n.identifier,i=n.rules;e.classList.push(a),i.forEach(function(e){t.insert(e,STYLE_GROUPS.atomic)})})}else e.style||(e.style={}),e.style[n]=a}return e},{classList:[]});return c.style&&(c.style=inline(c.style)),null!=a&&(n[l][a]=c),c}return a(),{getStyleSheet:function(){var e=t.getTextContent();return canUseDOM||a(),{id:STYLE_ELEMENT_ID,textContent:e}},createCSS:function(e,t){var r={};return Object.keys(e).forEach(function(a){var i=e[a],l=classic(i,a);Object.keys(l).forEach(function(e){var i=l[e],o=i.identifier,s=i.rules;n.css[o]={group:t||STYLE_GROUPS.classic,rules:s},r[a]=o})}),r},resolve:function(r,a){var o=[],s={};if(!r&&!a)return s;if(Array.isArray(a)&&flattenArray(a).forEach(function(r){if(r){if(null==e.css[r]&&null!=n.css[r]){var a=n.css[r];a.rules.forEach(function(e){t.insert(e,a.group)}),e.css[r]=!0}o.push(r)}}),"number"==typeof r)i(r),s=l(r,createCacheKey(r));else if(Array.isArray(r)){for(var c=flattenArray(r),f=!0,S="",u=0;u<c.length;u++){var y=c[u];"number"!=typeof y?f=!1:(f&&(S+=y+"-"),i(y))}s=l(c,f?createCacheKey(S):null)}else s=l(r);o.push.apply(o,s.classList);var m={className:classListToString(o),classList:o};return s.style&&(m.style=s.style),m},sheet:t}};var createCacheKey=function(e){return"rn-"+e},classListToString=function(e){return e.join(" ").trim()};