import{canUseDOM}from"fbjs/lib/ExecutionEnvironment";import createCSSStyleSheet from"./createCSSStyleSheet";import createCompileableStyle from"./createCompileableStyle";import createOrderedCSSStyleSheet from"./createOrderedCSSStyleSheet";import flattenArray from"../../modules/flattenArray";import flattenStyle from"./flattenStyle";import I18nManager from"../I18nManager";import i18nStyle from"./i18nStyle";import{atomic,classic,inline,stringifyValueWithProperty}from"./compile";import initialRules from"./initialRules";import modality from"./modality";import{STYLE_ELEMENT_ID,STYLE_GROUPS}from"./constants";export default function createStyleResolver(){var t,e,r,n={css:{},ltr:{},rtl:{},rtlNoSwap:{}},a=function(){t={css:{},ltr:{},rtl:{},rtlNoSwap:{}},e=createOrderedCSSStyleSheet(createCSSStyleSheet(STYLE_ELEMENT_ID)),r={},modality(function(t){return e.insert(t,STYLE_GROUPS.modality)}),initialRules.forEach(function(t){e.insert(t,STYLE_GROUPS.reset)})};function i(n){var a=I18nManager.getConstants(),i=a.doLeftAndRightSwapInRTL,l=a.isRTL?i?"rtl":"rtlNoSwap":"ltr";if(!t[l][n]){var o=createCompileableStyle(i18nStyle(flattenStyle(n))),s=atomic(o);Object.keys(s).forEach(function(t){var n=s[t],a=n.identifier,i=n.property,l=n.rules,o=n.value;!function(t,e,n){r[e]||(r[e]={}),r[e][n]=t}(a,i,o),l.forEach(function(t){var r=STYLE_GROUPS.custom[i]||STYLE_GROUPS.atomic;e.insert(t,r)})}),t[l][n]=!0}}function l(t,a){var i=I18nManager.getConstants(),l=i.doLeftAndRightSwapInRTL,o=i.isRTL?l?"rtl":"rtlNoSwap":"ltr";if(null!=a&&null!=n[o][a])return n[o][a];var s=flattenStyle(t),c=createCompileableStyle(i18nStyle(s)),f=Object.keys(c).sort().reduce(function(t,n){var a=c[n];if(null!=a){var i=function(t,e){var n=stringifyValueWithProperty(e,t);return r[t]&&r[t].hasOwnProperty(n)&&r[t][n]}(n,a);if(i)t.classList.push(i);else if("animationKeyframes"===n||"placeholderTextColor"===n||"pointerEvents"===n||"scrollbarWidth"===n){var l,o=atomic(((l={})[n]=a,l));Object.keys(o).forEach(function(r){var n=o[r],a=n.identifier,i=n.rules;t.classList.push(a),i.forEach(function(t){e.insert(t,STYLE_GROUPS.atomic)})})}else t.style||(t.style={}),t.style[n]=a}return t},{classList:[]});return f.style&&(f.style=inline(f.style)),null!=a&&(n[o][a]=f),f}return a(),{getStyleSheet:function(){var t=e.getTextContent();return canUseDOM||a(),{id:STYLE_ELEMENT_ID,textContent:t}},createCSS:function(t,e){var r={};return Object.keys(t).forEach(function(a){var i=t[a],l=classic(i,a);Object.keys(l).forEach(function(t){var i=l[t],o=i.identifier,s=i.rules;n.css[o]={group:e||STYLE_GROUPS.classic,rules:s},r[a]=o})}),r},resolve:function(r,a){var o=[],s={};if(!r&&!a)return s;if(Array.isArray(a)&&flattenArray(a).forEach(function(r){if(r){if(null==t.css[r]&&null!=n.css[r]){var a=n.css[r];a.rules.forEach(function(t){e.insert(t,a.group)}),t.css[r]=!0}o.push(r)}}),"number"==typeof r)i(r),s=l(r,createCacheKey(r));else if(Array.isArray(r)){for(var c=flattenArray(r),f=!0,u="",S=0;S<c.length;S++){var y=c[S];"number"!=typeof y?f=!1:(f&&(u+=y+"-"),i(y))}s=l(c,f?createCacheKey(u):null)}else s=l(r);o.push.apply(o,s.classList);var m={className:classListToString(o),classList:o};return s.style&&(m.style=s.style),m},get sheet(){return e}}};var createCacheKey=function(t){return"rn-"+t},classListToString=function(t){return t.join(" ").trim()};