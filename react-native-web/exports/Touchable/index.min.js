"use strict";function _objectWithoutPropertiesLoose(t,e){if(null==t)return{};var E,s,o={},i=Object.keys(t);for(s=0;s<i.length;s++)E=i[s],e.indexOf(E)>=0||(o[E]=t[E]);return o}function ownKeys(t,e){var E=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),E.push.apply(E,s)}return E}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var E=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(E),!0).forEach(function(e){_defineProperty(t,e,E[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(E)):ownKeys(Object(E)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(E,e))})}return t}function _defineProperty(t,e,E){return e in t?Object.defineProperty(t,e,{value:E,enumerable:!0,configurable:!0,writable:!0}):t[e]=E,t}import AccessibilityUtil from"../../modules/AccessibilityUtil";import BoundingDimensions from"./BoundingDimensions";import findNodeHandle from"../findNodeHandle";import normalizeColor from"normalize-css-color";import Position from"./Position";import React from"react";import UIManager from"../UIManager";import View from"../View";var extractSingleTouch=function(t){var e=t.touches,E=t.changedTouches,s=e&&e.length>0,o=E&&E.length>0;return!s&&o?E[0]:s?e[0]:t},States={NOT_RESPONDER:"NOT_RESPONDER",RESPONDER_INACTIVE_PRESS_IN:"RESPONDER_INACTIVE_PRESS_IN",RESPONDER_INACTIVE_PRESS_OUT:"RESPONDER_INACTIVE_PRESS_OUT",RESPONDER_ACTIVE_PRESS_IN:"RESPONDER_ACTIVE_PRESS_IN",RESPONDER_ACTIVE_PRESS_OUT:"RESPONDER_ACTIVE_PRESS_OUT",RESPONDER_ACTIVE_LONG_PRESS_IN:"RESPONDER_ACTIVE_LONG_PRESS_IN",RESPONDER_ACTIVE_LONG_PRESS_OUT:"RESPONDER_ACTIVE_LONG_PRESS_OUT",ERROR:"ERROR"},baseStatesConditions={NOT_RESPONDER:!1,RESPONDER_INACTIVE_PRESS_IN:!1,RESPONDER_INACTIVE_PRESS_OUT:!1,RESPONDER_ACTIVE_PRESS_IN:!1,RESPONDER_ACTIVE_PRESS_OUT:!1,RESPONDER_ACTIVE_LONG_PRESS_IN:!1,RESPONDER_ACTIVE_LONG_PRESS_OUT:!1,ERROR:!1},IsActive=_objectSpread({},baseStatesConditions,{RESPONDER_ACTIVE_PRESS_OUT:!0,RESPONDER_ACTIVE_PRESS_IN:!0}),IsPressingIn=_objectSpread({},baseStatesConditions,{RESPONDER_INACTIVE_PRESS_IN:!0,RESPONDER_ACTIVE_PRESS_IN:!0,RESPONDER_ACTIVE_LONG_PRESS_IN:!0}),IsLongPressingIn=_objectSpread({},baseStatesConditions,{RESPONDER_ACTIVE_LONG_PRESS_IN:!0}),Signals={DELAY:"DELAY",RESPONDER_GRANT:"RESPONDER_GRANT",RESPONDER_RELEASE:"RESPONDER_RELEASE",RESPONDER_TERMINATED:"RESPONDER_TERMINATED",ENTER_PRESS_RECT:"ENTER_PRESS_RECT",LEAVE_PRESS_RECT:"LEAVE_PRESS_RECT",LONG_PRESS_DETECTED:"LONG_PRESS_DETECTED"},Transitions={NOT_RESPONDER:{DELAY:States.ERROR,RESPONDER_GRANT:States.RESPONDER_INACTIVE_PRESS_IN,RESPONDER_RELEASE:States.ERROR,RESPONDER_TERMINATED:States.ERROR,ENTER_PRESS_RECT:States.ERROR,LEAVE_PRESS_RECT:States.ERROR,LONG_PRESS_DETECTED:States.ERROR},RESPONDER_INACTIVE_PRESS_IN:{DELAY:States.RESPONDER_ACTIVE_PRESS_IN,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_INACTIVE_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_INACTIVE_PRESS_OUT,LONG_PRESS_DETECTED:States.ERROR},RESPONDER_INACTIVE_PRESS_OUT:{DELAY:States.RESPONDER_ACTIVE_PRESS_OUT,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_INACTIVE_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_INACTIVE_PRESS_OUT,LONG_PRESS_DETECTED:States.ERROR},RESPONDER_ACTIVE_PRESS_IN:{DELAY:States.ERROR,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_ACTIVE_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_ACTIVE_PRESS_OUT,LONG_PRESS_DETECTED:States.RESPONDER_ACTIVE_LONG_PRESS_IN},RESPONDER_ACTIVE_PRESS_OUT:{DELAY:States.ERROR,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_ACTIVE_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_ACTIVE_PRESS_OUT,LONG_PRESS_DETECTED:States.ERROR},RESPONDER_ACTIVE_LONG_PRESS_IN:{DELAY:States.ERROR,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_ACTIVE_LONG_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_ACTIVE_LONG_PRESS_OUT,LONG_PRESS_DETECTED:States.RESPONDER_ACTIVE_LONG_PRESS_IN},RESPONDER_ACTIVE_LONG_PRESS_OUT:{DELAY:States.ERROR,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_ACTIVE_LONG_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_ACTIVE_LONG_PRESS_OUT,LONG_PRESS_DETECTED:States.ERROR},error:{DELAY:States.NOT_RESPONDER,RESPONDER_GRANT:States.RESPONDER_INACTIVE_PRESS_IN,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.NOT_RESPONDER,LEAVE_PRESS_RECT:States.NOT_RESPONDER,LONG_PRESS_DETECTED:States.NOT_RESPONDER}},HIGHLIGHT_DELAY_MS=130,PRESS_EXPAND_PX=20,LONG_PRESS_THRESHOLD=500,LONG_PRESS_DELAY_MS=LONG_PRESS_THRESHOLD-HIGHLIGHT_DELAY_MS,LONG_PRESS_ALLOWED_MOVEMENT=10,TouchableMixin={componentDidMount:function(){var t=this;this._touchableNode=findNodeHandle(this),this._touchableNode&&this._touchableNode.addEventListener&&(this._touchableBlurListener=function(e){t._isTouchableKeyboardActive&&(t.state.touchable.touchState&&t.state.touchable.touchState!==States.NOT_RESPONDER&&t.touchableHandleResponderTerminate({nativeEvent:e}),t._isTouchableKeyboardActive=!1)},this._touchableNode.addEventListener("blur",this._touchableBlurListener))},componentWillUnmount:function(){this._touchableNode&&this._touchableNode.addEventListener&&this._touchableNode.removeEventListener("blur",this._touchableBlurListener),this.touchableDelayTimeout&&clearTimeout(this.touchableDelayTimeout),this.longPressDelayTimeout&&clearTimeout(this.longPressDelayTimeout),this.pressOutDelayTimeout&&clearTimeout(this.pressOutDelayTimeout)},touchableGetInitialState:function(){return{touchable:{touchState:void 0,responderID:null}}},touchableHandleResponderTerminationRequest:function(){return!this.props.rejectResponderTermination},touchableHandleStartShouldSetResponder:function(){return!this.props.disabled},touchableLongPressCancelsPress:function(){return!0},touchableHandleResponderGrant:function(t){var e=t.currentTarget;t.persist(),this.pressOutDelayTimeout&&clearTimeout(this.pressOutDelayTimeout),this.pressOutDelayTimeout=null,this.state.touchable.touchState=States.NOT_RESPONDER,this.state.touchable.responderID=e,this._receiveSignal(Signals.RESPONDER_GRANT,t);var E=void 0!==this.touchableGetHighlightDelayMS?Math.max(this.touchableGetHighlightDelayMS(),0):HIGHLIGHT_DELAY_MS;0!==(E=isNaN(E)?HIGHLIGHT_DELAY_MS:E)?this.touchableDelayTimeout=setTimeout(this._handleDelay.bind(this,t),E):this._handleDelay(t);var s=void 0!==this.touchableGetLongPressDelayMS?Math.max(this.touchableGetLongPressDelayMS(),10):LONG_PRESS_DELAY_MS;s=isNaN(s)?LONG_PRESS_DELAY_MS:s,this.longPressDelayTimeout=setTimeout(this._handleLongDelay.bind(this,t),s+E)},touchableHandleResponderRelease:function(t){this.pressInLocation=null,this._receiveSignal(Signals.RESPONDER_RELEASE,t)},touchableHandleResponderTerminate:function(t){this.pressInLocation=null,this._receiveSignal(Signals.RESPONDER_TERMINATED,t)},touchableHandleResponderMove:function(t){if(this.state.touchable.positionOnActivate){var e=this.state.touchable.positionOnActivate,E=this.state.touchable.dimensionsOnActivate,s=this.touchableGetPressRectOffset?this.touchableGetPressRectOffset():{left:PRESS_EXPAND_PX,right:PRESS_EXPAND_PX,top:PRESS_EXPAND_PX,bottom:PRESS_EXPAND_PX},o=s.left,i=s.top,R=s.right,a=s.bottom,S=this.touchableGetHitSlop?this.touchableGetHitSlop():null;S&&(o+=S.left||0,i+=S.top||0,R+=S.right||0,a+=S.bottom||0);var n=extractSingleTouch(t.nativeEvent),_=n&&n.pageX,r=n&&n.pageY;if(this.pressInLocation)this._getDistanceBetweenPoints(_,r,this.pressInLocation.pageX,this.pressInLocation.pageY)>LONG_PRESS_ALLOWED_MOVEMENT&&this._cancelLongPressDelayTimeout();if(_>e.left-o&&r>e.top-i&&_<e.left+E.width+R&&r<e.top+E.height+a){var l=this.state.touchable.touchState;this._receiveSignal(Signals.ENTER_PRESS_RECT,t),this.state.touchable.touchState===States.RESPONDER_INACTIVE_PRESS_IN&&l!==States.RESPONDER_INACTIVE_PRESS_IN&&this._cancelLongPressDelayTimeout()}else this._cancelLongPressDelayTimeout(),this._receiveSignal(Signals.LEAVE_PRESS_RECT,t)}},touchableHandleFocus:function(t){this.props.onFocus&&this.props.onFocus(t)},touchableHandleBlur:function(t){this.props.onBlur&&this.props.onBlur(t)},_remeasureMetricsOnActivation:function(){var t=this.state.touchable.responderID;null!=t&&UIManager.measure(t,this._handleQueryLayout)},_handleQueryLayout:function(t,e,E,s,o,i){(t||e||E||s||o||i)&&(this.state.touchable.positionOnActivate&&Position.release(this.state.touchable.positionOnActivate),this.state.touchable.dimensionsOnActivate&&BoundingDimensions.release(this.state.touchable.dimensionsOnActivate),this.state.touchable.positionOnActivate=Position.getPooled(o,i),this.state.touchable.dimensionsOnActivate=BoundingDimensions.getPooled(E,s))},_handleDelay:function(t){this.touchableDelayTimeout=null,this._receiveSignal(Signals.DELAY,t)},_handleLongDelay:function(t){this.longPressDelayTimeout=null;var e=this.state.touchable.touchState;e!==States.RESPONDER_ACTIVE_PRESS_IN&&e!==States.RESPONDER_ACTIVE_LONG_PRESS_IN?console.error("Attempted to transition from state `"+e+"` to `"+States.RESPONDER_ACTIVE_LONG_PRESS_IN+"`, which is not supported. This is most likely due to `Touchable.longPressDelayTimeout` not being cancelled."):this._receiveSignal(Signals.LONG_PRESS_DETECTED,t)},_receiveSignal:function(t,e){var E=this.state.touchable.responderID,s=this.state.touchable.touchState,o=Transitions[s]&&Transitions[s][t];if(E||t!==Signals.RESPONDER_RELEASE){if(!o)throw new Error("Unrecognized signal `"+t+"` or state `"+s+"` for Touchable responder `"+E+"`");if(o===States.ERROR)throw new Error("Touchable cannot transition from `"+s+"` to `"+t+"` for responder `"+E+"`");s!==o&&(this._performSideEffectsForTransition(s,o,t,e),this.state.touchable.touchState=o)}},_cancelLongPressDelayTimeout:function(){this.longPressDelayTimeout&&clearTimeout(this.longPressDelayTimeout),this.longPressDelayTimeout=null},_isHighlight:function(t){return t===States.RESPONDER_ACTIVE_PRESS_IN||t===States.RESPONDER_ACTIVE_LONG_PRESS_IN},_savePressInLocation:function(t){var e=extractSingleTouch(t.nativeEvent),E=e&&e.pageX,s=e&&e.pageY,o=e&&e.locationX,i=e&&e.locationY;this.pressInLocation={pageX:E,pageY:s,locationX:o,locationY:i}},_getDistanceBetweenPoints:function(t,e,E,s){var o=t-E,i=e-s;return Math.sqrt(o*o+i*i)},_performSideEffectsForTransition:function(t,e,E,s){var o=this._isHighlight(t),i=this._isHighlight(e);(E===Signals.RESPONDER_TERMINATED||E===Signals.RESPONDER_RELEASE)&&this._cancelLongPressDelayTimeout();var R=t===States.NOT_RESPONDER&&e===States.RESPONDER_INACTIVE_PRESS_IN,a=!IsActive[t]&&IsActive[e];if((R||a)&&this._remeasureMetricsOnActivation(),IsPressingIn[t]&&E===Signals.LONG_PRESS_DETECTED&&this.touchableHandleLongPress&&this.touchableHandleLongPress(s),i&&!o?this._startHighlight(s):!i&&o&&this._endHighlight(s),IsPressingIn[t]&&E===Signals.RESPONDER_RELEASE){var S=!!this.props.onLongPress,n=IsLongPressingIn[t]&&(!S||!this.touchableLongPressCancelsPress());(!IsLongPressingIn[t]||n)&&this.touchableHandlePress&&(i||o||(this._startHighlight(s),this._endHighlight(s)),this.touchableHandlePress(s))}this.touchableDelayTimeout&&clearTimeout(this.touchableDelayTimeout),this.touchableDelayTimeout=null},_playTouchSound:function(){UIManager.playTouchSound()},_startHighlight:function(t){this._savePressInLocation(t),this.touchableHandleActivePressIn&&this.touchableHandleActivePressIn(t)},_endHighlight:function(t){var e=this;this.touchableHandleActivePressOut&&(this.touchableGetPressOutDelayMS&&this.touchableGetPressOutDelayMS()?this.pressOutDelayTimeout=setTimeout(function(){e.touchableHandleActivePressOut(t)},this.touchableGetPressOutDelayMS()):this.touchableHandleActivePressOut(t))},touchableHandleKeyEvent:function(t){var e=t.type,E=t.key;"Enter"!==E&&" "!==E||("keydown"===e?this._isTouchableKeyboardActive||this.state.touchable.touchState&&this.state.touchable.touchState!==States.NOT_RESPONDER||(this.touchableHandleResponderGrant(t),this._isTouchableKeyboardActive=!0):"keyup"===e&&this._isTouchableKeyboardActive&&this.state.touchable.touchState&&this.state.touchable.touchState!==States.NOT_RESPONDER&&(this.touchableHandleResponderRelease(t),this._isTouchableKeyboardActive=!1),t.stopPropagation(),"Enter"===E&&"link"===AccessibilityUtil.propsToAriaRole(this.props)||t.preventDefault())},withoutDefaultFocusAndBlur:{}},touchableHandleFocus=TouchableMixin.touchableHandleFocus,touchableHandleBlur=TouchableMixin.touchableHandleBlur,TouchableMixinWithoutDefaultFocusAndBlur=_objectWithoutPropertiesLoose(TouchableMixin,["touchableHandleFocus","touchableHandleBlur"]);TouchableMixin.withoutDefaultFocusAndBlur=TouchableMixinWithoutDefaultFocusAndBlur;var Touchable={Mixin:TouchableMixin,TOUCH_TARGET_DEBUG:!1,renderDebugView:function(t){var e=t.color,E=t.hitSlop;if(!Touchable.TOUCH_TARGET_DEBUG)return null;if("production"!==process.env.NODE_ENV)throw Error("Touchable.TOUCH_TARGET_DEBUG should not be enabled in prod!");var s={};for(var o in E=E||{top:0,bottom:0,left:0,right:0})s[o]=-E[o];var i=normalizeColor(e);if("number"!=typeof i)return null;var R="#"+("00000000"+i.toString(16)).substr(-8);return React.createElement(View,{pointerEvents:"none",style:_objectSpread({position:"absolute",borderColor:R.slice(0,-2)+"55",borderWidth:1,borderStyle:"dashed",backgroundColor:R.slice(0,-2)+"0F"},s)})}};export default Touchable;