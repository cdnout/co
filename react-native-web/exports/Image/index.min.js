function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e}).apply(this,arguments)}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var r,o,n={},a=Object.keys(e);for(o=0;o<a.length;o++)r=a[o],t.indexOf(r)>=0||(n[r]=e[r]);return n}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,o)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}import createElement from"../createElement";import css from"../StyleSheet/css";import{getAssetByID}from"../../modules/AssetRegistry";import resolveShadowValue from"../StyleSheet/resolveShadowValue";import ImageLoader from"../../modules/ImageLoader";import PixelRatio from"../PixelRatio";import StyleSheet from"../StyleSheet";import TextAncestorContext from"../Text/TextAncestorContext";import View from"../View";import React,{forwardRef,useContext,useEffect,useRef,useState}from"react";var ERRORED="ERRORED",LOADED="LOADED",LOADING="LOADING",IDLE="IDLE",_filterId=0,svgDataUriPattern=/^(data:image\/svg\+xml;utf8,)(.*)/;function createTintColorSVG(e,t){return e&&null!=t?React.createElement("svg",{style:{position:"absolute",height:0,visibility:"hidden",width:0}},React.createElement("defs",null,React.createElement("filter",{id:"tint-"+t,suppressHydrationWarning:!0},React.createElement("feFlood",{floodColor:""+e,key:e}),React.createElement("feComposite",{in2:"SourceAlpha",operator:"atop"})))):null}function getFlatStyle(e,t,r){var o=_objectSpread({},StyleSheet.flatten(e)),n=o.filter,a=o.resizeMode,i=o.shadowOffset,l=o.tintColor,s=[],c=null;if(n&&s.push(n),t&&s.push("blur("+t+"px)"),i){var u=resolveShadowValue(o);u&&s.push("drop-shadow("+u+")")}return l&&null!=r&&s.push("url(#tint-"+r+")"),s.length>0&&(c=s.join(" ")),delete o.blurRadius,delete o.shadowColor,delete o.shadowOpacity,delete o.shadowOffset,delete o.shadowRadius,delete o.tintColor,delete o.overlayColor,delete o.resizeMode,[o,a,c,l]}function resolveAssetDimensions(e){if("number"==typeof e){var t=getAssetByID(e);return{height:t.height,width:t.width}}if(null!=e&&!Array.isArray(e)&&"object"==typeof e)return{height:e.height,width:e.width}}function resolveAssetUri(e){var t=null;if("number"==typeof e){var r=getAssetByID(e),o=r.scales[0];if(r.scales.length>1){var n=PixelRatio.get();o=r.scales.reduce(function(e,t){return Math.abs(t-n)<Math.abs(e-n)?t:e})}var a=1!==o?"@"+o+"x":"";t=r?r.httpServerLocation+"/"+r.name+a+"."+r.type:""}else"string"==typeof e?t=e:e&&"string"==typeof e.uri&&(t=e.uri);if(t){var i=t.match(svgDataUriPattern);if(i){var l=i[1],s=i[2];return""+l+encodeURIComponent(s)}}return t}var Image=forwardRef(function(e,t){var r=e.accessibilityLabel,o=e.blurRadius,n=e.defaultSource,a=e.draggable,i=e.onError,l=e.onLayout,s=e.onLoad,c=e.onLoadEnd,u=e.onLoadStart,d=e.pointerEvents,f=e.source,g=e.style,p=_objectWithoutPropertiesLoose(e,["accessibilityLabel","blurRadius","defaultSource","draggable","onError","onLayout","onLoad","onLoadEnd","onLoadStart","pointerEvents","source","style"]);if("production"!==process.env.NODE_ENV&&e.children)throw new Error("The <Image> component cannot contain children. If you want to render content on top of the image, consider using the <ImageBackground> component or absolute positioning.");var h=useState(function(){var e=resolveAssetUri(f);if(null!=e&&ImageLoader.has(e))return LOADED;return IDLE}),y=h[0],m=h[1],b=useState({}),v=b[0],S=b[1],O=useContext(TextAncestorContext),E=useRef(null),w=useRef(_filterId++),I=useRef(null),L=y===LOADED||y===LOADING&&null==n,R=getFlatStyle(g,o,w.current),D=R[0],x=R[1],j=R[2],A=R[3],P=e.resizeMode||x||"cover",k=L?f:n,z=resolveAssetUri(k),C=resolveAssetDimensions(k),_=z?'url("'+z+'")':null,M=function(){if(null!=E.current&&("center"===P||"repeat"===P)){var e=E.current,t=e.naturalHeight,r=e.naturalWidth,o=v.height,n=v.width;if(t&&r&&o&&n){var a=Math.min(1,n/r,o/t),i=Math.ceil(a*r),l=Math.ceil(a*t);return i+"px "+l+"px"}}}(),V=z?createElement("img",{alt:r||"",classList:[classes.accessibilityImage],draggable:a||!1,ref:E,src:z}):null;var N=resolveAssetUri(f);return useEffect(function(){function e(){null!=I.current&&(ImageLoader.abort(I.current),I.current=null)}return e(),null!=N&&(m(LOADING),u&&u(),I.current=ImageLoader.load(N,function(e){m(LOADED),s&&s(e),c&&c()},function(){m(ERRORED),i&&i({nativeEvent:{error:"Failed to load resource "+N+" (404)"}}),c&&c()})),e},[N,I,m,i,s,c,u]),React.createElement(View,_extends({},p,{accessibilityLabel:r,onLayout:function(e){if("center"===P||"repeat"===P||l){var t=e.nativeEvent.layout;l&&l(e),S(t)}},pointerEvents:d,ref:t,style:[styles.root,O&&styles.inline,C,D]}),React.createElement(View,{style:[styles.image,resizeModeStyles[P],{backgroundImage:_,filter:j},null!=M&&{backgroundSize:M}],suppressHydrationWarning:!0}),V,createTintColorSVG(A,w.current))});Image.displayName="Image",Image.getSize=function(e,t,r){ImageLoader.getSize(e,t,r)},Image.prefetch=function(e){return ImageLoader.prefetch(e)},Image.queryCache=function(e){return ImageLoader.queryCache(e)};var classes=css.create({accessibilityImage:_objectSpread({},StyleSheet.absoluteFillObject,{height:"100%",opacity:0,width:"100%",zIndex:-1})}),styles=StyleSheet.create({root:{flexBasis:"auto",overflow:"hidden",zIndex:0},inline:{display:"inline-flex"},image:_objectSpread({},StyleSheet.absoluteFillObject,{backgroundColor:"transparent",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundSize:"cover",height:"100%",width:"100%",zIndex:-1})}),resizeModeStyles=StyleSheet.create({center:{backgroundSize:"auto"},contain:{backgroundSize:"contain"},cover:{backgroundSize:"cover"},none:{backgroundPosition:"0 0",backgroundSize:"auto"},repeat:{backgroundPosition:"0 0",backgroundRepeat:"repeat",backgroundSize:"auto"},stretch:{backgroundSize:"100% 100%"}});export default Image;