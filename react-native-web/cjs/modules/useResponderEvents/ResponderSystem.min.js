"use strict";exports.__esModule=!0,exports.attachListeners=attachListeners,exports.addNode=addNode,exports.removeNode=removeNode,exports.terminateResponder=terminateResponder,exports.getResponderNode=getResponderNode;var _ExecutionEnvironment=require("fbjs/lib/ExecutionEnvironment"),_createResponderEvent=_interopRequireDefault(require("./createResponderEvent")),_ResponderEventTypes=require("./ResponderEventTypes"),_utils=require("./utils"),_ResponderTouchHistoryStore=_interopRequireDefault(require("./ResponderTouchHistoryStore"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var emptyObject={},startRegistration=["onStartShouldSetResponderCapture","onStartShouldSetResponder",{bubbles:!0}],moveRegistration=["onMoveShouldSetResponderCapture","onMoveShouldSetResponder",{bubbles:!0}],scrollRegistration=["onScrollShouldSetResponderCapture","onScrollShouldSetResponder",{bubbles:!1}],shouldSetResponderEvents={touchstart:startRegistration,mousedown:startRegistration,touchmove:moveRegistration,mousemove:moveRegistration,scroll:scrollRegistration},emptyResponder={id:null,idPath:null,node:null},responderListenersMap=new Map,isEmulatingMouseEvents=!1,trackedTouchCount=0,currentResponder={id:null,node:null,idPath:null};function changeCurrentResponder(e){currentResponder=e}function getResponderConfig(e){e=responderListenersMap.get(e);return null!=e?e:emptyObject}function eventListener(e){var n,t,r,o,s,i,u,d,a,l,c,p,R,g,h=e.type,m=e.target;"touchstart"===h&&(isEmulatingMouseEvents=!0),("touchmove"===h||1<trackedTouchCount)&&(isEmulatingMouseEvents=!1),"mousedown"===h&&isEmulatingMouseEvents||"mousemove"===h&&isEmulatingMouseEvents||"mousemove"===h&&trackedTouchCount<1||(isEmulatingMouseEvents&&"mouseup"===h?0===trackedTouchCount&&(isEmulatingMouseEvents=!1):(n=(0,_ResponderEventTypes.isStartish)(h)&&(0,_utils.isPrimaryPointerDown)(e),t=(0,_ResponderEventTypes.isMoveish)(h),r=(0,_ResponderEventTypes.isEndish)(h),o=(0,_ResponderEventTypes.isScroll)(h),g=(0,_ResponderEventTypes.isSelectionChange)(h),s=(0,_createResponderEvent.default)(e),(n||t||r)&&(e.touches?trackedTouchCount=e.touches.length:n?trackedTouchCount=1:r&&(trackedTouchCount=0),_ResponderTouchHistoryStore.default.recordTouchTrack(h,s.nativeEvent)),l=(0,_utils.getResponderPaths)(e),i=!1,(n||t||o&&0<trackedTouchCount)&&(u=currentResponder.idPath,d=l.idPath,null!=u&&null!=d&&(l=null!=(R=(0,_utils.getLowestCommonAncestor)(u,d))?(a=d.indexOf(R)+(R===currentResponder.id?1:0),{idPath:d.slice(a),nodePath:l.nodePath.slice(a)}):null),null!=l&&null!=(c=findWantsResponder(l,e,s))&&(attemptTransfer(s,c),i=!0)),null!=currentResponder.id&&null!=currentResponder.node&&(p=currentResponder.id,u=currentResponder.node,d=(R=getResponderConfig(p)).onResponderStart,a=R.onResponderMove,l=R.onResponderEnd,c=R.onResponderRelease,p=R.onResponderTerminate,R=R.onResponderTerminationRequest,s.bubbles=!1,s.cancelable=!1,s.currentTarget=u,n?null!=d&&(s.dispatchConfig.registrationName="onResponderStart",d(s)):t?null!=a&&(s.dispatchConfig.registrationName="onResponderMove",a(s)):(g=(0,_ResponderEventTypes.isCancelish)(h)||"contextmenu"===h||"blur"===h&&m===window||"blur"===h&&m.contains(u)&&e.relatedTarget!==u||o&&0===trackedTouchCount||o&&m.contains(u)&&m!==u||g&&(0,_utils.hasValidSelection)(e),e=r&&!g&&!(0,_utils.hasTargetTouches)(u,e.touches),r&&null!=l&&(s.dispatchConfig.registrationName="onResponderEnd",l(s)),e&&(null!=c&&(s.dispatchConfig.registrationName="onResponderRelease",c(s)),changeCurrentResponder(emptyResponder)),g&&(g=!0,"contextmenu"!==h&&"scroll"!==h&&"selectionchange"!==h||(i||null!=R&&!(s.dispatchConfig.registrationName="onResponderTerminationRequest")===R(s))&&(g=!1),g&&(null!=p&&(s.dispatchConfig.registrationName="onResponderTerminate",p(s)),changeCurrentResponder(emptyResponder),isEmulatingMouseEvents=!1,trackedTouchCount=0))))))}function findWantsResponder(e,n,r){var t=shouldSetResponderEvents[n.type];if(null!=t){for(var o=e.idPath,s=e.nodePath,i=t[0],u=t[1],e=t[2].bubbles,d=function(e,n,t){t=getResponderConfig(e)[t];if(null!=t&&(r.currentTarget=n,!0===t(r)))return{id:e,node:n,idPath:o.slice(o.indexOf(e))}},a=o.length-1;0<=a;a--){var l=d(o[a],s[a],i);if(null!=l)return l;if(!0===r.isPropagationStopped())return}if(e)for(var c=0;c<o.length;c++){var p=d(o[c],s[c],u);if(null!=p)return p;if(!0===r.isPropagationStopped())return}else{t=o[0],e=s[0];if(n.target===e)return d(t,e,u)}}}function attemptTransfer(e,n){var t=currentResponder.id,r=currentResponder.node,o=n.id,s=n.node,i=getResponderConfig(o),u=i.onResponderGrant,d=i.onResponderReject;e.bubbles=!1,e.cancelable=!1,e.currentTarget=s,null==t?(null!=u&&(e.currentTarget=s,e.dispatchConfig.registrationName="onResponderGrant",u(e)),changeCurrentResponder(n)):(i=(o=getResponderConfig(t)).onResponderTerminate,t=!0,null!=(o=o.onResponderTerminationRequest)&&(e.currentTarget=r,!(e.dispatchConfig.registrationName="onResponderTerminationRequest")===o(e)&&(t=!1)),t?(null!=i&&(e.currentTarget=r,e.dispatchConfig.registrationName="onResponderTerminate",i(e)),null!=u&&(e.currentTarget=s,e.dispatchConfig.registrationName="onResponderGrant",u(e)),changeCurrentResponder(n)):null!=d&&(e.currentTarget=s,e.dispatchConfig.registrationName="onResponderReject",d(e)))}var documentEventsCapturePhase=["blur","scroll"],documentEventsBubblePhase=["mousedown","mousemove","mouseup","dragstart","touchstart","touchmove","touchend","touchcancel","contextmenu","select","selectionchange"];function attachListeners(){_ExecutionEnvironment.canUseDOM&&null==window.__reactResponderSystemActive&&(window.addEventListener("blur",eventListener),documentEventsBubblePhase.forEach(function(e){document.addEventListener(e,eventListener)}),documentEventsCapturePhase.forEach(function(e){document.addEventListener(e,eventListener,!0)}),window.__reactResponderSystemActive=!0)}function addNode(e,n,t){(0,_utils.setResponderId)(n,e),responderListenersMap.set(e,t)}function removeNode(e){currentResponder.id===e&&terminateResponder(),responderListenersMap.has(e)&&responderListenersMap.delete(e)}function terminateResponder(){var e,n=currentResponder.id,t=currentResponder.node;null!=n&&null!=t&&(null!=(e=getResponderConfig(n).onResponderTerminate)&&((n=(0,_createResponderEvent.default)({})).currentTarget=t,e(n)),changeCurrentResponder(emptyResponder)),isEmulatingMouseEvents=!1,trackedTouchCount=0}function getResponderNode(){return currentResponder.node}