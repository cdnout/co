"use strict";exports.__esModule=!0,exports.attachListeners=attachListeners,exports.addNode=addNode,exports.removeNode=removeNode,exports.terminateResponder=terminateResponder,exports.getResponderNode=getResponderNode;var _createResponderEvent=_interopRequireDefault(require("./createResponderEvent")),_ResponderEventTypes=require("./ResponderEventTypes"),_utils=require("./utils"),_ResponderTouchHistoryStore=_interopRequireDefault(require("./ResponderTouchHistoryStore")),_ExecutionEnvironment=_interopRequireDefault(require("fbjs/lib/ExecutionEnvironment"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var canUseDOM=_ExecutionEnvironment.default.canUseDOM,emptyObject={},startRegistration=["onStartShouldSetResponderCapture","onStartShouldSetResponder",{bubbles:!0}],moveRegistration=["onMoveShouldSetResponderCapture","onMoveShouldSetResponder",{bubbles:!0}],scrollRegistration=["onScrollShouldSetResponderCapture","onScrollShouldSetResponder",{bubbles:!1}],shouldSetResponderEvents={touchstart:startRegistration,mousedown:startRegistration,touchmove:moveRegistration,mousemove:moveRegistration,scroll:scrollRegistration},emptyResponder={id:null,idPath:null,node:null},responderListenersMap=new Map,isEmulatingMouseEvents=!1,trackedTouchCount=0,currentResponder={id:null,node:null,idPath:null};function changeCurrentResponder(e){currentResponder=e}function getResponderConfig(e){e=responderListenersMap.get(e);return null!=e?e:emptyObject}function eventListener(e){var n,t,r,o,s,i,u,a,d,l,c,p,R,g,h=e.type,m=e.target;"touchstart"===h&&(isEmulatingMouseEvents=!0),("touchmove"===h||1<trackedTouchCount)&&(isEmulatingMouseEvents=!1),"mousedown"===h&&isEmulatingMouseEvents||"mousemove"===h&&isEmulatingMouseEvents||"mousemove"===h&&trackedTouchCount<1||(isEmulatingMouseEvents&&"mouseup"===h?0===trackedTouchCount&&(isEmulatingMouseEvents=!1):(n=(0,_ResponderEventTypes.isStartish)(h)&&(0,_utils.isPrimaryPointerDown)(e),t=(0,_ResponderEventTypes.isMoveish)(h),r=(0,_ResponderEventTypes.isEndish)(h),o=(0,_ResponderEventTypes.isScroll)(h),g=(0,_ResponderEventTypes.isSelectionChange)(h),s=(0,_createResponderEvent.default)(e),(n||t||r)&&(e.touches?trackedTouchCount=e.touches.length:n?trackedTouchCount=1:r&&(trackedTouchCount=0),_ResponderTouchHistoryStore.default.recordTouchTrack(h,s.nativeEvent)),d=(0,_utils.getResponderPaths)(e),i=!1,(n||t||o&&0<trackedTouchCount)&&(p=currentResponder.idPath,R=d.idPath,null!=(d=null!=p&&null!=R?null!=(u=(0,_utils.getLowestCommonAncestor)(p,R))?(a=R.indexOf(u)+(u===currentResponder.id?1:0),{idPath:R.slice(a),nodePath:d.nodePath.slice(a)}):null:d)&&null!=(l=findWantsResponder(d,e,s))&&(attemptTransfer(s,l),i=!0)),null!=currentResponder.id&&null!=currentResponder.node&&(p=(c=currentResponder).id,u=c.node,a=(R=getResponderConfig(p)).onResponderStart,d=R.onResponderMove,l=R.onResponderEnd,c=R.onResponderRelease,p=R.onResponderTerminate,R=R.onResponderTerminationRequest,s.bubbles=!1,s.cancelable=!1,s.currentTarget=u,n?null!=a&&(s.dispatchConfig.registrationName="onResponderStart",a(s)):t?null!=d&&(s.dispatchConfig.registrationName="onResponderMove",d(s)):(g=(0,_ResponderEventTypes.isCancelish)(h)||"contextmenu"===h||"blur"===h&&m===window||"blur"===h&&m.contains(u)&&e.relatedTarget!==u||o&&0===trackedTouchCount||o&&m.contains(u)&&m!==u||g&&(0,_utils.hasValidSelection)(e),e=r&&!g&&!(0,_utils.hasTargetTouches)(u,e.touches),r&&null!=l&&(s.dispatchConfig.registrationName="onResponderEnd",l(s)),e&&(null!=c&&(s.dispatchConfig.registrationName="onResponderRelease",c(s)),changeCurrentResponder(emptyResponder)),g&&(g=!0,"contextmenu"!==h&&"scroll"!==h&&"selectionchange"!==h||(i||null!=R&&!(s.dispatchConfig.registrationName="onResponderTerminationRequest")===R(s))&&(g=!1),g&&(null!=p&&(s.dispatchConfig.registrationName="onResponderTerminate",p(s)),changeCurrentResponder(emptyResponder),isEmulatingMouseEvents=!1,trackedTouchCount=0))))))}function findWantsResponder(e,n,r){var t=shouldSetResponderEvents[n.type];if(null!=t){for(var o=e.idPath,s=e.nodePath,i=t[0],u=t[1],e=t[2].bubbles,a=function(e,n,t){t=getResponderConfig(e)[t];if(null!=t&&(r.currentTarget=n,!0===t(r)))return{id:e,node:n,idPath:o.slice(o.indexOf(e))}},d=o.length-1;0<=d;d--){var l=a(o[d],s[d],i);if(null!=l)return l;if(!0===r.isPropagationStopped())return}if(e)for(var c=0;c<o.length;c++){var p=a(o[c],s[c],u);if(null!=p)return p;if(!0===r.isPropagationStopped())return}else{t=o[0],e=s[0];if(n.target===e)return a(t,e,u)}}}function attemptTransfer(e,n){var t=currentResponder,r=t.id,o=t.node,s=n.id,i=n.node,u=getResponderConfig(s),a=u.onResponderGrant,t=u.onResponderReject;e.bubbles=!1,e.cancelable=!1,e.currentTarget=i,null==r?(null!=a&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderGrant",a(e)),changeCurrentResponder(n)):(u=(s=getResponderConfig(r)).onResponderTerminate,r=!0,null!=(s=s.onResponderTerminationRequest)&&(e.currentTarget=o,!(e.dispatchConfig.registrationName="onResponderTerminationRequest")===s(e)&&(r=!1)),r?(null!=u&&(e.currentTarget=o,e.dispatchConfig.registrationName="onResponderTerminate",u(e)),null!=a&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderGrant",a(e)),changeCurrentResponder(n)):null!=t&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderReject",t(e)))}var documentEventsCapturePhase=["blur","scroll"],documentEventsBubblePhase=["mousedown","mousemove","mouseup","dragstart","touchstart","touchmove","touchend","touchcancel","contextmenu","select","selectionchange"];function attachListeners(){canUseDOM&&null==window.__reactResponderSystemActive&&(window.addEventListener("blur",eventListener),documentEventsBubblePhase.forEach(function(e){document.addEventListener(e,eventListener)}),documentEventsCapturePhase.forEach(function(e){document.addEventListener(e,eventListener,!0)}),window.__reactResponderSystemActive=!0)}function addNode(e,n,t){(0,_utils.setResponderId)(n,e),responderListenersMap.set(e,t)}function removeNode(e){currentResponder.id===e&&terminateResponder(),responderListenersMap.has(e)&&responderListenersMap.delete(e)}function terminateResponder(){var e=currentResponder,n=e.id,t=e.node;null!=n&&null!=t&&(null!=(e=getResponderConfig(n).onResponderTerminate)&&((n=(0,_createResponderEvent.default)({})).currentTarget=t,e(n)),changeCurrentResponder(emptyResponder)),isEmulatingMouseEvents=!1,trackedTouchCount=0}function getResponderNode(){return currentResponder.node}