"use strict";function ownKeys(t,e){var r,i=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,r)),i}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _createForOfIteratorHelperLoose(e,t){var r;if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator])return(r=e[Symbol.iterator]()).next.bind(r);if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}import invariant from"fbjs/lib/invariant";var ViewabilityHelper=function(){function e(e){void 0===e&&(e={viewAreaCoveragePercentThreshold:0}),this._hasInteracted=!1,this._timers=new Set,this._viewableIndices=[],this._viewableItems=new Map,this._config=e}var t=e.prototype;return t.dispose=function(){this._timers.forEach(clearTimeout)},t.computeViewableItems=function(e,t,r,i,n){var o=this._config,a=o.itemVisiblePercentThreshold,o=o.viewAreaCoveragePercentThreshold,s=null!=o,l=s?o:a;invariant(null!=l&&null!=a!=(null!=o),"Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold");var c=[];if(0===e)return c;var u=-1,a=n||{first:0,last:e-1},o=a.first,f=a.last;if(e<=f)return console.warn("Invalid render range computing viewability "+JSON.stringify({renderRange:n,itemCount:e})),[];for(var b=o;b<=f;b++){var h=i(b);if(h){var p=h.offset-t,y=p+h.length;if(p<r&&0<y)u=b,_isViewable(s,l,p,y,r,h.length)&&c.push(b);else if(0<=u)break}}return c},t.onUpdate=function(e,t,r,i,n,o,a){var s,l,c=this;this._config.waitForInteraction&&!this._hasInteracted||0===e||!i(0)||(s=[],e&&(s=this.computeViewableItems(e,t,r,i,a)),this._viewableIndices.length===s.length&&this._viewableIndices.every(function(e,t){return e===s[t]})||(this._viewableIndices=s,this._config.minimumViewTime?(l=setTimeout(function(){c._timers.delete(l),c._onUpdateSync(s,o,n)},this._config.minimumViewTime),this._timers.add(l)):this._onUpdateSync(s,o,n)))},t.resetViewableIndices=function(){this._viewableIndices=[]},t.recordInteraction=function(){this._hasInteracted=!0},t._onUpdateSync=function(e,t,r){var i=this;e=e.filter(function(e){return i._viewableIndices.includes(e)});for(var n=this._viewableItems,o=new Map(e.map(function(e){e=r(e,!0);return[e.key,e]})),a=[],s=_createForOfIteratorHelperLoose(o);!(c=s()).done;){var l=c.value,c=l[0],l=l[1];n.has(c)||a.push(l)}for(var u=_createForOfIteratorHelperLoose(n);!(b=u()).done;){var f=b.value,b=f[0],f=f[1];o.has(b)||a.push(_objectSpread(_objectSpread({},f),{},{isViewable:!1}))}0<a.length&&(this._viewableItems=o,t({viewableItems:Array.from(o.values()),changed:a,viewabilityConfig:this._config}))},e}();function _isViewable(e,t,r,i,n,o){if(_isEntirelyVisible(r,i,n))return!0;i=_getPixelsVisible(r,i,n);return t<=100*(e?i/n:i/o)}function _getPixelsVisible(e,t,r){e=Math.min(t,r)-Math.max(e,0);return Math.max(0,e)}function _isEntirelyVisible(e,t,r){return 0<=e&&t<=r&&e<t}export default ViewabilityHelper;