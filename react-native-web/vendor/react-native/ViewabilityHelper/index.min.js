"use strict";function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);r&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,i)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){_defineProperty(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _createForOfIteratorHelperLoose(e,r){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,i=new Array(r);t<r;t++)i[t]=e[t];return i}import invariant from"fbjs/lib/invariant";var ViewabilityHelper=function(){function e(e){void 0===e&&(e={viewAreaCoveragePercentThreshold:0}),this._hasInteracted=!1,this._timers=new Set,this._viewableIndices=[],this._viewableItems=new Map,this._config=e}var r=e.prototype;return r.dispose=function(){this._timers.forEach(clearTimeout)},r.computeViewableItems=function(e,r,t,i,n){var a=this._config,o=a.itemVisiblePercentThreshold,s=a.viewAreaCoveragePercentThreshold,l=null!=s,c=l?s:o;invariant(null!=c&&null!=o!=(null!=s),"Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold");var u=[];if(0===e)return u;var f=-1,b=n||{first:0,last:e-1},h=b.first,v=b.last;if(v>=e)return console.warn("Invalid render range computing viewability "+JSON.stringify({renderRange:n,itemCount:e})),[];for(var p=h;p<=v;p++){var y=i(p);if(y){var d=y.offset-r,m=d+y.length;if(d<t&&m>0)f=p,_isViewable(l,c,d,m,t,y.length)&&u.push(p);else if(f>=0)break}}return u},r.onUpdate=function(e,r,t,i,n,a,o){var s=this;if((!this._config.waitForInteraction||this._hasInteracted)&&0!==e&&i(0)){var l=[];if(e&&(l=this.computeViewableItems(e,r,t,i,o)),this._viewableIndices.length!==l.length||!this._viewableIndices.every(function(e,r){return e===l[r]}))if(this._viewableIndices=l,this._config.minimumViewTime){var c=setTimeout(function(){s._timers.delete(c),s._onUpdateSync(l,a,n)},this._config.minimumViewTime);this._timers.add(c)}else this._onUpdateSync(l,a,n)}},r.resetViewableIndices=function(){this._viewableIndices=[]},r.recordInteraction=function(){this._hasInteracted=!0},r._onUpdateSync=function(e,r,t){var i=this;e=e.filter(function(e){return i._viewableIndices.includes(e)});for(var n,a=this._viewableItems,o=new Map(e.map(function(e){var r=t(e,!0);return[r.key,r]})),s=[],l=_createForOfIteratorHelperLoose(o);!(n=l()).done;){var c=n.value,u=c[0],f=c[1];a.has(u)||s.push(f)}for(var b,h=_createForOfIteratorHelperLoose(a);!(b=h()).done;){var v=b.value,p=v[0],y=v[1];o.has(p)||s.push(_objectSpread(_objectSpread({},y),{},{isViewable:!1}))}s.length>0&&(this._viewableItems=o,r({viewableItems:Array.from(o.values()),changed:s,viewabilityConfig:this._config}))},e}();function _isViewable(e,r,t,i,n,a){if(_isEntirelyVisible(t,i,n))return!0;var o=_getPixelsVisible(t,i,n);return 100*(e?o/n:o/a)>=r}function _getPixelsVisible(e,r,t){var i=Math.min(r,t)-Math.max(e,0);return Math.max(0,i)}function _isEntirelyVisible(e,r,t){return e>=0&&r<=t&&r>e}export default ViewabilityHelper;