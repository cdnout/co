"use strict";function ownKeys(e,i){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);i&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),t.push.apply(t,r)}return t}function _objectSpread(e){for(var i=1;i<arguments.length;i++){var t=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(t),!0).forEach(function(i){_defineProperty(e,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(t,i))})}return e}function _defineProperty(e,i,t){return i in e?Object.defineProperty(e,i,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[i]=t,e}import invariant from"fbjs/lib/invariant";var ViewabilityHelper=function(){function e(e){void 0===e&&(e={viewAreaCoveragePercentThreshold:0}),this._hasInteracted=!1,this._timers=new Set,this._viewableIndices=[],this._viewableItems=new Map,this._config=e}var i=e.prototype;return i.dispose=function(){this._timers.forEach(clearTimeout)},i.computeViewableItems=function(e,i,t,r,n){var a=this._config,s=a.itemVisiblePercentThreshold,o=a.viewAreaCoveragePercentThreshold,l=null!=o,c=l?o:s;invariant(null!=c&&null!=s!=(null!=o),"Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold");var f=[];if(0===e)return f;var u=-1,h=n||{first:0,last:e-1},b=h.first,v=h.last;if(v>=e)return console.warn("Invalid render range computing viewability "+JSON.stringify({renderRange:n,itemCount:e})),[];for(var d=b;d<=v;d++){var p=r(d);if(p){var w=p.offset-i,m=w+p.length;if(w<t&&m>0)u=d,_isViewable(l,c,w,m,t,p.length)&&f.push(d);else if(u>=0)break}}return f},i.onUpdate=function(e,i,t,r,n,a,s){var o=this;if((!this._config.waitForInteraction||this._hasInteracted)&&0!==e&&r(0)){var l=[];if(e&&(l=this.computeViewableItems(e,i,t,r,s)),this._viewableIndices.length!==l.length||!this._viewableIndices.every(function(e,i){return e===l[i]}))if(this._viewableIndices=l,this._config.minimumViewTime){var c=setTimeout(function(){o._timers.delete(c),o._onUpdateSync(l,a,n)},this._config.minimumViewTime);this._timers.add(c)}else this._onUpdateSync(l,a,n)}},i.resetViewableIndices=function(){this._viewableIndices=[]},i.recordInteraction=function(){this._hasInteracted=!0},i._onUpdateSync=function(e,i,t){var r=this;e=e.filter(function(e){return r._viewableIndices.includes(e)});var n=this._viewableItems,a=new Map(e.map(function(e){var i=t(e,!0);return[i.key,i]})),s=[],o=a,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var f;if(l){if(c>=o.length)break;f=o[c++]}else{if((c=o.next()).done)break;f=c.value}var u=f,h=u[0],b=u[1];n.has(h)||s.push(b)}var v=n,d=Array.isArray(v),p=0;for(v=d?v:v[Symbol.iterator]();;){var w;if(d){if(p>=v.length)break;w=v[p++]}else{if((p=v.next()).done)break;w=p.value}var m=w,y=m[0],_=m[1];a.has(y)||s.push(_objectSpread({},_,{isViewable:!1}))}s.length>0&&(this._viewableItems=a,i({viewableItems:Array.from(a.values()),changed:s,viewabilityConfig:this._config}))},e}();function _isViewable(e,i,t,r,n,a){if(_isEntirelyVisible(t,r,n))return!0;var s=_getPixelsVisible(t,r,n);return 100*(e?s/n:s/a)>=i}function _getPixelsVisible(e,i,t){var r=Math.min(i,t)-Math.max(e,0);return Math.max(0,r)}function _isEntirelyVisible(e,i,t){return e>=0&&i<=t&&i>e}export default ViewabilityHelper;