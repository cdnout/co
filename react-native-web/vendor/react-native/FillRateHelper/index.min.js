"use strict";function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,a)}return n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}import performanceNow from"fbjs/lib/performanceNow";import warning from"fbjs/lib/warning";var Info=function(){this.any_blank_count=0,this.any_blank_ms=0,this.any_blank_speed_sum=0,this.mostly_blank_count=0,this.mostly_blank_ms=0,this.pixels_blank=0,this.pixels_sampled=0,this.pixels_scrolled=0,this.total_time_spent=0,this.sample_count=0},DEBUG=!1,_listeners=[],_minSampleCount=10,_sampleRate=DEBUG?1:null,FillRateHelper=function(){function t(t){this._anyBlankStartTime=null,this._enabled=!1,this._info=new Info,this._mostlyBlankStartTime=null,this._samplesStartTime=null,this._getFrameMetrics=t,this._enabled=(_sampleRate||0)>Math.random(),this._resetData()}t.addListener=function(t){return warning(null!==_sampleRate,"Call `FillRateHelper.setSampleRate` before `addListener`."),_listeners.push(t),{remove:function(){_listeners=_listeners.filter(function(e){return t!==e})}}},t.setSampleRate=function(t){_sampleRate=t},t.setMinSampleCount=function(t){_minSampleCount=t};var e=t.prototype;return e.activate=function(){this._enabled&&null==this._samplesStartTime&&(DEBUG&&console.debug("FillRateHelper: activate"),this._samplesStartTime=performanceNow())},e.deactivateAndFlush=function(){if(this._enabled){var t=this._samplesStartTime;if(null!=t)if(this._info.sample_count<_minSampleCount)this._resetData();else{var e=performanceNow()-t,n=_objectSpread(_objectSpread({},this._info),{},{total_time_spent:e});if(DEBUG){var a={avg_blankness:this._info.pixels_blank/this._info.pixels_sampled,avg_speed:this._info.pixels_scrolled/(e/1e3),avg_speed_when_any_blank:this._info.any_blank_speed_sum/this._info.any_blank_count,any_blank_per_min:this._info.any_blank_count/(e/1e3/60),any_blank_time_frac:this._info.any_blank_ms/e,mostly_blank_per_min:this._info.mostly_blank_count/(e/1e3/60),mostly_blank_time_frac:this._info.mostly_blank_ms/e};for(var i in a)a[i]=Math.round(1e3*a[i])/1e3;console.debug("FillRateHelper deactivateAndFlush: ",{derived:a,info:n})}_listeners.forEach(function(t){return t(n)}),this._resetData()}else DEBUG&&console.debug("FillRateHelper: bail on deactivate with no start time")}},e.computeBlankness=function(t,e,n){if(!this._enabled||0===t.getItemCount(t.data)||null==this._samplesStartTime)return 0;var a=n.dOffset,i=n.offset,s=n.velocity,l=n.visibleLength;this._info.sample_count++,this._info.pixels_sampled+=Math.round(l),this._info.pixels_scrolled+=Math.round(Math.abs(a));var r=Math.round(1e3*Math.abs(s)),o=performanceNow();null!=this._anyBlankStartTime&&(this._info.any_blank_ms+=o-this._anyBlankStartTime),this._anyBlankStartTime=null,null!=this._mostlyBlankStartTime&&(this._info.mostly_blank_ms+=o-this._mostlyBlankStartTime),this._mostlyBlankStartTime=null;for(var _=0,m=e.first,f=this._getFrameMetrics(m);m<=e.last&&(!f||!f.inLayout);)f=this._getFrameMetrics(m),m++;f&&m>0&&(_=Math.min(l,Math.max(0,f.offset-i)));for(var h=0,u=e.last,c=this._getFrameMetrics(u);u>=e.first&&(!c||!c.inLayout);)c=this._getFrameMetrics(u),u--;if(c&&u<t.getItemCount(t.data)-1){var p=c.offset+c.length;h=Math.min(l,Math.max(0,i+l-p))}var b=Math.round(_+h),y=b/l;return y>0?(this._anyBlankStartTime=o,this._info.any_blank_speed_sum+=r,this._info.any_blank_count++,this._info.pixels_blank+=b,y>.5&&(this._mostlyBlankStartTime=o,this._info.mostly_blank_count++)):(r<.01||Math.abs(a)<1)&&this.deactivateAndFlush(),y},e.enabled=function(){return this._enabled},e._resetData=function(){this._anyBlankStartTime=null,this._info=new Info,this._mostlyBlankStartTime=null,this._samplesStartTime=null},t}();export default FillRateHelper;