"use strict";function ownKeys(e,t){var n,a=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,n)),a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var Info=function(){this.any_blank_count=0,this.any_blank_ms=0,this.any_blank_speed_sum=0,this.mostly_blank_count=0,this.mostly_blank_ms=0,this.pixels_blank=0,this.pixels_sampled=0,this.pixels_scrolled=0,this.total_time_spent=0,this.sample_count=0},DEBUG=!1,_listeners=[],_minSampleCount=10,_sampleRate=DEBUG?1:null,FillRateHelper=function(){function t(t){this._anyBlankStartTime=null,this._enabled=!1,this._info=new Info,this._mostlyBlankStartTime=null,this._samplesStartTime=null,this._getFrameMetrics=t,this._enabled=(_sampleRate||0)>Math.random(),this._resetData()}t.addListener=function(e){return null===_sampleRate&&console.warn("Call `FillRateHelper.setSampleRate` before `addListener`."),_listeners.push(e),{remove:function(){_listeners=_listeners.filter(function(t){return e!==t})}}},t.setSampleRate=function(t){_sampleRate=t},t.setMinSampleCount=function(t){_minSampleCount=t};var e=t.prototype;return e.activate=function(){this._enabled&&null==this._samplesStartTime&&(DEBUG&&console.debug("FillRateHelper: activate"),this._samplesStartTime=global.performance.now())},e.deactivateAndFlush=function(){if(this._enabled){var t=this._samplesStartTime;if(null!=t)if(this._info.sample_count<_minSampleCount)this._resetData();else{var t=global.performance.now()-t,e=_objectSpread(_objectSpread({},this._info),{},{total_time_spent:t});if(DEBUG){var n,a={avg_blankness:this._info.pixels_blank/this._info.pixels_sampled,avg_speed:this._info.pixels_scrolled/(t/1e3),avg_speed_when_any_blank:this._info.any_blank_speed_sum/this._info.any_blank_count,any_blank_per_min:this._info.any_blank_count/(t/1e3/60),any_blank_time_frac:this._info.any_blank_ms/t,mostly_blank_per_min:this._info.mostly_blank_count/(t/1e3/60),mostly_blank_time_frac:this._info.mostly_blank_ms/t};for(n in a)a[n]=Math.round(1e3*a[n])/1e3;console.debug("FillRateHelper deactivateAndFlush: ",{derived:a,info:e})}_listeners.forEach(function(t){return t(e)}),this._resetData()}else DEBUG&&console.debug("FillRateHelper: bail on deactivate with no start time")}},e.computeBlankness=function(t,e,n){if(!this._enabled||0===t.getItemCount(t.data)||null==this._samplesStartTime)return 0;var a=n.dOffset,i=n.offset,s=n.velocity,l=n.visibleLength;this._info.sample_count++,this._info.pixels_sampled+=Math.round(l),this._info.pixels_scrolled+=Math.round(Math.abs(a));var r=Math.round(1e3*Math.abs(s)),o=global.performance.now();null!=this._anyBlankStartTime&&(this._info.any_blank_ms+=o-this._anyBlankStartTime),(this._anyBlankStartTime=null)!=this._mostlyBlankStartTime&&(this._info.mostly_blank_ms+=o-this._mostlyBlankStartTime),this._mostlyBlankStartTime=null;for(var n=0,_=e.first,m=this._getFrameMetrics(_);_<=e.last&&(!m||!m.inLayout);)m=this._getFrameMetrics(_),_++;m&&0<_&&(n=Math.min(l,Math.max(0,m.offset-i)));for(var s=0,h=e.last,u=this._getFrameMetrics(h);h>=e.first&&(!u||!u.inLayout);)u=this._getFrameMetrics(h),h--;u&&h<t.getItemCount(t.data)-1&&(t=u.offset+u.length,s=Math.min(l,Math.max(0,i+l-t)));s=Math.round(n+s),l=s/l;return 0<l?(this._anyBlankStartTime=o,this._info.any_blank_speed_sum+=r,this._info.any_blank_count++,this._info.pixels_blank+=s,.5<l&&(this._mostlyBlankStartTime=o,this._info.mostly_blank_count++)):(r<.01||Math.abs(a)<1)&&this.deactivateAndFlush(),l},e.enabled=function(){return this._enabled},e._resetData=function(){this._anyBlankStartTime=null,this._info=new Info,this._mostlyBlankStartTime=null,this._samplesStartTime=null},t}();export default FillRateHelper;