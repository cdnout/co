import createResponderEvent from"./createResponderEvent";import{isCancelish,isEndish,isMoveish,isScroll,isSelectionChange,isStartish}from"./ResponderEventTypes";import{getLowestCommonAncestor,getResponderPaths,hasTargetTouches,hasValidSelection,isPrimaryPointerDown,setResponderId}from"./utils";import ResponderTouchHistoryStore from"./ResponderTouchHistoryStore";import ExecutionEnvironment from"fbjs/lib/ExecutionEnvironment";var canUseDOM=ExecutionEnvironment.canUseDOM,emptyObject={},startRegistration=["onStartShouldSetResponderCapture","onStartShouldSetResponder",{bubbles:!0}],moveRegistration=["onMoveShouldSetResponderCapture","onMoveShouldSetResponder",{bubbles:!0}],scrollRegistration=["onScrollShouldSetResponderCapture","onScrollShouldSetResponder",{bubbles:!1}],shouldSetResponderEvents={touchstart:startRegistration,mousedown:startRegistration,touchmove:moveRegistration,mousemove:moveRegistration,scroll:scrollRegistration},emptyResponder={id:null,idPath:null,node:null},responderListenersMap=new Map,isEmulatingMouseEvents=!1,trackedTouchCount=0,currentResponder={id:null,node:null,idPath:null};function changeCurrentResponder(e){currentResponder=e}function getResponderConfig(e){e=responderListenersMap.get(e);return null!=e?e:emptyObject}function eventListener(e){var n,t,o,r,s,i,a,u,d,c,l,p,R,h,m=e.type,g=e.target;"touchstart"===m&&(isEmulatingMouseEvents=!0),("touchmove"===m||1<trackedTouchCount)&&(isEmulatingMouseEvents=!1),"mousedown"===m&&isEmulatingMouseEvents||"mousemove"===m&&isEmulatingMouseEvents||"mousemove"===m&&trackedTouchCount<1||(isEmulatingMouseEvents&&"mouseup"===m?0===trackedTouchCount&&(isEmulatingMouseEvents=!1):(n=isStartish(m)&&isPrimaryPointerDown(e),t=isMoveish(m),o=isEndish(m),r=isScroll(m),h=isSelectionChange(m),s=createResponderEvent(e),(n||t||o)&&(e.touches?trackedTouchCount=e.touches.length:n?trackedTouchCount=1:o&&(trackedTouchCount=0),ResponderTouchHistoryStore.recordTouchTrack(m,s.nativeEvent)),d=getResponderPaths(e),i=!1,(n||t||r&&0<trackedTouchCount)&&(p=currentResponder.idPath,R=d.idPath,null!=(d=null!=p&&null!=R?null!=(a=getLowestCommonAncestor(p,R))?(u=R.indexOf(a)+(a===currentResponder.id?1:0),{idPath:R.slice(u),nodePath:d.nodePath.slice(u)}):null:d)&&null!=(c=findWantsResponder(d,e,s))&&(attemptTransfer(s,c),i=!0)),null!=currentResponder.id&&null!=currentResponder.node&&(p=(l=currentResponder).id,a=l.node,u=(R=getResponderConfig(p)).onResponderStart,d=R.onResponderMove,c=R.onResponderEnd,l=R.onResponderRelease,p=R.onResponderTerminate,R=R.onResponderTerminationRequest,s.bubbles=!1,s.cancelable=!1,s.currentTarget=a,n?null!=u&&(s.dispatchConfig.registrationName="onResponderStart",u(s)):t?null!=d&&(s.dispatchConfig.registrationName="onResponderMove",d(s)):(h=isCancelish(m)||"contextmenu"===m||"blur"===m&&g===window||"blur"===m&&g.contains(a)&&e.relatedTarget!==a||r&&0===trackedTouchCount||r&&g.contains(a)&&g!==a||h&&hasValidSelection(e),e=o&&!h&&!hasTargetTouches(a,e.touches),o&&null!=c&&(s.dispatchConfig.registrationName="onResponderEnd",c(s)),e&&(null!=l&&(s.dispatchConfig.registrationName="onResponderRelease",l(s)),changeCurrentResponder(emptyResponder)),h&&(h=!0,"contextmenu"!==m&&"scroll"!==m&&"selectionchange"!==m||(i||null!=R&&!(s.dispatchConfig.registrationName="onResponderTerminationRequest")===R(s))&&(h=!1),h&&(null!=p&&(s.dispatchConfig.registrationName="onResponderTerminate",p(s)),changeCurrentResponder(emptyResponder),isEmulatingMouseEvents=!1,trackedTouchCount=0))))))}function findWantsResponder(e,n,o){var t=shouldSetResponderEvents[n.type];if(null!=t){function r(e,n,t){t=getResponderConfig(e)[t];if(null!=t&&(o.currentTarget=n,!0===t(o)))return{id:e,node:n,idPath:s.slice(s.indexOf(e))}}for(var s=e.idPath,i=e.nodePath,a=t[0],u=t[1],e=t[2].bubbles,d=s.length-1;0<=d;d--){var c=r(s[d],i[d],a);if(null!=c)return c;if(!0===o.isPropagationStopped())return}if(e)for(var l=0;l<s.length;l++){var p=r(s[l],i[l],u);if(null!=p)return p;if(!0===o.isPropagationStopped())return}else{t=s[0],e=i[0];if(n.target===e)return r(t,e,u)}}}function attemptTransfer(e,n){var t=currentResponder,o=t.id,r=t.node,s=n.id,i=n.node,a=getResponderConfig(s),u=a.onResponderGrant,t=a.onResponderReject;e.bubbles=!1,e.cancelable=!1,e.currentTarget=i,null==o?(null!=u&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderGrant",u(e)),changeCurrentResponder(n)):(a=(s=getResponderConfig(o)).onResponderTerminate,o=!0,null!=(s=s.onResponderTerminationRequest)&&(e.currentTarget=r,!(e.dispatchConfig.registrationName="onResponderTerminationRequest")===s(e)&&(o=!1)),o?(null!=a&&(e.currentTarget=r,e.dispatchConfig.registrationName="onResponderTerminate",a(e)),null!=u&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderGrant",u(e)),changeCurrentResponder(n)):null!=t&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderReject",t(e)))}var documentEventsCapturePhase=["blur","scroll"],documentEventsBubblePhase=["mousedown","mousemove","mouseup","dragstart","touchstart","touchmove","touchend","touchcancel","contextmenu","select","selectionchange"];function attachListeners(){canUseDOM&&null==window.__reactResponderSystemActive&&(window.addEventListener("blur",eventListener),documentEventsBubblePhase.forEach(function(e){document.addEventListener(e,eventListener)}),documentEventsCapturePhase.forEach(function(e){document.addEventListener(e,eventListener,!0)}),window.__reactResponderSystemActive=!0)}function addNode(e,n,t){setResponderId(n,e),responderListenersMap.set(e,t)}function removeNode(e){currentResponder.id===e&&terminateResponder(),responderListenersMap.has(e)&&responderListenersMap.delete(e)}function terminateResponder(){var e=currentResponder,n=e.id,t=e.node;null!=n&&null!=t&&(null!=(e=getResponderConfig(n).onResponderTerminate)&&((n=createResponderEvent({})).currentTarget=t,e(n)),changeCurrentResponder(emptyResponder)),isEmulatingMouseEvents=!1,trackedTouchCount=0}function getResponderNode(){return currentResponder.node}export{attachListeners,addNode,removeNode,terminateResponder,getResponderNode};