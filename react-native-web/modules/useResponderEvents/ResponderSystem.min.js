import{canUseDOM}from"fbjs/lib/ExecutionEnvironment";import createResponderEvent from"./createResponderEvent";import{isCancelish,isEndish,isMoveish,isScroll,isSelectionChange,isStartish}from"./ResponderEventTypes";import{getLowestCommonAncestor,getResponderPaths,hasTargetTouches,hasValidSelection,isPrimaryPointerDown,setResponderId}from"./utils";import ResponderTouchHistoryStore from"./ResponderTouchHistoryStore";var emptyObject={},startRegistration=["onStartShouldSetResponderCapture","onStartShouldSetResponder",{bubbles:!0}],moveRegistration=["onMoveShouldSetResponderCapture","onMoveShouldSetResponder",{bubbles:!0}],scrollRegistration=["onScrollShouldSetResponderCapture","onScrollShouldSetResponder",{bubbles:!1}],shouldSetResponderEvents={touchstart:startRegistration,mousedown:startRegistration,touchmove:moveRegistration,mousemove:moveRegistration,scroll:scrollRegistration},emptyResponder={id:null,idPath:null,node:null},responderListenersMap=new Map,isEmulatingMouseEvents=!1,trackedTouchCount=0,currentResponder={id:null,node:null,idPath:null};function changeCurrentResponder(e){currentResponder=e}function getResponderConfig(e){var n=responderListenersMap.get(e);return null!=n?n:emptyObject}function eventListener(e){var n=e.type,t=e.target;if("touchstart"===n&&(isEmulatingMouseEvents=!0),("touchmove"===n||trackedTouchCount>1)&&(isEmulatingMouseEvents=!1),!("mousedown"===n&&isEmulatingMouseEvents||"mousemove"===n&&isEmulatingMouseEvents||"mousemove"===n&&trackedTouchCount<1))if(isEmulatingMouseEvents&&"mouseup"===n)0===trackedTouchCount&&(isEmulatingMouseEvents=!1);else{var r=isStartish(n)&&isPrimaryPointerDown(e),o=isMoveish(n),s=isEndish(n),i=isScroll(n),a=isSelectionChange(n),u=createResponderEvent(e);(r||o||s)&&(e.touches?trackedTouchCount=e.touches.length:r?trackedTouchCount=1:s&&(trackedTouchCount=0),ResponderTouchHistoryStore.recordTouchTrack(n,u.nativeEvent));var d,c=getResponderPaths(e),l=!1;if(r||o||i&&trackedTouchCount>0){var p=currentResponder.idPath,h=c.idPath;if(null!=p&&null!=h){var R=getLowestCommonAncestor(p,h);if(null!=R){var g=h.indexOf(R)+(R===currentResponder.id?1:0);c={idPath:h.slice(g),nodePath:c.nodePath.slice(g)}}else c=null}null!=c&&null!=(d=findWantsResponder(c,e,u))&&(attemptTransfer(u,d),l=!0)}if(null!=currentResponder.id&&null!=currentResponder.node){var m=currentResponder,v=m.id,f=m.node,C=getResponderConfig(v),T=C.onResponderStart,E=C.onResponderMove,S=C.onResponderEnd,b=C.onResponderRelease,M=C.onResponderTerminate,P=C.onResponderTerminationRequest;if(u.bubbles=!1,u.cancelable=!1,u.currentTarget=f,r)null!=T&&(u.dispatchConfig.registrationName="onResponderStart",T(u));else if(o)null!=E&&(u.dispatchConfig.registrationName="onResponderMove",E(u));else{var w=isCancelish(n)||"contextmenu"===n||"blur"===n&&t===window||"blur"===n&&t.contains(f)&&e.relatedTarget!==f||i&&0===trackedTouchCount||i&&t.contains(f)&&t!==f||a&&hasValidSelection(e),y=s&&!w&&!hasTargetTouches(f,e.touches);if(s&&null!=S&&(u.dispatchConfig.registrationName="onResponderEnd",S(u)),y&&(null!=b&&(u.dispatchConfig.registrationName="onResponderRelease",b(u)),changeCurrentResponder(emptyResponder)),w){var L=!0;"contextmenu"!==n&&"scroll"!==n&&"selectionchange"!==n||(l?L=!1:null!=P&&(u.dispatchConfig.registrationName="onResponderTerminationRequest",!1===P(u)&&(L=!1))),L&&(null!=M&&(u.dispatchConfig.registrationName="onResponderTerminate",M(u)),changeCurrentResponder(emptyResponder),isEmulatingMouseEvents=!1,trackedTouchCount=0)}}}}}function findWantsResponder(e,n,t){var r=shouldSetResponderEvents[n.type];if(null!=r){for(var o=e.idPath,s=e.nodePath,i=r[0],a=r[1],u=r[2].bubbles,d=function(e,n,r){var s=getResponderConfig(e)[r];if(null!=s&&(t.currentTarget=n,!0===s(t)))return{id:e,node:n,idPath:o.slice(o.indexOf(e))}},c=o.length-1;c>=0;c--){var l=d(o[c],s[c],i);if(null!=l)return l;if(!0===t.isPropagationStopped())return}if(u)for(var p=0;p<o.length;p++){var h=d(o[p],s[p],a);if(null!=h)return h;if(!0===t.isPropagationStopped())return}else{var R=o[0],g=s[0];if(n.target===g)return d(R,g,a)}}}function attemptTransfer(e,n){var t=currentResponder,r=t.id,o=t.node,s=n.id,i=n.node,a=getResponderConfig(s),u=a.onResponderGrant,d=a.onResponderReject;if(e.bubbles=!1,e.cancelable=!1,e.currentTarget=i,null==r)null!=u&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderGrant",u(e)),changeCurrentResponder(n);else{var c=getResponderConfig(r),l=c.onResponderTerminate,p=c.onResponderTerminationRequest,h=!0;null!=p&&(e.currentTarget=o,e.dispatchConfig.registrationName="onResponderTerminationRequest",!1===p(e)&&(h=!1)),h?(null!=l&&(e.currentTarget=o,e.dispatchConfig.registrationName="onResponderTerminate",l(e)),null!=u&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderGrant",u(e)),changeCurrentResponder(n)):null!=d&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderReject",d(e))}}var documentEventsCapturePhase=["blur","scroll"],documentEventsBubblePhase=["mousedown","mousemove","mouseup","dragstart","touchstart","touchmove","touchend","touchcancel","contextmenu","select","selectionchange"];export function attachListeners(){canUseDOM&&null==window.__reactResponderSystemActive&&(window.addEventListener("blur",eventListener),documentEventsBubblePhase.forEach(function(e){document.addEventListener(e,eventListener)}),documentEventsCapturePhase.forEach(function(e){document.addEventListener(e,eventListener,!0)}),window.__reactResponderSystemActive=!0)};export function addNode(e,n,t){setResponderId(n,e),responderListenersMap.set(e,t)};export function removeNode(e){currentResponder.id===e&&terminateResponder(),responderListenersMap.has(e)&&responderListenersMap.delete(e)};export function terminateResponder(){var e=currentResponder,n=e.id,t=e.node;if(null!=n&&null!=t){var r=getResponderConfig(n).onResponderTerminate;if(null!=r){var o=createResponderEvent({});o.currentTarget=t,r(o)}changeCurrentResponder(emptyResponder)}isEmulatingMouseEvents=!1,trackedTouchCount=0};export function getResponderNode(){return currentResponder.node};