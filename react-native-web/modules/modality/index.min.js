import createEventHandle from"../createEventHandle";import ExecutionEnvironment from"fbjs/lib/ExecutionEnvironment";var previousModality,previousActiveModality,canUseDOM=ExecutionEnvironment.canUseDOM,supportsPointerEvent=function(){return!("undefined"==typeof window||null==window.PointerEvent)},activeModality="keyboard",modality="keyboard",isEmulatingMouseEvents=!1,listeners=new Set,KEYBOARD="keyboard",MOUSE="mouse",TOUCH="touch",BLUR="blur",CONTEXTMENU="contextmenu",FOCUS="focus",KEYDOWN="keydown",MOUSEDOWN="mousedown",MOUSEMOVE="mousemove",MOUSEUP="mouseup",POINTERDOWN="pointerdown",POINTERMOVE="pointermove",SCROLL="scroll",SELECTIONCHANGE="selectionchange",TOUCHCANCEL="touchcancel",TOUCHMOVE="touchmove",TOUCHSTART="touchstart",VISIBILITYCHANGE="visibilitychange",bubbleOptions={passive:!0},captureOptions={capture:!0,passive:!0},addBlurListener=createEventHandle(BLUR,bubbleOptions),addFocusListener=createEventHandle(FOCUS,bubbleOptions),addVisibilityChangeListener=createEventHandle(VISIBILITYCHANGE,captureOptions),addKeyDownListener=createEventHandle(KEYDOWN,captureOptions),addPointerDownListener=createEventHandle(POINTERDOWN,captureOptions),addPointerMoveListener=createEventHandle(POINTERMOVE,captureOptions),addContextMenuListener=createEventHandle(CONTEXTMENU,captureOptions),addMouseDownListener=createEventHandle(MOUSEDOWN,captureOptions),addMouseMoveListener=createEventHandle(MOUSEMOVE,captureOptions),addMouseUpListener=createEventHandle(MOUSEUP,captureOptions),addScrollListener=createEventHandle(SCROLL,captureOptions),addSelectiomChangeListener=createEventHandle(SELECTIONCHANGE,captureOptions),addTouchCancelListener=createEventHandle(TOUCHCANCEL,captureOptions),addTouchMoveListener=createEventHandle(TOUCHMOVE,captureOptions),addTouchStartListener=createEventHandle(TOUCHSTART,captureOptions);function restoreModality(){null==previousModality&&null==previousActiveModality||(null!=previousModality&&(modality=previousModality,previousModality=null),null!=previousActiveModality&&(activeModality=previousActiveModality,previousActiveModality=null),callListeners())}function onBlurWindow(){previousModality=modality,previousActiveModality=activeModality,modality=activeModality=KEYBOARD,callListeners(),isEmulatingMouseEvents=!1}function onFocusWindow(){restoreModality()}function onKeyDown(e){e.metaKey||e.altKey||e.ctrlKey||modality!==KEYBOARD&&(activeModality=modality=KEYBOARD,callListeners())}function onVisibilityChange(){"hidden"!==document.visibilityState&&restoreModality()}function onPointerish(e){var t=e.type;if(supportsPointerEvent())t!==POINTERDOWN?t===POINTERMOVE&&modality!==e.pointerType&&(modality=e.pointerType,callListeners()):activeModality!==e.pointerType&&(modality=e.pointerType,activeModality=e.pointerType,callListeners());else{if(isEmulatingMouseEvents||(t===MOUSEDOWN&&activeModality!==MOUSE&&(activeModality=modality=MOUSE,callListeners()),t===MOUSEMOVE&&modality!==MOUSE&&(modality=MOUSE,callListeners())),t===TOUCHSTART)return isEmulatingMouseEvents=!0,e.touches&&1<e.touches.length&&(isEmulatingMouseEvents=!1),void(activeModality!==TOUCH&&(activeModality=modality=TOUCH,callListeners()));t!==CONTEXTMENU&&t!==MOUSEUP&&t!==SELECTIONCHANGE&&t!==SCROLL&&t!==TOUCHCANCEL&&t!==TOUCHMOVE||(isEmulatingMouseEvents=!1)}}function callListeners(){var t={activeModality:activeModality,modality:modality};listeners.forEach(function(e){e(t)})}function getActiveModality(){return activeModality}function getModality(){return modality}function addModalityListener(e){return listeners.add(e),function(){listeners.delete(e)}}function testOnly_resetActiveModality(){isEmulatingMouseEvents=!1,modality=activeModality=KEYBOARD}canUseDOM&&(addBlurListener(window,onBlurWindow),addFocusListener(window,onFocusWindow),addKeyDownListener(document,onKeyDown),addPointerDownListener(document,onPointerish),addPointerMoveListener(document,onPointerish),addVisibilityChangeListener(document,onVisibilityChange),addContextMenuListener(document,onPointerish),addMouseDownListener(document,onPointerish),addMouseMoveListener(document,onPointerish),addMouseUpListener(document,onPointerish),addTouchCancelListener(document,onPointerish),addTouchMoveListener(document,onPointerish),addTouchStartListener(document,onPointerish),addSelectiomChangeListener(document,onPointerish),addScrollListener(document,onPointerish));export{getActiveModality,getModality,addModalityListener,testOnly_resetActiveModality};