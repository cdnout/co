const{hooks:hooks,isPromise:isPromise}=require("@feathersjs/commons"),baseHooks=require("./base"),{createHookObject:createHookObject,getHooks:getHooks,processHooks:processHooks,enableHooks:enableHooks,ACTIVATE_HOOKS:ACTIVATE_HOOKS}=hooks,withHooks=function({app:e,service:o,method:r,original:t}){return(s={})=>{const i=e.hookTypes.reduce((e,o)=>{const r=s[o]||[];return e[o]=Array.isArray(r)?r:[r],e},{});return function(...s){const n=!0===s[s.length-1]&&s.pop(),a=createHookObject(r,{type:"before",arguments:s,service:o,app:e});return Promise.resolve(a).then(e=>processHooks.call(o,baseHooks.concat(i.before),e)).then(e=>{if(void 0!==e.result)return e;return new Promise(s=>{const i=t||o[r],n=o.methods[r].map(o=>e[o]),a=i.apply(o,n);if(!isPromise(a))throw new Error(`Service method '${e.method}' for '${e.path}' service must return a promise`);s(a)}).then(o=>(e.result=o,e)).catch(o=>{throw o.hook=e,o})}).then(e=>{const r=Object.assign({},e,{type:"after"});return processHooks.call(o,i.after,r)}).catch(e=>{const r=Object.assign({},e.hook,{type:"error",original:e.hook,error:e,result:void 0});return processHooks.call(o,i.error,r).catch(e=>{return Object.assign({},e.hook,{error:e,result:void 0})})}).then(e=>processHooks.call(o,i.finally,e).catch(e=>{return Object.assign({},e.hook,{error:e,result:void 0})})).then(e=>void 0!==e.error&&void 0===e.result?Promise.reject(n?e:e.error):n?e:e.result)}}},hookMixin=exports.hookMixin=function(e){if("function"==typeof e.hooks)return;e.methods=Object.getOwnPropertyNames(e).filter(o=>"function"==typeof e[o]&&e[o][ACTIVATE_HOOKS]).reduce((o,r)=>(o[r]=e[r][ACTIVATE_HOOKS],o),e.methods||{}),Object.assign(e.methods,{find:["params"],get:["id","params"],create:["data","params"],update:["id","data","params"],patch:["id","data","params"],remove:["id","params"]});const o=this,r=Object.keys(e.methods),t=r.reduce((r,t)=>"function"!=typeof e[t]?r:(r[t]=function(){const e=Array.from(arguments),r=this._super.bind(this);return withHooks({app:o,service:this,method:t,original:r})({before:getHooks(o,this,"before",t),after:getHooks(o,this,"after",t,!0),error:getHooks(o,this,"error",t,!0),finally:getHooks(o,this,"finally",t,!0)})(...e)},r),{});enableHooks(e,r,o.hookTypes),e.mixin(t)};module.exports=function(){return function(e){Object.assign(e,{hookTypes:["before","after","error","finally"]}),enableHooks(e,e.methods,e.hookTypes),e.mixins.push(hookMixin)}},module.exports.withHooks=withHooks,module.exports.ACTIVATE_HOOKS=ACTIVATE_HOOKS,module.exports.activateHooks=function(e){return o=>(Object.defineProperty(o,ACTIVATE_HOOKS,{value:e}),o)};