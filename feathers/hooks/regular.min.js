"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.enableRegularHooks=exports.convertHookData=exports.collectRegularHooks=exports.fromErrorHooks=exports.fromAfterHooks=exports.fromBeforeHooks=exports.fromErrorHook=exports.fromAfterHook=exports.fromBeforeHook=void 0;const service_1=require("../service"),runHook=(o,r,e)=>(e&&(r.type=e),Promise.resolve(o.call(r.self,r)).then(o=>{e&&(r.type=null),o&&o!==r&&Object.assign(r,o)}));function fromBeforeHook(e){return(o,r)=>runHook(e,o,"before").then(r)}function fromAfterHook(e){return(o,r)=>r().then(()=>runHook(e,o,"after"))}function fromErrorHook(e){return(r,o)=>o().catch(o=>(r.error===o&&void 0===r.result||(r.original={...r},r.error=o,delete r.result),runHook(e,r,"error").then(()=>{if(void 0===r.result&&void 0!==r.error)throw r.error})))}exports.fromBeforeHook=fromBeforeHook,exports.fromAfterHook=fromAfterHook,exports.fromErrorHook=fromErrorHook;const RunHooks=o=>e=>o.reduce((o,r)=>o.then(()=>runHook(r,e)),Promise.resolve(void 0));function fromBeforeHooks(o){return fromBeforeHook(RunHooks(o))}function fromAfterHooks(o){return fromAfterHook(RunHooks(o))}function fromErrorHooks(o){return fromErrorHook(RunHooks(o))}function collectRegularHooks(o,r){return o.__hooks.hooks[r]||[]}function convertHookData(o){const r={};if(Array.isArray(o))r.all=o;else if("object"!=typeof o)r.all=[o];else for(const t of Object.keys(o)){var e=o[t];r[t]=Array.isArray(e)?e:[e]}return r}exports.fromBeforeHooks=fromBeforeHooks,exports.fromAfterHooks=fromAfterHooks,exports.fromErrorHooks=fromErrorHooks,exports.collectRegularHooks=collectRegularHooks,exports.convertHookData=convertHookData;const types=["before","after","error"],isType=o=>types.includes(o),wrappers={before:fromBeforeHooks,after:fromAfterHooks,error:fromErrorHooks},createStore=o=>{const r={before:{},after:{},error:{},hooks:{}};for(const e of o)r.hooks[e]=[];return r},setStore=(o,r)=>{Object.defineProperty(o,"__hooks",{configurable:!0,value:r,writable:!0})},getStore=o=>o.__hooks,createMap=(e,t)=>{const s={};return Object.keys(e).forEach(o=>{if(!isType(o))throw new Error(`'${o}' is not a valid hook type`);var r=convertHookData(e[o]);Object.keys(r).forEach(o=>{if("all"!==o&&!t.includes(o))throw new Error(`'${o}' is not a valid hook method`)}),s[o]=r}),s},createAdapter=o=>{var r=[],o=wrappers[o](r);return Object.assign(o,{hooks:r})},updateStore=(a,k)=>{Object.keys(a.hooks).forEach(f=>{let n=!1;Object.keys(k).forEach(o=>{var r=o,e=k[r].all||[],t=k[r][f]||[];if(e.length||t.length){const s=(o=a[r])[f]||(o[f]=(n=!0,createAdapter(r)));s.hooks.push(...e,...t)}}),n&&(a.hooks[f]=[a.error[f],a.before[f],a.after[f]].filter(o=>o))})};function enableRegularHooks(o,e=service_1.defaultServiceMethods){var r=createStore(e);return setStore(o,r),function(o){var r=getStore(this),o=createMap(o,e);return updateStore(r,o),this}}exports.enableRegularHooks=enableRegularHooks;