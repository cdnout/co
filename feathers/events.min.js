const{EventEmitter:EventEmitter}=require("events"),Proto=require("uberproto"),eventHook=exports.eventHook=function(){return function(e){const{app:t,service:n}=e,o=null===e.event?e.event:t.eventMappings[e.method],i=n._hookEvents&&-1!==n._hookEvents.indexOf(o);if(o&&i&&"error"!==e.type){(Array.isArray(e.result)?e.result:[e.result]).forEach(t=>n.emit(o,t,e))}}},eventMixin=exports.eventMixin=function(e){if(e._serviceEvents)return;const t=this,n="function"==typeof e.on&&"function"==typeof e.emit;"function"!=typeof e.mixin||n||e.mixin(EventEmitter.prototype),Object.defineProperties(e,{_serviceEvents:{value:Array.isArray(e.events)?e.events.slice():[]},_hookEvents:{value:[]}}),Object.keys(t.eventMappings).forEach(n=>{const o=t.eventMappings[n],i=-1!==e._serviceEvents.indexOf(o);"function"!=typeof e[n]||i||(e._serviceEvents.push(o),e._hookEvents.push(o))})};module.exports=function(){return function(e){Object.assign(e,{eventMappings:{create:"created",update:"updated",remove:"removed",patch:"patched"}}),e.hooks({finally:eventHook()}),Proto.mixin(EventEmitter.prototype,e),e.mixins.push(eventMixin)}};