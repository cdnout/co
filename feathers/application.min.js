"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Feathers=void 0;const version_1=__importDefault(require("./version")),dependencies_1=require("./dependencies"),events_1=require("./events"),index_1=require("./hooks/index"),service_1=require("./service"),regular_1=require("./hooks/regular"),debug=(0,dependencies_1.createDebug)("@feathersjs/feathers");class Feathers extends dependencies_1.EventEmitter{constructor(){super(),this.services={},this.settings={},this.mixins=[index_1.hookMixin,events_1.eventMixin],this.version=version_1.default,this._isSetup=!1,this.appHooks={[dependencies_1.HOOKS]:[events_1.eventHook]},this.regularHooks=(0,regular_1.enableRegularHooks)(this),(0,dependencies_1.hooks)(this,{setup:(0,dependencies_1.middleware)().params("server").props({app:this}),teardown:(0,dependencies_1.middleware)().params("server").props({app:this})})}get(e){return this.settings[e]}set(e,s){return this.settings[e]=s,this}configure(e){return e.call(this,this),this}defaultService(e){throw new Error(`Can not find service '${e}'`)}service(e){var s=(0,dependencies_1.stripSlashes)(e)||"/",e=this.services[s];return void 0===e?(this.use(s,this.defaultService(s)),this.service(s)):e}use(e,s,t){if("string"!=typeof e)throw new Error(`'${e}' is not a valid service path.`);const r=(0,dependencies_1.stripSlashes)(e)||"/",i=s;if("function"==typeof i.service&&i.services)return Object.keys(i.services).forEach(e=>this.use(`${r}/${e}`,i.service(e))),this;const n=(0,service_1.wrapService)(r,s,t),o=(0,service_1.getServiceOptions)(n);for(const c of service_1.protectedMethods)if(o.methods.includes(c))throw new Error(`'${c}' on service '${r}' is not allowed as a custom method name`);return debug(`Registering new service at \`${r}\``),this.mixins.forEach(e=>e.call(this,n,r,o)),this.services[r]=n,this._isSetup&&"function"==typeof n.setup&&(debug(`Setting up service for \`${r}\``),n.setup(this,r)),this}hooks(e){var s=e;if(s.before||s.after||s.error)this.regularHooks(s);else if(s.setup||s.teardown)(0,dependencies_1.hooks)(this,s);else if(Array.isArray(e))this.appHooks[dependencies_1.HOOKS].push(...e);else{const t=e;Object.keys(t).forEach(e=>{const s=this.appHooks[e]||[];this.appHooks[e]=s.concat(t[e])})}return this}setup(){return this._isSetup=!0,Object.keys(this.services).reduce((e,s)=>e.then(()=>{const e=this.service(s);if("function"==typeof e.setup)return debug(`Setting up service for \`${s}\``),e.setup(this,s)}),Promise.resolve()).then(()=>this)}teardown(){return this._isSetup=!1,Object.keys(this.services).reduce((e,s)=>e.then(()=>{const e=this.service(s);if("function"==typeof e.teardown)return debug(`Tearing down service for \`${s}\``),e.teardown(this,s)}),Promise.resolve()).then(()=>this)}}exports.Feathers=Feathers;