import{OpKind,RpcClient}from"@taquito/rpc";export{OpKind}from"@taquito/rpc";import{Observable,ReplaySubject,defer,throwError,of,EMPTY,combineLatest,from,range,concat,Subject,NEVER,BehaviorSubject,timer}from"rxjs";import{switchMap,timeoutWith,shareReplay,map,filter,first,catchError,tap,distinctUntilChanged,takeWhile,startWith,concatMap,retry,takeUntil,pluck,distinctUntilKeyChanged,publish,refCount}from"rxjs/operators";import{Schema,ParameterSchema,ViewSchema,MichelsonMap}from"@taquito/michelson-encoder";export{MichelsonMap,UnitValue}from"@taquito/michelson-encoder";import BigNumber from"bignumber.js";import{validateOperation,ValidationResult,InvalidOperationHashError,InvalidOperationKindError,DeprecationError,validateAddress,InvalidAddressError,validateKeyHash,InvalidKeyHashError,validateContractAddress,InvalidContractAddressError,validateChain,InvalidChainIdError,encodeExpr}from"@taquito/utils";import{HttpResponseError,STATUS_CODE}from"@taquito/http-utils";import{Parser,packDataBytes}from"@taquito/michel-codec";import{LocalForger}from"@taquito/local-forging";function __rest(t,e){var r={};for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&e.indexOf(a)<0&&(r[a]=t[a]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,a=Object.getOwnPropertySymbols(t);i<a.length;i++)e.indexOf(a[i])<0&&Object.prototype.propertyIsEnumerable.call(t,a[i])&&(r[a[i]]=t[a[i]]);return r}function __awaiter(t,o,n,c){return new(n=n||Promise)(function(r,e){function i(t){try{s(c.next(t))}catch(t){e(t)}}function a(t){try{s(c.throw(t))}catch(t){e(t)}}function s(t){var e;t.done?r(t.value):((e=t.value)instanceof n?e:new n(function(t){t(e)})).then(i,a)}s((c=c.apply(t,o||[])).next())})}class RpcInjector{constructor(t){this.context=t}inject(t){return this.context.rpc.injectOperation(t)}}class UnconfiguredSignerError extends Error{constructor(){super("No signer has been configured. Please configure one by calling setProvider({signer}) on your TezosToolkit instance."),this.name="UnconfiguredSignerError"}}class NoopSigner{publicKey(){return __awaiter(this,void 0,void 0,function*(){throw new UnconfiguredSignerError})}publicKeyHash(){return __awaiter(this,void 0,void 0,function*(){throw new UnconfiguredSignerError})}secretKey(){return __awaiter(this,void 0,void 0,function*(){throw new UnconfiguredSignerError})}sign(t,e){return __awaiter(this,void 0,void 0,function*(){throw new UnconfiguredSignerError})}}function createObservableFromSubscription(t){return new Observable(e=>(t.on("data",t=>{e.next(t)}),t.on("error",t=>{e.error(t)}),t.on("close",()=>{e.complete()}),()=>{t.close()}))}var DEFAULT_GAS_LIMIT,DEFAULT_FEE,DEFAULT_STORAGE_LIMIT,Protocols,ChainIds;!function(t){t[t.DELEGATION=10600]="DELEGATION",t[t.ORIGINATION=10600]="ORIGINATION",t[t.TRANSFER=10600]="TRANSFER",t[t.REVEAL=1100]="REVEAL"}(DEFAULT_GAS_LIMIT=DEFAULT_GAS_LIMIT||{}),function(t){t[t.DELEGATION=1257]="DELEGATION",t[t.ORIGINATION=1e4]="ORIGINATION",t[t.TRANSFER=1e4]="TRANSFER",t[t.REVEAL=374]="REVEAL"}(DEFAULT_FEE=DEFAULT_FEE||{}),function(t){t[t.DELEGATION=0]="DELEGATION",t[t.ORIGINATION=257]="ORIGINATION",t[t.TRANSFER=257]="TRANSFER",t[t.REVEAL=0]="REVEAL"}(DEFAULT_STORAGE_LIMIT=DEFAULT_STORAGE_LIMIT||{}),function(t){t.Pt24m4xi="Pt24m4xiPbLDhVgVfABUjirbmda3yohdN82Sp9FeuAXJ4eV9otd",t.PsBABY5H="PsBABY5HQTSkA4297zNHfsZNKtxULfL18y95qb3m53QJiXGmrbU",t.PsBabyM1="PsBabyM1eUXZseaJdmXFApDSBqj8YBfwELoxZHHW77EMcAbbwAS",t.PsCARTHA="PsCARTHAGazKbHtnKfLzQg3kms52kSRpgnDY982a9oYsSXRLQEb",t.PsDELPH1="PsDELPH1Kxsxt8f9eWbxQeRxkjfbxoqM52jvs5Y5fBxWWh4ifpo",t.PtEdo2Zk="PtEdo2ZkT9oKpimTah6x2embF25oss54njMuPzkJTEi5RqfdZFA",t.PsFLorena="PsFLorenaUUuikDWvMDr6fGBRG8kt3e3D3fHoXK1j1BFRxeSH4i",t.PtGRANADs="PtGRANADsDU8R9daYKAgWnQYAJ64omN1o3KMGVCykShA97vQbvV",t.PtHangz2="PtHangz2aRngywmSRGGvrcTyMbbdpWdpFKuS4uMWxg2RaH9i1qx",t.PsiThaCa="PsiThaCaT47Zboaw71QWScM8sXeMM7bbQFncK9FLqYc6EKdpjVP",t.Psithaca2="Psithaca2MLRFYargivpo7YvUr7wUDqyxrdhC5CQq78mRvimz6A",t.ProtoALpha="ProtoALphaALphaALphaALphaALphaALphaALphaALphaDdp3zK"}(Protocols=Protocols||{});const protocols={"004":[Protocols.Pt24m4xi],"005":[Protocols.PsBABY5H,Protocols.PsBabyM1],"006":[Protocols.PsCARTHA],"007":[Protocols.PsDELPH1],"008":[Protocols.PtEdo2Zk],"009":[Protocols.PsFLorena],"010":[Protocols.PtGRANADs],"011":[Protocols.PtHangz2],"012":[Protocols.PsiThaCa],"013":[Protocols.Psithaca2],"014":[Protocols.ProtoALpha]},TZ_DECIMALS=(!function(t){t.MAINNET="NetXdQprcVkpaWU",t.CARTHAGENET="NetXjD3HPJJjmcd",t.DELPHINET="NetXm8tYqnMWky1",t.EDONET="NetXSgo1ZT2DRUG",t.FLORENCENET="NetXxkAx4woPLyu",t.GRANADANET="NetXz969SFaFn8k",t.HANGZHOUNET="NetXZSsxBpMQeAT",t.ITHACANET="NetXbhmtAbMukLc",t.ITHACANET2="NetXnHfVqm9iesp"}(ChainIds=ChainIds||{}),6),MTZ_DECIMALS=3;function getDecimal(t){switch(t){case"tz":return TZ_DECIMALS;case"mtz":return MTZ_DECIMALS;default:return 0}}function format(t="mutez",e="mutez",r){const i=new BigNumber(r);return i.isNaN()?r:i.multipliedBy(Math.pow(10,getDecimal(t))).dividedBy(Math.pow(10,getDecimal(e)))}class InvalidParameterError extends Error{constructor(t,e,r){super(`${t} Received ${r.length} arguments while expecting one of the following signatures (${JSON.stringify(e)})`),this.smartContractMethodName=t,this.sigs=e,this.args=r,this.name="Invalid parameters error"}}class InvalidDelegationSource extends Error{constructor(t){super(`Since Babylon delegation source can no longer be a contract address ${t}. Please use the smart contract abstraction to set your delegate.`),this.source=t,this.name="Invalid delegation source error"}}class InvalidCodeParameter extends Error{constructor(t,e){super(t),this.message=t,this.data=e,this.name="InvalidCodeParameter"}}class InvalidInitParameter extends Error{constructor(t,e){super(t),this.message=t,this.data=e,this.name="InvalidInitParameter"}}class InvalidViewParameterError extends Error{constructor(t,e,r,i){super(`Unable to encode the parameter of the view: ${t}. Received ${r} as parameter while expecting one of the following signatures (${JSON.stringify(e)})`),this.smartContractViewName=t,this.sigs=e,this.args=r,this.originalError=i,this.name="Invalid view parameters error",this.cause=i}}class ViewSimulationError extends Error{constructor(t,e,r,i){super(t),this.message=t,this.viewName=e,this.failWith=r,this.originalError=i,this.name="ViewSimulationError"}}const validateAndExtractFailwith=t=>{if(isJsonString(t.body)){t=JSON.parse(t.body);if(Array.isArray(t)&&"with"in t[t.length-1])return t[t.length-1].with}},isJsonString=t=>{try{JSON.parse(t)}catch(t){return!1}return!0};class InvalidViewSimulationContext extends Error{constructor(t){super(t+" Please configure the context of the view execution in the executeView method."),this.info=t,this.name="InvalidViewSimulationContext"}}class RevealOperationError extends Error{constructor(t){super(t),this.message=t,this.name="RevealOperationError"}}class OriginationParameterError extends Error{constructor(t){super(t),this.message=t,this.name="OriginationParameterError"}}const createOriginationOperation=({code:a,init:s,balance:o="0",delegate:n,storage:c,fee:d=DEFAULT_FEE.ORIGINATION,gasLimit:l=DEFAULT_GAS_LIMIT.ORIGINATION,storageLimit:h=DEFAULT_STORAGE_LIMIT.ORIGINATION,mutez:u=!1})=>__awaiter(void 0,void 0,void 0,function*(){if(void 0!==c&&void 0!==s)throw new OriginationParameterError("Storage and Init cannot be set a the same time. Please either use storage or init but not both.");if(!Array.isArray(a))throw new InvalidCodeParameter("Wrong code parameter type, expected an array",a);let t;if(void 0!==c){var e=a.find(t=>"prim"in t&&"storage"===t.prim);if(void 0===(null==e?void 0:e.args))throw new InvalidCodeParameter("The storage section is missing from the script",a);const i=new Schema(e.args[0]);t=i.Encode(c)}else{if(void 0===s||"object"!=typeof s)throw new InvalidInitParameter("Wrong init parameter type, expected JSON Michelson",s);t=s}e={code:a,storage:t};const r={kind:OpKind.ORIGINATION,fee:d,gas_limit:l,storage_limit:h,balance:(u?o:format("tz","mutez",o)).toString(),script:e};return n&&(r.delegate=n),r}),createTransferOperation=({to:t,amount:e,parameter:r,fee:i=DEFAULT_FEE.TRANSFER,gasLimit:a=DEFAULT_GAS_LIMIT.TRANSFER,storageLimit:s=DEFAULT_STORAGE_LIMIT.TRANSFER,mutez:o=!1})=>__awaiter(void 0,void 0,void 0,function*(){return{kind:OpKind.TRANSACTION,fee:i,gas_limit:a,storage_limit:s,amount:(o?e:format("tz","mutez",e)).toString(),destination:t,parameters:r}}),createSetDelegateOperation=({delegate:t,source:e,fee:r=DEFAULT_FEE.DELEGATION,gasLimit:i=DEFAULT_GAS_LIMIT.DELEGATION,storageLimit:a=DEFAULT_STORAGE_LIMIT.DELEGATION})=>__awaiter(void 0,void 0,void 0,function*(){return{kind:OpKind.DELEGATION,source:e,fee:r,gas_limit:i,storage_limit:a,delegate:t}}),createRegisterDelegateOperation=({fee:t=DEFAULT_FEE.DELEGATION,gasLimit:e=DEFAULT_GAS_LIMIT.DELEGATION,storageLimit:r=DEFAULT_STORAGE_LIMIT.DELEGATION},i)=>__awaiter(void 0,void 0,void 0,function*(){return{kind:OpKind.DELEGATION,fee:t,gas_limit:e,storage_limit:r,delegate:i}}),createRevealOperation=({fee:t=DEFAULT_FEE.REVEAL,gasLimit:e=DEFAULT_GAS_LIMIT.REVEAL,storageLimit:r=DEFAULT_STORAGE_LIMIT.REVEAL},i,a)=>__awaiter(void 0,void 0,void 0,function*(){return{kind:OpKind.REVEAL,fee:t,public_key:a,source:i,gas_limit:e,storage_limit:r}}),createRegisterGlobalConstantOperation=({value:t,source:e,fee:r,gasLimit:i,storageLimit:a})=>__awaiter(void 0,void 0,void 0,function*(){return{kind:OpKind.REGISTER_GLOBAL_CONSTANT,value:t,fee:r,gas_limit:i,storage_limit:a,source:e}}),attachKind=(t,e)=>Object.assign(Object.assign({},t),{kind:e}),findWithKind=(t,e)=>{if(Array.isArray(t)){t=t.find(t=>t.kind===e);if(t&&isKind(t,e))return t}},isKind=(t,e)=>t.kind===e,isOpWithFee=t=>-1!==["transaction","delegation","origination","reveal","register_global_constant"].indexOf(t.kind),isOpRequireReveal=t=>-1!==["transaction","delegation","origination","register_global_constant"].indexOf(t.kind),hasMetadata=t=>"metadata"in t,hasMetadataWithResult=t=>hasMetadata(t)&&"operation_result"in t.metadata,hasMetadataWithInternalOperationResult=t=>hasMetadata(t)&&"internal_operation_results"in t.metadata,isErrorWithMessage=t=>"with"in t;class TezosOperationError extends Error{constructor(t,e){super(),this.errors=t,this.errorDetails=e,this.name="TezosOperationError";e=t[t.length-1];this.id=e.id,this.kind=e.kind,this.message=`(${this.kind}) `+this.id,isErrorWithMessage(e)&&(e.with.string?this.message=e.with.string:e.with.int?this.message=e.with.int:this.message=JSON.stringify(e.with))}}class TezosPreapplyFailureError extends Error{constructor(t){super("Preapply returned an unexpected result"),this.result=t,this.name="TezosPreapplyFailureError"}}const flattenOperationResult=t=>{var r=Array.isArray(t)?t:[t];const i=[];for(let e=0;e<r.length;e++)for(let t=0;t<r[e].contents.length;t++){const a=r[e].contents[t];hasMetadataWithResult(a)&&(i.push(Object.assign({fee:a.fee},a.metadata.operation_result)),Array.isArray(a.metadata.internal_operation_results)&&a.metadata.internal_operation_results.forEach(t=>i.push(t.result)))}return i},flattenErrors=(t,r="failed")=>{var i=Array.isArray(t)?t:[t];let a=[];for(let e=0;e<i.length;e++)for(let t=0;t<i[e].contents.length;t++){var s=i[e].contents[t];if(hasMetadata(s)&&(hasMetadataWithResult(s)&&s.metadata.operation_result.status===r&&(a=a.concat(s.metadata.operation_result.errors||[])),hasMetadataWithInternalOperationResult(s)&&Array.isArray(s.metadata.internal_operation_results)))for(const o of s.metadata.internal_operation_results)"result"in o&&o.result.status===r&&(a=a.concat(o.result.errors||[]))}return a};class OriginationOperationError extends Error{constructor(t){super(t),this.message=t,this.name="OriginationOperationError"}}class InvalidConfirmationCountError extends Error{constructor(t){super(t),this.message=t,this.name="InvalidConfirmationCountError"}}class ConfirmationUndefinedError extends Error{constructor(t){super(t),this.message=t,this.name="ConfirmationUndefinedError"}}class InvalidFilterExpressionError extends Error{constructor(t){super(t),this.message=t,this.name="InvalidFilterExpressionError"}}class Operation{constructor(t,e,r,i){if(this.hash=t,this.raw=e,this.results=r,this.context=i,this._pollingConfig$=new ReplaySubject(1),this.currentHead$=this._pollingConfig$.pipe(switchMap(t=>defer(()=>createObservableFromSubscription(this.context.stream.subscribeBlock("head"))).pipe(timeoutWith(1e3*t.timeout,throwError(new Error("Confirmation polling timed out"))))),shareReplay({refCount:!0})),this.confirmed$=this.currentHead$.pipe(map(e=>{for(let t=3;0<=t;t--)e.operations[t].forEach(t=>{t.hash===this.hash&&(this._foundAt=e.header.level)});if(0<=e.header.level-this._foundAt)return this._foundAt}),filter(t=>void 0!==t),first(),shareReplay()),this._foundAt=Number.POSITIVE_INFINITY,validateOperation(this.hash)!==ValidationResult.VALID)throw new InvalidOperationHashError(this.hash);this.confirmed$.pipe(first(),catchError(()=>of(EMPTY))).subscribe()}get includedInBlock(){return this._foundAt}get revealOperation(){return Array.isArray(this.results)&&this.results.find(t=>"reveal"===t.kind)}get revealStatus(){return this.revealOperation?this.revealOperation.metadata.operation_result.status:"unknown"}get status(){return this.results.map(t=>hasMetadataWithResult(t)?t.metadata.operation_result.status:"unknown")[0]||"unknown"}confirmation(i,a){return __awaiter(this,void 0,void 0,function*(){if(void 0!==i&&i<1)throw new InvalidConfirmationCountError("Confirmation count must be at least 1");var{defaultConfirmationCount:t,confirmationPollingTimeoutSecond:e}=this.context.config;this._pollingConfig$.next({timeout:a||e});const r=void 0!==i?i:t;return new Promise((e,t)=>{this.confirmed$.pipe(switchMap(()=>this.currentHead$),filter(t=>t.header.level-this._foundAt>=r-1),first()).subscribe(t=>{e(this._foundAt+(r-1))},t)})})}}class BatchOperation extends Operation{constructor(t,e,r,i,a,s){super(t,i,a,s),this.params=e,this.source=r}sumProp(t,r){return t.reduce((t,e)=>r in e?Number(e[r])+t:t,0)}get status(){return this.results.filter(t=>-1!==BATCH_KINDS.indexOf(t.kind)).map(t=>hasMetadataWithResult(t)?t.metadata.operation_result.status:"unknown")[0]||"unknown"}get fee(){return this.sumProp(this.params,"fee")}get gasLimit(){return this.sumProp(this.params,"gas_limit")}get storageLimit(){return this.sumProp(this.params,"storage_limit")}get consumedGas(){return String(this.sumProp(flattenOperationResult({contents:this.results}),"consumed_gas"))}get storageDiff(){return String(this.sumProp(flattenOperationResult({contents:this.results}),"paid_storage_size_diff"))}get errors(){return flattenErrors({contents:this.results})}}class OperationEmitter{constructor(t){this.context=t}get rpc(){return this.context.rpc}get signer(){return this.context.signer}isRevealOpNeeded(t,e){return __awaiter(this,void 0,void 0,function*(){return!(!(yield this.isAccountRevealRequired(e))||!this.isRevealRequiredForOpType(t))})}isAccountRevealRequired(t){return __awaiter(this,void 0,void 0,function*(){return!(yield this.context.readProvider.isAccountRevealed(t,"head"))})}isRevealRequiredForOpType(t){let e=!1;for(const r of t)isOpRequireReveal(r)&&(e=!0);return e}prepareOperation({operation:l,source:h},u){return __awaiter(this,void 0,void 0,function*(){const e={};let r=[];var t=this.context.readProvider.getBlockHash("head~2"),i=this.context.readProvider.getNextProtocol("head");r=Array.isArray(l)?[...l]:[l];const a=u||(yield this.signer.publicKeyHash());let s=Promise.resolve(void 0);for(let t=0;t<r.length;t++)if(isOpRequireReveal(r[t])||"reveal"===r[t].kind){s=this.context.readProvider.getCounter(a,"head");break}var[t,i,o]=yield Promise.all([t,i,s]),o=parseInt(o||"0",10);(!e[a]||e[a]<o)&&(e[a]=o);const n=t=>{return{counter:""+ ++e[a],fee:void 0===t.fee?"0":""+t.fee,gas_limit:void 0===t.gas_limit?"0":""+t.gas_limit,storage_limit:void 0===t.storage_limit?"0":""+t.storage_limit}},c=t=>({source:void 0===t.source?h||a:t.source});var d=r.map(t=>{switch(t.kind){case OpKind.ACTIVATION:return Object.assign({},t);case OpKind.REVEAL:return Object.assign(Object.assign(Object.assign({},t),c(t)),n(t));case OpKind.ORIGINATION:return Object.assign(Object.assign(Object.assign(Object.assign({},t),{balance:void 0!==t.balance?""+t.balance:"0"}),c(t)),n(t));case OpKind.TRANSACTION:{const e=Object.assign(Object.assign(Object.assign(Object.assign({},t),{amount:void 0!==t.amount?""+t.amount:"0"}),c(t)),n(t));if(e.source.toLowerCase().startsWith("kt1"))throw new DeprecationError("KT1 addresses are not supported as source since "+Protocols.PsBabyM1);return e}case OpKind.DELEGATION:case OpKind.REGISTER_GLOBAL_CONSTANT:return Object.assign(Object.assign(Object.assign({},t),c(t)),n(t));default:throw new InvalidOperationKindError(t.kind)}});return{opOb:{branch:t,contents:d,protocol:i},counter:o}})}forge({opOb:{branch:t,contents:e,protocol:r},counter:i}){return __awaiter(this,void 0,void 0,function*(){return{opbytes:yield this.context.forger.forge({branch:t,contents:e}),opOb:{branch:t,contents:e,protocol:r},counter:i}})}simulate(t){return __awaiter(this,void 0,void 0,function*(){return{opResponse:yield this.rpc.runOperation(t),op:t,context:this.context.clone()}})}estimate(t,a){var{fee:s,gasLimit:o,storageLimit:n}=t,c=__rest(t,["fee","gasLimit","storageLimit"]);return __awaiter(this,void 0,void 0,function*(){let t=s,e=o,r=n;var i;return void 0!==s&&void 0!==o&&void 0!==n||(i=yield a(Object.assign({fee:s,gasLimit:o,storageLimit:n},c)),void 0===t&&(t=i.suggestedFeeMutez),void 0===e&&(e=i.gasLimit),void 0===r&&(r=i.storageLimit)),{fee:t,gasLimit:e,storageLimit:r}})}signAndInject(e){return __awaiter(this,void 0,void 0,function*(){var t=yield this.signer.sign(e.opbytes,new Uint8Array([3]));e.opbytes=t.sbytes,e.opOb.signature=t.prefixSig;const r=[];var i=yield this.rpc.preapplyOperations([e.opOb]);if(!Array.isArray(i))throw new TezosPreapplyFailureError(i);for(let e=0;e<i.length;e++)for(let t=0;t<i[e].contents.length;t++)r.push(i[e].contents[t]);t=flattenErrors(i);if(t.length)throw new TezosOperationError(t,"Error occurred during validation simulation of operation");return{hash:yield this.context.injector.inject(e.opbytes),forgedBytes:e,opResponse:r,context:this.context.clone()}})}}const BATCH_KINDS=[OpKind.ACTIVATION,OpKind.ORIGINATION,OpKind.TRANSACTION,OpKind.DELEGATION];class OperationBatch extends OperationEmitter{constructor(t,e){super(t),this.estimator=e,this.operations=[]}withTransfer(t){if(validateAddress(t.to)!==ValidationResult.VALID)throw new InvalidAddressError(t.to);return this.operations.push(Object.assign({kind:OpKind.TRANSACTION},t)),this}withContractCall(t){return this.withTransfer(t.toTransferParams())}withDelegation(t){if(t.source&&validateAddress(t.source)!==ValidationResult.VALID)throw new InvalidAddressError(t.source);if(t.delegate&&validateAddress(t.delegate)!==ValidationResult.VALID)throw new InvalidAddressError(t.delegate);return this.operations.push(Object.assign({kind:OpKind.DELEGATION},t)),this}withActivation({pkh:t,secret:e}){if(validateKeyHash(t)!==ValidationResult.VALID)throw new InvalidKeyHashError(t);return this.operations.push({kind:OpKind.ACTIVATION,pkh:t,secret:e}),this}withOrigination(t){return this.operations.push(Object.assign({kind:OpKind.ORIGINATION},t)),this}withRegisterGlobalConstant(t){return this.operations.push(Object.assign({kind:OpKind.REGISTER_GLOBAL_CONSTANT},t)),this}getRPCOp(t){return __awaiter(this,void 0,void 0,function*(){switch(t.kind){case OpKind.TRANSACTION:return createTransferOperation(Object.assign({},t));case OpKind.ORIGINATION:return createOriginationOperation(yield this.context.parser.prepareCodeOrigination(Object.assign({},t)));case OpKind.DELEGATION:return createSetDelegateOperation(Object.assign({},t));case OpKind.ACTIVATION:return Object.assign({},t);case OpKind.REGISTER_GLOBAL_CONSTANT:return createRegisterGlobalConstantOperation(Object.assign({},t));default:throw new InvalidOperationKindError(t.kind)}})}with(t){for(const e of t)switch(e.kind){case OpKind.TRANSACTION:this.withTransfer(e);break;case OpKind.ORIGINATION:this.withOrigination(e);break;case OpKind.DELEGATION:this.withDelegation(e);break;case OpKind.ACTIVATION:this.withActivation(e);break;case OpKind.REGISTER_GLOBAL_CONSTANT:this.withRegisterGlobalConstant(e);break;default:throw new InvalidOperationKindError(e.kind)}return this}send(l){return __awaiter(this,void 0,void 0,function*(){var t=yield this.signer.publicKeyHash(),e=yield this.signer.publicKey();const r=yield this.estimator.batch(this.operations);var i,a=yield this.isRevealOpNeeded(this.operations,t);let s=a?1:0;const o=[];for(const d of this.operations)isOpWithFee(d)?(i=yield this.estimate(d,()=>__awaiter(this,void 0,void 0,function*(){return r[s]})),o.push(yield this.getRPCOp(Object.assign(Object.assign({},d),i)))):o.push(Object.assign({},d)),s++;a&&(a={kind:OpKind.REVEAL},a=yield this.estimate(a,()=>__awaiter(this,void 0,void 0,function*(){return r[0]})),o.unshift(yield createRevealOperation(Object.assign({},a),t,e)));var a=l&&l.source||t,e=yield this.prepareOperation({operation:o,source:a}),t=yield this.forge(e),{hash:e,context:t,forgedBytes:n,opResponse:c}=yield this.signAndInject(t);return new BatchOperation(e,o,a,n,c,t)})}}class RPCBatchProvider{constructor(t,e){this.context=t,this.estimator=e}batch(t){const e=new OperationBatch(this.context,this.estimator);return Array.isArray(t)&&e.with(t),e}}const receiptFromOperation=(t,{ALLOCATION_BURN:e,ORIGINATION_BURN:r}={ALLOCATION_BURN:257,ORIGINATION_BURN:257})=>{const i=flattenOperationResult({contents:t});let a=new BigNumber(0),s=new BigNumber(0),o=new BigNumber(0),n=new BigNumber(0),c=new BigNumber(0),d=new BigNumber(0);return i.forEach(t=>{o=o.plus(t.fee||0),n=n.plus(Array.isArray(t.originated_contracts)?t.originated_contracts.length*r:0),c=c.plus("allocated_destination_contract"in t?e:0),a=a.plus(t.consumed_gas||0),d=d.plus("paid_storage_size_diff"in t&&Number(t.paid_storage_size_diff)||0)}),s=s.plus(c).plus(n).plus(d),{totalFee:o,totalGas:a,totalStorage:s,totalAllocationBurn:c,totalOriginationBurn:n,totalPaidStorageDiff:d,totalStorageBurn:new BigNumber(s.multipliedBy(1e3))}};class MissedBlockDuringConfirmationError extends Error{constructor(){super("Taquito missed a block while waiting for operation confirmation and was not able to find the operation"),this.name="MissedBlockDuringConfirmationError"}}const MAX_BRANCH_ANCESTORS=60;class WalletOperation{constructor(t,e,r){if(this.opHash=t,this.context=e,this._newHead$=r,this._operationResult=new ReplaySubject(1),this._includedInBlock=new ReplaySubject(1),this._included=!1,this.newHead$=this._newHead$.pipe(tap(t=>{if(!this._included&&this.lastHead&&1<t.header.level-this.lastHead.header.level)throw new MissedBlockDuringConfirmationError;this.lastHead=t}),shareReplay({bufferSize:1,refCount:!0})),this.confirmed$=this.newHead$.pipe(map(t=>{for(const e of t.operations)for(const r of e)if(r.hash===this.opHash)return this._included=!0,this._includedInBlock.next(t),this._operationResult.next(r.contents),t}),filter(t=>void 0!==t),first(),shareReplay({bufferSize:1,refCount:!0})),validateOperation(this.opHash)!==ValidationResult.VALID)throw new InvalidOperationHashError(this.opHash);this.confirmed$.pipe(first(),catchError(()=>of(void 0))).subscribe()}operationResults(){return __awaiter(this,void 0,void 0,function*(){return this._operationResult.pipe(first()).toPromise()})}receipt(){return __awaiter(this,void 0,void 0,function*(){return receiptFromOperation(yield this.operationResults())})}getCurrentConfirmation(){return __awaiter(this,void 0,void 0,function*(){return this._included?combineLatest([this._includedInBlock,from(this.context.readProvider.getBlock("head"))]).pipe(map(([t,e])=>e.header.level-t.header.level+1),first()).toPromise():0})}isInCurrentBranch(i="head"){return __awaiter(this,void 0,void 0,function*(){if(!this._included)return!0;var t=yield this.context.readProvider.getBlockLevel(i),e=yield this._includedInBlock.pipe(first()).toPromise(),t=t-e.header.level;if(t<=0)return!0;t=Math.min(e.header.level+t,e.header.level+MAX_BRANCH_ANCESTORS);const r=new Set(yield this.context.readProvider.getLiveBlocks(t));return r.has(e.hash)})}confirmationObservable(t){if(void 0!==t&&t<1)throw new InvalidConfirmationCountError("Confirmation count must be at least 1");var e=this.context.config["defaultConfirmationCount"];const r=void 0!==t?t:e;if(void 0===r)throw new ConfirmationUndefinedError("Default confirmation count can not be undefined!");return combineLatest([this._includedInBlock,this.newHead$]).pipe(distinctUntilChanged(([,t],[,e])=>t.hash===e.hash),map(([t,e])=>({block:e,expectedConfirmation:r,currentConfirmation:e.header.level-t.header.level+1,completed:e.header.level-t.header.level>=r-1,isInCurrentBranch:()=>this.isInCurrentBranch(e.hash)})),takeWhile(({completed:t})=>!t,!0))}confirmation(t){return this.confirmationObservable(t).toPromise()}}class BatchWalletOperation extends WalletOperation{constructor(t,e,r){super(t,e,r),this.opHash=t,this.context=e}revealOperation(){return __awaiter(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===OpKind.REVEAL)})}status(){return __awaiter(this,void 0,void 0,function*(){if(!this._included)return"pending";const t=yield this.operationResults();return t.filter(t=>-1!==BATCH_KINDS.indexOf(t.kind)).map(t=>hasMetadataWithResult(t)?t.metadata.operation_result.status:"unknown")[0]||"unknown"})}}class DelegationWalletOperation extends WalletOperation{constructor(t,e,r){super(t,e,r),this.opHash=t,this.context=e}revealOperation(){return __awaiter(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===OpKind.REVEAL)})}delegationOperation(){return __awaiter(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===OpKind.DELEGATION)})}status(){return __awaiter(this,void 0,void 0,function*(){if(!this._included)return"pending";var t=yield this.delegationOperation();return t?t.metadata.operation_result.status:"unknown"})}}class OriginationWalletOperation extends WalletOperation{constructor(t,e,r){super(t,e,r),this.opHash=t,this.context=e}originationOperation(){return __awaiter(this,void 0,void 0,function*(){var t=yield this.operationResults();return findWithKind(t,OpKind.ORIGINATION)})}revealOperation(){return __awaiter(this,void 0,void 0,function*(){var t=yield this.operationResults();return findWithKind(t,OpKind.REVEAL)})}status(){return __awaiter(this,void 0,void 0,function*(){if(!this._included)return"pending";var t=yield this.originationOperation();return t?t.metadata.operation_result.status:"unknown"})}contract(){return __awaiter(this,void 0,void 0,function*(){var t=yield this.originationOperation(),t=((null==t?void 0:t.metadata.operation_result.originated_contracts)||[])[0];return this.context.wallet.at(t)})}}class TransactionWalletOperation extends WalletOperation{constructor(t,e,r){super(t,e,r),this.opHash=t,this.context=e}revealOperation(){return __awaiter(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===OpKind.REVEAL)})}transactionOperation(){return __awaiter(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===OpKind.TRANSACTION)})}status(){return __awaiter(this,void 0,void 0,function*(){if(!this._included)return"pending";var t=yield this.transactionOperation();return t?t.metadata.operation_result.status:"unknown"})}}const createNewPollingBasedHeadObservable=(t,e,r)=>t.pipe(timeoutWith(1e3*e.config.confirmationPollingTimeoutSecond,throwError(new Error("Confirmation polling timed out")),r),shareReplay({refCount:!0,scheduler:r}));class OperationFactory{constructor(t){this.context=t,this.sharedHeadObs=defer(()=>createObservableFromSubscription(this.context.stream.subscribeBlock("head")))}createNewHeadObservable(){return __awaiter(this,void 0,void 0,function*(){return createNewPollingBasedHeadObservable(this.sharedHeadObs,this.context)})}createPastBlockWalker(t,e=1){return from(this.context.readProvider.getBlock(t)).pipe(switchMap(t=>1===e?of(t):range(t.header.level,e-1).pipe(startWith(t),concatMap(t=>__awaiter(this,void 0,void 0,function*(){return this.context.readProvider.getBlock("number"==typeof t?t:t.header.level)})))))}createHeadObservableFromConfig({blockIdentifier:e}){return __awaiter(this,void 0,void 0,function*(){const t=[];return e&&t.push(this.createPastBlockWalker(e)),t.push(yield this.createNewHeadObservable()),concat(...t)})}createOperation(t,e={}){return __awaiter(this,void 0,void 0,function*(){return new WalletOperation(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}createBatchOperation(t,e={}){return __awaiter(this,void 0,void 0,function*(){return new BatchWalletOperation(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}createTransactionOperation(t,e={}){return __awaiter(this,void 0,void 0,function*(){return new TransactionWalletOperation(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}createDelegationOperation(t,e={}){return __awaiter(this,void 0,void 0,function*(){return new DelegationWalletOperation(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}createOriginationOperation(t,e={}){return __awaiter(this,void 0,void 0,function*(){return new OriginationWalletOperation(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}}class RpcTzProvider extends OperationEmitter{constructor(t){super(t)}getBalance(t){return __awaiter(this,void 0,void 0,function*(){if(validateAddress(t)!==ValidationResult.VALID)throw new InvalidAddressError(t);return this.context.readProvider.getBalance(t,"head")})}getDelegate(t){return __awaiter(this,void 0,void 0,function*(){if(validateAddress(t)!==ValidationResult.VALID)throw new InvalidAddressError(t);return this.context.readProvider.getDelegate(t,"head")})}activate(r,i){return __awaiter(this,void 0,void 0,function*(){if(validateKeyHash(r)!==ValidationResult.VALID)throw new InvalidKeyHashError(r);var t={kind:OpKind.ACTIVATION,pkh:r,secret:i},t=yield this.prepareOperation({operation:[t],source:r}),t=yield this.forge(t),e=t.opbytes+"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";return new Operation(yield this.rpc.injectOperation(e),Object.assign(Object.assign({},t),{opbytes:e}),[],this.context.clone())})}}const MINIMAL_FEE_MUTEZ=100,MINIMAL_FEE_PER_BYTE_MUTEZ=1,MINIMAL_FEE_PER_GAS_MUTEZ=.1,GAS_BUFFER=100;class Estimate{constructor(t,e,r,i,a=MINIMAL_FEE_MUTEZ){this._milligasLimit=t,this._storageLimit=e,this.opSize=r,this.minimalFeePerStorageByteMutez=i,this.baseFeeMutez=a}get burnFeeMutez(){return this.roundUp(Number(this.storageLimit)*Number(this.minimalFeePerStorageByteMutez))}get storageLimit(){var t=Math.max(Number(this._storageLimit),0);return 0<t?t:0}get gasLimit(){return this.roundUp(Number(this._milligasLimit)/1e3+GAS_BUFFER)}get operationFeeMutez(){return(Number(this._milligasLimit)/1e3+GAS_BUFFER)*MINIMAL_FEE_PER_GAS_MUTEZ+Number(this.opSize)*MINIMAL_FEE_PER_BYTE_MUTEZ}roundUp(t){return Math.ceil(Number(t))}get minimalFeeMutez(){return this.roundUp(MINIMAL_FEE_MUTEZ+this.operationFeeMutez)}get suggestedFeeMutez(){return this.roundUp(this.operationFeeMutez+2*MINIMAL_FEE_MUTEZ)}get usingBaseFeeMutez(){return Math.max(Number(this.baseFeeMutez),MINIMAL_FEE_MUTEZ)+this.roundUp(this.operationFeeMutez)}get totalCost(){return this.minimalFeeMutez+this.burnFeeMutez}get consumedMilligas(){return Number(this._milligasLimit)}static createEstimateInstanceFromProperties(t){let e=0,r=0,i=0,a=0,s;return t.forEach(t=>{e+=t.milligasLimit,r+=t.storageLimit,i+=t.opSize,a=Math.max(t.minimalFeePerStorageByteMutez,a),t.baseFeeMutez&&(s=s?s+t.baseFeeMutez:t.baseFeeMutez)}),new Estimate(e,r,i,a,s)}static createArrayEstimateInstancesFromProperties(t){return t.map(t=>new Estimate(t.milligasLimit,t.storageLimit,t.opSize,t.minimalFeePerStorageByteMutez,t.baseFeeMutez))}}class RevealEstimateError extends Error{constructor(){super("Unable to estimate the reveal operation, the public key is unknown"),this.name="Reveal Estimate Error"}}const mergeLimits=(t,e)=>({fee:(void 0===t.fee?e:t).fee,gasLimit:(void 0===t.gasLimit?e:t).gasLimit,storageLimit:(void 0===t.storageLimit?e:t).storageLimit}),SIGNATURE_STUB="edsigtkpiSSschcaCt9pUVrpNPf7TTcgvgDEDD6NCEHMy8NNQJCGnMfLZzYoQj74yLjo9wx6MPVV29CvVzgi7qEcEUok3k7AuMg";class RPCEstimateProvider extends OperationEmitter{constructor(){super(...arguments),this.ALLOCATION_STORAGE=257,this.ORIGINATION_STORAGE=257,this.OP_SIZE_REVEAL=128}getKeys(){return __awaiter(this,void 0,void 0,function*(){var t=this.context.isAnySignerConfigured();return{publicKeyHash:t?yield this.signer.publicKeyHash():yield this.context.walletProvider.getPKH(),publicKey:t?yield this.signer.publicKey():void 0}})}getAccountLimits(s,o,n){return __awaiter(this,void 0,void 0,function*(){const t=yield this.context.readProvider.getBalance(s,"head"),{hard_gas_limit_per_operation:e,hard_gas_limit_per_block:r,hard_storage_limit_per_operation:i,cost_per_byte:a}=o;return{fee:0,gasLimit:n?Math.floor(this.ajustGasForBatchOperation(r,e,n).toNumber()):e.toNumber(),storageLimit:Math.floor(BigNumber.min(t.dividedBy(a),i).toNumber())}})}ajustGasForBatchOperation(t,e,r){return BigNumber.min(e,t.div(r+1))}getEstimationPropertiesFromOperationContent(t,e,r){const i=flattenOperationResult({contents:[t]});let a=0,s=0,o=0;return i.forEach(t=>{o=(o+="originated_contracts"in t&&void 0!==t.originated_contracts?t.originated_contracts.length*this.ORIGINATION_STORAGE:0)+("allocated_destination_contract"in t?this.ALLOCATION_STORAGE:0),a+=Number(t.consumed_gas)||0,s+=Number(t.consumed_milligas)||0,o=(o+="paid_storage_size_diff"in t&&Number(t.paid_storage_size_diff)||0)+("storage_size"in t&&"global_address"in t&&Number(t.storage_size)||0)}),0!==a&&0===s&&(s=1e3*a),isOpWithFee(t)?{milligasLimit:s||0,storageLimit:Number(o||0),opSize:e,minimalFeePerStorageByteMutez:r.toNumber()}:{milligasLimit:0,storageLimit:0,opSize:e,minimalFeePerStorageByteMutez:r.toNumber(),baseFeeMutez:0}}prepareEstimate(n,c,d){return __awaiter(this,void 0,void 0,function*(){var t=yield this.prepareOperation(n,d);const{opbytes:e,opOb:{branch:r,contents:i}}=yield this.forge(t);t={operation:{branch:r,contents:i,signature:SIGNATURE_STUB},chain_id:yield this.context.readProvider.getChainId()};const a=(yield this.simulate(t))["opResponse"],s=c["cost_per_byte"];t=[...flattenErrors(a,"backtracked"),...flattenErrors(a)];if(t.length)throw new TezosOperationError(t,"Error occurred during estimation");let o=1;return Array.isArray(n.operation)&&1<n.operation.length&&(o="reveal"===a.contents[0].kind?n.operation.length-1:n.operation.length),a.contents.map(t=>this.getEstimationPropertiesFromOperationContent(t,"reveal"===t.kind?this.OP_SIZE_REVEAL/2:e.length/2/o,s))})}originate(t){var{fee:s,storageLimit:o,gasLimit:n}=t,c=__rest(t,["fee","storageLimit","gasLimit"]);return __awaiter(this,void 0,void 0,function*(){var t=(yield this.getKeys())["publicKeyHash"],e=yield this.context.readProvider.getProtocolConstants("head"),r=yield this.getAccountLimits(t,e),r=yield createOriginationOperation(yield this.context.parser.prepareCodeOrigination(Object.assign(Object.assign({},c),mergeLimits({fee:s,storageLimit:o,gasLimit:n},r)))),i=yield this.isRevealOpNeeded([r],t),r=i?yield this.addRevealOp([r],t):r;const a=yield this.prepareEstimate({operation:r,source:t},e,t);return i&&a.shift(),Estimate.createEstimateInstanceFromProperties(a)})}transfer(t){var{fee:s,storageLimit:o,gasLimit:n}=t,c=__rest(t,["fee","storageLimit","gasLimit"]);return __awaiter(this,void 0,void 0,function*(){if(validateAddress(c.to)!==ValidationResult.VALID)throw new InvalidAddressError(c.to);if(c.source&&validateAddress(c.source)!==ValidationResult.VALID)throw new InvalidAddressError(c.source);var t=(yield this.getKeys()).publicKeyHash,e=yield this.context.readProvider.getProtocolConstants("head"),r=yield this.getAccountLimits(t,e),r=yield createTransferOperation(Object.assign(Object.assign({},c),mergeLimits({fee:s,storageLimit:o,gasLimit:n},r))),i=yield this.isRevealOpNeeded([r],t),r=i?yield this.addRevealOp([r],t):r;const a=yield this.prepareEstimate({operation:r,source:t},e,t);return i&&a.shift(),Estimate.createEstimateInstanceFromProperties(a)})}setDelegate(t){var{fee:s,gasLimit:o,storageLimit:n}=t,c=__rest(t,["fee","gasLimit","storageLimit"]);return __awaiter(this,void 0,void 0,function*(){if(c.source&&validateAddress(c.source)!==ValidationResult.VALID)throw new InvalidAddressError(c.source);if(c.delegate&&validateAddress(c.delegate)!==ValidationResult.VALID)throw new InvalidAddressError(c.delegate);var t=(yield this.getKeys()).publicKeyHash,e=c.source||t,r=yield this.context.readProvider.getProtocolConstants("head"),e=yield this.getAccountLimits(e,r),e=yield createSetDelegateOperation(Object.assign(Object.assign({},c),mergeLimits({fee:s,storageLimit:n,gasLimit:o},e))),i=yield this.isRevealOpNeeded([e],t),e=i?yield this.addRevealOp([e],t):e;const a=yield this.prepareEstimate({operation:e,source:t},r,t);return i&&a.shift(),Estimate.createEstimateInstanceFromProperties(a)})}batch(o){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.getKeys())["publicKeyHash"];let e=[];var r=yield this.context.readProvider.getProtocolConstants("head"),i=yield this.getAccountLimits(t,r,o.length);for(const s of o)switch(s.kind){case OpKind.TRANSACTION:e.push(yield createTransferOperation(Object.assign(Object.assign({},s),mergeLimits(s,i))));break;case OpKind.ORIGINATION:e.push(yield createOriginationOperation(yield this.context.parser.prepareCodeOrigination(Object.assign(Object.assign({},s),mergeLimits(s,i)))));break;case OpKind.DELEGATION:e.push(yield createSetDelegateOperation(Object.assign(Object.assign({},s),mergeLimits(s,i))));break;case OpKind.ACTIVATION:e.push(Object.assign(Object.assign({},s),i));break;case OpKind.REGISTER_GLOBAL_CONSTANT:e.push(yield createRegisterGlobalConstantOperation(Object.assign(Object.assign({},s),mergeLimits(s,i))));break;default:throw new InvalidOperationKindError(o.kind)}var a=yield this.isRevealOpNeeded(e,t),a=(e=a?yield this.addRevealOp(e,t):e,yield this.prepareEstimate({operation:e,source:t},r,t));return Estimate.createArrayEstimateInstancesFromProperties(a)})}registerDelegate(s){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.getKeys()).publicKeyHash,e=yield this.context.readProvider.getProtocolConstants("head"),r=yield this.getAccountLimits(t,e),r=yield createRegisterDelegateOperation(Object.assign(Object.assign({},s),r),t),i=yield this.isRevealOpNeeded([r],t),r=i?yield this.addRevealOp([r],t):r;const a=yield this.prepareEstimate({operation:r,source:t},e,t);return i&&a.shift(),Estimate.createEstimateInstanceFromProperties(a)})}reveal(a){return __awaiter(this,void 0,void 0,function*(){var t,e,{publicKeyHash:r,publicKey:i}=yield this.getKeys();if(!i)throw new RevealEstimateError;if(yield this.isAccountRevealRequired(r))return t=yield this.context.readProvider.getProtocolConstants("head"),e=yield this.getAccountLimits(r,t),e=yield createRevealOperation(Object.assign(Object.assign({},a),e),r,i),i=yield this.prepareEstimate({operation:e,source:r},t,r),Estimate.createEstimateInstanceFromProperties(i)})}registerGlobalConstant(t){var{fee:s,storageLimit:o,gasLimit:n}=t,c=__rest(t,["fee","storageLimit","gasLimit"]);return __awaiter(this,void 0,void 0,function*(){var t=(yield this.getKeys()).publicKeyHash,e=yield this.context.readProvider.getProtocolConstants("head"),r=yield this.getAccountLimits(t,e),r=yield createRegisterGlobalConstantOperation(Object.assign(Object.assign({},c),mergeLimits({fee:s,storageLimit:o,gasLimit:n},r))),i=yield this.isRevealOpNeeded([r],t),r=i?yield this.addRevealOp([r],t):r;const a=yield this.prepareEstimate({operation:r,source:t},e,t);return i&&a.shift(),Estimate.createEstimateInstanceFromProperties(a)})}addRevealOp(e,r){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.getKeys())["publicKey"];if(t)return e.unshift(yield createRevealOperation(Object.assign({fee:DEFAULT_FEE.REVEAL,gasLimit:DEFAULT_GAS_LIMIT.REVEAL,storageLimit:DEFAULT_STORAGE_LIMIT.REVEAL}),r,yield this.signer.publicKey())),e;throw new RevealEstimateError})}}class DelegateOperation extends Operation{constructor(t,e,r,i,a,s){super(t,i,a,s),this.params=e,this.source=r}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"delegation"===t.kind),t=t&&t.metadata&&t.metadata.operation_result;return t||void 0}get status(){var t=this.operationResults;return t?t.status:"unknown"}get delegate(){return this.delegate}get isRegisterOperation(){return this.delegate===this.source}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}get consumedGas(){var t=this.operationResults&&this.operationResults.consumed_gas;return t||void 0}get errors(){return this.operationResults&&this.operationResults.errors}}class OriginationOperation extends Operation{constructor(t,e,r,i,a,s){super(t,r,i,a),this.params=e,this.contractProvider=s;t=this.operationResults&&this.operationResults.originated_contracts;Array.isArray(t)&&(this.contractAddress=t[0])}get status(){var t=this.operationResults;return t?t.status:"unknown"}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"origination"===t.kind),t=t&&hasMetadataWithResult(t)&&t.metadata.operation_result;return t||void 0}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}get consumedGas(){var t=this.operationResults&&this.operationResults.consumed_gas;return t||void 0}get storageDiff(){var t=this.operationResults&&this.operationResults.paid_storage_size_diff;return t||void 0}get storageSize(){var t=this.operationResults&&this.operationResults.storage_size;return t||void 0}get errors(){return this.operationResults&&this.operationResults.errors}contract(t,e){return __awaiter(this,void 0,void 0,function*(){if(this.contractAddress)return yield this.confirmation(t,e),this.contractProvider.at(this.contractAddress);throw new OriginationOperationError("No contract was originated in this operation")})}}class RegisterGlobalConstantOperation extends Operation{constructor(t,e,r,i,a,s){super(t,i,a,s),this.params=e,this.source=r,this.globalConstantHash=this.operationResults&&this.operationResults.global_address}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"register_global_constant"===t.kind),t=t&&t.metadata&&t.metadata.operation_result;return t||void 0}get status(){var t=this.operationResults;return t?t.status:"unknown"}get registeredExpression(){return this.params.value}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}get errors(){return this.operationResults&&this.operationResults.errors}}class RevealOperation extends Operation{constructor(t,e,r,i,a,s){super(t,i,a,s),this.params=e,this.source=r}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"reveal"===t.kind);return t?[t]:[]}get status(){var t=this.operationResults[0];return t?t.metadata.operation_result.status:"unknown"}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}get publicKey(){return this.params.public_key}sumProp(t,r){return t.reduce((t,e)=>r in e?Number(e[r])+t:t,0)}get consumedGas(){return String(this.sumProp(flattenOperationResult({contents:this.operationResults}),"consumed_gas"))}get storageDiff(){return String(this.sumProp(flattenOperationResult({contents:this.operationResults}),"paid_storage_size_diff"))}get storageSize(){return String(this.sumProp(flattenOperationResult({contents:this.operationResults}),"storage_size"))}get errors(){return flattenErrors({contents:this.operationResults})}}class TransactionOperation extends Operation{constructor(t,e,r,i,a,s){super(t,i,a,s),this.params=e,this.source=r}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"transaction"===t.kind);return t?[t]:[]}get status(){var t=this.operationResults[0];return t?t.metadata.operation_result.status:"unknown"}get amount(){return new BigNumber(this.params.amount)}get destination(){return this.params.destination}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}sumProp(t,r){return t.reduce((t,e)=>r in e?Number(e[r])+t:t,0)}get consumedGas(){return String(this.sumProp(flattenOperationResult({contents:this.operationResults}),"consumed_gas"))}get storageDiff(){return String(this.sumProp(flattenOperationResult({contents:this.operationResults}),"paid_storage_size_diff"))}get storageSize(){return String(this.sumProp(flattenOperationResult({contents:this.operationResults}),"storage_size"))}get errors(){return flattenErrors({contents:this.operationResults})}}const setDelegate=t=>[{prim:"DROP"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"PUSH",args:[{prim:"key_hash"},{string:t}]},{prim:"SOME"},{prim:"SET_DELEGATE"},{prim:"CONS"}],transferImplicit=(t,e)=>[{prim:"DROP"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"PUSH",args:[{prim:"key_hash"},{string:t}]},{prim:"IMPLICIT_ACCOUNT"},{prim:"PUSH",args:[{prim:"mutez"},{int:""+e}]},{prim:"UNIT"},{prim:"TRANSFER_TOKENS"},{prim:"CONS"}],removeDelegate=()=>[{prim:"DROP"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"NONE",args:[{prim:"key_hash"}]},{prim:"SET_DELEGATE"},{prim:"CONS"}],transferToContract=(t,e)=>[{prim:"DROP"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"PUSH",args:[{prim:"address"},{string:t}]},{prim:"CONTRACT",args:[{prim:"unit"}]},[{prim:"IF_NONE",args:[[[{prim:"UNIT"},{prim:"FAILWITH"}]],[]]}],{prim:"PUSH",args:[{prim:"mutez"},{int:""+e}]},{prim:"UNIT"},{prim:"TRANSFER_TOKENS"},{prim:"CONS"}],MANAGER_LAMBDA={setDelegate:setDelegate,removeDelegate:removeDelegate,transferImplicit:transferImplicit,transferToContract:transferToContract},code=[{prim:"parameter",args:[{prim:"lambda",args:[{prim:"unit"},{prim:"pair",args:[{prim:"list",args:[{prim:"operation"}]},{prim:"unit"}]}]}]},{prim:"storage",args:[{prim:"unit"}]},{prim:"code",args:[[{prim:"CAR"},{prim:"UNIT"},{prim:"EXEC"}]]}],storage="Unit",VIEW_LAMBDA={code:code,storage:storage};function compose(r,i){return(t,e)=>i(r(t,e),e)}class ContractMethod{constructor(t,e,r,i,a,s=!0,o=!1){this.provider=t,this.address=e,this.parameterSchema=r,this.name=i,this.args=a,this.isMultipleEntrypoint=s,this.isAnonymous=o}validateArgs(e,t,r){const i=t.ExtractSignatures();if(!i.find(t=>t.length===e.length))throw new InvalidParameterError(r,i,e)}get schema(){return this.isAnonymous?this.parameterSchema.ExtractSchema()[this.name]:this.parameterSchema.ExtractSchema()}getSignature(){var t;if(!this.isAnonymous)return 1==(t=this.parameterSchema.ExtractSignatures()).length?t[0]:t;{const e=this.parameterSchema.ExtractSignatures().find(t=>t[0]===this.name);if(e)return e.shift(),e}}send(t={}){return this.provider instanceof Wallet?this.provider.transfer(this.toTransferParams(t)).send():this.provider.transfer(this.toTransferParams(t))}toTransferParams({fee:t,gasLimit:e,storageLimit:r,source:i,amount:a=0,mutez:s=!1}={}){return{to:this.address,amount:a,fee:t,mutez:s,source:i,gasLimit:e,storageLimit:r,parameter:{entrypoint:this.isMultipleEntrypoint?this.name:DEFAULT_SMART_CONTRACT_METHOD_NAME,value:this.isAnonymous?this.parameterSchema.Encode(this.name,...this.args):this.parameterSchema.Encode(...this.args)}}}}class WalletOperationBatch{constructor(t,e){this.walletProvider=t,this.context=e,this.operations=[]}withTransfer(t){if(validateAddress(t.to)!==ValidationResult.VALID)throw new InvalidAddressError(t.to);return this.operations.push(Object.assign({kind:OpKind.TRANSACTION},t)),this}withContractCall(t){return this.withTransfer(t.toTransferParams())}withDelegation(t){if(t.delegate&&validateAddress(t.delegate)!==ValidationResult.VALID)throw new InvalidAddressError(t.delegate);return this.operations.push(Object.assign({kind:OpKind.DELEGATION},t)),this}withOrigination(t){return this.operations.push(Object.assign({kind:OpKind.ORIGINATION},t)),this}mapOperation(t){return __awaiter(this,void 0,void 0,function*(){switch(t.kind){case OpKind.TRANSACTION:return this.walletProvider.mapTransferParamsToWalletParams(()=>__awaiter(this,void 0,void 0,function*(){return t}));case OpKind.ORIGINATION:return this.walletProvider.mapOriginateParamsToWalletParams(()=>__awaiter(this,void 0,void 0,function*(){return this.context.parser.prepareCodeOrigination(Object.assign({},t))}));case OpKind.DELEGATION:return this.walletProvider.mapDelegateParamsToWalletParams(()=>__awaiter(this,void 0,void 0,function*(){return t}));default:throw new InvalidOperationKindError(t.kind)}})}with(t){for(const e of t)switch(e.kind){case OpKind.TRANSACTION:this.withTransfer(e);break;case OpKind.ORIGINATION:this.withOrigination(e);break;case OpKind.DELEGATION:this.withDelegation(e);break;default:throw new InvalidOperationKindError(e.kind)}return this}send(){return __awaiter(this,void 0,void 0,function*(){const t=[];for(const r of this.operations)t.push(yield this.mapOperation(r));var e=yield this.walletProvider.sendOperations(t);return this.context.operationFactory.createBatchOperation(e)})}}class Wallet{constructor(t){this.context=t,this.walletCommand=t=>({send:t})}get walletProvider(){return this.context.walletProvider}pkh({forceRefetch:t}={}){return __awaiter(this,void 0,void 0,function*(){return this._pkh&&!t||(this._pkh=yield this.walletProvider.getPKH()),this._pkh})}originate(e){return this.walletCommand(()=>__awaiter(this,void 0,void 0,function*(){var t=yield this.walletProvider.mapOriginateParamsToWalletParams(()=>this.context.parser.prepareCodeOrigination(Object.assign({},e))),t=yield this.walletProvider.sendOperations([t]);return this.context.operationFactory.createOriginationOperation(t)}))}setDelegate(e){if(e.delegate&&validateAddress(e.delegate)!==ValidationResult.VALID)throw new InvalidAddressError(e.delegate);return this.walletCommand(()=>__awaiter(this,void 0,void 0,function*(){var t=yield this.walletProvider.mapDelegateParamsToWalletParams(()=>__awaiter(this,void 0,void 0,function*(){return e})),t=yield this.walletProvider.sendOperations([t]);return this.context.operationFactory.createDelegationOperation(t)}))}registerDelegate(){return this.walletCommand(()=>__awaiter(this,void 0,void 0,function*(){var t=yield this.walletProvider.mapDelegateParamsToWalletParams(()=>__awaiter(this,void 0,void 0,function*(){return{delegate:yield this.pkh()}})),t=yield this.walletProvider.sendOperations([t]);return this.context.operationFactory.createDelegationOperation(t)}))}transfer(e){if(validateAddress(e.to)!==ValidationResult.VALID)throw new InvalidAddressError(e.to);return this.walletCommand(()=>__awaiter(this,void 0,void 0,function*(){var t=yield this.walletProvider.mapTransferParamsToWalletParams(()=>__awaiter(this,void 0,void 0,function*(){return e})),t=yield this.walletProvider.sendOperations([t]);return this.context.operationFactory.createTransactionOperation(t)}))}batch(t){const e=new WalletOperationBatch(this.walletProvider,this.context);return Array.isArray(t)&&e.with(t),e}at(a,s=t=>t){return __awaiter(this,void 0,void 0,function*(){if(validateContractAddress(a)!==ValidationResult.VALID)throw new InvalidContractAddressError(a);var t=this.context.withExtensions().rpc;const e=this.context.withExtensions().readProvider;var r=yield e.getScript(a,"head"),i=yield e.getEntrypoints(a),r=new ContractAbstraction(a,r,this,this.context.contract,i,t,e);return s(r,this.context)})}}class LegacyWalletProvider{constructor(t){this.context=t}getPKH(){return __awaiter(this,void 0,void 0,function*(){return this.context.signer.publicKeyHash()})}mapTransferParamsToWalletParams(t){return __awaiter(this,void 0,void 0,function*(){return attachKind(yield t(),OpKind.TRANSACTION)})}mapOriginateParamsToWalletParams(t){return __awaiter(this,void 0,void 0,function*(){return attachKind(yield t(),OpKind.ORIGINATION)})}mapDelegateParamsToWalletParams(t){return __awaiter(this,void 0,void 0,function*(){return attachKind(yield t(),OpKind.DELEGATION)})}sendOperations(t){return __awaiter(this,void 0,void 0,function*(){return(yield this.context.batch.batch(t).send()).hash})}}class ContractMethodObject{constructor(t,e,r,i,a="unit",s=!0,o=!1){this.provider=t,this.address=e,this.parameterSchema=r,this.name=i,this.args=a,this.isMultipleEntrypoint=s,this.isAnonymous=o}getSignature(){return this.isAnonymous?this.parameterSchema.ExtractSchema()[this.name]:this.parameterSchema.ExtractSchema()}send(t={}){return this.provider instanceof Wallet?this.provider.transfer(this.toTransferParams(t)).send():this.provider.transfer(this.toTransferParams(t))}toTransferParams({fee:t,gasLimit:e,storageLimit:r,source:i,amount:a=0,mutez:s=!1}={}){return{to:this.address,amount:a,fee:t,mutez:s,source:i,gasLimit:e,storageLimit:r,parameter:{entrypoint:this.isMultipleEntrypoint?this.name:DEFAULT_SMART_CONTRACT_METHOD_NAME,value:this.isAnonymous?this.parameterSchema.EncodeObject({[this.name]:this.args}):this.parameterSchema.EncodeObject(this.args)}}}}const runCodeHelper=(t,e,r,i,a,s,o,n,c,d="0")=>({script:[{prim:"parameter",args:[{prim:"pair",args:[t,r]}]},{prim:"storage",args:[{prim:"option",args:[e]}]},{prim:"code",args:[[{prim:"CAR"},i,{prim:"SOME"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"PAIR"}]]}],storage:{prim:"None"},input:{prim:"Pair",args:[a,s]},amount:d,balance:o,chain_id:n,source:c});class OnChainView{constructor(t,e,r,i,a,s="Unit"){this._rpc=t,this._readProvider=e,this._contractAddress=r,this._smartContractViewSchema=i,this._contractStorageType=a,this._args=s}getSignature(){return{parameter:this._smartContractViewSchema.extractArgsSchema(),result:this._smartContractViewSchema.extractResultSchema()}}executeView(i){return __awaiter(this,void 0,void 0,function*(){this.verifyContextExecution(i);var t=(yield this._readProvider.getBalance(this._contractAddress,"head")).toString(),e=yield this._readProvider.getChainId(),r=yield this._readProvider.getStorage(this._contractAddress,"head");return this.executeViewAndDecodeResult(runCodeHelper(this._smartContractViewSchema.viewArgsType,this._smartContractViewSchema.viewReturnType,this._contractStorageType,this.adaptViewCodeToContext(this._smartContractViewSchema.instructions,i.viewCaller,t),this.transformArgsToMichelson(),r,t,e,i.source))})}verifyContextExecution(t){if(t.source&&validateAddress(t.source)!==ValidationResult.VALID)throw new InvalidViewSimulationContext(`The source account who initialized the view execution is invalid: ${t.source}.`);if(!t.viewCaller||validateAddress(t.viewCaller)!==ValidationResult.VALID)throw new InvalidViewSimulationContext(`The contract which is the caller of view is invalid: ${t.viewCaller}.`)}transformArgsToMichelson(){try{return this._smartContractViewSchema.encodeViewArgs(this._args)}catch(t){throw new InvalidViewParameterError(this._smartContractViewSchema.viewName,this.getSignature(),this._args,t)}}adaptViewCodeToContext(r,i,a){const s={BALANCE:[{prim:"PUSH",args:[{prim:"mutez"},{int:a}]}],SENDER:[{prim:"PUSH",args:[{prim:"address"},{string:i}]}],SELF_ADDRESS:[{prim:"PUSH",args:[{prim:"address"},{string:this._contractAddress}]}],AMOUNT:[{prim:"PUSH",args:[{prim:"mutez"},{int:"0"}]}]};return r.forEach((t,e)=>{t.prim in s&&(r[e]=Object(s)[t.prim]),t.args&&0!==t.args.length?this.adaptViewCodeToContext(t.args,i,a):Array.isArray(t)&&this.adaptViewCodeToContext(t,i,a)}),r}executeViewAndDecodeResult(r){return __awaiter(this,void 0,void 0,function*(){let t;try{t=(yield this._rpc.runCode(r)).storage}catch(t){var e=validateAndExtractFailwith(t);throw e?new ViewSimulationError(`The simulation of the on-chain view named ${this._smartContractViewSchema.viewName} failed with: `+JSON.stringify(e),this._smartContractViewSchema.viewName,e,t):t}if(t.args)return this._smartContractViewSchema.decodeViewResult(t.args[0]);throw new ViewSimulationError("View simulation failed with an invalid result: "+t,this._smartContractViewSchema.viewName)})}}class ContractMethodFactory{constructor(t,e){this.provider=t,this.contractAddress=e}createContractMethodFlatParams(t,e,r,i=!0,a=!1){return new ContractMethod(this.provider,this.contractAddress,t,e,r,i,a)}createContractMethodObjectParam(t,e,r,i=!0,a=!1){return new ContractMethodObject(this.provider,this.contractAddress,t,e,r,i,a)}createContractViewObjectParam(t,e,r,i,a){return new OnChainView(t,e,this.contractAddress,r,i,a)}}const DEFAULT_SMART_CONTRACT_METHOD_NAME="default";class ContractView{constructor(t,e,r,i,a,s,o){this.currentContract=t,this.name=e,this.callbackParametersSchema=r,this.parameterSchema=i,this.args=a,this.rpc=s,this.readProvider=o}read(e){return __awaiter(this,void 0,void 0,function*(){if(validateContractAddress(e)==ValidationResult.VALID)throw new DeprecationError("Since version 12, the lambda view no longer depends on a lambda contract. The read method no longer accepts a contract address as a parameter.");if(e&&validateChain(e)!==ValidationResult.VALID)throw new InvalidChainIdError(e);var t=this.parameterSchema.Encode(...this.args),t=yield this.rpc.runView({contract:this.currentContract.address,entrypoint:this.name,input:t,chain_id:e||(yield this.readProvider.getChainId())});return this.callbackParametersSchema.Execute(t.data)})}}const validateArgs=(e,t,r)=>{const i=t.ExtractSignatures();if(!i.find(t=>t.length===e.length))throw new InvalidParameterError(r,i,e)},isView=t=>{let e=!1;return"prim"in t&&"pair"===t.prim&&t.args&&("prim"in(t=t.args[t.args.length-1])&&"contract"===t.prim&&(e=!0)),e};class ContractAbstraction{constructor(t,e,r,i,a,s,o){this.address=t,this.script=e,this.storageProvider=i,this.entrypoints=a,this.rpc=s,this.readProvider=o,this.methods={},this.methodsObject={},this.views={},this.contractViews={},this.contractMethodFactory=new ContractMethodFactory(r,t),this.schema=Schema.fromRPCResponse({script:this.script}),this.parameterSchema=ParameterSchema.fromRPCResponse({script:this.script}),this.viewSchema=ViewSchema.fromRPCResponse({script:this.script}),0!==this.viewSchema.length&&this._initializeOnChainViews(this,s,this.readProvider,this.viewSchema),this._initializeMethods(this,this.entrypoints.entrypoints,this.rpc,this.readProvider)}_initializeMethods(a,s,o,n){const r=this.parameterSchema,t=Object.keys(s);if(r.isMultipleEntryPoint){t.forEach(i=>{const e=new ParameterSchema(s[i]);this.methods[i]=function(...t){return a.contractMethodFactory.createContractMethodFlatParams(e,i,t)},this.methodsObject[i]=function(t){return a.contractMethodFactory.createContractMethodObjectParam(e,i,t)},isView(s[i])&&(this.views[i]=function(...t){var e=s[i].args[0],e=new ParameterSchema(e),r=s[i].args[1].args[0],r=new ParameterSchema(r);return validateArgs(t,e,i),new ContractView(a,i,r,e,t,o,n)})});const e=Object.keys(r.ExtractSchema()).filter(t=>-1===Object.keys(s).indexOf(t));e.forEach(e=>{this.methods[e]=function(...t){return a.contractMethodFactory.createContractMethodFlatParams(r,e,t,!1,!0)},this.methodsObject[e]=function(t){return a.contractMethodFactory.createContractMethodObjectParam(r,e,t,!1,!0)}})}else{const i=this.parameterSchema;this.methods[DEFAULT_SMART_CONTRACT_METHOD_NAME]=function(...t){return a.contractMethodFactory.createContractMethodFlatParams(i,DEFAULT_SMART_CONTRACT_METHOD_NAME,t,!1)},this.methodsObject[DEFAULT_SMART_CONTRACT_METHOD_NAME]=function(t){return a.contractMethodFactory.createContractMethodObjectParam(i,DEFAULT_SMART_CONTRACT_METHOD_NAME,t,!1)}}}_initializeOnChainViews(r,i,a,t){const s=this.schema.val;t.forEach(e=>{this.contractViews[e.viewName]=function(t){return r.contractMethodFactory.createContractViewObjectParam(i,a,e,s,t)}})}storage(){return this.storageProvider.getStorage(this.address,this.schema)}bigMap(t){return this.storageProvider.getBigMapKey(this.address,t,this.schema)}}class BigMapAbstraction{constructor(t,e,r){this.id=t,this.schema=e,this.provider=r}get(t,e){return __awaiter(this,void 0,void 0,function*(){try{return yield this.provider.getBigMapKeyByID(this.id.toString(),t,this.schema,e)}catch(t){if(t instanceof HttpResponseError&&t.status===STATUS_CODE.NOT_FOUND)return;throw t}})}getMultipleValues(t,e,r=5){return __awaiter(this,void 0,void 0,function*(){return this.provider.getBigMapKeysByID(this.id.toString(),t,this.schema,e,r)})}toJSON(){return this.id.toString()}toString(){return this.id.toString()}}class SaplingStateAbstraction{constructor(t,e){this.id=t,this.provider=e}getSaplingDiff(t){return __awaiter(this,void 0,void 0,function*(){return this.provider.getSaplingDiffByID(this.id.toString(),t)})}getId(){return this.id.toString()}}const smartContractAbstractionSemantic=r=>({big_map:(t,e)=>{return t&&"int"in t&&void 0!==t.int?(e=new Schema(e),new BigMapAbstraction(new BigNumber(t.int),e,r)):{}},sapling_state:t=>t&&"int"in t&&void 0!==t.int?new SaplingStateAbstraction(new BigNumber(t.int),r):{}});class RpcContractProvider extends OperationEmitter{constructor(t,e){super(t),this.estimator=e,this.contractProviderTypeSymbol=Symbol.for("taquito--provider-type-symbol")}getStorage(r,i){return __awaiter(this,void 0,void 0,function*(){if(validateContractAddress(r)!==ValidationResult.VALID)throw new InvalidContractAddressError(r);var t=yield this.context.readProvider.getScript(r,"head");i=i||t;let e;return(e=Schema.isSchema(i)?i:Schema.fromRPCResponse({script:i})).Execute(t.storage,smartContractAbstractionSemantic(this))})}getBigMapKey(r,i,a){return __awaiter(this,void 0,void 0,function*(){if(validateContractAddress(r)!==ValidationResult.VALID)throw new InvalidContractAddressError(r);a=a||(yield this.rpc.getContract(r)).script;let t;var e=(t=Schema.isSchema(a)?a:Schema.fromRPCResponse({script:a})).EncodeBigMapKey(i),e=yield this.rpc.getBigMapKey(r,e);return t.ExecuteOnBigMapValue(e)})}getBigMapKeyByID(r,i,a,s){return __awaiter(this,void 0,void 0,function*(){var{key:t,type:e}=a.EncodeBigMapKey(i),t=(yield this.context.packer.packData({data:t,type:e}))["packed"],e=encodeExpr(t),t=s?yield this.context.readProvider.getBigMapValue({id:r.toString(),expr:e},s):yield this.context.readProvider.getBigMapValue({id:r.toString(),expr:e},"head");return a.ExecuteOnBigMapValue(t,smartContractAbstractionSemantic(this))})}getBigMapKeysByID(o,n,c,d,l=5){return __awaiter(this,void 0,void 0,function*(){const e=yield this.getBlockForRequest(n,d),r=new MichelsonMap;let t=0,i=[];for(;t<n.length;){const s=n.slice(t,t+l);var a=s.map(t=>this.getBigMapValueOrUndefined(t,o,c,e));i=[...i,...yield Promise.all(a)],t+=l}for(let t=0;t<i.length;t++)r.set(n[t],i[t]);return r})}getBlockForRequest(t,e){return __awaiter(this,void 0,void 0,function*(){return 1===t.length||void 0!==e?e:yield this.context.readProvider.getBlockLevel("head")})}getBigMapValueOrUndefined(t,e,r,i){return __awaiter(this,void 0,void 0,function*(){try{return yield this.getBigMapKeyByID(e,t,r,i)}catch(t){if(t instanceof HttpResponseError&&t.status===STATUS_CODE.NOT_FOUND)return;throw t}})}getSaplingDiffByID(t,e){return __awaiter(this,void 0,void 0,function*(){return e?yield this.context.readProvider.getSaplingDiffById({id:t.toString()},e):yield this.context.readProvider.getSaplingDiffById({id:t.toString()},"head")})}addRevealOperationIfNeeded(a,s){return __awaiter(this,void 0,void 0,function*(){if(isOpRequireReveal(a)){const r=[a];var t,e=yield this.signer.publicKey();const i=yield this.estimator.reveal();if(i)return t={kind:OpKind.REVEAL},t=yield this.estimate(t,()=>__awaiter(this,void 0,void 0,function*(){return i})),r.unshift(yield createRevealOperation(Object.assign({},t),s,e)),r}return a})}originate(s){return __awaiter(this,void 0,void 0,function*(){var t=yield this.estimate(s,this.estimator.originate.bind(this.estimator)),e=yield this.signer.publicKeyHash(),t=yield createOriginationOperation(yield this.context.parser.prepareCodeOrigination(Object.assign(Object.assign({},s),t))),r=yield this.addRevealOperationIfNeeded(t,e),r=yield this.prepareOperation({operation:r,source:e}),e=yield this.forge(r),{hash:r,context:e,forgedBytes:i,opResponse:a}=yield this.signAndInject(e);return new OriginationOperation(r,t,i,a,e,this)})}setDelegate(o){return __awaiter(this,void 0,void 0,function*(){if(o.source&&validateAddress(o.source)!==ValidationResult.VALID)throw new InvalidAddressError(o.source);if(o.delegate&&validateAddress(o.delegate)!==ValidationResult.VALID)throw new InvalidAddressError(o.delegate);if(/kt1/i.test(o.source))throw new InvalidDelegationSource(o.source);var t=yield this.estimate(o,this.estimator.setDelegate.bind(this.estimator)),e=yield this.signer.publicKeyHash(),t=yield createSetDelegateOperation(Object.assign(Object.assign({},o),t)),r=o.source||e,e=yield this.addRevealOperationIfNeeded(t,e),e=yield this.prepareOperation({operation:e,source:r}),e=yield this.forge(e),{hash:e,context:i,forgedBytes:a,opResponse:s}=yield this.signAndInject(e);return new DelegateOperation(e,t,r,a,s,i)})}registerDelegate(o){return __awaiter(this,void 0,void 0,function*(){var t=yield this.estimate(o,this.estimator.registerDelegate.bind(this.estimator)),e=yield this.signer.publicKeyHash(),t=yield createRegisterDelegateOperation(Object.assign(Object.assign({},o),t),e),r=yield this.addRevealOperationIfNeeded(t,e),r=yield this.prepareOperation({operation:r}),r=yield this.forge(r),{hash:r,context:i,forgedBytes:a,opResponse:s}=yield this.signAndInject(r);return new DelegateOperation(r,t,e,a,s,i)})}transfer(o){return __awaiter(this,void 0,void 0,function*(){if(validateAddress(o.to)!==ValidationResult.VALID)throw new InvalidAddressError(o.to);if(o.source&&validateAddress(o.source)!==ValidationResult.VALID)throw new InvalidAddressError(o.source);var t=yield this.signer.publicKeyHash(),e=yield this.estimate(o,this.estimator.transfer.bind(this.estimator)),e=yield createTransferOperation(Object.assign(Object.assign({},o),e)),r=o.source||t,t=yield this.addRevealOperationIfNeeded(e,t),t=yield this.prepareOperation({operation:t,source:o.source}),t=yield this.forge(t),{hash:t,context:i,forgedBytes:a,opResponse:s}=yield this.signAndInject(t);return new TransactionOperation(t,e,r,a,s,i)})}reveal(n){return __awaiter(this,void 0,void 0,function*(){var t,e,r,i,a,s=yield this.signer.publicKeyHash();const o=yield this.estimator.reveal(n);if(o)return t=yield this.estimate(n,()=>__awaiter(this,void 0,void 0,function*(){return o})),t=yield createRevealOperation(Object.assign({},t),s,yield this.signer.publicKey()),e=yield this.prepareOperation({operation:t,source:s}),e=yield this.forge(e),{hash:e,context:r,forgedBytes:i,opResponse:a}=yield this.signAndInject(e),new RevealOperation(e,t,s,i,a,r);throw new RevealOperationError(`The publicKeyHash '${s}' has already been revealed.`)})}registerGlobalConstant(o){return __awaiter(this,void 0,void 0,function*(){var t=yield this.signer.publicKeyHash(),e=yield this.estimate(o,this.estimator.registerGlobalConstant.bind(this.estimator)),e=yield createRegisterGlobalConstantOperation(Object.assign(Object.assign({},o),e)),r=yield this.addRevealOperationIfNeeded(e,t),r=yield this.prepareOperation({operation:r,source:t}),r=yield this.forge(r),{hash:r,context:i,forgedBytes:a,opResponse:s}=yield this.signAndInject(r);return new RegisterGlobalConstantOperation(r,e,t,a,s,i)})}at(a,s=t=>t){return __awaiter(this,void 0,void 0,function*(){if(validateContractAddress(a)!==ValidationResult.VALID)throw new InvalidContractAddressError(a);var t=this.context.withExtensions().rpc;const e=this.context.withExtensions().readProvider;var r=yield e.getScript(a,"head"),i=yield e.getEntrypoints(a),r=new ContractAbstraction(a,r,this,this,i,t,e);return s(r,this.context)})}batch(t){const e=new OperationBatch(this.context,this.estimator);return Array.isArray(t)&&e.with(t),e}}class MichelCodecParser{constructor(t){this.context=t}getNextProto(){return __awaiter(this,void 0,void 0,function*(){var t;return this.context.proto||(t=yield this.context.readProvider.getNextProtocol("head"),this.context.proto=t),this.context.proto})}parseScript(e){return __awaiter(this,void 0,void 0,function*(){const t=new Parser({protocol:yield this.getNextProto()});return t.parseScript(e)})}parseMichelineExpression(e){return __awaiter(this,void 0,void 0,function*(){const t=new Parser({protocol:yield this.getNextProto()});return t.parseMichelineExpression(e)})}parseJSON(e){return __awaiter(this,void 0,void 0,function*(){const t=new Parser({protocol:yield this.getNextProto()});return t.parseJSON(e)})}prepareCodeOrigination(o){return __awaiter(this,void 0,void 0,function*(){const t=o;if(t.code=yield this.formatCodeParam(o.code),o.init)t.init=yield this.formatInitParam(o.init);else if(o.storage){var e=t.code.find(t=>"prim"in t&&"storage"===t.prim);if(null==e||!e.args)throw new InvalidCodeParameter("The storage section is missing from the script",o.code);const i=new Schema(e.args[0]);var r=yield this.findGlobalConstantsHashAndValue(i);if(0!==Object.keys(r).length){const a=new Parser({expandGlobalConstant:r});r=a.parseJSON(e.args[0]);const s=new Schema(r);t.init=s.Encode(o.storage)}else t.init=i.Encode(o.storage);delete t.storage}return t})}formatCodeParam(a){return __awaiter(this,void 0,void 0,function*(){let t;if("string"==typeof a){var e=yield this.parseScript(a);if(null===e)throw new InvalidCodeParameter("Invalid code parameter",a);t=e}else{const r=yield this.parseJSON(a),i=["parameter","storage","code"];t=r.sort((t,e)=>i.indexOf(t.prim)-i.indexOf(e.prim))}return t})}formatInitParam(r){return __awaiter(this,void 0,void 0,function*(){let t;if("string"==typeof r){var e=yield this.parseMichelineExpression(r);if(null===e)throw new InvalidInitParameter("Invalid init parameter",r);t=e}else t=yield this.parseJSON(r);return t})}findGlobalConstantsHashAndValue(s){return __awaiter(this,void 0,void 0,function*(){var t=s.findToken("constant"),e={};if(0!==t.length)for(const a of t){var r,i=a.tokenVal.args;i&&(i=i[0].string,r=yield this.context.globalConstantsProvider.getGlobalConstantByHash(i),Object.assign(e,{[i]:r}))}return e})}}class RpcPacker{constructor(t){this.context=t}packData(t){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.packData(t)})}}class GlobalConstantNotFound extends Error{constructor(t){super(`Please load the value associated with the constant ${t} using the loadGlobalConstant method of the DefaultGlobalConstantsProvider.`),this.hash=t,this.name="GlobalConstantNotFound"}}class UnconfiguredGlobalConstantsProviderError extends Error{constructor(){super("No global constants provider has been configured. Please configure one by calling setGlobalConstantsProvider({globalConstantsProvider}) on your TezosToolkit instance."),this.name="UnconfiguredGlobalConstantsProviderError"}}class NoopGlobalConstantsProvider{getGlobalConstantByHash(t){return __awaiter(this,void 0,void 0,function*(){throw new UnconfiguredGlobalConstantsProviderError})}}class RpcReadAdapter{constructor(t){this.context=t}getBalance(t,e){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.getBalance(t,{block:String(e)})})}getDelegate(t,e){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.getDelegate(t,{block:String(e)})})}getNextProtocol(t){return __awaiter(this,void 0,void 0,function*(){return(yield this.context.rpc.getProtocols({block:String(t)})).next_protocol})}getProtocolConstants(o){return __awaiter(this,void 0,void 0,function*(){var{time_between_blocks:t,minimal_block_delay:e,hard_gas_limit_per_operation:r,hard_gas_limit_per_block:i,hard_storage_limit_per_operation:a,cost_per_byte:s}=yield this.context.rpc.getConstants({block:String(o)});return{time_between_blocks:t,minimal_block_delay:e,hard_gas_limit_per_operation:r,hard_gas_limit_per_block:i,hard_storage_limit_per_operation:a,cost_per_byte:s}})}getScript(e,r){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getContract(e,{block:String(r)}))["script"];return t})}getStorage(t,e){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.getStorage(t,{block:String(e)})})}getBlockHash(e){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getBlockHeader({block:String(e)}))["hash"];return t})}getBlockLevel(e){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getBlockHeader({block:String(e)}))["level"];return t})}getCounter(e,r){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getContract(e,{block:String(r)}))["counter"];return t||"0"})}getBlockTimestamp(e){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getBlockHeader({block:String(e)}))["timestamp"];return t})}getBigMapValue(t,e){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.getBigMapExpr(t.id,t.expr,{block:String(e)})})}getSaplingDiffById(t,e){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.getSaplingDiffById(t.id,{block:String(e)})})}getEntrypoints(t){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.getEntrypoints(t)})}getChainId(){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.getChainId()})}isAccountRevealed(e,r){return __awaiter(this,void 0,void 0,function*(){var t=yield this.context.rpc.getManagerKey(e,{block:String(r)});return t&&"object"==typeof t?!!t.key:!!t})}getBlock(t){return __awaiter(this,void 0,void 0,function*(){return this.context.rpc.getBlock({block:String(t)})})}getLiveBlocks(t){return this.context.rpc.getLiveBlocks({block:String(t)})}}const opHashFilter=(t,e)=>t.hash===e.opHash,sourceFilter=(t,e)=>{switch(t.kind){case"endorsement":return"metadata"in t&&t.metadata.delegate===e.source;case"activate_account":return"metadata"in t&&t.pkh===e.source;default:return"source"in t&&t.source===e.source}},kindFilter=(t,e)=>"kind"in t&&t.kind===e.kind,destinationFilter=(t,e)=>{switch(t.kind){case"delegation":return t.delegate===e.destination;case"origination":if("metadata"in t&&"operation_result"in t.metadata&&"originated_contracts"in t.metadata.operation_result&&Array.isArray(t.metadata.operation_result.originated_contracts))return t.metadata.operation_result.originated_contracts.some(t=>t===e.destination);break;case"transaction":return t.destination===e.destination;default:return!1}},evaluateOpFilter=(t,e)=>"opHash"in e?opHashFilter(t,e):"source"in e?sourceFilter(t,e):"kind"in e?kindFilter(t,e):"destination"in e&&destinationFilter(t,e),evaluateExpression=(e,t)=>{if(Array.isArray(t.and))return t.and.every(t=>evaluateFilter(e,t));if(Array.isArray(t.or))return t.or.some(t=>evaluateFilter(e,t));throw new InvalidFilterExpressionError("Filter expression must contain either and/or property")},evaluateFilter=(e,t)=>{const r=[];return Array.isArray(t)?r.push(...t):r.push(t),r.every(t=>("and"in t||"or"in t?evaluateExpression:evaluateOpFilter)(e,t))};class UnsupportedEventError extends Error{constructor(t){super(t),this.message=t,this.name="UnsupportedEventError"}}class ObservableSubscription{constructor(t,e=!1,r=retry()){this.shouldRetry=e,this.operatorFunction=r,this.errorListeners=[],this.messageListeners=[],this.closeListeners=[],this.completed$=new Subject,t.pipe(takeUntil(this.completed$),tap(t=>{this.call(this.messageListeners,t)},t=>{this.call(this.errorListeners,t)},()=>{this.call(this.closeListeners)}),this.shouldRetry?r:tap(),catchError(()=>NEVER)).subscribe()}call(t,e){for(const r of t)try{r(e)}catch(t){console.error(t)}}remove(t,e){e=t.indexOf(e);-1!==e&&t.splice(e,1)}on(t,e){switch(t){case"data":this.messageListeners.push(e);break;case"error":this.errorListeners.push(e);break;case"close":this.closeListeners.push(e);break;default:throw new UnsupportedEventError("Trying to register on an unsupported event: "+t)}}off(t,e){switch(t){case"data":this.remove(this.messageListeners,e);break;case"error":this.remove(this.errorListeners,e);break;case"close":this.remove(this.closeListeners,e);break;default:throw new UnsupportedEventError("Trying to unregister on an unsupported event: "+t)}}close(){this.completed$.next()}}const defaultConfigStreamer={shouldObservableSubscriptionRetry:!1,observableSubscriptionRetryFunction:retry()},getLastBlock=t=>from(t.rpc.getBlock()).pipe(first()),applyFilter=s=>concatMap(a=>new Observable(t=>{for(const e of a.operations)for(const r of e)for(const i of r.contents)evaluateFilter(Object.assign({hash:r.hash},i),s)&&t.next(Object.assign({hash:r.hash},i));t.complete()}));class PollingSubscribeProvider{constructor(t,e={}){this.context=t,this._config$=new BehaviorSubject(Object.assign(Object.assign({},defaultConfigStreamer),e)),this.timer$=this._config$.pipe(pluck("pollingIntervalMilliseconds"),switchMap(t=>t?timer(0,t):from(this.getConfirmationPollingInterval()).pipe(switchMap(t=>timer(0,t))))),this.newBlock$=this.timer$.pipe(switchMap(()=>getLastBlock(this.context)),distinctUntilKeyChanged("hash"),publish(),refCount())}get config(){return this._config$.getValue()}getConfirmationPollingInterval(){return __awaiter(this,void 0,void 0,function*(){if(!this.config.pollingIntervalMilliseconds)try{const t=yield this.context.readProvider.getProtocolConstants("head"),e=t.minimal_block_delay?t.minimal_block_delay.multipliedBy(1e3):t.time_between_blocks?t.time_between_blocks[0].multipliedBy(1e3):new BigNumber(5e3),r=e.dividedBy(3);this.config.pollingIntervalMilliseconds=0===r.toNumber()?1e3:r.toNumber()}catch(t){return 5e3}return this.config.pollingIntervalMilliseconds})}subscribeBlock(t){return new ObservableSubscription(this.newBlock$,this.config.shouldObservableSubscriptionRetry,this.config.observableSubscriptionRetryFunction)}subscribe(t){return new ObservableSubscription(this.newBlock$.pipe(pluck("hash")),this.config.shouldObservableSubscriptionRetry,this.config.observableSubscriptionRetryFunction)}subscribeOperation(t){return new ObservableSubscription(this.newBlock$.pipe(applyFilter(t)),this.config.shouldObservableSubscriptionRetry,this.config.observableSubscriptionRetryFunction)}}class TaquitoLocalForger{constructor(t){this.context=t}getNextProto(){return __awaiter(this,void 0,void 0,function*(){var t;return this.context.proto||(t=yield this.context.readProvider.getNextProtocol("head"),this.context.proto=t),this.context.proto})}forge({branch:e,contents:r}){return __awaiter(this,void 0,void 0,function*(){const t=new LocalForger(yield this.getNextProto());return t.forge({branch:e,contents:r})})}}const defaultConfigConfirmation={defaultConfirmationCount:1,confirmationPollingTimeoutSecond:180};class Context{constructor(t,e=new NoopSigner,r,i=new BehaviorSubject(Object.assign({},defaultConfigConfirmation)),a,s,o,n,c,d,l,h){this._rpc=t,this._signer=e,this._proto=r,this._config=i,this.providerDecorator=[],this.tz=new RpcTzProvider(this),this.estimate=new RPCEstimateProvider(this),this.contract=new RpcContractProvider(this,this.estimate),this.batch=new RPCBatchProvider(this,this.estimate),this.wallet=new Wallet(this),this.withExtensions=()=>{let e=this.clone();return this.providerDecorator.forEach(t=>{e=t(e)}),e},"string"==typeof this._rpc?this._rpcClient=new RpcClient(this._rpc):this._rpcClient=this._rpc,this._forger=a||new TaquitoLocalForger(this),this._injector=s||new RpcInjector(this),this.operationFactory=new OperationFactory(this),this._walletProvider=n||new LegacyWalletProvider(this),this._parser=c||new MichelCodecParser(this),this._packer=o||new RpcPacker(this),this._globalConstantsProvider=d||new NoopGlobalConstantsProvider,this._readProvider=l||new RpcReadAdapter(this),this._stream=h||new PollingSubscribeProvider(this)}get config(){return this._config.getValue()}set config(t){this._config.next(Object.assign({},t))}setPartialConfig(t){this._config.next(Object.assign(Object.assign({},this._config.getValue()),t))}get rpc(){return this._rpcClient}set rpc(t){this._rpcClient=t}get injector(){return this._injector}set injector(t){this._injector=t}get forger(){return this._forger}set forger(t){this._forger=t}get signer(){return this._signer}set signer(t){this._signer=t}get walletProvider(){return this._walletProvider}set walletProvider(t){this._walletProvider=t}set proto(t){this._proto=t}get proto(){return this._proto}get parser(){return this._parser}set parser(t){this._parser=t}get packer(){return this._packer}set packer(t){this._packer=t}get globalConstantsProvider(){return this._globalConstantsProvider}set globalConstantsProvider(t){this._globalConstantsProvider=t}get readProvider(){return this._readProvider}set readProvider(t){this._readProvider=t}get stream(){return this._stream}set stream(t){this._stream=t}isAnyProtocolActive(e=[]){return __awaiter(this,void 0,void 0,function*(){var t;return this._proto?e.includes(this._proto):(t=yield this.readProvider.getNextProtocol("head"),e.includes(t))})}isAnySignerConfigured(){return!(this.signer instanceof NoopSigner)}clone(){return new Context(this.rpc,this.signer,this.proto,this._config,this.forger,this._injector,this.packer,this._walletProvider,this._parser,this._globalConstantsProvider,this._readProvider,this._stream)}registerProviderDecorator(t){this.providerDecorator.push(t)}}const VERSION={commitHash:"cbdd0af87e400489076259d065e2d328feb8e1b4",version:"12.1.0"};class ForgingMismatchError extends Error{constructor(t){super("Forging mismatch error"),this.results=t,this.name="ForgingMismatchError"}}class UnspecifiedForgerError extends Error{constructor(){super("At least one forger must be specified"),this.name="UnspecifiedForgerError"}}class CompositeForger{constructor(t){if(0===(this.forgers=t).length)throw new UnspecifiedForgerError}forge({branch:i,contents:a}){return __awaiter(this,void 0,void 0,function*(){const t=yield Promise.all(this.forgers.map(t=>t.forge({branch:i,contents:a})));if(0===t.length)throw new UnspecifiedForgerError;let e=t.pop();for(;t.length;){var r=t.pop();if(r!==e)throw new ForgingMismatchError([e,r]);e=r}return e})}}class RpcForger{constructor(t){this.context=t}forge({branch:t,contents:e}){return this.context.rpc.forgeOperations({branch:t,contents:e})}}class NoopParser{prepareCodeOrigination(t){return __awaiter(this,void 0,void 0,function*(){return t})}}class MichelCodecPacker{packData(e){return __awaiter(this,void 0,void 0,function*(){var t=packDataBytes(e.data,e.type)["bytes"];return{packed:t}})}}class DefaultGlobalConstantsProvider{constructor(){this._globalConstantsLibrary={}}loadGlobalConstant(t){for(const e in t)Object.assign(this._globalConstantsLibrary,{[e]:t[e]})}getGlobalConstantByHash(e){return __awaiter(this,void 0,void 0,function*(){var t=this._globalConstantsLibrary[e];if(t)return t;throw new GlobalConstantNotFound(e)})}}class NaiveEstimateProvider{constructor(t){this.protocol=t,this._costPerByte=250}registerGlobalConstant(t){throw new InvalidOperationKindError(t.kind)}originate({fee:t=DEFAULT_FEE.ORIGINATION,storageLimit:e=DEFAULT_STORAGE_LIMIT.ORIGINATION,gasLimit:r=1e3*DEFAULT_GAS_LIMIT.ORIGINATION}){return __awaiter(this,void 0,void 0,function*(){return new Estimate(r,e,185,this._costPerByte,t)})}transfer({fee:t=DEFAULT_FEE.TRANSFER,storageLimit:e=DEFAULT_STORAGE_LIMIT.TRANSFER,gasLimit:r=1e3*DEFAULT_GAS_LIMIT.TRANSFER}){return __awaiter(this,void 0,void 0,function*(){return new Estimate(r,e,162,this._costPerByte,t)})}setDelegate({fee:t=DEFAULT_FEE.DELEGATION,gasLimit:e=1e3*DEFAULT_GAS_LIMIT.DELEGATION}){return __awaiter(this,void 0,void 0,function*(){return new Estimate(e,0,157,this._costPerByte,t)})}registerDelegate({fee:t=DEFAULT_FEE.DELEGATION,gasLimit:e=1e3*DEFAULT_GAS_LIMIT.DELEGATION}){return __awaiter(this,void 0,void 0,function*(){return new Estimate(e,0,157,this._costPerByte,t)})}reveal(){return __awaiter(this,void 0,void 0,function*(){return new Estimate(1e3*DEFAULT_GAS_LIMIT.REVEAL,DEFAULT_STORAGE_LIMIT.REVEAL,64,this._costPerByte,DEFAULT_FEE.REVEAL)})}batch(r){return __awaiter(this,void 0,void 0,function*(){const t=[];for(const e of r)switch(e.kind){case"transaction":t.push(yield this.transfer(e));break;case"origination":t.push(yield this.originate(e));break;case"delegation":t.push(yield this.setDelegate(e));break;case"activate_account":t.push(new Estimate(0,0,0,this._costPerByte,0));break;default:throw new InvalidOperationKindError(r.kind)}return t})}}class TezosToolkit{constructor(t){this._rpc=t,this._options={},this.format=format,"string"==typeof this._rpc?this._rpcClient=new RpcClient(this._rpc):this._rpcClient=this._rpc,this._context=new Context(t),this._wallet=new Wallet(this._context),this.setProvider({rpc:this._rpcClient}),this.batch=this._context.batch.batch.bind(this._context.batch)}setProvider({rpc:t,stream:e,signer:r,protocol:i,config:a,forger:s,wallet:o,packer:n,globalConstantsProvider:c,readProvider:d}){this.setRpcProvider(t),this.setStreamProvider(e),this.setSignerProvider(r),this.setForgerProvider(s),this.setWalletProvider(o),this.setPackerProvider(n),this.setGlobalConstantsProvider(c),this.setReadProvider(d),this._context.proto=i,a&&this._context.setPartialConfig(a)}setSignerProvider(t){this._options.signer||void 0!==t?void 0!==t&&(this._context.signer=t,this._options.signer=t):(this._context.signer=new NoopSigner,this._options.signer=t)}setRpcProvider(t){"string"==typeof t?this._rpcClient=new RpcClient(t):void 0!==t&&(this._rpcClient=t),this._options.rpc=this._rpcClient,this._context.rpc=this._rpcClient}setForgerProvider(t){void 0!==t?(this._options.forger=t,this._context.forger=t):void 0===this._options.forger&&(t=this.getFactory(TaquitoLocalForger)(),this._options.forger=t,this._context.forger=t)}setStreamProvider(t){var e;"string"==typeof t?(e=new PollingSubscribeProvider(new Context(new RpcClient(t))),this._options.stream=e,this._context.stream=e):void 0!==t?(this._options.stream=t,this._context.stream=t):void 0===this._options.stream&&(e=this.getFactory(PollingSubscribeProvider)(),this._options.stream=e,this._context.stream=e)}setWalletProvider(t){this._options.wallet||void 0!==t?void 0!==t&&(this._options.wallet=t,this._context.walletProvider=t):(t=this.getFactory(LegacyWalletProvider)(),this._options.wallet=t,this._context.walletProvider=t)}setPackerProvider(t){this._options.packer||void 0!==t?void 0!==t&&(this._context.packer=t,this._options.packer=t):(t=this.getFactory(RpcPacker)(),this._context.packer=t,this._options.packer=t)}setGlobalConstantsProvider(t){this._options.globalConstantsProvider||void 0!==t?void 0!==t&&(this._context.globalConstantsProvider=t,this._options.globalConstantsProvider=t):(t=new NoopGlobalConstantsProvider,this._context.globalConstantsProvider=t,this._options.globalConstantsProvider=t)}setReadProvider(t){t=void 0===t?this.getFactory(RpcReadAdapter)():t;this._options.readProvider=t,this._context.readProvider=t}get tz(){return this._context.tz}get contract(){return this._context.contract}get wallet(){return this._wallet}get operation(){return this._context.operationFactory}get estimate(){return this._context.estimate}get stream(){return this._context.stream}get rpc(){return this._context.rpc}get signer(){return this._context.signer}get globalConstants(){return this._context.globalConstantsProvider}addExtension(t){Array.isArray(t)?t.forEach(t=>t.configureContext(this._context)):t.configureContext(this._context)}getFactory(e){return(...t)=>new e(this._context,...t)}getVersionInfo(){return VERSION}}export{BatchOperation,BigMapAbstraction,ChainIds,CompositeForger,Context,ContractAbstraction,ContractMethod,ContractMethodObject,ContractView,DEFAULT_FEE,DEFAULT_GAS_LIMIT,DEFAULT_SMART_CONTRACT_METHOD_NAME,DEFAULT_STORAGE_LIMIT,DefaultGlobalConstantsProvider,DelegateOperation,DelegationWalletOperation,Estimate,GlobalConstantNotFound,InvalidCodeParameter,InvalidDelegationSource,InvalidInitParameter,InvalidParameterError,InvalidViewParameterError,InvalidViewSimulationContext,LegacyWalletProvider,MANAGER_LAMBDA,MichelCodecPacker,MichelCodecParser,MissedBlockDuringConfirmationError,NaiveEstimateProvider,NoopParser,ObservableSubscription,Operation,OperationBatch,OriginationOperation,OriginationParameterError,OriginationWalletOperation,PollingSubscribeProvider,Protocols,RPCEstimateProvider,RevealEstimateError,RevealOperationError,RpcForger,RpcPacker,RpcReadAdapter,TaquitoLocalForger,TezosOperationError,TezosPreapplyFailureError,TezosToolkit,TransactionOperation,TransactionWalletOperation,UnconfiguredGlobalConstantsProviderError,VIEW_LAMBDA,ViewSimulationError,Wallet,WalletOperation,WalletOperationBatch,compose,createOriginationOperation,createRegisterDelegateOperation,createRegisterGlobalConstantOperation,createRevealOperation,createSetDelegateOperation,createTransferOperation,defaultConfigConfirmation,protocols,validateAndExtractFailwith};