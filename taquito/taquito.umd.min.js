!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@taquito/rpc"),require("rxjs"),require("rxjs/operators"),require("@taquito/michelson-encoder"),require("bignumber.js"),require("@taquito/utils"),require("@taquito/http-utils"),require("@taquito/michel-codec"),require("@taquito/local-forging")):"function"==typeof define&&define.amd?define(["exports","@taquito/rpc","rxjs","rxjs/operators","@taquito/michelson-encoder","bignumber.js","@taquito/utils","@taquito/http-utils","@taquito/michel-codec","@taquito/local-forging"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).taquito={},t.rpc,t.rxjs,t.operators,t.michelsonEncoder,t.BigNumber,t.utils,t.httpUtils,t.michelCodec,t.localForging)}(this,function(p,g,u,n,m,t,v,s,a,F){"use strict";function M(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var h=M(t);function e(t,e){var i={};for(s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,s=Object.getOwnPropertySymbols(t);r<s.length;r++)e.indexOf(s[r])<0&&Object.prototype.propertyIsEnumerable.call(t,s[r])&&(i[s[r]]=t[s[r]]);return i}function f(t,n,a,c){return new(a=a||Promise)(function(i,e){function r(t){try{o(c.next(t))}catch(t){e(t)}}function s(t){try{o(c.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?i(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(r,s)}o((c=c.apply(t,n||[])).next())})}class V{constructor(t){this.context=t}inject(t){return this.context.rpc.injectOperation(t)}}class i extends Error{constructor(){super("No signer has been configured. Please configure one by calling setProvider({signer}) on your TezosToolkit instance."),this.name="UnconfiguredSignerError"}}class y{publicKey(){return f(this,void 0,void 0,function*(){throw new i})}publicKeyHash(){return f(this,void 0,void 0,function*(){throw new i})}secretKey(){return f(this,void 0,void 0,function*(){throw new i})}sign(t,e){return f(this,void 0,void 0,function*(){throw new i})}}function j(t){return new u.Observable(e=>(t.on("data",t=>{e.next(t)}),t.on("error",t=>{e.error(t)}),t.on("close",()=>{e.complete()}),()=>{t.close()}))}p.DEFAULT_GAS_LIMIT=void 0,(t=p.DEFAULT_GAS_LIMIT||(p.DEFAULT_GAS_LIMIT={}))[t.DELEGATION=10600]="DELEGATION",t[t.ORIGINATION=10600]="ORIGINATION",t[t.TRANSFER=10600]="TRANSFER",t[t.REVEAL=1100]="REVEAL",p.DEFAULT_FEE=void 0,(t=p.DEFAULT_FEE||(p.DEFAULT_FEE={}))[t.DELEGATION=1257]="DELEGATION",t[t.ORIGINATION=1e4]="ORIGINATION",t[t.TRANSFER=1e4]="TRANSFER",t[t.REVEAL=374]="REVEAL",p.DEFAULT_STORAGE_LIMIT=void 0,(t=p.DEFAULT_STORAGE_LIMIT||(p.DEFAULT_STORAGE_LIMIT={}))[t.DELEGATION=0]="DELEGATION",t[t.ORIGINATION=257]="ORIGINATION",t[t.TRANSFER=257]="TRANSFER",t[t.REVEAL=0]="REVEAL",p.Protocols=void 0,(t=p.Protocols||(p.Protocols={})).Pt24m4xi="Pt24m4xiPbLDhVgVfABUjirbmda3yohdN82Sp9FeuAXJ4eV9otd",t.PsBABY5H="PsBABY5HQTSkA4297zNHfsZNKtxULfL18y95qb3m53QJiXGmrbU",t.PsBabyM1="PsBabyM1eUXZseaJdmXFApDSBqj8YBfwELoxZHHW77EMcAbbwAS",t.PsCARTHA="PsCARTHAGazKbHtnKfLzQg3kms52kSRpgnDY982a9oYsSXRLQEb",t.PsDELPH1="PsDELPH1Kxsxt8f9eWbxQeRxkjfbxoqM52jvs5Y5fBxWWh4ifpo",t.PtEdo2Zk="PtEdo2ZkT9oKpimTah6x2embF25oss54njMuPzkJTEi5RqfdZFA",t.PsFLorena="PsFLorenaUUuikDWvMDr6fGBRG8kt3e3D3fHoXK1j1BFRxeSH4i",t.PtGRANADs="PtGRANADsDU8R9daYKAgWnQYAJ64omN1o3KMGVCykShA97vQbvV",t.PtHangz2="PtHangz2aRngywmSRGGvrcTyMbbdpWdpFKuS4uMWxg2RaH9i1qx",t.PsiThaCa="PsiThaCaT47Zboaw71QWScM8sXeMM7bbQFncK9FLqYc6EKdpjVP",t.Psithaca2="Psithaca2MLRFYargivpo7YvUr7wUDqyxrdhC5CQq78mRvimz6A",t.ProtoALpha="ProtoALphaALphaALphaALphaALphaALphaALphaALphaDdp3zK";t={"004":[p.Protocols.Pt24m4xi],"005":[p.Protocols.PsBABY5H,p.Protocols.PsBabyM1],"006":[p.Protocols.PsCARTHA],"007":[p.Protocols.PsDELPH1],"008":[p.Protocols.PtEdo2Zk],"009":[p.Protocols.PsFLorena],"010":[p.Protocols.PtGRANADs],"011":[p.Protocols.PtHangz2],"012":[p.Protocols.PsiThaCa],"013":[p.Protocols.Psithaca2],"014":[p.Protocols.ProtoALpha]};p.ChainIds=void 0,(x=p.ChainIds||(p.ChainIds={})).MAINNET="NetXdQprcVkpaWU",x.CARTHAGENET="NetXjD3HPJJjmcd",x.DELPHINET="NetXm8tYqnMWky1",x.EDONET="NetXSgo1ZT2DRUG",x.FLORENCENET="NetXxkAx4woPLyu",x.GRANADANET="NetXz969SFaFn8k",x.HANGZHOUNET="NetXZSsxBpMQeAT",x.ITHACANET="NetXbhmtAbMukLc",x.ITHACANET2="NetXnHfVqm9iesp";const B=6,G=3;function K(t){switch(t){case"tz":return B;case"mtz":return G;default:return 0}}function O(t="mutez",e="mutez",i){const r=new h.default(i);return r.isNaN()?i:r.multipliedBy(Math.pow(10,K(t))).dividedBy(Math.pow(10,K(e)))}class b extends Error{constructor(t,e,i){super(`${t} Received ${i.length} arguments while expecting one of the following signatures (${JSON.stringify(e)})`),this.smartContractMethodName=t,this.sigs=e,this.args=i,this.name="Invalid parameters error"}}class H extends Error{constructor(t){super(`Since Babylon delegation source can no longer be a contract address ${t}. Please use the smart contract abstraction to set your delegate.`),this.source=t,this.name="Invalid delegation source error"}}class _ extends Error{constructor(t,e){super(t),this.message=t,this.data=e,this.name="InvalidCodeParameter"}}class U extends Error{constructor(t,e){super(t),this.message=t,this.data=e,this.name="InvalidInitParameter"}}class z extends Error{constructor(t,e,i,r){super(`Unable to encode the parameter of the view: ${t}. Received ${i} as parameter while expecting one of the following signatures (${JSON.stringify(e)})`),this.smartContractViewName=t,this.sigs=e,this.args=i,this.originalError=r,this.name="Invalid view parameters error",this.cause=r}}class q extends Error{constructor(t,e,i,r){super(t),this.message=t,this.viewName=e,this.failWith=i,this.originalError=r,this.name="ViewSimulationError"}}const W=t=>{if((t=>{try{JSON.parse(t)}catch(t){return false}return true})(t.body)){t=JSON.parse(t.body);if(Array.isArray(t)&&"with"in t[t.length-1])return t[t.length-1].with}};class $ extends Error{constructor(t){super(t+" Please configure the context of the view execution in the executeView method."),this.info=t,this.name="InvalidViewSimulationContext"}}class J extends Error{constructor(t){super(t),this.message=t,this.name="RevealOperationError"}}class X extends Error{constructor(t){super(t),this.message=t,this.name="OriginationParameterError"}}const d=({code:s,init:o,balance:n="0",delegate:a,storage:c,fee:d=p.DEFAULT_FEE.ORIGINATION,gasLimit:h=p.DEFAULT_GAS_LIMIT.ORIGINATION,storageLimit:l=p.DEFAULT_STORAGE_LIMIT.ORIGINATION,mutez:u=!1})=>f(void 0,void 0,void 0,function*(){if(void 0!==c&&void 0!==o)throw new X("Storage and Init cannot be set a the same time. Please either use storage or init but not both.");if(!Array.isArray(s))throw new _("Wrong code parameter type, expected an array",s);let t;if(void 0!==c){var e=s.find(t=>"prim"in t&&"storage"===t.prim);if(void 0===(null==e?void 0:e.args))throw new _("The storage section is missing from the script",s);const r=new m.Schema(e.args[0]);t=r.Encode(c)}else{if(void 0===o||"object"!=typeof o)throw new U("Wrong init parameter type, expected JSON Michelson",o);t=o}e={code:s,storage:t};const i={kind:g.OpKind.ORIGINATION,fee:d,gas_limit:h,storage_limit:l,balance:(u?n:O("tz","mutez",n)).toString(),script:e};return a&&(i.delegate=a),i}),l=({to:t,amount:e,parameter:i,fee:r=p.DEFAULT_FEE.TRANSFER,gasLimit:s=p.DEFAULT_GAS_LIMIT.TRANSFER,storageLimit:o=p.DEFAULT_STORAGE_LIMIT.TRANSFER,mutez:n=!1})=>f(void 0,void 0,void 0,function*(){return{kind:g.OpKind.TRANSACTION,fee:r,gas_limit:s,storage_limit:o,amount:(n?e:O("tz","mutez",e)).toString(),destination:t,parameters:i}}),A=({delegate:t,source:e,fee:i=p.DEFAULT_FEE.DELEGATION,gasLimit:r=p.DEFAULT_GAS_LIMIT.DELEGATION,storageLimit:s=p.DEFAULT_STORAGE_LIMIT.DELEGATION})=>f(void 0,void 0,void 0,function*(){return{kind:g.OpKind.DELEGATION,source:e,fee:i,gas_limit:r,storage_limit:s,delegate:t}}),Y=({fee:t=p.DEFAULT_FEE.DELEGATION,gasLimit:e=p.DEFAULT_GAS_LIMIT.DELEGATION,storageLimit:i=p.DEFAULT_STORAGE_LIMIT.DELEGATION},r)=>f(void 0,void 0,void 0,function*(){return{kind:g.OpKind.DELEGATION,fee:t,gas_limit:e,storage_limit:i,delegate:r}}),w=({fee:t=p.DEFAULT_FEE.REVEAL,gasLimit:e=p.DEFAULT_GAS_LIMIT.REVEAL,storageLimit:i=p.DEFAULT_STORAGE_LIMIT.REVEAL},r,s)=>f(void 0,void 0,void 0,function*(){return{kind:g.OpKind.REVEAL,fee:t,public_key:s,source:r,gas_limit:e,storage_limit:i}}),E=({value:t,source:e,fee:i,gasLimit:r,storageLimit:s})=>f(void 0,void 0,void 0,function*(){return{kind:g.OpKind.REGISTER_GLOBAL_CONSTANT,value:t,fee:i,gas_limit:r,storage_limit:s,source:e}}),Q=(t,e)=>Object.assign(Object.assign({},t),{kind:e}),Z=(t,e)=>{if(Array.isArray(t)){t=t.find(t=>t.kind===e);if(t&&t.kind===e)return t}},tt=t=>-1!==["transaction","delegation","origination","reveal","register_global_constant"].indexOf(t.kind),et=t=>-1!==["transaction","delegation","origination","register_global_constant"].indexOf(t.kind),it=t=>"metadata"in t,c=t=>it(t)&&"operation_result"in t.metadata;class rt extends Error{constructor(t,e){super(),this.errors=t,this.errorDetails=e,this.name="TezosOperationError";e=t[t.length-1];this.id=e.id,this.kind=e.kind,this.message=`(${this.kind}) `+this.id,"with"in e&&(e.with.string?this.message=e.with.string:e.with.int?this.message=e.with.int:this.message=JSON.stringify(e.with))}}class st extends Error{constructor(t){super("Preapply returned an unexpected result"),this.result=t,this.name="TezosPreapplyFailureError"}}const P=t=>{var i=Array.isArray(t)?t:[t];const r=[];for(let e=0;e<i.length;e++)for(let t=0;t<i[e].contents.length;t++){const s=i[e].contents[t];c(s)&&(r.push(Object.assign({fee:s.fee},s.metadata.operation_result)),Array.isArray(s.metadata.internal_operation_results)&&s.metadata.internal_operation_results.forEach(t=>r.push(t.result)))}return r},I=(t,i="failed")=>{var r,s=Array.isArray(t)?t:[t];let o=[];for(let e=0;e<s.length;e++)for(let t=0;t<s[e].contents.length;t++){var n=s[e].contents[t];if(it(n)&&(c(n)&&n.metadata.operation_result.status===i&&(o=o.concat(n.metadata.operation_result.errors||[])),r=n,it(r)&&"internal_operation_results"in r.metadata&&Array.isArray(n.metadata.internal_operation_results)))for(const a of n.metadata.internal_operation_results)"result"in a&&a.result.status===i&&(o=o.concat(a.result.errors||[]))}return o};class ot extends Error{constructor(t){super(t),this.message=t,this.name="OriginationOperationError"}}class nt extends Error{constructor(t){super(t),this.message=t,this.name="InvalidConfirmationCountError"}}class at extends Error{constructor(t){super(t),this.message=t,this.name="ConfirmationUndefinedError"}}class ct extends Error{constructor(t){super(t),this.message=t,this.name="InvalidFilterExpressionError"}}class o{constructor(t,e,i,r){if(this.hash=t,this.raw=e,this.results=i,this.context=r,this._pollingConfig$=new u.ReplaySubject(1),this.currentHead$=this._pollingConfig$.pipe(n.switchMap(t=>u.defer(()=>j(this.context.stream.subscribeBlock("head"))).pipe(n.timeoutWith(1e3*t.timeout,u.throwError(new Error("Confirmation polling timed out"))))),n.shareReplay({refCount:!0})),this.confirmed$=this.currentHead$.pipe(n.map(e=>{for(let t=3;0<=t;t--)e.operations[t].forEach(t=>{t.hash===this.hash&&(this._foundAt=e.header.level)});if(0<=e.header.level-this._foundAt)return this._foundAt}),n.filter(t=>void 0!==t),n.first(),n.shareReplay()),this._foundAt=Number.POSITIVE_INFINITY,v.validateOperation(this.hash)!==v.ValidationResult.VALID)throw new v.InvalidOperationHashError(this.hash);this.confirmed$.pipe(n.first(),n.catchError(()=>u.of(u.EMPTY))).subscribe()}get includedInBlock(){return this._foundAt}get revealOperation(){return Array.isArray(this.results)&&this.results.find(t=>"reveal"===t.kind)}get revealStatus(){return this.revealOperation?this.revealOperation.metadata.operation_result.status:"unknown"}get status(){return this.results.map(t=>c(t)?t.metadata.operation_result.status:"unknown")[0]||"unknown"}confirmation(r,s){return f(this,void 0,void 0,function*(){if(void 0!==r&&r<1)throw new nt("Confirmation count must be at least 1");var{defaultConfirmationCount:t,confirmationPollingTimeoutSecond:e}=this.context.config;this._pollingConfig$.next({timeout:s||e});const i=void 0!==r?r:t;return new Promise((e,t)=>{this.confirmed$.pipe(n.switchMap(()=>this.currentHead$),n.filter(t=>t.header.level-this._foundAt>=i-1),n.first()).subscribe(t=>{e(this._foundAt+(i-1))},t)})})}}class dt extends o{constructor(t,e,i,r,s,o){super(t,r,s,o),this.params=e,this.source=i}sumProp(t,i){return t.reduce((t,e)=>i in e?Number(e[i])+t:t,0)}get status(){return this.results.filter(t=>-1!==ht.indexOf(t.kind)).map(t=>c(t)?t.metadata.operation_result.status:"unknown")[0]||"unknown"}get fee(){return this.sumProp(this.params,"fee")}get gasLimit(){return this.sumProp(this.params,"gas_limit")}get storageLimit(){return this.sumProp(this.params,"storage_limit")}get consumedGas(){return String(this.sumProp(P({contents:this.results}),"consumed_gas"))}get storageDiff(){return String(this.sumProp(P({contents:this.results}),"paid_storage_size_diff"))}get errors(){return I({contents:this.results})}}class r{constructor(t){this.context=t}get rpc(){return this.context.rpc}get signer(){return this.context.signer}isRevealOpNeeded(t,e){return f(this,void 0,void 0,function*(){return!(!(yield this.isAccountRevealRequired(e))||!this.isRevealRequiredForOpType(t))})}isAccountRevealRequired(t){return f(this,void 0,void 0,function*(){return!(yield this.context.readProvider.isAccountRevealed(t,"head"))})}isRevealRequiredForOpType(t){let e=!1;for(const i of t)et(i)&&(e=!0);return e}prepareOperation({operation:h,source:l},u){return f(this,void 0,void 0,function*(){const e={};let i=[];var t=this.context.readProvider.getBlockHash("head~2"),r=this.context.readProvider.getNextProtocol("head");i=Array.isArray(h)?[...h]:[h];const s=u||(yield this.signer.publicKeyHash());let o=Promise.resolve(void 0);for(let t=0;t<i.length;t++)if(et(i[t])||"reveal"===i[t].kind){o=this.context.readProvider.getCounter(s,"head");break}var[t,r,n]=yield Promise.all([t,r,o]),n=parseInt(n||"0",10);(!e[s]||e[s]<n)&&(e[s]=n);const a=t=>{return{counter:""+ ++e[s],fee:void 0===t.fee?"0":""+t.fee,gas_limit:void 0===t.gas_limit?"0":""+t.gas_limit,storage_limit:void 0===t.storage_limit?"0":""+t.storage_limit}},c=t=>({source:void 0===t.source?l||s:t.source});var d=i.map(t=>{switch(t.kind){case g.OpKind.ACTIVATION:return Object.assign({},t);case g.OpKind.REVEAL:return Object.assign(Object.assign(Object.assign({},t),c(t)),a(t));case g.OpKind.ORIGINATION:return Object.assign(Object.assign(Object.assign(Object.assign({},t),{balance:void 0!==t.balance?""+t.balance:"0"}),c(t)),a(t));case g.OpKind.TRANSACTION:{const e=Object.assign(Object.assign(Object.assign(Object.assign({},t),{amount:void 0!==t.amount?""+t.amount:"0"}),c(t)),a(t));if(e.source.toLowerCase().startsWith("kt1"))throw new v.DeprecationError("KT1 addresses are not supported as source since "+p.Protocols.PsBabyM1);return e}case g.OpKind.DELEGATION:case g.OpKind.REGISTER_GLOBAL_CONSTANT:return Object.assign(Object.assign(Object.assign({},t),c(t)),a(t));default:throw new v.InvalidOperationKindError(t.kind)}});return{opOb:{branch:t,contents:d,protocol:r},counter:n}})}forge({opOb:{branch:t,contents:e,protocol:i},counter:r}){return f(this,void 0,void 0,function*(){return{opbytes:yield this.context.forger.forge({branch:t,contents:e}),opOb:{branch:t,contents:e,protocol:i},counter:r}})}simulate(t){return f(this,void 0,void 0,function*(){return{opResponse:yield this.rpc.runOperation(t),op:t,context:this.context.clone()}})}estimate(t,s){var{fee:o,gasLimit:n,storageLimit:a}=t,c=e(t,["fee","gasLimit","storageLimit"]);return f(this,void 0,void 0,function*(){let t=o,e=n,i=a;var r;return void 0!==o&&void 0!==n&&void 0!==a||(r=yield s(Object.assign({fee:o,gasLimit:n,storageLimit:a},c)),void 0===t&&(t=r.suggestedFeeMutez),void 0===e&&(e=r.gasLimit),void 0===i&&(i=r.storageLimit)),{fee:t,gasLimit:e,storageLimit:i}})}signAndInject(e){return f(this,void 0,void 0,function*(){var t=yield this.signer.sign(e.opbytes,new Uint8Array([3]));e.opbytes=t.sbytes,e.opOb.signature=t.prefixSig;const i=[];var r=yield this.rpc.preapplyOperations([e.opOb]);if(!Array.isArray(r))throw new st(r);for(let e=0;e<r.length;e++)for(let t=0;t<r[e].contents.length;t++)i.push(r[e].contents[t]);t=I(r);if(t.length)throw new rt(t,"Error occurred during validation simulation of operation");return{hash:yield this.context.injector.inject(e.opbytes),forgedBytes:e,opResponse:i,context:this.context.clone()}})}}const ht=[g.OpKind.ACTIVATION,g.OpKind.ORIGINATION,g.OpKind.TRANSACTION,g.OpKind.DELEGATION];class lt extends r{constructor(t,e){super(t),this.estimator=e,this.operations=[]}withTransfer(t){if(v.validateAddress(t.to)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(t.to);return this.operations.push(Object.assign({kind:g.OpKind.TRANSACTION},t)),this}withContractCall(t){return this.withTransfer(t.toTransferParams())}withDelegation(t){if(t.source&&v.validateAddress(t.source)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(t.source);if(t.delegate&&v.validateAddress(t.delegate)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(t.delegate);return this.operations.push(Object.assign({kind:g.OpKind.DELEGATION},t)),this}withActivation({pkh:t,secret:e}){if(v.validateKeyHash(t)!==v.ValidationResult.VALID)throw new v.InvalidKeyHashError(t);return this.operations.push({kind:g.OpKind.ACTIVATION,pkh:t,secret:e}),this}withOrigination(t){return this.operations.push(Object.assign({kind:g.OpKind.ORIGINATION},t)),this}withRegisterGlobalConstant(t){return this.operations.push(Object.assign({kind:g.OpKind.REGISTER_GLOBAL_CONSTANT},t)),this}getRPCOp(t){return f(this,void 0,void 0,function*(){switch(t.kind){case g.OpKind.TRANSACTION:return l(Object.assign({},t));case g.OpKind.ORIGINATION:return d(yield this.context.parser.prepareCodeOrigination(Object.assign({},t)));case g.OpKind.DELEGATION:return A(Object.assign({},t));case g.OpKind.ACTIVATION:return Object.assign({},t);case g.OpKind.REGISTER_GLOBAL_CONSTANT:return E(Object.assign({},t));default:throw new v.InvalidOperationKindError(t.kind)}})}with(t){for(const e of t)switch(e.kind){case g.OpKind.TRANSACTION:this.withTransfer(e);break;case g.OpKind.ORIGINATION:this.withOrigination(e);break;case g.OpKind.DELEGATION:this.withDelegation(e);break;case g.OpKind.ACTIVATION:this.withActivation(e);break;case g.OpKind.REGISTER_GLOBAL_CONSTANT:this.withRegisterGlobalConstant(e);break;default:throw new v.InvalidOperationKindError(e.kind)}return this}send(h){return f(this,void 0,void 0,function*(){var t=yield this.signer.publicKeyHash(),e=yield this.signer.publicKey();const i=yield this.estimator.batch(this.operations);var r,s=yield this.isRevealOpNeeded(this.operations,t);let o=s?1:0;const n=[];for(const d of this.operations)tt(d)?(r=yield this.estimate(d,()=>f(this,void 0,void 0,function*(){return i[o]})),n.push(yield this.getRPCOp(Object.assign(Object.assign({},d),r)))):n.push(Object.assign({},d)),o++;s&&(s={kind:g.OpKind.REVEAL},s=yield this.estimate(s,()=>f(this,void 0,void 0,function*(){return i[0]})),n.unshift(yield w(Object.assign({},s),t,e)));var s=h&&h.source||t,e=yield this.prepareOperation({operation:n,source:s}),t=yield this.forge(e),{hash:e,context:t,forgedBytes:a,opResponse:c}=yield this.signAndInject(t);return new dt(e,n,s,a,c,t)})}}class ut{constructor(t,e){this.context=t,this.estimator=e}batch(t){const e=new lt(this.context,this.estimator);return Array.isArray(t)&&e.with(t),e}}class pt extends Error{constructor(){super("Taquito missed a block while waiting for operation confirmation and was not able to find the operation"),this.name="MissedBlockDuringConfirmationError"}}class L{constructor(t,e,i){if(this.opHash=t,this.context=e,this._newHead$=i,this._operationResult=new u.ReplaySubject(1),this._includedInBlock=new u.ReplaySubject(1),this._included=!1,this.newHead$=this._newHead$.pipe(n.tap(t=>{if(!this._included&&this.lastHead&&1<t.header.level-this.lastHead.header.level)throw new pt;this.lastHead=t}),n.shareReplay({bufferSize:1,refCount:!0})),this.confirmed$=this.newHead$.pipe(n.map(t=>{for(const e of t.operations)for(const i of e)if(i.hash===this.opHash)return this._included=!0,this._includedInBlock.next(t),this._operationResult.next(i.contents),t}),n.filter(t=>void 0!==t),n.first(),n.shareReplay({bufferSize:1,refCount:!0})),v.validateOperation(this.opHash)!==v.ValidationResult.VALID)throw new v.InvalidOperationHashError(this.opHash);this.confirmed$.pipe(n.first(),n.catchError(()=>u.of(void 0))).subscribe()}operationResults(){return f(this,void 0,void 0,function*(){return this._operationResult.pipe(n.first()).toPromise()})}receipt(){return f(this,void 0,void 0,function*(){{var[n,{ALLOCATION_BURN:a,ORIGINATION_BURN:c}={ALLOCATION_BURN:257,ORIGINATION_BURN:257}]=[yield this.operationResults()];const d=P({contents:n});let e=new h.default(0),t=new h.default(0),i=new h.default(0),r=new h.default(0),s=new h.default(0),o=new h.default(0);return d.forEach(t=>{i=i.plus(t.fee||0),r=r.plus(Array.isArray(t.originated_contracts)?t.originated_contracts.length*c:0),s=s.plus("allocated_destination_contract"in t?a:0),e=e.plus(t.consumed_gas||0),o=o.plus("paid_storage_size_diff"in t&&Number(t.paid_storage_size_diff)||0)}),t=t.plus(s).plus(r).plus(o),{totalFee:i,totalGas:e,totalStorage:t,totalAllocationBurn:s,totalOriginationBurn:r,totalPaidStorageDiff:o,totalStorageBurn:new h.default(t.multipliedBy(1e3))}}})}getCurrentConfirmation(){return f(this,void 0,void 0,function*(){return this._included?u.combineLatest([this._includedInBlock,u.from(this.context.readProvider.getBlock("head"))]).pipe(n.map(([t,e])=>e.header.level-t.header.level+1),n.first()).toPromise():0})}isInCurrentBranch(r="head"){return f(this,void 0,void 0,function*(){if(!this._included)return!0;var t=yield this.context.readProvider.getBlockLevel(r),e=yield this._includedInBlock.pipe(n.first()).toPromise(),t=t-e.header.level;if(t<=0)return!0;t=Math.min(e.header.level+t,e.header.level+60);const i=new Set(yield this.context.readProvider.getLiveBlocks(t));return i.has(e.hash)})}confirmationObservable(t){if(void 0!==t&&t<1)throw new nt("Confirmation count must be at least 1");var e=this.context.config["defaultConfirmationCount"];const i=void 0!==t?t:e;if(void 0===i)throw new at("Default confirmation count can not be undefined!");return u.combineLatest([this._includedInBlock,this.newHead$]).pipe(n.distinctUntilChanged(([,t],[,e])=>t.hash===e.hash),n.map(([t,e])=>({block:e,expectedConfirmation:i,currentConfirmation:e.header.level-t.header.level+1,completed:e.header.level-t.header.level>=i-1,isInCurrentBranch:()=>this.isInCurrentBranch(e.hash)})),n.takeWhile(({completed:t})=>!t,!0))}confirmation(t){return this.confirmationObservable(t).toPromise()}}class gt extends L{constructor(t,e,i){super(t,e,i),this.opHash=t,this.context=e}revealOperation(){return f(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===g.OpKind.REVEAL)})}status(){return f(this,void 0,void 0,function*(){if(!this._included)return"pending";const t=yield this.operationResults();return t.filter(t=>-1!==ht.indexOf(t.kind)).map(t=>c(t)?t.metadata.operation_result.status:"unknown")[0]||"unknown"})}}class mt extends L{constructor(t,e,i){super(t,e,i),this.opHash=t,this.context=e}revealOperation(){return f(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===g.OpKind.REVEAL)})}delegationOperation(){return f(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===g.OpKind.DELEGATION)})}status(){return f(this,void 0,void 0,function*(){if(!this._included)return"pending";var t=yield this.delegationOperation();return t?t.metadata.operation_result.status:"unknown"})}}class vt extends L{constructor(t,e,i){super(t,e,i),this.opHash=t,this.context=e}originationOperation(){return f(this,void 0,void 0,function*(){var t=yield this.operationResults();return Z(t,g.OpKind.ORIGINATION)})}revealOperation(){return f(this,void 0,void 0,function*(){var t=yield this.operationResults();return Z(t,g.OpKind.REVEAL)})}status(){return f(this,void 0,void 0,function*(){if(!this._included)return"pending";var t=yield this.originationOperation();return t?t.metadata.operation_result.status:"unknown"})}contract(){return f(this,void 0,void 0,function*(){var t=yield this.originationOperation(),t=((null==t?void 0:t.metadata.operation_result.originated_contracts)||[])[0];return this.context.wallet.at(t)})}}class ft extends L{constructor(t,e,i){super(t,e,i),this.opHash=t,this.context=e}revealOperation(){return f(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===g.OpKind.REVEAL)})}transactionOperation(){return f(this,void 0,void 0,function*(){const t=yield this.operationResults();return t.find(t=>t.kind===g.OpKind.TRANSACTION)})}status(){return f(this,void 0,void 0,function*(){if(!this._included)return"pending";var t=yield this.transactionOperation();return t?t.metadata.operation_result.status:"unknown"})}}class yt{constructor(t){this.context=t,this.sharedHeadObs=u.defer(()=>j(this.context.stream.subscribeBlock("head")))}createNewHeadObservable(){return f(this,void 0,void 0,function*(){return t=this.sharedHeadObs,e=this.context,t.pipe(n.timeoutWith(1e3*e.config.confirmationPollingTimeoutSecond,u.throwError(new Error("Confirmation polling timed out")),i),n.shareReplay({refCount:!0,scheduler:i}));var t,e,i})}createPastBlockWalker(t,e=1){return u.from(this.context.readProvider.getBlock(t)).pipe(n.switchMap(t=>1===e?u.of(t):u.range(t.header.level,e-1).pipe(n.startWith(t),n.concatMap(t=>f(this,void 0,void 0,function*(){return this.context.readProvider.getBlock("number"==typeof t?t:t.header.level)})))))}createHeadObservableFromConfig({blockIdentifier:e}){return f(this,void 0,void 0,function*(){const t=[];return e&&t.push(this.createPastBlockWalker(e)),t.push(yield this.createNewHeadObservable()),u.concat(...t)})}createOperation(t,e={}){return f(this,void 0,void 0,function*(){return new L(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}createBatchOperation(t,e={}){return f(this,void 0,void 0,function*(){return new gt(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}createTransactionOperation(t,e={}){return f(this,void 0,void 0,function*(){return new ft(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}createDelegationOperation(t,e={}){return f(this,void 0,void 0,function*(){return new mt(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}createOriginationOperation(t,e={}){return f(this,void 0,void 0,function*(){return new vt(t,this.context.clone(),yield this.createHeadObservableFromConfig(e))})}}class Ot extends r{constructor(t){super(t)}getBalance(t){return f(this,void 0,void 0,function*(){if(v.validateAddress(t)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(t);return this.context.readProvider.getBalance(t,"head")})}getDelegate(t){return f(this,void 0,void 0,function*(){if(v.validateAddress(t)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(t);return this.context.readProvider.getDelegate(t,"head")})}activate(i,r){return f(this,void 0,void 0,function*(){if(v.validateKeyHash(i)!==v.ValidationResult.VALID)throw new v.InvalidKeyHashError(i);var t={kind:g.OpKind.ACTIVATION,pkh:i,secret:r},t=yield this.prepareOperation({operation:[t],source:i}),t=yield this.forge(t),e=t.opbytes+"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";return new o(yield this.rpc.injectOperation(e),Object.assign(Object.assign({},t),{opbytes:e}),[],this.context.clone())})}}class R{constructor(t,e,i,r,s=100){this._milligasLimit=t,this._storageLimit=e,this.opSize=i,this.minimalFeePerStorageByteMutez=r,this.baseFeeMutez=s}get burnFeeMutez(){return this.roundUp(Number(this.storageLimit)*Number(this.minimalFeePerStorageByteMutez))}get storageLimit(){var t=Math.max(Number(this._storageLimit),0);return 0<t?t:0}get gasLimit(){return this.roundUp(Number(this._milligasLimit)/1e3+100)}get operationFeeMutez(){return.1*(Number(this._milligasLimit)/1e3+100)+ +Number(this.opSize)}roundUp(t){return Math.ceil(Number(t))}get minimalFeeMutez(){return this.roundUp(100+this.operationFeeMutez)}get suggestedFeeMutez(){return this.roundUp(this.operationFeeMutez+200)}get usingBaseFeeMutez(){return Math.max(Number(this.baseFeeMutez),100)+this.roundUp(this.operationFeeMutez)}get totalCost(){return this.minimalFeeMutez+this.burnFeeMutez}get consumedMilligas(){return Number(this._milligasLimit)}static createEstimateInstanceFromProperties(t){let e=0,i=0,r=0,s=0,o;return t.forEach(t=>{e+=t.milligasLimit,i+=t.storageLimit,r+=t.opSize,s=Math.max(t.minimalFeePerStorageByteMutez,s),t.baseFeeMutez&&(o=o?o+t.baseFeeMutez:t.baseFeeMutez)}),new R(e,i,r,s,o)}static createArrayEstimateInstancesFromProperties(t){return t.map(t=>new R(t.milligasLimit,t.storageLimit,t.opSize,t.minimalFeePerStorageByteMutez,t.baseFeeMutez))}}class bt extends Error{constructor(){super("Unable to estimate the reveal operation, the public key is unknown"),this.name="Reveal Estimate Error"}}const T=(t,e)=>({fee:(void 0===t.fee?e:t).fee,gasLimit:(void 0===t.gasLimit?e:t).gasLimit,storageLimit:(void 0===t.storageLimit?e:t).storageLimit});class _t extends r{constructor(){super(...arguments),this.ALLOCATION_STORAGE=257,this.ORIGINATION_STORAGE=257,this.OP_SIZE_REVEAL=128}getKeys(){return f(this,void 0,void 0,function*(){var t=this.context.isAnySignerConfigured();return{publicKeyHash:t?yield this.signer.publicKeyHash():yield this.context.walletProvider.getPKH(),publicKey:t?yield this.signer.publicKey():void 0}})}getAccountLimits(o,n,a){return f(this,void 0,void 0,function*(){const t=yield this.context.readProvider.getBalance(o,"head"),{hard_gas_limit_per_operation:e,hard_gas_limit_per_block:i,hard_storage_limit_per_operation:r,cost_per_byte:s}=n;return{fee:0,gasLimit:a?Math.floor(this.ajustGasForBatchOperation(i,e,a).toNumber()):e.toNumber(),storageLimit:Math.floor(h.default.min(t.dividedBy(s),r).toNumber())}})}ajustGasForBatchOperation(t,e,i){return h.default.min(e,t.div(i+1))}getEstimationPropertiesFromOperationContent(t,e,i){const r=P({contents:[t]});let s=0,o=0,n=0;return r.forEach(t=>{n=(n+="originated_contracts"in t&&void 0!==t.originated_contracts?t.originated_contracts.length*this.ORIGINATION_STORAGE:0)+("allocated_destination_contract"in t?this.ALLOCATION_STORAGE:0),s+=Number(t.consumed_gas)||0,o+=Number(t.consumed_milligas)||0,n=(n+="paid_storage_size_diff"in t&&Number(t.paid_storage_size_diff)||0)+("storage_size"in t&&"global_address"in t&&Number(t.storage_size)||0)}),0!==s&&0===o&&(o=1e3*s),tt(t)?{milligasLimit:o||0,storageLimit:Number(n||0),opSize:e,minimalFeePerStorageByteMutez:i.toNumber()}:{milligasLimit:0,storageLimit:0,opSize:e,minimalFeePerStorageByteMutez:i.toNumber(),baseFeeMutez:0}}prepareEstimate(a,c,d){return f(this,void 0,void 0,function*(){var t=yield this.prepareOperation(a,d);const{opbytes:e,opOb:{branch:i,contents:r}}=yield this.forge(t);t={operation:{branch:i,contents:r,signature:"edsigtkpiSSschcaCt9pUVrpNPf7TTcgvgDEDD6NCEHMy8NNQJCGnMfLZzYoQj74yLjo9wx6MPVV29CvVzgi7qEcEUok3k7AuMg"},chain_id:yield this.context.readProvider.getChainId()};const s=(yield this.simulate(t))["opResponse"],o=c["cost_per_byte"];t=[...I(s,"backtracked"),...I(s)];if(t.length)throw new rt(t,"Error occurred during estimation");let n=1;return Array.isArray(a.operation)&&1<a.operation.length&&(n="reveal"===s.contents[0].kind?a.operation.length-1:a.operation.length),s.contents.map(t=>this.getEstimationPropertiesFromOperationContent(t,"reveal"===t.kind?this.OP_SIZE_REVEAL/2:e.length/2/n,o))})}originate(t){var{fee:o,storageLimit:n,gasLimit:a}=t,c=e(t,["fee","storageLimit","gasLimit"]);return f(this,void 0,void 0,function*(){var t=(yield this.getKeys())["publicKeyHash"],e=yield this.context.readProvider.getProtocolConstants("head"),i=yield this.getAccountLimits(t,e),i=yield d(yield this.context.parser.prepareCodeOrigination(Object.assign(Object.assign({},c),T({fee:o,storageLimit:n,gasLimit:a},i)))),r=yield this.isRevealOpNeeded([i],t),i=r?yield this.addRevealOp([i],t):i;const s=yield this.prepareEstimate({operation:i,source:t},e,t);return r&&s.shift(),R.createEstimateInstanceFromProperties(s)})}transfer(t){var{fee:o,storageLimit:n,gasLimit:a}=t,c=e(t,["fee","storageLimit","gasLimit"]);return f(this,void 0,void 0,function*(){if(v.validateAddress(c.to)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(c.to);if(c.source&&v.validateAddress(c.source)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(c.source);var t=(yield this.getKeys()).publicKeyHash,e=yield this.context.readProvider.getProtocolConstants("head"),i=yield this.getAccountLimits(t,e),i=yield l(Object.assign(Object.assign({},c),T({fee:o,storageLimit:n,gasLimit:a},i))),r=yield this.isRevealOpNeeded([i],t),i=r?yield this.addRevealOp([i],t):i;const s=yield this.prepareEstimate({operation:i,source:t},e,t);return r&&s.shift(),R.createEstimateInstanceFromProperties(s)})}setDelegate(t){var{fee:o,gasLimit:n,storageLimit:a}=t,c=e(t,["fee","gasLimit","storageLimit"]);return f(this,void 0,void 0,function*(){if(c.source&&v.validateAddress(c.source)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(c.source);if(c.delegate&&v.validateAddress(c.delegate)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(c.delegate);var t=(yield this.getKeys()).publicKeyHash,e=c.source||t,i=yield this.context.readProvider.getProtocolConstants("head"),e=yield this.getAccountLimits(e,i),e=yield A(Object.assign(Object.assign({},c),T({fee:o,storageLimit:a,gasLimit:n},e))),r=yield this.isRevealOpNeeded([e],t),e=r?yield this.addRevealOp([e],t):e;const s=yield this.prepareEstimate({operation:e,source:t},i,t);return r&&s.shift(),R.createEstimateInstanceFromProperties(s)})}batch(n){return f(this,void 0,void 0,function*(){var t=(yield this.getKeys())["publicKeyHash"];let e=[];var i=yield this.context.readProvider.getProtocolConstants("head"),r=yield this.getAccountLimits(t,i,n.length);for(const o of n)switch(o.kind){case g.OpKind.TRANSACTION:e.push(yield l(Object.assign(Object.assign({},o),T(o,r))));break;case g.OpKind.ORIGINATION:e.push(yield d(yield this.context.parser.prepareCodeOrigination(Object.assign(Object.assign({},o),T(o,r)))));break;case g.OpKind.DELEGATION:e.push(yield A(Object.assign(Object.assign({},o),T(o,r))));break;case g.OpKind.ACTIVATION:e.push(Object.assign(Object.assign({},o),r));break;case g.OpKind.REGISTER_GLOBAL_CONSTANT:e.push(yield E(Object.assign(Object.assign({},o),T(o,r))));break;default:throw new v.InvalidOperationKindError(n.kind)}var s=yield this.isRevealOpNeeded(e,t),s=(e=s?yield this.addRevealOp(e,t):e,yield this.prepareEstimate({operation:e,source:t},i,t));return R.createArrayEstimateInstancesFromProperties(s)})}registerDelegate(o){return f(this,void 0,void 0,function*(){var t=(yield this.getKeys()).publicKeyHash,e=yield this.context.readProvider.getProtocolConstants("head"),i=yield this.getAccountLimits(t,e),i=yield Y(Object.assign(Object.assign({},o),i),t),r=yield this.isRevealOpNeeded([i],t),i=r?yield this.addRevealOp([i],t):i;const s=yield this.prepareEstimate({operation:i,source:t},e,t);return r&&s.shift(),R.createEstimateInstanceFromProperties(s)})}reveal(s){return f(this,void 0,void 0,function*(){var t,e,{publicKeyHash:i,publicKey:r}=yield this.getKeys();if(!r)throw new bt;if(yield this.isAccountRevealRequired(i))return t=yield this.context.readProvider.getProtocolConstants("head"),e=yield this.getAccountLimits(i,t),e=yield w(Object.assign(Object.assign({},s),e),i,r),r=yield this.prepareEstimate({operation:e,source:i},t,i),R.createEstimateInstanceFromProperties(r)})}registerGlobalConstant(t){var{fee:o,storageLimit:n,gasLimit:a}=t,c=e(t,["fee","storageLimit","gasLimit"]);return f(this,void 0,void 0,function*(){var t=(yield this.getKeys()).publicKeyHash,e=yield this.context.readProvider.getProtocolConstants("head"),i=yield this.getAccountLimits(t,e),i=yield E(Object.assign(Object.assign({},c),T({fee:o,storageLimit:n,gasLimit:a},i))),r=yield this.isRevealOpNeeded([i],t),i=r?yield this.addRevealOp([i],t):i;const s=yield this.prepareEstimate({operation:i,source:t},e,t);return r&&s.shift(),R.createEstimateInstanceFromProperties(s)})}addRevealOp(e,i){return f(this,void 0,void 0,function*(){var t=(yield this.getKeys())["publicKey"];if(t)return e.unshift(yield w(Object.assign({fee:p.DEFAULT_FEE.REVEAL,gasLimit:p.DEFAULT_GAS_LIMIT.REVEAL,storageLimit:p.DEFAULT_STORAGE_LIMIT.REVEAL}),i,yield this.signer.publicKey())),e;throw new bt})}}class At extends o{constructor(t,e,i,r,s,o){super(t,r,s,o),this.params=e,this.source=i}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"delegation"===t.kind),t=t&&t.metadata&&t.metadata.operation_result;return t||void 0}get status(){var t=this.operationResults;return t?t.status:"unknown"}get delegate(){return this.delegate}get isRegisterOperation(){return this.delegate===this.source}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}get consumedGas(){var t=this.operationResults&&this.operationResults.consumed_gas;return t||void 0}get errors(){return this.operationResults&&this.operationResults.errors}}class wt extends o{constructor(t,e,i,r,s,o){super(t,i,r,s),this.params=e,this.contractProvider=o;t=this.operationResults&&this.operationResults.originated_contracts;Array.isArray(t)&&(this.contractAddress=t[0])}get status(){var t=this.operationResults;return t?t.status:"unknown"}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"origination"===t.kind),t=t&&c(t)&&t.metadata.operation_result;return t||void 0}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}get consumedGas(){var t=this.operationResults&&this.operationResults.consumed_gas;return t||void 0}get storageDiff(){var t=this.operationResults&&this.operationResults.paid_storage_size_diff;return t||void 0}get storageSize(){var t=this.operationResults&&this.operationResults.storage_size;return t||void 0}get errors(){return this.operationResults&&this.operationResults.errors}contract(t,e){return f(this,void 0,void 0,function*(){if(this.contractAddress)return yield this.confirmation(t,e),this.contractProvider.at(this.contractAddress);throw new ot("No contract was originated in this operation")})}}class Et extends o{constructor(t,e,i,r,s,o){super(t,r,s,o),this.params=e,this.source=i,this.globalConstantHash=this.operationResults&&this.operationResults.global_address}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"register_global_constant"===t.kind),t=t&&t.metadata&&t.metadata.operation_result;return t||void 0}get status(){var t=this.operationResults;return t?t.status:"unknown"}get registeredExpression(){return this.params.value}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}get errors(){return this.operationResults&&this.operationResults.errors}}class Pt extends o{constructor(t,e,i,r,s,o){super(t,r,s,o),this.params=e,this.source=i}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"reveal"===t.kind);return t?[t]:[]}get status(){var t=this.operationResults[0];return t?t.metadata.operation_result.status:"unknown"}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}get publicKey(){return this.params.public_key}sumProp(t,i){return t.reduce((t,e)=>i in e?Number(e[i])+t:t,0)}get consumedGas(){return String(this.sumProp(P({contents:this.operationResults}),"consumed_gas"))}get storageDiff(){return String(this.sumProp(P({contents:this.operationResults}),"paid_storage_size_diff"))}get storageSize(){return String(this.sumProp(P({contents:this.operationResults}),"storage_size"))}get errors(){return I({contents:this.operationResults})}}class It extends o{constructor(t,e,i,r,s,o){super(t,r,s,o),this.params=e,this.source=i}get operationResults(){var t=Array.isArray(this.results)&&this.results.find(t=>"transaction"===t.kind);return t?[t]:[]}get status(){var t=this.operationResults[0];return t?t.metadata.operation_result.status:"unknown"}get amount(){return new h.default(this.params.amount)}get destination(){return this.params.destination}get fee(){return this.params.fee}get gasLimit(){return this.params.gas_limit}get storageLimit(){return this.params.storage_limit}sumProp(t,i){return t.reduce((t,e)=>i in e?Number(e[i])+t:t,0)}get consumedGas(){return String(this.sumProp(P({contents:this.operationResults}),"consumed_gas"))}get storageDiff(){return String(this.sumProp(P({contents:this.operationResults}),"paid_storage_size_diff"))}get storageSize(){return String(this.sumProp(P({contents:this.operationResults}),"storage_size"))}get errors(){return I({contents:this.operationResults})}}var x={setDelegate:t=>[{prim:"DROP"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"PUSH",args:[{prim:"key_hash"},{string:t}]},{prim:"SOME"},{prim:"SET_DELEGATE"},{prim:"CONS"}],removeDelegate:()=>[{prim:"DROP"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"NONE",args:[{prim:"key_hash"}]},{prim:"SET_DELEGATE"},{prim:"CONS"}],transferImplicit:(t,e)=>[{prim:"DROP"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"PUSH",args:[{prim:"key_hash"},{string:t}]},{prim:"IMPLICIT_ACCOUNT"},{prim:"PUSH",args:[{prim:"mutez"},{int:""+e}]},{prim:"UNIT"},{prim:"TRANSFER_TOKENS"},{prim:"CONS"}],transferToContract:(t,e)=>[{prim:"DROP"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"PUSH",args:[{prim:"address"},{string:t}]},{prim:"CONTRACT",args:[{prim:"unit"}]},[{prim:"IF_NONE",args:[[[{prim:"UNIT"},{prim:"FAILWITH"}]],[]]}],{prim:"PUSH",args:[{prim:"mutez"},{int:""+e}]},{prim:"UNIT"},{prim:"TRANSFER_TOKENS"},{prim:"CONS"}]},Lt={code:[{prim:"parameter",args:[{prim:"lambda",args:[{prim:"unit"},{prim:"pair",args:[{prim:"list",args:[{prim:"operation"}]},{prim:"unit"}]}]}]},{prim:"storage",args:[{prim:"unit"}]},{prim:"code",args:[[{prim:"CAR"},{prim:"UNIT"},{prim:"EXEC"}]]}],storage:"Unit"};class Rt{constructor(t,e,i,r,s,o=!0,n=!1){this.provider=t,this.address=e,this.parameterSchema=i,this.name=r,this.args=s,this.isMultipleEntrypoint=o,this.isAnonymous=n}validateArgs(e,t,i){const r=t.ExtractSignatures();if(!r.find(t=>t.length===e.length))throw new b(i,r,e)}get schema(){return this.isAnonymous?this.parameterSchema.ExtractSchema()[this.name]:this.parameterSchema.ExtractSchema()}getSignature(){var t;if(!this.isAnonymous)return 1==(t=this.parameterSchema.ExtractSignatures()).length?t[0]:t;{const e=this.parameterSchema.ExtractSignatures().find(t=>t[0]===this.name);if(e)return e.shift(),e}}send(t={}){return this.provider instanceof S?this.provider.transfer(this.toTransferParams(t)).send():this.provider.transfer(this.toTransferParams(t))}toTransferParams({fee:t,gasLimit:e,storageLimit:i,source:r,amount:s=0,mutez:o=!1}={}){return{to:this.address,amount:s,fee:t,mutez:o,source:r,gasLimit:e,storageLimit:i,parameter:{entrypoint:this.isMultipleEntrypoint?this.name:N,value:this.isAnonymous?this.parameterSchema.Encode(this.name,...this.args):this.parameterSchema.Encode(...this.args)}}}}class Tt{constructor(t,e){this.walletProvider=t,this.context=e,this.operations=[]}withTransfer(t){if(v.validateAddress(t.to)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(t.to);return this.operations.push(Object.assign({kind:g.OpKind.TRANSACTION},t)),this}withContractCall(t){return this.withTransfer(t.toTransferParams())}withDelegation(t){if(t.delegate&&v.validateAddress(t.delegate)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(t.delegate);return this.operations.push(Object.assign({kind:g.OpKind.DELEGATION},t)),this}withOrigination(t){return this.operations.push(Object.assign({kind:g.OpKind.ORIGINATION},t)),this}mapOperation(t){return f(this,void 0,void 0,function*(){switch(t.kind){case g.OpKind.TRANSACTION:return this.walletProvider.mapTransferParamsToWalletParams(()=>f(this,void 0,void 0,function*(){return t}));case g.OpKind.ORIGINATION:return this.walletProvider.mapOriginateParamsToWalletParams(()=>f(this,void 0,void 0,function*(){return this.context.parser.prepareCodeOrigination(Object.assign({},t))}));case g.OpKind.DELEGATION:return this.walletProvider.mapDelegateParamsToWalletParams(()=>f(this,void 0,void 0,function*(){return t}));default:throw new v.InvalidOperationKindError(t.kind)}})}with(t){for(const e of t)switch(e.kind){case g.OpKind.TRANSACTION:this.withTransfer(e);break;case g.OpKind.ORIGINATION:this.withOrigination(e);break;case g.OpKind.DELEGATION:this.withDelegation(e);break;default:throw new v.InvalidOperationKindError(e.kind)}return this}send(){return f(this,void 0,void 0,function*(){const t=[];for(const i of this.operations)t.push(yield this.mapOperation(i));var e=yield this.walletProvider.sendOperations(t);return this.context.operationFactory.createBatchOperation(e)})}}class S{constructor(t){this.context=t,this.walletCommand=t=>({send:t})}get walletProvider(){return this.context.walletProvider}pkh({forceRefetch:t}={}){return f(this,void 0,void 0,function*(){return this._pkh&&!t||(this._pkh=yield this.walletProvider.getPKH()),this._pkh})}originate(e){return this.walletCommand(()=>f(this,void 0,void 0,function*(){var t=yield this.walletProvider.mapOriginateParamsToWalletParams(()=>this.context.parser.prepareCodeOrigination(Object.assign({},e))),t=yield this.walletProvider.sendOperations([t]);return this.context.operationFactory.createOriginationOperation(t)}))}setDelegate(e){if(e.delegate&&v.validateAddress(e.delegate)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(e.delegate);return this.walletCommand(()=>f(this,void 0,void 0,function*(){var t=yield this.walletProvider.mapDelegateParamsToWalletParams(()=>f(this,void 0,void 0,function*(){return e})),t=yield this.walletProvider.sendOperations([t]);return this.context.operationFactory.createDelegationOperation(t)}))}registerDelegate(){return this.walletCommand(()=>f(this,void 0,void 0,function*(){var t=yield this.walletProvider.mapDelegateParamsToWalletParams(()=>f(this,void 0,void 0,function*(){return{delegate:yield this.pkh()}})),t=yield this.walletProvider.sendOperations([t]);return this.context.operationFactory.createDelegationOperation(t)}))}transfer(e){if(v.validateAddress(e.to)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(e.to);return this.walletCommand(()=>f(this,void 0,void 0,function*(){var t=yield this.walletProvider.mapTransferParamsToWalletParams(()=>f(this,void 0,void 0,function*(){return e})),t=yield this.walletProvider.sendOperations([t]);return this.context.operationFactory.createTransactionOperation(t)}))}batch(t){const e=new Tt(this.walletProvider,this.context);return Array.isArray(t)&&e.with(t),e}at(s,o=t=>t){return f(this,void 0,void 0,function*(){if(v.validateContractAddress(s)!==v.ValidationResult.VALID)throw new v.InvalidContractAddressError(s);var t=this.context.withExtensions().rpc;const e=this.context.withExtensions().readProvider;var i=yield e.getScript(s,"head"),r=yield e.getEntrypoints(s),i=new Dt(s,i,this,this.context.contract,r,t,e);return o(i,this.context)})}}class xt{constructor(t){this.context=t}getPKH(){return f(this,void 0,void 0,function*(){return this.context.signer.publicKeyHash()})}mapTransferParamsToWalletParams(t){return f(this,void 0,void 0,function*(){return Q(yield t(),g.OpKind.TRANSACTION)})}mapOriginateParamsToWalletParams(t){return f(this,void 0,void 0,function*(){return Q(yield t(),g.OpKind.ORIGINATION)})}mapDelegateParamsToWalletParams(t){return f(this,void 0,void 0,function*(){return Q(yield t(),g.OpKind.DELEGATION)})}sendOperations(t){return f(this,void 0,void 0,function*(){return(yield this.context.batch.batch(t).send()).hash})}}class St{constructor(t,e,i,r,s="unit",o=!0,n=!1){this.provider=t,this.address=e,this.parameterSchema=i,this.name=r,this.args=s,this.isMultipleEntrypoint=o,this.isAnonymous=n}getSignature(){return this.isAnonymous?this.parameterSchema.ExtractSchema()[this.name]:this.parameterSchema.ExtractSchema()}send(t={}){return this.provider instanceof S?this.provider.transfer(this.toTransferParams(t)).send():this.provider.transfer(this.toTransferParams(t))}toTransferParams({fee:t,gasLimit:e,storageLimit:i,source:r,amount:s=0,mutez:o=!1}={}){return{to:this.address,amount:s,fee:t,mutez:o,source:r,gasLimit:e,storageLimit:i,parameter:{entrypoint:this.isMultipleEntrypoint?this.name:N,value:this.isAnonymous?this.parameterSchema.EncodeObject({[this.name]:this.args}):this.parameterSchema.EncodeObject(this.args)}}}}class Nt{constructor(t,e,i,r,s,o="Unit"){this._rpc=t,this._readProvider=e,this._contractAddress=i,this._smartContractViewSchema=r,this._contractStorageType=s,this._args=o}getSignature(){return{parameter:this._smartContractViewSchema.extractArgsSchema(),result:this._smartContractViewSchema.extractResultSchema()}}executeView(d){return f(this,void 0,void 0,function*(){this.verifyContextExecution(d);var t,e,i,r,s,o,n=(yield this._readProvider.getBalance(this._contractAddress,"head")).toString(),a=yield this._readProvider.getChainId(),c=yield this._readProvider.getStorage(this._contractAddress,"head");return this.executeViewAndDecodeResult((t=this._smartContractViewSchema.viewArgsType,e=this._smartContractViewSchema.viewReturnType,i=this._contractStorageType,r=this.adaptViewCodeToContext(this._smartContractViewSchema.instructions,d.viewCaller,n),s=this.transformArgsToMichelson(),o=d.source,{script:[{prim:"parameter",args:[{prim:"pair",args:[t,i]}]},{prim:"storage",args:[{prim:"option",args:[e]}]},{prim:"code",args:[[{prim:"CAR"},r,{prim:"SOME"},{prim:"NIL",args:[{prim:"operation"}]},{prim:"PAIR"}]]}],storage:{prim:"None"},input:{prim:"Pair",args:[s,c]},amount:"0",balance:n,chain_id:a,source:o}))})}verifyContextExecution(t){if(t.source&&v.validateAddress(t.source)!==v.ValidationResult.VALID)throw new $(`The source account who initialized the view execution is invalid: ${t.source}.`);if(!t.viewCaller||v.validateAddress(t.viewCaller)!==v.ValidationResult.VALID)throw new $(`The contract which is the caller of view is invalid: ${t.viewCaller}.`)}transformArgsToMichelson(){try{return this._smartContractViewSchema.encodeViewArgs(this._args)}catch(t){throw new z(this._smartContractViewSchema.viewName,this.getSignature(),this._args,t)}}adaptViewCodeToContext(i,r,s){const o={BALANCE:[{prim:"PUSH",args:[{prim:"mutez"},{int:s}]}],SENDER:[{prim:"PUSH",args:[{prim:"address"},{string:r}]}],SELF_ADDRESS:[{prim:"PUSH",args:[{prim:"address"},{string:this._contractAddress}]}],AMOUNT:[{prim:"PUSH",args:[{prim:"mutez"},{int:"0"}]}]};return i.forEach((t,e)=>{t.prim in o&&(i[e]=Object(o)[t.prim]),t.args&&0!==t.args.length?this.adaptViewCodeToContext(t.args,r,s):Array.isArray(t)&&this.adaptViewCodeToContext(t,r,s)}),i}executeViewAndDecodeResult(i){return f(this,void 0,void 0,function*(){let t;try{t=(yield this._rpc.runCode(i)).storage}catch(t){var e=W(t);throw e?new q(`The simulation of the on-chain view named ${this._smartContractViewSchema.viewName} failed with: `+JSON.stringify(e),this._smartContractViewSchema.viewName,e,t):t}if(t.args)return this._smartContractViewSchema.decodeViewResult(t.args[0]);throw new q("View simulation failed with an invalid result: "+t,this._smartContractViewSchema.viewName)})}}class Ct{constructor(t,e){this.provider=t,this.contractAddress=e}createContractMethodFlatParams(t,e,i,r=!0,s=!1){return new Rt(this.provider,this.contractAddress,t,e,i,r,s)}createContractMethodObjectParam(t,e,i,r=!0,s=!1){return new St(this.provider,this.contractAddress,t,e,i,r,s)}createContractViewObjectParam(t,e,i,r,s){return new Nt(t,e,this.contractAddress,i,r,s)}}const N="default";class kt{constructor(t,e,i,r,s,o,n){this.currentContract=t,this.name=e,this.callbackParametersSchema=i,this.parameterSchema=r,this.args=s,this.rpc=o,this.readProvider=n}read(e){return f(this,void 0,void 0,function*(){if(v.validateContractAddress(e)==v.ValidationResult.VALID)throw new v.DeprecationError("Since version 12, the lambda view no longer depends on a lambda contract. The read method no longer accepts a contract address as a parameter.");if(e&&v.validateChain(e)!==v.ValidationResult.VALID)throw new v.InvalidChainIdError(e);var t=this.parameterSchema.Encode(...this.args),t=yield this.rpc.runView({contract:this.currentContract.address,entrypoint:this.name,input:t,chain_id:e||(yield this.readProvider.getChainId())});return this.callbackParametersSchema.Execute(t.data)})}}class Dt{constructor(t,e,i,r,s,o,n){this.address=t,this.script=e,this.storageProvider=r,this.entrypoints=s,this.rpc=o,this.readProvider=n,this.methods={},this.methodsObject={},this.views={},this.contractViews={},this.contractMethodFactory=new Ct(i,t),this.schema=m.Schema.fromRPCResponse({script:this.script}),this.parameterSchema=m.ParameterSchema.fromRPCResponse({script:this.script}),this.viewSchema=m.ViewSchema.fromRPCResponse({script:this.script}),0!==this.viewSchema.length&&this._initializeOnChainViews(this,o,this.readProvider,this.viewSchema),this._initializeMethods(this,this.entrypoints.entrypoints,this.rpc,this.readProvider)}_initializeMethods(c,d,h,l){const i=this.parameterSchema,t=Object.keys(d);if(i.isMultipleEntryPoint){t.forEach(a=>{const e=new m.ParameterSchema(d[a]);this.methods[a]=function(...t){return c.contractMethodFactory.createContractMethodFlatParams(e,a,t)},this.methodsObject[a]=function(t){return c.contractMethodFactory.createContractMethodObjectParam(e,a,t)},(t=>{let e=!1;return"prim"in t&&"pair"===t.prim&&t.args&&("prim"in(t=t.args[t.args.length-1])&&"contract"===t.prim&&(e=!0)),e})(d[a])&&(this.views[a]=function(...t){var e=d[a].args[0],e=new m.ParameterSchema(e),i=d[a].args[1].args[0],i=new m.ParameterSchema(i);{var r=t,s,o=a;const n=e.ExtractSignatures();if(!n.find(t=>t.length===r.length))throw new b(o,n,r)}return new kt(c,a,i,e,t,h,l)})});const e=Object.keys(i.ExtractSchema()).filter(t=>-1===Object.keys(d).indexOf(t));e.forEach(e=>{this.methods[e]=function(...t){return c.contractMethodFactory.createContractMethodFlatParams(i,e,t,!1,!0)},this.methodsObject[e]=function(t){return c.contractMethodFactory.createContractMethodObjectParam(i,e,t,!1,!0)}})}else{const r=this.parameterSchema;this.methods[N]=function(...t){return c.contractMethodFactory.createContractMethodFlatParams(r,N,t,!1)},this.methodsObject[N]=function(t){return c.contractMethodFactory.createContractMethodObjectParam(r,N,t,!1)}}}_initializeOnChainViews(i,r,s,t){const o=this.schema.val;t.forEach(e=>{this.contractViews[e.viewName]=function(t){return i.contractMethodFactory.createContractViewObjectParam(r,s,e,o,t)}})}storage(){return this.storageProvider.getStorage(this.address,this.schema)}bigMap(t){return this.storageProvider.getBigMapKey(this.address,t,this.schema)}}class Ft{constructor(t,e,i){this.id=t,this.schema=e,this.provider=i}get(t,e){return f(this,void 0,void 0,function*(){try{return yield this.provider.getBigMapKeyByID(this.id.toString(),t,this.schema,e)}catch(t){if(t instanceof s.HttpResponseError&&t.status===s.STATUS_CODE.NOT_FOUND)return;throw t}})}getMultipleValues(t,e,i=5){return f(this,void 0,void 0,function*(){return this.provider.getBigMapKeysByID(this.id.toString(),t,this.schema,e,i)})}toJSON(){return this.id.toString()}toString(){return this.id.toString()}}class Mt{constructor(t,e){this.id=t,this.provider=e}getSaplingDiff(t){return f(this,void 0,void 0,function*(){return this.provider.getSaplingDiffByID(this.id.toString(),t)})}getId(){return this.id.toString()}}const Vt=i=>({big_map:(t,e)=>{return t&&"int"in t&&void 0!==t.int?(e=new m.Schema(e),new Ft(new h.default(t.int),e,i)):{}},sapling_state:t=>t&&"int"in t&&void 0!==t.int?new Mt(new h.default(t.int),i):{}});class jt extends r{constructor(t,e){super(t),this.estimator=e,this.contractProviderTypeSymbol=Symbol.for("taquito--provider-type-symbol")}getStorage(i,r){return f(this,void 0,void 0,function*(){if(v.validateContractAddress(i)!==v.ValidationResult.VALID)throw new v.InvalidContractAddressError(i);var t=yield this.context.readProvider.getScript(i,"head");r=r||t;let e;return(e=m.Schema.isSchema(r)?r:m.Schema.fromRPCResponse({script:r})).Execute(t.storage,Vt(this))})}getBigMapKey(i,r,s){return f(this,void 0,void 0,function*(){if(v.validateContractAddress(i)!==v.ValidationResult.VALID)throw new v.InvalidContractAddressError(i);s=s||(yield this.rpc.getContract(i)).script;let t;var e=(t=m.Schema.isSchema(s)?s:m.Schema.fromRPCResponse({script:s})).EncodeBigMapKey(r),e=yield this.rpc.getBigMapKey(i,e);return t.ExecuteOnBigMapValue(e)})}getBigMapKeyByID(i,r,s,o){return f(this,void 0,void 0,function*(){var{key:t,type:e}=s.EncodeBigMapKey(r),t=(yield this.context.packer.packData({data:t,type:e}))["packed"],e=v.encodeExpr(t),t=o?yield this.context.readProvider.getBigMapValue({id:i.toString(),expr:e},o):yield this.context.readProvider.getBigMapValue({id:i.toString(),expr:e},"head");return s.ExecuteOnBigMapValue(t,Vt(this))})}getBigMapKeysByID(n,a,c,d,h=5){return f(this,void 0,void 0,function*(){const e=yield this.getBlockForRequest(a,d),i=new m.MichelsonMap;let t=0,r=[];for(;t<a.length;){const o=a.slice(t,t+h);var s=o.map(t=>this.getBigMapValueOrUndefined(t,n,c,e));r=[...r,...yield Promise.all(s)],t+=h}for(let t=0;t<r.length;t++)i.set(a[t],r[t]);return i})}getBlockForRequest(t,e){return f(this,void 0,void 0,function*(){return 1===t.length||void 0!==e?e:yield this.context.readProvider.getBlockLevel("head")})}getBigMapValueOrUndefined(t,e,i,r){return f(this,void 0,void 0,function*(){try{return yield this.getBigMapKeyByID(e,t,i,r)}catch(t){if(t instanceof s.HttpResponseError&&t.status===s.STATUS_CODE.NOT_FOUND)return;throw t}})}getSaplingDiffByID(t,e){return f(this,void 0,void 0,function*(){return e?yield this.context.readProvider.getSaplingDiffById({id:t.toString()},e):yield this.context.readProvider.getSaplingDiffById({id:t.toString()},"head")})}addRevealOperationIfNeeded(s,o){return f(this,void 0,void 0,function*(){if(et(s)){const i=[s];var t,e=yield this.signer.publicKey();const r=yield this.estimator.reveal();if(r)return t={kind:g.OpKind.REVEAL},t=yield this.estimate(t,()=>f(this,void 0,void 0,function*(){return r})),i.unshift(yield w(Object.assign({},t),o,e)),i}return s})}originate(o){return f(this,void 0,void 0,function*(){var t=yield this.estimate(o,this.estimator.originate.bind(this.estimator)),e=yield this.signer.publicKeyHash(),t=yield d(yield this.context.parser.prepareCodeOrigination(Object.assign(Object.assign({},o),t))),i=yield this.addRevealOperationIfNeeded(t,e),i=yield this.prepareOperation({operation:i,source:e}),e=yield this.forge(i),{hash:i,context:e,forgedBytes:r,opResponse:s}=yield this.signAndInject(e);return new wt(i,t,r,s,e,this)})}setDelegate(n){return f(this,void 0,void 0,function*(){if(n.source&&v.validateAddress(n.source)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(n.source);if(n.delegate&&v.validateAddress(n.delegate)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(n.delegate);if(/kt1/i.test(n.source))throw new H(n.source);var t=yield this.estimate(n,this.estimator.setDelegate.bind(this.estimator)),e=yield this.signer.publicKeyHash(),t=yield A(Object.assign(Object.assign({},n),t)),i=n.source||e,e=yield this.addRevealOperationIfNeeded(t,e),e=yield this.prepareOperation({operation:e,source:i}),e=yield this.forge(e),{hash:e,context:r,forgedBytes:s,opResponse:o}=yield this.signAndInject(e);return new At(e,t,i,s,o,r)})}registerDelegate(n){return f(this,void 0,void 0,function*(){var t=yield this.estimate(n,this.estimator.registerDelegate.bind(this.estimator)),e=yield this.signer.publicKeyHash(),t=yield Y(Object.assign(Object.assign({},n),t),e),i=yield this.addRevealOperationIfNeeded(t,e),i=yield this.prepareOperation({operation:i}),i=yield this.forge(i),{hash:i,context:r,forgedBytes:s,opResponse:o}=yield this.signAndInject(i);return new At(i,t,e,s,o,r)})}transfer(n){return f(this,void 0,void 0,function*(){if(v.validateAddress(n.to)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(n.to);if(n.source&&v.validateAddress(n.source)!==v.ValidationResult.VALID)throw new v.InvalidAddressError(n.source);var t=yield this.signer.publicKeyHash(),e=yield this.estimate(n,this.estimator.transfer.bind(this.estimator)),e=yield l(Object.assign(Object.assign({},n),e)),i=n.source||t,t=yield this.addRevealOperationIfNeeded(e,t),t=yield this.prepareOperation({operation:t,source:n.source}),t=yield this.forge(t),{hash:t,context:r,forgedBytes:s,opResponse:o}=yield this.signAndInject(t);return new It(t,e,i,s,o,r)})}reveal(a){return f(this,void 0,void 0,function*(){var t,e,i,r,s,o=yield this.signer.publicKeyHash();const n=yield this.estimator.reveal(a);if(n)return t=yield this.estimate(a,()=>f(this,void 0,void 0,function*(){return n})),t=yield w(Object.assign({},t),o,yield this.signer.publicKey()),e=yield this.prepareOperation({operation:t,source:o}),e=yield this.forge(e),{hash:e,context:i,forgedBytes:r,opResponse:s}=yield this.signAndInject(e),new Pt(e,t,o,r,s,i);throw new J(`The publicKeyHash '${o}' has already been revealed.`)})}registerGlobalConstant(n){return f(this,void 0,void 0,function*(){var t=yield this.signer.publicKeyHash(),e=yield this.estimate(n,this.estimator.registerGlobalConstant.bind(this.estimator)),e=yield E(Object.assign(Object.assign({},n),e)),i=yield this.addRevealOperationIfNeeded(e,t),i=yield this.prepareOperation({operation:i,source:t}),i=yield this.forge(i),{hash:i,context:r,forgedBytes:s,opResponse:o}=yield this.signAndInject(i);return new Et(i,e,t,s,o,r)})}at(s,o=t=>t){return f(this,void 0,void 0,function*(){if(v.validateContractAddress(s)!==v.ValidationResult.VALID)throw new v.InvalidContractAddressError(s);var t=this.context.withExtensions().rpc;const e=this.context.withExtensions().readProvider;var i=yield e.getScript(s,"head"),r=yield e.getEntrypoints(s),i=new Dt(s,i,this,this,r,t,e);return o(i,this.context)})}batch(t){const e=new lt(this.context,this.estimator);return Array.isArray(t)&&e.with(t),e}}class Bt{constructor(t){this.context=t}getNextProto(){return f(this,void 0,void 0,function*(){var t;return this.context.proto||(t=yield this.context.readProvider.getNextProtocol("head"),this.context.proto=t),this.context.proto})}parseScript(e){return f(this,void 0,void 0,function*(){const t=new a.Parser({protocol:yield this.getNextProto()});return t.parseScript(e)})}parseMichelineExpression(e){return f(this,void 0,void 0,function*(){const t=new a.Parser({protocol:yield this.getNextProto()});return t.parseMichelineExpression(e)})}parseJSON(e){return f(this,void 0,void 0,function*(){const t=new a.Parser({protocol:yield this.getNextProto()});return t.parseJSON(e)})}prepareCodeOrigination(n){return f(this,void 0,void 0,function*(){const t=n;if(t.code=yield this.formatCodeParam(n.code),n.init)t.init=yield this.formatInitParam(n.init);else if(n.storage){var e=t.code.find(t=>"prim"in t&&"storage"===t.prim);if(null==e||!e.args)throw new _("The storage section is missing from the script",n.code);const r=new m.Schema(e.args[0]);var i=yield this.findGlobalConstantsHashAndValue(r);if(0!==Object.keys(i).length){const s=new a.Parser({expandGlobalConstant:i});i=s.parseJSON(e.args[0]);const o=new m.Schema(i);t.init=o.Encode(n.storage)}else t.init=r.Encode(n.storage);delete t.storage}return t})}formatCodeParam(s){return f(this,void 0,void 0,function*(){let t;if("string"==typeof s){var e=yield this.parseScript(s);if(null===e)throw new _("Invalid code parameter",s);t=e}else{const i=yield this.parseJSON(s),r=["parameter","storage","code"];t=i.sort((t,e)=>r.indexOf(t.prim)-r.indexOf(e.prim))}return t})}formatInitParam(i){return f(this,void 0,void 0,function*(){let t;if("string"==typeof i){var e=yield this.parseMichelineExpression(i);if(null===e)throw new U("Invalid init parameter",i);t=e}else t=yield this.parseJSON(i);return t})}findGlobalConstantsHashAndValue(o){return f(this,void 0,void 0,function*(){var t=o.findToken("constant"),e={};if(0!==t.length)for(const s of t){var i,r=s.tokenVal.args;r&&(r=r[0].string,i=yield this.context.globalConstantsProvider.getGlobalConstantByHash(r),Object.assign(e,{[r]:i}))}return e})}}class Gt{constructor(t){this.context=t}packData(t){return f(this,void 0,void 0,function*(){return this.context.rpc.packData(t)})}}class Kt extends Error{constructor(t){super(`Please load the value associated with the constant ${t} using the loadGlobalConstant method of the DefaultGlobalConstantsProvider.`),this.hash=t,this.name="GlobalConstantNotFound"}}class Ht extends Error{constructor(){super("No global constants provider has been configured. Please configure one by calling setGlobalConstantsProvider({globalConstantsProvider}) on your TezosToolkit instance."),this.name="UnconfiguredGlobalConstantsProviderError"}}class Ut{getGlobalConstantByHash(t){return f(this,void 0,void 0,function*(){throw new Ht})}}class zt{constructor(t){this.context=t}getBalance(t,e){return f(this,void 0,void 0,function*(){return this.context.rpc.getBalance(t,{block:String(e)})})}getDelegate(t,e){return f(this,void 0,void 0,function*(){return this.context.rpc.getDelegate(t,{block:String(e)})})}getNextProtocol(t){return f(this,void 0,void 0,function*(){return(yield this.context.rpc.getProtocols({block:String(t)})).next_protocol})}getProtocolConstants(n){return f(this,void 0,void 0,function*(){var{time_between_blocks:t,minimal_block_delay:e,hard_gas_limit_per_operation:i,hard_gas_limit_per_block:r,hard_storage_limit_per_operation:s,cost_per_byte:o}=yield this.context.rpc.getConstants({block:String(n)});return{time_between_blocks:t,minimal_block_delay:e,hard_gas_limit_per_operation:i,hard_gas_limit_per_block:r,hard_storage_limit_per_operation:s,cost_per_byte:o}})}getScript(e,i){return f(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getContract(e,{block:String(i)}))["script"];return t})}getStorage(t,e){return f(this,void 0,void 0,function*(){return this.context.rpc.getStorage(t,{block:String(e)})})}getBlockHash(e){return f(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getBlockHeader({block:String(e)}))["hash"];return t})}getBlockLevel(e){return f(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getBlockHeader({block:String(e)}))["level"];return t})}getCounter(e,i){return f(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getContract(e,{block:String(i)}))["counter"];return t||"0"})}getBlockTimestamp(e){return f(this,void 0,void 0,function*(){var t=(yield this.context.rpc.getBlockHeader({block:String(e)}))["timestamp"];return t})}getBigMapValue(t,e){return f(this,void 0,void 0,function*(){return this.context.rpc.getBigMapExpr(t.id,t.expr,{block:String(e)})})}getSaplingDiffById(t,e){return f(this,void 0,void 0,function*(){return this.context.rpc.getSaplingDiffById(t.id,{block:String(e)})})}getEntrypoints(t){return f(this,void 0,void 0,function*(){return this.context.rpc.getEntrypoints(t)})}getChainId(){return f(this,void 0,void 0,function*(){return this.context.rpc.getChainId()})}isAccountRevealed(e,i){return f(this,void 0,void 0,function*(){var t=yield this.context.rpc.getManagerKey(e,{block:String(i)});return t&&"object"==typeof t?!!t.key:!!t})}getBlock(t){return f(this,void 0,void 0,function*(){return this.context.rpc.getBlock({block:String(t)})})}getLiveBlocks(t){return this.context.rpc.getLiveBlocks({block:String(t)})}}const qt=(t,e)=>{if("opHash"in e)return t.hash===e.opHash;if("source"in e){var i=t,r=e;switch(i.kind){case"endorsement":return"metadata"in i&&i.metadata.delegate===r.source;case"activate_account":return"metadata"in i&&i.pkh===r.source;default:return"source"in i&&i.source===r.source}}else{if("kind"in e)return o=e,"kind"in(s=t)&&s.kind===o.kind;var s,o;if(!("destination"in e))return!1;var n=t,a=e;switch(n.kind){case"delegation":return n.delegate===a.destination;case"origination":if("metadata"in n&&"operation_result"in n.metadata&&"originated_contracts"in n.metadata.operation_result&&Array.isArray(n.metadata.operation_result.originated_contracts))return n.metadata.operation_result.originated_contracts.some(t=>t===a.destination);break;case"transaction":return n.destination===a.destination;default:return!1}}},Wt=(e,t)=>{if(Array.isArray(t.and))return t.and.every(t=>$t(e,t));if(Array.isArray(t.or))return t.or.some(t=>$t(e,t));throw new ct("Filter expression must contain either and/or property")},$t=(e,t)=>{const i=[];return Array.isArray(t)?i.push(...t):i.push(t),i.every(t=>("and"in t||"or"in t?Wt:qt)(e,t))};class Jt extends Error{constructor(t){super(t),this.message=t,this.name="UnsupportedEventError"}}class C{constructor(t,e=!1,i=n.retry()){this.shouldRetry=e,this.operatorFunction=i,this.errorListeners=[],this.messageListeners=[],this.closeListeners=[],this.completed$=new u.Subject,t.pipe(n.takeUntil(this.completed$),n.tap(t=>{this.call(this.messageListeners,t)},t=>{this.call(this.errorListeners,t)},()=>{this.call(this.closeListeners)}),this.shouldRetry?i:n.tap(),n.catchError(()=>u.NEVER)).subscribe()}call(t,e){for(const i of t)try{i(e)}catch(t){console.error(t)}}remove(t,e){e=t.indexOf(e);-1!==e&&t.splice(e,1)}on(t,e){switch(t){case"data":this.messageListeners.push(e);break;case"error":this.errorListeners.push(e);break;case"close":this.closeListeners.push(e);break;default:throw new Jt("Trying to register on an unsupported event: "+t)}}off(t,e){switch(t){case"data":this.remove(this.messageListeners,e);break;case"error":this.remove(this.errorListeners,e);break;case"close":this.remove(this.closeListeners,e);break;default:throw new Jt("Trying to unregister on an unsupported event: "+t)}}close(){this.completed$.next()}}const Xt={shouldObservableSubscriptionRetry:!1,observableSubscriptionRetryFunction:n.retry()};class k{constructor(t,e={}){this.context=t,this._config$=new u.BehaviorSubject(Object.assign(Object.assign({},Xt),e)),this.timer$=this._config$.pipe(n.pluck("pollingIntervalMilliseconds"),n.switchMap(t=>t?u.timer(0,t):u.from(this.getConfirmationPollingInterval()).pipe(n.switchMap(t=>u.timer(0,t))))),this.newBlock$=this.timer$.pipe(n.switchMap(()=>(t=>u.from(t.rpc.getBlock()).pipe(n.first()))(this.context)),n.distinctUntilKeyChanged("hash"),n.publish(),n.refCount())}get config(){return this._config$.getValue()}getConfirmationPollingInterval(){return f(this,void 0,void 0,function*(){if(!this.config.pollingIntervalMilliseconds)try{const t=yield this.context.readProvider.getProtocolConstants("head"),e=t.minimal_block_delay?t.minimal_block_delay.multipliedBy(1e3):t.time_between_blocks?t.time_between_blocks[0].multipliedBy(1e3):new h.default(5e3),i=e.dividedBy(3);this.config.pollingIntervalMilliseconds=0===i.toNumber()?1e3:i.toNumber()}catch(t){return 5e3}return this.config.pollingIntervalMilliseconds})}subscribeBlock(t){return new C(this.newBlock$,this.config.shouldObservableSubscriptionRetry,this.config.observableSubscriptionRetryFunction)}subscribe(t){return new C(this.newBlock$.pipe(n.pluck("hash")),this.config.shouldObservableSubscriptionRetry,this.config.observableSubscriptionRetryFunction)}subscribeOperation(t){return new C(this.newBlock$.pipe((o=t,n.concatMap(s=>new u.Observable(t=>{for(const e of s.operations)for(const i of e)for(const r of i.contents)$t(Object.assign({hash:i.hash},r),o)&&t.next(Object.assign({hash:i.hash},r));t.complete()})))),this.config.shouldObservableSubscriptionRetry,this.config.observableSubscriptionRetryFunction);var o}}class Yt{constructor(t){this.context=t}getNextProto(){return f(this,void 0,void 0,function*(){var t;return this.context.proto||(t=yield this.context.readProvider.getNextProtocol("head"),this.context.proto=t),this.context.proto})}forge({branch:e,contents:i}){return f(this,void 0,void 0,function*(){const t=new F.LocalForger(yield this.getNextProto());return t.forge({branch:e,contents:i})})}}const Qt={defaultConfirmationCount:1,confirmationPollingTimeoutSecond:180};class D{constructor(t,e=new y,i,r=new u.BehaviorSubject(Object.assign({},Qt)),s,o,n,a,c,d,h,l){this._rpc=t,this._signer=e,this._proto=i,this._config=r,this.providerDecorator=[],this.tz=new Ot(this),this.estimate=new _t(this),this.contract=new jt(this,this.estimate),this.batch=new ut(this,this.estimate),this.wallet=new S(this),this.withExtensions=()=>{let e=this.clone();return this.providerDecorator.forEach(t=>{e=t(e)}),e},"string"==typeof this._rpc?this._rpcClient=new g.RpcClient(this._rpc):this._rpcClient=this._rpc,this._forger=s||new Yt(this),this._injector=o||new V(this),this.operationFactory=new yt(this),this._walletProvider=a||new xt(this),this._parser=c||new Bt(this),this._packer=n||new Gt(this),this._globalConstantsProvider=d||new Ut,this._readProvider=h||new zt(this),this._stream=l||new k(this)}get config(){return this._config.getValue()}set config(t){this._config.next(Object.assign({},t))}setPartialConfig(t){this._config.next(Object.assign(Object.assign({},this._config.getValue()),t))}get rpc(){return this._rpcClient}set rpc(t){this._rpcClient=t}get injector(){return this._injector}set injector(t){this._injector=t}get forger(){return this._forger}set forger(t){this._forger=t}get signer(){return this._signer}set signer(t){this._signer=t}get walletProvider(){return this._walletProvider}set walletProvider(t){this._walletProvider=t}set proto(t){this._proto=t}get proto(){return this._proto}get parser(){return this._parser}set parser(t){this._parser=t}get packer(){return this._packer}set packer(t){this._packer=t}get globalConstantsProvider(){return this._globalConstantsProvider}set globalConstantsProvider(t){this._globalConstantsProvider=t}get readProvider(){return this._readProvider}set readProvider(t){this._readProvider=t}get stream(){return this._stream}set stream(t){this._stream=t}isAnyProtocolActive(e=[]){return f(this,void 0,void 0,function*(){var t;return this._proto?e.includes(this._proto):(t=yield this.readProvider.getNextProtocol("head"),e.includes(t))})}isAnySignerConfigured(){return!(this.signer instanceof y)}clone(){return new D(this.rpc,this.signer,this.proto,this._config,this.forger,this._injector,this.packer,this._walletProvider,this._parser,this._globalConstantsProvider,this._readProvider,this._stream)}registerProviderDecorator(t){this.providerDecorator.push(t)}}const Zt={commitHash:"cbdd0af87e400489076259d065e2d328feb8e1b4",version:"12.1.0"};class te extends Error{constructor(t){super("Forging mismatch error"),this.results=t,this.name="ForgingMismatchError"}}class ee extends Error{constructor(){super("At least one forger must be specified"),this.name="UnspecifiedForgerError"}}Object.defineProperty(p,"OpKind",{enumerable:!0,get:function(){return g.OpKind}}),Object.defineProperty(p,"MichelsonMap",{enumerable:!0,get:function(){return m.MichelsonMap}}),Object.defineProperty(p,"UnitValue",{enumerable:!0,get:function(){return m.UnitValue}}),p.BatchOperation=dt,p.BigMapAbstraction=Ft,p.CompositeForger=class{constructor(t){if(0===(this.forgers=t).length)throw new ee}forge({branch:r,contents:s}){return f(this,void 0,void 0,function*(){const t=yield Promise.all(this.forgers.map(t=>t.forge({branch:r,contents:s})));if(0===t.length)throw new ee;let e=t.pop();for(;t.length;){var i=t.pop();if(i!==e)throw new te([e,i]);e=i}return e})}},p.Context=D,p.ContractAbstraction=Dt,p.ContractMethod=Rt,p.ContractMethodObject=St,p.ContractView=kt,p.DEFAULT_SMART_CONTRACT_METHOD_NAME=N,p.DefaultGlobalConstantsProvider=class{constructor(){this._globalConstantsLibrary={}}loadGlobalConstant(t){for(const e in t)Object.assign(this._globalConstantsLibrary,{[e]:t[e]})}getGlobalConstantByHash(e){return f(this,void 0,void 0,function*(){var t=this._globalConstantsLibrary[e];if(t)return t;throw new Kt(e)})}},p.DelegateOperation=At,p.DelegationWalletOperation=mt,p.Estimate=R,p.GlobalConstantNotFound=Kt,p.InvalidCodeParameter=_,p.InvalidDelegationSource=H,p.InvalidInitParameter=U,p.InvalidParameterError=b,p.InvalidViewParameterError=z,p.InvalidViewSimulationContext=$,p.LegacyWalletProvider=xt,p.MANAGER_LAMBDA=x,p.MichelCodecPacker=class{packData(e){return f(this,void 0,void 0,function*(){var t=a.packDataBytes(e.data,e.type)["bytes"];return{packed:t}})}},p.MichelCodecParser=Bt,p.MissedBlockDuringConfirmationError=pt,p.NaiveEstimateProvider=class{constructor(t){this.protocol=t,this._costPerByte=250}registerGlobalConstant(t){throw new v.InvalidOperationKindError(t.kind)}originate({fee:t=p.DEFAULT_FEE.ORIGINATION,storageLimit:e=p.DEFAULT_STORAGE_LIMIT.ORIGINATION,gasLimit:i=1e3*p.DEFAULT_GAS_LIMIT.ORIGINATION}){return f(this,void 0,void 0,function*(){return new R(i,e,185,this._costPerByte,t)})}transfer({fee:t=p.DEFAULT_FEE.TRANSFER,storageLimit:e=p.DEFAULT_STORAGE_LIMIT.TRANSFER,gasLimit:i=1e3*p.DEFAULT_GAS_LIMIT.TRANSFER}){return f(this,void 0,void 0,function*(){return new R(i,e,162,this._costPerByte,t)})}setDelegate({fee:t=p.DEFAULT_FEE.DELEGATION,gasLimit:e=1e3*p.DEFAULT_GAS_LIMIT.DELEGATION}){return f(this,void 0,void 0,function*(){return new R(e,0,157,this._costPerByte,t)})}registerDelegate({fee:t=p.DEFAULT_FEE.DELEGATION,gasLimit:e=1e3*p.DEFAULT_GAS_LIMIT.DELEGATION}){return f(this,void 0,void 0,function*(){return new R(e,0,157,this._costPerByte,t)})}reveal(){return f(this,void 0,void 0,function*(){return new R(1e3*p.DEFAULT_GAS_LIMIT.REVEAL,p.DEFAULT_STORAGE_LIMIT.REVEAL,64,this._costPerByte,p.DEFAULT_FEE.REVEAL)})}batch(i){return f(this,void 0,void 0,function*(){const t=[];for(const e of i)switch(e.kind){case"transaction":t.push(yield this.transfer(e));break;case"origination":t.push(yield this.originate(e));break;case"delegation":t.push(yield this.setDelegate(e));break;case"activate_account":t.push(new R(0,0,0,this._costPerByte,0));break;default:throw new v.InvalidOperationKindError(i.kind)}return t})}},p.NoopParser=class{prepareCodeOrigination(t){return f(this,void 0,void 0,function*(){return t})}},p.ObservableSubscription=C,p.Operation=o,p.OperationBatch=lt,p.OriginationOperation=wt,p.OriginationParameterError=X,p.OriginationWalletOperation=vt,p.PollingSubscribeProvider=k,p.RPCEstimateProvider=_t,p.RevealEstimateError=bt,p.RevealOperationError=J,p.RpcForger=class{constructor(t){this.context=t}forge({branch:t,contents:e}){return this.context.rpc.forgeOperations({branch:t,contents:e})}},p.RpcPacker=Gt,p.RpcReadAdapter=zt,p.TaquitoLocalForger=Yt,p.TezosOperationError=rt,p.TezosPreapplyFailureError=st,p.TezosToolkit=class{constructor(t){this._rpc=t,this._options={},this.format=O,"string"==typeof this._rpc?this._rpcClient=new g.RpcClient(this._rpc):this._rpcClient=this._rpc,this._context=new D(t),this._wallet=new S(this._context),this.setProvider({rpc:this._rpcClient}),this.batch=this._context.batch.batch.bind(this._context.batch)}setProvider({rpc:t,stream:e,signer:i,protocol:r,config:s,forger:o,wallet:n,packer:a,globalConstantsProvider:c,readProvider:d}){this.setRpcProvider(t),this.setStreamProvider(e),this.setSignerProvider(i),this.setForgerProvider(o),this.setWalletProvider(n),this.setPackerProvider(a),this.setGlobalConstantsProvider(c),this.setReadProvider(d),this._context.proto=r,s&&this._context.setPartialConfig(s)}setSignerProvider(t){this._options.signer||void 0!==t?void 0!==t&&(this._context.signer=t,this._options.signer=t):(this._context.signer=new y,this._options.signer=t)}setRpcProvider(t){"string"==typeof t?this._rpcClient=new g.RpcClient(t):void 0!==t&&(this._rpcClient=t),this._options.rpc=this._rpcClient,this._context.rpc=this._rpcClient}setForgerProvider(t){void 0!==t?(this._options.forger=t,this._context.forger=t):void 0===this._options.forger&&(t=this.getFactory(Yt)(),this._options.forger=t,this._context.forger=t)}setStreamProvider(t){var e;"string"==typeof t?(e=new k(new D(new g.RpcClient(t))),this._options.stream=e,this._context.stream=e):void 0!==t?(this._options.stream=t,this._context.stream=t):void 0===this._options.stream&&(e=this.getFactory(k)(),this._options.stream=e,this._context.stream=e)}setWalletProvider(t){this._options.wallet||void 0!==t?void 0!==t&&(this._options.wallet=t,this._context.walletProvider=t):(t=this.getFactory(xt)(),this._options.wallet=t,this._context.walletProvider=t)}setPackerProvider(t){this._options.packer||void 0!==t?void 0!==t&&(this._context.packer=t,this._options.packer=t):(t=this.getFactory(Gt)(),this._context.packer=t,this._options.packer=t)}setGlobalConstantsProvider(t){this._options.globalConstantsProvider||void 0!==t?void 0!==t&&(this._context.globalConstantsProvider=t,this._options.globalConstantsProvider=t):(t=new Ut,this._context.globalConstantsProvider=t,this._options.globalConstantsProvider=t)}setReadProvider(t){t=void 0===t?this.getFactory(zt)():t;this._options.readProvider=t,this._context.readProvider=t}get tz(){return this._context.tz}get contract(){return this._context.contract}get wallet(){return this._wallet}get operation(){return this._context.operationFactory}get estimate(){return this._context.estimate}get stream(){return this._context.stream}get rpc(){return this._context.rpc}get signer(){return this._context.signer}get globalConstants(){return this._context.globalConstantsProvider}addExtension(t){Array.isArray(t)?t.forEach(t=>t.configureContext(this._context)):t.configureContext(this._context)}getFactory(e){return(...t)=>new e(this._context,...t)}getVersionInfo(){return Zt}},p.TransactionOperation=It,p.TransactionWalletOperation=ft,p.UnconfiguredGlobalConstantsProviderError=Ht,p.VIEW_LAMBDA=Lt,p.ViewSimulationError=q,p.Wallet=S,p.WalletOperation=L,p.WalletOperationBatch=Tt,p.compose=function(i,r){return(t,e)=>r(i(t,e),e)},p.createOriginationOperation=d,p.createRegisterDelegateOperation=Y,p.createRegisterGlobalConstantOperation=E,p.createRevealOperation=w,p.createSetDelegateOperation=A,p.createTransferOperation=l,p.defaultConfigConfirmation=Qt,p.protocols=t,p.validateAndExtractFailwith=W,Object.defineProperty(p,"__esModule",{value:!0})});