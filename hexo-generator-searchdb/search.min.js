class LocalSearch{constructor({path:t="",unescape:e=!1,top_n_per_article:n=1}){this.path=t,this.unescape=e,this.top_n_per_article=n,this.isfetched=!1,this.datas=null}getIndexByWord(t,s,o=!1){const h=[],i=new Set;return o||(s=s.toLowerCase()),t.forEach(e=>{if(this.unescape){const t=document.createElement("div");t.innerText=e,e=t.innerHTML}var n=e.length;if(0!==n){let t=0;var r;for(o||(e=e.toLowerCase());-1<(r=s.indexOf(e,t));)h.push({position:r,word:e}),i.add(e),t=r+n}}),h.sort((t,e)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length),[h,i]}mergeIntoSlice(t,e,n){var r;let{position:s,word:o}=r=n[0];const h=[],i=new Set;for(;s+o.length<=e&&0!==n.length;){i.add(o),h.push({position:s,length:o.length});var a=s+o.length;for(n.shift();0!==n.length&&(r=n[0],s=r.position,o=r.word,a>s);)n.shift()}return{hits:h,start:t,end:e,count:i.size}}highlightKeyword(t,e){let n="",r=e.start;for(var{position:s,length:o}of e.hits)n+=t.substring(r,s),r=s+o,n+=`<mark class="search-keyword">${t.substr(s,o)}</mark>`;return n+=t.substring(r,e.end),n}getResultItems(g){const u=[];return this.datas.forEach(({title:n,content:r,url:s})=>{var[o,h]=this.getIndexByWord(g,n),[i,a]=this.getIndexByWord(g,r),h=new Set([...h,...a]).size,a=o.length+i.length;if(0!==a){const d=[];0!==o.length&&d.push(this.mergeIntoSlice(0,n.length,o));let t=[];for(;0!==i.length;){var l=i[0]["position"],c=Math.max(0,l-20),l=Math.min(r.length,l+80);t.push(this.mergeIntoSlice(c,l,i))}t.sort((t,e)=>t.count!==e.count?e.count-t.count:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start);o=parseInt(this.top_n_per_article,10);0<=o&&(t=t.slice(0,o));let e="";(s=new URL(s,location.origin)).searchParams.append("highlight",g.join(" ")),0!==d.length?e+=`<li><a href="${s.href}" class="search-result-title">${this.highlightKeyword(n,d[0])}</a>`:e+=`<li><a href="${s.href}" class="search-result-title">${n}</a>`,t.forEach(t=>{e+=`<a href="${s.href}"><p class="search-result">${this.highlightKeyword(r,t)}...</p></a>`}),e+="</li>",u.push({item:e,id:u.length,hitCount:a,includedCount:h})}}),u}fetchData(){const e=!this.path.endsWith("json");fetch(this.path).then(t=>t.text()).then(t=>{this.isfetched=!0,this.datas=e?[...(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("entry")].map(t=>({title:t.querySelector("title").textContent,content:t.querySelector("content").textContent,url:t.querySelector("url").textContent})):JSON.parse(t),this.datas=this.datas.filter(t=>t.title).map(t=>(t.title=t.title.trim(),t.content=t.content?t.content.trim().replace(/<[^>]+>/g,""):"",t.url=decodeURIComponent(t.url).replace(/\/{2,}/g,"/"),t)),window.dispatchEvent(new Event("search:loaded"))})}highlightText(e,t,n){const r=e.nodeValue;let s=t.start;const o=[];for(var{position:h,length:i}of t.hits){var a=document.createTextNode(r.substring(s,h));s=h+i;const l=document.createElement("mark");l.className=n,l.appendChild(document.createTextNode(r.substr(h,i))),o.push(a,l)}e.nodeValue=r.substring(s,t.end),o.forEach(t=>{e.parentNode.insertBefore(t,e)})}highlightSearchWords(t){const e=new URL(location.href).searchParams.get("highlight"),n=e?e.split(" "):[];if(n.length&&t){const r=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),s=[];for(;r.nextNode();)r.currentNode.parentNode.matches("button, select, textarea")||s.push(r.currentNode);s.forEach(t=>{var[e]=this.getIndexByWord(n,t.nodeValue);e.length&&(e=this.mergeIntoSlice(0,t.nodeValue.length,e),this.highlightText(t,e,"search-keyword"))})}}}