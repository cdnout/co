!function(){function extend(t,e){for(var n=1;n<arguments.length;n+=1){var i=arguments[n];for(var r in i){var o=Object.getOwnPropertyDescriptor(i,r);"undefined"==typeof o||"undefined"==typeof o.value?delete t[r]:Object.defineProperty(t,r,o)}}return t}var blueprint={configure:function(t,e){return"function"==typeof arguments[0]?arguments[0].apply(this):this[t]=e,this}}.configure("ctor",function(){this.init&&this.init.apply(this,arguments)}).configure("_decorators",[]).configure("_applyDecorators",function(t,e){var n=[].concat(this._decorators);for(this._decorators=[];n.length;)e=n.shift().call(this,t,e);return e}).configure("directive",function(t,e){return e=this._applyDecorators(t,e),this[t]=e,this}).directive("mixin",function(t){return extend(this.ctor,t),extend(this.ctor.prototype,t.prototype),this.ctor.prototype.constructor=this.ctor,this}).directive("decorate",function(t,e){var n=this;"function"==typeof t&&1==arguments.length&&(e=t,t=void 0),e=this._applyDecorators(t,e);var i=function(){var t=e.apply(this,arguments);return this._decorators.push(t),this};return i.decorator=function(){return e.apply(n,arguments)},"undefined"==typeof t?i.apply(this):(this[t]=i,this)}).directive("define",function(t,e){e=this._applyDecorators(t,e);var n=this.ctor.prototype;this.__static&&(delete this.__static,n=this.ctor),n[t]=e;var i={name:t,value:e,obj:n};return this.ctor.trigger("define",i),this.ctor.trigger("define:"+t,i),this.__lastdefine=i,this}).directive("def",function(){return this.define.apply(this,arguments)}).decorate("static",function(){return this.__static=!0,function(t,e){return e}}).static().define("trigger",function(t){if(this.__events&&this.__events[t])for(var e=[].concat(this.__events[t]),n=0;n<e.length;n+=1)e[n].apply(this,arguments);return this}).static().define("on",function(t,e){return this.__events||(this.__events={}),this.__events[t]||(this.__events[t]=[]),this.__events[t].indexOf(e)!=-1?this:(this.__events[t].push(e),this)}).static().define("off",function(t,e){if(t){if(this.__events[t]){if(e){var n=this.__events[t].indexOf(e);return n!=-1&&this.__events[t].splice(n,1),this}return delete this.__events[t],this}return this}return delete this.__events,this}).configure(function(){this.ctor.prototype.trigger=this.ctor.trigger,this.ctor.prototype.on=this.ctor.on,this.ctor.prototype.off=this.ctor.off,this.ctor.on("extend",function(t,e){delete this.__events,e.on("extend",arguments.callee)})}).decorate("bind",function(t){return function(e,n){if("function"!=typeof n)throw new Error("'bind' decorator is only applicable to functions");var i=this;return function(){var e="function"==typeof t?t.call(i,this):t;return n.apply(e,arguments)}}}).bind(function(){return this}).static().define("extend",function(name,proto){var _super=this.ctor,ctor="(function NAME(){return _super.apply(this,arguments)})";ctor=ctor.replace("NAME",name||""),ctor=extend(eval(ctor),this.ctor),ctor.prototype=Object.create(this.ctor.prototype),ctor.prototype.constructor=ctor;var subcls=extend(Object.create(this),{ctor:ctor,super:this,_decorators:[],privates:extend({},this.privates),static_privates:extend({},this.static_privates)});return ctor.extend=this.bind.decorator(subcls)("extend",arguments.callee),this.ctor.trigger("extend",ctor),subcls}).decorate("alias",function(t){return function(e,n){return this.ctor.on("define",function(e,n){this.off("define",arguments.callee);var i=Object.getOwnPropertyDescriptor(n.obj,n.name);Object.defineProperty(n.obj,t,i)}),n}}).decorate("trigger",function(t){return function(e,n){return function(){return this.trigger(t,{arguments:arguments}),n.apply(this,arguments)}}}).decorate("thenable",function(){return function(t,e){return function(){var t=[].slice.call(arguments),n=this;return new Promise(function(i,r){t.push(i,r),e.apply(n,t)})}}}).directive("then",function(t){var e=this.__lastdefine;t=this._applyDecorators(e.name,t);var n=e.obj[e.name];return e.obj[e.name]=function(){var e=n.apply(this,arguments);return e instanceof Promise?e.then(t):t.call(this,e)},this}).directive("catch",function(t){var e=this.__lastdefine;t=this._applyDecorators(e.name,t);var n=e.obj[e.name];return e.obj[e.name]=function(){var e;try{e=n.apply(this,arguments),e instanceof Promise&&(e=e.catch(t))}catch(n){e=t.call(this,n)}return e},this}).directive("init",function(t){return this.define("init",t)}).directive("create",function(){return console.warn("blueprint.create() is deprecated. Use blueprint.compile() instead"),this.ctor.trigger("create"),this.ctor}).directive("compile",function(){return this.ctor.trigger("compile"),this.ctor}).compile(),Promise=blueprint.extend("Promise").init(function(t){var e=this.__onfulfill=[],n=this.__onreject=[],i="undefined"!=typeof process&&process.nextTick?process.nextTick:function(t){setTimeout(t,1)},r=function(t){i(function(){e.length&&(e.shift()(t),r(t))})},o=function(t){i(function(){n.length&&(n.shift()(t),o(t))})};t(r,o)}).define("resolve",function(t,e,n){var i=this;if(this==t)return n(new TypeError);if(["object","function"].indexOf(typeof t)==-1)return e(t);try{var r=t.then}catch(t){return n(t)}if("function"!=typeof r)return e(t);var o=!1;try{r.call(t,function(t){o||(o=!0,i.resolve(t,e,n))},function(t){o||(o=!0,n(t))})}catch(t){if(o)return;n(t)}}).define("then",function(t,e){var n=this,i=(n.resolve,new Promise(function(r,o){n.__onfulfill.push(function(e){if("function"!=typeof t)return void r(e);try{i.resolve(t(e),r,o)}catch(t){o(t)}}),n.__onreject.push(function(t){if("function"!=typeof e)return void o(t);try{i.resolve(e(t),r,o)}catch(t){o(t)}})}));return i}).define("catch",function(t){return this.then(null,t)}).compile(),Model=blueprint.extend("Model").define("id",null).init(function(t){t||(t={}),extend(this,t)}).directive("collection",function(t){return this.static().define("collection",t),this}).define("save",function(t){return this.constructor.backend().save(this,t)}).thenable().define("load",function(t){return this.constructor.backend().load(this,t)}).thenable().define("remove",function(t){return this.constructor.backend().remove(this,t)}).static().define("find",function(t,e){var n,i,r,o;return t=extend({},t),o={query:function(e){return 0==arguments.length?t:(t=extend({},e),this)},limit:function(t){return 0==arguments.length?n:(n=t,this)},skip:function(t){return 0==arguments.length?i:(i=t,this)},sort:function(t){return 0==arguments.length?r:(r=t,this)},and:function(e){return t=extend(t,e),this},or:function(e){return t={$or:[t,e]},this}},this.backend().find(this,o,e)}).static().define("backend",function(t){if(0==arguments.length){var t=this.prototype._backend;if(!t)throw new Error("No backend has been assigned");return t}return null===t?delete this.prototype._backend:this.prototype._backend=t,this}).compile(),MemoryBackend=blueprint.extend("MemoryBackend").init(function(t){this.storage=t||{},this.__id=0}).thenable().define("save",function(t,e,n,i){for(var r=t.id;!r;)this.__id+=1,this.storage.hasOwnProperty(this.__id)||(r=t.id=this.__id);this.storage[r]=JSON.stringify(t),n(t)}).thenable().define("load",function(t,e,n,i){var r=t.id;if(!r)return i(new Error("Unable to load model: missing id"));var o=this.storage[r];return o?(extend(t,JSON.parse(o)),void n(t)):i("Unable to load model: not found")}).thenable().define("remove",function(t,e,n,i){var r=t.id;return r?this.storage.hasOwnProperty(r)?(delete this.storage[r],void n(t)):i("Unable to remove model: not found"):i(new Error("Unable to remove: missing id"))}).thenable().define("find",function(t,e,n,i,r){var o=this.storage.map(function(e){return new t(JSON.parse(e))});i(o)}).compile(),RESTBackend=blueprint.extend("RESTBackend").init(function(t){this.root=t||"/"}).define("request","undefined"!=typeof jQuery?jQuery.ajax:require("request")).thenable().define("save",function(t,e,n,i){var r=t.constructor.collection.toLower(),o="POST";t.id&&(r+="/"+t.id+"/",o=e.patch?"PATCH":"PUT"),this.request({url:this.root+"/"+r,method:o,body:JSON.stringify(mode),success:function(e){extend(t,JSON.parse(e)),n(t)},error:function(t){i(t)}})}).thenable().define("load",function(t,e,n,i){if(!t.id)return i(new Error("Unable to load model: no id"));var r=t.constructor.collection.toLower()+"/"+t.id+"/";this.request({url:this.root+"/"+r,method:"GET",success:function(e){extend(t,JSON.parse(e)),n(t)},error:function(t){i(t)}})}).thenable().define("remove",function(t,e,n,i){if(!t.id)return i(new Error("Unable to load model: no id"));var r=t.constructor.collection.toLower()+"/"+t.id+"/";this.request({url:this.root+"/"+r,method:"DELETE",success:function(e){n(t)},error:function(t){i(t)}})}).thenable().define("find",function(t,e,n,i,r){var o=t.collection.toLower(),c=["query="+JSON.stringify(e.query())];e.limit()&&c.push("limit="+e.limit()),e.skip()&&c.push("skip="+e.skip()),e.sort()&&c.push("sort="+e.sort()),this.request({url:this.root+"/"+o+"?"+c.join("&"),method:"GET",success:function(e){var n=JSON.parse(e).map(function(e){return t(e)});i(n)},error:function(t){r(t)}})}).compile();blueprint=extend(function(t,e){"function"==typeof t&&(e=t,t=void 0);var n=arguments.callee.Object.extend(t);return e&&(extend(n.ctor,e),n.ctor.prototype=Object.create(e.prototype),n.ctor.prototype.constructor=n.ctor,n.init(e)),n},{Object:blueprint,Promise:Promise,Model:Model,MemoryBackend:MemoryBackend,RESTBackend:RESTBackend}),"undefined"==typeof exports&&"undefined"!=typeof window?window.blueprint=blueprint:module.exports=blueprint}();
//# sourceMappingURL=blueprint.min.js.map