"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,a){void 0===a&&(a=i),Object.defineProperty(t,a,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,a){void 0===a&&(a=i),t[a]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Chart=void 0;const d3_shape_1=require("d3-shape"),d3_format_1=require("d3-format"),d3_scale_1=require("d3-scale"),d3_axis_1=require("d3-axis"),d3_zoom_1=require("d3-zoom"),d3_selection_1=require("d3-selection"),d3_interpolate_1=require("d3-interpolate"),events_1=__importDefault(require("events")),annotations_1=__importDefault(require("./helpers/annotations")),tip_1=__importDefault(require("./tip")),helpers_1=__importDefault(require("./helpers")),datum_defaults_1=__importDefault(require("./datum-defaults")),globals_1=__importDefault(require("./globals")),graphTypes=__importStar(require("./graph-types")),$eval=__importStar(require("./helpers/eval"));require("./polyfills");const d3Scale={linear:d3_scale_1.scaleLinear,log:d3_scale_1.scaleLog};class Chart extends events_1.default.EventEmitter{constructor(t){super();const e=Math.random(),i=String.fromCharCode(Math.floor(26*e)+97);this.options=t,this.id=i+e.toString(16).substr(2),this.options.id=this.id,this.markerId=this.id+"-marker",Chart.cache[this.id]=this,this.linkedGraphs=[this],this.meta={},this.setUpEventListeners()}build(){return this.internalVars(),this.drawGraphWrapper(),this}getDraggableNode(){return d3_selection_1.select(this.options.target).select(".zoom-and-drag").node()}getEmitInstance(){let t=this;const e=this.getDraggableNode();return e&&(t=e.instance),t}internalVars(){const t=this.meta.margin={left:40,right:20,top:20,bottom:20};this.options.title&&(this.meta.margin.top=40),this.meta.width=(this.options.width||globals_1.default.DEFAULT_WIDTH)-t.left-t.right,this.meta.height=(this.options.height||globals_1.default.DEFAULT_HEIGHT)-t.top-t.bottom,this.initializeAxes()}initializeAxes(){const t=this,e=d3_format_1.format("~s");d3_format_1.format("~e");function i(t){return Math.abs(t)-Math.floor(Math.abs(t))>0?t.toString():e(t)}this.options.xAxis=this.options.xAxis||{},this.options.xAxis.type=this.options.xAxis.type||"linear",this.options.yAxis=this.options.yAxis||{},this.options.yAxis.type=this.options.yAxis.type||"linear";const a=this.meta.xDomain=function(t){if(t.domain)return t.domain;if("linear"===t.type){const t=12;return[-t/2,t/2]}if("log"===t.type)return[1,10];throw Error("axis type "+t.type+" unsupported")}(this.options.xAxis),s=this.meta.yDomain=function(e){if(e.domain)return e.domain;const i=function(e){const i=e[1]-e[0];return t.meta.height*i/t.meta.width}(a);if("linear"===e.type)return[-i/2,i/2];if("log"===e.type)return[1,10];throw Error("axis type "+e.type+" unsupported")}(this.options.yAxis);this.meta.xScale||(this.meta.xScale=d3Scale[this.options.xAxis.type]()),this.meta.xScale.domain(a).range(this.options.xAxis.invert?[this.meta.width,0]:[0,this.meta.width]),this.meta.yScale||(this.meta.yScale=d3Scale[this.options.yAxis.type]()),this.meta.yScale.domain(s).range(this.options.yAxis.invert?[0,this.meta.height]:[this.meta.height,0]),this.meta.xAxis||(this.meta.xAxis=d3_axis_1.axisBottom(this.meta.xScale)),this.meta.xAxis.tickSize(this.options.grid?-this.meta.height:0).tickFormat(i),this.meta.yAxis||(this.meta.yAxis=d3_axis_1.axisLeft(this.meta.yScale)),this.meta.yAxis.tickSize(this.options.grid?-this.meta.width:0).tickFormat(i),this.line=d3_shape_1.line().x(function(e){return t.meta.xScale(e[0])}).y(function(e){return t.meta.yScale(e[1])})}drawGraphWrapper(){const t=this.root=d3_selection_1.select(this.options.target).selectAll("svg").data([this.options]);this.root.enter=t.enter().append("svg").attr("class","function-plot").attr("font-size",this.getFontSize()),t.merge(this.root.enter).attr("width",this.meta.width+this.meta.margin.left+this.meta.margin.right).attr("height",this.meta.height+this.meta.margin.top+this.meta.margin.bottom),this.buildTitle(),this.buildLegend(),this.buildCanvas(),this.buildClip(),this.buildAxis(),this.buildAxisLabel(),this.draw();const e=this.tip=tip_1.default(Object.assign(this.options.tip||{},{owner:this}));this.canvas.merge(this.canvas.enter).call(e),this.buildZoomHelper(),this.setUpPlugins()}buildTitle(){const t=this.root.merge(this.root.enter).selectAll("text.title").data(function(t){return[t.title].filter(Boolean)});t.enter().append("text").merge(t).attr("class","title").attr("y",this.meta.margin.top/2).attr("x",this.meta.margin.left+this.meta.width/2).attr("font-size",25).attr("text-anchor","middle").attr("alignment-baseline","middle").text(this.options.title),t.exit().remove()}buildLegend(){this.root.enter.append("text").attr("class","top-right-legend").attr("text-anchor","end"),this.root.merge(this.root.enter).select(".top-right-legend").attr("y",this.meta.margin.top/2).attr("x",this.meta.width+this.meta.margin.left)}buildCanvas(){const t=this.canvas=this.root.merge(this.root.enter).selectAll(".canvas").data(function(t){return[t]});this.canvas.enter=t.enter().append("g").attr("class","canvas")}buildClip(){const t=this.id,e=this.canvas.enter.append("defs");e.append("clipPath").attr("id","function-plot-clip-"+t).append("rect").attr("class","clip static-clip"),this.canvas.merge(this.canvas.enter).selectAll(".clip").attr("width",this.meta.width).attr("height",this.meta.height),e.append("clipPath").append("marker").attr("id",this.markerId).attr("viewBox","0 -5 10 10").attr("refX",10).attr("markerWidth",5).attr("markerHeight",5).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5L0,0").attr("stroke-width","0px").attr("fill-opacity",1).attr("fill","#777")}buildAxis(){const t=this.canvas.enter;t.append("g").attr("class","x axis"),t.append("g").attr("class","y axis"),this.canvas.merge(this.canvas.enter).select(".x.axis").attr("transform","translate(0,"+this.meta.height+")").call(this.meta.xAxis),this.canvas.merge(this.canvas.enter).select(".y.axis").call(this.meta.yAxis)}buildAxisLabel(){const t=this.canvas,e=t.merge(t.enter).selectAll("text.x.axis-label").data(function(t){return[t.xAxis.label].filter(Boolean)}),i=e.enter().append("text").attr("class","x axis-label").attr("text-anchor","end");e.merge(i).attr("x",this.meta.width).attr("y",this.meta.height-6).text(function(t){return t}),e.exit().remove();const a=t.merge(t.enter).selectAll("text.y.axis-label").data(function(t){return[t.yAxis.label].filter(Boolean)}),s=a.enter().append("text").attr("class","y axis-label").attr("y",6).attr("dy",".75em").attr("text-anchor","end").attr("transform","rotate(-90)");a.merge(s).text(function(t){return t}),a.exit().remove()}buildContent(){const t=this,e=this.canvas;e.merge(e.enter).attr("transform","translate("+this.meta.margin.left+","+this.meta.margin.top+")");const i=this.content=e.merge(e.enter).selectAll(":scope > g.content").data(function(t){return[t]}),a=i.enter().append("g").attr("clip-path","url(#function-plot-clip-"+this.id+")").attr("class","content");if("linear"===this.options.xAxis.type){const t=i.merge(a).selectAll(":scope > path.y.origin").data([[[0,this.meta.yScale.domain()[0]],[0,this.meta.yScale.domain()[1]]]]),e=t.enter().append("path").attr("class","y origin").attr("stroke","black").attr("opacity",.2);t.merge(e).attr("d",this.line)}if("linear"===this.options.yAxis.type){const t=i.merge(a).selectAll(":scope > path.x.origin").data([[[this.meta.xScale.domain()[0],0],[this.meta.xScale.domain()[1],0]]]),e=t.enter().append("path").attr("class","x origin").attr("stroke","black").attr("opacity",.2);t.merge(e).attr("d",this.line)}i.merge(a).call(annotations_1.default({owner:t}));const s=i.merge(a).selectAll(":scope > g.graph").data(t=>t.data.map(datum_defaults_1.default)),n=s.enter().append("g").attr("class","graph");s.merge(n).each(function(e,i){e.index=i;const a=d3_selection_1.select(this);a.call(graphTypes[e.graphType](t)),a.call(helpers_1.default(t))})}buildZoomHelper(){const t=this;this.meta.zoomBehavior||(this.meta.zoomBehavior=d3_zoom_1.zoom().on("zoom",function(e){t.getEmitInstance().emit("all:zoom",e)}),t.meta.zoomBehavior.xScale=t.meta.xScale.copy(),t.meta.zoomBehavior.yScale=t.meta.yScale.copy()),t.meta.zoomBehavior.xScale.range(t.meta.xScale.range()),t.meta.zoomBehavior.yScale.range(t.meta.yScale.range()),this.canvas.enter.append("rect").call(this.meta.zoomBehavior).attr("class","zoom-and-drag").style("fill","none").style("pointer-events","all").on("mouseover",function(e){t.getEmitInstance().emit("all:mouseover",e)}).on("mouseout",function(e){t.getEmitInstance().emit("all:mouseout",e)}).on("mousemove",function(e){t.getEmitInstance().emit("all:mousemove",e)}),this.draggable=this.canvas.merge(this.canvas.enter).select(".zoom-and-drag").call(e=>{e.node()&&(e.node().instance=t)}).attr("width",this.meta.width).attr("height",this.meta.height)}setUpPlugins(){const t=this.options.plugins||[],e=this;t.forEach(function(t){t(e)})}addLink(){for(let t=0;t<arguments.length;t+=1)this.linkedGraphs.push(arguments[t])}updateAxes(){const t=this.canvas.merge(this.canvas.enter);t.select(".x.axis").call(this.meta.xAxis),t.select(".y.axis").call(this.meta.yAxis),t.selectAll(".axis path, .axis line").attr("fill","none").attr("stroke","black").attr("shape-rendering","crispedges").attr("opacity",.1)}syncOptions(){this.options.xAxis.domain=this.meta.xScale.domain(),this.options.yAxis.domain=this.meta.yScale.domain()}getFontSize(){return Math.max(Math.max(this.meta.width,this.meta.height)/50,8)}draw(){this.emit("before:draw"),this.syncOptions(),this.updateAxes(),this.buildContent(),this.emit("after:draw")}setUpEventListeners(){const t=this,e=this.getEmitInstance();e&&e.removeAllListeners();const i={mousemove:function(e){t.tip.move(e)},mouseover:function(){t.tip.show()},mouseout:function(){t.tip.hide()},zoom:function({transform:e}){if(t.options.disableZoom)return;const i=e.rescaleX(t.meta.zoomBehavior.xScale).interpolate(d3_interpolate_1.interpolateRound),a=e.rescaleY(t.meta.zoomBehavior.yScale).interpolate(d3_interpolate_1.interpolateRound);t.meta.xScale.domain(i.domain()).range(i.range()),t.meta.yScale.domain(a.domain()).range(a.range())},"tip:update":function({x:e,y:i,index:a}){const s=t.root.merge(t.root.enter).datum().data[a],n=s.title||"",o=s.renderer||function(t,e){return t.toFixed(3)+", "+e.toFixed(3)},r=[];n&&r.push(n),r.push(o(e,i)),t.root.select(".top-right-legend").attr("fill",globals_1.default.COLORS[a]).text(r.join(" "))}},a={mousemove:function(e){const i=d3_selection_1.pointer(e,t.draggable.node()),a={x:t.meta.xScale.invert(i[0]),y:t.meta.yScale.invert(i[1])};t.linkedGraphs.forEach(function(t){t.emit("before:mousemove",a),t.emit("mousemove",a)})},zoom:function(e){t.linkedGraphs.forEach(function(i){i.draggable.node().__zoom=t.draggable.node().__zoom,i.emit("zoom",e),i.draw()}),t.emit("all:mousemove",e)}};Object.keys(i).forEach(function(e){!a[e]&&t.on("all:"+e,function(){const i=Array.prototype.slice.call(arguments);t.linkedGraphs.forEach(function(t){const a=i.slice();a.unshift(e),t.emit.apply(t,a)})}),t.on(e,i[e])}),Object.keys(a).forEach(function(e){t.on("all:"+e,a[e])})}}function functionPlot(t={target:null}){t.data=t.data||[];let e=Chart.cache[t.id];return e||(e=new Chart(t)),e.build()}exports.Chart=Chart,Chart.cache={},functionPlot.globals=globals_1.default,functionPlot.$eval=$eval,functionPlot.graphTypes=graphTypes,exports.default=functionPlot;