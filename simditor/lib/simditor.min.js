!function(n,s){"function"==typeof define&&define.amd?define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader","dompurify"],function(t,e,i,o,r){return n.Simditor=s(t,e,i,o,r)}):"object"==typeof exports?module.exports=s(require("jquery"),require("simple-module"),require("simple-hotkeys"),require("simple-uploader"),require("dompurify")):n.Simditor=s(jQuery,SimpleModule,simple.hotkeys,simple.uploader,window.DOMPurify)}(this,function(N,t,o,r,n){function e(t,e){for(var i in e)Y.call(e,i)&&(t[i]=e[i]);function o(){this.constructor=t}return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t}var i,s,a,l,d,h,p,u,c,f,g,m,v,y,_,b,w,x,C,T,k,S,A,E,B,R,I,M,O,P,z,L,W,D,H,q,U,j,V,F,K,X,J,Q,$,G,Y={}.hasOwnProperty,Z=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1},tt=[].slice;function et(){return et.__super__.constructor.apply(this,arguments)}function it(){return it.__super__.constructor.apply(this,arguments)}function ot(){return ot.__super__.constructor.apply(this,arguments)}function rt(){return rt.__super__.constructor.apply(this,arguments)}function nt(){return nt.__super__.constructor.apply(this,arguments)}function st(){return st.__super__.constructor.apply(this,arguments)}function at(){return at.__super__.constructor.apply(this,arguments)}function lt(){return lt.__super__.constructor.apply(this,arguments)}function dt(){return dt.__super__.constructor.apply(this,arguments)}function ht(){return ht.__super__.constructor.apply(this,arguments)}function pt(t){this.editor=t.editor,this.title=this._t(this.name),pt.__super__.constructor.call(this,t)}function ut(t){this.button=t.button,this.editor=t.button.editor,ut.__super__.constructor.call(this,t)}function ct(){return ct.__super__.constructor.apply(this,arguments)}function ft(){return ft.__super__.constructor.apply(this,arguments)}function gt(){return gt.__super__.constructor.apply(this,arguments)}function mt(){return mt.__super__.constructor.apply(this,arguments)}function vt(){return vt.__super__.constructor.apply(this,arguments)}function yt(){return yt.__super__.constructor.apply(this,arguments)}function _t(){return _t.__super__.constructor.apply(this,arguments)}function bt(){return bt.__super__.constructor.apply(this,arguments)}function wt(){return wt.__super__.constructor.apply(this,arguments)}function xt(){return xt.__super__.constructor.apply(this,arguments)}function Ct(){return Ct.__super__.constructor.apply(this,arguments)}function Tt(){return Tt.__super__.constructor.apply(this,arguments)}function kt(){return kt.__super__.constructor.apply(this,arguments)}function Nt(){return Nt.__super__.constructor.apply(this,arguments)}function St(){return St.__super__.constructor.apply(this,arguments)}function At(){return At.__super__.constructor.apply(this,arguments)}function Et(){return Et.__super__.constructor.apply(this,arguments)}function Bt(){return Bt.__super__.constructor.apply(this,arguments)}function Rt(){return Rt.__super__.constructor.apply(this,arguments)}function It(){return It.__super__.constructor.apply(this,arguments)}function Mt(){return Mt.__super__.constructor.apply(this,arguments)}function Ot(){return Ot.__super__.constructor.apply(this,arguments)}return e(et,t),et.pluginName="Selection",et.prototype._range=null,et.prototype._startNodes=null,et.prototype._endNodes=null,et.prototype._containerNode=null,et.prototype._nodes=null,et.prototype._blockNodes=null,et.prototype._rootNodes=null,et.prototype._init=function(){var e,i,o;return this.editor=this._module,this._selection=document.getSelection(),this.editor.on("selectionchanged",(e=this,function(t){return e.reset(),e._range=e._selection.getRangeAt(0)})),this.editor.on("blur",(i=this,function(t){return i.reset()})),this.editor.on("focus",(o=this,function(t){return o.reset(),o._range=o._selection.getRangeAt(0)}))},et.prototype.reset=function(){return this._range=null,this._startNodes=null,this._endNodes=null,this._containerNode=null,this._nodes=null,this._blockNodes=null,this._rootNodes=null},et.prototype.clear=function(){try{this._selection.removeAllRanges()}catch(t){}return this.reset()},et.prototype.range=function(t){var e;return t?(this.clear(),this._selection.addRange(t),this._range=t,e=this.editor.util.browser.firefox||this.editor.util.browser.msie,!this.editor.inputManager.focused&&e&&this.editor.body.focus()):!this._range&&this.editor.inputManager.focused&&this._selection.rangeCount&&(this._range=this._selection.getRangeAt(0)),this._range},et.prototype.startNodes=function(){var e;return this._range&&(this._startNodes||(this._startNodes=(e=this,function(){var t;return(t=N(e._range.startContainer).parentsUntil(e.editor.body).get()).unshift(e._range.startContainer),N(t)}()))),this._startNodes},et.prototype.endNodes=function(){var t;return this._range&&(this._endNodes||(this._endNodes=this._range.collapsed?this.startNodes():((t=N(this._range.endContainer).parentsUntil(this.editor.body).get()).unshift(this._range.endContainer),N(t)))),this._endNodes},et.prototype.containerNode=function(){return this._range&&(this._containerNode||(this._containerNode=N(this._range.commonAncestorContainer))),this._containerNode},et.prototype.nodes=function(){var h;return this._range&&(this._nodes||(this._nodes=(h=this,function(){var d;return d=[],h.startNodes().first().is(h.endNodes().first())?d=h.startNodes().get():(h.startNodes().each(function(t,e){var i,o,r,n,s,a,l;return o=N(e),-1<h.endNodes().index(o)?d.push(e):o.parent().is(h.editor.body)||-1<(a=h.endNodes().index(o.parent()))?(i=a&&-1<a?h.endNodes().eq(a-1):h.endNodes().last(),l=(r=o.parent().contents()).index(o),n=r.index(i),N.merge(d,r.slice(l,n).get())):(s=(r=o.parent().contents()).index(o),N.merge(d,r.slice(s).get()))}),h.endNodes().each(function(t,e){var i,o,r;return(i=N(e)).parent().is(h.editor.body)||-1<h.startNodes().index(i.parent())?(d.push(e),!1):(r=(o=i.parent().contents()).index(i),N.merge(d,o.slice(0,r+1)))})),N(N.unique(d))}()))),this._nodes},et.prototype.blockNodes=function(){var i;if(this._range)return this._blockNodes||(this._blockNodes=(i=this).nodes().filter(function(t,e){return i.editor.util.isBlockNode(e)})),this._blockNodes},et.prototype.rootNodes=function(){var o;if(this._range)return this._rootNodes||(this._rootNodes=(o=this).nodes().filter(function(t,e){var i;return(i=N(e).parent()).is(o.editor.body)||i.is("blockquote")})),this._rootNodes},et.prototype.rangeAtEndOf=function(t,e){var i,o,r,n,s,a;if(null==e&&(e=this.range()),e&&e.collapsed)return t=N(t)[0],r=e.endContainer,n=this.editor.util.getNodeLength(r),o=e.endOffset===n-1,s=N(r).contents().last().is("br"),i=e.endOffset===n,!!(o&&s||i)&&(t===r||!!N.contains(t,r)&&(a=!0,N(r).parentsUntil(t).addBack().each(function(t,e){var i,o,r;if(r=(i=N(e).parent().contents().filter(function(){return!(this!==e&&3===this.nodeType&&!this.nodeValue)}).last()).get(0)===e,o=i.is("br")&&i.prev().get(0)===e,!r&&!o)return a=!1}),a))},et.prototype.rangeAtStartOf=function(t,e){var i,o;if(null==e&&(e=this.range()),e&&e.collapsed)return t=N(t)[0],o=e.startContainer,0===e.startOffset&&(t===o||!!N.contains(t,o)&&(i=!0,N(o).parentsUntil(t).addBack().each(function(t,e){if(N(e).parent().contents().filter(function(){return!(this!==e&&3===this.nodeType&&!this.nodeValue)}).first().get(0)!==e)return i=!1}),i))},et.prototype.insertNode=function(t,e){if(null==e&&(e=this.range()),e)return t=N(t)[0],e.insertNode(t),this.setRangeAfter(t,e)},et.prototype.setRangeAfter=function(t,e){if(null==e&&(e=this.range()),null!=e)return t=N(t)[0],e.setEndAfter(t),e.collapse(!1),this.range(e)},et.prototype.setRangeBefore=function(t,e){if(null==e&&(e=this.range()),null!=e)return t=N(t)[0],e.setEndBefore(t),e.collapse(!1),this.range(e)},et.prototype.setRangeAtStartOf=function(t,e){return null==e&&(e=this.range()),t=N(t).get(0),e.setEnd(t,0),e.collapse(!1),this.range(e)},et.prototype.setRangeAtEndOf=function(t,e){var i,o,r,n,s,a,l;if(null==e&&(e=this.range()),t=(o=N(t))[0])return o.is("pre")?0<(r=o.contents()).length?(a=(n=r.last()).text(),s=this.editor.util.getNodeLength(n[0]),"\n"===a.charAt(a.length-1)?e.setEnd(n[0],s-1):e.setEnd(n[0],s)):e.setEnd(t,0):(l=this.editor.util.getNodeLength(t),3!==t.nodeType&&0<l&&((i=N(t).contents().last()).is("br")?l-=1:3!==i[0].nodeType&&this.editor.util.isEmptyNode(i)&&(i.append(this.editor.util.phBr),t=i[0],l=0)),e.setEnd(t,l)),e.collapse(!1),this.range(e)},et.prototype.deleteRangeContents=function(t){var e,i,o,r;return null==t&&(t=this.range()),r=t.cloneRange(),o=t.cloneRange(),r.collapse(!0),o.collapse(!1),i=this.rangeAtStartOf(this.editor.body,r),e=this.rangeAtEndOf(this.editor.body,o),!t.collapsed&&i&&e?(this.editor.body.empty(),t.setStart(this.editor.body[0],0),t.collapse(!0),this.range(t)):t.deleteContents(),t},et.prototype.breakBlockEl=function(t,e){var i;return null==e&&(e=this.range()),i=N(t),e.collapsed?(e.setStartBefore(i.get(0)),e.collapsed?i:i.before(e.extractContents())):i},et.prototype.save=function(t){var e,i,o;if(null==t&&(t=this.range()),!this._selectionSaved)return(i=t.cloneRange()).collapse(!1),o=N("<span/>").addClass("simditor-caret-start"),e=N("<span/>").addClass("simditor-caret-end"),i.insertNode(e[0]),t.insertNode(o[0]),this.clear(),this._selectionSaved=!0},et.prototype.restore=function(){var t,e,i,o,r,n,s;return!!this._selectionSaved&&(r=this.editor.body.find(".simditor-caret-start"),t=this.editor.body.find(".simditor-caret-end"),r.length&&t.length?(s=(n=r.parent()).contents().index(r),i=(e=t.parent()).contents().index(t),n[0]===e[0]&&(i-=1),(o=document.createRange()).setStart(n.get(0),s),o.setEnd(e.get(0),i),r.remove(),t.remove(),this.range(o)):(r.remove(),t.remove()),this._selectionSaved=!1,o)},B=et,e(it,t),it.pluginName="Formatter",it.prototype.opts={allowedTags:[],allowedAttributes:{},allowedStyles:{}},it.prototype._init=function(){return this.editor=this._module,this._allowedTags=N.merge(["br","span","a","img","b","strong","i","strike","u","font","p","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","hr"],this.opts.allowedTags),this._allowedAttributes=N.extend({img:["src","alt","width","height","data-non-image"],a:["href","target"],font:["color"],code:["class"]},this.opts.allowedAttributes),this._allowedStyles=N.extend({span:["color","font-size"],b:["color","font-size"],i:["color","font-size"],strong:["color","font-size"],strike:["color","font-size"],u:["color","font-size"],p:["margin-left","text-align"],h1:["margin-left","text-align"],h2:["margin-left","text-align"],h3:["margin-left","text-align"],h4:["margin-left","text-align"]},this.opts.allowedStyles),this.editor.body.on("click","a",function(t){return!1})},it.prototype.decorate=function(t){return null==t&&(t=this.editor.body),this.editor.trigger("decorate",[t]),t},it.prototype.undecorate=function(t){return null==t&&(t=this.editor.body.clone()),this.editor.trigger("undecorate",[t]),t},it.prototype.autolink=function(r){var t,e,n,i,o,s,a,l,d,h,p,u,c;for(null==r&&(r=this.editor.body),a=[],(n=function(t){return t.contents().each(function(t,e){var i,o;if(!(i=N(e)).is("a")&&!i.closest("a, pre",r).length)return!i.is("iframe")&&i.contents().length?n(i):(o=i.text())&&/https?:\/\/|www\./gi.test(o)?a.push(i):void 0})})(r),d=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,i=0,s=a.length;i<s;i++){for(u=(e=a[i]).text(),h=[],l=null,o=0;null!==(l=d.exec(u));)p=u.substring(o,l.index),h.push(document.createTextNode(p)),o=d.lastIndex,c=/^(http(s)?:\/\/|\/)/.test(l[0])?l[0]:"http://"+l[0],t=N('<a href="'+c+'" rel="nofollow"></a>').text(l[0]),h.push(t[0]);h.push(document.createTextNode(u.substring(o))),e.replaceWith(N(h))}return r},it.prototype.format=function(t){var e,i,o,r,n,s,a,l,d,h;if(null==t&&(t=this.editor.body),t.is(":empty"))return t.append("<p>"+this.editor.util.phBr+"</p>"),t;for(o=0,n=(d=t.contents()).length;o<n;o++)a=d[o],this.cleanNode(a,!0);for(r=0,s=(h=t.contents()).length;r<s;r++)l=h[r],(e=N(l)).is("br")?(null!=i&&(i=null),e.remove()):this.editor.util.isBlockNode(l)?e.is("li")?i&&i.is("ul, ol")?i.append(l):(i=N("<ul/>").insertBefore(l)).append(l):i=null:(i&&!i.is("ul, ol")||(i=N("<p/>").insertBefore(l)),i.append(l),this.editor.util.isEmptyNode(i)&&i.append(this.editor.util.phBr));return t},it.prototype.cleanNode=function(t,e){var i,o,r,n,s,a,l,d,h,p,u,c,f,g,m,v,y,_;if(0<(r=N(t)).length){if(3!==r[0].nodeType){if(d=r.is("iframe")?null:r.contents(),h=this.editor.util.isDecoratedNode(r),r.is(this._allowedTags.join(","))||h){if(r.is("a")&&0<(o=r.find("img")).length&&(r.replaceWith(o),r=o,d=null),r.is("td")&&0<(i=r.find(this.editor.util.blockNodes.join(","))).length&&(i.each(function(t,e){return N(e).contents().unwrap()}),d=r.contents()),r.is("img")&&r.hasClass("uploading")&&r.remove(),!h){for(a=this._allowedAttributes[r[0].tagName.toLowerCase()],p=0,c=(m=N.makeArray(r[0].attributes)).length;p<c;p++)"style"!==(l=m[p]).name&&(null!=a&&(v=l.name,0<=Z.call(a,v))||r.removeAttr(l.name));this._cleanNodeStyles(r),r.is("span")&&(0===r[0].attributes.length&&r.contents().first().unwrap(),2===r[0].style.length&&"rgb(51, 51, 51)"===r[0].style.color&&"16px"===r[0].style.fontSize&&r.contents().unwrap())}}else 1!==r[0].nodeType||r.is(":empty")?(r.remove(),d=null):r.is("div, article, dl, header, footer, tr")?(r.append("<br/>"),d.first().unwrap()):r.is("table")?(n=N("<p/>"),r.find("tr").each(function(t,e){return n.append(N(e).text()+"<br/>")}),r.replaceWith(n),d=null):r.is("thead, tfoot")?(r.remove(),d=null):r.is("th")?(s=N("<td/>").append(r.contents()),r.replaceWith(s)):d.first().unwrap();if(e&&null!=d&&!r.is("pre"))for(u=0,f=d.length;u<f;u++)g=d[u],this.cleanNode(g,!0);return null}(y=r.text().replace(/(\r\n|\n|\r)/gm,""))?(_=document.createTextNode(y),r.replaceWith(_)):r.remove()}},it.prototype._cleanNodeStyles=function(t){var e,i,o,r,n,s,a,l,d;if(l=t.attr("style")){if(t.removeAttr("style"),!((e=this._allowedStyles[t[0].tagName.toLowerCase()])&&0<e.length))return t;for(d={},i=0,o=(n=l.split(";")).length;i<o;i++)a=n[i],2===(r=(a=N.trim(a)).split(":")).length&&("font-size"===r[0]&&0<r[1].indexOf("px")&&parseInt(r[1],10)<12||(s=r[0],0<=Z.call(e,s)&&(d[N.trim(r[0])]=N.trim(r[1]))));return 0<Object.keys(d).length&&t.css(d),t}},it.prototype.clearHtml=function(t,r){var e,n,s,a;return null==r&&(r=!0),e=N("<div/>").append(t),n=e.contents(),s="",n.each((a=this,function(t,e){var i,o;return 3===e.nodeType?s+=e.nodeValue:1===e.nodeType&&((o=(i=N(e)).is("iframe")?null:i.contents())&&0<o.length&&(s+=a.clearHtml(o)),r&&t<n.length-1&&i.is("br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header"))?s+="\n":void 0})),s},it.prototype.beautify=function(t){var o;return o=function(t){return!!(t.is("p")&&!t.text()&&t.children(":not(br)").length<1)},t.each(function(t,e){var i;return((i=N(e)).is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')||o(i))&&i.remove(),i.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()})},f=it,e(ot,t),ot.pluginName="InputManager",ot.prototype._modifierKeys=[16,17,18,91,93,224],ot.prototype._arrowKeys=[37,38,39,40],ot.prototype._init=function(){var t,e,i,o,r,n,s,a,l,d;return this.editor=this._module,this.throttledValueChanged=this.editor.util.throttle((i=this,function(t){return setTimeout(function(){return i.editor.trigger("valuechanged",t)},10)}),300),this.throttledSelectionChanged=this.editor.util.throttle((o=this,function(){return o.editor.trigger("selectionchanged")}),50),N(document).on("selectionchange.simditor"+this.editor.id,(r=this,function(t){var e;if(r.focused&&!r.editor.clipboard.pasting)return(e=function(){return r._selectionTimer&&(clearTimeout(r._selectionTimer),r._selectionTimer=null),0<r.editor.selection._selection.rangeCount?r.throttledSelectionChanged():r._selectionTimer=setTimeout(function(){if(r._selectionTimer=null,r.focused)return e()},10)})()})),this.editor.on("valuechanged",(n=this,function(){var t;if(n.lastCaretPosition=null,t=n.editor.body.children().filter(function(t,e){return n.editor.util.isBlockNode(e)}),n.focused&&0===t.length&&(n.editor.selection.save(),n.editor.formatter.format(),n.editor.selection.restore()),n.editor.body.find("hr, pre, .simditor-table").each(function(t,e){var i,o;if(((i=N(e)).parent().is("blockquote")||i.parent()[0]===n.editor.body[0])&&(o=!1,0===i.next().length&&(N("<p/>").append(n.editor.util.phBr).insertAfter(i),o=!0),0===i.prev().length&&(N("<p/>").append(n.editor.util.phBr).insertBefore(i),o=!0),o))return n.throttledValueChanged()}),n.editor.body.find("pre:empty").append(n.editor.util.phBr),!n.editor.util.support.onselectionchange&&n.focused)return n.throttledSelectionChanged()})),this.editor.body.on("keydown",N.proxy(this._onKeyDown,this)).on("keypress",N.proxy(this._onKeyPress,this)).on("keyup",N.proxy(this._onKeyUp,this)).on("mouseup",N.proxy(this._onMouseUp,this)).on("focus",N.proxy(this._onFocus,this)).on("blur",N.proxy(this._onBlur,this)).on("drop",N.proxy(this._onDrop,this)).on("input",N.proxy(this._onInput,this)),this.editor.util.browser.firefox&&(this.editor.hotkeys.add("cmd+left",(l=this,function(t){return t.preventDefault(),l.editor.selection._selection.modify("move","backward","lineboundary"),!1})),this.editor.hotkeys.add("cmd+right",(a=this,function(t){return t.preventDefault(),a.editor.selection._selection.modify("move","forward","lineboundary"),!1})),t=this.editor.util.os.mac?"cmd+a":"ctrl+a",this.editor.hotkeys.add(t,(s=this,function(t){var e,i,o,r;if(0<(e=s.editor.body.children()).length)return i=e.first().get(0),o=e.last().get(0),(r=document.createRange()).setStart(i,0),r.setEnd(o,s.editor.util.getNodeLength(o)),s.editor.selection.range(r),!1}))),e=this.editor.util.os.mac?"cmd+enter":"ctrl+enter",this.editor.hotkeys.add(e,(d=this,function(t){return d.editor.sync(),d.editor.el.closest("form").find("button:submit").click(),!1}))},ot.prototype._onFocus=function(t){var i;if(!this.editor.clipboard.pasting)return this.editor.el.addClass("focus").removeClass("error"),this.focused=!0,setTimeout((i=this,function(){var t,e;if((e=i.editor.selection._selection.getRangeAt(0)).startContainer===i.editor.body[0]&&(i.lastCaretPosition?i.editor.undoManager.caretPosition(i.lastCaretPosition):(t=i.editor.body.children().first(),e=document.createRange(),i.editor.selection.setRangeAtStartOf(t,e))),i.lastCaretPosition=null,i.editor.triggerHandler("focus"),!i.editor.util.support.onselectionchange)return i.throttledSelectionChanged()}),0)},ot.prototype._onBlur=function(t){var e;if(!this.editor.clipboard.pasting)return this.editor.el.removeClass("focus"),this.editor.sync(),this.focused=!1,this.lastCaretPosition=null!=(e=this.editor.undoManager.currentState())?e.caret:void 0,this.editor.triggerHandler("blur")},ot.prototype._onMouseUp=function(t){if(!this.editor.util.support.onselectionchange)return this.throttledSelectionChanged()},ot.prototype._onKeyDown=function(t){var e,i;if(!1===this.editor.triggerHandler(t))return!1;if(!this.editor.hotkeys.respondTo(t)){if(this.editor.keystroke.respondTo(t))return this.throttledValueChanged(),!1;if(e=t.which,!(0<=Z.call(this._modifierKeys,e)||(i=t.which,0<=Z.call(this._arrowKeys,i))||this.editor.util.metaKey(t)&&86===t.which))return this.editor.util.support.oninput||this.throttledValueChanged(["typing"]),null}},ot.prototype._onKeyPress=function(t){if(!1===this.editor.triggerHandler(t))return!1},ot.prototype._onKeyUp=function(t){var e,i;if(!1===this.editor.triggerHandler(t))return!1;!this.editor.util.support.onselectionchange&&(i=t.which,0<=Z.call(this._arrowKeys,i))?this.throttledValueChanged():8!==t.which&&46!==t.which||!this.editor.util.isEmptyNode(this.editor.body)||(this.editor.body.empty(),e=N("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body),this.editor.selection.setRangeAtStartOf(e))},ot.prototype._onDrop=function(t){return!1!==this.editor.triggerHandler(t)&&this.throttledValueChanged()},ot.prototype._onInput=function(t){return this.throttledValueChanged(["oninput"])},b=ot,e(rt,t),rt.pluginName="Keystroke",rt.prototype._init=function(){return this.editor=this._module,this._keystrokeHandlers={},this._initKeystrokeHandlers()},rt.prototype.add=function(t,e,i){return t=t.toLowerCase(),t=this.editor.hotkeys.constructor.aliases[t]||t,this._keystrokeHandlers[t]||(this._keystrokeHandlers[t]={}),this._keystrokeHandlers[t][e]=i},rt.prototype.respondTo=function(r){var t,n,e,s,a;if(n=null!=(e=this.editor.hotkeys.constructor.keyNameMap[r.which])?e.toLowerCase():void 0)return!!(n in this._keystrokeHandlers&&((s="function"==typeof(t=this._keystrokeHandlers[n])["*"]?t["*"](r):void 0)||this.editor.selection.startNodes().each((a=this,function(t,e){var i,o;if(e.nodeType===Node.ELEMENT_NODE)return i=null!=(o=a._keystrokeHandlers[n])?o[e.tagName.toLowerCase()]:void 0,!0!==(s="function"==typeof i?i(r,N(e)):void 0)&&!1!==s&&void 0})),s))||void 0},rt.prototype._initKeystrokeHandlers=function(){var t,o,r,n,s,a,l,d,p,h,u;return this.editor.util.browser.safari&&this.add("enter","*",(o=this,function(t){var e,i;if(t.shiftKey&&!(e=o.editor.selection.blockNodes().last()).is("pre"))return i=N("<br/>"),o.editor.selection.rangeAtEndOf(e)?(o.editor.selection.insertNode(i),o.editor.selection.insertNode(N("<br/>")),o.editor.selection.setRangeBefore(i)):o.editor.selection.insertNode(i),!0})),(this.editor.util.browser.webkit||this.editor.util.browser.msie)&&(t=function(t,e){var i;if(r.editor.selection.rangeAtEndOf(e))return i=N("<p/>").append(r.editor.util.phBr).insertAfter(e),r.editor.selection.setRangeAtStartOf(i),!0},(r=this).add("enter","h1",t),this.add("enter","h2",t),this.add("enter","h3",t),this.add("enter","h4",t),this.add("enter","h5",t),this.add("enter","h6",t)),this.add("backspace","*",(n=this,function(t){var e,i,o;return(i=(o=n.editor.selection.rootNodes().first()).prev()).is("hr")&&n.editor.selection.rangeAtStartOf(o)?(n.editor.selection.save(),i.remove(),n.editor.selection.restore(),!0):((e=n.editor.selection.blockNodes().last()).is(".simditor-resize-handle")&&o.is(".simditor-table")&&(t.preventDefault(),o.remove(),n.editor.selection.setRangeAtEndOf(i)),i.is(".simditor-table")&&!e.is("table")&&n.editor.util.isEmptyNode(e)&&(t.preventDefault(),e.remove(),n.editor.selection.setRangeAtEndOf(i)),n.editor.util.browser.webkit&&n.editor.selection.rangeAtStartOf(e)?(n.editor.selection.save(),n.editor.formatter.cleanNode(e,!0),n.editor.selection.restore(),null):void 0)})),this.add("enter","div",(s=this,function(t,e){var i;if(e.is(".simditor-table")&&s.editor.selection.blockNodes().last().is(".simditor-resize-handle"))return t.preventDefault(),i=N("<p/>").append(s.editor.util.phBr).insertAfter(e),s.editor.selection.setRangeAtStartOf(i)})),this.add("enter","li",(a=this,function(t,e){var i,o,r,n;if((i=e.clone()).find("ul, ol").remove(),a.editor.util.isEmptyNode(i)&&e.is(a.editor.selection.blockNodes().last())){if(o=e.parent(),0<e.next("li").length){if(!a.editor.util.isEmptyNode(e))return;0<o.parent("li").length?(r=N("<li/>").append(a.editor.util.phBr).insertAfter(o.parent("li")),n=N("<"+o[0].tagName+"/>").append(e.nextAll("li")),r.append(n)):(r=N("<p/>").append(a.editor.util.phBr).insertAfter(o),n=N("<"+o[0].tagName+"/>").append(e.nextAll("li")),r.after(n))}else 0<o.parent("li").length?(r=N("<li/>").insertAfter(o.parent("li")),0<e.contents().length?r.append(e.contents()):r.append(a.editor.util.phBr)):(r=N("<p/>").append(a.editor.util.phBr).insertAfter(o),0<e.children("ul, ol").length&&r.after(e.children("ul, ol")));return e.prev("li").length?e.remove():e.prev("ul").length||e.prev("ol").length?e.remove():o.remove(),a.editor.selection.setRangeAtStartOf(r),!0}})),this.add("enter","pre",(l=this,function(t,e){var i,o,r;return t.preventDefault(),t.shiftKey?(i=N("<p/>").append(l.editor.util.phBr).insertAfter(e),l.editor.selection.setRangeAtStartOf(i)):(o=null,(r=l.editor.selection.range()).deleteContents(),o=!l.editor.util.browser.msie&&l.editor.selection.rangeAtEndOf(e)?document.createTextNode("\n\n"):document.createTextNode("\n"),r.insertNode(o),r.setEnd(o,1),r.collapse(!1),l.editor.selection.range(r)),!0})),this.add("enter","blockquote",(d=this,function(t,e){var i,o;if((i=d.editor.selection.blockNodes().last()).is("p")&&!i.next().length&&d.editor.util.isEmptyNode(i))return e.after(i),o=document.createRange(),d.editor.selection.setRangeAtStartOf(i,o),!0})),this.add("backspace","li",(p=this,function(t,e){var i,o,r,n,s,a,l,d,h;return o=e.children("ul, ol"),s=e.prev("li"),0<o.length&&0<s.length&&(h="",a=null,e.contents().each(function(t,e){return(1!==e.nodeType||!/UL|OL/.test(e.nodeName))&&(1===e.nodeType&&/BR/.test(e.nodeName)?void 0:(3===e.nodeType&&e.nodeValue?h+=e.nodeValue:1===e.nodeType&&(h+=N(e).text()),a=N(e)))}),l=p.editor.util.browser.firefox&&!a.next("br").length,a&&1===h.length&&l?(i=N(p.editor.util.phBr).insertAfter(a),a.remove(),p.editor.selection.setRangeBefore(i),!0):!(0<h.length||(d=document.createRange(),0<(n=s.children("ul, ol")).length?(r=N("<li/>").append(p.editor.util.phBr).appendTo(n),n.append(o.children("li")),e.remove(),p.editor.selection.setRangeAtEndOf(r,d)):(p.editor.selection.setRangeAtEndOf(s,d),s.append(o),e.remove(),p.editor.selection.range(d)),0)))})),this.add("backspace","pre",(h=this,function(t,e){var i,o,r;if(h.editor.selection.rangeAtStartOf(e))return o=e.html().replace("\n","<br/>")||h.editor.util.phBr,i=N("<p/>").append(o).insertAfter(e),e.remove(),r=document.createRange(),h.editor.selection.setRangeAtStartOf(i,r),!0})),this.add("backspace","blockquote",(u=this,function(t,e){var i,o;if(u.editor.selection.rangeAtStartOf(e))return i=e.children().first().unwrap(),o=document.createRange(),u.editor.selection.setRangeAtStartOf(i,o),!0}))},x=rt,e(nt,t),nt.pluginName="UndoManager",nt.prototype._index=-1,nt.prototype._capacity=20,nt.prototype._startPosition=null,nt.prototype._endPosition=null,nt.prototype._init=function(){var t,e,i,o,r,n,s,a,l;return this.editor=this._module,this._stack=[],t=this.editor.util.os.mac?(e="cmd+z","shift+cmd+z"):this.editor.util.os.win?(e="ctrl+z","ctrl+y"):(e="ctrl+z","shift+ctrl+z"),this.editor.hotkeys.add(e,(i=this,function(t){return t.preventDefault(),i.undo(),!1})),this.editor.hotkeys.add(t,(o=this,function(t){return t.preventDefault(),o.redo(),!1})),this.throttledPushState=this.editor.util.throttle((r=this,function(){return r._pushUndoState()}),2e3),this.editor.on("valuechanged",(n=this,function(t,e){if("undo"!==e&&"redo"!==e)return n.throttledPushState()})),this.editor.on("selectionchanged",(s=this,function(t){return s.resetCaretPosition(),s.update()})),this.editor.on("focus",(a=this,function(t){if(0===a._stack.length)return a._pushUndoState()})),this.editor.on("blur",(l=this,function(t){return l.resetCaretPosition()}))},nt.prototype.resetCaretPosition=function(){return this._startPosition=null,this._endPosition=null},nt.prototype.startPosition=function(){return this.editor.selection._range&&(this._startPosition||(this._startPosition=this._getPosition("start"))),this._startPosition},nt.prototype.endPosition=function(){var t;return this.editor.selection._range&&(this._endPosition||(this._endPosition=(t=this).editor.selection.range().collapsed?t._startPosition:t._getPosition("end"))),this._endPosition},nt.prototype._pushUndoState=function(){if(!1!==this.editor.triggerHandler("pushundostate")&&this.caretPosition().start)return this._index+=1,this._stack.length=this._index,this._stack.push({html:this.editor.body.html(),caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),this._index-=1):void 0},nt.prototype.currentState=function(){return this._stack.length&&-1<this._index?this._stack[this._index]:null},nt.prototype.undo=function(){var t;if(!(this._index<1||this._stack.length<2))return this.editor.hidePopover(),this._index-=1,t=this._stack[this._index],this.editor.body.get(0).innerHTML=t.html,this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},nt.prototype.redo=function(){var t;if(!(this._index<0||this._stack.length<this._index+2))return this.editor.hidePopover(),this._index+=1,t=this._stack[this._index],this.editor.body.get(0).innerHTML=t.html,this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["redo"])},nt.prototype.update=function(){var t;if(t=this.currentState())return t.html=this.editor.body.html(),t.caret=this.caretPosition()},nt.prototype._getNodeOffset=function(i,o){var t,r,n;return t=N.isNumeric(o)?N(i):N(i).parent(),n=0,r=!1,t.contents().each(function(t,e){return i!==e&&(o!==t||0!==t)&&(e.nodeType===Node.TEXT_NODE?!r&&0<e.nodeValue.length&&(n+=1,r=!0):(n+=1,r=!1),o-1!==t&&null)}),n},nt.prototype._getPosition=function(t){var e,i,o,r,n,s,a;if(null==t&&(t="start"),r=this.editor.selection.range()[t+"Offset"],(i=(e=this.editor.selection[t+"Nodes"]()).first()[0]).nodeType===Node.TEXT_NODE){for(s=i.previousSibling;s&&s.nodeType===Node.TEXT_NODE;)i=s,r+=this.editor.util.getNodeLength(s),s=s.previousSibling;(o=e.get())[0]=i,e=N(o)}else r=this._getNodeOffset(i,r);return n=[r],e.each((a=this,function(t,e){return n.unshift(a._getNodeOffset(e))})),n},nt.prototype._getNodeByPosition=function(t){var e,i,o,r,n,s,a,l;for(s=this.editor.body[0],o=r=0,n=(l=t.slice(0,t.length-1)).length;r<n;o=++r){if((a=l[o])>(i=s.childNodes).length-1){if(o!==t.length-2||!N(s).is(":empty")){s=null;break}e=document.createTextNode(""),s.appendChild(e),i=s.childNodes}s=i[a]}return s},nt.prototype.caretPosition=function(t){var e,i,o,r,n;if(t){if(!t.start)return;return r=this._getNodeByPosition(t.start),n=t.start[t.start.length-1],i=t.collapsed?(e=r,n):(e=this._getNodeByPosition(t.end),t.start[t.start.length-1]),r&&e?((o=document.createRange()).setStart(r,n),o.setEnd(e,i),this.editor.selection.range(o)):void("undefined"!=typeof console&&null!==console&&"function"==typeof console.info&&console.info("simditor: invalid caret state"))}return o=this.editor.selection.range(),t=this.editor.inputManager.focused&&null!=o?{start:this.startPosition(),end:this.endPosition(),collapsed:o.collapsed}:{}},L=nt,e(st,t),st.pluginName="Util",st.prototype._init=function(){if(this.editor=this._module,this.browser.msie&&this.browser.version<11)return this.phBr=""},st.prototype.phBr="<br/>",st.prototype.os=(H={},/Mac/.test(navigator.appVersion)?H.mac=!0:/Linux/.test(navigator.appVersion)?H.linux=!0:/Win/.test(navigator.appVersion)?H.win=!0:/X11/.test(navigator.appVersion)&&(H.unix=!0),/Mobi/.test(navigator.appVersion)&&(H.mobile=!0),H),st.prototype.browser=(G=navigator.userAgent,V=/(msie|trident)/i.test(G),q=/chrome|crios/i.test(G),$=/safari/i.test(G)&&!q,j=/firefox/i.test(G),U=/edge/i.test(G),V?{msie:!0,version:1*(null!=(F=G.match(/(msie |rv:)(\d+(\.\d+)?)/i))?F[2]:void 0)}:U?{edge:!0,webkit:!0,version:1*(null!=(K=G.match(/edge\/(\d+(\.\d+)?)/i))?K[1]:void 0)}:q?{webkit:!0,chrome:!0,version:1*(null!=(X=G.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))?X[1]:void 0)}:$?{webkit:!0,safari:!0,version:1*(null!=(J=G.match(/version\/(\d+(\.\d+)?)/i))?J[1]:void 0)}:j?{mozilla:!0,firefox:!0,version:1*(null!=(Q=G.match(/firefox\/(\d+(\.\d+)?)/i))?Q[1]:void 0)}:{}),st.prototype.support={onselectionchange:function(){var t;if(void 0!==(t=document.onselectionchange))try{return document.onselectionchange=0,null===document.onselectionchange}catch(t){}finally{document.onselectionchange=t}return!1}(),oninput:!/(msie|trident)/i.test(navigator.userAgent)},st.prototype.reflow=function(t){return null==t&&(t=document),N(t)[0].offsetHeight},st.prototype.metaKey=function(t){return/Mac/.test(navigator.userAgent)?t.metaKey:t.ctrlKey},st.prototype.isEmptyNode=function(t){var e;return(e=N(t)).is(":empty")||!e.text()&&!e.find(":not(br, span, div, b, a, strong, i, strike, font, u)").length},st.prototype.isDecoratedNode=function(t){return N(t).is('[class^="simditor-"]')},st.prototype.blockNodes=["div","p","ul","ol","li","blockquote","hr","pre","h1","h2","h3","h4","h5","table"],st.prototype.isBlockNode=function(t){return!(!(t=N(t)[0])||3===t.nodeType)&&new RegExp("^("+this.blockNodes.join("|")+")$").test(t.nodeName.toLowerCase())},st.prototype.getNodeLength=function(t){switch((t=N(t)[0]).nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length}},st.prototype.dataURLtoBlob=function(t){var e,i,o,r,n,s,a,l,d,h,p;if(n=(s=window.Blob&&function(){try{return Boolean(new Blob)}catch(t){return!1}}())&&window.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return!1}}(),e=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!((s||e)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;for(r=0<=t.split(",")[0].indexOf("base64")?atob(t.split(",")[1]):decodeURIComponent(t.split(",")[1]),i=new ArrayBuffer(r.length),l=new Uint8Array(i),a=d=0,p=r.length;0<=p?d<=p:p<=d;a=0<=p?++d:--d)l[a]=r.charCodeAt(a);return h=t.split(",")[0].split(":")[1].split(";")[0],s?new Blob([n?l:i],{type:h}):((o=new e).append(i),o.getBlob(h))},st.prototype.throttle=function(t,e){var i,o,r,n,s,a,l;return l=n=0,r=i=s=null,o=function(){return l=0,n=+new Date,s=t.apply(r,i),i=r=null},(a=function(){var t;return r=this,i=arguments,t=new Date-n,l||(e<=t?o():l=setTimeout(o,e-t)),s}).clear=function(){if(l)return clearTimeout(l),o()},a},st.prototype.formatHTML=function(t){var e,i,o,r,n,s,a,l;for(n=/<(\/?)(.+?)(\/?)>/g,a="",o=0,i=null,s=function(t,e){return new Array(e+1).join(t)};null!==(r=n.exec(t));)r.isBlockNode=-1<N.inArray(r[2],this.blockNodes),r.isStartTag="/"!==r[1]&&"/"!==r[3],r.isEndTag="/"===r[1]||"/"===r[3],e=i?i.index+i[0].length:0,0<(l=t.substring(e,r.index)).length&&N.trim(l)&&(a+=l),r.isBlockNode&&r.isEndTag&&!r.isStartTag&&(o-=1),r.isBlockNode&&r.isStartTag&&(i&&i.isBlockNode&&i.isEndTag||(a+="\n"),a+=s("  ",o)),a+=r[0],r.isBlockNode&&r.isEndTag&&(a+="\n"),r.isBlockNode&&r.isStartTag&&(o+=1),i=r;return N.trim(a)},D=st,e(at,t),at.pluginName="Toolbar",at.prototype.opts={toolbar:!0,toolbarFloat:!0,toolbarHidden:!1,toolbarFloatOffset:0,toolbarScrollContainer:window},at.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'},at.prototype._init=function(){var r,n,s,a,e,i,l,t,o,d;if(this.editor=this._module,this.opts.toolbar)return N.isArray(this.opts.toolbar)||(this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]),this._render(),this.list.on("click",function(t){return!1}),this.wrapper.on("mousedown",(e=this,function(t){return e.list.find(".menu-on").removeClass(".menu-on")})),N(document).on("mousedown.simditor"+this.editor.id,(i=this,function(t){return i.list.find(".menu-on").removeClass(".menu-on")})),!this.opts.toolbarHidden&&this.opts.toolbarFloat&&(s=this.opts.toolbarScrollContainer===window?{top:0,left:0}:N(this.opts.toolbarScrollContainer).offset(),this.wrapper.css("top",s.top+this.opts.toolbarFloatOffset),a=0,t=this,n=function(){return t.wrapper.css("position","static"),t.wrapper.width("auto"),t.editor.util.reflow(t.wrapper),t.wrapper.width(t.wrapper.outerWidth()),t.wrapper.css("left",t.editor.util.os.mobile?t.wrapper.position().left:t.wrapper.offset().left-s.left),t.wrapper.css("position",""),a=t.wrapper.outerHeight(),t.editor.placeholderEl.css("top",s.top),!0},r=null,N(window).on("resize.simditor-"+this.editor.id,function(t){return r=n()}),N(this.opts.toolbarScrollContainer).on("scroll.simditor-"+this.editor.id,(l=this,function(t){var e,i,o;if(l.wrapper.is(":visible"))if(e=(o=l.opts.toolbarScrollContainer===window?l.editor.wrapper.get(0).getBoundingClientRect().top:l.editor.wrapper.offset().top-s.top)+l.editor.wrapper.outerHeight()-80,i=N(l.opts.toolbarScrollContainer).scrollTop()+l.opts.toolbarFloatOffset,0<o||e<0){if(l.editor.wrapper.removeClass("toolbar-floating").css("padding-top",""),l.editor.util.os.mobile)return l.wrapper.css("top",l.opts.toolbarFloatOffset)}else if(r=r||n(),l.editor.wrapper.addClass("toolbar-floating").css("padding-top",a),l.editor.util.os.mobile)return l.wrapper.css("top",i-o+l.opts.toolbarFloatOffset)}))),this.editor.on("destroy",(o=this,function(){return o.buttons.length=0})),N(document).on("mousedown.simditor-"+this.editor.id,(d=this,function(t){return d.list.find("li.menu-on").removeClass("menu-on")}))},at.prototype._render=function(){var t,e,i,o;for(this.buttons=[],this.wrapper=N(this._tpl.wrapper).prependTo(this.editor.wrapper),this.list=this.wrapper.find("ul"),t=0,e=(o=this.opts.toolbar).length;t<e;t++)if("|"!==(i=o[t])){if(!this.constructor.buttons[i])throw new Error("simditor: invalid toolbar button "+i);this.buttons.push(new this.constructor.buttons[i]({editor:this.editor}))}else N(this._tpl.separator).appendTo(this.list);if(this.opts.toolbarHidden)return this.wrapper.hide()},at.prototype.findButton=function(t){var e;return null!=(e=this.list.find(".toolbar-item-"+t).data("button"))?e:null},at.addButton=function(t){return this.buttons[t.prototype.name]=t},at.buttons={},P=at,e(lt,t),lt.pluginName="Indentation",lt.prototype.opts={tabIndent:!0},lt.prototype._init=function(){return this.editor=this._module,this.editor.keystroke.add("tab","*",(i=this,function(t){var e;if(e=i.editor.toolbar.findButton("code"),i.opts.tabIndent||e&&e.active)return i.indent(t.shiftKey)}));var i},lt.prototype.indent=function(o){var t,a,r,n;return this.editor.selection.startNodes(),this.editor.selection.endNodes(),t=this.editor.selection.blockNodes(),a=[],t=t.each(function(t,e){var i,o,r,n,s;for(i=!0,o=r=0,n=a.length;r<n;o=++r){if(s=a[o],N.contains(e,s)){i=!1;break}if(N.contains(s,e)){a.splice(o,1,e),i=!1;break}}if(i)return a.push(e)}),t=N(a),r=!1,t.each((n=this,function(t,e){var i;if(i=o?n.outdentBlock(e):n.indentBlock(e))return r=i})),r},lt.prototype.indentBlock=function(t){var e,i,o,r,n,s,a,l,d,h;if((e=N(t)).length){if(e.is("pre")){if(!(s=this.editor.selection.containerNode()).is(e)&&!s.closest("pre").is(e))return;this.indentText(this.editor.selection.range())}else if(e.is("li")){if((n=e.prev("li")).length<1)return;this.editor.selection.save(),h=e.parent()[0].tagName,0<(i=n.children("ul, ol")).length?i.append(e):N("<"+h+"/>").append(e).appendTo(n),this.editor.selection.restore()}else if(e.is("p, h1, h2, h3, h4"))d=parseInt(e.css("margin-left"))||0,d=(Math.round(d/this.opts.indentWidth)+1)*this.opts.indentWidth,e.css("margin-left",d);else{if(!e.is("table")&&!e.is(".simditor-table"))return!1;if(0<(o=(a=this.editor.selection.containerNode().closest("td, th")).next("td, th")).length||((r=(l=a.parent("tr")).next("tr")).length<1&&l.parent().is("thead")&&(r=l.parent("thead").next("tbody").find("tr:first")),o=r.find("td:first, th:first")),!(0<a.length&&0<o.length))return;this.editor.selection.setRangeAtEndOf(o)}return!0}},lt.prototype.indentText=function(t){var e,i;return e=t.toString().replace(/^(?=.+)/gm,"  "),i=document.createTextNode(e||"  "),t.deleteContents(),t.insertNode(i),e?(t.selectNode(i),this.editor.selection.range(t)):this.editor.selection.setRangeAfter(i)},lt.prototype.outdentBlock=function(t){var e,i,o,r,n,s,a,l,d,h;if((e=N(t))&&0<e.length){if(e.is("pre")){if(!(r=this.editor.selection.containerNode()).is(e)&&!r.closest("pre").is(e))return;this.outdentText(h)}else if(e.is("li"))o=(i=e.parent()).parent("li"),this.editor.selection.save(),o.length<1?((h=document.createRange()).setStartBefore(i[0]),h.setEndBefore(e[0]),i.before(h.extractContents()),N("<p/>").insertBefore(i).after(e.children("ul, ol")).append(e.contents()),e.remove()):(0<e.next("li").length&&N("<"+i[0].tagName+"/>").append(e.nextAll("li")).appendTo(e),e.insertAfter(o),i.children("li").length<1&&i.remove()),this.editor.selection.restore();else if(e.is("p, h1, h2, h3, h4"))d=parseInt(e.css("margin-left"))||0,d=Math.max(Math.round(d/this.opts.indentWidth)-1,0)*this.opts.indentWidth,e.css("margin-left",0===d?"":d);else{if(!e.is("table")&&!e.is(".simditor-table"))return!1;if(0<(n=(a=this.editor.selection.containerNode().closest("td, th")).prev("td, th")).length||((s=(l=a.parent("tr")).prev("tr")).length<1&&l.parent().is("tbody")&&(s=l.parent("tbody").prev("thead").find("tr:first")),n=s.find("td:last, th:last")),!(0<a.length&&0<n.length))return;this.editor.selection.setRangeAtEndOf(n)}return!0}},lt.prototype.outdentText=function(t){},_=lt,e(dt,t),dt.pluginName="Clipboard",dt.prototype.opts={pasteImage:!1,cleanPaste:!1},dt.prototype._init=function(){return this.editor=this._module,this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this.editor.body.on("paste",(o=this,function(t){var e,i;if(!o.pasting&&!o._pasteBin)return!1!==o.editor.triggerHandler(t)&&(i=o.editor.selection.deleteRangeContents(),o.editor.body.html()?i.collapsed||i.collapse(!0):(o.editor.formatter.format(),o.editor.selection.setRangeAtStartOf(o.editor.body.find("p:first")),i=o.editor.selection._range),!o._processPasteByClipboardApi(t)&&(e=N("<span>"),i.insertNode(e[0]),o._createPasteBin(e),e.remove(),i.collapse(!0),o.editor.selection.range(i),o.editor.inputManager.throttledValueChanged.clear(),o.editor.inputManager.throttledSelectionChanged.clear(),o.editor.undoManager.throttledPushState.clear(),o.editor.selection.reset(),o.editor.undoManager.resetCaretPosition(),o.pasting=!0,o._getPasteContent(function(t){return o._processPasteContent(t),o._pasteInBlockEl=null,o._pastePlainText=null,o.pasting=!1})))}));var o},dt.prototype._processPasteByClipboardApi=function(t){var e,i,o,r;if(t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items&&0<t.originalEvent.clipboardData.items.length&&(i=t.originalEvent.clipboardData.items[0],/^image\//.test(i.type))){if(null==(e=i.getAsFile())||!this.opts.pasteImage)return;if(e.name||(e.name="Clipboard Image.png"),!1===this.editor.triggerHandler("pasting",[e]))return;return(r={})[this.opts.pasteImage]=!0,null!=(o=this.editor.uploader)&&o.upload(e,r),!0}},dt.prototype._createPasteBin=function(t){var e,i;return e=t.offset(),i=this.editor.el.offset(),this._pasteBin=N('<div contenteditable="true" />').addClass("simditor-paste-bin").attr("tabIndex","-1").css({top:e.top-i.top,left:e.left-i.left}).appendTo(this.editor.el)},dt.prototype._getPasteContent=function(e){var i,o;return i={html:this.editor.body.html(),caret:this.editor.undoManager.caretPosition()},this._pasteBin.focus(),setTimeout((o=this,function(){var t;return o.editor.hidePopover(),o.editor.body.get(0).innerHTML=n?n.sanitize(i.html):i.html,o.editor.undoManager.caretPosition(i.caret),o.editor.body.focus(),o.editor.selection.reset(),o.editor.selection.range(),o._pasteInBlockEl=o.editor.selection.blockNodes().last(),o._pastePlainText=o.opts.cleanPaste||o._pasteInBlockEl.is("pre, table"),t=o._pastePlainText?o.editor.formatter.clearHtml(o._pasteBin.html(),!0):((t=N("<div/>").append(o._pasteBin.contents())).find("style").remove(),t.find("table colgroup").remove(),o._cleanPasteFontSize(t),o.editor.formatter.format(t),o.editor.formatter.decorate(t),o.editor.formatter.beautify(t.children()),t.contents()),o._pasteBin.remove(),o._pasteBin=null,e(t)}),0)},dt.prototype._processPasteContent=function(t){var e,i,o,r,n,s,a,l,d,h,p,u,c,f,g,m,v,y,_,b,w,x,C,T,k;if(!1!==this.editor.triggerHandler("pasting",[t])&&(e=this._pasteInBlockEl,t)){if(this._pastePlainText)if(e.is("table")){for(d=(m=t.split("\n")).pop(),a=0,h=m.length;a<h;a++)g=m[a],this.editor.selection.insertNode(document.createTextNode(g)),this.editor.selection.insertNode(N("<br/>"));this.editor.selection.insertNode(document.createTextNode(d))}else for(l=0,p=(w=(t=N("<div/>").text(t)).contents()).length;l<p;l++)y=w[l],this.editor.selection.insertNode(N(y)[0]);else if(e.is(this.editor.body))for(v=0,u=t.length;v<u;v++)y=t[v],this.editor.selection.insertNode(y);else{if(t.length<1)return;if(1===t.length)if(t.is("p")){if(r=t.contents(),e.is("h1, h2, h3, h4, h5")&&r.length&&r.css("font-size",""),1===r.length&&r.is("img")){if(/^data:image/.test((i=r).attr("src"))){if(!this.opts.pasteImage)return;return(o=this.editor.util.dataURLtoBlob(i.attr("src"))).name="Clipboard Image.png",(T={})[this.opts.pasteImage]=!0,void(null!=(x=this.editor.uploader)&&x.upload(o,T))}if(new RegExp("^blob:"+location.origin+"/").test(i.attr("src"))){if(!this.opts.pasteImage)return;return(T={})[this.opts.pasteImage]=!0,n=this.editor.util.dataURLtoBlob,k=this.editor.uploader,(s=new Image).onload=function(){var t;(t=document.createElement("canvas")).width=s.naturalWidth,t.height=s.naturalHeight,t.getContext("2d").drawImage(s,0,0),(o=n(t.toDataURL("image/png"))).name="Clipboard Image.png",null!==k&&k.upload(o,T)},void(s.src=i.attr("src"))}if(i.is('img[src^="webkit-fake-url://"]'))return}for(_=0,c=r.length;_<c;_++)y=r[_],this.editor.selection.insertNode(y)}else if(e.is("p")&&this.editor.util.isEmptyNode(e))e.replaceWith(t),this.editor.selection.setRangeAtEndOf(t);else if(t.is("ul, ol"))if(1===t.find("li").length)for(b=0,f=(C=(t=N("<div/>").text(t.text())).contents()).length;b<f;b++)y=C[b],this.editor.selection.insertNode(N(y)[0]);else e.is("li")?e.parent().after(t):e.after(t),this.editor.selection.setRangeAtEndOf(t);else e.after(t),this.editor.selection.setRangeAtEndOf(t);else e.is("li")&&(e=e.parent()),e[this.editor.selection.rangeAtStartOf(e)?"before":this.editor.selection.rangeAtEndOf(e)?"after":(this.editor.selection.breakBlockEl(e),"before")](t),this.editor.selection.setRangeAtEndOf(t.last())}return this.editor.inputManager.throttledValueChanged()}},dt.prototype._cleanPasteFontSize=function(t){var e,o;if(0<(e=N(t)).length)return o=["1.5em","1.25em","0.75em","0.5em"],e.find('[style*="font-size"]').map(function(t,e){var i;if(i=N(e),N.inArray(i.css("font-size"),o)<0)return i.css("font-size","")})},d=dt,e(ht,t),ht.connect(D),ht.connect(b),ht.connect(B),ht.connect(L),ht.connect(x),ht.connect(f),ht.connect(P),ht.connect(_),ht.connect(d),ht.count=0,ht.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1,indentWidth:40},ht.prototype._init=function(){var t,e,i;if(this.textarea=N(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");if(null!=(t=this.textarea.data("simditor"))&&t.destroy(),this.id=++ht.count,this._render(),!o)throw new Error("simditor: simple-hotkeys is required.");if(this.hotkeys=o({el:this.body}),this.opts.upload&&r&&(e="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=r(e)),this.on("initialized",(i=this,function(){if(i.opts.placeholder&&i.on("valuechanged",function(){return i._placeholder()}),i.setValue(i.textarea.val().trim()||""),i.textarea.attr("autofocus"))return i.focus()})),this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(t){}}},ht.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',ht.prototype._render=function(){var t,e,i,o;if(this.el=N(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.data("simditor",this),this.wrapper.append(this.textarea),this.textarea.data("simditor",this).blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){for(t in i=[],e=this.opts.params)o=e[t],i.push(N("<input/>",{type:"hidden",name:t,value:o}).insertAfter(this.textarea));return i}},ht.prototype._placeholder=function(){var t;return 0===(t=this.body.children()).length||1===t.length&&this.util.isEmptyNode(t)&&parseInt(t.css("margin-left")||0)<this.opts.indentWidth?this.placeholderEl.show():this.placeholderEl.hide()},ht.prototype.setValue=function(t){return this.hidePopover(),this.textarea.val(t),this.body.get(0).innerHTML=n?n.sanitize(t):t,this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null,this.trigger("valuechanged")},ht.prototype.getValue=function(){return this.sync()},ht.prototype.sync=function(){var t,e,i,o,r,n;for(e=this.body.clone(),this.formatter.undecorate(e),this.formatter.format(e),this.formatter.autolink(e),r=(t=e.children()).last("p"),o=t.first("p");r.is("p")&&this.util.isEmptyNode(r);)r=(i=r).prev("p"),i.remove();for(;o.is("p")&&this.util.isEmptyNode(o);)i=o,o=r.next("p"),i.remove();return e.find("img.uploading").remove(),n=N.trim(e.html()),this.textarea.val(n),n},ht.prototype.focus=function(){var t,e;if(this.body.is(":visible")&&this.body.is("[contenteditable]"))return this.inputManager.lastCaretPosition?(this.undoManager.caretPosition(this.inputManager.lastCaretPosition),this.inputManager.lastCaretPosition=null):((t=this.body.children().last()).is("p")||(t=N("<p/>").append(this.util.phBr).appendTo(this.body)),e=document.createRange(),this.selection.setRangeAtEndOf(t,e));this.el.find("textarea:visible").focus()},ht.prototype.blur=function(){return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.body.blur():this.body.find("textarea:visible").blur()},ht.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(t,e){if((e=N(e).data("popover")).active)return e.hide()})},ht.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.inputManager.focused=!1,this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),N(document).off(".simditor-"+this.id),N(window).off(".simditor-"+this.id),this.off()},(R=ht).i18n={"zh-CN":{blockquote:"引用",bold:"加粗文字",code:"插入代码",color:"文字颜色",coloredText:"彩色文字",hr:"分隔线",image:"插入图片",externalImage:"外链图片",uploadImage:"上传图片",uploadFailed:"上传失败了",uploadError:"上传出错了",imageUrl:"图片地址",imageSize:"图片尺寸",imageAlt:"图片描述",restoreImageSize:"还原图片尺寸",uploading:"正在上传",indent:"向右缩进",outdent:"向左缩进",italic:"斜体文字",link:"插入链接",linkText:"链接文字",linkUrl:"链接地址",linkTarget:"打开方式",openLinkInCurrentWindow:"在当前窗口中打开",openLinkInNewWindow:"在新窗口中打开",removeLink:"移除链接",ol:"有序列表",ul:"无序列表",strikethrough:"删除线文字",table:"表格",deleteRow:"删除行",insertRowAbove:"在上面插入行",insertRowBelow:"在下面插入行",deleteColumn:"删除列",insertColumnLeft:"在左边插入列",insertColumnRight:"在右边插入列",deleteTable:"删除表格",title:"标题",normalText:"普通文本",underline:"下划线文字",alignment:"水平对齐",alignCenter:"居中",alignLeft:"居左",alignRight:"居右",selectLanguage:"选择程序语言",fontScale:"字体大小",fontScaleXLarge:"超大字体",fontScaleLarge:"大号字体",fontScaleNormal:"正常大小",fontScaleSmall:"小号字体",fontScaleXSmall:"超小字体"},"en-US":{blockquote:"Block Quote",bold:"Bold",code:"Code",color:"Text Color",coloredText:"Colored Text",hr:"Horizontal Line",image:"Insert Image",externalImage:"External Image",uploadImage:"Upload Image",uploadFailed:"Upload failed",uploadError:"Error occurs during upload",imageUrl:"Url",imageSize:"Size",imageAlt:"Alt",restoreImageSize:"Restore Origin Size",uploading:"Uploading",indent:"Indent",outdent:"Outdent",italic:"Italic",link:"Insert Link",linkText:"Text",linkUrl:"Url",linkTarget:"Target",openLinkInCurrentWindow:"Open link in current window",openLinkInNewWindow:"Open link in new window",removeLink:"Remove Link",ol:"Ordered List",ul:"Unordered List",strikethrough:"Strikethrough",table:"Table",deleteRow:"Delete Row",insertRowAbove:"Insert Row Above",insertRowBelow:"Insert Row Below",deleteColumn:"Delete Column",insertColumnLeft:"Insert Column Left",insertColumnRight:"Insert Column Right",deleteTable:"Delete Table",title:"Title",normalText:"Text",underline:"Underline",alignment:"Alignment",alignCenter:"Align Center",alignLeft:"Align Left",alignRight:"Align Right",selectLanguage:"Select Language",fontScale:"Font Size",fontScaleXLarge:"X Large Size",fontScaleLarge:"Large Size",fontScaleNormal:"Normal Size",fontScaleSmall:"Small Size",fontScaleXSmall:"X Small Size"}},e(pt,t),pt.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'},pt.prototype.name="",pt.prototype.icon="",pt.prototype.title="",pt.prototype.text="",pt.prototype.htmlTag="",pt.prototype.disableTag="",pt.prototype.menu=!1,pt.prototype.active=!1,pt.prototype.disabled=!1,pt.prototype.needFocus=!0,pt.prototype.shortcut=null,pt.prototype._init=function(){var t,e,i,o,r,n,s,a,l;for(this.render(),this.el.on("mousedown",(r=this,function(t){var e,i;return t.preventDefault(),e=r.needFocus&&!r.editor.inputManager.focused,!r.el.hasClass("disabled")&&(e&&r.editor.focus(),r.menu?(r.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on"),r.wrapper.is(".menu-on")&&(0<r.menuWrapper.offset().left+r.menuWrapper.outerWidth()+5-r.editor.wrapper.offset().left-r.editor.wrapper.outerWidth()&&r.menuWrapper.css({left:"auto",right:0}),r.trigger("menuexpand"))):(i=r.el.data("param"),r.command(i)),!1)})),this.wrapper.on("click","a.menu-item",(n=this,function(t){var e,i,o;return t.preventDefault(),e=N(t.currentTarget),n.wrapper.removeClass("menu-on"),i=n.needFocus&&!n.editor.inputManager.focused,e.hasClass("disabled")||i||(n.editor.toolbar.wrapper.removeClass("menu-on"),o=e.data("param"),n.command(o)),!1})),this.wrapper.on("mousedown","a.menu-item",function(t){return!1}),this.editor.on("blur",(s=this,function(){if(s.editor.body.is(":visible")&&s.editor.body.is("[contenteditable]")&&!s.editor.clipboard.pasting)return s.setActive(!1),s.setDisabled(!1)})),null!=this.shortcut&&this.editor.hotkeys.add(this.shortcut,(a=this,function(t){return a.el.mousedown(),!1})),t=0,e=(i=this.htmlTag.split(",")).length;t<e;t++)o=i[t],(o=N.trim(o))&&N.inArray(o,this.editor.formatter._allowedTags)<0&&this.editor.formatter._allowedTags.push(o);return this.editor.on("selectionchanged",(l=this,function(t){if(l.editor.inputManager.focused)return l._status()}))},pt.prototype.iconClassOf=function(t){return t?"simditor-icon simditor-icon-"+t:""},pt.prototype.setIcon=function(t){return this.el.find("span").removeClass().addClass(this.iconClassOf(t)).text(this.text)},pt.prototype.render=function(){if(this.wrapper=N(this._tpl.item).appendTo(this.editor.toolbar.list),this.el=this.wrapper.find("a.toolbar-item"),this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this),this.setIcon(this.icon),this.menu)return this.menuWrapper=N(this._tpl.menuWrapper).appendTo(this.wrapper),this.menuWrapper.addClass("toolbar-menu-"+this.name),this.renderMenu()},pt.prototype.renderMenu=function(){var t,e,i,o,r,n,s;if(N.isArray(this.menu)){for(this.menuEl=N("<ul/>").appendTo(this.menuWrapper),s=[],e=0,i=(r=this.menu).length;e<i;e++)"|"!==(o=r[e])?(t=N(this._tpl.menuItem).appendTo(this.menuEl).find("a.menu-item").attr({title:null!=(n=o.title)?n:o.text,"data-param":o.param}).addClass("menu-item-"+o.name),o.icon?s.push(t.find("span").addClass(this.iconClassOf(o.icon))):s.push(t.find("span").text(o.text))):N(this._tpl.separator).appendTo(this.menuEl);return s}},pt.prototype.setActive=function(t){if(t!==this.active)return this.active=t,this.el.toggleClass("active",this.active)},pt.prototype.setDisabled=function(t){if(t!==this.disabled)return this.disabled=t,this.el.toggleClass("disabled",this.disabled)},pt.prototype._disableStatus=function(){var t,e,i;return i=this.editor.selection.startNodes(),e=this.editor.selection.endNodes(),t=0<i.filter(this.disableTag).length||0<e.filter(this.disableTag).length,this.setDisabled(t),this.disabled&&this.setActive(!1),this.disabled},pt.prototype._activeStatus=function(){var t,e,i,o,r;return r=this.editor.selection.startNodes(),i=this.editor.selection.endNodes(),o=r.filter(this.htmlTag),e=i.filter(this.htmlTag),t=0<o.length&&0<e.length&&o.is(e),this.node=t?o:null,this.setActive(t),this.active},pt.prototype._status=function(){if(this._disableStatus(),!this.disabled)return this._activeStatus()},pt.prototype.command=function(t){},pt.prototype._t=function(){var t,e;return t=1<=arguments.length?tt.call(arguments,0):[],pt.__super__._t.apply(this,t)||(e=this.editor)._t.apply(e,t)},l=pt,R.Button=l,e(ut,t),ut.prototype.offset={top:4,left:0},ut.prototype.target=null,ut.prototype.active=!1,ut.prototype._init=function(){var e,i;return this.el=N('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this),this.render(),this.el.on("mouseenter",(e=this,function(t){return e.el.addClass("hover")})),this.el.on("mouseleave",(i=this,function(t){return i.el.removeClass("hover")}))},ut.prototype.render=function(){},ut.prototype._initLabelWidth=function(){var t,o;if(0<(t=this.el.find(".settings-field")).length)return this._labelWidth=0,t.each((o=this,function(t,e){var i;if(0<(i=N(e).find("label")).length)return o._labelWidth=Math.max(o._labelWidth,i.width())})),t.find("label").width(this._labelWidth)},ut.prototype.show=function(t,e){if(null==e&&(e="bottom"),null!=t)return this.el.siblings(".simditor-popover").each(function(t,e){if((e=N(e).data("popover"))&&e.active)return e.hide()}),this.active&&this.target&&this.target.removeClass("selected"),this.target=t.addClass("selected"),this.active||(this.active=!0,this.el.css({left:-9999}).show(),this._labelWidth||this._initLabelWidth(),this.editor.util.reflow()),this.refresh(e),this.trigger("popovershow")},ut.prototype.hide=function(){if(this.active)return this.target&&this.target.removeClass("selected"),this.target=null,this.active=!1,this.el.hide(),this.trigger("popoverhide")},ut.prototype.refresh=function(t){var e,i,o,r,n,s;if(null==t&&(t="bottom"),this.active)return e=this.editor.el.offset(),n=this.target.offset(),r=this.target.outerHeight(),"bottom"===t?s=n.top-e.top+r:"top"===t&&(s=n.top-e.top-this.el.height()),o=this.editor.wrapper.width()-this.el.outerWidth()-10,i=Math.min(n.left-e.left,o),this.el.css({top:s+this.offset.top,left:i+this.offset.left})},ut.prototype.destroy=function(){return this.target=null,this.active=!1,this.editor.off(".linkpopover"),this.el.remove()},ut.prototype._t=function(){var t,e;return t=1<=arguments.length?tt.call(arguments,0):[],ut.__super__._t.apply(this,t)||(e=this.button)._t.apply(e,t)},E=ut,R.Popover=E,e(ct,l),ct.prototype.name="title",ct.prototype.htmlTag="h1, h2, h3, h4, h5",ct.prototype.disableTag="pre, table",ct.prototype._init=function(){return this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}],ct.__super__._init.call(this)},ct.prototype.setActive=function(t,e){if(ct.__super__.setActive.call(this,t),t&&(e=e||this.node[0].tagName.toLowerCase()),this.el.removeClass("active-p active-h1 active-h2 active-h3 active-h4 active-h5"),t)return this.el.addClass("active active-"+e)},ct.prototype.command=function(o){var t,r;return t=this.editor.selection.rootNodes(),this.editor.selection.save(),t.each((r=this,function(t,e){var i;if(!((i=N(e)).is("blockquote")||i.is(o)||i.is(r.disableTag)||r.editor.util.isDecoratedNode(i)))return N("<"+o+"/>").append(i.contents()).replaceAll(i)})),this.editor.selection.restore(),this.editor.trigger("valuechanged")},O=ct,R.Toolbar.addButton(O),e(ft,l),ft.prototype.name="fontScale",ft.prototype.icon="font",ft.prototype.htmlTag="span",ft.prototype.disableTag="pre, h1, h2, h3, h4, h5",ft.prototype.sizeMap={"x-large":"1.5em",large:"1.25em",small:".75em","x-small":".5em"},ft.prototype._init=function(){return this.menu=[{name:"150%",text:this._t("fontScaleXLarge"),param:"5"},{name:"125%",text:this._t("fontScaleLarge"),param:"4"},{name:"100%",text:this._t("fontScaleNormal"),param:"3"},{name:"75%",text:this._t("fontScaleSmall"),param:"2"},{name:"50%",text:this._t("fontScaleXSmall"),param:"1"}],ft.__super__._init.call(this)},ft.prototype._activeStatus=function(){var t,e,i,o,r;return this.editor.selection.range(),r=this.editor.selection.startNodes(),i=this.editor.selection.endNodes(),o=r.filter('span[style*="font-size"]'),e=i.filter('span[style*="font-size"]'),t=0<r.length&&0<i.length&&o.is(e),this.setActive(t),this.active},ft.prototype.command=function(t){var e,i,r;if(!(i=this.editor.selection.range()).collapsed)return this.editor.selection.range(i),document.execCommand("styleWithCSS",!1,!0),document.execCommand("fontSize",!1,t),document.execCommand("styleWithCSS",!1,!1),this.editor.selection.reset(),this.editor.selection.range(),((e=this.editor.selection.containerNode())[0].nodeType===Node.TEXT_NODE?e.closest('span[style*="font-size"]'):e.find('span[style*="font-size"]')).each((r=this,function(t,e){var i,o;return i=N(e),o=e.style.fontSize,/large|x-large|small|x-small/.test(o)?i.css("fontSize",r.sizeMap[o]):"medium"===o?1<i[0].style.length?i.css("fontSize",""):i.replaceWith(i.contents()):void 0})),this.editor.trigger("valuechanged")},c=ft,R.Toolbar.addButton(c),e(gt,l),gt.prototype.name="bold",gt.prototype.icon="bold",gt.prototype.htmlTag="b, strong",gt.prototype.disableTag="pre",gt.prototype.shortcut="cmd+b",gt.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + b )":(this.title=this.title+" ( Ctrl + b )",this.shortcut="ctrl+b"),gt.__super__._init.call(this)},gt.prototype._activeStatus=function(){var t;return t=!0===document.queryCommandState("bold"),this.setActive(t),this.active},gt.prototype.command=function(){return document.execCommand("bold"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),N(document).trigger("selectionchange")},a=gt,R.Toolbar.addButton(a),e(mt,l),mt.prototype.name="italic",mt.prototype.icon="italic",mt.prototype.htmlTag="i",mt.prototype.disableTag="pre",mt.prototype.shortcut="cmd+i",mt.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + i )":(this.title=this.title+" ( Ctrl + i )",this.shortcut="ctrl+i"),mt.__super__._init.call(this)},mt.prototype._activeStatus=function(){var t;return t=!0===document.queryCommandState("italic"),this.setActive(t),this.active},mt.prototype.command=function(){return document.execCommand("italic"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),N(document).trigger("selectionchange")},w=mt,R.Toolbar.addButton(w),e(vt,l),vt.prototype.name="underline",vt.prototype.icon="underline",vt.prototype.htmlTag="u",vt.prototype.disableTag="pre",vt.prototype.shortcut="cmd+u",vt.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + u )":(this.title=this.title+" ( Ctrl + u )",this.shortcut="ctrl+u"),vt.__super__.render.call(this)},vt.prototype._activeStatus=function(){var t;return t=!0===document.queryCommandState("underline"),this.setActive(t),this.active},vt.prototype.command=function(){return document.execCommand("underline"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),N(document).trigger("selectionchange")},z=vt,R.Toolbar.addButton(z),e(yt,l),yt.prototype.name="color",yt.prototype.icon="tint",yt.prototype.disableTag="pre",yt.prototype.menu=!0,yt.prototype.render=function(){var t;return t=1<=arguments.length?tt.call(arguments,0):[],yt.__super__.render.apply(this,t)},yt.prototype.renderMenu=function(){return N('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default"></a></li>\n</ul>').appendTo(this.menuWrapper),this.menuWrapper.on("mousedown",".color-list",function(t){return!1}),this.menuWrapper.on("click",".font-color",(a=this,function(t){var e,i,o,r,n,s;if(a.wrapper.removeClass("menu-on"),(e=N(t.currentTarget)).hasClass("font-color-default")){if(!(0<(i=a.editor.body.find("p, li")).length))return;n=window.getComputedStyle(i[0],null).getPropertyValue("color"),o=a._convertRgbToHex(n)}else n=window.getComputedStyle(e[0],null).getPropertyValue("background-color"),o=a._convertRgbToHex(n);if(o)return r=a.editor.selection.range(),!e.hasClass("font-color-default")&&r.collapsed&&(s=document.createTextNode(a._t("coloredText")),r.insertNode(s),r.selectNodeContents(s)),a.editor.selection.range(r),document.execCommand("styleWithCSS",!1,!0),document.execCommand("foreColor",!1,o),document.execCommand("styleWithCSS",!1,!1),a.editor.util.support.oninput?void 0:a.editor.trigger("valuechanged")}));var a},yt.prototype._convertRgbToHex=function(t){var e;return(e=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g.exec(t))?function(t,e,i){var o;return"#"+(o=function(t){var e;return 1===(e=t.toString(16)).length?"0"+e:e})(t)+o(e)+o(i)}(1*e[1],1*e[2],1*e[3]):""},u=yt,R.Toolbar.addButton(u),e(_t,l),_t.prototype.type="",_t.prototype.disableTag="pre, table",_t.prototype.command=function(t){var o,e,r,n;return e=this.editor.selection.blockNodes(),r="ul"===this.type?"ol":"ul",this.editor.selection.save(),o=null,e.each((n=this,function(t,e){var i;if(!((i=N(e)).is("blockquote, li")||i.is(n.disableTag)||n.editor.util.isDecoratedNode(i))&&N.contains(document,e))return i.is(n.type)?(i.children("li").each(function(t,e){return N(e).children("ul, ol").insertAfter(i),N("<p/>").append(N(e).html()||n.editor.util.phBr).insertBefore(i)}),i.remove()):i.is(r)?N("<"+n.type+"/>").append(i.contents()).replaceAll(i):o&&i.prev().is(o)?(N("<li/>").append(i.html()||n.editor.util.phBr).appendTo(o),i.remove()):((o=N("<"+n.type+"><li></li></"+n.type+">")).find("li").append(i.html()||n.editor.util.phBr),o.replaceAll(i))})),this.editor.selection.restore(),this.editor.trigger("valuechanged")},e(bt,k=_t),bt.prototype.type="ol",bt.prototype.name="ol",bt.prototype.icon="list-ol",bt.prototype.htmlTag="ol",bt.prototype.shortcut="cmd+/",bt.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + / )":(this.title=this.title+" ( ctrl + / )",this.shortcut="ctrl+/"),bt.__super__._init.call(this)},S=bt,e(wt,k),wt.prototype.type="ul",wt.prototype.name="ul",wt.prototype.icon="list-ul",wt.prototype.htmlTag="ul",wt.prototype.shortcut="cmd+.",wt.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + . )":(this.title=this.title+" ( Ctrl + . )",this.shortcut="ctrl+."),wt.__super__._init.call(this)},W=wt,R.Toolbar.addButton(S),R.Toolbar.addButton(W),e(xt,l),xt.prototype.name="blockquote",xt.prototype.icon="quote-left",xt.prototype.htmlTag="blockquote",xt.prototype.disableTag="pre, table",xt.prototype.command=function(){var t,o,r,e,n;return t=(t=this.editor.selection.rootNodes()).filter(function(t,e){return!N(e).parent().is("blockquote")}),this.editor.selection.save(),r=[],e=this,o=function(){if(0<r.length)return N("<"+e.htmlTag+"/>").insertBefore(r[0]).append(r),r.length=0},t.each((n=this,function(t,e){var i;if((i=N(e)).parent().is(n.editor.body))return i.is(n.htmlTag)?(o(),i.children().unwrap()):i.is(n.disableTag)||n.editor.util.isDecoratedNode(i)?o():r.push(e)})),o(),this.editor.selection.restore(),this.editor.trigger("valuechanged")},s=xt,R.Toolbar.addButton(s),e(Ct,l),Ct.prototype.name="code",Ct.prototype.icon="code",Ct.prototype.htmlTag="pre",Ct.prototype.disableTag="ul, ol, table",Ct.prototype._init=function(){var i,o;return Ct.__super__._init.call(this),this.editor.on("decorate",(i=this,function(t,e){return e.find("pre").each(function(t,e){return i.decorate(N(e))})})),this.editor.on("undecorate",(o=this,function(t,e){return e.find("pre").each(function(t,e){return o.undecorate(N(e))})}))},Ct.prototype.render=function(){var t;return t=1<=arguments.length?tt.call(arguments,0):[],Ct.__super__.render.apply(this,t),this.popover=new p({button:this})},Ct.prototype._checkMode=function(){var t;return t=this.editor.selection.range(),0<N(t.cloneContents()).find(this.editor.util.blockNodes.join(","))||t.collapsed&&0===this.editor.selection.startNodes().filter("code").length?(this.inlineMode=!1,this.htmlTag="pre"):(this.inlineMode=!0,this.htmlTag="code")},Ct.prototype._status=function(){if(this._checkMode(),Ct.__super__._status.call(this),!this.inlineMode)return this.active?this.popover.show(this.node):this.popover.hide()},Ct.prototype.decorate=function(t){var e,i,o,r;if(0<(e=t.find("> code")).length&&(i=null!=(o=e.attr("class"))&&null!=(r=o.match(/lang-(\S+)/))?r[1]:void 0,e.contents().unwrap(),i))return t.attr("data-lang",i)},Ct.prototype.undecorate=function(t){var e,i;return i=t.attr("data-lang"),e=N("<code/>"),i&&-1!==i&&e.addClass("lang-"+i),t.wrapInner(e).removeAttr("data-lang")},Ct.prototype.command=function(){return this.inlineMode?this._inlineCommand():this._blockCommand()},Ct.prototype._blockCommand=function(){var t,r,n,s,e,a;return t=this.editor.selection.rootNodes(),n=[],s=[],e=this,r=function(){var t;if(0<n.length)return t=N("<"+e.htmlTag+"/>").insertBefore(n[0]).text(e.editor.formatter.clearHtml(n)),s.push(t[0]),n.length=0},t.each((a=this,function(t,e){var i,o;return(i=N(e)).is(a.htmlTag)?(r(),o=N("<p/>").append(i.html().replace("\n","<br/>")).replaceAll(i),s.push(o[0])):i.is(a.disableTag)||a.editor.util.isDecoratedNode(i)||i.is("blockquote")?r():n.push(e)})),r(),this.editor.selection.setRangeAtEndOf(N(s).last()),this.editor.trigger("valuechanged")},Ct.prototype._inlineCommand=function(){var t,e,i;return i=this.editor.selection.range(),this.active?(i.selectNodeContents(this.node[0]),this.editor.selection.save(i),this.node.contents().unwrap(),this.editor.selection.restore()):(e=N(i.extractContents()),t=N("<"+this.htmlTag+"/>").append(e.contents()),i.insertNode(t[0]),i.selectNodeContents(t[0]),this.editor.selection.range(i)),this.editor.trigger("valuechanged")},h=Ct,e(Tt,E),Tt.prototype.render=function(){var t,e,i,o,r,n;for(this._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">'+this._t("selectLanguage")+"</option>\n    </select>\n  </div>\n</div>",this.langs=this.editor.opts.codeLanguages||[{name:"Bash",value:"bash"},{name:"C++",value:"c++"},{name:"C#",value:"cs"},{name:"CSS",value:"css"},{name:"Erlang",value:"erlang"},{name:"Less",value:"less"},{name:"Sass",value:"sass"},{name:"Diff",value:"diff"},{name:"CoffeeScript",value:"coffeescript"},{name:"HTML,XML",value:"html"},{name:"JSON",value:"json"},{name:"Java",value:"java"},{name:"JavaScript",value:"js"},{name:"Markdown",value:"markdown"},{name:"Objective C",value:"oc"},{name:"PHP",value:"php"},{name:"Perl",value:"parl"},{name:"Python",value:"python"},{name:"Ruby",value:"ruby"},{name:"SQL",value:"sql"}],this.el.addClass("code-popover").append(this._tpl),this.selectEl=this.el.find(".select-lang"),t=0,i=(o=this.langs).length;t<i;t++)e=o[t],N("<option/>",{text:e.name,value:e.value}).appendTo(this.selectEl);return this.selectEl.on("change",(r=this,function(t){var e;return r.lang=r.selectEl.val(),e=r.target.hasClass("selected"),r.target.removeClass().removeAttr("data-lang"),-1!==r.lang&&r.target.attr("data-lang",r.lang),e&&r.target.addClass("selected"),r.editor.trigger("valuechanged")})),this.editor.on("valuechanged",(n=this,function(t){if(n.active)return n.refresh()}))},Tt.prototype.show=function(){var t;return t=1<=arguments.length?tt.call(arguments,0):[],Tt.__super__.show.apply(this,t),this.lang=this.target.attr("data-lang"),null!=this.lang?this.selectEl.val(this.lang):this.selectEl.val(-1)},p=Tt,R.Toolbar.addButton(h),e(kt,l),kt.prototype.name="link",kt.prototype.icon="link",kt.prototype.htmlTag="a",kt.prototype.disableTag="pre",kt.prototype.render=function(){var t;return t=1<=arguments.length?tt.call(arguments,0):[],kt.__super__.render.apply(this,t),this.popover=new T({button:this})},kt.prototype._status=function(){return kt.__super__._status.call(this),this.active&&!this.editor.selection.rangeAtEndOf(this.node)?this.popover.show(this.node):this.popover.hide()},kt.prototype.command=function(){var t,e,i,o,r,n,s;return r=this.editor.selection.range(),this.active?(n=document.createTextNode(this.node.text()),this.node.replaceWith(n),r.selectNode(n)):(t=N(r.extractContents()),o=this.editor.formatter.clearHtml(t.contents(),!1),e=N("<a/>",{href:"",target:"_blank",text:o||this._t("linkText")}),0<this.editor.selection.blockNodes().length?r.insertNode(e[0]):(i=N("<p/>").append(e),r.insertNode(i[0])),r.selectNodeContents(e[0]),this.popover.one("popovershow",(s=this,function(){return o?(s.popover.urlEl.focus(),s.popover.urlEl[0].select()):(s.popover.textEl.focus(),s.popover.textEl[0].select())}))),this.editor.selection.range(r),this.editor.trigger("valuechanged")},C=kt,e(Nt,E),Nt.prototype.render=function(){var t,e,i,o,r,n;return t='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("linkText")+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+this._t("removeLink")+'"\n      tabindex="-1">\n      <span class="simditor-icon simditor-icon-unlink"></span>\n    </a>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("linkUrl")+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("linkTarget")+'</label>\n    <select class="link-target">\n      <option value="_blank">'+this._t("openLinkInNewWindow")+' (_blank)</option>\n      <option value="_self">'+this._t("openLinkInCurrentWindow")+" (_self)</option>\n    </select>\n  </div>\n</div>",this.el.addClass("link-popover").append(t),this.textEl=this.el.find(".link-text"),this.urlEl=this.el.find(".link-url"),this.unlinkEl=this.el.find(".btn-unlink"),this.selectTarget=this.el.find(".link-target"),this.textEl.on("keyup",(e=this,function(t){if(13!==t.which)return e.target.text(e.textEl.val()),e.editor.inputManager.throttledValueChanged()})),this.urlEl.on("keyup",(i=this,function(t){var e;if(13!==t.which)return e=i.urlEl.val(),!/^(http|https|ftp|ftps|file)?:\/\/|^(mailto|tel)?:|^\//gi.test(e)&&e&&(e="http://"+e),i.target.attr("href",e),i.editor.inputManager.throttledValueChanged()})),N([this.urlEl[0],this.textEl[0]]).on("keydown",(o=this,function(t){var e;if(13===t.which||27===t.which||!t.shiftKey&&9===t.which&&N(t.target).hasClass("link-url"))return t.preventDefault(),e=document.createRange(),o.editor.selection.setRangeAfter(o.target,e),o.hide(),o.editor.inputManager.throttledValueChanged()})),this.unlinkEl.on("click",(r=this,function(t){var e,i;return i=document.createTextNode(r.target.text()),r.target.replaceWith(i),r.hide(),e=document.createRange(),r.editor.selection.setRangeAfter(i,e),r.editor.inputManager.throttledValueChanged()})),this.selectTarget.on("change",(n=this,function(t){return n.target.attr("target",n.selectTarget.val()),n.editor.inputManager.throttledValueChanged()}))},Nt.prototype.show=function(){var t;return t=1<=arguments.length?tt.call(arguments,0):[],Nt.__super__.show.apply(this,t),this.textEl.val(this.target.text()),this.urlEl.val(this.target.attr("href"))},T=Nt,R.Toolbar.addButton(C),e(St,l),St.prototype.name="image",St.prototype.icon="picture-o",St.prototype.htmlTag="img",St.prototype.disableTag="pre, table",St.prototype.defaultImage="",St.prototype.needFocus=!1,St.prototype._init=function(){var t,e,i,o,r,n,s;if(this.editor.opts.imageButton)if(Array.isArray(this.editor.opts.imageButton))for(this.menu=[],e=0,i=(o=this.editor.opts.imageButton).length;e<i;e++)t=o[e],this.menu.push({name:t+"-image",text:this._t(t+"Image")});else this.menu=!1;else null!=this.editor.uploader?this.menu=[{name:"upload-image",text:this._t("uploadImage")},{name:"external-image",text:this._t("externalImage")}]:this.menu=!1;return this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",(r=this,function(t){var e,i;return e=N(t.currentTarget),(i=document.createRange()).selectNode(e[0]),r.editor.selection.range(i),r.editor.util.support.onselectionchange||r.editor.trigger("selectionchanged"),!1})),this.editor.body.on("mouseup","img:not([data-non-image])",function(t){return!1}),this.editor.on("selectionchanged.image",(n=this,function(){var t,e,i;if(null!=(i=n.editor.selection.range()))return 1===(t=N(i.cloneContents()).contents()).length&&t.is("img:not([data-non-image])")?(e=N(i.startContainer).contents().eq(i.startOffset),n.popover.show(e)):n.popover.hide()})),this.editor.on("valuechanged.image",(s=this,function(){var t;if(0<(t=s.editor.wrapper.find(".simditor-image-loading")).length)return t.each(function(t,e){var i,o,r;if(!((i=(o=N(e)).data("img"))&&0<i.parent().length)&&(o.remove(),i&&(r=i.data("file"))&&(s.editor.uploader.cancel(r),s.editor.body.find("img.uploading").length<1)))return s.editor.uploader.trigger("uploadready",[r])})})),St.__super__._init.call(this)},St.prototype.render=function(){var t;if(t=1<=arguments.length?tt.call(arguments,0):[],St.__super__.render.apply(this,t),this.popover=new v({button:this}),"upload"===this.editor.opts.imageButton)return this._initUploader(this.el)},St.prototype.renderMenu=function(){return St.__super__.renderMenu.call(this),this._initUploader()},St.prototype._initUploader=function(t){var e,i,o,r,n,s,a,l;if(null==t&&(t=this.menuEl.find(".menu-item-upload-image")),null!=this.editor.uploader)return e=null,r=this,(i=function(){return e&&e.remove(),e=N("<input/>",{type:"file",title:r._t("uploadImage"),multiple:!0,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg"}).appendTo(t)})(),t.on("click mousedown","input[type=file]",function(t){return t.stopPropagation()}),t.on("change","input[type=file]",(n=this,function(t){return n.editor.inputManager.focused?(n.editor.uploader.upload(e,{inline:!0}),i()):(n.editor.one("focus",function(t){return n.editor.uploader.upload(e,{inline:!0}),i()}),n.editor.focus()),n.wrapper.removeClass("menu-on")})),this.editor.uploader.on("beforeupload",(s=this,function(t,e){var i;if(e.inline)return e.img?i=N(e.img):(i=s.createImage(e.name),e.img=i),i.addClass("uploading"),i.data("file",e),s.editor.uploader.readImageFile(e.obj,function(t){var e;if(i.hasClass("uploading"))return e=t?t.src:s.defaultImage,s.loadImage(i,e,function(){if(s.popover.active)return s.popover.refresh(),s.popover.srcEl.val(s._t("uploading")).prop("disabled",!0)})})})),o=N.proxy(this.editor.util.throttle(function(t,e,i,o){var r,n,s;if(e.inline&&(n=e.img.data("mask"))){if((r=n.data("img"))&&r.hasClass("uploading")&&0<r.parent().length)return 99<(s=(100*(s=i/o)).toFixed(0))&&(s=99),n.find(".progress").height(100-s+"%");n.remove()}},500),this),this.editor.uploader.on("uploadprogress",o),this.editor.uploader.on("uploadsuccess",(a=this,function(t,e,i){var o,r,n;if(e.inline&&(o=e.img).hasClass("uploading")&&0<o.parent().length){if("object"!=typeof i)try{i=N.parseJSON(i)}catch(t){i={success:!1}}return r=!1===i.success?(n=i.msg||a._t("uploadFailed"),alert(n),a.defaultImage):i.file_path,a.loadImage(o,r,function(){var t;if(o.removeData("file"),o.removeClass("uploading").removeClass("loading"),(t=o.data("mask"))&&t.remove(),o.removeData("mask"),a.editor.trigger("valuechanged"),a.editor.body.find("img.uploading").length<1)return a.editor.uploader.trigger("uploadready",[e,i])}),a.popover.active?(a.popover.srcEl.prop("disabled",!1),a.popover.srcEl.val(i.file_path)):void 0}})),this.editor.uploader.on("uploaderror",(l=this,function(t,e,i){var o,r;if(e.inline&&"abort"!==i.statusText){if(i.responseText)try{(r=N.parseJSON(i.responseText)).msg}catch(t){l._t("uploadError")}if((o=e.img).hasClass("uploading")&&0<o.parent().length)return l.loadImage(o,l.defaultImage,function(){var t;return o.removeData("file"),o.removeClass("uploading").removeClass("loading"),(t=o.data("mask"))&&t.remove(),o.removeData("mask")}),l.popover.active&&(l.popover.srcEl.prop("disabled",!1),l.popover.srcEl.val(l.defaultImage)),l.editor.trigger("valuechanged"),l.editor.body.find("img.uploading").length<1?l.editor.uploader.trigger("uploadready",[e,r]):void 0}}));this.el.find(".btn-upload").remove()},St.prototype._status=function(){return this._disableStatus()},St.prototype.loadImage=function(i,o,r){var n,s,a,l,d;return l=this,a=function(){var t,e;return t=i.offset(),e=l.editor.wrapper.offset(),n.css({top:t.top-e.top,left:t.left-e.left,width:i.width(),height:i.height()}).show()},i.addClass("loading"),(n=i.data("mask"))||(n=N('<div class="simditor-image-loading">\n  <div class="progress"></div>\n</div>').hide().appendTo(this.editor.wrapper),a(),i.data("mask",n),n.data("img",i)),(s=new Image).onload=(d=this,function(){var t,e;if(i.hasClass("loading")||i.hasClass("uploading"))return e=s.width,t=s.height,i.attr({src:o,width:e,height:t,"data-image-size":e+","+t}).removeClass("loading"),i.hasClass("uploading")?(d.editor.util.reflow(d.editor.body),a()):(n.remove(),i.removeData("mask")),N.isFunction(r)?r(s):void 0}),s.onerror=function(){return N.isFunction(r)&&r(!1),n.remove(),i.removeData("mask").removeClass("loading")},s.setAttribute("src",o)},St.prototype.createImage=function(t){var e,i;return null==t&&(t="Image"),this.editor.inputManager.focused||this.editor.focus(),(i=this.editor.selection.range()).deleteContents(),this.editor.selection.range(i),e=N("<img/>").attr("alt",t),i.insertNode(e[0]),this.editor.selection.setRangeAfter(e,i),this.editor.trigger("valuechanged"),e},St.prototype.command=function(t){var e,i;return e=this.createImage(),this.loadImage(e,t||this.defaultImage,(i=this,function(){return i.editor.trigger("valuechanged"),i.editor.util.reflow(e),e.click(),i.popover.one("popovershow",function(){return i.popover.srcEl.focus(),i.popover.srcEl[0].select()})}))},m=St,e(At,E),At.prototype.offset={top:6,left:-4},At.prototype.render=function(){var t,i,e,o,r,n,s,a,l,d;return t='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("imageUrl")+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;"\n      title="'+this._t("uploadImage")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-upload"></span>\n    </a>\n  </div>\n  <div class=\'settings-field\'>\n    <label>'+this._t("imageAlt")+'</label>\n    <input class="image-alt" id="image-alt" type="text" tabindex="1" />\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("imageSize")+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">×</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;"\n      title="'+this._t("restoreImageSize")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-undo"></span>\n    </a>\n  </div>\n</div>',this.el.addClass("image-popover").append(t),this.srcEl=this.el.find(".image-src"),this.widthEl=this.el.find("#image-width"),this.heightEl=this.el.find("#image-height"),this.altEl=this.el.find("#image-alt"),this.srcEl.on("keydown",(i=this,function(t){var e;if(13===t.which&&!i.target.hasClass("uploading"))return t.preventDefault(),e=document.createRange(),i.button.editor.selection.setRangeAfter(i.target,e),i.hide()})),this.srcEl.on("blur",(e=this,function(t){return e._loadImage(e.srcEl.val())})),this.el.find(".image-size").on("blur",(o=this,function(t){return o._resizeImg(N(t.currentTarget)),o.el.data("popover").refresh()})),this.el.find(".image-size").on("keyup",(r=this,function(t){var e;if(e=N(t.currentTarget),13!==t.which&&27!==t.which&&9!==t.which)return r._resizeImg(e,!0)})),this.el.find(".image-size").on("keydown",(n=this,function(t){var e,i,o;return i=N(t.currentTarget),13===t.which||27===t.which?(t.preventDefault(),13===t.which?n._resizeImg(i):n._restoreImg(),e=n.target,n.hide(),o=document.createRange(),n.button.editor.selection.setRangeAfter(e,o)):9===t.which?n.el.data("popover").refresh():void 0})),this.altEl.on("keydown",(s=this,function(t){var e;if(13===t.which)return t.preventDefault(),e=document.createRange(),s.button.editor.selection.setRangeAfter(s.target,e),s.hide()})),this.altEl.on("keyup",(a=this,function(t){if(13!==t.which&&27!==t.which&&9!==t.which)return a.alt=a.altEl.val(),a.target.attr("alt",a.alt)})),this.el.find(".btn-restore").on("click",(l=this,function(t){return l._restoreImg(),l.el.data("popover").refresh()})),this.editor.on("valuechanged",(d=this,function(t){if(d.active)return d.refresh()})),this._initUploader()},At.prototype._initUploader=function(){var t,e,i,o;if(t=this.el.find(".btn-upload"),null!=this.editor.uploader)return i=this,(e=function(){return i.input&&i.input.remove(),i.input=N("<input/>",{type:"file",title:i._t("uploadImage"),multiple:!0,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg"}).appendTo(t)})(),this.el.on("click mousedown","input[type=file]",function(t){return t.stopPropagation()}),this.el.on("change","input[type=file]",(o=this,function(t){return o.editor.uploader.upload(o.input,{inline:!0,img:o.target}),e()}));t.remove()},At.prototype._resizeImg=function(t,e){var i,o,r;if(null==e&&(e=!1),o=1*t.val(),this.target&&(N.isNumeric(o)||o<0))return t.is(this.widthEl)?(r=o,i=this.height*o/this.width,this.heightEl.val(i)):(i=o,r=this.width*o/this.height,this.widthEl.val(r)),e?void 0:(this.target.attr({width:r,height:i}),this.editor.trigger("valuechanged"))},At.prototype._restoreImg=function(){var t,e;return e=(null!=(t=this.target.data("image-size"))?t.split(","):void 0)||[this.width,this.height],this.target.attr({width:1*e[0],height:1*e[1]}),this.widthEl.val(e[0]),this.heightEl.val(e[1]),this.editor.trigger("valuechanged")},At.prototype._loadImage=function(i,o){var r;if(!/^data:image/.test(i)||this.editor.uploader){if(this.target.attr("src")!==i)return this.button.loadImage(this.target,i,(r=this,function(t){var e;if(t)return r.active&&(r.width=t.width,r.height=t.height,r.widthEl.val(r.width),r.heightEl.val(r.height)),/^data:image/.test(i)?((e=r.editor.util.dataURLtoBlob(i)).name="Base64 Image.png",r.editor.uploader.upload(e,{inline:!0,img:r.target})):r.editor.trigger("valuechanged"),o?o(t):void 0}))}else o&&o(!1)},At.prototype.show=function(){var t,e;return e=1<=arguments.length?tt.call(arguments,0):[],At.__super__.show.apply(this,e),t=this.target,this.width=t.width(),this.height=t.height(),this.alt=t.attr("alt"),t.hasClass("uploading")?this.srcEl.val(this._t("uploading")).prop("disabled",!0):(this.srcEl.val(t.attr("src")).prop("disabled",!1),this.widthEl.val(this.width),this.heightEl.val(this.height),this.altEl.val(this.alt))},v=At,R.Toolbar.addButton(m),e(Et,l),Et.prototype.name="indent",Et.prototype.icon="indent",Et.prototype._init=function(){var t;return t=!1===this.editor.opts.tabIndent?"":" (Tab)",this.title=this._t(this.name)+t,Et.__super__._init.call(this)},Et.prototype._status=function(){},Et.prototype.command=function(){return this.editor.indentation.indent()},y=Et,R.Toolbar.addButton(y),e(Bt,l),Bt.prototype.name="outdent",Bt.prototype.icon="outdent",Bt.prototype._init=function(){var t;return t=!1===this.editor.opts.tabIndent?"":" (Shift + Tab)",this.title=this._t(this.name)+t,Bt.__super__._init.call(this)},Bt.prototype._status=function(){},Bt.prototype.command=function(){return this.editor.indentation.indent(!0)},A=Bt,R.Toolbar.addButton(A),e(Rt,l),Rt.prototype.name="hr",Rt.prototype.icon="minus",Rt.prototype.htmlTag="hr",Rt.prototype._status=function(){},Rt.prototype.command=function(){var t,e,i;return 0<(i=this.editor.selection.rootNodes().first()).next().length?this.editor.selection.save():e=N("<p/>").append(this.editor.util.phBr),t=N("<hr/>").insertAfter(i),e?(e.insertAfter(t),this.editor.selection.setRangeAtStartOf(e)):this.editor.selection.restore(),this.editor.trigger("valuechanged")},g=Rt,R.Toolbar.addButton(g),e(It,l),It.prototype.name="table",It.prototype.icon="table",It.prototype.htmlTag="table",It.prototype.disableTag="pre, li, blockquote",It.prototype.menu=!0,It.prototype._init=function(){var i,o,r,e,n,s,a,l;return It.__super__._init.call(this),N.merge(this.editor.formatter._allowedTags,["thead","th","tbody","tr","td","colgroup","col"]),N.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),N.extend(this.editor.formatter._allowedStyles,{td:["text-align"],th:["text-align"]}),this._initShortcuts(),this._initResize(),this.editor.on("decorate",(i=this,function(t,e){return e.find("table").each(function(t,e){return i.decorate(N(e))})})),this.editor.on("undecorate",(o=this,function(t,e){return e.find("table").each(function(t,e){return o.undecorate(N(e))})})),this.editor.on("selectionchanged.table",(r=this,function(t){var e,i;if(r.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active"),i=r.editor.selection.range())return e=r.editor.selection.containerNode(),i.collapsed&&e.is(".simditor-table")&&r.editor.selection.setRangeAtEndOf(e),e.closest("td, th",r.editor.body).addClass("active")})),this.editor.on("blur.table",(e=this,function(t){return e.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active")})),this.editor.keystroke.add("up","td",(n=this,function(t,e){return n._tdNav(e,"up"),!0})),this.editor.keystroke.add("up","th",(s=this,function(t,e){return s._tdNav(e,"up"),!0})),this.editor.keystroke.add("down","td",(a=this,function(t,e){return a._tdNav(e,"down"),!0})),this.editor.keystroke.add("down","th",(l=this,function(t,e){return l._tdNav(e,"down"),!0}))},It.prototype._tdNav=function(t,e){var i,o,r,n;return null==e&&(e="up"),r="up"===e?"prev":"next","up"===e?["tbody","thead"]:["thead","tbody"],o=t.parent("tr"),!(0<(i=this["_"+r+"Row"](o)).length)||(n=o.find("td, th").index(t),this.editor.selection.setRangeAtEndOf(i.find("td, th").eq(n)))},It.prototype._nextRow=function(t){var e;return(e=t.next("tr")).length<1&&0<t.parent("thead").length&&(e=t.parent("thead").next("tbody").find("tr:first")),e},It.prototype._prevRow=function(t){var e;return(e=t.prev("tr")).length<1&&0<t.parent("tbody").length&&(e=t.parent("tbody").prev("thead").find("tr")),e},It.prototype._initResize=function(){var u;return u=this.editor,N(document).on("mousemove.simditor-table",".simditor-table td, .simditor-table th",function(t){var e,i,o,r,n,s,a,l;if(o=(n=N(this).parents(".simditor-table")).find(".simditor-resize-handle"),i=n.find("colgroup"),!n.hasClass("resizing"))if(r=N(t.currentTarget),t.pageX-N(t.currentTarget).offset().left<5&&0<r.prev().length&&(r=r.prev()),r.next("td, th").length<1)o.hide();else if(null!=(a=o.data("td"))&&a.is(r))o.show();else{if(s=r.parent().find("td, th").index(r),e=i.find("col").eq(s),null==(l=o.data("col"))||!l.is(e))return o.css("left",r.position().left+r.outerWidth()-5).data("td",r).data("col",e).show();o.show()}}),N(document).on("mouseleave.simditor-table",".simditor-table",function(t){return N(this).find(".simditor-resize-handle").hide()}),N(document).on("mousedown.simditor-resize-handle",".simditor-resize-handle",function(t){var r,n,e,s,i,o,a,l,d,h,p;return o=N(this).parent(".simditor-table"),e=(r=N(t.currentTarget)).data("td"),n=r.data("col"),i=e.next("td, th"),s=n.next("col"),h=t.pageX,l=1*e.outerWidth(),d=1*i.outerWidth(),a=parseFloat(r.css("left")),p=e.closest("table").width(),N(document).on("mousemove.simditor-resize-table",function(t){var e,i,o;return e=t.pageX-h,o=d-e,(i=l+e)<50?o=d-(e=(i=50)-l):o<50&&(i=l+(e=d-(o=50))),n.attr("width",i/p*100+"%"),s.attr("width",o/p*100+"%"),r.css("left",a+e)}),N(document).one("mouseup.simditor-resize-table",function(t){return u.sync(),N(document).off(".simditor-resize-table"),o.removeClass("resizing")}),o.addClass("resizing"),!1})},It.prototype._initShortcuts=function(){var e,i,o,r;return this.editor.hotkeys.add("ctrl+alt+up",(e=this,function(t){return e.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+down",(i=this,function(t){return i.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+left",(o=this,function(t){return o.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+right",(r=this,function(t){return r.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}))},It.prototype.decorate=function(t){var i,e,o,r,n;return 0<t.parent(".simditor-table").length&&this.undecorate(t),t.wrap('<div class="simditor-table"></div>'),n=t.parent(".simditor-table"),i=t.find("colgroup"),t.find("thead").length<1&&(r=N("<thead />"),e=t.find("tr").first(),r.append(e),this._changeCellTag(e,"th"),0<(o=t.find("tbody")).length?o.before(r):t.prepend(r)),i.length<1&&(i=N("<colgroup/>").prependTo(t),t.find("thead tr th").each(function(t,e){return N("<col/>").appendTo(i)}),this.refreshTableWidth(t)),N("<div />",{class:"simditor-resize-handle",contenteditable:"false"}).appendTo(n),t.parent()},It.prototype.undecorate=function(t){if(0<t.parent(".simditor-table").length)return t.parent().replaceWith(t)},It.prototype.renderMenu=function(){var s,n,a;return N('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteRow">\n        <span>'+this._t("deleteRow")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowAbove">\n        <span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + ↑ )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowBelow">\n        <span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + ↓ )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteCol">\n        <span>'+this._t("deleteColumn")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColLeft">\n        <span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + ← )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColRight">\n        <span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + → )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteTable">\n        <span>'+this._t("deleteTable")+"</span>\n      </a>\n    </li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),s=this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td, th",(n=this,function(t){var e,i,o,r;return n.createMenu.find("td, th").removeClass("selected"),r=(i=(e=N(t.currentTarget)).parent()).find("td, th").index(e)+1,o=i.prevAll("tr").addBack(),i.parent().is("tbody")&&(o=o.add(s.find("thead tr"))),o.find("td:lt("+r+"), th:lt("+r+")").addClass("selected")})),this.createMenu.on("mouseleave",function(t){return N(t.currentTarget).find("td, th").removeClass("selected")}),this.createMenu.on("mousedown","td, th",(a=this,function(t){var e,i,o,r,n;if(a.wrapper.removeClass("menu-on"),a.editor.inputManager.focused)return r=(o=(i=N(t.currentTarget)).parent()).find("td").index(i)+1,n=o.prevAll("tr").length+1,o.parent().is("tbody")&&(n+=1),s=a.createTable(n,r,!0),e=a.editor.selection.blockNodes().last(),a.editor.util.isEmptyNode(e)?e.replaceWith(s):e.after(s),a.decorate(s),a.editor.selection.setRangeAtStartOf(s.find("th:first")),a.editor.trigger("valuechanged"),!1}))},It.prototype.createTable=function(t,e,i){var o,r,n,s,a,l,d,h,p,u;for(o=N("<table/>"),s=N("<thead/>").appendTo(o),r=N("<tbody/>").appendTo(o),h=l=0,p=t;0<=p?l<p:p<l;h=0<=p?++l:--l)for((a=N("<tr/>")).appendTo(0===h?s:r),d=0,u=e;0<=u?d<u:u<d;0<=u?++d:--d)n=N(0===h?"<th/>":"<td/>").appendTo(a),i&&n.append(this.editor.util.phBr);return o},It.prototype.refreshTableWidth=function(t){return setTimeout(function(){var i,o;return o=t.width(),i=t.find("col"),t.find("thead tr th").each(function(t,e){return i.eq(t).attr("width",N(e).outerWidth()/o*100+"%")})},0)},It.prototype.setActive=function(t){return It.__super__.setActive.call(this,t),t?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},It.prototype._changeCellTag=function(t,o){return t.find("td, th").each(function(t,e){var i;return(i=N(e)).replaceWith("<"+o+">"+i.html()+"</"+o+">")})},It.prototype.deleteRow=function(t){var e,i,o;return(i=t.parent("tr")).closest("table").find("tr").length<1?this.deleteTable(t):(0<(e=this._nextRow(i)).length||(e=this._prevRow(i)),o=i.find("td, th").index(t),i.parent().is("thead")&&(e.appendTo(i.parent()),this._changeCellTag(e,"th")),i.remove(),this.editor.selection.setRangeAtEndOf(e.find("td, th").eq(o)))},It.prototype.insertRow=function(t,e){var i,o,r,n,s,a,l,d;for(null==e&&(e="after"),o=(r=t.parent("tr")).closest("table"),s=0,o.find("tr").each(function(t,e){return s=Math.max(s,N(e).find("td").length)}),a=r.find("td, th").index(t),i=N("<tr/>"),n="td","after"===e&&r.parent().is("thead")?r.parent().next("tbody").prepend(i):"before"===e&&r.parent().is("thead")?(r.before(i),r.parent().next("tbody").prepend(r),this._changeCellTag(r,"td"),n="th"):r[e](i),l=1,d=s;1<=d?l<=d:d<=l;1<=d?++l:--l)N("<"+n+"/>").append(this.editor.util.phBr).appendTo(i);return this.editor.selection.setRangeAtStartOf(i.find("td, th").eq(a))},It.prototype.deleteCol=function(t){var e,i,o,r,n,s;return s=(o=t.parent("tr")).closest("table").find("tr").length<2,n=t.siblings("td, th").length<1,s&&n?this.deleteTable(t):(r=o.find("td, th").index(t),0<(e=t.next("td, th")).length||(e=o.prev("td, th")),(i=o.closest("table")).find("col").eq(r).remove(),i.find("tr").each(function(t,e){return N(e).find("td, th").eq(r).remove()}),this.refreshTableWidth(i),this.editor.selection.setRangeAtEndOf(e))},It.prototype.insertCol=function(t,r){var e,i,o,n,s,a,l,d,h;return null==r&&(r="after"),s=t.parent("tr"),a=s.find("td, th").index(t),e=(n=t.closest("table")).find("col").eq(a),n.find("tr").each((h=this,function(t,e){var i,o;return o=N(e).parent().is("thead")?"th":"td",i=N("<"+o+"/>").append(h.editor.util.phBr),N(e).find("td, th").eq(a)[r](i)})),i=N("<col/>"),e[r](i),l=n.width(),d=Math.max(parseFloat(e.attr("width"))/2,50/l*100),e.attr("width",d+"%"),i.attr("width",d+"%"),this.refreshTableWidth(n),o="after"===r?t.next("td, th"):t.prev("td, th"),this.editor.selection.setRangeAtStartOf(o)},It.prototype.deleteTable=function(t){var e,i;if(e=(i=t.closest(".simditor-table")).next("p"),i.remove(),0<e.length)return this.editor.selection.setRangeAtStartOf(e)},It.prototype.command=function(t){var e;if(0<(e=this.editor.selection.containerNode().closest("td, th")).length){if("deleteRow"===t)this.deleteRow(e);else if("insertRowAbove"===t)this.insertRow(e,"before");else if("insertRowBelow"===t)this.insertRow(e);else if("deleteCol"===t)this.deleteCol(e);else if("insertColLeft"===t)this.insertCol(e,"before");else if("insertColRight"===t)this.insertCol(e);else{if("deleteTable"!==t)return;this.deleteTable(e)}return this.editor.trigger("valuechanged")}},M=It,R.Toolbar.addButton(M),e(Mt,l),Mt.prototype.name="strikethrough",Mt.prototype.icon="strikethrough",Mt.prototype.htmlTag="strike",Mt.prototype.disableTag="pre",Mt.prototype._activeStatus=function(){var t;return t=!0===document.queryCommandState("strikethrough"),this.setActive(t),this.active},Mt.prototype.command=function(){return document.execCommand("strikethrough"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),N(document).trigger("selectionchange")},I=Mt,R.Toolbar.addButton(I),e(Ot,l),Ot.prototype.name="alignment",Ot.prototype.icon="align-left",Ot.prototype.htmlTag="p, h1, h2, h3, h4, td, th",Ot.prototype._init=function(){return this.menu=[{name:"left",text:this._t("alignLeft"),icon:"align-left",param:"left"},{name:"center",text:this._t("alignCenter"),icon:"align-center",param:"center"},{name:"right",text:this._t("alignRight"),icon:"align-right",param:"right"}],Ot.__super__._init.call(this)},Ot.prototype.setActive=function(t,e){return null==e&&(e="left"),"left"!==e&&"center"!==e&&"right"!==e&&(e="left"),"left"===e?Ot.__super__.setActive.call(this,!1):Ot.__super__.setActive.call(this,t),this.el.removeClass("align-left align-center align-right"),t&&this.el.addClass("align-"+e),this.setIcon("align-"+e),this.menuEl.find(".menu-item").show().end().find(".menu-item-"+e).hide()},Ot.prototype._status=function(){return this.nodes=this.editor.selection.nodes().filter(this.htmlTag),this.nodes.length<1?(this.setDisabled(!0),this.setActive(!1)):(this.setDisabled(!1),this.setActive(!0,this.nodes.first().css("text-align")))},Ot.prototype.command=function(t){if("left"!==t&&"center"!==t&&"right"!==t)throw new Error("simditor alignment button: invalid align "+t);return this.nodes.css({"text-align":"left"===t?"":t}),this.editor.trigger("valuechanged"),this.editor.inputManager.throttledSelectionChanged()},i=Ot,R.Toolbar.addButton(i),R});