import{applyPatch}from"fast-json-patch";import stringify from"json-stringify-pretty-compact";import{satisfies}from"semver";import*as vegaImport from"vega";import{writeConfig,isString,mergeConfig,isBoolean}from"vega";import*as vegaLiteImport from"vega-lite";import schemaParser from"vega-schema-url-parser";import*as themes from"vega-themes";import{Handler}from"vega-tooltip";function __awaiter(e,n,t,o){return new(t||(t=Promise))(function(i,a){function r(e){try{c(o.next(e))}catch(e){a(e)}}function s(e){try{c(o.throw(e))}catch(e){a(e)}}function c(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t(function(e){e(n)})).then(r,s)}c((o=o.apply(e,n||[])).next())})}function post(e,n,t){const o=e.open(n),i=250,{origin:a}=new URL(n);let r=~~(1e4/i);e.addEventListener("message",function n(t){t.source===o&&(r=0,e.removeEventListener("message",n,!1))},!1),setTimeout(function e(){r<=0||(o.postMessage(t,a),setTimeout(e,i),r-=1)},i)}var _a,embedStyle='.vega-embed {\n  position: relative;\n  display: inline-block;\n  box-sizing: border-box; }\n  .vega-embed.has-actions {\n    padding-right: 38px; }\n  .vega-embed details:not([open]) > :not(summary) {\n    display: none !important; }\n  .vega-embed summary {\n    list-style: none;\n    position: absolute;\n    top: 0;\n    right: 0;\n    padding: 6px;\n    z-index: 1000;\n    background: white;\n    box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);\n    color: #1b1e23;\n    border: 1px solid #aaa;\n    border-radius: 999px;\n    opacity: 0.2;\n    transition: opacity 0.4s ease-in;\n    outline: none;\n    cursor: pointer;\n    line-height: 0px; }\n    .vega-embed summary::-webkit-details-marker {\n      display: none; }\n    .vega-embed summary:active {\n      box-shadow: #aaa 0px 0px 0px 1px inset; }\n    .vega-embed summary svg {\n      width: 14px;\n      height: 14px; }\n  .vega-embed details[open] summary {\n    opacity: 0.7; }\n  .vega-embed:hover summary,\n  .vega-embed:focus summary {\n    opacity: 1 !important;\n    transition: opacity 0.2s ease; }\n  .vega-embed .vega-actions {\n    position: absolute;\n    z-index: 1001;\n    top: 35px;\n    right: -9px;\n    display: flex;\n    flex-direction: column;\n    padding-bottom: 8px;\n    padding-top: 8px;\n    border-radius: 4px;\n    box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.2);\n    border: 1px solid #d9d9d9;\n    background: white;\n    animation-duration: 0.15s;\n    animation-name: scale-in;\n    animation-timing-function: cubic-bezier(0.2, 0, 0.13, 1.5);\n    text-align: left; }\n    .vega-embed .vega-actions a {\n      padding: 8px 16px;\n      font-family: sans-serif;\n      font-size: 14px;\n      font-weight: 600;\n      white-space: nowrap;\n      color: #434a56;\n      text-decoration: none; }\n      .vega-embed .vega-actions a:hover {\n        background-color: #f7f7f9;\n        color: black; }\n    .vega-embed .vega-actions::before, .vega-embed .vega-actions::after {\n      content: "";\n      display: inline-block;\n      position: absolute; }\n    .vega-embed .vega-actions::before {\n      left: auto;\n      right: 14px;\n      top: -16px;\n      border: 8px solid #0000;\n      border-bottom-color: #d9d9d9; }\n    .vega-embed .vega-actions::after {\n      left: auto;\n      right: 15px;\n      top: -14px;\n      border: 7px solid #0000;\n      border-bottom-color: #fff; }\n  .vega-embed .chart-wrapper {\n    width: 100%;\n    height: 100%; }\n\n.vega-embed-wrapper {\n  max-width: 100%;\n  overflow: auto;\n  padding-right: 14px; }\n\n@keyframes scale-in {\n  from {\n    opacity: 0;\n    transform: scale(0.6); }\n  to {\n    opacity: 1;\n    transform: scale(1); } }\n';function mergeDeep(e,...n){for(const t of n)deepMerge_(e,t);return e}function deepMerge_(e,n){for(const t of Object.keys(n))writeConfig(e,t,n[t],!0)}String.prototype.startsWith||(String.prototype.startsWith=function(e,n){return this.substr(!n||n<0?0:+n,e.length)===e});const vega=vegaImport;let vegaLite=vegaLiteImport;const w="undefined"!=typeof window?window:void 0;void 0===vegaLite&&(null===(_a=null==w?void 0:w.vl)||void 0===_a?void 0:_a.compile)&&(vegaLite=w.vl);const DEFAULT_ACTIONS={export:{svg:!0,png:!0},source:!0,compiled:!0,editor:!0},I18N={CLICK_TO_VIEW_ACTIONS:"Click to view actions",COMPILED_ACTION:"View Compiled Vega",EDITOR_ACTION:"Open in Vega Editor",PNG_ACTION:"Save as PNG",SOURCE_ACTION:"View Source",SVG_ACTION:"Save as SVG"},NAMES={vega:"Vega","vega-lite":"Vega-Lite"},VERSION={vega:vega.version,"vega-lite":vegaLite?vegaLite.version:"not available"},PREPROCESSOR={vega:e=>e,"vega-lite":(e,n)=>vegaLite.compile(e,{config:n}).spec},SVG_CIRCLES='\n<svg viewBox="0 0 16 16" fill="currentColor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">\n  <circle r="2" cy="8" cx="2"></circle>\n  <circle r="2" cy="8" cx="8"></circle>\n  <circle r="2" cy="8" cx="14"></circle>\n</svg>',CHART_WRAPPER_CLASS="chart-wrapper";function isTooltipHandler(e){return"function"==typeof e}function viewSource(e,n,t,o){const i=`<html><head>${n}</head><body><pre><code class="json">`,a=`</code></pre>${t}</body></html>`,r=window.open("");r.document.write(i+e+a),r.document.title=`${NAMES[o]} JSON Source`}function guessMode(e,n){var t;if(e.$schema){const o=schemaParser(e.$schema);n&&n!==o.library&&console.warn(`The given visualization spec is written in ${NAMES[o.library]}, but mode argument sets ${null!==(t=NAMES[n])&&void 0!==t?t:n}.`);const i=o.library;return satisfies(VERSION[i],`^${o.version.slice(1)}`)||console.warn(`The input spec uses ${NAMES[i]} ${o.version}, but the current version of ${NAMES[i]} is v${VERSION[i]}.`),i}return"mark"in e||"encoding"in e||"layer"in e||"hconcat"in e||"vconcat"in e||"facet"in e||"repeat"in e?"vega-lite":"marks"in e||"signals"in e||"scales"in e||"axes"in e?"vega":null!=n?n:"vega"}function isLoader(e){return!!(e&&"load"in e)}function createLoader(e){return isLoader(e)?e:vega.loader(e)}function embedOptionsFromUsermeta(e){var n;return null!==(n=e.usermeta&&e.usermeta.embedOptions)&&void 0!==n?n:{}}function embed(e,n,t={}){var o,i,a;return __awaiter(this,void 0,void 0,function*(){let r,s;isString(n)?(s=createLoader(t.loader),r=JSON.parse(yield s.load(n))):r=n;const c=embedOptionsFromUsermeta(r).loader;s&&!c||(s=createLoader(null!==(o=t.loader)&&void 0!==o?o:c));const d=yield loadOpts(embedOptionsFromUsermeta(r),s),l=yield loadOpts(t,s),p=Object.assign(Object.assign({},mergeDeep(l,d)),{config:mergeConfig(null!==(i=l.config)&&void 0!==i?i:{},null!==(a=d.config)&&void 0!==a?a:{})});return yield _embed(e,r,p,s)})}function loadOpts(e,n){var t;return __awaiter(this,void 0,void 0,function*(){const o=isString(e.config)?JSON.parse(yield n.load(e.config)):null!==(t=e.config)&&void 0!==t?t:{},i=isString(e.patch)?JSON.parse(yield n.load(e.patch)):e.patch;return Object.assign(Object.assign(Object.assign({},e),i?{patch:i}:{}),o?{config:o}:{})})}function getRoot(e){var n;const t=e.getRootNode?e.getRootNode():document;return t instanceof ShadowRoot?{root:t,rootContainer:t}:{root:document,rootContainer:null!==(n=document.head)&&void 0!==n?n:document.body}}function _embed(e,n,t={},o){var i,a,r,s,c,d;return __awaiter(this,void 0,void 0,function*(){const l=t.theme?mergeConfig(themes[t.theme],null!==(i=t.config)&&void 0!==i?i:{}):t.config,p=isBoolean(t.actions)?t.actions:mergeDeep({},DEFAULT_ACTIONS,null!==(a=t.actions)&&void 0!==a?a:{}),g=Object.assign(Object.assign({},I18N),t.i18n),m=null!==(r=t.renderer)&&void 0!==r?r:"canvas",v=null!==(s=t.logLevel)&&void 0!==s?s:vega.Warn,u=null!==(c=t.downloadFileName)&&void 0!==c?c:"visualization",f="string"==typeof e?document.querySelector(e):e;if(!f)throw new Error(`${e} does not exist`);if(!1!==t.defaultStyle){const e="vega-embed-style",{root:n,rootContainer:o}=getRoot(f);if(!n.getElementById(e)){const n=document.createElement("style");n.id=e,n.innerText=void 0===t.defaultStyle||!0===t.defaultStyle?embedStyle.toString():t.defaultStyle,o.appendChild(n)}}const h=guessMode(n,t.mode);let b=PREPROCESSOR[h](n,l);if("vega-lite"===h&&b.$schema){const e=schemaParser(b.$schema);satisfies(VERSION.vega,`^${e.version.slice(1)}`)||console.warn(`The compiled spec uses Vega ${e.version}, but current version is v${VERSION.vega}.`)}f.classList.add("vega-embed"),p&&f.classList.add("has-actions"),f.innerHTML="";let y=f;if(p){const e=document.createElement("div");e.classList.add(CHART_WRAPPER_CLASS),f.appendChild(e),y=e}const w=t.patch;w&&(b=w instanceof Function?w(b):applyPatch(b,w,!0,!1).newDocument),t.formatLocale&&vega.formatLocale(t.formatLocale),t.timeFormatLocale&&vega.timeFormatLocale(t.timeFormatLocale);const{ast:x}=t,S=vega.parse(b,"vega-lite"===h?{}:l,{ast:x}),O=new vega.View(S,Object.assign({loader:o,logLevel:v,renderer:m},x?{expr:vega.expressionInterpreter}:{}));if(!1!==t.tooltip){let e;e=isTooltipHandler(t.tooltip)?t.tooltip:new Handler(!0===t.tooltip?{}:t.tooltip).call,O.tooltip(e)}let E,{hover:L}=t;if(void 0===L&&(L="vega"===h),L){const{hoverSet:e,updateSet:n}="boolean"==typeof L?{}:L;O.hover(e,n)}if(t&&(null!=t.width&&O.width(t.width),null!=t.height&&O.height(t.height),null!=t.padding&&O.padding(t.padding)),yield O.initialize(y,t.bind).runAsync(),!1!==p){let e=f;if(!1!==t.defaultStyle){const n=document.createElement("details");n.title=g.CLICK_TO_VIEW_ACTIONS,f.append(n),e=n;const t=document.createElement("summary");t.innerHTML=SVG_CIRCLES,n.append(t),E=(e=>{n.contains(e.target)||n.removeAttribute("open")}),document.addEventListener("click",E)}const o=document.createElement("div");if(e.append(o),o.classList.add("vega-actions"),!0===p||!1!==p.export)for(const e of["svg","png"])if(!0===p||!0===p.export||p.export[e]){const n=g[`${e.toUpperCase()}_ACTION`],i=document.createElement("a");i.text=n,i.href="#",i.target="_blank",i.download=`${u}.${e}`,i.addEventListener("mousedown",function(n){return __awaiter(this,void 0,void 0,function*(){n.preventDefault();const o=yield O.toImageURL(e,t.scaleFactor);this.href=o})}),o.append(i)}if(!0===p||!1!==p.source){const e=document.createElement("a");e.text=g.SOURCE_ACTION,e.href="#",e.addEventListener("click",function(e){var o,i;viewSource(stringify(n),null!==(o=t.sourceHeader)&&void 0!==o?o:"",null!==(i=t.sourceFooter)&&void 0!==i?i:"",h),e.preventDefault()}),o.append(e)}if("vega-lite"===h&&(!0===p||!1!==p.compiled)){const e=document.createElement("a");e.text=g.COMPILED_ACTION,e.href="#",e.addEventListener("click",function(e){var n,o;viewSource(stringify(b),null!==(n=t.sourceHeader)&&void 0!==n?n:"",null!==(o=t.sourceFooter)&&void 0!==o?o:"","vega"),e.preventDefault()}),o.append(e)}if(!0===p||!1!==p.editor){const e=null!==(d=t.editorUrl)&&void 0!==d?d:"https://vega.github.io/editor/",i=document.createElement("a");i.text=g.EDITOR_ACTION,i.href="#",i.addEventListener("click",function(t){post(window,e,{config:l,mode:h,renderer:m,spec:stringify(n)}),t.preventDefault()}),o.append(i)}}return{view:O,spec:n,vgSpec:b,finalize:function(){E&&document.removeEventListener("click",E),O.finalize()}}})}export default embed;export{DEFAULT_ACTIONS,guessMode,vega,vegaLite};