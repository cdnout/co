import"./boot.js";import{timeOut,microTask}from"./async.js";import{Debouncer}from"./debounce.js";import{passiveTouchGestures,cancelSyntheticClickEvents}from"./settings.js";import{wrap}from"./wrap.js";let HAS_NATIVE_TA="string"==typeof document.head.style.touchAction,GESTURE_KEY="__polymerGestures",HANDLED_OBJ="__polymerGesturesHandled",TOUCH_ACTION="__polymerGesturesTouchAction",TAP_DISTANCE=25,TRACK_DISTANCE=5,TRACK_LENGTH=2,MOUSE_TIMEOUT=2500,MOUSE_EVENTS=["mousedown","mousemove","mouseup","click"],MOUSE_WHICH_TO_BUTTONS=[0,1,4,2],MOUSE_HAS_BUTTONS=function(){try{return 1===new MouseEvent("test",{buttons:1}).buttons}catch(e){return!1}}();function isMouseEvent(e){return MOUSE_EVENTS.indexOf(e)>-1}let supportsPassive=!1;function PASSIVE_TOUCH(e){if(!isMouseEvent(e)&&"touchend"!==e)return HAS_NATIVE_TA&&supportsPassive&&passiveTouchGestures?{passive:!0}:void 0}!function(){try{let e=Object.defineProperty({},"passive",{get(){supportsPassive=!0}});window.addEventListener("test",null,e),window.removeEventListener("test",null,e)}catch(e){}}();let IS_TOUCH_ONLY=navigator.userAgent.match(/iP(?:[oa]d|hone)|Android/);const clickedLabels=[],labellable={button:!0,input:!0,keygen:!0,meter:!0,output:!0,textarea:!0,progress:!0,select:!0},canBeDisabled={button:!0,command:!0,fieldset:!0,input:!0,keygen:!0,optgroup:!0,option:!0,select:!0,textarea:!0};function canBeLabelled(e){return labellable[e.localName]||!1}function matchingLabels(e){let t=Array.prototype.slice.call(e.labels||[]);if(!t.length){t=[];let n=e.getRootNode();if(e.id){let o=n.querySelectorAll(`label[for = ${e.id}]`);for(let e=0;e<o.length;e++)t.push(o[e])}}return t}let mouseCanceller=function(e){let t=e.sourceCapabilities;if((!t||t.firesTouchEvents)&&(e[HANDLED_OBJ]={skip:!0},"click"===e.type)){let t=!1,n=getComposedPath(e);for(let e=0;e<n.length;e++){if(n[e].nodeType===Node.ELEMENT_NODE)if("label"===n[e].localName)clickedLabels.push(n[e]);else if(canBeLabelled(n[e])){let o=matchingLabels(n[e]);for(let e=0;e<o.length;e++)t=t||clickedLabels.indexOf(o[e])>-1}if(n[e]===POINTERSTATE.mouse.target)return}if(t)return;e.preventDefault(),e.stopPropagation()}};function setupTeardownMouseCanceller(e){let t=IS_TOUCH_ONLY?["click"]:MOUSE_EVENTS;for(let n,o=0;o<t.length;o++)n=t[o],e?(clickedLabels.length=0,document.addEventListener(n,mouseCanceller,!0)):document.removeEventListener(n,mouseCanceller,!0)}function ignoreMouse(e){if(!cancelSyntheticClickEvents)return;POINTERSTATE.mouse.mouseIgnoreJob||setupTeardownMouseCanceller(!0);POINTERSTATE.mouse.target=getComposedPath(e)[0],POINTERSTATE.mouse.mouseIgnoreJob=Debouncer.debounce(POINTERSTATE.mouse.mouseIgnoreJob,timeOut.after(MOUSE_TIMEOUT),function(){setupTeardownMouseCanceller(),POINTERSTATE.mouse.target=null,POINTERSTATE.mouse.mouseIgnoreJob=null})}function hasLeftMouseButton(e){let t=e.type;if(!isMouseEvent(t))return!1;if("mousemove"===t){let t=void 0===e.buttons?1:e.buttons;return e instanceof window.MouseEvent&&!MOUSE_HAS_BUTTONS&&(t=MOUSE_WHICH_TO_BUTTONS[e.which]||0),Boolean(1&t)}return 0===(void 0===e.button?0:e.button)}function isSyntheticClick(e){if("click"===e.type){if(0===e.detail)return!0;let t=_findOriginalTarget(e);if(!t.nodeType||t.nodeType!==Node.ELEMENT_NODE)return!0;let n=t.getBoundingClientRect(),o=e.pageX,i=e.pageY;return!(o>=n.left&&o<=n.right&&i>=n.top&&i<=n.bottom)}return!1}let POINTERSTATE={mouse:{target:null,mouseIgnoreJob:null},touch:{x:0,y:0,id:-1,scrollDecided:!1}};function firstTouchAction(e){let t="auto",n=getComposedPath(e);for(let e,o=0;o<n.length;o++)if((e=n[o])[TOUCH_ACTION]){t=e[TOUCH_ACTION];break}return t}function trackDocument(e,t,n){e.movefn=t,e.upfn=n,document.addEventListener("mousemove",t),document.addEventListener("mouseup",n)}function untrackDocument(e){document.removeEventListener("mousemove",e.movefn),document.removeEventListener("mouseup",e.upfn),e.movefn=null,e.upfn=null}cancelSyntheticClickEvents&&document.addEventListener("touchend",ignoreMouse,!!supportsPassive&&{passive:!0});const getComposedPath=window.ShadyDOM&&window.ShadyDOM.noPatch?window.ShadyDOM.composedPath:e=>e.composedPath&&e.composedPath()||[];export const gestures={};export const recognizers=[];export function deepTargetFind(e,t){let n=document.elementFromPoint(e,t),o=n;for(;o&&o.shadowRoot&&!window.ShadyDOM;){if(o===(o=o.shadowRoot.elementFromPoint(e,t)))break;o&&(n=o)}return n};function _findOriginalTarget(e){const t=getComposedPath(e);return t.length>0?t[0]:e.target}function _handleNative(e){let t,n=e.type,o=e.currentTarget[GESTURE_KEY];if(!o)return;let i=o[n];if(i){if(!e[HANDLED_OBJ]&&(e[HANDLED_OBJ]={},"touch"===n.slice(0,5))){let t=(e=e).changedTouches[0];if("touchstart"===n&&1===e.touches.length&&(POINTERSTATE.touch.id=t.identifier),POINTERSTATE.touch.id!==t.identifier)return;HAS_NATIVE_TA||"touchstart"!==n&&"touchmove"!==n||_handleTouchAction(e)}if(!(t=e[HANDLED_OBJ]).skip){for(let n,o=0;o<recognizers.length;o++)i[(n=recognizers[o]).name]&&!t[n.name]&&n.flow&&n.flow.start.indexOf(e.type)>-1&&n.reset&&n.reset();for(let o,r=0;r<recognizers.length;r++)i[(o=recognizers[r]).name]&&!t[o.name]&&(t[o.name]=!0,o[n](e))}}}function _handleTouchAction(e){let t=e.changedTouches[0],n=e.type;if("touchstart"===n)POINTERSTATE.touch.x=t.clientX,POINTERSTATE.touch.y=t.clientY,POINTERSTATE.touch.scrollDecided=!1;else if("touchmove"===n){if(POINTERSTATE.touch.scrollDecided)return;POINTERSTATE.touch.scrollDecided=!0;let n=firstTouchAction(e),o=!1,i=Math.abs(POINTERSTATE.touch.x-t.clientX),r=Math.abs(POINTERSTATE.touch.y-t.clientY);e.cancelable&&("none"===n?o=!0:"pan-x"===n?o=r>i:"pan-y"===n&&(o=i>r)),o?e.preventDefault():prevent("track")}}export function addListener(e,t,n){return!!gestures[t]&&(_add(e,t,n),!0)};export function removeListener(e,t,n){return!!gestures[t]&&(_remove(e,t,n),!0)};function _add(e,t,n){let o=gestures[t],i=o.deps,r=o.name,s=e[GESTURE_KEY];s||(e[GESTURE_KEY]=s={});for(let t,n,o=0;o<i.length;o++)t=i[o],IS_TOUCH_ONLY&&isMouseEvent(t)&&"click"!==t||((n=s[t])||(s[t]=n={_count:0}),0===n._count&&e.addEventListener(t,_handleNative,PASSIVE_TOUCH(t)),n[r]=(n[r]||0)+1,n._count=(n._count||0)+1);e.addEventListener(t,n),o.touchAction&&setTouchAction(e,o.touchAction)}function _remove(e,t,n){let o=gestures[t],i=o.deps,r=o.name,s=e[GESTURE_KEY];if(s)for(let t,n,o=0;o<i.length;o++)(n=s[t=i[o]])&&n[r]&&(n[r]=(n[r]||1)-1,n._count=(n._count||1)-1,0===n._count&&e.removeEventListener(t,_handleNative,PASSIVE_TOUCH(t)));e.removeEventListener(t,n)}export function register(e){recognizers.push(e);for(let t=0;t<e.emits.length;t++)gestures[e.emits[t]]=e};function _findRecognizerByEvent(e){for(let t,n=0;n<recognizers.length;n++){t=recognizers[n];for(let n,o=0;o<t.emits.length;o++)if((n=t.emits[o])===e)return t}return null}export function setTouchAction(e,t){HAS_NATIVE_TA&&e instanceof HTMLElement&&microTask.run(()=>{e.style.touchAction=t}),e[TOUCH_ACTION]=t};function _fire(e,t,n){let o=new Event(t,{bubbles:!0,cancelable:!0,composed:!0});if(o.detail=n,wrap(e).dispatchEvent(o),o.defaultPrevented){let e=n.preventer||n.sourceEvent;e&&e.preventDefault&&e.preventDefault()}}export function prevent(e){let t=_findRecognizerByEvent(e);t.info&&(t.info.prevent=!0)};export function resetMouseCanceller(){POINTERSTATE.mouse.mouseIgnoreJob&&POINTERSTATE.mouse.mouseIgnoreJob.flush()};function downupFire(e,t,n,o){t&&_fire(t,e,{x:n.clientX,y:n.clientY,sourceEvent:n,preventer:o,prevent:function(e){return prevent(e)}})}function trackHasMovedEnough(e,t,n){if(e.prevent)return!1;if(e.started)return!0;let o=Math.abs(e.x-t),i=Math.abs(e.y-n);return o>=TRACK_DISTANCE||i>=TRACK_DISTANCE}function trackFire(e,t,n){if(!t)return;let o,i=e.moves[e.moves.length-2],r=e.moves[e.moves.length-1],s=r.x-e.x,u=r.y-e.y,c=0;i&&(o=r.x-i.x,c=r.y-i.y),_fire(t,"track",{state:e.state,x:n.clientX,y:n.clientY,dx:s,dy:u,ddx:o,ddy:c,sourceEvent:n,hover:function(){return deepTargetFind(n.clientX,n.clientY)}})}function trackForward(e,t,n){let o=Math.abs(t.clientX-e.x),i=Math.abs(t.clientY-e.y),r=_findOriginalTarget(n||t);!r||canBeDisabled[r.localName]&&r.hasAttribute("disabled")||(isNaN(o)||isNaN(i)||o<=TAP_DISTANCE&&i<=TAP_DISTANCE||isSyntheticClick(t))&&(e.prevent||_fire(r,"tap",{x:t.clientX,y:t.clientY,sourceEvent:t,preventer:n}))}register({name:"downup",deps:["mousedown","touchstart","touchend"],flow:{start:["mousedown","touchstart"],end:["mouseup","touchend"]},emits:["down","up"],info:{movefn:null,upfn:null},reset:function(){untrackDocument(this.info)},mousedown:function(e){if(!hasLeftMouseButton(e))return;let t=_findOriginalTarget(e),n=this;trackDocument(this.info,function(e){hasLeftMouseButton(e)||(downupFire("up",t,e),untrackDocument(n.info))},function(e){hasLeftMouseButton(e)&&downupFire("up",t,e),untrackDocument(n.info)}),downupFire("down",t,e)},touchstart:function(e){downupFire("down",_findOriginalTarget(e),e.changedTouches[0],e)},touchend:function(e){downupFire("up",_findOriginalTarget(e),e.changedTouches[0],e)}}),register({name:"track",touchAction:"none",deps:["mousedown","touchstart","touchmove","touchend"],flow:{start:["mousedown","touchstart"],end:["mouseup","touchend"]},emits:["track"],info:{x:0,y:0,state:"start",started:!1,moves:[],addMove:function(e){this.moves.length>TRACK_LENGTH&&this.moves.shift(),this.moves.push(e)},movefn:null,upfn:null,prevent:!1},reset:function(){this.info.state="start",this.info.started=!1,this.info.moves=[],this.info.x=0,this.info.y=0,this.info.prevent=!1,untrackDocument(this.info)},mousedown:function(e){if(!hasLeftMouseButton(e))return;let t=_findOriginalTarget(e),n=this,o=function(e){let o=e.clientX,i=e.clientY;trackHasMovedEnough(n.info,o,i)&&(n.info.state=n.info.started?"mouseup"===e.type?"end":"track":"start","start"===n.info.state&&prevent("tap"),n.info.addMove({x:o,y:i}),hasLeftMouseButton(e)||(n.info.state="end",untrackDocument(n.info)),t&&trackFire(n.info,t,e),n.info.started=!0)};trackDocument(this.info,o,function(e){n.info.started&&o(e),untrackDocument(n.info)}),this.info.x=e.clientX,this.info.y=e.clientY},touchstart:function(e){let t=e.changedTouches[0];this.info.x=t.clientX,this.info.y=t.clientY},touchmove:function(e){let t=_findOriginalTarget(e),n=e.changedTouches[0],o=n.clientX,i=n.clientY;trackHasMovedEnough(this.info,o,i)&&("start"===this.info.state&&prevent("tap"),this.info.addMove({x:o,y:i}),trackFire(this.info,t,n),this.info.state="track",this.info.started=!0)},touchend:function(e){let t=_findOriginalTarget(e),n=e.changedTouches[0];this.info.started&&(this.info.state="end",this.info.addMove({x:n.clientX,y:n.clientY}),trackFire(this.info,t,n))}}),register({name:"tap",deps:["mousedown","click","touchstart","touchend"],flow:{start:["mousedown","touchstart"],end:["click","touchend"]},emits:["tap"],info:{x:NaN,y:NaN,prevent:!1},reset:function(){this.info.x=NaN,this.info.y=NaN,this.info.prevent=!1},mousedown:function(e){hasLeftMouseButton(e)&&(this.info.x=e.clientX,this.info.y=e.clientY)},click:function(e){hasLeftMouseButton(e)&&trackForward(this.info,e)},touchstart:function(e){const t=e.changedTouches[0];this.info.x=t.clientX,this.info.y=t.clientY},touchend:function(e){trackForward(this.info,e.changedTouches[0],e)}});export const findOriginalTarget=_findOriginalTarget;export const add=addListener;export const remove=removeListener;