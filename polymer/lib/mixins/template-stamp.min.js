import"../utils/boot.js";import{dedupingMixin}from"../utils/mixin.js";const templateExtensions={"dom-if":!0,"dom-repeat":!0};let placeholderBugDetect=!1,placeholderBug=!1;function hasPlaceholderBug(){if(!placeholderBugDetect){placeholderBugDetect=!0;const e=document.createElement("textarea");e.placeholder="a",placeholderBug=e.placeholder===e.textContent}return placeholderBug}function fixPlaceholder(e){hasPlaceholderBug()&&"textarea"===e.localName&&e.placeholder&&e.placeholder===e.textContent&&(e.textContent=null)}function wrapTemplateExtension(e){let t=e.getAttribute("is");if(t&&templateExtensions[t]){let n=e;for(n.removeAttribute("is"),e=n.ownerDocument.createElement(t),n.parentNode.replaceChild(e,n),e.appendChild(n);n.attributes.length;)e.setAttribute(n.attributes[0].name,n.attributes[0].value),n.removeAttribute(n.attributes[0].name)}return e}function findTemplateNode(e,t){let n=t.parentInfo&&findTemplateNode(e,t.parentInfo);if(!n)return e;for(let e=n.firstChild,a=0;e;e=e.nextSibling)if(t.parentIndex===a++)return e}function applyIdToMap(e,t,n,a){a.id&&(t[a.id]=n)}function applyEventListener(e,t,n){if(n.events&&n.events.length)for(let a,o=0,r=n.events;o<r.length&&(a=r[o]);o++)e._addMethodEventListenerToNode(t,a.name,a.value,e)}function applyTemplateInfo(e,t,n,a){n.templateInfo&&(t._templateInfo=n.templateInfo,t._parentTemplateInfo=a)}function createNodeEventHandler(e,t,n){e=e._methodHost||e;return function(t){e[n]?e[n](t,t.detail):console.warn("listener method `"+n+"` not defined")}}export const TemplateStamp=dedupingMixin(e=>{return class extends e{static _parseTemplate(e,t){if(!e._templateInfo){let n=e._templateInfo={};n.nodeInfoList=[],n.nestedTemplate=Boolean(t),n.stripWhiteSpace=t&&t.stripWhiteSpace||e.hasAttribute("strip-whitespace"),this._parseTemplateContent(e,n,{parent:null})}return e._templateInfo}static _parseTemplateContent(e,t,n){return this._parseTemplateNode(e.content,t,n)}static _parseTemplateNode(e,t,n){let a=!1,o=e;return"template"!=o.localName||o.hasAttribute("preserve-content")?"slot"===o.localName&&(t.hasInsertionPoint=!0):a=this._parseTemplateNestedTemplate(o,t,n)||a,fixPlaceholder(o),o.firstChild&&this._parseTemplateChildNodes(o,t,n),o.hasAttributes&&o.hasAttributes()&&(a=this._parseTemplateNodeAttributes(o,t,n)||a),a||n.noted}static _parseTemplateChildNodes(e,t,n){if("script"!==e.localName&&"style"!==e.localName)for(let a,o=e.firstChild,r=0;o;o=a){if("template"==o.localName&&(o=wrapTemplateExtension(o)),a=o.nextSibling,o.nodeType===Node.TEXT_NODE){let n=a;for(;n&&n.nodeType===Node.TEXT_NODE;)o.textContent+=n.textContent,a=n.nextSibling,e.removeChild(n),n=a;if(t.stripWhiteSpace&&!o.textContent.trim()){e.removeChild(o);continue}}let l={parentIndex:r,parentInfo:n};this._parseTemplateNode(o,t,l)&&(l.infoIndex=t.nodeInfoList.push(l)-1),o.parentNode&&r++}}static _parseTemplateNestedTemplate(e,t,n){let a=e,o=this._parseTemplate(a,t);return(o.content=a.content.ownerDocument.createDocumentFragment()).appendChild(a.content),n.templateInfo=o,!0}static _parseTemplateNodeAttributes(e,t,n){let a=!1,o=Array.from(e.attributes);for(let r,l=o.length-1;r=o[l];l--)a=this._parseTemplateNodeAttribute(e,t,n,r.name,r.value)||a;return a}static _parseTemplateNodeAttribute(e,t,n,a,o){return"on-"===a.slice(0,3)?(e.removeAttribute(a),n.events=n.events||[],n.events.push({name:a.slice(3),value:o}),!0):"id"===a&&(n.id=o,!0)}static _contentForTemplate(e){let t=e._templateInfo;return t&&t.content||e.content}_stampTemplate(e,t){e&&!e.content&&window.HTMLTemplateElement&&HTMLTemplateElement.decorate&&HTMLTemplateElement.decorate(e);let n=(t=t||this.constructor._parseTemplate(e)).nodeInfoList,a=t.content||e.content,o=document.importNode(a,!0);o.__noInsertionPoint=!t.hasInsertionPoint;let r=o.nodeList=new Array(n.length);o.$={};for(let e,a=0,l=n.length;a<l&&(e=n[a]);a++){let n=r[a]=findTemplateNode(o,e);applyIdToMap(this,o.$,n,e),applyTemplateInfo(this,n,e,t),applyEventListener(this,n,e)}return o=o}_addMethodEventListenerToNode(e,t,n,a){let o=createNodeEventHandler(a=a||e,t,n);return this._addEventListenerToNode(e,t,o),o}_addEventListenerToNode(e,t,n){e.addEventListener(t,n)}_removeEventListenerFromNode(e,t,n){e.removeEventListener(t,n)}}});