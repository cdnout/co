!function(){"use strict";DS.LSSerializer=DS.JSONSerializer.extend({serializeHasMany:function(a,b,c){var d=c.key,e=DS.RelationshipChange.determineRelationshipType(a.constructor,c);("manyToNone"===e||"manyToMany"===e||"manyToOne"===e)&&(b[d]=a.get(d).mapBy("id"))},extractSingle:function(a,b,c){if(c&&c._embedded){for(var d in c._embedded){var e=Ember.String.singularize(d),f=c._embedded[d];f&&(Ember.isArray(f)?a.pushMany(e,f):a.push(e,f))}delete c._embedded}return this.normalize(b,c)},extractArray:function(a,b,c){var d=this;return c.map(function(c){return d.extractSingle(a,b,c),d.normalize(b,c)})}}),DS.LSAdapter=DS.Adapter.extend(Ember.Evented,{find:function(a,b,c,d){var e=this,f=!0,g=this._namespaceForType(b);return d&&"undefined"!=typeof d.allowRecursive&&(f=d.allowRecursive),new Ember.RSVP.Promise(function(a,d){var h=Ember.A(g.records[c]);f&&h?e.loadRelationships(b,h).then(function(b){a(b)}):h?a(h):d()})},findMany:function(a,b,c){var d=this,e=this._namespaceForType(b);return new Ember.RSVP.Promise(function(a){for(var d=[],f=0;f<c.length;f++)d.push(Ember.copy(e.records[c[f]]));a(d)}).then(function(a){return a.get("length")?d.loadRelationshipsForMany(b,a):a})},findQuery:function(a,b,c){var e=this._namespaceForType(b),f=this.query(e.records,c);return f.get("length")&&(f=this.loadRelationshipsForMany(b,f)),Ember.RSVP.resolve(f)},query:function(a,b){var d,e,f,g,h,c=[];for(d in a){e=a[d];for(f in b)g=b[f],h=!1,h="[object RegExp]"===Object.prototype.toString.call(g)?g.test(e[f]):e[f]===g;h&&c.push(e)}return c},findAll:function(a,b){var c=this._namespaceForType(b),d=[];for(var e in c.records)d.push(Ember.copy(c.records[e]));return Ember.RSVP.resolve(d)},createRecord:function(a,b,c){var d=this._namespaceForType(b),e=c.serialize({includeId:!0});return d.records[e.id]=e,this.persistData(b,d),Ember.RSVP.resolve()},updateRecord:function(a,b,c){var d=this._namespaceForType(b),e=c.get("id");return d.records[e]=c.serialize({includeId:!0}),this.persistData(b,d),Ember.RSVP.resolve()},deleteRecord:function(a,b,c){var d=this._namespaceForType(b),e=c.get("id");return delete d.records[e],this.persistData(b,d),Ember.RSVP.resolve()},generateIdForRecord:function(){return Math.random().toString(32).slice(2).substr(0,5)},adapterNamespace:function(){return this.namespace||"DS.LSAdapter"},loadData:function(){var a=localStorage.getItem(this.adapterNamespace());return a?JSON.parse(a):{}},persistData:function(a,b){var c=this.modelNamespace(a),d=this.loadData();d[c]=b,localStorage.setItem(this.adapterNamespace(),JSON.stringify(d))},_namespaceForType:function(a){var b=this.modelNamespace(a),c=localStorage.getItem(this.adapterNamespace());return c?JSON.parse(c)[b]||{records:{}}:{records:{}}},modelNamespace:function(a){return a.url||a.typeKey},loadRelationships:function(a,b){var c=this;return new Ember.RSVP.Promise(function(d){var h,i,j=(a.typeKey,[]);h=Ember.get(a,"relationshipNames"),i=h.belongsTo,i=i.concat(h.hasMany),i.forEach(function(d){var i,k,e=a.typeForRelationship(d),f=b[d],g=c.relationshipProperties(a,d),h=g.kind,l={allowRecursive:!1};f&&("belongsTo"==h||"hasOne"==h?i=c.find(null,e,f,l):"hasMany"==h&&(i=c.findMany(null,e,f,l)),k=new Ember.RSVP.Promise(function(a){i.then(function(e){var f=c.addEmbeddedPayload(b,d,e);a(f)})}),j.push(k))}),Ember.RSVP.all(j).then(function(){d(b)})})},addEmbeddedPayload:function(a,b,c){var d=c&&c.id,e=c.length&&c.everyBy("id"),f=d||e;return f&&(a._embedded||(a._embedded={}),a._embedded[b]=c,a[b]=c.length?c.mapBy("id"):c.id),this.isArray(a[b])&&(a[b]=a[b].filter(function(a){return a})),a},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},loadRelationshipsForMany:function(a,b){var c=this;return new Ember.RSVP.Promise(function(d){var f=[],g=[];for(var i in b)b.hasOwnProperty(i)&&g.push(b[i]);var j=function(b){g=g.slice(1);var e=c.loadRelationships(a,b);e.then(function(a){f.push(a),g[0]?j(g[0]):d(f)})};j(g[0])})},relationshipProperties:function(a,b){var c=Ember.get(a,"relationshipsByName");return b?c.get(b):c}})}();
