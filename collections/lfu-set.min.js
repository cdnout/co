"use strict";var Shim=require("./shim"),Set=require("./set").CollectionsSet,GenericCollection=require("./generic-collection"),GenericSet=require("./generic-set"),PropertyChanges=require("./listen/property-changes"),RangeChanges=require("./listen/range-changes");function LfuSet(e,t,n,r,s){if(!(this instanceof LfuSet))return new LfuSet(e,t,n,r,s);t=t||1/0,n=n||Object.equals,r=r||Object.hash,s=s||Function.noop,this.store=new Set(void 0,function(e,t){return n(e.value,t.value)},function(e){return r(e.value)}),this.frequencyHead=new this.FrequencyNode(0),this.contentEquals=n,this.contentHash=r,this.getDefault=s,this.capacity=t,this.length=0,this.addEach(e)}function Node(e,t){this.value=e,this.frequencyNode=t}function FrequencyNode(e,t,n){this.frequency=e,this.values=new Set,this.prev=t||this,this.next=n||this,t&&(t.next=this),n&&(n.prev=this)}(module.exports=LfuSet).LfuSet=LfuSet,Object.addEach(LfuSet.prototype,GenericCollection.prototype),Object.addEach(LfuSet.prototype,GenericSet.prototype),Object.addEach(LfuSet.prototype,PropertyChanges.prototype),Object.addEach(LfuSet.prototype,RangeChanges.prototype),Object.defineProperty(LfuSet.prototype,"size",GenericCollection._sizePropertyDescriptor),LfuSet.from=GenericCollection.from,LfuSet.prototype.constructClone=function(e){return new this.constructor(e,this.capacity,this.contentEquals,this.contentHash,this.getDefault)},LfuSet.prototype.has=function(e){return this.store.has(new this.Node(e))},LfuSet.prototype.get=function(e,t){if(t)throw new Error("LfuSet#get does not support second argument: equals");var n=this.store.get(new this.Node(e));if(void 0===n)return this.getDefault(e);var r=n.frequencyNode,s=r.next;return s.frequency!==r.frequency+1&&(s=new this.FrequencyNode(r.frequency+1,r,s)),s.values.add(n),n.frequencyNode=s,r.values.delete(n),0===r.values.length&&(r.prev.next=r.next,r.next.prev=r.prev),n.value},LfuSet.prototype.add=function(e){if(this.has(e))return this.get(e),!1;var t,n,r,s,i=[],u=[];return 0<this.capacity&&(i.push(e),this.length+1>this.capacity&&(n=(t=this.frequencyHead.next).values.order.head.next.value,u.push(n.value)),this.dispatchesRangeChanges&&this.dispatchBeforeRangeChange(i,u,0),0<u.length&&(this.store.delete(n),t.values.delete(n),1!==t.value&&0===t.values.length&&(this.frequencyHead.next=t.next,t.next.prev=this.frequencyHead)),r=new this.Node(e),1!==(s=this.frequencyHead.next).frequency&&(s=new this.FrequencyNode(1,this.frequencyHead,s)),this.store.add(r),s.values.add(r),r.frequencyNode=s,this.length=this.length+i.length-u.length,this.dispatchesRangeChanges&&this.dispatchRangeChange(i,u,0)),i.length!==u.length},LfuSet.prototype.delete=function(e,t){if(t)throw new Error("LfuSet#delete does not support second argument: equals");var n,r=this.store.get(new this.Node(e)),s=!!r;return s&&(this.dispatchesRangeChanges&&this.dispatchBeforeRangeChange([],[e],0),n=r.frequencyNode,this.store.delete(r),n.values.delete(r),0===n.values.length&&(n.prev.next=n.next,n.next.prev=n.prev),this.length--,this.dispatchesRangeChanges&&this.dispatchRangeChange([],[e],0)),s},LfuSet.prototype.one=function(){if(0<this.length)return this.frequencyHead.next.values.one().value},LfuSet.prototype.clear=function(){this.store.clear(),this.frequencyHead.next=this.frequencyHead,this.length=0},LfuSet.prototype.reduce=function(n,e){for(var r=arguments[2],s=0,t=this.frequencyHead.next;0!==t.frequency;){e=t.values.reduce(function(e,t){return n.call(r,e,t.value,s++,this)},e,this),t=t.next}return e},LfuSet.prototype.reduceRight=function(n,e){for(var r=arguments[2],s=this.length-1,t=this.frequencyHead.prev;0!==t.frequency;){e=t.values.reduceRight(function(e,t){return n.call(r,e,t.value,s--,this)},e,this),t=t.prev}return e},LfuSet.prototype.iterate=function(){return this.store.map(function(e){return e.value}).iterate()},LfuSet.prototype.Node=Node,LfuSet.prototype.FrequencyNode=FrequencyNode;