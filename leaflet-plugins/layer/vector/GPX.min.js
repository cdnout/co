L.GPX=L.FeatureGroup.extend({initialize:function(e,t){L.Util.setOptions(this,t),this._gpx=e,this._layers={},e&&this.addGPX(e,t,this.options.async)},loadXML:function(e,t,n,a){void 0===a&&(a=this.options.async),void 0===n&&(n=this.options);var r=new window.XMLHttpRequest;r.open("GET",e,a);try{r.overrideMimeType("text/xml")}catch(e){}r.onreadystatechange=function(){4===r.readyState&&200===r.status&&t(r.responseXML,n)},r.send(null)},_humanLen:function(e){return e<2e3?e.toFixed(0)+" m":(e/1e3).toFixed(1)+" km"},_polylineLen:function(e){for(var t=e._latlngs,n=0,a=null,r=0;r<t.length;r++)r&&a&&(n+=a.distanceTo(t[r])),a=t[r];return n},addGPX:function(e,t,n){var a=this;this.loadXML(e,function(e,t){a._addGPX(e,t)},t,n)},_addGPX:function(e,t){var n=this.parseGPX(e,t);n&&(this.addLayer(n),this.fire("loaded"))},parseGPX:function(e,t){for(var n,a,r=[],i=!1,s=[["rte","rtept"],["trkseg","trkpt"]],o=0;o<s.length;o++)for(a=e.getElementsByTagName(s[o][0]),n=0;n<a.length;n++)for(var l=this.parse_trkseg(a[n],e,t,s[o][1]),h=0;h<l.length;h++)this.parse_name(a[n],l[h])&&(i=!0),r.push(l[h]);if(a=e.getElementsByTagName("wpt"),!1!==t.display_wpt)for(n=0;n<a.length;n++){var d=this.parse_wpt(a[n],e,t);d&&(this.parse_name(a[n],d)&&(i=!0),r.push(d))}if(r.length){var p=r[0];return 1<r.length&&(p=new L.FeatureGroup(r)),i||this.parse_name(e,p),p}},parse_name:function(e,t){var n,a,r,i="",s="",o=0,l=e.getElementsByTagName("name");for(l.length&&(a=l[0].childNodes[0].nodeValue),l=e.getElementsByTagName("desc"),n=0;n<l.length;n++)for(var h=0;h<l[n].childNodes.length;h++)s+=l[n].childNodes[h].nodeValue;return(l=e.getElementsByTagName("link")).length&&(r=l[0].getAttribute("href")),t instanceof L.Path&&(o=this._polylineLen(t)),a&&(i+="<h2>"+a+"</h2>"+s),o&&(i+="<p>"+this._humanLen(o)+"</p>"),r&&(i+='<p><a target="_blank" href="'+r+'">[...]</a></p>'),t&&void 0===t._popup&&t.bindPopup(i),i},parse_trkseg:function(e,t,n,a){var r=e.getElementsByTagName(a);if(!r.length)return[];for(var i=[],s=0;s<r.length;s++){var o=new L.LatLng(r[s].getAttribute("lat"),r[s].getAttribute("lon"));for(var l in o.meta={},r[s].childNodes){var h=r[s].childNodes[l];h.tagName&&(o.meta[h.tagName]=h.textContent)}i.push(o)}var d=[new L.Polyline(i,n)];return this.fire("addline",{line:d}),d},parse_wpt:function(e,t,n){for(var a=new L.Marker(new L.LatLng(e.getAttribute("lat"),e.getAttribute("lon")),n),r={},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];"#text"!==s.nodeName&&(r[s.nodeName]=s.textContent)}return this.fire("addpoint",{point:a,attributes:r}),a}});