L.GPX=L.FeatureGroup.extend({initialize:function(e,t){L.Util.setOptions(this,t),this._gpx=e,this._layers={},e&&this.addGPX(e,t,this.options.async)},loadXML:function(e,t,n,a){void 0===a&&(a=this.options.async),void 0===n&&(n=this.options);var i=new window.XMLHttpRequest;i.open("GET",e,a);try{i.overrideMimeType("text/xml")}catch(e){}i.onreadystatechange=function(){4===i.readyState&&200===i.status&&t(i.responseXML,n)},i.send(null)},_humanLen:function(e){return e<2e3?e.toFixed(0)+" m":(e/1e3).toFixed(1)+" km"},_polylineLen:function(e){for(var t=e._latlngs,n=0,a=null,i=0;i<t.length;i++)i&&a&&(n+=a.distanceTo(t[i])),a=t[i];return n},addGPX:function(e,t,n){var a=this;this.loadXML(e,function(e,t){a._addGPX(e,t)},t,n)},_addGPX:function(e,t){t=this.parseGPX(e,t);t&&(this.addLayer(t),this.fire("loaded"))},parseGPX:function(e,t){for(var n,a,i=[],r=!1,s=[["rte","rtept"],["trkseg","trkpt"]],o=0;o<s.length;o++)for(a=e.getElementsByTagName(s[o][0]),n=0;n<a.length;n++)for(var l=this.parse_trkseg(a[n],e,t,s[o][1]),h=0;h<l.length;h++)this.parse_name(a[n],l[h])&&(r=!0),i.push(l[h]);if(a=e.getElementsByTagName("wpt"),!1!==t.display_wpt)for(n=0;n<a.length;n++){var d=this.parse_wpt(a[n],e,t);d&&(this.parse_name(a[n],d)&&(r=!0),i.push(d))}if(i.length){var p=i[0];return 1<i.length&&(p=new L.FeatureGroup(i)),r||this.parse_name(e,p),p}},parse_name:function(e,t){var n,a,i,r="",s="",o=0,l=e.getElementsByTagName("name");for(l.length&&(a=l[0].childNodes[0].nodeValue),l=e.getElementsByTagName("desc"),n=0;n<l.length;n++)for(var h=0;h<l[n].childNodes.length;h++)s+=l[n].childNodes[h].nodeValue;return(l=e.getElementsByTagName("link")).length&&(i=l[0].getAttribute("href")),t instanceof L.Path&&(o=this._polylineLen(t)),a&&(r+="<h2>"+a+"</h2>"+s),o&&(r+="<p>"+this._humanLen(o)+"</p>"),i&&(r+='<p><a target="_blank" href="'+i+'">[...]</a></p>'),t&&void 0===t._popup&&t.bindPopup(r),r},parse_trkseg:function(e,t,n,a){var i=e.getElementsByTagName(a);if(!i.length)return[];for(var r=[],s=0;s<i.length;s++){var o,l=new L.LatLng(i[s].getAttribute("lat"),i[s].getAttribute("lon"));for(o in l.meta={},i[s].childNodes){var h=i[s].childNodes[o];h.tagName&&(l.meta[h.tagName]=h.textContent)}r.push(l)}n=[new L.Polyline(r,n)];return this.fire("addline",{line:n}),n},parse_wpt:function(e,t,n){for(var n=new L.Marker(new L.LatLng(e.getAttribute("lat"),e.getAttribute("lon")),n),a={},i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];"#text"!==r.nodeName&&(a[r.nodeName]=r.textContent)}return this.fire("addpoint",{point:n,attributes:a}),n}});