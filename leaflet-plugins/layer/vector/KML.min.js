L.KML=L.FeatureGroup.extend({options:{async:!0},initialize:function(e,t){L.Util.setOptions(this,t),this._kml=e,this._layers={},e&&this.addKML(e,t,this.options.async)},loadXML:function(e,t,n,o){void 0===o&&(o=this.options.async),void 0===n&&(n=this.options);var r=new window.XMLHttpRequest;if(void 0===r.withCredentials&&void 0!==window.XDomainRequest){var a=new window.XDomainRequest;a.open("GET",e,o),a.onprogress=function(){},a.ontimeout=function(){},a.onerror=function(){},a.onload=function(){var e;a.responseText&&((e=new window.ActiveXObject("Microsoft.XMLDOM")).loadXML(a.responseText),t(e,n))},setTimeout(function(){a.send()},0)}else{r.open("GET",e,o),r.setRequestHeader("Accept","application/vnd.google-earth.kml+xml");try{r.overrideMimeType("text/xml")}catch(e){}r.onreadystatechange=function(){4===r.readyState&&200===r.status&&t(r.responseXML,n)},r.send(null)}},addKML:function(e,t,n){var o=this;this.loadXML(e,function(e){o._addKML(e)},t,n)},_addKML:function(e){var t=L.KML.parseKML(e);if(t&&t.length){for(var n=0;n<t.length;n++)this.fire("addlayer",{layer:t[n]}),this.addLayer(t[n]);this.latLngs=L.KML.getLatLngs(e),this.fire("loaded")}},latLngs:[]}),L.Util.extend(L.KML,{parseKML:function(e){var t=this.parseStyles(e);this.parseStyleMap(e,t);for(var n,o=e.getElementsByTagName("Folder"),r=[],a=0;a<o.length;a++)this._check_folder(o[a])&&(n=this.parseFolder(o[a],t))&&r.push(n);o=e.getElementsByTagName("Placemark");for(var s=0;s<o.length;s++)this._check_folder(o[s])&&(n=this.parsePlacemark(o[s],e,t))&&r.push(n);o=e.getElementsByTagName("GroundOverlay");for(var i=0;i<o.length;i++)(n=this.parseGroundOverlay(o[i]))&&r.push(n);return r},_check_folder:function(e,t){for(e=e.parentNode;e&&"Folder"!==e.tagName;)e=e.parentNode;return!e||e===t},parseStyles:function(e){for(var t={},n=e.getElementsByTagName("Style"),o=0,r=n.length;o<r;o++){var a=this.parseStyle(n[o]);a&&(t["#"+a.id]=a)}return t},parseStyle:function(e){var t,n={},o={},i={},l={color:!0,width:!0,Icon:!0,href:!0,hotSpot:!0};function h(e){for(var t={},n=0;n<e.childNodes.length;n++){var o=e.childNodes[n],r=o.tagName;if(l[r])if("hotSpot"===r)for(var a=0;a<o.attributes.length;a++)t[o.attributes[a].name]=o.attributes[a].nodeValue;else{var s=o.childNodes[0].nodeValue;"color"===r?(t.opacity=parseInt(s.substring(0,2),16)/255,t.color="#"+s.substring(6,8)+s.substring(4,6)+s.substring(2,4)):"width"===r?t.weight=s:"Icon"===r?(i=h(o)).href&&(t.href=i.href):"href"===r&&(t.href=s)}}return t}return(t=e.getElementsByTagName("LineStyle"))&&t[0]&&(n=h(t[0])),(t=e.getElementsByTagName("PolyStyle"))&&t[0]&&(o=h(t[0])),o.color&&(n.fillColor=o.color),o.opacity&&(n.fillOpacity=o.opacity),(t=e.getElementsByTagName("IconStyle"))&&t[0]&&(i=h(t[0])),i.href&&(n.icon=new L.KMLIcon({iconUrl:i.href,shadowUrl:null,anchorRef:{x:i.x,y:i.y},anchorType:{x:i.xunits,y:i.yunits}})),(e=e.getAttribute("id"))&&n&&(n.id=e),n},parseStyleMap:function(e,t){for(var n=e.getElementsByTagName("StyleMap"),o=0;o<n.length;o++){var r,a,s=n[o],i=s.getElementsByTagName("key");i&&i[0]&&(r=i[0].textContent),(i=s.getElementsByTagName("styleUrl"))&&i[0]&&(a=i[0].textContent),"normal"===r&&(t["#"+s.getAttribute("id")]=t[a])}},parseFolder:function(e,t){for(var n,o=[],r=e.getElementsByTagName("Folder"),a=0;a<r.length;a++)this._check_folder(r[a],e)&&(n=this.parseFolder(r[a],t))&&o.push(n);r=e.getElementsByTagName("Placemark");for(var s=0;s<r.length;s++)this._check_folder(r[s],e)&&(n=this.parsePlacemark(r[s],e,t))&&o.push(n);r=e.getElementsByTagName("GroundOverlay");for(var i=0;i<r.length;i++)this._check_folder(r[i],e)&&(n=this.parseGroundOverlay(r[i]))&&o.push(n);if(o.length)return 1===o.length?o[0]:new L.FeatureGroup(o)},parsePlacemark:function(e,t,n,o){var r,a,s,i=o||{};for(p=e.getElementsByTagName("styleUrl"),y=0;y<p.length;y++){var l,h=p[y].childNodes[0].nodeValue;for(l in n[h])i[l]=n[h][l]}if(e.getElementsByTagName("Style")[0]){var g=this.parseStyle(e);if(g)for(s in g)i[s]=g[s]}var c=["MultiGeometry","MultiTrack","gx:MultiTrack"];for(r in c)if(p=e.getElementsByTagName(c[r]),y=0,y<p.length)return this.parsePlacemark(p[y],t,n,i);var d=[],u=["LineString","Polygon","Point","Track","gx:Track"];for(a in u)for(var f=u[a],p=e.getElementsByTagName(f),y=0;y<p.length;y++){var m=this["parse"+f.replace(/gx:/,"")](p[y],t,i);m&&d.push(m)}if(d.length){var v=d[0];1<d.length&&(v=new L.FeatureGroup(d));var N,T="";for((p=e.getElementsByTagName("name")).length&&p[0].childNodes.length&&(N=p[0].childNodes[0].nodeValue),p=e.getElementsByTagName("description"),y=0;y<p.length;y++)for(a=0;a<p[y].childNodes.length;a++)T+=p[y].childNodes[a].nodeValue;return N&&v.on("add",function(){v.bindPopup("<h2>"+N+"</h2>"+T)}),v}},parseCoords:function(e){e=e.getElementsByTagName("coordinates");return this._read_coords(e[0])},parseLineString:function(e,t,n){e=this.parseCoords(e);if(e.length)return new L.Polyline(e,n)},parseTrack:function(e,t,n){var o=t.getElementsByTagName("gx:coord");0===o.length&&(o=t.getElementsByTagName("coord"));for(var r=[],a=0;a<o.length;a++)r=r.concat(this._read_gxcoords(o[a]));if(r.length)return new L.Polyline(r,n)},parsePoint:function(e,t,n){e=e.getElementsByTagName("coordinates");if(e.length){e=e[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(e[1],e[0]),n)}},parsePolygon:function(e,t,n){for(var o,r=[],a=[],s=e.getElementsByTagName("outerBoundaryIs"),i=0;i<s.length;i++)(o=this.parseCoords(s[i]))&&r.push(o);for(s=e.getElementsByTagName("innerBoundaryIs"),i=0;i<s.length;i++)(o=this.parseCoords(s[i]))&&a.push(o);if(r.length)return n.fillColor&&(n.fill=!0),1===r.length?new L.Polygon(r.concat(a),n):new L.MultiPolygon(r,n)},getLatLngs:function(e){for(var t=e.getElementsByTagName("coordinates"),n=[],o=0;o<t.length;o++)n=n.concat(this._read_coords(t[o]));return n},_read_coords:function(e){for(var t="",n=[],o=0;o<e.childNodes.length;o++)t+=e.childNodes[o].nodeValue;for(t=t.split(/[\s\n]+/),o=0;o<t.length;o++){var r=t[o].split(",");r.length<2||n.push(new L.LatLng(r[1],r[0]))}return n},_read_gxcoords:function(e){var t=[],n=e.firstChild.nodeValue.split(" ");return t.push(new L.LatLng(n[1],n[0])),t},parseGroundOverlay:function(e){var t=e.getElementsByTagName("LatLonBox")[0],n=new L.LatLngBounds([t.getElementsByTagName("south")[0].childNodes[0].nodeValue,t.getElementsByTagName("west")[0].childNodes[0].nodeValue],[t.getElementsByTagName("north")[0].childNodes[0].nodeValue,t.getElementsByTagName("east")[0].childNodes[0].nodeValue]),i={Icon:!0,href:!0,color:!0};var o={},o=function e(t){for(var n={},o=0;o<t.childNodes.length;o++){var r,a=t.childNodes[o],s=a.tagName;i[s]&&(r=a.childNodes[0].nodeValue,"Icon"===s?(a=e(a)).href&&(n.href=a.href):"href"===s?n.href=r:"color"===s&&(n.opacity=parseInt(r.substring(0,2),16)/255,n.color="#"+r.substring(6,8)+r.substring(4,6)+r.substring(2,4)))}return n}(e);return void 0!==t.getElementsByTagName("rotation")[0]&&(t=t.getElementsByTagName("rotation")[0].childNodes[0].nodeValue,o.rotation=parseFloat(t)),new L.RotatedImageOverlay(o.href,n,{opacity:o.opacity,angle:o.rotation})}}),L.KMLIcon=L.Icon.extend({_setIconStyles:function(e,t){L.Icon.prototype._setIconStyles.apply(this,[e,t]);t=this.options;this.options.popupAnchor=[0,-.83*e.height],"fraction"===t.anchorType.x&&(e.style.marginLeft=-t.anchorRef.x*e.width+"px"),"fraction"===t.anchorType.y&&(e.style.marginTop=-(1-t.anchorRef.y)*e.height+1+"px"),"pixels"===t.anchorType.x&&(e.style.marginLeft=-t.anchorRef.x+"px"),"pixels"===t.anchorType.y&&(e.style.marginTop=t.anchorRef.y-e.height+1+"px")}}),L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default}}),L.RotatedImageOverlay=L.ImageOverlay.extend({options:{angle:0},_reset:function(){L.ImageOverlay.prototype._reset.call(this),this._rotate()},_animateZoom:function(e){L.ImageOverlay.prototype._animateZoom.call(this,e),this._rotate()},_rotate:function(){var e,t;L.DomUtil.TRANSFORM?this._image.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)":L.Browser.ie&&(t=this.options.angle*(Math.PI/180),e=Math.cos(t),t=Math.sin(t),this._image.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+e+", M12="+-t+", M21="+t+", M22="+e+")")},getBounds:function(){return this._bounds}});