L.OSM=L.FeatureGroup.extend({options:{async:!0,forceAll:!1},initialize:function(t,e){L.Util.setOptions(this,e),this._url=t,this._layers={},t&&this.addXML(t,e,this.options.async)},loadXML:function(t,e,a,n){void 0===n&&(n=this.options.async),void 0===a&&(a=this.options);var r=new window.XMLHttpRequest;r.open("GET",t,n),r.overrideMimeType("text/xml"),r.onreadystatechange=function(){4===r.readyState&&200===r.status&&e(r.responseXML,a)},r.send(null)},addXML:function(t,e,a){var n=this;this.loadXML(t,function(t,e){n._addXML(t,e)},e,a)},_addXML:function(t,e){e=this.parseOSM(t,e);e&&(this.addLayer(e),this.fire("loaded"))},parseOSM:function(t,e){for(var a=[],n={},r={},s=!1,i=t.getElementsByTagName("node"),o=0;o<i.length;o++){var l,g,u=this.parse_node(i[o],t,e);void 0!==u&&(n[u.osmid]=u,(this.options.forceAll||u.tags.length)&&(l=this.named_node(u,e),g=g||l.getLatLng(),this.parse_name(l,u,"Node")&&(s=!0),a.push(l)))}for(i=t.getElementsByTagName("way"),o=0;o<i.length&&!(10<o);o++){var h=this.parse_way(i[o],n,e);h&&(g=g||h.getLatLngs()[0],this.parse_name(h,h,"Way")&&(s=!0),a.push(h),r[h.osmid]=h)}for(i=t.getElementsByTagName("relation"),o=0;o<i.length&&!(10<o);o++){var d=this.parse_relation(i[o],r,e);d&&(g=g||d.getLatLngs()[0],this.parse_name(d,d,"Relation")&&(s=!0),a.push(d))}if(a.length){var p=a[0];return 1<a.length&&(p=new L.FeatureGroup(a)),s||this.parse_name(t,p),p.focusPoint=g,p}},parse_name:function(t,e,a){if(this.options.forceAll||e.tags&&e.tags.length){for(var n="<table>",r=0;r<e.tags.length;r++){var s=e.tags[r];n+="<tr><td>"+s.k+"</td><td>=</td><td>"+s.v+"</td></tr>"}return n+="</table>",n="<h2>"+a+" "+e.osmid+"</h2>"+n,t&&t.bindPopup(n),n}},parse_tags:function(t){for(var e=[],a=t.getElementsByTagName("tag"),n=0;n<a.length;n++)e.push({k:a[n].getAttribute("k"),v:a[n].getAttribute("v")});return e},parse_node:function(t){var e={osmid:t.getAttribute("id"),lat:t.getAttribute("lat"),lon:t.getAttribute("lon")};return e.ll=new L.LatLng(e.lat,e.lon),e.tags=this.parse_tags(t),e},parse_way:function(t,e,a){var n=t.getElementsByTagName("nd");if(n.length){for(var r=[],s=0;s<n.length;s++){var i=e[n[s].getAttribute("ref")];if(!i)return;r.push(i.ll)}a=new L.Polyline(r,a);return a.tags=this.parse_tags(t),a.osmid=t.getAttribute("id"),a}},parse_relation:function(t,e,a){var n=t.getElementsByTagName("member");if(n.length){for(var r,s=[],i=this.parse_tags(t),o=0;o<i.length;o++)"type"===i[o].k&&(r=i[o].v);if("multipolygon"===r||"boundary"===r||"waterway"===r){for(o=0;o<n.length;o++){var l=n[o].getAttribute("type"),g=n[o].getAttribute("ref");if("way"===l){g=e[g];if(!g)return;s.push(g)}}if(s.length){a=new L.MultiPolyline(s,a);return a.tags=this.parse_tags(t),a.osmid=t.getAttribute("id"),a}}}},named_node:function(t,e){return new L.Marker(new L.LatLng(t.lat,t.lon),e)}});