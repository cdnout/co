L.BingLayer=L.TileLayer.extend({options:{imagerySet:"Aerial",culture:"",style:"",retinaDpi:"d2",attribution:"Bing",minZoom:1,maxZoom:21},initialize:function(t,e){"object"==typeof t&&(e=t,t=!1),L.TileLayer.prototype.initialize.call(this,null,e),(e=this.options).key=e.key||e.bingMapsKey,e.imagerySet=e.imagerySet||e.type,t&&(e.key=t)},tile2quad:function(t,e,i){for(var r="",o=i;0<o;o--){var a=0,n=1<<o-1;0!=(t&n)&&(a+=1),0!=(e&n)&&(a+=2),r+=a}return r},getTileUrl:function(t){t={subdomain:this._getSubdomain(t),quadkey:this.tile2quad(t.x,t.y,this._getZoomForUrl()),culture:this.options.culture};return L.Util.template(this._url,t)},callRestService:function(t,e,i){i=i||this;for(var r="_bing_metadata_"+L.Util.stamp(this);window[r];)r+="_";t+="&jsonp="+r;var o=document.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",t),window[r]=function(t){if(delete window[r],o.remove(),t.errorDetails)throw new Error(t.errorDetails);e.call(i,t)},document.body.appendChild(o)},_makeApiUrl:function(t,e,i){e={version:"v1",restApi:t,resourcePath:e};i=L.extend({key:this.options.key},i);return L.Util.template("https://dev.virtualearth.net/REST/{version}/{restApi}/{resourcePath}",e)+L.Util.getParamString(i)},loadMetadata:function(){var i,t;this.metaRequested||(this.metaRequested=!0,i=this.options,t=this._makeApiUrl("Imagery/Metadata",i.imagerySet,{UriScheme:"https",include:"ImageryProviders",culture:i.culture,style:i.style}),this.callRestService(t,function(t){var e=t.resourceSets[0].resources[0];if(!e.imageUrl)throw new Error("imageUrl not found in response");e.imageUrlSubdomains&&(i.subdomains=e.imageUrlSubdomains),this._providers=e.imageryProviders?this._prepAttrBounds(e.imageryProviders):[],this._attributions=[],this._url=e.imageUrl,i.retinaDpi&&i.detectRetina&&i.zoomOffset&&(this._url+="&dpi="+i.retinaDpi),this.fire("load",{meta:t}),this._map&&this._update()}))},_prepAttrBounds:function(t){return t.forEach(function(t){t.coverageAreas.forEach(function(t){t.bounds=L.latLngBounds([t.bbox[0],t.bbox[1]],[t.bbox[2],t.bbox[3]])})}),t},_update:function(t){this._url&&(L.GridLayer.prototype._update.call(this,t),this._update_attribution())},_update_attribution:function(e){var i,r,t,o=this._map.attributionControl;o?(i=this._map.getBounds(),i=L.latLngBounds(i.getSouthWest().wrap(),i.getNorthEast().wrap()),r=this._getZoomForUrl(),(t=this._providers.map(function(t){return!e&&t.coverageAreas.some(function(t){return r<=t.zoomMax&&r>=t.zoomMin&&i.intersects(t.bounds)})})).forEach(function(t,e){t==this._attributions[e]||(t?o.addAttribution(this._providers[e].attribution):o.removeAttribution(this._providers[e].attribution))},this),this._attributions=t):this._attributions={}},onAdd:function(t){this.loadMetadata(),L.GridLayer.prototype.onAdd.call(this,t)},onRemove:function(t){this._providers&&this._update_attribution(!0),L.GridLayer.prototype.onRemove.call(this,t)}}),L.bingLayer=function(t,e){return new L.BingLayer(t,e)};