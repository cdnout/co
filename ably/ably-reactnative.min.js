var Ably={},global="object"==typeof window&&window||"object"==typeof self&&self,CryptoJS=CryptoJS||function(l){var e={},t=e.lib={},n=t.Base={extend:function(e){o.prototype=this;var t=new o;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),(t.init.prototype=t).$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}};function o(){}var u=t.WordArray=n.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||i).stringify(this)},concat:function(e){var t=this.words,n=e.words,o=this.sigBytes,r=e.sigBytes;if(this.clamp(),o%4)for(var i=0;i<r;i++){var s=n[i>>>2]>>>24-i%4*8&255;t[o+i>>>2]|=s<<24-(o+i)%4*8}else if(65535<n.length)for(i=0;i<r;i+=4)t[o+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=r,this},clamp:function(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=l.ceil(t/4)},clone:function(){var e=n.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],n=0;n<e;n+=4){var o=function(t){var t=t,n=987654321,o=4294967295;return function(){var e=((n=36969*(65535&n)+(n>>16)&o)<<16)+(t=18e3*(65535&t)+(t>>16)&o)&o;return e/=4294967296,(e+=.5)*(.5<l.random()?1:-1)}}(4294967296*(r||l.random())),r=987654071*o();t.push(4294967296*o()|0)}return new u.init(t,e)}}),r=e.enc={},i=r.Hex={stringify:function(e){for(var t=e.words,n=e.sigBytes,o=[],r=0;r<n;r++){var i=t[r>>>2]>>>24-r%4*8&255;o.push((i>>>4).toString(16)),o.push((15&i).toString(16))}return o.join("")},parse:function(e){for(var t=e.length,n=[],o=0;o<t;o+=2)n[o>>>3]|=parseInt(e.substr(o,2),16)<<24-o%8*4;return new u.init(n,t/2)}},s=r.Latin1={stringify:function(e){for(var t=e.words,n=e.sigBytes,o=[],r=0;r<n;r++){var i=t[r>>>2]>>>24-r%4*8&255;o.push(String.fromCharCode(i))}return o.join("")},parse:function(e){for(var t=e.length,n=[],o=0;o<t;o++)n[o>>>2]|=(255&e.charCodeAt(o))<<24-o%4*8;return new u.init(n,t)}},a=r.Utf8={stringify:function(e){try{return decodeURIComponent(escape(s.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return s.parse(unescape(encodeURIComponent(e)))}},c=t.BufferedBlockAlgorithm=n.extend({reset:function(){this._data=new u.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=a.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(e){var t=this._data,n=t.words,o=t.sigBytes,r=this.blockSize,i=o/(4*r),s=(i=e?l.ceil(i):l.max((0|i)-this._minBufferSize,0))*r,o=l.min(4*s,o);if(s){for(var a=0;a<s;a+=r)this._doProcessBlock(n,a);var c=n.splice(0,s);t.sigBytes-=o}return new u.init(c,o)},clone:function(){var e=n.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),h=(t.Hasher=c.extend({cfg:n.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(n){return function(e,t){return new n.init(t).finalize(e)}},_createHmacHelper:function(n){return function(e,t){return new h.HMAC.init(n,t).finalize(e)}}}),e.algo={});return e}(Math);!function(r){var e=CryptoJS,t=e.lib,n=t.WordArray,o=t.Hasher,t=e.algo,i=[],d=[];!function(){function e(e){return 4294967296*(e-(0|e))|0}for(var t=2,n=0;n<64;)!function(e){for(var t=r.sqrt(e),n=2;n<=t;n++)if(!(e%n))return;return 1}(t)||(n<8&&(i[n]=e(r.pow(t,.5))),d[n]=e(r.pow(t,1/3)),n++),t++}();var m=[],t=t.SHA256=o.extend({_doReset:function(){this._hash=new n.init(i.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,o=n[0],r=n[1],i=n[2],s=n[3],a=n[4],c=n[5],l=n[6],u=n[7],h=0;h<64;h++){h<16?m[h]=0|e[t+h]:(p=((f=m[h-15])<<25|f>>>7)^(f<<14|f>>>18)^f>>>3,f=((g=m[h-2])<<15|g>>>17)^(g<<13|g>>>19)^g>>>10,m[h]=p+m[h-7]+f+m[h-16]);var g=o&r^o&i^r&i,p=(o<<30|o>>>2)^(o<<19|o>>>13)^(o<<10|o>>>22),f=u+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&c^~a&l)+d[h]+m[h],u=l,l=c,c=a,a=s+f|0,s=i,i=r,r=o,o=f+(p+g)|0}n[0]=n[0]+o|0,n[1]=n[1]+r|0,n[2]=n[2]+i|0,n[3]=n[3]+s|0,n[4]=n[4]+a|0,n[5]=n[5]+c|0,n[6]=n[6]+l|0,n[7]=n[7]+u|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,o=8*e.sigBytes;return t[o>>>5]|=128<<24-o%32,t[14+(64+o>>>9<<4)]=r.floor(n/4294967296),t[15+(64+o>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA256=o._createHelper(t),e.HmacSHA256=o._createHmacHelper(t)}(Math),function(){var e=CryptoJS.lib.Base,a=CryptoJS.enc.Utf8;CryptoJS.algo.HMAC=e.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=a.parse(t));var n=e.blockSize,o=4*n;t.sigBytes>o&&(t=e.finalize(t)),t.clamp();for(var e=this._oKey=t.clone(),t=this._iKey=t.clone(),r=e.words,i=t.words,s=0;s<n;s++)r[s]^=1549556828,i[s]^=909522486;e.sigBytes=t.sigBytes=o,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,e=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var l=CryptoJS.lib.WordArray;CryptoJS.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,o=this._map;e.clamp();for(var r=[],i=0;i<n;i+=3)for(var s=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,a=0;a<4&&i+.75*a<n;a++)r.push(o.charAt(s>>>6*(3-a)&63));var c=o.charAt(64);if(c)for(;r.length%4;)r.push(c);return r.join("")},parse:function(e){var t=e.length,n=this._map,o=n.charAt(64);!o||-1!=(o=e.indexOf(o))&&(t=o);for(var r,i,s=[],a=0,c=0;c<t;c++)c%4&&(r=n.indexOf(e.charAt(c-1))<<c%4*2,i=n.indexOf(e.charAt(c))>>>6-c%4*2,s[a>>>2]|=(r|i)<<24-a%4*8,a++);return l.create(s,a)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),CryptoJS.lib.Cipher||function(){var e=CryptoJS,t=e.lib,n=t.Base,s=t.WordArray,o=t.BufferedBlockAlgorithm,r=e.enc,i=(r.Utf8,r.Base64),a=e.algo.EvpKDF,c=t.Cipher=o.extend({cfg:n.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,n){this.cfg=this.cfg.extend(n),this._xformMode=e,this._key=t,this.reset()},reset:function(){o.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(o){return{encrypt:function(e,t,n){return l(t).encrypt(o,e,t,n)},decrypt:function(e,t,n){return l(t).decrypt(o,e,t,n)}}}});function l(e){return"string"==typeof e?f:p}t.StreamCipher=c.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var u=e.mode={},r=t.BlockCipherMode=n.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}}),r=u.CBC=((u=r.extend()).Encryptor=u.extend({processBlock:function(e,t){var n=this._cipher,o=n.blockSize;h.call(this,e,t,o),n.encryptBlock(e,t),this._prevBlock=e.slice(t,t+o)}}),u.Decryptor=u.extend({processBlock:function(e,t){var n=this._cipher,o=n.blockSize,r=e.slice(t,t+o);n.decryptBlock(e,t),h.call(this,e,t,o),this._prevBlock=r}}),u);function h(e,t,n){var o,r=this._iv;r?(o=r,this._iv=void 0):o=this._prevBlock;for(var i=0;i<n;i++)e[t+i]^=o[i]}var u=(e.pad={}).Pkcs7={pad:function(e,t){for(var t=4*t,n=t-e.sigBytes%t,o=n<<24|n<<16|n<<8|n,r=[],i=0;i<n;i+=4)r.push(o);t=s.create(r,n);e.concat(t)},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}},g=(t.BlockCipher=c.extend({cfg:c.cfg.extend({mode:r,padding:u}),reset:function(){c.reset.call(this);var e,t=this.cfg,n=t.iv,t=t.mode;this._xformMode==this._ENC_XFORM_MODE?e=t.createEncryptor:(e=t.createDecryptor,this._minBufferSize=1),this._mode=e.call(t,this,n&&n.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e,t=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(t.pad(this._data,this.blockSize),e=this._process(!0)):(e=this._process(!0),t.unpad(e)),e},blockSize:4}),t.CipherParams=n.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}})),u=(e.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,e=e.salt;return(e?s.create([1398893684,1701076831]).concat(e).concat(t):t).toString(i)},parse:function(e){var t,n=i.parse(e),e=n.words;return 1398893684==e[0]&&1701076831==e[1]&&(t=s.create(e.slice(2,4)),e.splice(0,4),n.sigBytes-=16),g.create({ciphertext:n,salt:t})}},p=t.SerializableCipher=n.extend({cfg:n.extend({format:u}),encrypt:function(e,t,n,o){o=this.cfg.extend(o);var r=e.createEncryptor(n,o),t=r.finalize(t),r=r.cfg;return g.create({ciphertext:t,key:n,iv:r.iv,algorithm:e,mode:r.mode,padding:r.padding,blockSize:e.blockSize,formatter:o.format})},decrypt:function(e,t,n,o){return o=this.cfg.extend(o),t=this._parse(t,o.format),e.createDecryptor(n,o).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),e=(e.kdf={}).OpenSSL={execute:function(e,t,n,o){o=o||s.random(8);e=a.create({keySize:t+n}).compute(e,o),n=s.create(e.words.slice(t),4*n);return e.sigBytes=4*t,g.create({key:e,iv:n,salt:o})}},f=t.PasswordBasedCipher=p.extend({cfg:p.cfg.extend({kdf:e}),encrypt:function(e,t,n,o){n=(o=this.cfg.extend(o)).kdf.execute(n,e.keySize,e.ivSize);o.iv=n.iv;o=p.encrypt.call(this,e,t,n.key,o);return o.mixIn(n),o},decrypt:function(e,t,n,o){o=this.cfg.extend(o),t=this._parse(t,o.format);n=o.kdf.execute(n,e.keySize,e.ivSize,t.salt);return o.iv=n.iv,p.decrypt.call(this,e,t,n.key,o)}})}(),function(){var e=CryptoJS,t=e.lib.BlockCipher,n=e.algo,l=[],u=[],h=[],g=[],p=[],f=[],d=[],m=[],y=[],v=[];!function(){for(var e=[],t=0;t<256;t++)e[t]=t<128?t<<1:t<<1^283;for(var n=0,o=0,t=0;t<256;t++){var r=(r=o^o<<1^o<<2^o<<3^o<<4)>>>8^255&r^99;l[n]=r;var i=e[u[r]=n],s=e[i],a=e[s],c=257*e[r]^16843008*r;h[n]=c<<24|c>>>8,g[n]=c<<16|c>>>16,p[n]=c<<8|c>>>24,f[n]=c;c=16843009*a^65537*s^257*i^16843008*n;d[r]=c<<24|c>>>8,m[r]=c<<16|c>>>16,y[r]=c<<8|c>>>24,v[r]=c,n?(n=i^e[e[e[a^i]]],o^=e[e[o]]):n=o=1}}();var L=[0,1,2,4,8,16,32,64,128,27,54],n=n.AES=t.extend({_doReset:function(){for(var e=this._key,t=e.words,n=e.sigBytes/4,o=4*(1+(this._nRounds=6+n)),r=this._keySchedule=[],i=0;i<o;i++)i<n?r[i]=t[i]:(c=r[i-1],i%n?6<n&&i%n==4&&(c=l[c>>>24]<<24|l[c>>>16&255]<<16|l[c>>>8&255]<<8|l[255&c]):(c=l[(c=c<<8|c>>>24)>>>24]<<24|l[c>>>16&255]<<16|l[c>>>8&255]<<8|l[255&c],c^=L[i/n|0]<<24),r[i]=r[i-n]^c);for(var s=this._invKeySchedule=[],a=0;a<o;a++){var c,i=o-a;c=a%4?r[i]:r[i-4],s[a]=a<4||i<=4?c:d[l[c>>>24]]^m[l[c>>>16&255]]^y[l[c>>>8&255]]^v[l[255&c]]}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,h,g,p,f,l)},decryptBlock:function(e,t){var n=e[t+1];e[t+1]=e[t+3],e[t+3]=n,this._doCryptBlock(e,t,this._invKeySchedule,d,m,y,v,u);n=e[t+1];e[t+1]=e[t+3],e[t+3]=n},_doCryptBlock:function(e,t,n,o,r,i,s,a){for(var c=this._nRounds,l=e[t]^n[0],u=e[t+1]^n[1],h=e[t+2]^n[2],g=e[t+3]^n[3],p=4,f=1;f<c;f++)var d=o[l>>>24]^r[u>>>16&255]^i[h>>>8&255]^s[255&g]^n[p++],m=o[u>>>24]^r[h>>>16&255]^i[g>>>8&255]^s[255&l]^n[p++],y=o[h>>>24]^r[g>>>16&255]^i[l>>>8&255]^s[255&u]^n[p++],v=o[g>>>24]^r[l>>>16&255]^i[u>>>8&255]^s[255&h]^n[p++],l=d,u=m,h=y,g=v;d=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[h>>>8&255]<<8|a[255&g])^n[p++],m=(a[u>>>24]<<24|a[h>>>16&255]<<16|a[g>>>8&255]<<8|a[255&l])^n[p++],y=(a[h>>>24]<<24|a[g>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^n[p++],v=(a[g>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&h])^n[p++];e[t]=d,e[t+1]=m,e[t+2]=y,e[t+3]=v},keySize:8});e.AES=t._createHelper(n)}(),function(){var e,r;"undefined"!=typeof ArrayBuffer&&(e=CryptoJS.lib.WordArray,r=e.init,(e.init=function(e){if(e instanceof ArrayBuffer?e=new Uint8Array(e):(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||"undefined"!=typeof Float32Array&&e instanceof Float32Array||"undefined"!=typeof Float64Array&&e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var t=e.byteLength,n=[],o=0;o<t;o++)n[o>>>2]|=e[o]<<24-o%4*8;r.call(this,n,t)}else r.apply(this,arguments)}).prototype=e)}();var msgpack=function(){"use strict";var e={};function g(e,t,n){e.byteLength;for(var o=0,r=n.length;o<r;o++){var i=n.charCodeAt(o);if(i<128)e.setUint8(t++,i>>>0&127|0);else if(i<2048)e.setUint8(t++,i>>>6&31|192),e.setUint8(t++,i>>>0&63|128);else if(i<65536)e.setUint8(t++,i>>>12&15|224),e.setUint8(t++,i>>>6&63|128),e.setUint8(t++,i>>>0&63|128);else{if(!(i<1114112))throw new Error("bad codepoint "+i);e.setUint8(t++,i>>>18&7|240),e.setUint8(t++,i>>>12&63|128),e.setUint8(t++,i>>>6&63|128),e.setUint8(t++,i>>>0&63|128)}}}function n(e,t,n){for(var o="",r=t,i=t+n;r<i;r++){var s=e.getUint8(r);if(0!=(128&s))if(192!=(224&s))if(224!=(240&s)){if(240!=(248&s))throw new Error("Invalid byte "+s.toString(16));o+=String.fromCharCode((7&s)<<18|(63&e.getUint8(++r))<<12|(63&e.getUint8(++r))<<6|(63&e.getUint8(++r))<<0)}else o+=String.fromCharCode((15&s)<<12|(63&e.getUint8(++r))<<6|(63&e.getUint8(++r))<<0);else o+=String.fromCharCode((15&s)<<6|63&e.getUint8(++r));else o+=String.fromCharCode(s)}return o}function p(e){for(var t=0,n=0,o=e.length;n<o;n++){var r=e.charCodeAt(n);if(r<128)t+=1;else if(r<2048)t+=2;else if(r<65536)t+=3;else{if(!(r<1114112))throw new Error("bad codepoint "+r);t+=4}}return t}e.inspect=function(e){if(void 0===e)return"undefined";var t,n;e instanceof ArrayBuffer?(n="ArrayBuffer",t=new DataView(e)):e instanceof DataView&&(n="DataView",t=e);if(!t)return JSON.stringify(e);for(var o=[],r=0;r<e.byteLength;r++){if(20<r){o.push("...");break}var i=t.getUint8(r).toString(16);1===i.length&&(i="0"+i),o.push(i)}return"<"+n+" "+o.join(" ")+">"},e.utf8Write=g,e.utf8Read=n,e.utf8ByteCount=p,e.encode=function(e,t){var n=function e(t,n){var o=typeof t;if("string"==o){var r=p(t);if(r<32)return 1+r;if(r<256)return 2+r;if(r<65536)return 3+r;if(r<4294967296)return 5+r}ArrayBuffer.isView&&ArrayBuffer.isView(t)&&(t=t.buffer);if(t instanceof ArrayBuffer){var r=t.byteLength;if(r<256)return 2+r;if(r<65536)return 3+r;if(r<4294967296)return 5+r}if("number"==o){if(Math.floor(t)!==t)return 9;if(0<=t){if(t<128)return 1;if(t<256)return 2;if(t<65536)return 3;if(t<4294967296)return 5;if(t<0x10000000000000000)return 9;throw new Error("Number too big 0x"+t.toString(16))}if(-32<=t)return 1;if(-128<=t)return 2;if(-32768<=t)return 3;if(-2147483648<=t)return 5;if(-0x8000000000000000<=t)return 9;throw new Error("Number too small -0x"+t.toString(16).substr(1))}if("boolean"==o)return 1;if(null===t)return n?0:1;if(void 0===t)return n?0:3;if("function"==typeof t.toJSON)return e(t.toJSON(),n);if("object"==o){var i=0;if(Array.isArray(t)){r=t.length;for(var s=0;s<r;s++)i+=e(t[s],n)}else{var a=m(t,n);r=a.length;for(var s=0;s<r;s++){var c=a[s];i+=e(c)+e(t[c],n)}}if(r<16)return 1+i;if(r<65536)return 3+i;if(r<4294967296)return 5+i;throw new Error("Array or object too long 0x"+r.toString(16))}if("function"==o)return 0;throw new Error("Unknown type "+o)}(e,t);if(0!=n){n=new ArrayBuffer(n);return function e(t,n,o,r){var i=typeof t;if("string"==i){var s=p(t);if(s<32)return n.setUint8(o,160|s),g(n,o+1,t),1+s;if(s<256)return n.setUint8(o,217),n.setUint8(o+1,s),g(n,o+2,t),2+s;if(s<65536)return n.setUint8(o,218),n.setUint16(o+1,s),g(n,o+3,t),3+s;if(s<4294967296)return n.setUint8(o,219),n.setUint32(o+1,s),g(n,o+5,t),5+s}ArrayBuffer.isView&&ArrayBuffer.isView(t)&&(t=t.buffer);if(t instanceof ArrayBuffer){var s=t.byteLength;if(s<256)return n.setUint8(o,196),n.setUint8(o+1,s),new Uint8Array(n.buffer).set(new Uint8Array(t),o+2),2+s;if(s<65536)return n.setUint8(o,197),n.setUint16(o+1,s),new Uint8Array(n.buffer).set(new Uint8Array(t),o+3),3+s;if(s<4294967296)return n.setUint8(o,198),n.setUint32(o+1,s),new Uint8Array(n.buffer).set(new Uint8Array(t),o+5),5+s}if("number"==i){if(Math.floor(t)!==t)return n.setUint8(o,203),n.setFloat64(o+1,t),9;if(0<=t){if(t<128)return n.setUint8(o,t),1;if(t<256)return n.setUint8(o,204),n.setUint8(o+1,t),2;if(t<65536)return n.setUint8(o,205),n.setUint16(o+1,t),3;if(t<4294967296)return n.setUint8(o,206),n.setUint32(o+1,t),5;if(t<0x10000000000000000)return n.setUint8(o,207),d(n,o+1,t),9;throw new Error("Number too big 0x"+t.toString(16))}if(-32<=t)return n.setInt8(o,t),1;if(-128<=t)return n.setUint8(o,208),n.setInt8(o+1,t),2;if(-32768<=t)return n.setUint8(o,209),n.setInt16(o+1,t),3;if(-2147483648<=t)return n.setUint8(o,210),n.setInt32(o+1,t),5;if(-0x8000000000000000<=t)return n.setUint8(o,211),f(n,o+1,t),9;throw new Error("Number too small -0x"+(-t).toString(16).substr(1))}if("undefined"==i)return r?0:(n.setUint8(o,212),n.setUint8(o+1,0),n.setUint8(o+2,0),3);if(null===t)return r?0:(n.setUint8(o,192),1);if("boolean"==i)return n.setUint8(o,t?195:194),1;if("function"==typeof t.toJSON)return e(t.toJSON(),n,o,r);if("object"==i){var a,c=0,l=Array.isArray(t);if((s=l?t.length:(a=m(t,r)).length)<16?(n.setUint8(o,s|(l?144:128)),c=1):s<65536?(n.setUint8(o,l?220:222),n.setUint16(o+1,s),c=3):s<4294967296&&(n.setUint8(o,l?221:223),n.setUint32(o+1,s),c=5),l)for(var u=0;u<s;u++)c+=e(t[u],n,o+c,r);else for(var u=0;u<s;u++){var h=a[u];c+=e(h,n,o+c),c+=e(t[h],n,o+c,r)}return c}if("function"==i)return 0;throw new Error("Unknown type "+i)}(e,new DataView(n),0,t),n}},e.decode=function(e){var t=new r(new DataView(e)),n=t.parse();if(t.offset!==e.byteLength)throw new Error(e.byteLength-t.offset+" trailing bytes");return n};var i=4294967296,o=1/i;function f(e,t,n){n<0x8000000000000000?(e.setInt32(t,Math.floor(n*o)),e.setInt32(t+4,-1&n)):(e.setUint32(t,2147483647),e.setUint32(t+4,2147483647))}function d(e,t,n){n<0x10000000000000000?(e.setUint32(t,Math.floor(n*o)),e.setInt32(t+4,-1&n)):(e.setUint32(t,4294967295),e.setUint32(t+4,4294967295))}function r(e,t){this.offset=t||0,this.view=e}function m(t,n){return Utils.keysArray(t,!0).filter(function(e){e=t[e];return!(n&&null==e||"function"==typeof e&&!e.toJSON)})}return r.prototype.map=function(e){for(var t={},n=0;n<e;n++)t[this.parse()]=this.parse();return t},r.prototype.bin=r.prototype.buf=function(e){var t=new ArrayBuffer(e);return new Uint8Array(t).set(new Uint8Array(this.view.buffer,this.offset,e),0),this.offset+=e,t},r.prototype.str=function(e){var t=n(this.view,this.offset,e);return this.offset+=e,t},r.prototype.array=function(e){for(var t=new Array(e),n=0;n<e;n++)t[n]=this.parse();return t},r.prototype.ext=function(e){var t={};return t.type=this.view.getInt8(this.offset),this.offset++,t.data=this.buf(e),this.offset+=e,t},r.prototype.parse=function(){var e,t,n,o,r=this.view.getUint8(this.offset);if(0==(128&r))return this.offset++,r;if(128==(240&r))return t=15&r,this.offset++,this.map(t);if(144==(240&r))return t=15&r,this.offset++,this.array(t);if(160==(224&r))return t=31&r,this.offset++,this.str(t);if(224==(224&r))return e=this.view.getInt8(this.offset),this.offset++,e;switch(r){case 192:return this.offset++,null;case 193:return void this.offset++;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return t=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(t);case 197:return t=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(t);case 198:return t=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(t);case 199:return t=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(t);case 200:return t=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(t);case 201:return t=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(t);case 202:return e=this.view.getFloat32(this.offset+1),this.offset+=5,e;case 203:return e=this.view.getFloat64(this.offset+1),this.offset+=9,e;case 204:return e=this.view.getUint8(this.offset+1),this.offset+=2,e;case 205:return e=this.view.getUint16(this.offset+1),this.offset+=3,e;case 206:return e=this.view.getUint32(this.offset+1),this.offset+=5,e;case 207:return n=this.view,o=(o=this.offset+1)||0,e=n.getUint32(o)*i+n.getUint32(o+4),this.offset+=9,e;case 208:return e=this.view.getInt8(this.offset+1),this.offset+=2,e;case 209:return e=this.view.getInt16(this.offset+1),this.offset+=3,e;case 210:return e=this.view.getInt32(this.offset+1),this.offset+=5,e;case 211:return n=this.view,o=(o=this.offset+1)||0,e=n.getInt32(o)*i+n.getUint32(o+4),this.offset+=9,e;case 212:return t=1,this.offset++,this.ext(t);case 213:return t=2,this.offset++,this.ext(t);case 214:return t=4,this.offset++,this.ext(t);case 215:return t=8,this.offset++,this.ext(t);case 216:return t=16,this.offset++,this.ext(t);case 217:return t=this.view.getUint8(this.offset+1),this.offset+=2,this.str(t);case 218:return t=this.view.getUint16(this.offset+1),this.offset+=3,this.str(t);case 219:return t=this.view.getUint32(this.offset+1),this.offset+=5,this.str(t);case 220:return t=this.view.getUint16(this.offset+1),this.offset+=3,this.array(t);case 221:return t=this.view.getUint32(this.offset+1),this.offset+=5,this.array(t);case 222:return t=this.view.getUint16(this.offset+1),this.offset+=3,this.map(t);case 223:return t=this.view.getUint32(this.offset+1),this.offset+=5,this.map(t)}throw new Error("Unknown type 0x"+r.toString(16))},e}(),Platform={libver:"js-rn",logTimestamps:!0,noUpgrade:!1,binaryType:"arraybuffer",WebSocket:WebSocket,xhrSupported:XMLHttpRequest,allowComet:!0,jsonpSupported:!1,streamingSupported:!0,useProtocolHeartbeats:!0,createHmac:null,msgpack:msgpack,supportsBinary:"undefined"!=typeof TextDecoder&&TextDecoder,preferBinary:!1,ArrayBuffer:"undefined"!=typeof ArrayBuffer&&ArrayBuffer,atob:global.atob,nextTick:function(e){setTimeout(e,0)},addEventListener:null,inspect:JSON.stringify,stringByteSize:function(e){return"undefined"!=typeof TextDecoder&&(new TextEncoder).encode(e).length||e.length},TextEncoder:global.TextEncoder,TextDecoder:global.TextDecoder,Promise:global.Promise,getRandomWordArray:function(t){return function(e,n){t.randomBytes(e,function(e,t){n(e,!e&&CryptoJS.enc.Base64.parse(t))})}}(require("react-native").NativeModules.RNRandomBytes)},Crypto=function(){var o,c,i=CryptoJS.lib.WordArray;c=Platform.getRandomWordArray||("undefined"!=typeof Uint32Array&&Platform.getRandomValues?(o=new Uint32Array(4),function(e,t){var e=e/4,n=4==e?o:new Uint32Array(e);Platform.getRandomValues(n,function(e){t(e,BufferUtils.toWordArray(n))})}):function(e,t){Logger.logAction(Logger.LOG_MAJOR,"Ably.Crypto.generateRandom()","Warning: the browser you are using does not support secure cryptographically secure randomness generation; falling back to insecure Math.random()");for(var n=e/4,o=new Array(n),r=0;r<n;r++)o[r]=Math.floor(4294967296*Math.random())-2147483648;t(null,i.create(o))});i.create([0,0,0,0]);var l=[i.create([269488144,269488144,269488144,269488144],16),i.create([16777216],1),i.create([33685504],2),i.create([50529024],3),i.create([67372036],4),i.create([84215045,83886080],5),i.create([101058054,101056512],6),i.create([117901063,117901056],7),i.create([134744072,134744072],8),i.create([151587081,151587081,150994944],9),i.create([168430090,168430090,168427520],10),i.create([185273099,185273099,185273088],11),i.create([202116108,202116108,202116108],12),i.create([218959117,218959117,218959117,218103808],13),i.create([235802126,235802126,235802126,235798528],14),i.create([252645135,252645135,252645135,252645135],15),i.create([269488144,269488144,269488144,269488144],16)];function r(){}function s(){this.algorithm=null,this.keyLength=null,this.mode=null,this.key=null}function n(e,t,n){this.algorithm=e.algorithm+"-"+String(e.keyLength)+"-"+e.mode,this.cjsAlgorithm=e.algorithm.toUpperCase().replace(/-\d+$/,""),this.key=BufferUtils.toWordArray(e.key),n&&(this.iv=BufferUtils.toWordArray(n).clone()),this.blockLengthWords=t}return r.CipherParams=s,r.getDefaultParams=function(t){var e;if("function"!=typeof t&&"string"!=typeof t){if(!t.key)throw new Error("Crypto.getDefaultParams: a key is required");e="string"==typeof t.key?CryptoJS.enc.Base64.parse(t.key.replace("_","/").replace("-","+")):BufferUtils.toWordArray(t.key);var n=new s;if(n.key=e,n.algorithm=t.algorithm||"aes",n.keyLength=32*e.words.length,n.mode=t.mode||"cbc",t.keyLength&&t.keyLength!==n.keyLength)throw new Error("Crypto.getDefaultParams: a keyLength of "+t.keyLength+" was specified, but the key actually has length "+n.keyLength);return function(e){if("aes"===e.algorithm&&"cbc"===e.mode&&128!==e.keyLength&&256!==e.keyLength)throw new Error("Unsupported key length "+e.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}(n),n}if(Logger.deprecated("Crypto.getDefaultParams(key, callback)","Crypto.getDefaultParams({key: key})"),"function"==typeof t)r.generateRandomKey(function(e){t(null,r.getDefaultParams({key:e}))});else{if("function"!=typeof arguments[1])throw new Error("Invalid arguments for Crypto.getDefaultParams");arguments[1](null,r.getDefaultParams({key:t}))}},r.generateRandomKey=function(e,t){1==arguments.length&&"function"==typeof e&&(t=e,e=void 0),c((e||256)/8,t)},r.getCipher=function(e){var t=e instanceof s?e:r.getDefaultParams(e);return{cipherParams:t,cipher:new n(t,4,e.iv)}},n.prototype.encrypt=function(n,o){Logger.logAction(Logger.LOG_MICRO,"CBCCipher.encrypt()","");function r(){a.getIv(function(e,t){e?o(e):(e=a.encryptCipher.process(n.concat(l[s-i])),e=t.concat(e),o(null,e))})}var i=(n=BufferUtils.toWordArray(n)).sigBytes,s=i+16&-16,a=this;this.encryptCipher?r():this.iv?(this.encryptCipher=CryptoJS.algo[this.cjsAlgorithm].createEncryptor(this.key,{iv:this.iv}),r()):c(16,function(e,t){e?o(e):(a.encryptCipher=CryptoJS.algo[a.cjsAlgorithm].createEncryptor(a.key,{iv:t}),a.iv=t,r())})},n.prototype.decrypt=function(e){Logger.logAction(Logger.LOG_MICRO,"CBCCipher.decrypt()",""),e=BufferUtils.toWordArray(e);var t=this.blockLengthWords,n=e.words,e=i.create(n.slice(0,t)),n=i.create(n.slice(t)),t=CryptoJS.algo[this.cjsAlgorithm].createDecryptor(this.key,{iv:e}),e=t.process(n),n=t.finalize();return t.reset(),n&&n.sigBytes&&e.concat(n),e},n.prototype.getIv=function(n){if(this.iv){var e=this.iv;return this.iv=null,void n(null,e)}var o=this;c(16,function(e,t){e?n(e):n(null,o.encryptCipher.process(t))})},r}(),WebStorage=function(){var t,n,e="ablyjs-storage-test";try{global.sessionStorage.setItem(e,e),global.sessionStorage.removeItem(e),t=!0}catch(e){t=!1}try{global.localStorage.setItem(e,e),global.localStorage.removeItem(e),n=!0}catch(e){n=!1}function o(){}function r(e){return e?global.sessionStorage:global.localStorage}function i(e,t,n,o){t={value:t};return n&&(t.expires=Utils.now()+n),r(o).setItem(e,JSON.stringify(t))}function s(e,t){var n=r(t).getItem(e);if(!n)return null;n=JSON.parse(n);return n.expires&&n.expires<Utils.now()?(r(t).removeItem(e),null):n.value}function a(e,t){return r(t).removeItem(e)}return n&&(o.set=function(e,t,n){return i(e,t,n,!1)},o.get=function(e){return s(e,!1)},o.remove=function(e){return a(e,!1)}),t&&(o.setSession=function(e,t,n){return i(e,t,n,!0)},o.getSession=function(e){return s(e,!0)},o.removeSession=function(e){return a(e,!0)}),o}(),Defaults={internetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",jsonpInternetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up-0-9.js",defaultTransports:["xhr_polling","xhr_streaming","jsonp","web_socket"],baseTransportOrder:["xhr_polling","xhr_streaming","jsonp","web_socket"],transportPreferenceOrder:["jsonp","xhr_polling","xhr_streaming","web_socket"],upgradeTransports:["xhr_streaming","web_socket"]};Platform.noUpgrade&&(Defaults.upgradeTransports=[]);var BufferUtils=function(){var t=CryptoJS.lib.WordArray,r=Platform.ArrayBuffer,s=Platform.atob,n=Platform.TextEncoder,o=Platform.TextDecoder,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function i(e){return null!=e&&void 0!==e.sigBytes}function a(e){return null!=e&&e.constructor===r}function l(e){return r&&r.isView&&r.isView(e)}function u(){}u.base64CharSet=c,u.hexCharSet="0123456789abcdef";var h=u.isBuffer=function(e){return a(e)||i(e)||l(e)},g=u.toBuffer=function(e){if(!r)throw new Error("Can't convert to Buffer: browser does not support the necessary types");if(a(e))return new Uint8Array(e);if(l(e))return new Uint8Array(e.buffer);if(i(e)){for(var t=new r(e.sigBytes),n=new Uint8Array(t),o=0;o<e.sigBytes;o++)n[o]=e.words[o>>>2]>>>24-o%4*8&255;return n}throw new Error("BufferUtils.toBuffer expected an arraybuffer, typed array, or CryptoJS wordarray")};return u.toArrayBuffer=function(e){return a(e)?e:g(e).buffer},u.toWordArray=function(e){return l(e)&&(e=e.buffer),i(e)?e:t.create(e)},u.base64Encode=function(e){return i(e)?CryptoJS.enc.Base64.stringify(e):function(e){for(var t,n="",o=c,r=e.byteLength,i=r%3,s=r-i,a=0;a<s;a+=3)n+=o[(16515072&(t=e[a]<<16|e[a+1]<<8|e[a+2]))>>18]+o[(258048&t)>>12]+o[(4032&t)>>6]+o[63&t];return 1==i?n+=o[(252&(t=e[s]))>>2]+o[(3&t)<<4]+"==":2==i&&(n+=o[(64512&(t=e[s]<<8|e[1+s]))>>10]+o[(1008&t)>>4]+o[(15&t)<<2]+"="),n}(g(e))},u.base64Decode=function(e){return r&&s?function(e){for(var t=s(e),n=t.length,o=new Uint8Array(n),r=0;r<n;r++){var i=t.charCodeAt(r);o[r]=i}return o.buffer}(e):CryptoJS.enc.Base64.parse(e)},u.hexEncode=function(e){return e=u.toWordArray(e),CryptoJS.enc.Hex.stringify(e)},u.hexDecode=function(e){e=CryptoJS.enc.Hex.parse(e);return r?u.toArrayBuffer(e):e},u.utf8Encode=function(e){return n?(new n).encode(e).buffer:CryptoJS.enc.Utf8.parse(e)},u.utf8Decode=function(e){if(!h(e))throw new Error("Expected input of utf8decode to be an arraybuffer, typed array, or CryptoJS wordarray");return o&&!i(e)?(new o).decode(e):(e=u.toWordArray(e),CryptoJS.enc.Utf8.stringify(e))},u.bufferCompare=function(e,t){if(!e)return-1;if(!t)return 1;e=u.toWordArray(e),t=u.toWordArray(t),e.clamp(),t.clamp();var n=e.sigBytes-t.sigBytes;if(0!=n)return n;e=e.words,t=t.words;for(var o=0;o<e.length;o++)if(0!=(n=e[o]-t[o]))return n;return 0},u.byteLength=function(e){return a(e)||l(e)?e.byteLength:i(e)?e.sigBytes:void 0},u.typedArrayToBuffer=function(e){return e.buffer},u}(),Utils=function(){var n=Platform.msgpack;function s(){}function i(e){return Math.floor(Math.random()*e.length)}s.mixin=function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];if(!n)break;var o,r=n.hasOwnProperty;for(o in n)r&&!r.call(n,o)||(e[o]=n[o])}return e},s.copy=function(e){return s.mixin({},e)},s.isArray=Array.isArray||function(e){return"[object Array]"==Object.prototype.toString.call(e)},s.ensureArray=function(e){return s.isEmptyArg(e)?[]:s.isArray(e)?e:[e]},s.isObject=function(e){return"[object Object]"==Object.prototype.toString.call(e)},s.isEmpty=function(e){for(var t in e)return!1;return!0},s.isOnlyPropIn=function(e,t){for(var n in e)if(n!==t)return!1;return!0},s.isEmptyArg=function(e){return null==e},s.shallowClone=function(e){var t,n=new Object;for(t in e)n[t]=e[t];return n},s.prototypicalClone=function(e,t){function n(){}n.prototype=e;e=new n;return t&&s.mixin(e,t),e},s.inherits=Platform.inherits||function(e,t){e.super_=t,e.prototype=s.prototypicalClone(t.prototype,{constructor:e})},s.containsValue=function(e,t){for(var n in e)if(e[n]==t)return!0;return!1},s.intersect=function(e,t){return s.isArray(t)?s.arrIntersect(e,t):s.arrIntersectOb(e,t)},s.arrIntersect=function(e,t){for(var n=[],o=0;o<e.length;o++){var r=e[o];-1!=s.arrIndexOf(t,r)&&n.push(r)}return n},s.arrIntersectOb=function(e,t){for(var n=[],o=0;o<e.length;o++){var r=e[o];r in t&&n.push(r)}return n},s.arrSubtract=function(e,t){for(var n=[],o=0;o<e.length;o++){var r=e[o];-1==s.arrIndexOf(t,r)&&n.push(r)}return n},s.arrIndexOf=Array.prototype.indexOf?function(e,t,n){return e.indexOf(t,n)}:function(e,t,n){n=n||0;for(var o=e.length;n<o;n++)if(e[n]===t)return n;return-1},s.arrIn=function(e,t){return-1!==s.arrIndexOf(e,t)},s.arrDeleteValue=function(e,t){var n=s.arrIndexOf(e,t),t=-1!=n;return t&&e.splice(n,1),t},s.arrWithoutValue=function(e,t){e=e.slice();return s.arrDeleteValue(e,t),e},s.keysArray=function(e,t){var n,o=[];for(n in e)t&&!e.hasOwnProperty(n)||o.push(n);return o},s.valuesArray=function(e,t){var n,o=[];for(n in e)t&&!e.hasOwnProperty(n)||o.push(e[n]);return o},s.forInOwnNonNullProps=function(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&e[n]&&t(n)},s.arrForEach=Array.prototype.forEach?function(e,t){e.forEach(t)}:function(e,t){for(var n=e.length,o=0;o<n;o++)t(e[o],o,e)},s.safeArrForEach=function(e,t){return s.arrForEach(e.slice(),t)},s.arrMap=Array.prototype.map?function(e,t){return e.map(t)}:function(e,t){for(var n=[],o=e.length,r=0;r<o;r++)n.push(t(e[r],r,e));return n},s.arrFilter=Array.prototype.filter?function(e,t){return e.filter(t)}:function(e,t){for(var n=[],o=e.length,r=0;r<o;r++)t(e[r])&&n.push(e[r]);return n},s.arrEvery=Array.prototype.every?function(e,t){return e.every(t)}:function(e,t){for(var n=e.length,o=0;o<n;o++)if(!t(e[o],o,e))return!1;return!0},s.allSame=function(e,t){if(0===e.length)return!0;var n=e[0][t];return s.arrEvery(e,function(e){return e[t]===n})},s.nextTick=Platform.nextTick;var t={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};return s.defaultGetHeaders=function(e){return{accept:t[e||"json"],"X-Ably-Version":Defaults.apiVersion,"X-Ably-Lib":Defaults.libstring}},s.defaultPostHeaders=function(e){return{accept:e=t[e||"json"],"content-type":e,"X-Ably-Version":Defaults.apiVersion,"X-Ably-Lib":Defaults.libstring}},s.arrPopRandomElement=function(e){return e.splice(i(e),1)[0]},s.toQueryString=function(e){var t=[];if(e)for(var n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.length?"?"+t.join("&"):""},s.parseQueryString=function(e){for(var t,n=/([^?&=]+)=?([^&]*)/g,o={};t=n.exec(e);)o[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return o},s.now=Date.now||function(){return(new Date).getTime()},s.inspect=Platform.inspect,s.isErrorInfo=function(e){return"ErrorInfo"==e.constructor.name},s.inspectError=function(e){return e&&(s.isErrorInfo(e)||"Error"==e.constructor.name||e instanceof Error)?e.toString():s.inspect(e)},s.inspectBody=function(e){return BufferUtils.isBuffer(e)?e.toString():"string"==typeof e?e:Platform.inspect(e)},s.dataSizeBytes=function(e){if(BufferUtils.isBuffer(e))return BufferUtils.byteLength(e);if("string"==typeof e)return Platform.stringByteSize(e);throw new Error("Expected input of Utils.dataSizeBytes to be a buffer or string, but was: "+typeof e)},s.cheapRandStr=function(){return String(Math.random()).substr(2)},s.randomString=Platform.getRandomValues&&"undefined"!=typeof Uint8Array?function(e){e=new Uint8Array(e);return Platform.getRandomValues(e),BufferUtils.base64Encode(e)}:function(e){for(var t=BufferUtils.base64CharSet,n=Math.round(4*e/3),o="",r=0;r<n;r++)o+=t[i(t)];return o},s.randomHexString=Platform.getRandomValues&&"undefined"!=typeof Uint8Array?function(e){e=new Uint8Array(e);return Platform.getRandomValues(e),BufferUtils.hexEncode(e)}:function(e){for(var t=BufferUtils.hexCharSet,n=2*e,o="",r=0;r<n;r++)o+=t[i(t)];return o},s.arrChooseN=function(e,t){for(var n=Math.min(t,e.length),o=e.slice(),r=[],i=0;i<n;i++)r.push(s.arrPopRandomElement(o));return r},s.trim=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},s.promisify=function(e,t,r){return new Promise(function(n,o){e[t].apply(e,Array.prototype.slice.call(r).concat(function(e,t){e?o(e):n(t)}))})},s.decodeBody=function(e,t){return"msgpack"==t?n.decode(e):JSON.parse(String(e))},s.encodeBody=function(e,t){return"msgpack"==t?n.encode(e,!0):JSON.stringify(e)},s.allToLowerCase=function(e){return s.arrMap(e,function(e){return e&&e.toLowerCase()})},s.allToUpperCase=function(e){return s.arrMap(e,function(e){return e&&e.toUpperCase()})},s}(),Http=function(){function h(){}function g(){}var p=Date.now||function(){return(new Date).getTime()};function f(e){var t=e.statusCode;return 408===t&&!e.code||400===t&&!e.code||500<=t&&t<=504}function d(e){var t=e.connection,t=t&&t.connectionManager.host;return t?[t].concat(Defaults.getFallbackHosts(e.options)):Defaults.getHosts(e.options)}return g._getHosts=d,g.methods=["get","delete","post","put","patch"],g.methodsWithoutBody=["get","delete"],g.methodsWithBody=Utils.arrSubtract(g.methods,g.methodsWithoutBody),Utils.arrForEach(g.methodsWithoutBody,function(i){g[i]=function(e,t,n,o,r){g.do(i,e,t,n,null,o,r)},g[i+"Uri"]=function(e,t,n,o,r){g.doUri(i,e,t,n,null,o,r)}}),Utils.arrForEach(g.methodsWithBody,function(s){g[s]=function(e,t,n,o,r,i){g.do(s,e,t,n,o,r,i)},g[s+"Uri"]=function(e,t,n,o,r,i){g.doUri(s,e,t,n,o,r,i)}}),g.do=function(e,r,t,i,s,a,c){c=c||h;var l="function"==typeof t?t:function(e){return r.baseUri(e)+t},n=(i&&i.accept,arguments),o=r._currentFallback;if(o){if(o.validUntil>p())return void g.Request(e,r,l(o.host),i,a,s,function(e){return e&&f(e)?(r._currentFallback=null,void g.do.apply(g,n)):void c.apply(null,arguments)});r._currentFallback=null}var u,o=d(r);1!=o.length?(u=function(t,n){var o=t.shift();g.doUri(e,r,l(o),i,s,a,function(e){e&&f(e)&&t.length?u(t,!0):(n&&(r._currentFallback={host:o,validUntil:p()+r.options.timeouts.fallbackRetryTimeout}),c.apply(null,arguments))})})(o):g.doUri(e,r,l(o[0]),i,s,a,c)},g.doUri=function(e,t,n,o,r,i,s){g.Request(e,t,n,o,i,r,s)},g.supportsAuthHeaders=!1,g.supportsLinkHeaders=!1,g}(),Base64=function(){function u(){this.buffer=[]}u.prototype.append=function(e){return this.buffer.push(e),this},u.prototype.toString=function(){return this.buffer.join("")};var h={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){for(var t=new u,n=h.codex,o=new g(e);o.moveNext();){var r=o.current;o.moveNext();var i=o.current;o.moveNext();var s=o.current,a=r>>2,c=(3&r)<<4|i>>4,l=(15&i)<<2|s>>6,r=63&s;isNaN(i)?l=r=64:isNaN(s)&&(r=64),t.append(n.charAt(a)+n.charAt(c)+n.charAt(l)+n.charAt(r))}return t.toString()},decode:function(e){for(var t=new u,n=new s(e);n.moveNext();){var o,r,i=n.current;i<128?t.append(String.fromCharCode(i)):191<i&&i<224?(n.moveNext(),o=n.current,t.append(String.fromCharCode((31&i)<<6|63&o))):(n.moveNext(),o=n.current,n.moveNext(),r=n.current,t.append(String.fromCharCode((15&i)<<12|(63&o)<<6|63&r)))}return t.toString()}};function g(e){this._input=e,this._index=-1,this._buffer=[]}function s(e){this._input=e,this._index=-1,this._buffer=[]}return g.prototype={current:Number.NaN,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=Number.NaN,!1;var e=this._input.charCodeAt(++this._index);return 13==e&&10==this._input.charCodeAt(this._index+1)&&(e=10,this._index+=2),e<128?this.current=e:(127<e&&e<2048?this.current=e>>6|192:(this.current=e>>12|224,this._buffer.push(e>>6&63|128)),this._buffer.push(63&e|128)),!0}},s.prototype={current:64,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return!(this.current=64);var e=h.codex.indexOf(this._input.charAt(++this._index)),t=h.codex.indexOf(this._input.charAt(++this._index)),n=h.codex.indexOf(this._input.charAt(++this._index)),o=h.codex.indexOf(this._input.charAt(++this._index)),r=e<<2|t>>4,e=(15&t)<<4|n>>2,t=(3&n)<<6|o;return this.current=r,64!=n&&this._buffer.push(e),64!=o&&this._buffer.push(t),!0}},h}();function checkHost(e){if("string"!=typeof e)throw new ErrorInfo("host must be a string; was a "+typeof e,4e4,400);if(!e.length)throw new ErrorInfo("host must not be zero-length",4e4,400)}Defaults.ENVIRONMENT="",Defaults.REST_HOST="rest.ably.io",Defaults.REALTIME_HOST="realtime.ably.io",Defaults.FALLBACK_HOSTS=["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],Defaults.PORT=80,Defaults.TLS_PORT=443,Defaults.TIMEOUTS={disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,preferenceConnectTimeout:6e3,parallelUpgradeDelay:6e3},Defaults.httpMaxRetryCount=3,Defaults.maxMessageSize=65536,Defaults.errorReportingUrl="https://errors.ably.io/api/15/store/",Defaults.errorReportingHeaders={"X-Sentry-Auth":"Sentry sentry_version=7, sentry_key=a04e33c8674c451f8a310fbec029acf5, sentry_client=ably-js/0.1","Content-Type":"application/json"},Defaults.version="1.2.4",Defaults.libstring=Platform.libver+"-"+Defaults.version,Defaults.apiVersion="1.2",Defaults.getHost=function(e,t,n){return t=n?t==e.restHost&&e.realtimeHost||t||e.realtimeHost:t||e.restHost},Defaults.getPort=function(e,t){return t||e.tls?e.tlsPort:e.port},Defaults.getHttpScheme=function(e){return e.tls?"https://":"http://"},Defaults.environmentFallbackHosts=function(e){return[e+"-a-fallback.ably-realtime.com",e+"-b-fallback.ably-realtime.com",e+"-c-fallback.ably-realtime.com",e+"-d-fallback.ably-realtime.com",e+"-e-fallback.ably-realtime.com"]},Defaults.getFallbackHosts=function(e){var t=e.fallbackHosts,e=(void 0!==e.httpMaxRetryCount?e:Defaults).httpMaxRetryCount;return t?Utils.arrChooseN(t,e):[]},Defaults.getHosts=function(e){return[e.restHost].concat(Defaults.getFallbackHosts(e))},Defaults.objectifyOptions=function(e){return"string"==typeof e?-1==e.indexOf(":")?{token:e}:{key:e}:e},Defaults.normaliseOptions=function(e){if(e.host&&(Logger.deprecated("host","restHost"),e.restHost=e.host),e.wsHost&&(Logger.deprecated("wsHost","realtimeHost"),e.realtimeHost=e.wsHost),e.queueEvents&&(Logger.deprecated("queueEvents","queueMessages"),e.queueMessages=e.queueEvents),e.fallbackHostsUseDefault){if(e.fallbackHosts){var t="fallbackHosts and fallbackHostsUseDefault cannot both be set";throw Logger.logAction(Logger.LOG_ERROR,"Defaults.normaliseOptions",t),new ErrorInfo(t,4e4,400)}if(e.port||e.tlsPort){t="fallbackHostsUseDefault cannot be set when port or tlsPort are set";throw Logger.logAction(Logger.LOG_ERROR,"Defaults.normaliseOptions",t),new ErrorInfo(t,4e4,400)}e.environment?Logger.deprecatedWithMsg("fallbackHostsUseDefault","There is no longer a need to set this when the environment option is also set since the library will now generate the correct fallback hosts using the environment option."):Logger.deprecated("fallbackHostsUseDefault","fallbackHosts: Ably.Defaults.FALLBACK_HOSTS"),e.fallbackHosts=Defaults.FALLBACK_HOSTS}!0===e.recover&&(Logger.deprecated("{recover: true}","{recover: function(lastConnectionDetails, cb) { cb(true); }}"),e.recover=function(e,t){t(!0)}),"function"==typeof e.recover&&!0===e.closeOnUnload&&(Logger.logAction(Logger.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),e.recover=null),"closeOnUnload"in e||(e.closeOnUnload=!e.recover),e.transports&&Utils.arrIn(e.transports,"xhr")&&(Logger.deprecated('transports: ["xhr"]','transports: ["xhr_streaming"]'),Utils.arrDeleteValue(e.transports,"xhr"),e.transports.push("xhr_streaming")),"queueMessages"in e||(e.queueMessages=!0);var n,o=e.environment&&String(e.environment).toLowerCase()||Defaults.ENVIRONMENT,t=!o||"production"===o;for(n in e.fallbackHosts||e.restHost||e.realtimeHost||e.port||e.tlsPort||(e.fallbackHosts=t?Defaults.FALLBACK_HOSTS:Defaults.environmentFallbackHosts(o)),e.realtimeHost||(e.restHost?(Logger.logAction(Logger.LOG_WARN,"Defaults.normaliseOptions",'restHost is set to "'+e.restHost+'" but realtimeHost is not set, so setting realtimeHost to "'+e.restHost+'" too. If this is not what you want, please set realtimeHost explicitly.'),e.realtimeHost=e.restHost):e.realtimeHost=t?Defaults.REALTIME_HOST:o+"-"+Defaults.REALTIME_HOST),e.restHost||(e.restHost=t?Defaults.REST_HOST:o+"-"+Defaults.REST_HOST),Utils.arrForEach((e.fallbackHosts||[]).concat(e.restHost,e.realtimeHost),checkHost),e.port=e.port||Defaults.PORT,e.tlsPort=e.tlsPort||Defaults.TLS_PORT,e.maxMessageSize=e.maxMessageSize||Defaults.maxMessageSize,"tls"in e||(e.tls=!0),e.timeouts={},Defaults.TIMEOUTS)e.timeouts[n]=e[n]||Defaults.TIMEOUTS[n];return"useBinaryProtocol"in e?e.useBinaryProtocol=Platform.supportsBinary&&e.useBinaryProtocol:e.useBinaryProtocol=Platform.preferBinary,e.clientId&&((e.headers=e.headers||{})["X-Ably-ClientId"]=BufferUtils.base64Encode(BufferUtils.utf8Encode(e.clientId))),"idempotentRestPublishing"in e||(e.idempotentRestPublishing=!0),e.promises&&!Platform.Promise&&(Logger.logAction(Logger.LOG_ERROR,"Defaults.normaliseOptions","{promises: true} was specified, but no Promise constructor found; disabling promises"),e.promises=!1),e};var EventEmitter=function(){function s(){this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={}}function a(e,t,n){try{t.apply(e,n)}catch(e){Logger.logAction(Logger.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+e+"; stack = "+(e&&e.stack))}}function c(e,t,n){for(var o,r,i,s=0;s<e.length;s++)if(o=e[s],n&&(o=o[n]),Utils.isArray(o)){for(;-1!==(r=Utils.arrIndexOf(o,t));)o.splice(r,1);n&&0===o.length&&delete e[s][n]}else if(Utils.isObject(o))for(i in o)o.hasOwnProperty(i)&&Utils.isArray(o[i])&&c([o],t,i)}return s.prototype.on=function(e,t){var n;1==arguments.length&&"function"==typeof e?this.any.push(e):Utils.isEmptyArg(e)?this.any.push(t):Utils.isArray(e)?(n=this,Utils.arrForEach(e,function(e){n.on(e,t)})):(this.events[e]||(this.events[e]=[])).push(t)},s.prototype.off=function(e,t){if(0==arguments.length||Utils.isEmptyArg(e)&&Utils.isEmptyArg(t))return this.any=[],this.events={},this.anyOnce=[],void(this.eventsOnce={});var n;1==arguments.length&&"function"==typeof e&&(t=e,e=null),t&&Utils.isEmptyArg(e)?c([this.any,this.events,this.anyOnce,this.eventsOnce],t):(Utils.isArray(e)&&(n=this,Utils.arrForEach(e,function(e){n.off(e,t)})),t?c([this.events,this.eventsOnce],t,e):(delete this.events[e],delete this.eventsOnce[e]))},s.prototype.listeners=function(e){if(e){var t=this.events[e]||[];return this.eventsOnce[e]&&Array.prototype.push.apply(t,this.eventsOnce[e]),t.length?t:null}return this.any.length?this.any:null},s.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments,1),n={event:e},o=[];this.anyOnce.length&&(Array.prototype.push.apply(o,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(o,this.any);var r=this.eventsOnce[e];r&&(Array.prototype.push.apply(o,r),delete this.eventsOnce[e]);r=this.events[e];r&&Array.prototype.push.apply(o,r),Utils.arrForEach(o,function(e){a(n,e,t)})},s.prototype.once=function(t,e){var n=arguments.length,o=this;if((0===n||1===n&&"function"!=typeof t)&&Platform.Promise)return new Platform.Promise(function(e){o.once(t,e)});if(1==arguments.length&&"function"==typeof t)this.anyOnce.push(t);else if(Utils.isEmptyArg(t))this.anyOnce.push(e);else{if(Utils.isArray(t))throw"Arrays of events can only be used with on(), not once()";(this.eventsOnce[t]||(this.eventsOnce[t]=[])).push(e)}},s.prototype.whenState=function(t,n,e){var o={event:t},r=this,i=Array.prototype.slice.call(arguments,3);if("string"!=typeof t||"string"!=typeof n)throw"whenState requires a valid event String argument";if("function"!=typeof e&&Platform.Promise)return new Platform.Promise(function(e){s.prototype.whenState.apply(r,[t,n,e].concat(i))});t===n?a(o,e,i):this.once(t,e)},s}(),Logger=function(){var e,t;function o(e,t){return("000"+e).slice(-2-(t||0))}"undefined"==typeof Window&&"undefined"==typeof WorkerGlobalScope||global.console&&global.console.log&&"function"==typeof global.console.log.apply?(e=function(){console.log.apply(console,arguments)},t=console.warn?function(){console.warn.apply(console,arguments)}:e):e=t=global.console&&global.console.log?function(){Function.prototype.apply.call(console.log,console,arguments)}:function(){};var n=1;function r(n){return Platform.logTimestamps?function(e){var t=new Date;n(o(t.getHours())+":"+o(t.getMinutes())+":"+o(t.getSeconds())+"."+o(t.getMilliseconds(),!0)+" "+e)}:n}var i=r(e),s=r(t);function a(e){}return a.LOG_NONE=0,a.LOG_ERROR=1,a.LOG_MAJOR=2,a.LOG_MINOR=3,a.LOG_MICRO=4,a.LOG_DEFAULT=1,a.LOG_DEBUG=4,a.logAction=function(e,t,n){a.shouldLog(e)&&(1===e?s:i)("Ably: "+t+": "+n)},a.deprecated=function(e,t){a.deprecatedWithMsg(e,"Please use '"+t+"' instead.")},a.deprecatedWithMsg=function(e,t){a.shouldLog(1)&&s("Ably: Deprecation warning - '"+e+"' is deprecated and will be removed from a future version. "+t)},a.shouldLog=function(e){return e<=n},a.setLog=function(e,t){void 0!==e&&(n=e),void 0!==t&&(i=s=t)},a}(),Multicaster=function(n){function e(){for(var e=0;e<n.length;e++){var t=n[e];if(t)try{t.apply(null,arguments)}catch(e){Logger.logAction(Logger.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+e+"; stack = "+e.stack)}}}return n=n||[],e.push=function(){Array.prototype.push.apply(n,arguments)},e},ErrorReporter=function(){function e(){}e.levels=["fatal","error","warning","info","debug"];return e.report=function(e,t,n,o){n={event_id:Utils.randomHexString(16),tags:Utils.mixin({lib:Platform.libver},o),platform:"javascript",level:e,release:Defaults.version,fingerprint:n&&[n],message:t,request:{headers:{"User-Agent":Platform.userAgent},url:Platform.currentUrl}};Logger.logAction(Logger.LOG_MICRO,"ErrorReporter","POSTing to error reporter: "+t),Http.postUri(null,Defaults.errorReportingUrl,Defaults.errorReportingHeaders,JSON.stringify(n),{},function(e,t){Logger.logAction(Logger.LOG_MICRO,"ErrorReporter","POSTing to error reporter resulted in: "+(e?Utils.inspectError(e):Utils.inspectBody(t)))})},e}(),ErrorInfo=function(){function n(e,t,n,o){this.message=e,this.code=t,this.statusCode=n,this.cause=o,this.href=void 0}return n.prototype.toString=function(){var e="["+this.constructor.name;return this.message&&(e+=": "+this.message),this.statusCode&&(e+="; statusCode="+this.statusCode),this.code&&(e+="; code="+this.code),this.cause&&(e+="; cause="+Utils.inspectError(this.cause)),!this.href||this.message&&-1<this.message.indexOf("help.ably.io")||(e+="; see "+this.href+" "),e+="]"},n.fromValues=function(e){var t=Utils.mixin(new n,e);return e instanceof Error&&(t.message=e.message),t.code&&!t.href&&(t.href="https://help.ably.io/error/"+t.code),t},n}(),Message=function(){function i(){this.name=void 0,this.id=void 0,this.timestamp=void 0,this.clientId=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.data=void 0,this.encoding=void 0,this.extras=void 0,this.size=void 0}function o(e){if(e&&e.cipher&&!e.cipher.channelCipher){if(!Crypto)throw new Error("Encryption not enabled; use ably.encryption.js instead");var t=Crypto.getCipher(e.cipher);e.cipher=t.cipherParams,e.channelCipher=t.cipher}}return i.prototype.toJSON=function(){var e,t={name:this.name,id:this.id,clientId:this.clientId,connectionId:this.connectionId,connectionKey:this.connectionKey,encoding:this.encoding,extras:this.extras},n=this.data;return n&&BufferUtils.isBuffer(n)&&(n=0<arguments.length?(e=this.encoding,t.encoding=e?e+"/base64":"base64",BufferUtils.base64Encode(n)):BufferUtils.toBuffer(n)),t.data=n,t},i.prototype.toString=function(){var e="[Message";return this.name&&(e+="; name="+this.name),this.id&&(e+="; id="+this.id),this.timestamp&&(e+="; timestamp="+this.timestamp),this.clientId&&(e+="; clientId="+this.clientId),this.connectionId&&(e+="; connectionId="+this.connectionId),this.encoding&&(e+="; encoding="+this.encoding),this.extras&&(e+="; extras ="+JSON.stringify(this.extras)),this.data&&("string"==typeof this.data?e+="; data="+this.data:BufferUtils.isBuffer(this.data)?e+="; data (buffer)="+BufferUtils.base64Encode(this.data):e+="; data (json)="+JSON.stringify(this.data)),this.extras&&(e+="; extras="+JSON.stringify(this.extras)),e+="]"},i.encrypt=function(n,e,o){var t=n.data,r=n.encoding,i=e.channelCipher,r=r?r+"/":"";BufferUtils.isBuffer(t)||(t=BufferUtils.utf8Encode(String(t)),r+="utf-8/"),i.encrypt(t,function(e,t){e?o(e):(n.data=t,n.encoding=r+"cipher+"+i.algorithm,o(null,n))})},i.encode=function(e,t,n){var o=e.data;if(!("string"==typeof o||BufferUtils.isBuffer(o)||null==o)){if(!Utils.isObject(o)&&!Utils.isArray(o))throw new ErrorInfo("Data type is unsupported",40013,400);e.data=JSON.stringify(o),e.encoding=(o=e.encoding)?o+"/json":"json"}null!=t&&t.cipher?i.encrypt(e,t,n):n(null,e)},i.encodeArray=function(n,e,o){for(var r=0,t=0;t<n.length;t++)i.encode(n[t],e,function(e,t){e?o(e):++r==n.length&&o(null,n)})},i.serialize=Utils.encodeBody,i.decode=function(e,t){t&&t.channelOptions||(t={channelOptions:t,plugins:{},baseEncodedPreviousPayload:void 0});var n=e.data,o=e.encoding;if(o){var r,i=o.split("/"),s=i.length,a=e.data;try{for(;0<(r=s);){var c=i[--s].match(/([\-\w]+)(\+([\w\-]+))?/);if(!c)break;var l=c[1];switch(l){case"base64":a=BufferUtils.base64Decode(String(a)),r==i.length&&(n=a);continue;case"utf-8":a=BufferUtils.utf8Decode(a);continue;case"json":a=JSON.parse(a);continue;case"cipher":if(null!=t.channelOptions&&t.channelOptions.cipher){var u=c[3],c=t.channelOptions.channelCipher;if(u!=c.algorithm)throw new Error("Unable to decrypt message with given cipher; incompatible cipher params");a=c.decrypt(a);continue}throw new Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!t.plugins||!t.plugins.vcdiff)throw new ErrorInfo("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if("undefined"==typeof Uint8Array)throw new ErrorInfo("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{var h=t.baseEncodedPreviousPayload;"string"==typeof h&&(h=BufferUtils.utf8Encode(h)),h=BufferUtils.toBuffer(h),a=BufferUtils.toBuffer(a),n=a=BufferUtils.typedArrayToBuffer(t.plugins.vcdiff.decode(a,h))}catch(e){throw new ErrorInfo("Vcdiff delta decode failed with "+e,40018,400)}continue;default:throw new Error("Unknown encoding")}break}}catch(e){throw new ErrorInfo("Error processing the "+l+" encoding, decoder returned ‘"+e.message+"’",e.code||40013,400)}finally{e.encoding=r<=0?null:i.slice(0,r).join("/"),e.data=a}}t.baseEncodedPreviousPayload=n},i.fromResponseBody=function(e,t,n){n&&(e=Utils.decodeBody(e,n));for(var o=0;o<e.length;o++){var r=e[o]=i.fromValues(e[o]);try{i.decode(r,t)}catch(e){Logger.logAction(Logger.LOG_ERROR,"Message.fromResponseBody()",e.toString())}}return e},i.fromValues=function(e){return Utils.mixin(new i,e)},i.fromValuesArray=function(e){for(var t=e.length,n=new Array(t),o=0;o<t;o++)n[o]=i.fromValues(e[o]);return n},i.fromEncoded=function(e,t){var n=i.fromValues(e);o(t);try{i.decode(n,t)}catch(e){Logger.logAction(Logger.LOG_ERROR,"Message.fromEncoded()",e.toString())}return n},i.fromEncodedArray=function(e,t){return o(t),Utils.arrMap(e,function(e){return i.fromEncoded(e,t)})},i.getMessagesSize=function(e){for(var t,n,o=0,r=0;r<e.length;r++)o+=(t=e[r]).size||(t.size=(n=void 0,n=0,(t=t).name&&(n+=t.name.length),t.clientId&&(n+=t.clientId.length),t.extras&&(n+=JSON.stringify(t.extras).length),t.data&&(n+=Utils.dataSizeBytes(t.data)),n));return o},i}(),PresenceMessage=function(){Platform.msgpack;function i(){this.action=void 0,this.id=void 0,this.timestamp=void 0,this.clientId=void 0,this.connectionId=void 0,this.data=void 0,this.encoding=void 0,this.size=void 0}return i.Actions=["absent","present","enter","leave","update"],i.prototype.isSynthesized=function(){return this.id.substring(this.connectionId.length,0)!==this.connectionId},i.prototype.parseId=function(){var e=this.id.split(":");return{connectionId:e[0],msgSerial:parseInt(e[1],10),index:parseInt(e[2],10)}},i.prototype.toJSON=function(){var e,t={clientId:this.clientId,action:(e=this.action,Utils.arrIndexOf(i.Actions,e)),encoding:this.encoding},n=this.data;return n&&BufferUtils.isBuffer(n)&&(n=0<arguments.length?(e=this.encoding,t.encoding=e?e+"/base64":"base64",BufferUtils.base64Encode(n)):BufferUtils.toBuffer(n)),t.data=n,t},i.prototype.toString=function(){var e="[PresenceMessage";return e+="; action="+this.action,this.id&&(e+="; id="+this.id),this.timestamp&&(e+="; timestamp="+this.timestamp),this.clientId&&(e+="; clientId="+this.clientId),this.connectionId&&(e+="; connectionId="+this.connectionId),this.encoding&&(e+="; encoding="+this.encoding),this.data&&("string"==typeof this.data?e+="; data="+this.data:BufferUtils.isBuffer(this.data)?e+="; data (buffer)="+BufferUtils.base64Encode(this.data):e+="; data (json)="+JSON.stringify(this.data)),e+="]"},i.encode=Message.encode,i.decode=Message.decode,i.fromResponseBody=function(e,t,n){n&&(e=Utils.decodeBody(e,n));for(var o=0;o<e.length;o++){var r=e[o]=i.fromValues(e[o],!0);try{i.decode(r,t)}catch(e){Logger.logAction(Logger.LOG_ERROR,"PresenceMessage.fromResponseBody()",e.toString())}}return e},i.fromValues=function(e,t){return t&&(e.action=i.Actions[e.action]),Utils.mixin(new i,e)},i.fromValuesArray=function(e){for(var t=e.length,n=new Array(t),o=0;o<t;o++)n[o]=i.fromValues(e[o]);return n},i.fromEncoded=function(e,t){var n=i.fromValues(e,!0);try{i.decode(n,t)}catch(e){Logger.logAction(Logger.LOG_ERROR,"PresenceMessage.fromEncoded()",e.toString())}return n},i.fromEncodedArray=function(e,t){return Utils.arrMap(e,function(e){return i.fromEncoded(e,t)})},i.getMessagesSize=Message.getMessagesSize,i}(),ProtocolMessage=function(){function i(){this.action=void 0,this.flags=void 0,this.id=void 0,this.timestamp=void 0,this.count=void 0,this.error=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionSerial=void 0,this.channel=void 0,this.channelSerial=void 0,this.msgSerial=void 0,this.messages=void 0,this.presence=void 0,this.auth=void 0,this.params=void 0}var s=i.Action={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17};i.channelModes=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE"],i.ActionName=[],Utils.arrForEach(Utils.keysArray(i.Action,!0),function(e){i.ActionName[s[e]]=e});var t={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,PRESENCE:65536,PUBLISH:1<<17,SUBSCRIBE:1<<18,PRESENCE_SUBSCRIBE:1<<19},a=Utils.keysArray(t);function c(e){var t=[];if(e)for(var n=0;n<e.length;n++)t.push(e[n].toString());return"[ "+t.join(", ")+" ]"}t.MODE_ALL=t.PRESENCE|t.PUBLISH|t.SUBSCRIBE|t.PRESENCE_SUBSCRIBE,i.prototype.hasFlag=function(e){return 0<(this.flags&t[e])},i.prototype.setFlag=function(e){return this.flags=this.flags|t[e]},i.prototype.getMode=function(){return this.flags&&this.flags&t.MODE_ALL},i.prototype.encodeModesToFlags=function(e){var t=this;Utils.arrForEach(e,function(e){t.setFlag(e)})},i.prototype.decodeModesFromFlags=function(){var t=[],n=this;return Utils.arrForEach(i.channelModes,function(e){n.hasFlag(e)&&t.push(e)}),0<t.length?t:void 0},i.serialize=Utils.encodeBody,i.deserialize=function(e,t){t=Utils.decodeBody(e,t);return i.fromDeserialized(t)},i.fromDeserialized=function(e){var t=e.error;t&&(e.error=ErrorInfo.fromValues(t));var n=e.messages;if(n)for(var o=0;o<n.length;o++)n[o]=Message.fromValues(n[o]);var r=e.presence;if(r)for(o=0;o<r.length;o++)r[o]=PresenceMessage.fromValues(r[o],!0);return Utils.mixin(new i,e)},i.fromValues=function(e){return Utils.mixin(new i,e)};var l="id channel channelSerial connectionId connectionKey connectionSerial count msgSerial timestamp".split(" ");return i.stringify=function(t){var e,n="[ProtocolMessage";void 0!==t.action&&(n+="; action="+i.ActionName[t.action]||t.action);for(var o,r=0;r<l.length;r++)e=l[r],void 0!==t[e]&&(n+="; "+e+"="+t[e]);return t.messages&&(n+="; messages="+c(Message.fromValuesArray(t.messages))),t.presence&&(n+="; presence="+c(PresenceMessage.fromValuesArray(t.presence))),t.error&&(n+="; error="+ErrorInfo.fromValues(t.error).toString()),t.auth&&t.auth.accessToken&&(n+="; token="+t.auth.accessToken),t.flags&&(n+="; flags="+Utils.arrFilter(a,function(e){return t.hasFlag(e)}).join(",")),t.params&&(o="",Utils.forInOwnNonNullProps(t.params,function(e){0<o.length&&(o+="; "),o+=e+"="+t.params[e]}),0<o.length&&(n+="; params=["+o+"]")),n+="]"},i.isDuplicate=function(e,t){if(e&&t&&(e.action===s.MESSAGE||e.action===s.PRESENCE)&&e.action===t.action&&e.channel===t.channel&&e.id===t.id){if(e.action===s.PRESENCE)return!0;if(e.messages.length===t.messages.length){for(var n=0;n<e.messages.length;n++){var o=e.messages[n],r=t.messages[n];if((o.extras&&o.extras.delta&&o.extras.delta.format)!==(r.extras&&r.extras.delta&&r.extras.delta.format))return!1}return!0}}return!1},i}(),Stats=function(){function o(e){this.count=e&&e.count||0,this.data=e&&e.data||0,this.uncompressedData=e&&e.uncompressedData||0,this.failed=e&&e.failed||0,this.refused=e&&e.refused||0}function t(t){var n=this;o.call(this,t),this.category=void 0,t&&t.category&&(this.category={},Utils.forInOwnNonNullProps(t.category,function(e){n.category[e]=new o(t.category[e])}))}function n(e){this.peak=e&&e.peak||0,this.min=e&&e.min||0,this.mean=e&&e.mean||0,this.opened=e&&e.opened||0,this.refused=e&&e.refused||0}function r(e){this.succeeded=e&&e.succeeded||0,this.failed=e&&e.failed||0,this.refused=e&&e.refused||0}function i(e){this.plain=new n(e&&e.plain),this.tls=new n(e&&e.tls),this.all=new n(e&&e.all)}function s(e){this.messages=new t(e&&e.messages),this.presence=new t(e&&e.presence),this.all=new t(e&&e.all)}function a(e){this.realtime=new s(e&&e.realtime),this.rest=new s(e&&e.rest),this.webhook=new s(e&&e.webhook),this.sharedQueue=new s(e&&e.sharedQueue),this.externalQueue=new s(e&&e.externalQueue),this.httpEvent=new s(e&&e.httpEvent),this.push=new s(e&&e.push),this.all=new s(e&&e.all)}function c(e){this.all=new s(e&&e.all),this.inbound=new a(e&&e.inbound),this.outbound=new a(e&&e.outbound)}function l(e){this.all=new s(e&&e.all),this.producerPaid=new c(e&&e.producerPaid),this.consumerPaid=new c(e&&e.consumerPaid)}function u(e){this.messages=e&&e.messages||0;var t=e&&e.notifications;this.notifications={invalid:t&&t.invalid||0,attempted:t&&t.attempted||0,successful:t&&t.successful||0,failed:t&&t.failed||0},this.directPublishes=e&&e.directPublishes||0}function h(e){this.succeeded=e&&e.succeeded||0,this.skipped=e&&e.skipped||0,this.failed=e&&e.failed||0}function g(t){var n=this;this.delta=void 0,t&&t.delta&&(this.delta={},Utils.forInOwnNonNullProps(t.delta,function(e){n.delta[e]=new h(t.delta[e])}))}function p(e){c.call(this,e),this.persisted=new s(e&&e.persisted),this.connections=new i(e&&e.connections),this.channels=new n(e&&e.channels),this.apiRequests=new r(e&&e.apiRequests),this.tokenRequests=new r(e&&e.tokenRequests),this.xchgProducer=new l(e&&e.xchgProducer),this.xchgConsumer=new l(e&&e.xchgConsumer),this.push=new u(e&&e.pushStats),this.processed=new g(e&&e.processed),this.inProgress=e&&e.inProgress||void 0,this.unit=e&&e.unit||void 0,this.intervalId=e&&e.intervalId||void 0}return p.fromValues=function(e){return new p(e)},p}(),DeviceDetails=function(){function r(){this.id=void 0,this.deviceSecret=void 0,this.platform=void 0,this.formFactor=void 0,this.clientId=void 0,this.metadata=void 0,this.deviceIdentityToken=void 0,this.push={recipient:void 0,state:void 0,errorReason:void 0}}return r.prototype.toJSON=function(){return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:this.push.recipient,state:this.push.state,errorReason:this.push.errorReason}}},r.prototype.toString=function(){var e="[DeviceDetails";return this.id&&(e+="; id="+this.id),this.platform&&(e+="; platform="+this.platform),this.formFactor&&(e+="; formFactor="+this.formFactor),this.clientId&&(e+="; clientId="+this.clientId),this.metadata&&(e+="; metadata="+this.metadata),this.deviceIdentityToken&&(e+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),this.push.recipient&&(e+="; push.recipient="+JSON.stringify(this.push.recipient)),this.push.state&&(e+="; push.state="+this.push.state),this.push.errorReason&&(e+="; push.errorReason="+this.push.errorReason),this.push.metadata&&(e+="; push.metadata="+this.push.metadata),e+="]"},r.toRequestBody=Utils.encodeBody,r.fromResponseBody=function(e,t){return t&&(e=Utils.decodeBody(e,t)),Utils.isArray(e)?r.fromValuesArray(e):r.fromValues(e)},r.fromValues=function(e){return Utils.mixin(new r,e)},r.fromValuesArray=function(e){for(var t=e.length,n=new Array(t),o=0;o<t;o++)n[o]=r.fromValues(e[o]);return n},r}(),PushChannelSubscription=function(){function r(){this.channel=void 0,this.deviceId=void 0,this.clientId=void 0}return r.prototype.toJSON=function(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}},r.prototype.toString=function(){var e="[PushChannelSubscription";return this.channel&&(e+="; channel="+this.channel),this.deviceId&&(e+="; deviceId="+this.deviceId),this.clientId&&(e+="; clientId="+this.clientId),e+="]"},r.toRequestBody=Utils.encodeBody,r.fromResponseBody=function(e,t){return t&&(e=Utils.decodeBody(e,t)),Utils.isArray(e)?r.fromValuesArray(e):r.fromValues(e)},r.fromValues=function(e){return Utils.mixin(new r,e)},r.fromValuesArray=function(e){for(var t=e.length,n=new Array(t),o=0;o<t;o++)n[o]=r.fromValues(e[o]);return n},r}(),ConnectionError={disconnected:ErrorInfo.fromValues({statusCode:400,code:80003,message:"Connection to server temporarily unavailable"}),suspended:ErrorInfo.fromValues({statusCode:400,code:80002,message:"Connection to server unavailable"}),failed:ErrorInfo.fromValues({statusCode:400,code:8e4,message:"Connection failed or disconnected by server"}),closing:ErrorInfo.fromValues({statusCode:400,code:80017,message:"Connection closing"}),closed:ErrorInfo.fromValues({statusCode:400,code:80017,message:"Connection closed"}),unknownConnectionErr:ErrorInfo.fromValues({statusCode:500,code:50002,message:"Internal connection error"}),unknownChannelErr:ErrorInfo.fromValues({statusCode:500,code:50001,message:"Internal channel error"})},MessageQueue=function(){function e(){EventEmitter.call(this),this.messages=[]}return Utils.inherits(e,EventEmitter),e.prototype.count=function(){return this.messages.length},e.prototype.push=function(e){this.messages.push(e)},e.prototype.shift=function(){return this.messages.shift()},e.prototype.last=function(){return this.messages[this.messages.length-1]},e.prototype.copyAll=function(){return this.messages.slice()},e.prototype.append=function(e){this.messages.push.apply(this.messages,e)},e.prototype.prepend=function(e){this.messages.unshift.apply(this.messages,e)},e.prototype.completeMessages=function(e,t,n){Logger.logAction(Logger.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+e+"; count = "+t),n=n||null;var o=this.messages,r=o[0];if(r){r=r.message.msgSerial,t=e+t;if(r<t)for(var i=o.splice(0,t-r),s=0;s<i.length;s++)i[s].callback(n);0==o.length&&this.emit("idle")}},e.prototype.completeAllMessages=function(e){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,e)},e.prototype.clear=function(){Logger.logAction(Logger.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")},e}(),Protocol=function(){var n=ProtocolMessage.Action;function e(e){EventEmitter.call(this),this.transport=e,this.messageQueue=new MessageQueue;var o=this;e.on("ack",function(e,t){o.onAck(e,t)}),e.on("nack",function(e,t,n){o.onNack(e,t,n)})}return Utils.inherits(e,EventEmitter),e.prototype.onAck=function(e,t){Logger.logAction(Logger.LOG_MICRO,"Protocol.onAck()","serial = "+e+"; count = "+t),this.messageQueue.completeMessages(e,t)},e.prototype.onNack=function(e,t,n){Logger.logAction(Logger.LOG_ERROR,"Protocol.onNack()","serial = "+e+"; count = "+t+"; err = "+Utils.inspectError(n)),n=n||new ErrorInfo("Unable to send message; channel not responding",50001,500),this.messageQueue.completeMessages(e,t,n)},e.prototype.onceIdle=function(e){var t=this.messageQueue;0!==t.count()?t.once("idle",e):e()},e.prototype.send=function(e){e.ackRequired&&this.messageQueue.push(e),Logger.shouldLog(Logger.LOG_MICRO)&&Logger.logAction(Logger.LOG_MICRO,"Protocol.send()","sending msg; "+ProtocolMessage.stringify(e.message)),e.sendAttempted=!0,this.transport.send(e.message)},e.prototype.getTransport=function(){return this.transport},e.prototype.getPendingMessages=function(){return this.messageQueue.copyAll()},e.prototype.clearPendingMessages=function(){return this.messageQueue.clear()},e.prototype.finish=function(){var e=this.transport;this.onceIdle(function(){e.disconnect()})},e.PendingMessage=function(e,t){this.message=e,this.callback=t,this.merged=!1,e=e.action,this.sendAttempted=!1,this.ackRequired=e==n.MESSAGE||e==n.PRESENCE},e}(),ConnectionManager=function(){function r(){}var t=!(void 0===WebStorage||!WebStorage.get),i=!(void 0===WebStorage||!WebStorage.getSession),c=ProtocolMessage.Action,s=Protocol.PendingMessage,u=Defaults.transportPreferenceOrder,l=u[u.length-1],n="ably-transport-preference",a="ably-connection-recovery";function o(e,t,n,o){this.options=e,this.host=t,this.mode=n,this.connectionKey=o,this.format=e.useBinaryProtocol?"msgpack":"json",this.connectionSerial=void 0,this.timeSerial=void 0}function h(e,t){EventEmitter.call(this),this.realtime=e;var n=(this.options=t).timeouts,o=this,e=n.preferenceConnectTimeout+n.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:e,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},synchronizing:{state:"connected",terminal:!1,queueEvents:!0,sendEvents:!1,forceQueueEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:n.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:n.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:n.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new MessageQueue,this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.timeSerial=void 0,this.connectionSerial=void 0,this.connectionStateTtl=n.connectionStateTtl,this.maxIdleInterval=null,this.transports=Utils.intersect(t.transports||Defaults.defaultTransports,h.supportedTransports),this.baseTransport=Utils.intersect(Defaults.baseTransportOrder,this.transports)[0],this.upgradeTransports=Utils.intersect(this.transports,Defaults.upgradeTransports),this.transportPreference=null,this.httpHosts=Defaults.getHosts(t),this.activeProtocol=null,this.proposedTransports=[],this.pendingTransports=[],this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.mostRecentMsg=null,this.forceFallbackHost=!1,this.connectCounter=0,Logger.logAction(Logger.LOG_MINOR,"Realtime.ConnectionManager()","started"),Logger.logAction(Logger.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(t.transports||Defaults.defaultTransports)+"]"),Logger.logAction(Logger.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),Logger.logAction(Logger.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]"),!this.transports.length){var r="no requested transports available";throw Logger.logAction(Logger.LOG_ERROR,"realtime.ConnectionManager()",r),new Error(r)}r=Platform.addEventListener;r&&(i&&"function"==typeof t.recover&&r("beforeunload",this.persistConnection.bind(this)),!0===t.closeOnUnload&&r("beforeunload",function(){Logger.logAction(Logger.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),o.requestState({state:"closing"})}),r("online",function(){o.state!=o.states.disconnected&&o.state!=o.states.suspended||(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager caught browser ‘online’ event","reattempting connection"),o.requestState({state:"connecting"}))}),r("offline",function(){o.state==o.states.connected&&(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager caught browser ‘offline’ event","disconnecting active transport"),o.disconnectAllTransports())}))}return o.prototype.getConnectParams=function(e){var t=e?Utils.copy(e):{},n=this.options;switch(this.mode){case"upgrade":t.upgrade=this.connectionKey;break;case"resume":t.resume=this.connectionKey,void 0!==this.timeSerial?t.timeSerial=this.timeSerial:void 0!==this.connectionSerial&&(t.connectionSerial=this.connectionSerial);break;case"recover":e=n.recover.split(":");e&&(t.recover=e[0],e=e[1],isNaN(e)?t.timeSerial=e:t.connectionSerial=e)}return void 0!==n.clientId&&(t.clientId=n.clientId),!1===n.echoMessages&&(t.echo="false"),void 0!==this.format&&(t.format=this.format),void 0!==this.stream&&(t.stream=this.stream),void 0!==this.heartbeats&&(t.heartbeats=this.heartbeats),t.v=Defaults.apiVersion,t.lib=Defaults.libstring,void 0!==n.transportParams&&Utils.mixin(t,n.transportParams),t},o.prototype.toString=function(){var e="[mode="+this.mode;return this.host&&(e+=",host="+this.host),this.connectionKey&&(e+=",connectionKey="+this.connectionKey),void 0!==this.connectionSerial&&(e+=",connectionSerial="+this.connectionSerial),this.timeSerial&&(e+=",timeSerial="+this.timeSerial),this.format&&(e+=",format="+this.format),e+="]"},Utils.inherits(h,EventEmitter),h.supportedTransports={},h.prototype.createTransportParams=function(e,t){t=new o(this.options,e,t,this.connectionKey);return this.timeSerial?t.timeSerial=this.timeSerial:void 0!==this.connectionSerial&&(t.connectionSerial=this.connectionSerial),t},h.prototype.getTransportParams=function(n){var o=this;!function(t){if(o.connectionKey)t("resume");else if("string"!=typeof o.options.recover){var e=o.options.recover,n=i&&WebStorage.getSession(a);if(n&&"function"==typeof e)return Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data"),e(n,function(e){e?(o.options.recover=n.recoveryKey,t("recover")):t("clean")});t("clean")}else t("recover")}(function(e){var t=o.createTransportParams(null,e);"recover"===e?(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+o.options.recover),(e=o.options.recover.split(":"))&&e[2]&&(o.msgSerial=e[2])):Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+t.toString()),n(t)})},h.prototype.tryATransport=function(o,r,i){var s=this;o.host;Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+r),h.supportedTransports[r].tryConnect(this,this.realtime.auth,o,function(e,t){var n=s.state;return n==s.states.closing||n==s.states.closed||n==s.states.failed?(t&&(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+n.state+" while we were attempting the transport; closing "+t),t.close()),void i(!0)):e?(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+r+" "+e.event+", err: "+e.error.toString()),void(Auth.isTokenErr(e.error)?s.realtime.auth._forceNewToken(null,null,function(e){e?s.actOnErrorFromAuthorize(e):s.tryATransport(o,r,i)}):"failed"===e.event?(s.notifyState({state:"failed",error:e.error}),i(!0)):"disconnected"===e.event&&i(!1))):(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+r+"; setting pending"),s.setTransportPending(t,o),void i(null,t))})},h.prototype.setTransportPending=function(r,i){var s=i.mode;Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+r+"; mode = "+s),Utils.arrDeleteValue(this.proposedTransports,r),this.pendingTransports.push(r);var a=this;r.once("connected",function(e,t,n,o){"upgrade"==s&&a.activeProtocol?r.shortName!==l&&Utils.arrIn(a.getUpgradePossibilities(),l)?setTimeout(function(){a.scheduleTransportActivation(e,r,t,n,o)},a.options.timeouts.parallelUpgradeDelay):a.scheduleTransportActivation(e,r,t,n,o):(a.activateTransport(e,r,t,n,o),Utils.nextTick(function(){a.connectImpl(i)})),"recover"===s&&a.options.recover&&(a.options.recover=null,a.unpersistConnection())}),r.on(["disconnected","closed","failed"],function(e){a.deactivateTransport(r,this.event,e)}),this.emit("transport.pending",r)},h.prototype.scheduleTransportActivation=function(r,i,n,s,a){function c(){i.disconnect(),Utils.arrDeleteValue(l.pendingTransports,i)}var e,t,l=this,o=this.activeProtocol&&this.activeProtocol.getTransport();return this.state!==this.states.connected&&this.state!==this.states.connecting?(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+this.state.state+(this.state===this.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+i.shortName),void c()):!o||(e=i,t=o,Utils.arrIndexOf(u,e.shortName)>Utils.arrIndexOf(u,t.shortName))?(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Scheduling transport upgrade; transport = "+i),void this.realtime.channels.onceNopending(function(e){var o;if(e)Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unable to activate transport; transport = "+i+"; err = "+e);else{if(!i.isConnected)return Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+i.shortName+"is no longer connected; abandoning upgrade"),void c();if(l.state===l.states.connected)Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Currently connected, so temporarily pausing events until the upgrade is complete"),l.state=l.states.synchronizing,o=l.activeProtocol;else if(l.state!==l.states.connecting)return Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+l.state.state+(l.state===l.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+i.shortName),void c();var t=n!==l.connectionId,e=t?a:l;t&&Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Upgrade resulted in new connectionId; resetting library connection position from "+(l.timeSerial||l.connectionSerial)+" to "+(e.timeSerial||e.connectionSerial)+"; upgrade error was "+r),Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Syncing transport; transport = "+i),l.sync(i,e,function(e,t,n){e?l.state===l.states.synchronizing&&(Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unexpected error attempting to sync transport; transport = "+i+"; err = "+e),l.disconnectAllTransports()):(e=function(){Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Activating transport; transport = "+i),l.activateTransport(r,i,t,s,n),l.state===l.states.synchronizing?(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, sending queued messages on upgraded transport; transport = "+i),l.state=l.states.connected):Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, but state is now "+l.state.state+", so leaving unchanged"),l.state.sendEvents&&l.sendQueuedMessages()},o?o.onceIdle(e):e())})}})):(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+i.shortName+" is no better than current active transport "+o.shortName+" - abandoning upgrade"),void c())},h.prototype.activateTransport=function(e,o,t,n,r){Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+o),e&&Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+e),t&&Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+t),n&&Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(n)),r&&Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.activateTransport()","serial =  "+(r.timeSerial||r.connectionSerial)),this.persistTransportPreference(o);var i=this.state,s=this.states.connected.state;if(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+i.state),i.state==this.states.closing.state||i.state==this.states.closed.state||i.state==this.states.failed.state)return Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),o.disconnect(),!1;if(Utils.arrDeleteValue(this.pendingTransports,o),!o.isConnected)return Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+o+" since it appears to no longer be connected"),!1;var a=this.activeProtocol;this.activeProtocol=new Protocol(o),this.host=o.params.host;var c=n.connectionKey;c&&this.connectionKey!=c&&this.setConnection(t,n,r,!!e),this.onConnectionDetailsUpdate(n,o);var l=this;return Utils.nextTick(function(){o.on("connected",function(e,t,n){l.onConnectionDetailsUpdate(n,o),l.emit("update",new ConnectionStateChange(s,s,null,e))})}),i.state===this.states.connected.state?e&&(this.errorReason=this.realtime.connection.errorReason=e,this.emit("update",new ConnectionStateChange(s,s,null,e))):(this.notifyState({state:"connected",error:e}),this.errorReason=this.realtime.connection.errorReason=e||null),this.emit("transport.active",o),a&&(0<a.messageQueue.count()&&Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+a.transport.shortName+", new one is "+o.shortName+") finishing with "+a.messageQueue.count()+" messages still pending"),a.transport===o?(e="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+o.shortName+"; stack = "+(new Error).stack,Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.activateTransport()",e),ErrorReporter.report("error",e,"transport-previously-active")):a.finish()),Utils.safeArrForEach(this.pendingTransports,function(e){var t;e===o?(t="Assumption violated: activating a transport that is still marked as a pending transport; transport = "+o.shortName+"; stack = "+(new Error).stack,Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.activateTransport()",t),ErrorReporter.report("error",t,"transport-activating-pending"),Utils.arrDeleteValue(l.pendingTransports,o)):e.disconnect()}),Utils.safeArrForEach(this.proposedTransports,function(e){var t;e===o?(t="Assumption violated: activating a transport that is still marked as a proposed transport; transport = "+o.shortName+"; stack = "+(new Error).stack,Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.activateTransport()",t),ErrorReporter.report("error",t,"transport-activating-proposed"),Utils.arrDeleteValue(l.proposedTransports,o)):e.dispose()}),!0},h.prototype.deactivateTransport=function(e,t,n){var o=this.activeProtocol,r=o&&o.getTransport()===e,i=Utils.arrDeleteValue(this.pendingTransports,e),s=Utils.arrDeleteValue(this.proposedTransports,e),a=this.noTransportsScheduledForActivation();if(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+e),Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+t+(r?"; was active":i?"; was pending":s?"; was proposed":"")+(a?"":"; another transport is scheduled for activation")),n&&n.message&&Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+n.message),r&&(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(o.getPendingMessages()),Utils.nextTick(function(){o.clearPendingMessages()}),this.activeProtocol=this.host=null,clearTimeout(this.channelResumeCheckTimer)),this.emit("transport.inactive",e),r&&a||r&&"failed"===t||"closed"===t||null===o&&i&&0===this.pendingTransports.length){if("disconnected"===t&&n&&500<n.statusCode&&1<this.httpHosts.length)return this.unpersistTransportPreference(),this.forceFallbackHost=!0,void this.notifyState({state:t,error:n,retryImmediately:!0});i="failed"===t&&Auth.isTokenErr(n)?"disconnected":t;this.notifyState({state:i,error:n})}else r&&"disconnected"===t&&this.state!==this.states.synchronizing&&(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.deactivateTransport()","wasActive but another transport is connected and scheduled for activation, so going into the connecting state until it activates"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),this.notifyState({state:"connecting",error:n}))},h.prototype.noTransportsScheduledForActivation=function(){return Utils.isEmpty(this.pendingTransports)||this.pendingTransports.every(function(e){return!e.isConnected})},h.prototype.sync=function(e,t,n){var o=setTimeout(function(){e.off("sync"),n(new ErrorInfo("Timeout waiting for sync response",5e4,500))},this.options.timeouts.realtimeRequestTimeout),r=ProtocolMessage.fromValues({action:c.SYNC,connectionKey:this.connectionKey});t.timeSerial?r.timeSerial=t.timeSerial:void 0!==t.connectionSerial&&(r.connectionSerial=t.connectionSerial),e.send(r),e.once("sync",function(e,t){clearTimeout(o),n(null,e,t)})},h.prototype.setConnection=function(e,t,n,o){var r=this,i=this.connectionid,s=i&&i!==e;(s||!i&&o)&&(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0),this.connectionId!==e?(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),Utils.nextTick(function(){r.realtime.channels.reattach()})):this.options.checkChannelsOnResume&&(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.setConnection()","Same connectionId; checkChannelsOnResume is enabled"),clearTimeout(this.channelResumeCheckTimer),this.realtime.channels.resetAttachedMsgIndicators(),this.channelResumeCheckTimer=setTimeout(function(){r.realtime.channels.checkAttachedMsgIndicators(e)},3e4)),this.realtime.connection.id=this.connectionId=e,this.realtime.connection.key=this.connectionKey=t.connectionKey;i=s||!i;this.setConnectionSerial(n,i)},h.prototype.clearConnection=function(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.clearConnectionSerial(),this.msgSerial=0,this.unpersistConnection()},h.prototype.setConnectionSerial=function(e,t){var n=e.timeSerial,e=e.connectionSerial;if(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.setConnectionSerial()","Updating connection serial; serial = "+e+"; timeSerial = "+n+"; force = "+t+"; previous = "+this.connectionSerial),void 0!==n)return n<=this.timeSerial&&!t?(Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with timeSerial "+n+", but current timeSerial is "+this.timeSerial+"; assuming message is a duplicate and discarding it"),!0):(this.realtime.connection.timeSerial=this.timeSerial=n,void this.setRecoveryKey());if(void 0!==e){if(e<=this.connectionSerial&&!t)return Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with connectionSerial "+e+", but current connectionSerial is "+this.connectionSerial+"; assuming message is a duplicate and discarding it"),!0;this.realtime.connection.serial=this.connectionSerial=e,this.setRecoveryKey()}},h.prototype.clearConnectionSerial=function(){this.realtime.connection.serial=this.connectionSerial=void 0,this.realtime.connection.timeSerial=this.timeSerial=void 0,this.clearRecoveryKey()},h.prototype.setRecoveryKey=function(){this.realtime.connection.recoveryKey=this.connectionKey+":"+(this.timeSerial||this.connectionSerial)+":"+this.msgSerial},h.prototype.clearRecoveryKey=function(){this.realtime.connection.recoveryKey=null},h.prototype.checkConnectionStateFreshness=function(){var e;this.lastActivity&&this.connectionId&&((e=Utils.now()-this.lastActivity)>this.connectionStateTtl+this.maxIdleInterval&&(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+e+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended",this.states.connecting.queueEvents=!1))},h.prototype.persistConnection=function(){var e;!i||(e=this.realtime.connection.recoveryKey)&&(e={recoveryKey:e,disconnectedAt:Utils.now(),location:global.location,clientId:this.realtime.auth.clientId},this.connectionStateTtl,i&&WebStorage.setSession(a,e))},h.prototype.unpersistConnection=function(){i&&WebStorage.removeSession(a)},h.prototype.getError=function(){return this.errorReason||this.getStateError()},h.prototype.getStateError=function(){return ConnectionError[this.state.state]},h.prototype.activeState=function(){return this.state.queueEvents||this.state.sendEvents},h.prototype.enactStateChange=function(e){var t="failed"===e.current?Logger.LOG_ERROR:Logger.LOG_MAJOR;Logger.logAction(t,"Connection state",e.current+(e.reason?"; reason: "+e.reason:"")),Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+e.current+"; reason = "+(e.reason&&e.reason.message));t=this.state=this.states[e.current];e.reason&&(this.errorReason=e.reason,this.realtime.connection.errorReason=e.reason),!t.terminal&&"suspended"!==t.state||this.clearConnection(),this.emit("connectionstate",e)},h.prototype.startTransitionTimer=function(e){Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+e.state),this.transitionTimer&&(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer));var t=this;this.transitionTimer=setTimeout(function(){t.transitionTimer&&(t.transitionTimer=null,Logger.logAction(Logger.LOG_MINOR,"ConnectionManager "+e.state+" timer expired","requesting new state: "+e.failState),t.notifyState({state:e.failState}))},e.retryDelay)},h.prototype.cancelTransitionTimer=function(){Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)},h.prototype.startSuspendTimer=function(){var e=this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){e.suspendTimer&&(e.suspendTimer=null,Logger.logAction(Logger.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),e.states.connecting.failState="suspended",e.states.connecting.queueEvents=!1,e.notifyState({state:"suspended"}))},this.connectionStateTtl))},h.prototype.checkSuspendTimer=function(e){"disconnected"!==e&&"suspended"!==e&&"connecting"!==e&&this.cancelSuspendTimer()},h.prototype.cancelSuspendTimer=function(){this.states.connecting.failState="disconnected",this.states.connecting.queueEvents=!0,this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)},h.prototype.startRetryTimer=function(e){var t=this;this.retryTimer=setTimeout(function(){Logger.logAction(Logger.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),t.retryTimer=null,t.requestState({state:"connecting"})},e)},h.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},h.prototype.notifyState=function(e){var t,n,o,r=e.state,i=this,s="disconnected"===r&&(this.state===this.states.connected||this.state===this.states.synchronizing||e.retryImmediately||this.state===this.states.connecting&&e.error&&Auth.isTokenErr(e.error)&&!(this.errorReason&&Auth.isTokenErr(this.errorReason)));Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+r+(s?"; will retry connection immediately":"")),r!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(e.state),this.state.terminal||(t=this.states[e.state],n=new ConnectionStateChange(this.state.state,t.state,t.retryDelay,e.error||ConnectionError[t.state]),s?(o=function(){i.state===i.states.disconnected&&(i.lastAutoReconnectAttempt=Utils.now(),i.requestState({state:"connecting"}))},(e=this.lastAutoReconnectAttempt&&Utils.now()-this.lastAutoReconnectAttempt+1)&&e<1e3?(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+e+"ms ago, waiting another "+(1e3-e)+"ms before trying again"),setTimeout(o,1e3-e)):Utils.nextTick(o)):"disconnected"!==r&&"suspended"!==r||this.startRetryTimer(t.retryDelay),("disconnected"===r&&!s||"suspended"===r||t.terminal)&&Utils.nextTick(function(){i.disconnectAllTransports()}),"connected"!=r||this.activeProtocol||Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(n),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(r,n.reason),this.failQueuedMessages(n.reason))))},h.prototype.requestState=function(e){var t,n=e.state,o=this;Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+n+"; current state: "+this.state.state),n!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(n),"connecting"==n&&"connected"==this.state.state||"closing"==n&&"closed"==this.state.state||(t=this.states[n],t=new ConnectionStateChange(this.state.state,t.state,null,e.error||ConnectionError[t.state]),this.enactStateChange(t),"connecting"==n&&Utils.nextTick(function(){o.startConnect()}),"closing"==n&&this.closeImpl()))},h.prototype.startConnect=function(){var e,t,n,o,r;this.state===this.states.connecting?(e=this.realtime.auth,n=++(t=this).connectCounter,o=function(){t.checkConnectionStateFreshness(),t.getTransportParams(function(e){n===t.connectCounter&&t.connectImpl(e,n)})},Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),"basic"===e.method?o():(r=function(e){n===t.connectCounter&&(e?t.actOnErrorFromAuthorize(e):o())},this.errorReason&&Auth.isTokenErr(this.errorReason)?e._forceNewToken(null,null,r):e._ensureValidAuthCredentials(!1,r))):Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state)},h.prototype.connectImpl=function(e,t){var n=this.state.state;n!==this.states.connecting.state&&n!==this.states.connected.state?Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect (or connected to upgrade), but was "+n):this.pendingTransports.length?Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.connectImpl()","Transports "+this.pendingTransports[0].toString()+" currently pending; taking no action"):n==this.states.connected.state?this.upgradeIfNeeded(e):1<this.transports.length&&this.getTransportPreference()?this.connectPreference(e):this.connectBase(e,t)},h.prototype.connectPreference=function(n){var e=this.getTransportPreference(),o=this,r=!1;Utils.arrIn(this.transports,e)||(this.unpersistTransportPreference(),this.connectImpl(n)),Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.connectPreference()","Trying to connect with stored transport preference "+e);var i=setTimeout(function(){r=!0,o.state.state!==o.states.connected.state&&(Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.connectPreference()","Shortcircuit connection attempt with "+e+" failed; clearing preference and trying from scratch"),o.disconnectAllTransports(),o.unpersistTransportPreference()),o.connectImpl(n)},this.options.timeouts.preferenceConnectTimeout);n.host=o.httpHosts[0],o.tryATransport(n,e,function(e,t){clearTimeout(i),r&&t?(t.off(),t.disconnect(),Utils.arrDeleteValue(this.pendingTransports,t)):t||e||(o.unpersistTransportPreference(),o.connectImpl(n))})},h.prototype.connectBase=function(n,o){var r=this,i=function(e){r.notifyState({state:r.states.connecting.failState,error:e})},s=this.httpHosts.slice(),a=function(e,t){o===r.connectCounter&&(t||e||c())};Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.connectBase()","Trying to connect with base transport "+this.baseTransport);var e=s.shift();if(e){if(n.host=e,this.forceFallbackHost&&s.length)return this.forceFallbackHost=!1,void c();this.tryATransport(n,this.baseTransport,a)}else i(new ErrorInfo("Unable to connect (no available host)",80003,404));function c(){s.length?Http.checkConnectivity(function(e,t){o===r.connectCounter&&(e?i(e):t?(n.host=Utils.arrPopRandomElement(s),r.tryATransport(n,r.baseTransport,a)):i(new ErrorInfo("Unable to connect (network unreachable)",80003,404)))}):i(new ErrorInfo("Unable to connect (and no more fallback hosts to try)",80003,404))}},h.prototype.getUpgradePossibilities=function(){var e=this.activeProtocol.getTransport().shortName,e=Utils.arrIndexOf(this.upgradeTransports,e);return this.upgradeTransports.slice(e+1)},h.prototype.upgradeIfNeeded=function(n){var e=this.getUpgradePossibilities(),o=this;Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.upgradeIfNeeded()","upgrade possibilities: "+Utils.inspect(e)),e.length&&Utils.arrForEach(e,function(e){var t=o.createTransportParams(n.host,"upgrade");o.tryATransport(t,e,r)})},h.prototype.closeImpl=function(){Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),Utils.safeArrForEach(this.pendingTransports,function(e){Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+e),e&&e.close()}),Utils.safeArrForEach(this.proposedTransports,function(e){Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.closeImpl()","Disposing of proposed transport: "+e),e&&e.dispose()}),this.activeProtocol&&(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})},h.prototype.onAuthUpdated=function(t,n){var e,o=this;switch(this.state.state){case"connected":Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport"),(this.pendingTransports.length||this.proposedTransports.length)&&o.state!==o.states.synchronizing&&(this.disconnectAllTransports(!0),e=this.activeProtocol.getTransport().params,Utils.nextTick(function(){"connected"===o.state.state&&o.upgradeIfNeeded(e)})),this.activeProtocol.getTransport().onAuthUpdated(t);var r=ProtocolMessage.fromValues({action:c.AUTH,auth:{accessToken:t.token}});this.send(r);function i(){o.off(s),n(null,t)}var s=function(e){"failed"===e.current&&(o.off(i),o.off(s),n(e.reason||o.getStateError()))};this.once("connectiondetails",i),this.on("connectionstate",s);break;case"connecting":Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");var a=function(e){switch(e.current){case"connected":o.off(a),n(null,t);break;case"failed":case"closed":case"suspended":o.off(a),n(e.reason||o.getStateError())}};o.on("connectionstate",a),"connecting"===this.state.state?o.startConnect():o.requestState({state:"connecting"})}},h.prototype.disconnectAllTransports=function(e){Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"+(e?" except the active transport":"")),this.connectCounter++,Utils.safeArrForEach(this.pendingTransports,function(e){Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+e),e&&e.disconnect()}),this.pendingTransports=[],Utils.safeArrForEach(this.proposedTransports,function(e){Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disposing of proposed transport: "+e),e&&e.dispose()}),this.proposedTransports=[],this.activeProtocol&&!e&&(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())},h.prototype.send=function(e,t,n){n=n||r;var o=this.state;if(o.sendEvents)return Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.send()","sending event"),void this.sendImpl(new s(e,n));if(!(t&&o.queueEvents||o.forceQueueEvents)){o="rejecting event, queueEvent was "+t+", state was "+o.state;return Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.send()",o),void n(this.errorReason||new ErrorInfo(o,9e4,400))}Logger.shouldLog(Logger.LOG_MICRO)&&Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+ProtocolMessage.stringify(e)),this.queue(e,n)},h.prototype.sendImpl=function(e){var t=e.message;e.ackRequired&&!e.sendAttempted&&(t.msgSerial=this.msgSerial++,this.setRecoveryKey());try{this.activeProtocol.send(e)}catch(e){Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+e.stack)}},h.prototype.queue=function(e,t){Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.queue()","queueing event");var n=this.queuedMessages.last(),o=this.options.maxMessageSize;n&&!n.sendAttempted&&function(e,t,n){if(e.channel===t.channel&&((o=e.action)===c.PRESENCE||o===c.MESSAGE)&&o===t.action){var o=o===c.PRESENCE?"presence":"messages",t=e[o].concat(t[o]);return n<Message.getMessagesSize(t)?void 0:Utils.allSame(t,"clientId")&&(Utils.arrEvery(t,function(e){return!e.id})&&(e[o]=t,1))}}(n.message,e,o)?(n.merged||(n.callback=Multicaster([n.callback]),n.merged=!0),n.callback.push(t)):this.queuedMessages.push(new s(e,t))},h.prototype.sendQueuedMessages=function(){var e;for(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");e=this.queuedMessages.shift();)this.sendImpl(e)},h.prototype.queuePendingMessages=function(e){e&&e.length&&(Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+e.length+" pending messages"),this.queuedMessages.prepend(e))},h.prototype.failQueuedMessages=function(e){var t=this.queuedMessages.count();0<t&&(Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+t+" queued messages, err = "+Utils.inspectError(e)),this.queuedMessages.completeAllMessages(e))},h.prototype.onChannelMessage=function(e,t){var n=this.activeProtocol&&t===this.activeProtocol.getTransport(),o=Utils.arrIn(this.pendingTransports,t)&&this.state==this.states.synchronizing,t=e.action===c.MESSAGE||e.action===c.PRESENCE;if(n||o){if(t){if(this.setConnectionSerial(e))return;if(ProtocolMessage.isDuplicate(e,this.mostRecentMsg))return void Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.onChannelMessage()","received message with different connectionSerial, but same message id as a previous; discarding; id = "+e.id);this.mostRecentMsg=e}this.realtime.channels.onChannelMessage(e)}else-1<Utils.arrIndexOf([c.ACK,c.NACK,c.ERROR],e.action)?this.realtime.channels.onChannelMessage(e):Logger.logAction(Logger.LOG_MICRO,"ConnectionManager.onChannelMessage()","received message "+JSON.stringify(e)+"on defunct transport; discarding")},h.prototype.ping=function(t,n){if(t){Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.ping()","transport = "+t);var o=Utils.now(),r=Utils.cheapRandStr(),i=function(e){e===r&&(t.off("heartbeat",i),clearTimeout(s),e=Utils.now()-o,n(null,e))},s=setTimeout(function(){t.off("heartbeat",i),n(new ErrorInfo("Timeout waiting for heartbeat response",5e4,500))},this.options.timeouts.realtimeRequestTimeout);return t.on("heartbeat",i),void t.ping(r)}var a,c,l;"connected"===this.state.state?(a=!1,l=function(){a||(a=!0,Utils.nextTick(function(){c.ping(null,n)}))},(c=this).on("transport.active",l),this.ping(this.activeProtocol.getTransport(),function(e,t){c.off("transport.active",l),a||(a=!0,n(e,t))})):n(new ErrorInfo("Unable to ping service; not connected",4e4,400))},h.prototype.abort=function(e){this.activeProtocol.getTransport().fail(e)},h.prototype.registerProposedTransport=function(e){this.proposedTransports.push(e)},h.prototype.getTransportPreference=function(){return this.transportPreference||t&&WebStorage.get(n)},h.prototype.persistTransportPreference=function(e){Utils.arrIn(Defaults.upgradeTransports,e.shortName)&&(this.transportPreference=e.shortName,t&&WebStorage.set(n,e.shortName))},h.prototype.unpersistTransportPreference=function(){this.transportPreference=null,t&&WebStorage.remove(n)},h.prototype.actOnErrorFromAuthorize=function(e){var t;40171===e.code?this.notifyState({state:"failed",error:e}):403===e.statusCode?(t="Client configured authentication provider returned 403; failing the connection",Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",t),this.notifyState({state:"failed",error:new ErrorInfo(t,80019,403,e)})):(t="Client configured authentication provider request failed",Logger.logAction(Logger.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",t),this.notifyState({state:this.state.failState,error:new ErrorInfo(t,80019,401,e)}))},h.prototype.onConnectionDetailsUpdate=function(e,t){if(e){(this.connectionDetails=e).maxMessageSize&&(this.options.maxMessageSize=e.maxMessageSize);var n=e.clientId;if(n){var o=this.realtime.auth._uncheckedSetClientId(n);if(o)return Logger.logAction(Logger.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",o.message),void t.fail(o)}o=e.connectionStateTtl;o&&(this.connectionStateTtl=o),this.maxIdleInterval=e.maxIdleInterval,this.emit("connectiondetails",e)}},h}(),Transport=function(){var t=ProtocolMessage.Action,e=ProtocolMessage.fromValues({action:t.CLOSE}),n=ProtocolMessage.fromValues({action:t.DISCONNECT});function o(e,t,n){EventEmitter.call(this),(this.connectionManager=e).registerProposedTransport(this),this.auth=t,this.params=n,this.timeouts=n.options.timeouts,this.format=n.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}return Utils.inherits(o,EventEmitter),o.prototype.connect=function(){},o.prototype.close=function(){this.isConnected&&this.requestClose(),this.finish("closed",ConnectionError.closed)},o.prototype.disconnect=function(e){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",e||ConnectionError.disconnected)},o.prototype.fail=function(e){this.isConnected&&this.requestDisconnect(),this.finish("failed",e||ConnectionError.failed)},o.prototype.finish=function(e,t){this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout(this.idleTimer),this.idleTimer=null,this.emit(e,t),this.dispose())},o.prototype.onProtocolMessage=function(e){switch(Logger.shouldLog(Logger.LOG_MICRO)&&Logger.logAction(Logger.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+ProtocolMessage.stringify(e)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),e.action){case t.HEARTBEAT:Logger.logAction(Logger.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",e.id);break;case t.CONNECTED:this.onConnect(e),this.emit("connected",e.error,e.connectionId,e.connectionDetails,e);break;case t.CLOSED:this.onClose(e);break;case t.DISCONNECTED:this.onDisconnect(e);break;case t.ACK:this.emit("ack",e.msgSerial,e.count);break;case t.NACK:this.emit("nack",e.msgSerial,e.count,e.error);break;case t.SYNC:if(void 0!==e.connectionId){this.emit("sync",e.connectionId,e);break}this.connectionManager.onChannelMessage(e,this);break;case t.AUTH:this.auth.authorize(function(e){e&&Logger.logAction(Logger.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+Utils.inspectError(e))});break;case t.ERROR:if(Logger.logAction(Logger.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+Utils.inspect(e.error)+(e.channel?", channel: "+e.channel:"")),void 0===e.channel){this.onFatalError(e);break}this.connectionManager.onChannelMessage(e,this);break;default:this.connectionManager.onChannelMessage(e,this)}},o.prototype.onConnect=function(e){this.isConnected=!0;e=e.connectionDetails.maxIdleInterval;e&&(this.maxIdleInterval=e+this.timeouts.realtimeRequestTimeout,this.onActivity())},o.prototype.onDisconnect=function(e){e=e&&e.error;Logger.logAction(Logger.LOG_MINOR,"Transport.onDisconnect()","err = "+Utils.inspectError(e)),this.finish("disconnected",e)},o.prototype.onFatalError=function(e){e=e&&e.error;Logger.logAction(Logger.LOG_MINOR,"Transport.onFatalError()","err = "+Utils.inspectError(e)),this.finish("failed",e)},o.prototype.onClose=function(e){e=e&&e.error;Logger.logAction(Logger.LOG_MINOR,"Transport.onClose()","err = "+Utils.inspectError(e)),this.finish("closed",e)},o.prototype.requestClose=function(){Logger.logAction(Logger.LOG_MINOR,"Transport.requestClose()",""),this.send(e)},o.prototype.requestDisconnect=function(){Logger.logAction(Logger.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(n)},o.prototype.ping=function(e){var t={action:ProtocolMessage.Action.HEARTBEAT};e&&(t.id=e),this.send(ProtocolMessage.fromValues(t))},o.prototype.dispose=function(){Logger.logAction(Logger.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()},o.prototype.onActivity=function(){this.maxIdleInterval&&(this.lastActivity=this.connectionManager.lastActivity=Utils.now(),this.setIdleTimer(this.maxIdleInterval+100))},o.prototype.setIdleTimer=function(e){var t=this;this.idleTimer||(this.idleTimer=setTimeout(function(){t.onIdleTimerExpire()},e))},o.prototype.onIdleTimerExpire=function(){this.idleTimer=null;var e=Utils.now()-this.lastActivity,t=this.maxIdleInterval-e;t<=0?(e="No activity seen from realtime in "+e+"ms; assuming connection has dropped",Logger.logAction(Logger.LOG_ERROR,"Transport.onIdleTimerExpire()",e),this.disconnect(new ErrorInfo(e,80003,408))):this.setIdleTimer(100+t)},o.prototype.onAuthUpdated=function(){},o}(),WebSocketTransport=function(){var r=Platform.WebSocket,o="web_socket";function s(e,t,n){this.shortName=o,n.heartbeats=Platform.useProtocolHeartbeats,Transport.call(this,e,t,n),this.wsHost=Defaults.getHost(n.options,n.host,!0)}return Utils.inherits(s,Transport),(s.isAvailable=function(){return!!r})()&&(ConnectionManager.supportedTransports[o]=s),s.tryConnect=function(e,t,n,o){function r(e){o({event:this.event,error:e})}var i=new s(e,t,n);i.on(["failed","disconnected"],r),i.on("wsopen",function(){Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.tryConnect()","viable transport "+i),i.off(["failed","disconnected"],r),o(null,i)}),i.connect()},s.prototype.createWebSocket=function(e,t){var n=0;if(t)for(var o in t)e+=(n++?"&":"?")+o+"="+t[o];return this.uri=e,new r(e)},s.prototype.toString=function(){return"WebSocketTransport; uri="+this.uri},s.prototype.connect=function(){Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.connect()","starting"),Transport.prototype.connect.call(this);var s=this,a=this.params,e=a.options,c=(e.tls?"wss://":"ws://")+this.wsHost+":"+Defaults.getPort(e)+"/";Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.connect()","uri: "+c),this.auth.getAuthParams(function(e,t){if(!s.isDisposed){var n,o="";for(n in t)o+=" "+n+": "+t[n]+";";if(Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+o+" err: "+e),e)s.disconnect(e);else{var r=a.getConnectParams(t);try{var i=s.wsConnection=s.createWebSocket(c,r);i.binaryType=Platform.binaryType,i.onopen=function(){s.onWsOpen()},i.onclose=function(e){s.onWsClose(e)},i.onmessage=function(e){s.onWsData(e.data)},i.onerror=function(e){s.onWsError(e)},i.on&&i.on("ping",function(){s.onActivity()})}catch(e){Logger.logAction(Logger.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(e.stack||e.message)),s.disconnect(e)}}}})},s.prototype.send=function(e){var t=this.wsConnection;if(t)try{t.send(ProtocolMessage.serialize(e,this.params.format))}catch(e){var n="Exception from ws connection when trying to send: "+Utils.inspectError(e);Logger.logAction(Logger.LOG_ERROR,"WebSocketTransport.send()",n),this.finish("disconnected",new ErrorInfo(n,5e4,500))}else Logger.logAction(Logger.LOG_ERROR,"WebSocketTransport.send()","No socket connection")},s.prototype.onWsData=function(e){Logger.logAction(Logger.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+e.length+"; type = "+typeof e);try{this.onProtocolMessage(ProtocolMessage.deserialize(e,this.format))}catch(e){Logger.logAction(Logger.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+e.stack)}},s.prototype.onWsOpen=function(){Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("wsopen")},s.prototype.onWsClose=function(e){var t,n,o;"object"==typeof e?(t=e.wasClean,n=e.code):t=1e3==(n=e),delete this.wsConnection,t?(Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket"),o=new ErrorInfo("Websocket closed",80003,400)):(o=new ErrorInfo(n="Unclean disconnection of WebSocket ; code = "+n,80003,400),Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.onWsClose()",n)),this.finish("disconnected",o),this.emit("disposed")},s.prototype.onWsError=function(e){Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+e.message);var t=this;Utils.nextTick(function(){t.disconnect(e)})},s.prototype.dispose=function(){Logger.logAction(Logger.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;var e=this.wsConnection;e&&(e.onmessage=function(){},delete this.wsConnection,Utils.nextTick(function(){Logger.logAction(Logger.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),e.close()}))},s}(),CometTransport=function(){function s(e){return(t=e).code&&(!Auth.isTokenErr(t)&&(Utils.arrIn([80015,80017,80030],t.code)||4e4<=t.code&&t.code<5e4))?[ProtocolMessage.fromValues({action:ProtocolMessage.Action.ERROR,error:e})]:[ProtocolMessage.fromValues({action:ProtocolMessage.Action.DISCONNECTED,error:e})];var t}function e(e,t,n){n.format=void 0,n.heartbeats=!0,Transport.call(this,e,t,n),this.stream=!("stream"in n)||n.stream,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}return Utils.inherits(e,Transport),e.REQ_SEND=0,e.REQ_RECV=1,e.REQ_RECV_POLL=2,e.REQ_RECV_STREAM=3,e.prototype.connect=function(){Logger.logAction(Logger.LOG_MINOR,"CometTransport.connect()","starting"),Transport.prototype.connect.call(this);var r=this,e=this.params,t=e.options,n=Defaults.getHost(t,e.host),e=Defaults.getPort(t),t=t.tls?"https://":"http://";this.baseUri=t+n+":"+e+"/comet/";var i=this.baseUri+"connect";Logger.logAction(Logger.LOG_MINOR,"CometTransport.connect()","uri: "+i),this.auth.getAuthParams(function(e,t){var o;e?r.disconnect(e):r.isDisposed||(r.authParams=t,"stream"in(t=r.params.getConnectParams(t))&&(r.stream=t.stream),Logger.logAction(Logger.LOG_MINOR,"CometTransport.connect()","connectParams:"+Utils.toQueryString(t)),o=!1,(t=r.recvRequest=r.createRequest(i,null,t,null,r.stream?3:1)).on("data",function(e){r.recvRequest&&(o||(o=!0,r.emit("preconnect")),r.onData(e))}),t.on("complete",function(e,t,n){r.recvRequest||(e=e||new ErrorInfo("Request cancelled",80003,400)),r.recvRequest=null,o||(o=!0,r.emit("preconnect")),r.onActivity(),e?e.code?r.onData(s(e)):r.disconnect(e):Utils.nextTick(function(){r.recv()})}),t.exec())})},e.prototype.requestClose=function(){Logger.logAction(Logger.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)},e.prototype.requestDisconnect=function(){Logger.logAction(Logger.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)},e.prototype._requestCloseOrDisconnect=function(t){var n,e=t?this.closeUri:this.disconnectUri;e&&((e=(n=this).createRequest(e,null,this.authParams,null,0)).on("complete",function(e){e&&(Logger.logAction(Logger.LOG_ERROR,"CometTransport.request"+(t?"Close()":"Disconnect()"),"request returned err = "+Utils.inspectError(e)),n.finish("disconnected",e))}),e.exec())},e.prototype.dispose=function(){var e;Logger.logAction(Logger.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(Logger.logAction(Logger.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",ConnectionError.disconnected),e=this,Utils.nextTick(function(){e.emit("disposed")}))},e.prototype.onConnect=function(e){var t;this.isDisposed||(t=e.connectionKey,Transport.prototype.onConnect.call(this,e),t=this.baseUri+t,Logger.logAction(Logger.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+t+"; connectionKey = "+e.connectionKey),this.sendUri=t+"/send",this.recvUri=t+"/recv",this.closeUri=t+"/close",this.disconnectUri=t+"/disconnect")},e.prototype.send=function(e){if(this.sendRequest)return this.pendingItems=this.pendingItems||[],void this.pendingItems.push(e);var t=this.pendingItems||[];t.push(e),this.pendingItems=null,this.sendItems(t)},e.prototype.sendAnyPending=function(){var e=this.pendingItems;e&&(this.pendingItems=null,this.sendItems(e))},e.prototype.sendItems=function(e){var n=this,e=this.sendRequest=n.createRequest(n.sendUri,null,n.authParams,this.encodeRequest(e),0);e.on("complete",function(e,t){e&&Logger.logAction(Logger.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+Utils.inspectError(e)),n.sendRequest=null,e?e.code?n.onData(s(e)):n.disconnect(e):(t&&n.onData(t),n.pendingItems&&Utils.nextTick(function(){n.sendRequest||n.sendAnyPending()}))}),e.exec()},e.prototype.recv=function(){var t,e;this.recvRequest||this.isConnected&&((e=(t=this).recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,t.stream?3:2)).on("data",function(e){t.onData(e)}),e.on("complete",function(e){t.recvRequest=null,t.onActivity(),e?e.code?t.onData(s(e)):t.disconnect(e):Utils.nextTick(function(){t.recv()})}),e.exec())},e.prototype.onData=function(e){try{var t=this.decodeResponse(e);if(t&&t.length)for(var n=0;n<t.length;n++)this.onProtocolMessage(ProtocolMessage.fromDeserialized(t[n]))}catch(e){Logger.logAction(Logger.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+e.stack)}},e.prototype.encodeRequest=function(e){return JSON.stringify(e)},e.prototype.decodeResponse=function(e){return"string"==typeof e&&(e=JSON.parse(e)),e},e.prototype.onAuthUpdated=function(e){this.authParams={access_token:e.token}},e}(),Presence=function(){function a(){}function e(e){this.channel=e,this.basePath=e.basePath+"/presence"}return Utils.inherits(e,EventEmitter),e.prototype.get=function(e,t){if(Logger.logAction(Logger.LOG_MICRO,"Presence.get()","channel = "+this.channel.name),void 0===t)if("function"==typeof e)t=e,e=null;else{if(this.channel.rest.options.promises)return Utils.promisify(this,"get",arguments);t=a}var n=this.channel.rest,o=n.options.useBinaryProtocol?"msgpack":"json",r=Http.supportsLinkHeaders?void 0:o,i=Utils.defaultGetHeaders(o);n.options.headers&&Utils.mixin(i,n.options.headers);var s=this.channel.channelOptions;new PaginatedResource(n,this.basePath,i,r,function(e,t,n){return PresenceMessage.fromResponseBody(e,s,!n&&o)}).get(e,t)},e.prototype.history=function(e,t){Logger.logAction(Logger.LOG_MICRO,"Presence.history()","channel = "+this.channel.name),this._history(e,t)},e.prototype._history=function(e,t){if(void 0===t)if("function"==typeof e)t=e,e=null;else{if(this.channel.rest.options.promises)return Utils.promisify(this,"_history",arguments);t=a}var n=this.channel.rest,o=n.options.useBinaryProtocol?"msgpack":"json",r=Http.supportsLinkHeaders?void 0:o,i=Utils.defaultGetHeaders(o);this.channel;n.options.headers&&Utils.mixin(i,n.options.headers);var s=this.channel.channelOptions;new PaginatedResource(n,this.basePath+"/history",i,r,function(e,t,n){return PresenceMessage.fromResponseBody(e,s,!n&&o)}).get(e,t)},e}(),Resource=function(){var y=Platform.msgpack;function c(){}function v(e,n,o,r,i){Http.supportsAuthHeaders?e.auth.getAuthHeaders(function(e,t){e?r(e):i(Utils.mixin(t,n),o)}):e.auth.getAuthParams(function(e,t){e?r(e):i(n,Utils.mixin(t,o))})}function L(e){var t=[];if(e)for(var n in e)t.push(n+"="+e[n]);return t.join("&")}function R(e,t){return e+(t?"?":"")+L(t)}return Utils.arrForEach(Http.methodsWithoutBody,function(s){c[s]=function(e,t,n,o,r,i){c.do(s,e,t,null,n,o,r,i)}}),Utils.arrForEach(Http.methodsWithBody,function(a){c[a]=function(e,t,n,o,r,i,s){c.do(a,e,t,n,o,r,i,s)}}),c.do=function(r,s,a,c,l,u,e,h){var i,g,p,f,d,m;Logger.shouldLog(Logger.LOG_MICRO)&&(i=h,g=r,p=a,f=u,h=function(e,t,n,o,r){e?Logger.logAction(Logger.LOG_MICRO,"Resource."+g+"()","Received Error; "+R(p,f)+"; Error: "+Utils.inspectError(e)):Logger.logAction(Logger.LOG_MICRO,"Resource."+g+"()","Received; "+R(p,f)+"; Headers: "+L(n)+"; StatusCode: "+r+"; Body: "+(BufferUtils.isBuffer(t)?t.toString():t)),i&&i(e,t,n,o,r)}),e&&(h=h&&(d=h,m=e,function(e,t,n,o,r){if(!e||t){if(!o)try{t=Utils.decodeBody(t,m)}catch(e){return void d(e)}if(void 0!==t.statusCode){var i=t.statusCode,s=t.response,a=t.headers;if(i<200||300<=i){o=s&&s.error||e;return o||((o=new Error("Error in unenveloping "+t)).statusCode=i),void d(o,s,a,!0,i)}d(e,s,a,!0,i)}else d(e,t,n,!0,r)}else d(e)}),(u=u||{}).envelope=e),v(s,l,u,h,function i(e,t){Logger.shouldLog(Logger.LOG_MICRO)&&Logger.logAction(Logger.LOG_MICRO,"Resource."+r+"()","Sending; "+R(a,t));var n=[s,a,e,c,t,function(e,t,n,o,r){e&&Auth.isTokenErr(e)?s.auth.authorize(null,null,function(e){e?h(e):v(s,l,u,h,i)}):h(e,t,n,o,r)}];if(c||n.splice(3,1),Logger.shouldLog(Logger.LOG_MICRO)){var o=c;if(0<(e["content-type"]||"").indexOf("msgpack"))try{o=y.decode(c)}catch(e){Logger.logAction(Logger.LOG_MICRO,"Resource."+r+"()","Sending MsgPack Decoding Error: "+Utils.inspectError(e))}Logger.logAction(Logger.LOG_MICRO,"Resource."+r+"()","Sending; "+R(a,t)+"; Body: "+o)}Http[r].apply(this,n)})},c}(),PaginatedResource=function(){function h(e){"string"==typeof e&&(e=e.split(","));for(var t={},n=0;n<e.length;n++){var o,r=e[n].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);!r||(o=(o=(o=r[1]).match(/^\.\/(\w+)\?(.*)$/))&&Utils.parseQueryString(o[2]))&&(t[r[2]]=o)}return t}function e(e,t,n,o,r,i){this.rest=e,this.path=t,this.headers=n,this.envelope=o,this.bodyHandler=r,this.useHttpPaginatedResponse=i||!1}function g(e,t,n){var o;this.resource=e,this.items=t,n&&(o=this,"first"in n&&(this.first=function(e){if(!e&&o.resource.rest.options.promises)return Utils.promisify(o,"first",[]);o.get(n.first,e)}),"current"in n&&(this.current=function(e){if(!e&&o.resource.rest.options.promises)return Utils.promisify(o,"current",[]);o.get(n.current,e)}),this.next=function(e){if(!e&&o.resource.rest.options.promises)return Utils.promisify(o,"next",[]);"next"in n?o.get(n.next,e):e(null,null)},this.hasNext=function(){return"next"in n},this.isLast=function(){return!this.hasNext()})}function p(e,t,n,o,r,i){g.call(this,e,t,r),this.statusCode=o,this.success=o<300&&200<=o,this.headers=n,this.errorCode=i&&i.code,this.errorMessage=i&&i.message}return Utils.arrForEach(Http.methodsWithoutBody,function(t){e.prototype[t]=function(e,i){var s=this;Resource[t](s.rest,s.path,s.headers,e,s.envelope,function(e,t,n,o,r){s.handlePage(e,t,n,o,r,i)})}}),Utils.arrForEach(Http.methodsWithBody,function(n){e.prototype[n]=function(e,t,i){var s=this;Resource[n](s.rest,s.path,t,s.headers,e,s.envelope,function(e,t,n,o,r){i&&s.handlePage(e,t,n,o,r,i)})}}),e.prototype.handlePage=function(t,e,n,o,r,i){if(t&&(s=t,a=e,!this.useHttpPaginatedResponse||!a&&"number"!=typeof s.code))return Logger.logAction(Logger.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+Utils.inspectError(t)),void i(t);var s,a,c,l,u;try{c=this.bodyHandler(e,n,o)}catch(e){return void i(t||e)}n&&(l=n.Link||n.link)&&(u=h(l)),this.useHttpPaginatedResponse?i(null,new p(this,c,n,r,u,t)):i(null,new g(this,c,u))},g.prototype.get=function(e,i){var s=this.resource;Resource.get(s.rest,s.path,s.headers,e,s.envelope,function(e,t,n,o,r){s.handlePage(e,t,n,o,r,i)})},Utils.inherits(p,g),e}(),Auth=function(){var h,o,g=Math.pow(2,17);function i(){}function p(e){return Utils.isErrorInfo(e)?(e.code||(403===e.statusCode?e.code=40300:(e.code=40170,e.statusCode=401)),e):new ErrorInfo(Utils.inspectError(e),e.code||40170,e.statusCode||401)}function f(e){if(!e)return"";"string"==typeof e&&(e=JSON.parse(e));var t={},n=Utils.keysArray(e,!0);if(!n)return"";n.sort();for(var o=0;o<n.length;o++)t[n[o]]=e[n[o]].sort();return JSON.stringify(t)}function r(e){if(e.authCallback)Logger.logAction(Logger.LOG_MINOR,"Auth()","using token auth with authCallback");else if(e.authUrl)Logger.logAction(Logger.LOG_MINOR,"Auth()","using token auth with authUrl");else if(e.key)Logger.logAction(Logger.LOG_MINOR,"Auth()","using token auth with client-side signing");else{if(!e.tokenDetails){e="authOptions must include valid authentication parameters";throw Logger.logAction(Logger.LOG_ERROR,"Auth()",e),new Error(e)}Logger.logAction(Logger.LOG_MINOR,"Auth()","using token auth with supplied token only")}}h=Platform.createHmac?(o=function(e){return Buffer.from(e,"ascii").toString("base64")},function(e,t){t=Platform.createHmac("SHA256",t);return t.update(e),t.digest("base64")}):(o=Base64.encode,function(e,t){return CryptoJS.HmacSHA256(e,t).toString(CryptoJS.enc.Base64)});var s=0;function e(e,t){if(this.client=e,this.tokenParams=t.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,(o=t).useTokenAuth||(!("useTokenAuth"in(e=o))||e.useTokenAuth)&&(o.authCallback||o.authUrl||o.token||o.tokenDetails)){if(t.key&&!h){var n="client-side token request signing not supported";throw Logger.logAction(Logger.LOG_ERROR,"Auth()",n),new Error(n)}(o=t).key||o.authCallback||o.authUrl||Logger.logAction(Logger.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(t.defaultTokenParams,t),r(this.authOptions)}else{if(!t.key){n="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw Logger.logAction(Logger.LOG_ERROR,"Auth()",n),new ErrorInfo(n,40160,401)}Logger.logAction(Logger.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(t)}var o}return e.prototype.authorize=function(e,t,n){if("function"!=typeof e||n?"function"!=typeof t||n||(n=t,t=null):(n=e,t=e=null),!n){if(this.client.options.promises)return Utils.promisify(this,"authorize",arguments);n=i}var o=this;if(t&&t.key&&this.authOptions.key!==t.key)throw new ErrorInfo("Unable to update auth options with incompatible key",40102,401);t&&"force"in t&&(Logger.logAction(Logger.LOG_ERROR,"Auth.authorize","Deprecation warning: specifying {force: true} in authOptions is no longer necessary, authorize() now always gets a new token. Please remove this, as in version 1.0 and later, having a non-null authOptions will overwrite stored library authOptions, which may not be what you want"),Utils.isOnlyPropIn(t,"force")&&(t=null)),this._forceNewToken(e,t,function(e,t){return e?(o.client.connection&&o.client.connection.connectionManager.actOnErrorFromAuthorize(e),void n(e)):void(o.client.connection?o.client.connection.connectionManager.onAuthUpdated(t,n):n(null,t))})},e.prototype.authorise=function(){Logger.deprecated("Auth.authorise","Auth.authorize"),this.authorize.apply(this,arguments)},e.prototype._forceNewToken=function(e,t,n){var o=this;this.tokenDetails=null,this._saveTokenOptions(e,t),r(this.authOptions),this._ensureValidAuthCredentials(!0,function(e,t){delete o.tokenParams.timestamp,delete o.authOptions.queryTime,n(e,t)})},e.prototype.requestToken=function(e,s,a){if("function"!=typeof e||a?"function"!=typeof s||a||(a=s,s=null):(a=e,s=e=null),!a&&this.client.options.promises)return Utils.promisify(this,"requestToken",arguments);s=s||this.authOptions,e=e||Utils.copy(this.tokenParams),a=a||i;var t,c=this.client;if(s.authCallback)Logger.logAction(Logger.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),t=s.authCallback;else if(s.authUrl)Logger.logAction(Logger.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),t=function(e,i){var t=Utils.mixin({accept:"application/json, text/plain"},s.authHeaders),n=s.authMethod&&"post"===s.authMethod.toLowerCase();n||-1<(o=s.authUrl.indexOf("?"))&&(r=Utils.parseQueryString(s.authUrl.slice(o)),s.authUrl=s.authUrl.slice(0,o),s.authParams=Utils.mixin(r,s.authParams));var o=Utils.mixin({},s.authParams||{},e),r=function(e,t,n,o){var r;if(e?Logger.logAction(Logger.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+Utils.inspectError(e)):(r=n["content-type"],Logger.logAction(Logger.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+r+"; body: "+Utils.inspectBody(t))),e||o)return i(e,t);if(BufferUtils.isBuffer(t)&&(t=t.toString()),r){o=-1<r.indexOf("application/json"),e=-1<r.indexOf("text/plain")||-1<r.indexOf("application/jwt");if(o||e){if(o){if(t.length>g)return void i(new ErrorInfo("authUrl response exceeded max permitted length",40170,401));try{t=JSON.parse(t)}catch(e){return void i(new ErrorInfo("Unexpected error processing authURL response; err = "+e.message,40170,401))}}i(null,t,r)}else i(new ErrorInfo("authUrl responded with unacceptable content-type "+r+", should be either text/plain, application/jwt or application/json",40170,401))}else i(new ErrorInfo("authUrl response is missing a content-type header",40170,401))};Logger.logAction(Logger.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+s.authUrl+"; Params: "+JSON.stringify(o)+"; method: "+(n?"POST":"GET")),n?((e=t||{})["content-type"]="application/x-www-form-urlencoded",n=Utils.toQueryString(o).slice(1),Http.postUri(c,s.authUrl,e,n,{},r)):Http.getUri(c,s.authUrl,t||{},o,r)};else{if(!s.key)return Logger.logAction(Logger.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),void a(new ErrorInfo("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)",40171,403));var n=this;Logger.logAction(Logger.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),t=function(e,t){n.createTokenRequest(e,s,t)}}"capability"in e&&(e.capability=f(e.capability));var l=!1,o=this.client.options.timeouts.realtimeRequestTimeout,u=setTimeout(function(){l=!0;var e="Token request callback timed out after "+o/1e3+" seconds";Logger.logAction(Logger.LOG_ERROR,"Auth.requestToken()",e),a(new ErrorInfo(e,40170,401))},o);t(e,function(e,t,n){if(!l){if(clearTimeout(u),e)return Logger.logAction(Logger.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+Utils.inspectError(e)),void a(p(e));if("string"!=typeof t){if("object"!=typeof t){var o="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof t;return Logger.logAction(Logger.LOG_ERROR,"Auth.requestToken()",o),void a(new ErrorInfo(o,40170,401))}var r,i=JSON.stringify(t).length;if(g<i&&!s.suppressMaxLengthCheck)a(new ErrorInfo("Token request/details object exceeded max permitted stringified size (was "+i+" bytes)",40170,401));else if("issued"in t)a(null,t);else{if(!("keyName"in t)){var o="Expected token request callback to call back with a token string, token request object, or token details object";return Logger.logAction(Logger.LOG_ERROR,"Auth.requestToken()",o),void a(new ErrorInfo(o,40170,401))}e=function(e,t,n,o){return e?(Logger.logAction(Logger.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+Utils.inspectError(e)),void a(p(e))):(o||(t=JSON.parse(t)),Logger.logAction(Logger.LOG_MINOR,"Auth.getToken()","token received"),void a(null,t))},r="/keys/"+(i=t).keyName+"/requestToken",o=Utils.defaultPostHeaders(),s.requestHeaders&&Utils.mixin(o,s.requestHeaders),Logger.logAction(Logger.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+r+"; Token params: "+JSON.stringify(i)),i=JSON.stringify(i),Http.post(c,function(e){return c.baseUri(e)+r},o,i,null,e)}}else 0===t.length?a(new ErrorInfo("Token string is empty",40170,401)):t.length>g?a(new ErrorInfo("Token string exceeded max permitted length (was "+t.length+" bytes)",40170,401)):"undefined"===t||"null"===t?a(new ErrorInfo("Token string was literal null/undefined",40170,401)):"{"!==t[0]||n&&-1<n.indexOf("application/jwt")?a(null,{token:t}):a(new ErrorInfo("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401))}})},e.prototype.createTokenRequest=function(e,t,n){if("function"!=typeof e||n?"function"!=typeof t||n||(n=t,t=null):(n=e,t=e=null),!n&&this.client.options.promises)return Utils.promisify(this,"createTokenRequest",arguments);t=t||this.authOptions,e=e||Utils.copy(this.tokenParams);var o,r,i,s,a,c,l,u=t.key;u?(u=(o=u.split(":"))[0],(r=o[1])?""!==e.clientId?("capability"in e&&(e.capability=f(e.capability)),i=Utils.mixin({keyName:u},e),s=e.clientId||"",a=e.ttl||"",c=e.capability||"",u=this,l=function(){var e=i.nonce||(i.nonce=("000000"+Math.floor(1e16*Math.random())).slice(-16)),t=i.timestamp,e=i.keyName+"\n"+a+"\n"+c+"\n"+s+"\n"+t+"\n"+e+"\n";i.mac=i.mac||h(e,r),Logger.logAction(Logger.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),n(null,i)},i.timestamp?l():u.getTimestamp(t&&t.queryTime,function(e,t){e?n(e):(i.timestamp=t,l())})):n(new ErrorInfo("clientId can’t be an empty string",40012,400)):n(new ErrorInfo("Invalid key specified",40101,403))):n(new ErrorInfo("No key specified",40101,403))},e.prototype.getAuthParams=function(n){"basic"==this.method?n(null,{key:this.key}):this._ensureValidAuthCredentials(!1,function(e,t){e?n(e):n(null,{access_token:t.token})})},e.prototype.getAuthHeaders=function(n){"basic"==this.method?n(null,{authorization:"Basic "+this.basicKey}):this._ensureValidAuthCredentials(!1,function(e,t){e?n(e):n(null,{authorization:"Bearer "+o(t.token)})})},e.prototype.getTimestamp=function(e,t){this.isTimeOffsetSet()||!e&&!this.authOptions.queryTime?t(null,this.getTimestampUsingOffset()):this.client.time(t)},e.prototype.getTimestampUsingOffset=function(){return Utils.now()+(this.client.serverTimeOffset||0)},e.prototype.isTimeOffsetSet=function(){return null!==this.client.serverTimeOffset},e.prototype._saveBasicOptions=function(e){this.method="basic",this.key=e.key,this.basicKey=o(e.key),this.authOptions=e||{},"clientId"in e&&this._userSetClientId(e.clientId)},e.prototype._saveTokenOptions=function(e,t){this.method="token",e&&(this.tokenParams=e),t&&(t.token&&(t.tokenDetails="string"==typeof t.token?{token:t.token}:t.token),t.tokenDetails&&(this.tokenDetails=t.tokenDetails),"clientId"in t&&this._userSetClientId(t.clientId),this.authOptions=t)},e.prototype._ensureValidAuthCredentials=function(e,t){var o,r=this,n=this.tokenDetails;if(n){if(this._tokenClientIdMismatch(n.clientId))return void t(new ErrorInfo("Mismatch between clientId in token ("+n.clientId+") and current clientId ("+this.clientId+")",40102,403));if(!this.isTimeOffsetSet()||!n.expires||n.expires>=this.getTimestampUsingOffset())return Logger.logAction(Logger.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+n.expires),void t(null,n);Logger.logAction(Logger.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}(this.waitingForTokenRequest||(this.waitingForTokenRequest=Multicaster())).push(t),null!==this.currentTokenRequestId&&!e||(o=this.currentTokenRequestId=s++,this.requestToken(this.tokenParams,this.authOptions,function(e,t){var n;r.currentTokenRequestId>o?Logger.logAction(Logger.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"):(r.currentTokenRequestId=null,n=r.waitingForTokenRequest||i,r.waitingForTokenRequest=null,e?n(e):n(null,r.tokenDetails=t))}))},e.prototype._userSetClientId=function(e){if("string"!=typeof e&&null!==e)throw new ErrorInfo("clientId must be either a string or null",40012,400);if("*"===e)throw new ErrorInfo('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);e=this._uncheckedSetClientId(e);if(e)throw e},e.prototype._uncheckedSetClientId=function(e){if(this._tokenClientIdMismatch(e)){var t="Unexpected clientId mismatch: client has "+this.clientId+", requested "+e,n=new ErrorInfo(t,40102,401);return Logger.logAction(Logger.LOG_ERROR,"Auth._uncheckedSetClientId()",t),n}return this.clientId=this.tokenParams.clientId=e,null},e.prototype._tokenClientIdMismatch=function(e){return this.clientId&&"*"!==this.clientId&&e&&"*"!==e&&this.clientId!==e},e.isTokenErr=function(e){return e.code&&40140<=e.code&&e.code<40150},e}(),Rest=function(){function u(){}var h=Platform.msgpack;function o(t){if(!(this instanceof o))return new o(t);if(!t){var e="no options provided";throw Logger.logAction(Logger.LOG_ERROR,"Rest()",e),new Error(e)}if((t=Defaults.objectifyOptions(t)).log&&Logger.setLog(t.log.level,t.log.handler),Logger.logAction(Logger.LOG_MICRO,"Rest()","initialized with clientOptions "+Utils.inspect(t)),this.options=Defaults.normaliseOptions(t),t.key){var n=t.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!n){e="invalid key parameter";throw Logger.logAction(Logger.LOG_ERROR,"Rest()",e),new Error(e)}t.keyName=n[1],t.keySecret=n[2]}if("clientId"in t){if("string"!=typeof t.clientId&&null!==t.clientId)throw new ErrorInfo("clientId must be either a string or null",40012,400);if("*"===t.clientId)throw new ErrorInfo('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}Logger.logAction(Logger.LOG_MINOR,"Rest()","started; version = "+Defaults.libstring),this.baseUri=this.authority=function(e){return Defaults.getHttpScheme(t)+e+":"+Defaults.getPort(t,!1)},this._currentFallback=null,this.serverTimeOffset=null,this.auth=new Auth(this,t),this.channels=new r(this),this.push=new Push(this)}function r(e){this.rest=e,this.all={}}return o.prototype.stats=function(e,t){if(void 0===t)if("function"==typeof e)t=e,e=null;else{if(this.options.promises)return Utils.promisify(this,"stats",arguments);t=u}var n=Utils.defaultGetHeaders(),o=this.options.useBinaryProtocol?"msgpack":"json",o=Http.supportsLinkHeaders?void 0:o;this.options.headers&&Utils.mixin(n,this.options.headers),new PaginatedResource(this,"/stats",n,o,function(e,t,n){for(var o=n?e:JSON.parse(e),r=0;r<o.length;r++)o[r]=Stats.fromValues(o[r]);return o}).get(e,t)},o.prototype.time=function(e,r){if(void 0===r)if("function"==typeof e)r=e,e=null;else{if(this.options.promises)return Utils.promisify(this,"time",arguments);r=u}var t=Utils.defaultGetHeaders();this.options.headers&&Utils.mixin(t,this.options.headers);var i=this;Http.get(this,function(e){return i.authority(e)+"/time"},t,e,function(e,t,n,o){if(e)r(e);else{o||(t=JSON.parse(t));t=t[0];if(!t)return(e=new Error("Internal error (unexpected result type from GET /time)")).statusCode=500,void r(e);i.serverTimeOffset=t-Utils.now(),r(null,t)}})},o.prototype.request=function(e,t,n,o,r,i){var s=this.options.useBinaryProtocol,a=s?h.encode:JSON.stringify,c=s?h.decode:JSON.parse,l=s?"msgpack":"json",s=Http.supportsLinkHeaders?void 0:l;n=n||{};l="get"==(e=e.toLowerCase())?Utils.defaultGetHeaders(l):Utils.defaultPostHeaders(l);if(void 0===i){if(this.options.promises)return Utils.promisify(this,"request",[e,t,n,o,r]);i=u}"string"!=typeof o&&(o=a(o)),this.options.headers&&Utils.mixin(l,this.options.headers),r&&Utils.mixin(l,r);s=new PaginatedResource(this,t,l,s,function(e,t,n){return Utils.ensureArray(n?e:c(e))},!0);if(!Utils.arrIn(Http.methods,e))throw new ErrorInfo("Unsupported method "+e,40500,405);Utils.arrIn(Http.methodsWithBody,e)?s[e](n,o,i):s[e](n,i)},o.prototype.setLog=function(e){Logger.setLog(e.level,e.handler)},r.prototype.get=function(e,t){e=String(e);var n=this.all[e];return n?t&&n.setOptions(t):this.all[e]=n=new Channel(this.rest,e,t),n},r.prototype.release=function(e){delete this.all[String(e)]},o}();Rest.Promise=function(e){return(e=Defaults.objectifyOptions(e)).promises=!0,new Rest(e)},Rest.Callbacks=Rest;var Realtime=function(){function t(e){if(!(this instanceof t))return new t(e);Logger.logAction(Logger.LOG_MINOR,"Realtime()",""),Rest.call(this,e),this.connection=new Connection(this,this.options),this.channels=new n(this),!1!==e.autoConnect&&this.connect()}function n(e){EventEmitter.call(this),this.realtime=e,this.all={},this.inProgress={};var t=this;e.connection.connectionManager.on("transport.active",function(){t.onTransportActive()})}return Utils.inherits(t,Rest),t.prototype.connect=function(){Logger.logAction(Logger.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()},t.prototype.close=function(){Logger.logAction(Logger.LOG_MINOR,"Realtime.close()",""),this.connection.close()},Utils.inherits(n,EventEmitter),n.prototype.onChannelMessage=function(e){var t,n=e.channel;void 0!==n?(t=this.all[n])?t.onMessage(e):Logger.logAction(Logger.LOG_ERROR,"Channels.onChannelMessage()","received event for non-existent channel: "+n):Logger.logAction(Logger.LOG_ERROR,"Channels.onChannelMessage()","received event unspecified channel, action = "+e.action)},n.prototype.onTransportActive=function(){for(var e in this.all){var t=this.all[e];"attaching"===t.state||"detaching"===t.state?t.checkPendingState():"suspended"===t.state&&t.attach()}},n.prototype.reattach=function(e){for(var t in this.all){var n=this.all[t];"attached"===n.state&&n.requestState("attaching",e)}},n.prototype.resetAttachedMsgIndicators=function(){for(var e in this.all){var t=this.all[e];"attached"===t.state&&(t._attachedMsgIndicator=!1)}},n.prototype.checkAttachedMsgIndicators=function(e){for(var t in this.all){var n,o=this.all[t];"attached"===o.state&&!1===o._attachedMsgIndicator&&(n="30s after a resume, found channel which has not received an attached; channelId = "+t+"; connectionId = "+e,Logger.logAction(Logger.LOG_ERROR,"Channels.checkAttachedMsgIndicators()",n),ErrorReporter.report("error",n,"channel-no-attached-after-resume"),o.requestState("attaching"))}},n.prototype.propogateConnectionInterruption=function(e,t){var n,o=["attaching","attached","detaching","suspended"],r={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"}[e];for(n in this.all){var i=this.all[n];Utils.arrIn(o,i.state)&&i.notifyState(r,t)}},n.prototype.get=function(e,t){e=String(e);var n=this.all[e];if(n){if(t){if(n._shouldReattachToSetOptions(t))throw new ErrorInfo("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);n.setOptions(t)}}else n=this.all[e]=new RealtimeChannel(this.realtime,e,t);return n},n.prototype.release=function(e){e=String(e);var t=this.all[e];if(t){t=t.getReleaseErr();if(t)throw t;delete this.all[e]}},n.prototype.setInProgress=function(e,t,n){this.inProgress[e.name]=this.inProgress[e.name]||{},!(this.inProgress[e.name][t]=n)&&this.hasNopending()&&this.emit("nopending")},n.prototype.onceNopending=function(e){this.hasNopending()?e():this.once("nopending",e)},n.prototype.hasNopending=function(){return Utils.arrEvery(Utils.valuesArray(this.inProgress,!0),function(e){return!Utils.containsValue(e,!0)})},t}();Realtime.Promise=function(e){return(e=Defaults.objectifyOptions(e)).promises=!0,new Realtime(e)},Realtime.Callbacks=Realtime;var ConnectionStateChange=function(e,t,n,o){this.previous=e,this.current=t,n&&(this.retryIn=n),o&&(this.reason=o)},ChannelStateChange=function(e,t,n,o){this.previous=e,"attached"===(this.current=t)&&(this.resumed=n),o&&(this.reason=o)},Connection=function(){function t(){}function e(e,t){EventEmitter.call(this),this.ably=e,this.connectionManager=new ConnectionManager(e,t),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.serial=void 0,this.timeSerial=void 0,this.recoveryKey=void 0,this.errorReason=null;var n=this;this.connectionManager.on("connectionstate",function(e){var t=n.state=e.current;Utils.nextTick(function(){n.emit(t,e)})}),this.connectionManager.on("update",function(e){Utils.nextTick(function(){n.emit("update",e)})})}return Utils.inherits(e,EventEmitter),e.prototype.whenState=function(e,t){return EventEmitter.prototype.whenState.call(this,e,this.state,t,new ConnectionStateChange(void 0,e))},e.prototype.connect=function(){Logger.logAction(Logger.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})},e.prototype.ping=function(e){if(Logger.logAction(Logger.LOG_MINOR,"Connection.ping()",""),!e){if(this.ably.options.promises)return Utils.promisify(this,"ping",arguments);e=t}this.connectionManager.ping(null,e)},e.prototype.close=function(){Logger.logAction(Logger.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})},e}(),Push=function(){function c(){}function t(e){this.rest=e,this.deviceRegistrations=new n(e),this.channelSubscriptions=new o(e)}function n(e){this.rest=e}function o(e){this.rest=e}return t.prototype.publish=function(e,t,n){var o=this.rest,r=o.options.useBinaryProtocol?"msgpack":"json",i=Utils.mixin({recipient:e},t),s=Utils.defaultPostHeaders(r),a={};if("function"!=typeof n){if(this.rest.options.promises)return Utils.promisify(this,"publish",arguments);n=c}o.options.headers&&Utils.mixin(s,o.options.headers),o.options.pushFullWait&&Utils.mixin(a,{fullWait:"true"}),i=Utils.encodeBody(i,r),Resource.post(o,"/push/publish",i,s,a,!1,function(e){n(e)})},n.prototype.save=function(e,r){var t=this.rest,i=t.options.useBinaryProtocol?"msgpack":"json",n=DeviceDetails.fromValues(e),o=Utils.defaultPostHeaders(i),s={};if("function"!=typeof r){if(this.rest.options.promises)return Utils.promisify(this,"save",arguments);r=c}t.options.headers&&Utils.mixin(o,t.options.headers),t.options.pushFullWait&&Utils.mixin(s,{fullWait:"true"}),n=Utils.encodeBody(n,i),Resource.put(t,"/push/deviceRegistrations/"+encodeURIComponent(e.id),n,o,s,!1,function(e,t,n,o){r(e,!e&&DeviceDetails.fromResponseBody(t,!o&&i))})},n.prototype.get=function(e,r){var t=this.rest,i=t.options.useBinaryProtocol?"msgpack":"json",n=Utils.defaultGetHeaders(i),o=e.id||e;if("function"!=typeof r){if(this.rest.options.promises)return Utils.promisify(this,"get",arguments);r=c}"string"==typeof o&&o.length?(t.options.headers&&Utils.mixin(n,t.options.headers),Resource.get(t,"/push/deviceRegistrations/"+encodeURIComponent(o),n,{},!1,function(e,t,n,o){r(e,!e&&DeviceDetails.fromResponseBody(t,!o&&i))})):r(new ErrorInfo("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400))},n.prototype.list=function(e,t){var n=this.rest,o=n.options.useBinaryProtocol?"msgpack":"json",r=Http.supportsLinkHeaders?void 0:o,i=Utils.defaultGetHeaders(o);if("function"!=typeof t){if(this.rest.options.promises)return Utils.promisify(this,"list",arguments);t=c}n.options.headers&&Utils.mixin(i,n.options.headers),new PaginatedResource(n,"/push/deviceRegistrations",i,r,function(e,t,n){return DeviceDetails.fromResponseBody(e,!n&&o)}).get(e,t)},n.prototype.remove=function(e,t){var n=this.rest,o=n.options.useBinaryProtocol?"msgpack":"json",r=Utils.defaultGetHeaders(o),i={},o=e.id||e;if("function"!=typeof t){if(this.rest.options.promises)return Utils.promisify(this,"remove",arguments);t=c}"string"==typeof o&&o.length?(n.options.headers&&Utils.mixin(r,n.options.headers),n.options.pushFullWait&&Utils.mixin(i,{fullWait:"true"}),Resource.delete(n,"/push/deviceRegistrations/"+encodeURIComponent(o),r,i,!1,function(e){t(e)})):t(new ErrorInfo("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400))},n.prototype.removeWhere=function(e,t){var n=this.rest,o=n.options.useBinaryProtocol?"msgpack":"json",o=Utils.defaultGetHeaders(o);if("function"!=typeof t){if(this.rest.options.promises)return Utils.promisify(this,"removeWhere",arguments);t=c}n.options.headers&&Utils.mixin(o,n.options.headers),n.options.pushFullWait&&Utils.mixin(e,{fullWait:"true"}),Resource.delete(n,"/push/deviceRegistrations",o,e,!1,function(e){t(e)})},o.prototype.save=function(e,r){var t=this.rest,i=t.options.useBinaryProtocol?"msgpack":"json",n=PushChannelSubscription.fromValues(e),o=Utils.defaultPostHeaders(i),s={};if("function"!=typeof r){if(this.rest.options.promises)return Utils.promisify(this,"save",arguments);r=c}t.options.headers&&Utils.mixin(o,t.options.headers),t.options.pushFullWait&&Utils.mixin(s,{fullWait:"true"}),n=Utils.encodeBody(n,i),Resource.post(t,"/push/channelSubscriptions",n,o,s,!1,function(e,t,n,o){r(e,!e&&PushChannelSubscription.fromResponseBody(t,!o&&i))})},o.prototype.list=function(e,t){var n=this.rest,o=n.options.useBinaryProtocol?"msgpack":"json",r=Http.supportsLinkHeaders?void 0:o,i=Utils.defaultGetHeaders(o);if("function"!=typeof t){if(this.rest.options.promises)return Utils.promisify(this,"list",arguments);t=c}n.options.headers&&Utils.mixin(i,n.options.headers),new PaginatedResource(n,"/push/channelSubscriptions",i,r,function(e,t,n){return PushChannelSubscription.fromResponseBody(e,!n&&o)}).get(e,t)},o.prototype.remove=o.prototype.removeWhere=function(e,t){var n=this.rest,o=n.options.useBinaryProtocol?"msgpack":"json",o=Utils.defaultGetHeaders(o);if("function"!=typeof t){if(this.rest.options.promises)return Utils.promisify(this,"removeWhere",arguments);t=c}n.options.headers&&Utils.mixin(o,n.options.headers),n.options.pushFullWait&&Utils.mixin(e,{fullWait:"true"}),Resource.delete(n,"/push/channelSubscriptions",o,e,!1,function(e){t(e)})},o.prototype.listChannels=function(e,t){var n=this.rest,r=n.options.useBinaryProtocol?"msgpack":"json",o=Http.supportsLinkHeaders?void 0:r,i=Utils.defaultGetHeaders(r);if("function"!=typeof t){if(this.rest.options.promises)return Utils.promisify(this,"listChannels",arguments);t=c}n.options.headers&&Utils.mixin(i,n.options.headers),n.options.pushFullWait&&Utils.mixin(e,{fullWait:"true"}),new PaginatedResource(n,"/push/channels",i,o,function(e,t,n){!n&&r&&(e=Utils.decodeBody(e,r));for(var o=0;o<e.length;o++)e[o]=String(e[o]);return e}).get(e,t)},function(e){this.rest=e,this.admin=new t(e)}}(),Channel=function(){function u(){}function e(e,t,n){Logger.logAction(Logger.LOG_MINOR,"Channel()","started; name = "+t),EventEmitter.call(this),this.rest=e,this.name=t,this.basePath="/channels/"+encodeURIComponent(t),this.presence=new Presence(this),this.setOptions(n)}return Utils.inherits(e,EventEmitter),e.prototype.setOptions=function(e){if(this.channelOptions=e=e||{},e.cipher){if(!Crypto)throw new Error("Encryption not enabled; use ably.encryption.js instead");var t=Crypto.getCipher(e.cipher);e.cipher=t.cipherParams,e.channelCipher=t.cipher}else"cipher"in e&&(e.cipher=null,e.channelCipher=null)},e.prototype.history=function(e,t){if(Logger.logAction(Logger.LOG_MICRO,"Channel.history()","channel = "+this.name),void 0===t)if("function"==typeof e)t=e,e=null;else{if(this.rest.options.promises)return Utils.promisify(this,"history",arguments);t=u}this._history(e,t)},e.prototype._history=function(e,t){var n=this.rest,o=n.options.useBinaryProtocol?"msgpack":"json",r=Http.supportsLinkHeaders?void 0:o,i=Utils.defaultGetHeaders(o);n.options.headers&&Utils.mixin(i,n.options.headers);var s=this.channelOptions;new PaginatedResource(n,this.basePath+"/messages",i,r,function(e,t,n){return Message.fromResponseBody(e,s,!n&&o)}).get(e,t)},e.prototype.publish=function(){var n,o,e=arguments[0],t=arguments[1],r=arguments[arguments.length-1],i=this;if("function"!=typeof r){if(this.rest.options.promises)return Utils.promisify(this,"publish",arguments);r=u}if("string"==typeof e||null===e)n=[Message.fromValues({name:e,data:t})],o=arguments[2];else if(Utils.isObject(e))n=[Message.fromValues(e)],o=arguments[1];else{if(!Utils.isArray(e))throw new ErrorInfo("The single-argument form of publish() expects a message object or an array of message objects",40013,400);n=Message.fromValuesArray(e),o=arguments[1]}"object"==typeof o&&o||(o={});var s,e=this.rest,a=e.options,c=a.useBinaryProtocol?"msgpack":"json",e=e.options.idempotentRestPublishing,l=Utils.defaultPostHeaders(c);a.headers&&Utils.mixin(l,a.headers),e&&(e=n,Utils.arrEvery(e,function(e){return!e.id}))&&(s=Utils.randomString(9),Utils.arrForEach(n,function(e,t){e.id=s+":"+t.toString()})),Message.encodeArray(n,this.channelOptions,function(e){var t;e?r(e):(t=Message.getMessagesSize(n),(e=a.maxMessageSize)<t?r(new ErrorInfo("Maximum size of messages that can be published at once exceeded ( was "+t+" bytes; limit is "+e+" bytes)",40009,400)):i._publish(Message.serialize(n,c),l,o,r))})},e.prototype._publish=function(e,t,n,o){Resource.post(this.rest,this.basePath+"/messages",e,t,n,!1,o)},e}(),RealtimeChannel=function(){function i(){}var m=ProtocolMessage.Action,y="statechange",s="sync";function o(e,t,n){Logger.logAction(Logger.LOG_MINOR,"RealtimeChannel()","started; name = "+t),Channel.call(this,e,t,n),this.realtime=e,this.presence=new RealtimePresence(this,e.options),this.connectionManager=e.connection.connectionManager,this.state="initialized",this.subscriptions=new EventEmitter,this.syncChannelSerial=void 0,this.properties={attachSerial:void 0},this.setOptions(n),this.errorReason=null,this._requestedFlags=null,this._mode=null,this._attachedMsgIndicator=!1,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:e.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new EventEmitter}return Utils.inherits(o,Channel),o.invalidStateError=function(e){return{statusCode:400,code:90001,message:"Channel operation failed as channel state is "+e}},o.progressOps={statechange:y,sync:s},o.processListenerArgs=function(e){return"function"==typeof(e=Array.prototype.slice.call(e))[0]&&e.unshift(null),null==e[e.length-1]&&e.pop(),e},o.prototype.setOptions=function(e,t){if(!t){if(this.rest.options.promises)return Utils.promisify(this,"setOptions",arguments);t=function(e){e&&Logger.logAction(Logger.LOG_ERROR,"RealtimeChannel.setOptions()","Set options failed: "+e.toString())}}var n=function(e){if(e&&"params"in e&&!Utils.isObject(e.params))return new ErrorInfo("options.params must be an object",4e4,400);if(e&&"modes"in e){if(!Utils.isArray(e.modes))return new ErrorInfo("options.modes must be an array",4e4,400);for(var t=0;t<e.modes.length;t++){var n=e.modes[t];if(!n||"string"!=typeof n||!Utils.arrIn(ProtocolMessage.channelModes,String.prototype.toUpperCase.call(n)))return new ErrorInfo("Invalid channel mode: "+n,4e4,400)}}}(e);n?t(n):(Channel.prototype.setOptions.call(this,e),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(e)?(this.attachImpl(),this._allChannelChanges.once(function(e){switch(this.event){case"update":case"attached":return void t(null);default:return void t(e.reason)}})):t())},o.prototype._shouldReattachToSetOptions=function(e){return("attached"===this.state||"attaching"===this.state)&&(e.params||e.modes)},o.prototype.publish=function(){var e=arguments.length,t=arguments[0],n=arguments[e-1];if("function"!=typeof n){if(this.realtime.options.promises)return Utils.promisify(this,"publish",arguments);n=i,++e}if(this.connectionManager.activeState()){if(2==e)if(Utils.isObject(t))t=[Message.fromValues(t)];else{if(!Utils.isArray(t))throw new ErrorInfo("The single-argument form of publish() expects a message object or an array of message objects",40013,400);t=Message.fromValuesArray(t)}else t=[Message.fromValues({name:arguments[0],data:arguments[1]})];var o=this,r=this.realtime.options.maxMessageSize;Message.encodeArray(t,this.channelOptions,function(e){e?n(e):(e=Message.getMessagesSize(t),r<e?n(new ErrorInfo("Maximum size of messages that can be published at once exceeded ( was "+e+" bytes; limit is "+r+" bytes)",40009,400)):o._publish(t,n))})}else n(this.connectionManager.getError())},o.prototype._publish=function(e,t){Logger.logAction(Logger.LOG_MICRO,"RealtimeChannel.publish()","message count = "+e.length);var n=this.state;switch(n){case"failed":case"suspended":t(ErrorInfo.fromValues(o.invalidStateError(n)));break;default:Logger.logAction(Logger.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+n);n=new ProtocolMessage;n.action=m.MESSAGE,n.channel=this.name,n.messages=e,this.sendMessage(n,t)}},o.prototype.onEvent=function(e){Logger.logAction(Logger.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var t=this.subscriptions,n=0;n<e.length;n++){var o=e[n];t.emit(o.name,o)}},o.prototype.attach=function(e,t){if("function"==typeof e&&(t=e,e=null),!t){if(this.realtime.options.promises)return Utils.promisify(this,"attach",arguments);t=function(e){e&&Logger.logAction(Logger.LOG_MAJOR,"RealtimeChannel.attach()","Channel attach failed: "+e.toString())}}if(e)Logger.deprecated("channel.attach() with flags","channel.setOptions() with channelOptions.params"),this._requestedFlags=e;else if("attached"===this.state)return void t();this._attach(!1,null,t)},o.prototype._attach=function(e,t,n){n=n||function(e){e&&Logger.logAction(Logger.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+e.toString())};var o=this.connectionManager;o.activeState()?("attaching"===this.state&&!e||this.requestState("attaching",t),this.once(function(e){switch(this.event){case"attached":n();break;case"detached":case"suspended":case"failed":n(e.reason||o.getError());break;case"detaching":n(new ErrorInfo("Attach request superseded by a subsequent detach request",9e4,409))}})):n(o.getError())},o.prototype.attachImpl=function(){Logger.logAction(Logger.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message"),this.setInProgress(y,!0);var e=ProtocolMessage.fromValues({action:m.ATTACH,channel:this.name,params:this.channelOptions.params});this._requestedFlags?e.encodeModesToFlags(this._requestedFlags):this.channelOptions.modes&&e.encodeModesToFlags(Utils.allToUpperCase(this.channelOptions.modes)),this._attachResume&&e.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(e.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(e,i)},o.prototype.detach=function(t){if(!t){if(this.realtime.options.promises)return Utils.promisify(this,"detach",arguments);t=i}var n=this.connectionManager;if(n.activeState())switch(this.state){case"detached":case"failed":t();break;default:this.requestState("detaching");case"detaching":this.once(function(e){switch(this.event){case"detached":t();break;case"attached":case"suspended":case"failed":t(e.reason||n.getError());break;case"attaching":t(new ErrorInfo("Detach request superseded by a subsequent attach request",9e4,409))}})}else t(n.getError())},o.prototype.detachImpl=function(e){Logger.logAction(Logger.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message"),this.setInProgress(y,!0);var t=ProtocolMessage.fromValues({action:m.DETACH,channel:this.name});this.sendMessage(t,e||i)},o.prototype.subscribe=function(){var e=o.processListenerArgs(arguments),t=e[0],n=e[1],e=e[2];if(!e){if(this.realtime.options.promises)return Utils.promisify(this,"subscribe",[t,n]);e=i}if("failed"!==this.state)return this.subscriptions.on(t,n),this.attach(e);e(ErrorInfo.fromValues(o.invalidStateError("failed")))},o.prototype.unsubscribe=function(){var e=o.processListenerArgs(arguments),t=e[0],e=e[1];this.subscriptions.off(t,e)},o.prototype.sync=function(){switch(this.state){case"initialized":case"detaching":case"detached":throw new ErrorInfo("Unable to sync to channel; not attached",4e4)}var e=this.connectionManager;if(!e.activeState())throw e.getError();var t=ProtocolMessage.fromValues({action:m.SYNC,channel:this.name});this.syncChannelSerial&&(t.channelSerial=this.syncChannelSerial),e.send(t)},o.prototype.sendMessage=function(e,t){this.connectionManager.send(e,this.realtime.options.queueMessages,t)},o.prototype.sendPresence=function(e,t){e=ProtocolMessage.fromValues({action:m.PRESENCE,channel:this.name,presence:Utils.isArray(e)?PresenceMessage.fromValuesArray(e):[PresenceMessage.fromValues(e)]});this.sendMessage(e,t)},o.prototype.onMessage=function(e){var t=!1;switch(e.action){case m.ATTACHED:this._attachedMsgIndicator=!0,this.properties.attachSerial=e.channelSerial,this._mode=e.getMode(),this.params=e.params||{};var n=e.decodeModesFromFlags();this.modes=n&&Utils.allToLowerCase(n)||void 0;var o=e.hasFlag("RESUMED"),r=e.hasFlag("HAS_PRESENCE");"attached"===this.state?(this.setInProgress(y,!1),o||this.presence.onAttached(r),n=new ChannelStateChange(this.state,this.state,o,e.error),this._allChannelChanges.emit("update",n),o&&!this.channelOptions.updateOnAttached||this.emit("update",n)):this.notifyState("attached",e.error,o,r);break;case m.DETACHED:var i=e.error?ErrorInfo.fromValues(e.error):new ErrorInfo("Channel detached",90001,404);"detaching"===this.state?this.notifyState("detached",i):"attaching"===this.state?this.notifyState("suspended",i):this.requestState("attaching",i);break;case m.SYNC:if(t=!0,f=this.syncChannelSerial=e.channelSerial,!e.presence)break;case m.PRESENCE:for(var s=e.presence,a=e.id,c=e.connectionId,l=e.timestamp,u=this.channelOptions,h=0;h<s.length;h++){try{var g=s[h];PresenceMessage.decode(g,u)}catch(e){Logger.logAction(Logger.LOG_ERROR,"RealtimeChannel.onMessage()",e.toString())}g.connectionId||(g.connectionId=c),g.timestamp||(g.timestamp=l),g.id||(g.id=a+":"+h)}this.presence.setPresence(s,t,f);break;case m.MESSAGE:if("attached"!==this.state)return void Logger.logAction(Logger.LOG_MAJOR,"RealtimeChannel.onMessage()",'Message "'+e.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');var p=e.messages,t=p[0],f=p[p.length-1],a=e.id,c=e.connectionId,l=e.timestamp;if(t.extras&&t.extras.delta&&t.extras.delta.from!==this._lastPayload.messageId){var d='Delta message decode failure - previous message not available for message "'+e.id+'" on this channel "'+this.name+'".';Logger.logAction(Logger.LOG_ERROR,"RealtimeChannel.onMessage()",d),this._startDecodeFailureRecovery(new ErrorInfo(d,40018,400));break}for(h=0;h<p.length;h++){d=p[h];try{Message.decode(d,this._decodingContext)}catch(e){switch(Logger.logAction(Logger.LOG_ERROR,"RealtimeChannel.onMessage()",e.toString()),e.code){case 40018:return void this._startDecodeFailureRecovery(e);case 40019:case 40021:return void this.notifyState("failed",e)}}d.connectionId||(d.connectionId=c),d.timestamp||(d.timestamp=l),d.id||(d.id=a+":"+h)}this._lastPayload.messageId=f.id,this._lastPayload.protocolMessageChannelSerial=e.channelSerial,this.onEvent(p);break;case m.ERROR:(i=e.error)&&80016==i.code?this.checkPendingState():this.notifyState("failed",ErrorInfo.fromValues(i));break;default:Logger.logAction(Logger.LOG_ERROR,"RealtimeChannel.onMessage()","Fatal protocol error: unrecognised action ("+e.action+")"),this.connectionManager.abort(ConnectionError.unknownChannelErr)}},o.prototype._startDecodeFailureRecovery=function(e){var t=this;this._lastPayload.decodeFailureRecoveryInProgress||(Logger.logAction(Logger.LOG_MAJOR,"RealtimeChannel.onMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,e,function(){t._lastPayload.decodeFailureRecoveryInProgress=!1}))},o.prototype.onAttached=function(){Logger.logAction(Logger.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)},o.prototype.notifyState=function(e,t,n,o){var r;Logger.logAction(Logger.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+e),this.clearStateTimer(),e!==this.state&&(this.presence.actOnChannelState(e,o,t),"suspended"===e&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),t&&(this.errorReason=t),r=new ChannelStateChange(this.state,e,n,t),n="failed"===e?Logger.LOG_ERROR:Logger.LOG_MAJOR,Logger.logAction(n,'Channel state for channel "'+this.name+'"',e+(t?"; reason: "+t:"")),"attached"===e?(this.onAttached(),this.setInProgress(s,o),this.setInProgress(y,!1)):"detached"!==e&&"failed"!==e&&"suspended"!==e||(this.setInProgress(y,!1),this.setInProgress(s,!1)),"attached"===e?this._attachResume=!0:"detaching"!==e&&"failed"!==e||(this._attachResume=!1),this.state=e,this._allChannelChanges.emit(e,r),this.emit(e,r))},o.prototype.requestState=function(e,t){Logger.logAction(Logger.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+e),this.notifyState(e,t),this.checkPendingState()},o.prototype.checkPendingState=function(){var e=this.connectionManager.state;if(e.sendEvents||e.forceQueueEvents)switch(Logger.logAction(Logger.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync()}else Logger.logAction(Logger.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state)},o.prototype.timeoutPendingState=function(){switch(this.state){case"attaching":var e=new ErrorInfo("Channel attach timed out",90007,408);this.notifyState("suspended",e);break;case"detaching":e=new ErrorInfo("Channel detach timed out",90007,408);this.notifyState("attached",e);break;default:this.checkPendingState()}},o.prototype.startStateTimerIfNotRunning=function(){var e=this;this.stateTimer||(this.stateTimer=setTimeout(function(){Logger.logAction(Logger.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),e.stateTimer=null,e.timeoutPendingState()},this.realtime.options.timeouts.realtimeRequestTimeout))},o.prototype.clearStateTimer=function(){var e=this.stateTimer;e&&(clearTimeout(e),this.stateTimer=null)},o.prototype.startRetryTimer=function(){var e=this;this.retryTimer||(this.retryTimer=setTimeout(function(){"suspended"===e.state&&e.connectionManager.state.sendEvents&&(e.retryTimer=null,Logger.logAction(Logger.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),e.requestState("attaching"))},this.realtime.options.timeouts.channelRetryTimeout))},o.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.suspendTimer=null)},o.prototype.setInProgress=function(e,t){this.rest.channels.setInProgress(this,e,t)},o.prototype.history=function(e,t){if(Logger.logAction(Logger.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name),void 0===t)if("function"==typeof e)t=e,e=null;else{if(this.rest.options.promises)return Utils.promisify(this,"history",arguments);t=i}if(e&&e.untilAttach){if("attached"!==this.state)return void t(new ErrorInfo("option untilAttach requires the channel to be attached",4e4,400));if(!this.properties.attachSerial)return void t(new ErrorInfo("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400));delete e.untilAttach,e.from_serial=this.properties.attachSerial}Channel.prototype._history.call(this,e,t)},o.prototype.whenState=function(e,t){return EventEmitter.prototype.whenState.call(this,e,this.state,t)},o.prototype.getReleaseErr=function(){var e=this.state;return"initialized"===e||"detached"===e||"failed"===e?null:new ErrorInfo("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+e,90001,400)},o}(),RealtimePresence=function(){function a(){}function r(e){return e.clientId+":"+e.connectionId}function n(e){var t=e.channel.realtime,e=t.auth.clientId;return(!e||"*"===e)&&"connected"===t.connection.state}function e(e,t){Presence.call(this,e),this.syncComplete=!1,this.members=new o(this),this._myMembers=new o(this),this.subscriptions=new EventEmitter,this.pendingPresence=[]}function o(e){EventEmitter.call(this),this.presence=e,this.map={},this.syncInProgress=!1,this.residualMembers=null}function i(e,t){if(e.isSynthesized()||t.isSynthesized())return e.timestamp>t.timestamp;e=e.parseId(),t=t.parseId();return e.msgSerial===t.msgSerial?e.index>t.index:e.msgSerial>t.msgSerial}return Utils.inherits(e,Presence),e.prototype.enter=function(e,t){if(n(this))throw new ErrorInfo("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,e,"enter",t)},e.prototype.update=function(e,t){if(n(this))throw new ErrorInfo("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,e,"update",t)},e.prototype.enterClient=function(e,t,n){return this._enterOrUpdateClient(e,t,"enter",n)},e.prototype.updateClient=function(e,t,n){return this._enterOrUpdateClient(e,t,"update",n)},e.prototype._enterOrUpdateClient=function(e,t,n,o){if(!o)if("function"==typeof t)o=t,t=null;else{if(this.channel.realtime.options.promises)return Utils.promisify(this,"_enterOrUpdateClient",[e,t,n]);o=a}var r,i,s=this.channel;s.connectionManager.activeState()?(Logger.logAction(Logger.LOG_MICRO,"RealtimePresence."+n+"Client()","channel = "+s.name+", client = "+(e||"(implicit) "+this.channel.realtime.auth.clientId)),r=PresenceMessage.fromValues({action:n,data:t}),e&&(r.clientId=e),i=this,PresenceMessage.encode(r,s.channelOptions,function(e){if(e)o(e);else switch(s.state){case"attached":s.sendPresence(r,o);break;case"initialized":case"detached":s.attach();case"attaching":i.pendingPresence.push({presence:r,callback:o});break;default:(e=new ErrorInfo("Unable to "+n+" presence channel while in "+s.state+" state",90001)).code=90001,o(e)}})):o(s.connectionManager.getError())},e.prototype.leave=function(e,t){if(n(this))throw new ErrorInfo("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,e,t)},e.prototype.leaveClient=function(e,t,n){if(!n)if("function"==typeof t)n=t,t=null;else{if(this.channel.realtime.options.promises)return Utils.promisify(this,"leaveClient",[e,t]);n=a}var o=this.channel;if(o.connectionManager.activeState()){Logger.logAction(Logger.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+e);t=PresenceMessage.fromValues({action:"leave",data:t});switch(e&&(t.clientId=e),o.state){case"attached":o.sendPresence(t,n);break;case"attaching":this.pendingPresence.push({presence:t,callback:n});break;case"initialized":case"failed":n(new ErrorInfo("Unable to leave presence channel (incompatible state)",90001));break;default:n(ConnectionError.failed)}}else n(o.connectionManager.getError())},e.prototype.get=function(){var e=Array.prototype.slice.call(arguments);1==e.length&&"function"==typeof e[0]&&e.unshift(null);var t,n=e[0],o=e[1],r=!n||!("waitForSync"in n)||n.waitForSync;if(!o){if(this.channel.realtime.options.promises)return Utils.promisify(this,"get",e);o=a}function i(e){o(null,n?e.list(n):e.values())}"suspended"!==this.channel.state?function(e,t,n){switch(e.state){case"attached":case"suspended":n();break;case"initialized":case"detached":case"detaching":case"attaching":e.attach(function(e){e?t(e):n()});break;default:t(ErrorInfo.fromValues(RealtimeChannel.invalidStateError(e.state)))}}((t=this).channel,o,function(){var e=t.members;r?e.waitSync(function(){i(e)}):i(e)}):r?o(ErrorInfo.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):i(this.members)},e.prototype.history=function(e,t){if(Logger.logAction(Logger.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name),void 0===t)if("function"==typeof e)t=e,e=null;else{if(this.channel.realtime.options.promises)return Utils.promisify(this,"history",arguments);t=a}e&&e.untilAttach&&("attached"===this.channel.state?(delete e.untilAttach,e.from_serial=this.channel.properties.attachSerial):t(new ErrorInfo("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400))),Presence.prototype._history.call(this,e,t)},e.prototype.setPresence=function(e,t,n){Logger.logAction(Logger.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+e.length+" participants; syncChannelSerial = "+n);var o,r,i=this.members,s=this._myMembers,a=[],c=this.channel.connectionManager.connectionId;t&&(this.members.startSync(),n&&(r=n.match(/^[\w\-]+:(.*)$/))&&(o=r[1]));for(var l=0;l<e.length;l++)switch((u=PresenceMessage.fromValues(e[l])).action){case"leave":i.remove(u)&&a.push(u),u.connectionId!==c||u.isSynthesized()||s.remove(u);break;case"enter":case"present":case"update":i.put(u)&&a.push(u),u.connectionId===c&&s.put(u)}t&&!o&&(i.endSync(),this._ensureMyMembersPresent(),this.channel.setInProgress(RealtimeChannel.progressOps.sync,!1),this.channel.syncChannelSerial=null);for(l=0;l<a.length;l++){var u=a[l];this.subscriptions.emit(u.action,u)}},e.prototype.onAttached=function(e){Logger.logAction(Logger.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+e),e?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear(),this._ensureMyMembersPresent());var t=this.pendingPresence,n=t.length;if(n){this.pendingPresence=[];var o=[],r=Multicaster();Logger.logAction(Logger.LOG_MICRO,"RealtimePresence.onAttached","sending "+n+" queued presence messages");for(var i=0;i<n;i++){var s=t[i];o.push(s.presence),r.push(s.callback)}this.channel.sendPresence(o,r)}},e.prototype.actOnChannelState=function(e,t,n){switch(e){case"attached":this.onAttached(t);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(n)}},e.prototype.failPendingPresence=function(e){if(this.pendingPresence.length){Logger.logAction(Logger.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+Utils.inspectError(e));for(var t=0;t<this.pendingPresence.length;t++)try{this.pendingPresence[t].callback(e)}catch(e){}this.pendingPresence=[]}},e.prototype._clearMyMembers=function(){this._myMembers.clear()},e.prototype._ensureMyMembersPresent=function(){function e(e){var t;e&&(t="Presence auto-re-enter failed: "+e.toString(),e=new ErrorInfo(t,91004,400),Logger.logAction(Logger.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()",t),e=new ChannelStateChange(o.channel.state,o.channel.state,!0,e),o.channel.emit("update",e))}var t,n,o=this,r=this.members,i=this._myMembers;for(t in i.map)t in r.map||(n=i.map[t],Logger.logAction(Logger.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+n.clientId+'" into the presence set'),this._enterOrUpdateClient(n.clientId,n.data,"enter",e),delete i.map[t])},e.prototype._synthesizeLeaves=function(e){var t=this.subscriptions;Utils.arrForEach(e,function(e){e=PresenceMessage.fromValues({action:"leave",connectionId:e.connectionId,clientId:e.clientId,data:e.data,encoding:e.encoding,timestamp:Utils.now()});t.emit("leave",e)})},e.prototype.on=function(){Logger.deprecated("presence.on","presence.subscribe"),this.subscribe.apply(this,arguments)},e.prototype.off=function(){Logger.deprecated("presence.off","presence.unsubscribe"),this.unsubscribe.apply(this,arguments)},e.prototype.subscribe=function(){var e=RealtimeChannel.processListenerArgs(arguments),t=e[0],n=e[1],o=e[2],e=this.channel;if(!o){if(this.channel.realtime.options.promises)return Utils.promisify(this,"subscribe",[t,n]);o=a}"failed"!==e.state?(this.subscriptions.on(t,n),e.attach(o)):o(ErrorInfo.fromValues(RealtimeChannel.invalidStateError("failed")))},e.prototype.unsubscribe=function(){var e=RealtimeChannel.processListenerArgs(arguments),t=e[0],e=e[1];this.subscriptions.off(t,e)},Utils.inherits(o,EventEmitter),o.prototype.get=function(e){return this.map[e]},o.prototype.getClient=function(e){var t,n=this.map,o=[];for(t in n){var r=n[t];r.clientId==e&&"absent"!=r.action&&o.push(r)}return o},o.prototype.list=function(e){var t,n=this.map,o=e&&e.clientId,r=e&&e.connectionId,i=[];for(t in n){var s=n[t];"absent"!==s.action&&(o&&o!=s.clientId||r&&r!=s.connectionId||i.push(s))}return i},o.prototype.put=function(e){"enter"!==e.action&&"update"!==e.action||((e=PresenceMessage.fromValues(e)).action="present");var t=this.map,n=r(e);this.residualMembers&&delete this.residualMembers[n];var o=t[n];return!(o&&!i(e,o))&&(t[n]=e,!0)},o.prototype.values=function(){var e,t=this.map,n=[];for(e in t){var o=t[e];"absent"!=o.action&&n.push(o)}return n},o.prototype.remove=function(e){var t=this.map,n=r(e),o=t[n];return!(o&&!i(e,o))&&(this.syncInProgress?((e=PresenceMessage.fromValues(e)).action="absent",t[n]=e):delete t[n],!0)},o.prototype.startSync=function(){var e=this.map,t=this.syncInProgress;Logger.logAction(Logger.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),this.syncInProgress||(this.residualMembers=Utils.copy(e),this.setInProgress(!0))},o.prototype.endSync=function(){var e=this.map,t=this.syncInProgress;if(Logger.logAction(Logger.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),t){for(var n in e)"absent"===e[n].action&&delete e[n];for(var n in this.presence._synthesizeLeaves(Utils.valuesArray(this.residualMembers)),this.residualMembers)delete e[n];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")},o.prototype.waitSync=function(e){var t=this.syncInProgress;Logger.logAction(Logger.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),t?this.once("sync",e):e()},o.prototype.clear=function(e){this.map={},this.setInProgress(!1),this.residualMembers=null},o.prototype.setInProgress=function(e){Logger.logAction(Logger.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+e),this.syncInProgress=e,this.presence.syncComplete=!e},e}(),XHRRequest=function(){function n(){}var a=0,c={};var t=void 0!==global&&global.XDomainRequest;function l(){var e;return t&&(e=(e=navigator.userAgent.toString().match(/MSIE\s([\d.]+)/))&&Number(e[1]))&&10===e}function u(e,t,n,o,r,i,s){EventEmitter.call(this),(n=n||{}).rnd=Utils.cheapRandStr(),l()&&!n.envelope&&(n.envelope="json"),this.uri=e+Utils.toQueryString(n),this.headers=t||{},this.body=o,this.method=s?s.toUpperCase():Utils.isEmptyArg(o)?"GET":"POST",this.requestMode=r,this.timeouts=i,this.timedOut=!1,this.requestComplete=!1,c[this.id=String(++a)]=this}Utils.inherits(u,EventEmitter);var h=u.createRequest=function(e,t,n,o,r,i,s){return i=i||Defaults.TIMEOUTS,new u(e,t,Utils.copy(n),o,r,i,s)};return u.prototype.complete=function(e,t,n,o,r){this.requestComplete||(this.requestComplete=!0,!e&&t&&this.emit("data",t),this.emit("complete",e,t,n,o,r),this.dispose())},u.prototype.abort=function(){this.dispose()},u.prototype.exec=function(){var e,t=0==this.requestMode?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,i=this,n=this.timer=setTimeout(function(){i.timedOut=!0,a.abort()},t),o=this.body,r=this.method,s=this.headers,a=this.xhr=new XMLHttpRequest,c=s.accept,t="text";for(e in c?0===c.indexOf("application/x-msgpack")&&(t="arraybuffer"):s.accept="application/json",o&&-1<(s["content-type"]||(s["content-type"]="application/json")).indexOf("application/json")&&"string"!=typeof o&&(o=JSON.stringify(o)),a.open(r,this.uri,!0),a.responseType=t,"authorization"in s&&(a.withCredentials=!0),s)a.setRequestHeader(e,s[e]);function l(e,t,n,o){t=t+" (event type: "+e.type+")"+(i.xhr.statusText?", current statusText is "+i.xhr.statusText:""),Logger.logAction(Logger.LOG_ERROR,"Request.on"+e.type+"()",t),i.complete(new ErrorInfo(t,n,o))}a.onerror=function(e){l(e,"XHR error occurred",null,400)},a.onabort=function(e){i.timedOut?l(e,"Request aborted due to request timeout expiring",null,408):l(e,"Request cancelled",null,400)},a.ontimeout=function(e){l(e,"Request timed out",null,408)};var u,h,g,p,f=0,d=!1;function m(){try{var e,t,n=(n="content-type",(o=a).getResponseHeader&&o.getResponseHeader(n));(n?0<=n.indexOf("application/json"):"text"==a.responseType)?((t="arraybuffer"===a.responseType?BufferUtils.utf8Decode(a.response):String(a.responseText)).length&&(t=JSON.parse(t)),d=!0):t=a.response,void 0!==t.response?(h=t.statusCode,p=h<400,e=t.headers,t=t.response):e=function(e){for(var t=Utils.trim(e.getAllResponseHeaders()).split("\r\n"),n={},o=0;o<t.length;o++){var r=Utils.arrMap(t[o].split(":"),Utils.trim);n[r[0].toLowerCase()]=r[1]}return n}(a)}catch(e){return void i.complete(new ErrorInfo("Malformed response body from server: "+e.message,null,400))}var o,n,r;p||Utils.isArray(t)?i.complete(null,t,e,d,h):(r=(r=t.error&&ErrorInfo.fromValues(t.error))||new ErrorInfo("Error response received from server: "+h+" body was: "+Utils.inspect(t),null,h),i.complete(r,t,e,d,h))}function y(){for(var e,t,n=(g=a.responseText).length-1;f<n&&-1<(e=g.indexOf("\n",f));)t=g.slice(f,e),f=e+1,function(e){try{e=JSON.parse(e)}catch(e){return i.complete(new ErrorInfo("Malformed response body from server: "+e.message,null,400))}i.emit("data",e)}(t)}a.onreadystatechange=function(){var e,t=a.readyState;t<3||0!==a.status&&(void 0===h&&(1223===(h=a.status)&&(h=204),clearTimeout(n),p=h<400,204!=h?u=3==i.requestMode&&p&&((e=a).getResponseHeader&&(e.getResponseHeader("transfer-encoding")||!e.getResponseHeader("content-length"))):i.complete(null,null,null,null,h)),3==t&&u?y():4==t&&(u?(y(),i.streamComplete=!0,Utils.nextTick(function(){i.complete()})):m()))},a.send(o)},u.prototype.dispose=function(){var e,t=this.xhr;t&&(t.onreadystatechange=t.onerror=t.onabort=t.ontimeout=n,this.xhr=null,(e=this.timer)&&(clearTimeout(e),this.timer=null),this.requestComplete||t.abort()),delete c[this.id]},Platform.xhrSupported&&("object"==typeof DomEvent&&DomEvent.addUnloadListener(function(){for(var e in c)c[e].dispose()}),void 0!==Http&&(Http.supportsAuthHeaders=!0,Http.Request=function(e,t,n,o,r,i,s){e=h(n,o,r,i,0,t&&t.options.timeouts,e);return e.once("complete",s),e.exec(),e},Http.checkConnectivity=function(n){var e=Defaults.internetUpUrl;Logger.logAction(Logger.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+e),Http.getUri(null,e,null,null,function(e,t){t=!e&&"yes"==t.replace(/\n/,"");Logger.logAction(Logger.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+t),n(null,t)})})),u}(),XHRStreamingTransport=function(){var o="xhr_streaming";function s(e,t,n){CometTransport.call(this,e,t,n),this.shortName=o}return Utils.inherits(s,CometTransport),s.isAvailable=function(){return Platform.xhrSupported&&Platform.streamingSupported&&Platform.allowComet},s.tryConnect=function(e,t,n,o){function r(e){o({event:this.event,error:e})}var i=new s(e,t,n);i.on(["failed","disconnected"],r),i.on("preconnect",function(){Logger.logAction(Logger.LOG_MINOR,"XHRStreamingTransport.tryConnect()","viable transport "+i),i.off(["failed","disconnected"],r),o(null,i)}),i.connect()},s.prototype.toString=function(){return"XHRStreamingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},s.prototype.createRequest=function(e,t,n,o,r){return XHRRequest.createRequest(e,t,n,o,r,this.timeouts)},void 0!==ConnectionManager&&s.isAvailable()&&(ConnectionManager.supportedTransports[o]=s),s}(),XHRPollingTransport=function(){var o="xhr_polling";function s(e,t,n){n.stream=!1,CometTransport.call(this,e,t,n),this.shortName=o}return Utils.inherits(s,CometTransport),s.isAvailable=function(){return Platform.xhrSupported&&Platform.allowComet},s.tryConnect=function(e,t,n,o){function r(e){o({event:this.event,error:e})}var i=new s(e,t,n);i.on(["failed","disconnected"],r),i.on("preconnect",function(){Logger.logAction(Logger.LOG_MINOR,"XHRPollingTransport.tryConnect()","viable transport "+i),i.off(["failed","disconnected"],r),o(null,i)}),i.connect()},s.prototype.toString=function(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},s.prototype.createRequest=function(e,t,n,o,r){return XHRRequest.createRequest(e,t,n,o,r,this.timeouts)},void 0!==ConnectionManager&&s.isAvailable()&&(ConnectionManager.supportedTransports[o]=s),s}();Ably.msgpack=msgpack,Ably.Rest=Rest,(Ably.Realtime=Realtime).ConnectionManager=ConnectionManager,Realtime.BufferUtils=Rest.BufferUtils=BufferUtils,void 0!==Crypto&&(Realtime.Crypto=Rest.Crypto=Crypto),Realtime.Defaults=Rest.Defaults=Defaults,Realtime.Http=Rest.Http=Http,Realtime.Utils=Rest.Utils=Utils,Realtime.Http=Rest.Http=Http,Realtime.Message=Rest.Message=Message,Realtime.PresenceMessage=Rest.PresenceMessage=PresenceMessage,Realtime.ProtocolMessage=Rest.ProtocolMessage=ProtocolMessage,module.exports=Ably,module.exports.__esModule=!0;