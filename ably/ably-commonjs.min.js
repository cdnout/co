!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Ably=e():t.Ably=e()}(window,function(){return i={},o.m=n=[function(t,e,n){"use strict";(function(c){var u=n(3),t=function(){var t,e;function i(t,e){return("000"+t).slice(-2-(e||0))}"undefined"==typeof Window&&"undefined"==typeof WorkerGlobalScope||c.console&&c.console.log&&"function"==typeof c.console.log.apply?(t=function(){console.log.apply(console,arguments)},e=console.warn?function(){console.warn.apply(console,arguments)}:t):t=e=c.console&&c.console.log?function(){Function.prototype.apply.call(console.log,console,arguments)}:function(){};var n=1;function o(n){return u.a.logTimestamps?function(t){var e=new Date;n(i(e.getHours())+":"+i(e.getMinutes())+":"+i(e.getSeconds())+"."+i(e.getMilliseconds(),!0)+" "+t)}:n}var r=o(t),s=o(e);function a(t){}return a.LOG_NONE=0,a.LOG_ERROR=1,a.LOG_MAJOR=2,a.LOG_MINOR=3,a.LOG_MICRO=4,a.LOG_DEFAULT=1,a.LOG_DEBUG=4,a.logAction=function(t,e,n){a.shouldLog(t)&&(1===t?s:r)("Ably: "+e+": "+n)},a.deprecated=function(t,e){a.deprecatedWithMsg(t,"Please use '"+e+"' instead.")},a.deprecatedWithMsg=function(t,e){a.shouldLog(1)&&s("Ably: Deprecation warning - '"+t+"' is deprecated and will be removed from a future version. "+e)},a.shouldLog=function(t){return t<=n},a.setLog=function(t,e){void 0!==t&&(n=t),void 0!==e&&(r=s=e)},a}();e.a=t}).call(this,n(20))},function(t,e,n){"use strict";var i=n(3),o=n(5),a=n(4),n=function(){var n=i.a.msgpack;function s(){}function r(t){return Math.floor(Math.random()*t.length)}s.mixin=function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];if(!n)break;var i,o=n.hasOwnProperty;for(i in n)o&&!o.call(n,i)||(t[i]=n[i])}return t},s.copy=function(t){return s.mixin({},t)},s.isArray=Array.isArray||function(t){return"[object Array]"==Object.prototype.toString.call(t)},s.ensureArray=function(t){return s.isEmptyArg(t)?[]:s.isArray(t)?t:[t]},s.isObject=function(t){return"[object Object]"==Object.prototype.toString.call(t)},s.isEmpty=function(t){for(var e in t)return!1;return!0},s.isOnlyPropIn=function(t,e){for(var n in t)if(n!==e)return!1;return!0},s.isEmptyArg=function(t){return null==t},s.shallowClone=function(t){var e,n=new Object;for(e in t)n[e]=t[e];return n},s.prototypicalClone=function(t,e){function n(){}n.prototype=t;t=new n;return e&&s.mixin(t,e),t},s.inherits=i.a.inherits||function(t,e){t.super_=e,t.prototype=s.prototypicalClone(e.prototype,{constructor:t})},s.containsValue=function(t,e){for(var n in t)if(t[n]==e)return!0;return!1},s.intersect=function(t,e){return s.isArray(e)?s.arrIntersect(t,e):s.arrIntersectOb(t,e)},s.arrIntersect=function(t,e){for(var n=[],i=0;i<t.length;i++){var o=t[i];-1!=s.arrIndexOf(e,o)&&n.push(o)}return n},s.arrIntersectOb=function(t,e){for(var n=[],i=0;i<t.length;i++){var o=t[i];o in e&&n.push(o)}return n},s.arrSubtract=function(t,e){for(var n=[],i=0;i<t.length;i++){var o=t[i];-1==s.arrIndexOf(e,o)&&n.push(o)}return n},s.arrIndexOf=Array.prototype.indexOf?function(t,e,n){return t.indexOf(e,n)}:function(t,e,n){n=n||0;for(var i=t.length;n<i;n++)if(t[n]===e)return n;return-1},s.arrIn=function(t,e){return-1!==s.arrIndexOf(t,e)},s.arrDeleteValue=function(t,e){var n=s.arrIndexOf(t,e),e=-1!=n;return e&&t.splice(n,1),e},s.arrWithoutValue=function(t,e){t=t.slice();return s.arrDeleteValue(t,e),t},s.keysArray=function(t,e){var n,i=[];for(n in t)e&&!t.hasOwnProperty(n)||i.push(n);return i},s.valuesArray=function(t,e){var n,i=[];for(n in t)e&&!t.hasOwnProperty(n)||i.push(t[n]);return i},s.forInOwnNonNullProps=function(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&t[n]&&e(n)},s.arrForEach=Array.prototype.forEach?function(t,e){t.forEach(e)}:function(t,e){for(var n=t.length,i=0;i<n;i++)e(t[i],i,t)},s.safeArrForEach=function(t,e){return s.arrForEach(t.slice(),e)},s.arrMap=Array.prototype.map?function(t,e){return t.map(e)}:function(t,e){for(var n=[],i=t.length,o=0;o<i;o++)n.push(e(t[o],o,t));return n},s.arrFilter=Array.prototype.filter?function(t,e){return t.filter(e)}:function(t,e){for(var n=[],i=t.length,o=0;o<i;o++)e(t[o])&&n.push(t[o]);return n},s.arrEvery=Array.prototype.every?function(t,e){return t.every(e)}:function(t,e){for(var n=t.length,i=0;i<n;i++)if(!e(t[i],i,t))return!1;return!0},s.allSame=function(t,e){if(0===t.length)return!0;var n=t[0][e];return s.arrEvery(t,function(t){return t[e]===n})},s.nextTick=i.a.nextTick;var e={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};return s.defaultGetHeaders=function(t){return{accept:e[t||"json"],"X-Ably-Version":o.a.apiVersion,"X-Ably-Lib":o.a.libstring}},s.defaultPostHeaders=function(t){return{accept:t=e[t||"json"],"content-type":t,"X-Ably-Version":o.a.apiVersion,"X-Ably-Lib":o.a.libstring}},s.arrPopRandomElement=function(t){return t.splice(r(t),1)[0]},s.toQueryString=function(t){var e=[];if(t)for(var n in t)e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.length?"?"+e.join("&"):""},s.parseQueryString=function(t){for(var e,n=/([^?&=]+)=?([^&]*)/g,i={};e=n.exec(t);)i[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return i},s.now=Date.now||function(){return(new Date).getTime()},s.inspect=i.a.inspect,s.isErrorInfo=function(t){return"ErrorInfo"==t.constructor.name},s.inspectError=function(t){return t&&(s.isErrorInfo(t)||"Error"==t.constructor.name||t instanceof Error)?t.toString():s.inspect(t)},s.inspectBody=function(t){return a.a.isBuffer(t)?t.toString():"string"==typeof t?t:i.a.inspect(t)},s.dataSizeBytes=function(t){if(a.a.isBuffer(t))return a.a.byteLength(t);if("string"==typeof t)return i.a.stringByteSize(t);throw new Error("Expected input of Utils.dataSizeBytes to be a buffer or string, but was: "+typeof t)},s.cheapRandStr=function(){return String(Math.random()).substr(2)},s.randomString=i.a.getRandomValues&&"undefined"!=typeof Uint8Array?function(t){t=new Uint8Array(t);return i.a.getRandomValues(t),a.a.base64Encode(t)}:function(t){for(var e=a.a.base64CharSet,n=Math.round(4*t/3),i="",o=0;o<n;o++)i+=e[r(e)];return i},s.randomHexString=i.a.getRandomValues&&"undefined"!=typeof Uint8Array?function(t){t=new Uint8Array(t);return i.a.getRandomValues(t),a.a.hexEncode(t)}:function(t){for(var e=a.a.hexCharSet,n=2*t,i="",o=0;o<n;o++)i+=e[r(e)];return i},s.arrChooseN=function(t,e){for(var n=Math.min(e,t.length),i=t.slice(),o=[],r=0;r<n;r++)o.push(s.arrPopRandomElement(i));return o},s.trim=String.prototype.trim?function(t){return t.trim()}:function(t){return t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},s.promisify=function(t,e,o){return new Promise(function(n,i){t[e].apply(t,Array.prototype.slice.call(o).concat(function(t,e){t?i(t):n(e)}))})},s.decodeBody=function(t,e){return"msgpack"==e?n.decode(t):JSON.parse(String(t))},s.encodeBody=function(t,e){return"msgpack"==e?n.encode(t,!0):JSON.stringify(t)},s.allToLowerCase=function(t){return s.arrMap(t,function(t){return t&&t.toLowerCase()})},s.allToUpperCase=function(t){return s.arrMap(t,function(t){return t&&t.toUpperCase()})},s}();e.a=n},function(t,e,n){"use strict";var i=n(1),n=(o.prototype.toString=function(){var t="["+this.constructor.name;return this.message&&(t+=": "+this.message),this.statusCode&&(t+="; statusCode="+this.statusCode),this.code&&(t+="; code="+this.code),this.cause&&(t+="; cause="+i.a.inspectError(this.cause)),!this.href||this.message&&-1<this.message.indexOf("help.ably.io")||(t+="; see "+this.href+" "),t+="]"},o.fromValues=function(t){var e=i.a.mixin(new o,t);return t instanceof Error&&(e.message=t.message),e.code&&!e.href&&(e.href="https://help.ably.io/error/"+e.code),e},o);function o(t,e,n,i){this.message=t,this.code=e,this.statusCode=n,this.cause=i,this.href=void 0}e.a=n},function(t,o,r){"use strict";(function(e){var t=r(24);"undefined"==typeof Window&&"undefined"==typeof WorkerGlobalScope&&console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");var n,i=e.navigator&&e.navigator.userAgent.toString(),t={libver:"js-web",logTimestamps:!0,userAgent:i,currentUrl:e.location&&e.location.href,noUpgrade:i&&i.match(/MSIE\s8\.0/),binaryType:"arraybuffer",WebSocket:e.WebSocket||e.MozWebSocket,xhrSupported:e.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,jsonpSupported:"undefined"!=typeof document,allowComet:(n=e.location,!e.WebSocket||!n||!n.origin||-1<n.origin.indexOf("http")),streamingSupported:!0,useProtocolHeartbeats:!0,createHmac:null,msgpack:t.a,supportsBinary:!!e.TextDecoder,preferBinary:!1,ArrayBuffer:e.ArrayBuffer,atob:e.atob,nextTick:function(t){setTimeout(t,0)},addEventListener:e.addEventListener,inspect:JSON.stringify,stringByteSize:function(t){return e.TextDecoder&&(new e.TextEncoder).encode(t).length||t.length},TextEncoder:e.TextEncoder,TextDecoder:e.TextDecoder,Promise:e.Promise,getRandomValues:function(n){if(void 0!==n)return function(t,e){n.getRandomValues(t),e&&e(null)}}(e.crypto||e.msCrypto)};o.a=t}).call(this,r(20))},function(t,e,n){"use strict";var p=n(32),f=n(33),d=n(17),i=n(10),g=n.n(i),m=n(3),n=function(){var o=m.a.ArrayBuffer,s=m.a.atob,e=m.a.TextEncoder,n=m.a.TextDecoder,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function r(t){return null!=t&&void 0!==t.sigBytes}function a(t){return null!=t&&t.constructor===o}function u(t){return o&&o.isView&&o.isView(t)}function h(){}h.base64CharSet=c,h.hexCharSet="0123456789abcdef";var i=h.isBuffer=function(t){return a(t)||r(t)||u(t)},l=h.toBuffer=function(t){if(!o)throw new Error("Can't convert to Buffer: browser does not support the necessary types");if(a(t))return new Uint8Array(t);if(u(t))return new Uint8Array(t.buffer);if(r(t)){for(var e=new o(t.sigBytes),n=new Uint8Array(e),i=0;i<t.sigBytes;i++)n[i]=t.words[i>>>2]>>>24-i%4*8&255;return n}throw new Error("BufferUtils.toBuffer expected an arraybuffer, typed array, or CryptoJS wordarray")};return h.toArrayBuffer=function(t){return a(t)?t:l(t).buffer},h.toWordArray=function(t){return u(t)&&(t=t.buffer),r(t)?t:g.a.create(t)},h.base64Encode=function(t){return r(t)?Object(d.stringify)(t):function(t){for(var e,n="",i=c,o=t.byteLength,r=o%3,s=o-r,a=0;a<s;a+=3)n+=i[(16515072&(e=t[a]<<16|t[a+1]<<8|t[a+2]))>>18]+i[(258048&e)>>12]+i[(4032&e)>>6]+i[63&e];return 1==r?n+=i[(252&(e=t[s]))>>2]+i[(3&e)<<4]+"==":2==r&&(n+=i[(64512&(e=t[s]<<8|t[1+s]))>>10]+i[(1008&e)>>4]+i[(15&e)<<2]+"="),n}(l(t))},h.base64Decode=function(t){return(o&&s?function(t){for(var e=s(t),n=e.length,i=new Uint8Array(n),o=0;o<n;o++){var r=e.charCodeAt(o);i[o]=r}return i.buffer}:Object(d.parse))(t)},h.hexEncode=function(t){return t=h.toWordArray(t),Object(p.stringify)(t)},h.hexDecode=function(t){t=Object(p.parse)(t);return o?h.toArrayBuffer(t):t},h.utf8Encode=function(t){return e?(new e).encode(t).buffer:Object(f.parse)(t)},h.utf8Decode=function(t){if(!i(t))throw new Error("Expected input of utf8decode to be an arraybuffer, typed array, or CryptoJS wordarray");return n&&!r(t)?(new n).decode(t):(t=h.toWordArray(t),Object(f.stringify)(t))},h.bufferCompare=function(t,e){if(!t)return-1;if(!e)return 1;t=h.toWordArray(t),e=h.toWordArray(e),t.clamp(),e.clamp();var n=t.sigBytes-e.sigBytes;if(0!=n)return n;t=t.words,e=e.words;for(var i=0;i<t.length;i++)if(0!=(n=t[i]-e[i]))return n;return 0},h.byteLength=function(t){return a(t)||u(t)?t.byteLength:r(t)?t.sigBytes:void 0},h.typedArrayToBuffer=function(t){return t.buffer},h}();e.a=n},function(t,e,n){"use strict";var o=n(3),i={internetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",jsonpInternetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up-0-9.js",defaultTransports:["xhr_polling","xhr_streaming","jsonp","web_socket"],baseTransportOrder:["xhr_polling","xhr_streaming","jsonp","web_socket"],transportPreferenceOrder:["jsonp","xhr_polling","xhr_streaming","web_socket"],upgradeTransports:["xhr_streaming","web_socket"]};o.a.noUpgrade&&(i.upgradeTransports=[]);var r=i,s=n(1),a=n(4),c=n(0),u=n(2);function h(t){if("string"!=typeof t)throw new u.a("host must be a string; was a "+typeof t,4e4,400);if(!t.length)throw new u.a("host must not be zero-length",4e4,400)}r.ENVIRONMENT="",r.REST_HOST="rest.ably.io",r.REALTIME_HOST="realtime.ably.io",r.FALLBACK_HOSTS=["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],r.PORT=80,r.TLS_PORT=443,r.TIMEOUTS={disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,preferenceConnectTimeout:6e3,parallelUpgradeDelay:6e3},r.httpMaxRetryCount=3,r.maxMessageSize=65536,r.errorReportingUrl="https://errors.ably.io/api/15/store/",r.errorReportingHeaders={"X-Sentry-Auth":"Sentry sentry_version=7, sentry_key=a04e33c8674c451f8a310fbec029acf5, sentry_client=ably-js/0.1","Content-Type":"application/json"},r.version="1.2.5",r.libstring=o.a.libver+"-"+r.version,r.apiVersion="1.2",r.getHost=function(t,e,n){return e=n?e==t.restHost&&t.realtimeHost||e||t.realtimeHost:e||t.restHost},r.getPort=function(t,e){return e||t.tls?t.tlsPort:t.port},r.getHttpScheme=function(t){return t.tls?"https://":"http://"},r.environmentFallbackHosts=function(t){return[t+"-a-fallback.ably-realtime.com",t+"-b-fallback.ably-realtime.com",t+"-c-fallback.ably-realtime.com",t+"-d-fallback.ably-realtime.com",t+"-e-fallback.ably-realtime.com"]},r.getFallbackHosts=function(t){var e=t.fallbackHosts,t=(void 0!==t.httpMaxRetryCount?t:r).httpMaxRetryCount;return e?s.a.arrChooseN(e,t):[]},r.getHosts=function(t){return[t.restHost].concat(r.getFallbackHosts(t))},r.objectifyOptions=function(t){return"string"==typeof t?-1==t.indexOf(":")?{token:t}:{key:t}:t},r.normaliseOptions=function(t){if(t.host&&(c.a.deprecated("host","restHost"),t.restHost=t.host),t.wsHost&&(c.a.deprecated("wsHost","realtimeHost"),t.realtimeHost=t.wsHost),t.queueEvents&&(c.a.deprecated("queueEvents","queueMessages"),t.queueMessages=t.queueEvents),t.fallbackHostsUseDefault){if(t.fallbackHosts){var e="fallbackHosts and fallbackHostsUseDefault cannot both be set";throw c.a.logAction(c.a.LOG_ERROR,"Defaults.normaliseOptions",e),new u.a(e,4e4,400)}if(t.port||t.tlsPort){e="fallbackHostsUseDefault cannot be set when port or tlsPort are set";throw c.a.logAction(c.a.LOG_ERROR,"Defaults.normaliseOptions",e),new u.a(e,4e4,400)}t.environment?c.a.deprecatedWithMsg("fallbackHostsUseDefault","There is no longer a need to set this when the environment option is also set since the library will now generate the correct fallback hosts using the environment option."):c.a.deprecated("fallbackHostsUseDefault","fallbackHosts: Ably.Defaults.FALLBACK_HOSTS"),t.fallbackHosts=r.FALLBACK_HOSTS}!0===t.recover&&(c.a.deprecated("{recover: true}","{recover: function(lastConnectionDetails, cb) { cb(true); }}"),t.recover=function(t,e){e(!0)}),"function"==typeof t.recover&&!0===t.closeOnUnload&&(c.a.logAction(c.a.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),t.recover=null),"closeOnUnload"in t||(t.closeOnUnload=!t.recover),t.transports&&s.a.arrIn(t.transports,"xhr")&&(c.a.deprecated('transports: ["xhr"]','transports: ["xhr_streaming"]'),s.a.arrDeleteValue(t.transports,"xhr"),t.transports.push("xhr_streaming")),"queueMessages"in t||(t.queueMessages=!0);var n,i=t.environment&&String(t.environment).toLowerCase()||r.ENVIRONMENT,e=!i||"production"===i;for(n in t.fallbackHosts||t.restHost||t.realtimeHost||t.port||t.tlsPort||(t.fallbackHosts=e?r.FALLBACK_HOSTS:r.environmentFallbackHosts(i)),t.realtimeHost||(t.restHost?(c.a.logAction(c.a.LOG_WARN,"Defaults.normaliseOptions",'restHost is set to "'+t.restHost+'" but realtimeHost is not set, so setting realtimeHost to "'+t.restHost+'" too. If this is not what you want, please set realtimeHost explicitly.'),t.realtimeHost=t.restHost):t.realtimeHost=e?r.REALTIME_HOST:i+"-"+r.REALTIME_HOST),t.restHost||(t.restHost=e?r.REST_HOST:i+"-"+r.REST_HOST),s.a.arrForEach((t.fallbackHosts||[]).concat(t.restHost,t.realtimeHost),h),t.port=t.port||r.PORT,t.tlsPort=t.tlsPort||r.TLS_PORT,t.maxMessageSize=t.maxMessageSize||r.maxMessageSize,"tls"in t||(t.tls=!0),t.timeouts={},r.TIMEOUTS)t.timeouts[n]=t[n]||r.TIMEOUTS[n];return"useBinaryProtocol"in t?t.useBinaryProtocol=o.a.supportsBinary&&t.useBinaryProtocol:t.useBinaryProtocol=o.a.preferBinary,t.clientId&&((t.headers=t.headers||{})["X-Ably-ClientId"]=a.a.base64Encode(a.a.utf8Encode(t.clientId))),"idempotentRestPublishing"in t||(t.idempotentRestPublishing=!0),t.promises&&!o.a.Promise&&(c.a.logAction(c.a.LOG_ERROR,"Defaults.normaliseOptions","{promises: true} was specified, but no Promise constructor found; disabling promises"),t.promises=!1),t};e.a=r},function(t,e,n){"use strict";var l,i=n(1),o=n(5),i=(l=Date.now||function(){return(new Date).getTime()},f._getHosts=g,f.methods=["get","delete","post","put","patch"],f.methodsWithoutBody=["get","delete"],f.methodsWithBody=i.a.arrSubtract(f.methods,f.methodsWithoutBody),i.a.arrForEach(f.methodsWithoutBody,function(r){f[r]=function(t,e,n,i,o){f.do(r,t,e,n,null,i,o)},f[r+"Uri"]=function(t,e,n,i,o){f.doUri(r,t,e,n,null,i,o)}}),i.a.arrForEach(f.methodsWithBody,function(s){f[s]=function(t,e,n,i,o,r){f.do(s,t,e,n,i,o,r)},f[s+"Uri"]=function(t,e,n,i,o,r){f.doUri(s,t,e,n,i,o,r)}}),f.do=function(t,o,e,r,s,a,c){c=c||p;var u="function"==typeof e?e:function(t){return o.baseUri(t)+e},n=(r&&r.accept,arguments),i=o._currentFallback;if(i){if(i.validUntil>l())return void f.Request(t,o,u(i.host),r,a,s,function(t){return t&&d(t)?(o._currentFallback=null,void f.do.apply(f,n)):void c.apply(null,arguments)});o._currentFallback=null}var h,i=g(o);1!=i.length?(h=function(e,n){var i=e.shift();f.doUri(t,o,u(i),r,s,a,function(t){t&&d(t)&&e.length?h(e,!0):(n&&(o._currentFallback={host:i,validUntil:l()+o.options.timeouts.fallbackRetryTimeout}),c.apply(null,arguments))})})(i):f.doUri(t,o,u(i[0]),r,s,a,c)},f.doUri=function(t,e,n,i,o,r,s){f.Request(t,e,n,i,r,o,s)},f.supportsAuthHeaders=!1,f.supportsLinkHeaders=!1,f);function p(){}function f(){}function d(t){var e=t.statusCode;return 408===e&&!t.code||400===e&&!t.code||500<=e&&e<=504}function g(t){var e=t.connection,e=e&&e.connectionManager.host;return e?[e].concat(o.a.getFallbackHosts(t.options)):o.a.getHosts(t.options)}e.a=i},function(t,e,n){"use strict";var a=n(1),i=n(0),s=n(3),n=(c.prototype.on=function(t,e){var n;1==arguments.length&&"function"==typeof t?this.any.push(t):a.a.isEmptyArg(t)?this.any.push(e):a.a.isArray(t)?(n=this,a.a.arrForEach(t,function(t){n.on(t,e)})):(this.events[t]||(this.events[t]=[])).push(e)},c.prototype.off=function(t,e){if(0==arguments.length||a.a.isEmptyArg(t)&&a.a.isEmptyArg(e))return this.any=[],this.events={},this.anyOnce=[],void(this.eventsOnce={});var n;1==arguments.length&&"function"==typeof t&&(e=t,t=null),e&&a.a.isEmptyArg(t)?h([this.any,this.events,this.anyOnce,this.eventsOnce],e):(a.a.isArray(t)&&(n=this,a.a.arrForEach(t,function(t){n.off(t,e)})),e?h([this.events,this.eventsOnce],e,t):(delete this.events[t],delete this.eventsOnce[t]))},c.prototype.listeners=function(t){if(t){var e=this.events[t]||[];return this.eventsOnce[t]&&Array.prototype.push.apply(e,this.eventsOnce[t]),e.length?e:null}return this.any.length?this.any:null},c.prototype.emit=function(t){var e=Array.prototype.slice.call(arguments,1),n={event:t},i=[];this.anyOnce.length&&(Array.prototype.push.apply(i,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(i,this.any);var o=this.eventsOnce[t];o&&(Array.prototype.push.apply(i,o),delete this.eventsOnce[t]);t=this.events[t];t&&Array.prototype.push.apply(i,t),a.a.arrForEach(i,function(t){u(n,t,e)})},c.prototype.once=function(e,t){var n=arguments.length,i=this;if((0===n||1===n&&"function"!=typeof e)&&s.a.Promise)return new s.a.Promise(function(t){i.once(e,t)});if(1==arguments.length&&"function"==typeof e)this.anyOnce.push(e);else if(a.a.isEmptyArg(e))this.anyOnce.push(t);else{if(a.a.isArray(e))throw"Arrays of events can only be used with on(), not once()";(this.eventsOnce[e]||(this.eventsOnce[e]=[])).push(t)}},c.prototype.whenState=function(e,n,t){var i={event:e},o=this,r=Array.prototype.slice.call(arguments,3);if("string"!=typeof e||"string"!=typeof n)throw"whenState requires a valid event String argument";if("function"!=typeof t&&s.a.Promise)return new s.a.Promise(function(t){c.prototype.whenState.apply(o,[e,n,t].concat(r))});e===n?u(i,t,r):this.once(e,t)},c);function c(){this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={}}function u(t,e,n){try{e.apply(t,n)}catch(t){i.a.logAction(i.a.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+t+"; stack = "+(t&&t.stack))}}function h(t,e,n){for(var i,o,r,s=0;s<t.length;s++)if(i=t[s],n&&(i=i[n]),a.a.isArray(i)){for(;-1!==(o=a.a.arrIndexOf(i,e));)i.splice(o,1);n&&0===i.length&&delete t[s][n]}else if(a.a.isObject(i))for(r in i)i.hasOwnProperty(r)&&a.a.isArray(i[r])&&h([i],e,r)}e.a=n},function(t,e,n){"use strict";var h=n(1),l=n(2),p=n(9),f=n(11),n=function(){function r(){this.action=void 0,this.flags=void 0,this.id=void 0,this.timestamp=void 0,this.count=void 0,this.error=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionSerial=void 0,this.channel=void 0,this.channelSerial=void 0,this.msgSerial=void 0,this.messages=void 0,this.presence=void 0,this.auth=void 0,this.params=void 0}var s=r.Action={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17};r.channelModes=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE"],r.ActionName=[],h.a.arrForEach(h.a.keysArray(r.Action,!0),function(t){r.ActionName[s[t]]=t});var e={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,PRESENCE:65536,PUBLISH:1<<17,SUBSCRIBE:1<<18,PRESENCE_SUBSCRIBE:1<<19},a=h.a.keysArray(e);function c(t){var e=[];if(t)for(var n=0;n<t.length;n++)e.push(t[n].toString());return"[ "+e.join(", ")+" ]"}e.MODE_ALL=e.PRESENCE|e.PUBLISH|e.SUBSCRIBE|e.PRESENCE_SUBSCRIBE,r.prototype.hasFlag=function(t){return 0<(this.flags&e[t])},r.prototype.setFlag=function(t){return this.flags=this.flags|e[t]},r.prototype.getMode=function(){return this.flags&&this.flags&e.MODE_ALL},r.prototype.encodeModesToFlags=function(t){var e=this;h.a.arrForEach(t,function(t){e.setFlag(t)})},r.prototype.decodeModesFromFlags=function(){var e=[],n=this;return h.a.arrForEach(r.channelModes,function(t){n.hasFlag(t)&&e.push(t)}),0<e.length?e:void 0},r.serialize=h.a.encodeBody,r.deserialize=function(t,e){e=h.a.decodeBody(t,e);return r.fromDeserialized(e)},r.fromDeserialized=function(t){var e=t.error;e&&(t.error=l.a.fromValues(e));var n=t.messages;if(n)for(var i=0;i<n.length;i++)n[i]=p.a.fromValues(n[i]);var o=t.presence;if(o)for(i=0;i<o.length;i++)o[i]=f.a.fromValues(o[i],!0);return h.a.mixin(new r,t)},r.fromValues=function(t){return h.a.mixin(new r,t)};var u="id channel channelSerial connectionId connectionKey connectionSerial count msgSerial timestamp".split(" ");return r.stringify=function(e){var t,n="[ProtocolMessage";void 0!==e.action&&(n+="; action="+r.ActionName[e.action]||!1);for(var i,o=0;o<u.length;o++)t=u[o],void 0!==e[t]&&(n+="; "+t+"="+e[t]);return e.messages&&(n+="; messages="+c(p.a.fromValuesArray(e.messages))),e.presence&&(n+="; presence="+c(f.a.fromValuesArray(e.presence))),e.error&&(n+="; error="+l.a.fromValues(e.error).toString()),e.auth&&e.auth.accessToken&&(n+="; token="+e.auth.accessToken),e.flags&&(n+="; flags="+h.a.arrFilter(a,function(t){return e.hasFlag(t)}).join(",")),e.params&&(i="",h.a.forInOwnNonNullProps(e.params,function(t){0<i.length&&(i+="; "),i+=t+"="+e.params[t]}),0<i.length&&(n+="; params=["+i+"]")),n+="]"},r.isDuplicate=function(t,e){if(t&&e&&(t.action===s.MESSAGE||t.action===s.PRESENCE)&&t.action===e.action&&t.channel===e.channel&&t.id===e.id){if(t.action===s.PRESENCE)return!0;if(t.messages.length===e.messages.length){for(var n=0;n<t.messages.length;n++){var i=t.messages[n],o=e.messages[n];if((i.extras&&i.extras.delta&&i.extras.delta.format)!==(o.extras&&o.extras.delta&&o.extras.delta.format))return!1}return!0}}return!1},r}();e.a=n},function(t,e,n){"use strict";var p=n(4),r=n(1),s=n(0),i=n(18),f=n(2),n=(a.prototype.toJSON=function(){var t,e={name:this.name,id:this.id,clientId:this.clientId,connectionId:this.connectionId,connectionKey:this.connectionKey,encoding:this.encoding,extras:this.extras},n=this.data;return n&&p.a.isBuffer(n)&&(n=0<arguments.length?(t=this.encoding,e.encoding=t?t+"/base64":"base64",p.a.base64Encode(n)):p.a.toBuffer(n)),e.data=n,e},a.prototype.toString=function(){var t="[Message";return this.name&&(t+="; name="+this.name),this.id&&(t+="; id="+this.id),this.timestamp&&(t+="; timestamp="+this.timestamp),this.clientId&&(t+="; clientId="+this.clientId),this.connectionId&&(t+="; connectionId="+this.connectionId),this.encoding&&(t+="; encoding="+this.encoding),this.extras&&(t+="; extras ="+JSON.stringify(this.extras)),this.data&&("string"==typeof this.data?t+="; data="+this.data:p.a.isBuffer(this.data)?t+="; data (buffer)="+p.a.base64Encode(this.data):t+="; data (json)="+JSON.stringify(this.data)),this.extras&&(t+="; extras="+JSON.stringify(this.extras)),t+="]"},a.encrypt=function(n,t,i){var e=n.data,o=n.encoding,r=t.channelCipher,o=o?o+"/":"";p.a.isBuffer(e)||(e=p.a.utf8Encode(String(e)),o+="utf-8/"),r.encrypt(e,function(t,e){t?i(t):(n.data=e,n.encoding=o+"cipher+"+r.algorithm,i(null,n))})},a.encode=function(t,e,n){var i=t.data;if(!("string"==typeof i||p.a.isBuffer(i)||null==i)){if(!r.a.isObject(i)&&!r.a.isArray(i))throw new f.a("Data type is unsupported",40013,400);t.data=JSON.stringify(i),t.encoding=(i=t.encoding)?i+"/json":"json"}null!=e&&e.cipher?a.encrypt(t,e,n):n(null,t)},a.encodeArray=function(n,t,i){for(var o=0,e=0;e<n.length;e++)a.encode(n[e],t,function(t,e){t?i(t):++o==n.length&&i(null,n)})},a.serialize=r.a.encodeBody,a.decode=function(t,e){e&&e.channelOptions||(e={channelOptions:e,plugins:{},baseEncodedPreviousPayload:void 0});var n=t.data,i=t.encoding;if(i){var o,r=i.split("/"),s=r.length,a=t.data;try{for(;0<(o=s);){var c=r[--s].match(/([\-\w]+)(\+([\w\-]+))?/);if(!c)break;var u=c[1];switch(u){case"base64":a=p.a.base64Decode(String(a)),o==r.length&&(n=a);continue;case"utf-8":a=p.a.utf8Decode(a);continue;case"json":a=JSON.parse(a);continue;case"cipher":if(null!=e.channelOptions&&e.channelOptions.cipher){var h=c[3],c=e.channelOptions.channelCipher;if(h!=c.algorithm)throw new Error("Unable to decrypt message with given cipher; incompatible cipher params");a=c.decrypt(a);continue}throw new Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!e.plugins||!e.plugins.vcdiff)throw new f.a("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if("undefined"==typeof Uint8Array)throw new f.a("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{var l=e.baseEncodedPreviousPayload;"string"==typeof l&&(l=p.a.utf8Encode(l)),l=p.a.toBuffer(l),a=p.a.toBuffer(a),n=a=p.a.typedArrayToBuffer(e.plugins.vcdiff.decode(a,l))}catch(t){throw new f.a("Vcdiff delta decode failed with "+t,40018,400)}continue;default:throw new Error("Unknown encoding")}break}}catch(t){throw new f.a("Error processing the "+u+" encoding, decoder returned ‘"+t.message+"’",t.code||40013,400)}finally{t.encoding=o<=0?null:r.slice(0,o).join("/"),t.data=a}}e.baseEncodedPreviousPayload=n},a.fromResponseBody=function(t,e,n){n&&(t=r.a.decodeBody(t,n));for(var i=0;i<t.length;i++){var o=t[i]=a.fromValues(t[i]);try{a.decode(o,e)}catch(t){s.a.logAction(s.a.LOG_ERROR,"Message.fromResponseBody()",t.toString())}}return t},a.fromValues=function(t){return r.a.mixin(new a,t)},a.fromValuesArray=function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i++)n[i]=a.fromValues(t[i]);return n},a.fromEncoded=function(t,e){var n=a.fromValues(t);o(e);try{a.decode(n,e)}catch(t){s.a.logAction(s.a.LOG_ERROR,"Message.fromEncoded()",t.toString())}return n},a.fromEncodedArray=function(t,e){return o(e),r.a.arrMap(t,function(t){return a.fromEncoded(t,e)})},a.getMessagesSize=function(t){for(var e,n,i=0,o=0;o<t.length;o++)i+=(e=t[o]).size||(e.size=(n=void 0,n=0,(e=e).name&&(n+=e.name.length),e.clientId&&(n+=e.clientId.length),e.extras&&(n+=JSON.stringify(e.extras).length),e.data&&(n+=r.a.dataSizeBytes(e.data)),n));return i},a);function a(){this.name=void 0,this.id=void 0,this.timestamp=void 0,this.clientId=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.data=void 0,this.encoding=void 0,this.extras=void 0,this.size=void 0}function o(t){if(t&&t.cipher&&!t.cipher.channelCipher){if(!i.a)throw new Error("Encryption not enabled; use ably.encryption.js instead");var e=i.a.getCipher(t.cipher);t.cipher=e.cipherParams,t.channelCipher=e.cipher}}e.a=n},function(t,e,n){var i;t.exports=(i=n(12),function(){var t,o;"function"==typeof ArrayBuffer&&(t=i.lib.WordArray,o=t.init,(t.init=function(t){if(t instanceof ArrayBuffer&&(t=new Uint8Array(t)),(t instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array)&&(t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),t instanceof Uint8Array){for(var e=t.byteLength,n=[],i=0;i<e;i++)n[i>>>2]|=t[i]<<24-i%4*8;o.call(this,n,e)}else o.apply(this,arguments)}).prototype=t)}(),i.lib.WordArray)},function(t,e,n){"use strict";var i=n(3),s=n(0),o=n(4),a=n(9),c=n(1),n=function(){i.a.msgpack;function r(){this.action=void 0,this.id=void 0,this.timestamp=void 0,this.clientId=void 0,this.connectionId=void 0,this.data=void 0,this.encoding=void 0,this.size=void 0}return r.Actions=["absent","present","enter","leave","update"],r.prototype.isSynthesized=function(){return this.id.substring(this.connectionId.length,0)!==this.connectionId},r.prototype.parseId=function(){var t=this.id.split(":");return{connectionId:t[0],msgSerial:parseInt(t[1],10),index:parseInt(t[2],10)}},r.prototype.toJSON=function(){var t,e={clientId:this.clientId,action:(t=this.action,c.a.arrIndexOf(r.Actions,t)),encoding:this.encoding},n=this.data;return n&&o.a.isBuffer(n)&&(n=0<arguments.length?(t=this.encoding,e.encoding=t?t+"/base64":"base64",o.a.base64Encode(n)):o.a.toBuffer(n)),e.data=n,e},r.prototype.toString=function(){var t="[PresenceMessage";return t+="; action="+this.action,this.id&&(t+="; id="+this.id),this.timestamp&&(t+="; timestamp="+this.timestamp),this.clientId&&(t+="; clientId="+this.clientId),this.connectionId&&(t+="; connectionId="+this.connectionId),this.encoding&&(t+="; encoding="+this.encoding),this.data&&("string"==typeof this.data?t+="; data="+this.data:o.a.isBuffer(this.data)?t+="; data (buffer)="+o.a.base64Encode(this.data):t+="; data (json)="+JSON.stringify(this.data)),t+="]"},r.encode=a.a.encode,r.decode=a.a.decode,r.fromResponseBody=function(t,e,n){n&&(t=c.a.decodeBody(t,n));for(var i=0;i<t.length;i++){var o=t[i]=r.fromValues(t[i],!0);try{r.decode(o,e)}catch(t){s.a.logAction(s.a.LOG_ERROR,"PresenceMessage.fromResponseBody()",t.toString())}}return t},r.fromValues=function(t,e){return e&&(t.action=r.Actions[t.action]),c.a.mixin(new r,t)},r.fromValuesArray=function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i++)n[i]=r.fromValues(t[i]);return n},r.fromEncoded=function(t,e){var n=r.fromValues(t,!0);try{r.decode(n,e)}catch(t){s.a.logAction(s.a.LOG_ERROR,"PresenceMessage.fromEncoded()",t.toString())}return n},r.fromEncodedArray=function(t,e){return c.a.arrMap(t,function(t){return r.fromEncoded(t,e)})},r.getMessagesSize=a.a.getMessagesSize,r}();e.a=n},function(e,t,g){(function(d){var t;e.exports=(t=function(u){var i;if("undefined"!=typeof window&&window.crypto&&(i=window.crypto),!i&&"undefined"!=typeof window&&window.msCrypto&&(i=window.msCrypto),!i&&void 0!==d&&d.crypto&&(i=d.crypto),!i)try{i=g(42)}catch(t){}var n=Object.create||function(t){return e.prototype=t,t=new e,e.prototype=null,t};function e(){}var t={},o=t.lib={},r=o.Base={extend:function(t){var e=n(this);return t&&e.mixIn(t),e.hasOwnProperty("init")&&this.init!==e.init||(e.init=function(){e.$super.init.apply(this,arguments)}),(e.init.prototype=e).$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},h=o.WordArray=r.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,n=t.words,i=this.sigBytes,o=t.sigBytes;if(this.clamp(),i%4)for(var r=0;r<o;r++){var s=n[r>>>2]>>>24-r%4*8&255;e[i+r>>>2]|=s<<24-(i+r)%4*8}else for(r=0;r<o;r+=4)e[i+r>>>2]=n[r>>>2];return this.sigBytes+=o,this},clamp:function(){var t=this.words,e=this.sigBytes;t[e>>>2]&=4294967295<<32-e%4*8,t.length=u.ceil(e/4)},clone:function(){var t=r.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var e=[],n=0;n<t;n+=4)e.push(function(){if(i){if("function"==typeof i.getRandomValues)try{return i.getRandomValues(new Uint32Array(1))[0]}catch(t){}if("function"==typeof i.randomBytes)try{return i.randomBytes(4).readInt32LE()}catch(t){}}throw new Error("Native crypto module could not be used to get secure random number.")}());return new h.init(e,t)}}),s=t.enc={},a=s.Hex={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],o=0;o<n;o++){var r=e[o>>>2]>>>24-o%4*8&255;i.push((r>>>4).toString(16)),i.push((15&r).toString(16))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i+=2)n[i>>>3]|=parseInt(t.substr(i,2),16)<<24-i%8*4;return new h.init(n,e/2)}},c=s.Latin1={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],o=0;o<n;o++){var r=e[o>>>2]>>>24-o%4*8&255;i.push(String.fromCharCode(r))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i++)n[i>>>2]|=(255&t.charCodeAt(i))<<24-i%4*8;return new h.init(n,e)}},l=s.Utf8={stringify:function(t){try{return decodeURIComponent(escape(c.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return c.parse(unescape(encodeURIComponent(t)))}},p=o.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=new h.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(t){var e,n=this._data,i=n.words,o=n.sigBytes,r=this.blockSize,s=o/(4*r),a=(s=t?u.ceil(s):u.max((0|s)-this._minBufferSize,0))*r,o=u.min(4*a,o);if(a){for(var c=0;c<a;c+=r)this._doProcessBlock(i,c);e=i.splice(0,a),n.sigBytes-=o}return new h.init(e,o)},clone:function(){var t=r.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),f=(o.Hasher=p.extend({cfg:r.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(n){return function(t,e){return new n.init(e).finalize(t)}},_createHmacHelper:function(n){return function(t,e){return new f.HMAC.init(n,e).finalize(t)}}}),t.algo={});return t}(Math),t)}).call(this,g(20))},function(t,e,n){"use strict";n=n(2),n={disconnected:n.a.fromValues({statusCode:400,code:80003,message:"Connection to server temporarily unavailable"}),suspended:n.a.fromValues({statusCode:400,code:80002,message:"Connection to server unavailable"}),failed:n.a.fromValues({statusCode:400,code:8e4,message:"Connection failed or disconnected by server"}),closing:n.a.fromValues({statusCode:400,code:80017,message:"Connection closing"}),closed:n.a.fromValues({statusCode:400,code:80017,message:"Connection closed"}),unknownConnectionErr:n.a.fromValues({statusCode:500,code:50002,message:"Internal connection error"}),unknownChannelErr:n.a.fromValues({statusCode:500,code:50001,message:"Internal channel error"})};e.a=n},function(t,e,n){"use strict";var g=n(0),a=n(3),m=n(1),y=n(6),c=n(22),v=n(4),O=n(2),u=function(){function h(){this.buffer=[]}h.prototype.append=function(t){return this.buffer.push(t),this},h.prototype.toString=function(){return this.buffer.join("")};var l={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){for(var e=new h,n=l.codex,i=new p(t);i.moveNext();){var o=i.current;i.moveNext();var r=i.current;i.moveNext();var s=i.current,a=o>>2,c=(3&o)<<4|r>>4,u=(15&r)<<2|s>>6,o=63&s;isNaN(r)?u=o=64:isNaN(s)&&(o=64),e.append(n.charAt(a)+n.charAt(c)+n.charAt(u)+n.charAt(o))}return e.toString()},decode:function(t){for(var e=new h,n=new s(t);n.moveNext();){var i,o,r=n.current;r<128?e.append(String.fromCharCode(r)):191<r&&r<224?(n.moveNext(),i=n.current,e.append(String.fromCharCode((31&r)<<6|63&i))):(n.moveNext(),i=n.current,n.moveNext(),o=n.current,e.append(String.fromCharCode((15&r)<<12|(63&i)<<6|63&o)))}return e.toString()}};function p(t){this._input=t,this._index=-1,this._buffer=[]}function s(t){this._input=t,this._index=-1,this._buffer=[]}return p.prototype={current:Number.NaN,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=Number.NaN,!1;var t=this._input.charCodeAt(++this._index);return 13==t&&10==this._input.charCodeAt(this._index+1)&&(t=10,this._index+=2),t<128?this.current=t:(127<t&&t<2048?this.current=t>>6|192:(this.current=t>>12|224,this._buffer.push(t>>6&63|128)),this._buffer.push(63&t|128)),!0}},s.prototype={current:64,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return!(this.current=64);var t=l.codex.indexOf(this._input.charAt(++this._index)),e=l.codex.indexOf(this._input.charAt(++this._index)),n=l.codex.indexOf(this._input.charAt(++this._index)),i=l.codex.indexOf(this._input.charAt(++this._index)),o=t<<2|e>>4,t=(15&e)<<4|n>>2,e=(3&n)<<6|i;return this.current=o,64!=n&&this._buffer.push(t),64!=i&&this._buffer.push(e),!0}},l}(),i=n(38),h=n.n(i),R=n(17),n=function(){var l,i,p=Math.pow(2,17);function r(){}function f(t){return m.a.isErrorInfo(t)?(t.code||(403===t.statusCode?t.code=40300:(t.code=40170,t.statusCode=401)),t):new O.a(m.a.inspectError(t),t.code||40170,t.statusCode||401)}function d(t){if(!t)return"";"string"==typeof t&&(t=JSON.parse(t));var e={},n=m.a.keysArray(t,!0);if(!n)return"";n.sort();for(var i=0;i<n.length;i++)e[n[i]]=t[n[i]].sort();return JSON.stringify(e)}function o(t){if(t.authCallback)g.a.logAction(g.a.LOG_MINOR,"Auth()","using token auth with authCallback");else if(t.authUrl)g.a.logAction(g.a.LOG_MINOR,"Auth()","using token auth with authUrl");else if(t.key)g.a.logAction(g.a.LOG_MINOR,"Auth()","using token auth with client-side signing");else{if(!t.tokenDetails){t="authOptions must include valid authentication parameters";throw g.a.logAction(g.a.LOG_ERROR,"Auth()",t),new Error(t)}g.a.logAction(g.a.LOG_MINOR,"Auth()","using token auth with supplied token only")}}l=a.a.createHmac?(i=function(t){return Buffer.from(t,"ascii").toString("base64")},function(t,e){e=a.a.createHmac("SHA256",e);return e.update(t),e.digest("base64")}):(i=u.encode,function(t,e){return Object(R.stringify)(h()(t,e))});var s=0;function t(t,e){if(this.client=t,this.tokenParams=e.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,(i=e).useTokenAuth||(!("useTokenAuth"in(t=i))||t.useTokenAuth)&&(i.authCallback||i.authUrl||i.token||i.tokenDetails)){if(e.key&&!l){var n="client-side token request signing not supported";throw g.a.logAction(g.a.LOG_ERROR,"Auth()",n),new Error(n)}(i=e).key||i.authCallback||i.authUrl||g.a.logAction(g.a.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(e.defaultTokenParams,e),o(this.authOptions)}else{if(!e.key){n="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw g.a.logAction(g.a.LOG_ERROR,"Auth()",n),new O.a(n,40160,401)}g.a.logAction(g.a.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(e)}var i}return t.prototype.authorize=function(t,e,n){if("function"!=typeof t||n?"function"!=typeof e||n||(n=e,e=null):(n=t,e=t=null),!n){if(this.client.options.promises)return m.a.promisify(this,"authorize",arguments);n=r}var i=this;if(e&&e.key&&this.authOptions.key!==e.key)throw new O.a("Unable to update auth options with incompatible key",40102,401);e&&"force"in e&&(g.a.logAction(g.a.LOG_ERROR,"Auth.authorize","Deprecation warning: specifying {force: true} in authOptions is no longer necessary, authorize() now always gets a new token. Please remove this, as in version 1.0 and later, having a non-null authOptions will overwrite stored library authOptions, which may not be what you want"),m.a.isOnlyPropIn(e,"force")&&(e=null)),this._forceNewToken(t,e,function(t,e){return t?(i.client.connection&&i.client.connection.connectionManager.actOnErrorFromAuthorize(t),void n(t)):void(i.client.connection?i.client.connection.connectionManager.onAuthUpdated(e,n):n(null,e))})},t.prototype.authorise=function(){g.a.deprecated("Auth.authorise","Auth.authorize"),this.authorize.apply(this,arguments)},t.prototype._forceNewToken=function(t,e,n){var i=this;this.tokenDetails=null,this._saveTokenOptions(t,e),o(this.authOptions),this._ensureValidAuthCredentials(!0,function(t,e){delete i.tokenParams.timestamp,delete i.authOptions.queryTime,n(t,e)})},t.prototype.requestToken=function(t,s,a){if("function"!=typeof t||a?"function"!=typeof s||a||(a=s,s=null):(a=t,s=t=null),!a&&this.client.options.promises)return m.a.promisify(this,"requestToken",arguments);s=s||this.authOptions,t=t||m.a.copy(this.tokenParams),a=a||r;var e,c=this.client;if(s.authCallback)g.a.logAction(g.a.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),e=s.authCallback;else if(s.authUrl)g.a.logAction(g.a.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),e=function(t,r){var e=m.a.mixin({accept:"application/json, text/plain"},s.authHeaders),n=s.authMethod&&"post"===s.authMethod.toLowerCase();n||-1<(i=s.authUrl.indexOf("?"))&&(o=m.a.parseQueryString(s.authUrl.slice(i)),s.authUrl=s.authUrl.slice(0,i),s.authParams=m.a.mixin(o,s.authParams));var i=m.a.mixin({},s.authParams||{},t),o=function(t,e,n,i){var o;if(t?g.a.logAction(g.a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+m.a.inspectError(t)):(o=n["content-type"],g.a.logAction(g.a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+o+"; body: "+m.a.inspectBody(e))),t||i)return r(t,e);if(v.a.isBuffer(e)&&(e=e.toString()),o){i=-1<o.indexOf("application/json"),t=-1<o.indexOf("text/plain")||-1<o.indexOf("application/jwt");if(i||t){if(i){if(e.length>p)return void r(new O.a("authUrl response exceeded max permitted length",40170,401));try{e=JSON.parse(e)}catch(t){return void r(new O.a("Unexpected error processing authURL response; err = "+t.message,40170,401))}}r(null,e,o)}else r(new O.a("authUrl responded with unacceptable content-type "+o+", should be either text/plain, application/jwt or application/json",40170,401))}else r(new O.a("authUrl response is missing a content-type header",40170,401))};g.a.logAction(g.a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+s.authUrl+"; Params: "+JSON.stringify(i)+"; method: "+(n?"POST":"GET")),n?((t=e||{})["content-type"]="application/x-www-form-urlencoded",n=m.a.toQueryString(i).slice(1),y.a.postUri(c,s.authUrl,t,n,{},o)):y.a.getUri(c,s.authUrl,e||{},i,o)};else{if(!s.key)return g.a.logAction(g.a.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),void a(new O.a("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)",40171,403));var n=this;g.a.logAction(g.a.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),e=function(t,e){n.createTokenRequest(t,s,e)}}"capability"in t&&(t.capability=d(t.capability));var u=!1,i=this.client.options.timeouts.realtimeRequestTimeout,h=setTimeout(function(){u=!0;var t="Token request callback timed out after "+i/1e3+" seconds";g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()",t),a(new O.a(t,40170,401))},i);e(t,function(t,e,n){if(!u){if(clearTimeout(h),t)return g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+m.a.inspectError(t)),void a(f(t));if("string"!=typeof e){if("object"!=typeof e){var i="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof e;return g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()",i),void a(new O.a(i,40170,401))}var o,r=JSON.stringify(e).length;if(p<r&&!s.suppressMaxLengthCheck)a(new O.a("Token request/details object exceeded max permitted stringified size (was "+r+" bytes)",40170,401));else if("issued"in e)a(null,e);else{if(!("keyName"in e)){var i="Expected token request callback to call back with a token string, token request object, or token details object";return g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()",i),void a(new O.a(i,40170,401))}t=function(t,e,n,i){return t?(g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+m.a.inspectError(t)),void a(f(t))):(i||(e=JSON.parse(e)),g.a.logAction(g.a.LOG_MINOR,"Auth.getToken()","token received"),void a(null,e))},o="/keys/"+(r=e).keyName+"/requestToken",i=m.a.defaultPostHeaders(),s.requestHeaders&&m.a.mixin(i,s.requestHeaders),g.a.logAction(g.a.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+o+"; Token params: "+JSON.stringify(r)),r=JSON.stringify(r),y.a.post(c,function(t){return c.baseUri(t)+o},i,r,null,t)}}else 0===e.length?a(new O.a("Token string is empty",40170,401)):e.length>p?a(new O.a("Token string exceeded max permitted length (was "+e.length+" bytes)",40170,401)):"undefined"===e||"null"===e?a(new O.a("Token string was literal null/undefined",40170,401)):"{"!==e[0]||n&&-1<n.indexOf("application/jwt")?a(null,{token:e}):a(new O.a("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401))}})},t.prototype.createTokenRequest=function(t,e,n){if("function"!=typeof t||n?"function"!=typeof e||n||(n=e,e=null):(n=t,e=t=null),!n&&this.client.options.promises)return m.a.promisify(this,"createTokenRequest",arguments);e=e||this.authOptions,t=t||m.a.copy(this.tokenParams);var i,o,r,s,a,c,u,h=e.key;h?(h=(i=h.split(":"))[0],(o=i[1])?""!==t.clientId?("capability"in t&&(t.capability=d(t.capability)),r=m.a.mixin({keyName:h},t),s=t.clientId||"",a=t.ttl||"",c=t.capability||"",t=this,u=function(){var t=r.nonce||(r.nonce=("000000"+Math.floor(1e16*Math.random())).slice(-16)),e=r.timestamp,t=r.keyName+"\n"+a+"\n"+c+"\n"+s+"\n"+e+"\n"+t+"\n";r.mac=r.mac||l(t,o),g.a.logAction(g.a.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),n(null,r)},r.timestamp?u():t.getTimestamp(e&&e.queryTime,function(t,e){t?n(t):(r.timestamp=e,u())})):n(new O.a("clientId can’t be an empty string",40012,400)):n(new O.a("Invalid key specified",40101,403))):n(new O.a("No key specified",40101,403))},t.prototype.getAuthParams=function(n){"basic"==this.method?n(null,{key:this.key}):this._ensureValidAuthCredentials(!1,function(t,e){t?n(t):n(null,{access_token:e.token})})},t.prototype.getAuthHeaders=function(n){"basic"==this.method?n(null,{authorization:"Basic "+this.basicKey}):this._ensureValidAuthCredentials(!1,function(t,e){t?n(t):n(null,{authorization:"Bearer "+i(e.token)})})},t.prototype.getTimestamp=function(t,e){this.isTimeOffsetSet()||!t&&!this.authOptions.queryTime?e(null,this.getTimestampUsingOffset()):this.client.time(e)},t.prototype.getTimestampUsingOffset=function(){return m.a.now()+(this.client.serverTimeOffset||0)},t.prototype.isTimeOffsetSet=function(){return null!==this.client.serverTimeOffset},t.prototype._saveBasicOptions=function(t){this.method="basic",this.key=t.key,this.basicKey=i(t.key),this.authOptions=t||{},"clientId"in t&&this._userSetClientId(t.clientId)},t.prototype._saveTokenOptions=function(t,e){this.method="token",t&&(this.tokenParams=t),e&&(e.token&&(e.tokenDetails="string"==typeof e.token?{token:e.token}:e.token),e.tokenDetails&&(this.tokenDetails=e.tokenDetails),"clientId"in e&&this._userSetClientId(e.clientId),this.authOptions=e)},t.prototype._ensureValidAuthCredentials=function(t,e){var i,o=this,n=this.tokenDetails;if(n){if(this._tokenClientIdMismatch(n.clientId))return void e(new O.a("Mismatch between clientId in token ("+n.clientId+") and current clientId ("+this.clientId+")",40102,403));if(!this.isTimeOffsetSet()||!n.expires||n.expires>=this.getTimestampUsingOffset())return g.a.logAction(g.a.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+n.expires),void e(null,n);g.a.logAction(g.a.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}(this.waitingForTokenRequest||(this.waitingForTokenRequest=Object(c.a)())).push(e),null!==this.currentTokenRequestId&&!t||(i=this.currentTokenRequestId=s++,this.requestToken(this.tokenParams,this.authOptions,function(t,e){var n;o.currentTokenRequestId>i?g.a.logAction(g.a.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"):(o.currentTokenRequestId=null,n=o.waitingForTokenRequest||r,o.waitingForTokenRequest=null,t?n(t):n(null,o.tokenDetails=e))}))},t.prototype._userSetClientId=function(t){if("string"!=typeof t&&null!==t)throw new O.a("clientId must be either a string or null",40012,400);if("*"===t)throw new O.a('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);t=this._uncheckedSetClientId(t);if(t)throw t},t.prototype._uncheckedSetClientId=function(t){if(this._tokenClientIdMismatch(t)){var e="Unexpected clientId mismatch: client has "+this.clientId+", requested "+t,n=new O.a(e,40102,401);return g.a.logAction(g.a.LOG_ERROR,"Auth._uncheckedSetClientId()",e),n}return this.clientId=this.tokenParams.clientId=t,null},t.prototype._tokenClientIdMismatch=function(t){return this.clientId&&"*"!==this.clientId&&t&&"*"!==t&&this.clientId!==t},t.isTokenErr=function(t){return t.code&&40140<=t.code&&t.code<40150},t}();e.a=n},function(t,e,n){"use strict";var s=n(1),i=n(8),a=n(19),c=n(0),u=n(5),o=n(13),r=n(14),h=n(2),n=(s.a.inherits(p,a.a),p.REQ_SEND=0,p.REQ_RECV=1,p.REQ_RECV_POLL=2,p.REQ_RECV_STREAM=3,p.prototype.connect=function(){c.a.logAction(c.a.LOG_MINOR,"CometTransport.connect()","starting"),a.a.prototype.connect.call(this);var o=this,t=this.params,e=t.options,n=u.a.getHost(e,t.host),t=u.a.getPort(e),e=e.tls?"https://":"http://";this.baseUri=e+n+":"+t+"/comet/";var r=this.baseUri+"connect";c.a.logAction(c.a.LOG_MINOR,"CometTransport.connect()","uri: "+r),this.auth.getAuthParams(function(t,e){var i;t?o.disconnect(t):o.isDisposed||(o.authParams=e,"stream"in(e=o.params.getConnectParams(e))&&(o.stream=e.stream),c.a.logAction(c.a.LOG_MINOR,"CometTransport.connect()","connectParams:"+s.a.toQueryString(e)),i=!1,(e=o.recvRequest=o.createRequest(r,null,e,null,o.stream?3:1)).on("data",function(t){o.recvRequest&&(i||(i=!0,o.emit("preconnect")),o.onData(t))}),e.on("complete",function(t,e,n){o.recvRequest||(t=t||new h.a("Request cancelled",80003,400)),o.recvRequest=null,i||t||(i=!0,o.emit("preconnect")),o.onActivity(),t?t.code?o.onData(l(t)):o.disconnect(t):s.a.nextTick(function(){o.recv()})}),e.exec())})},p.prototype.requestClose=function(){c.a.logAction(c.a.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)},p.prototype.requestDisconnect=function(){c.a.logAction(c.a.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)},p.prototype._requestCloseOrDisconnect=function(e){var n,t=e?this.closeUri:this.disconnectUri;t&&((t=(n=this).createRequest(t,null,this.authParams,null,0)).on("complete",function(t){t&&(c.a.logAction(c.a.LOG_ERROR,"CometTransport.request"+(e?"Close()":"Disconnect()"),"request returned err = "+s.a.inspectError(t)),n.finish("disconnected",t))}),t.exec())},p.prototype.dispose=function(){var t;c.a.logAction(c.a.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(c.a.logAction(c.a.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",o.a.disconnected),t=this,s.a.nextTick(function(){t.emit("disposed")}))},p.prototype.onConnect=function(t){var e;this.isDisposed||(e=t.connectionKey,a.a.prototype.onConnect.call(this,t),e=this.baseUri+e,c.a.logAction(c.a.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+e+"; connectionKey = "+t.connectionKey),this.sendUri=e+"/send",this.recvUri=e+"/recv",this.closeUri=e+"/close",this.disconnectUri=e+"/disconnect")},p.prototype.send=function(t){if(this.sendRequest)return this.pendingItems=this.pendingItems||[],void this.pendingItems.push(t);var e=this.pendingItems||[];e.push(t),this.pendingItems=null,this.sendItems(e)},p.prototype.sendAnyPending=function(){var t=this.pendingItems;t&&(this.pendingItems=null,this.sendItems(t))},p.prototype.sendItems=function(t){var n=this,t=this.sendRequest=n.createRequest(n.sendUri,null,n.authParams,this.encodeRequest(t),0);t.on("complete",function(t,e){t&&c.a.logAction(c.a.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+s.a.inspectError(t)),n.sendRequest=null,t?t.code?n.onData(l(t)):n.disconnect(t):(e&&n.onData(e),n.pendingItems&&s.a.nextTick(function(){n.sendRequest||n.sendAnyPending()}))}),t.exec()},p.prototype.recv=function(){var e,t;this.recvRequest||this.isConnected&&((t=(e=this).recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,e.stream?3:2)).on("data",function(t){e.onData(t)}),t.on("complete",function(t){e.recvRequest=null,e.onActivity(),t?t.code?e.onData(l(t)):e.disconnect(t):s.a.nextTick(function(){e.recv()})}),t.exec())},p.prototype.onData=function(t){try{var e=this.decodeResponse(t);if(e&&e.length)for(var n=0;n<e.length;n++)this.onProtocolMessage(i.a.fromDeserialized(e[n]))}catch(t){c.a.logAction(c.a.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+t.stack)}},p.prototype.encodeRequest=function(t){return JSON.stringify(t)},p.prototype.decodeResponse=function(t){return"string"==typeof t&&(t=JSON.parse(t)),t},p.prototype.onAuthUpdated=function(t){this.authParams={access_token:t.token}},p);function l(t){return(e=t).code&&(!r.a.isTokenErr(e)&&(s.a.arrIn([80015,80017,80030],e.code)||4e4<=e.code&&e.code<5e4))?[i.a.fromValues({action:i.a.Action.ERROR,error:t})]:[i.a.fromValues({action:i.a.Action.DISCONNECTED,error:t})];var e}function p(t,e,n){n.format=void 0,n.heartbeats=!0,a.a.call(this,t,e,n),this.stream=!("stream"in n)||n.stream,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}e.a=n},function(t,e,n){"use strict";(function(c){var u=n(1),t=function(){var e,n,t="ablyjs-storage-test";try{c.sessionStorage.setItem(t,t),c.sessionStorage.removeItem(t),e=!0}catch(t){e=!1}try{c.localStorage.setItem(t,t),c.localStorage.removeItem(t),n=!0}catch(t){n=!1}function i(){}function o(t){return t?c.sessionStorage:c.localStorage}function r(t,e,n,i){e={value:e};return n&&(e.expires=u.a.now()+n),o(i).setItem(t,JSON.stringify(e))}function s(t,e){var n=o(e).getItem(t);if(!n)return null;n=JSON.parse(n);return n.expires&&n.expires<u.a.now()?(o(e).removeItem(t),null):n.value}function a(t,e){return o(e).removeItem(t)}return n&&(i.set=function(t,e,n){return r(t,e,n,!1)},i.get=function(t){return s(t,!1)},i.remove=function(t){return a(t,!1)}),e&&(i.setSession=function(t,e,n){return r(t,e,n,!0)},i.getSession=function(t){return s(t,!0)},i.removeSession=function(t){return a(t,!0)}),i}();e.a=t}).call(this,n(20))},function(t,e,n){var i;t.exports=(i=n(12),function(){var c=i.lib.WordArray;i.enc.Base64={stringify:function(t){var e=t.words,n=t.sigBytes,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";t.clamp();for(var o=[],r=0;r<n;r+=3)for(var s=(e[r>>>2]>>>24-r%4*8&255)<<16|(e[r+1>>>2]>>>24-(r+1)%4*8&255)<<8|e[r+2>>>2]>>>24-(r+2)%4*8&255,a=0;a<4&&r+.75*a<n;a++)o.push(i.charAt(s>>>6*(3-a)&63));var c=i.charAt(64);if(c)for(;o.length%4;)o.push(c);return o.join("")},parse:function(t){var e=t.length,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=this._reverseMap;if(!i){i=this._reverseMap=[];for(var o=0;o<n.length;o++)i[n.charCodeAt(o)]=o}var r=n.charAt(64);return!r||-1!==(r=t.indexOf(r))&&(e=r),function(t,e,n){for(var i=[],o=0,r=0;r<e;r++){var s,a;r%4&&(s=n[t.charCodeAt(r-1)]<<r%4*2,a=n[t.charCodeAt(r)]>>>6-r%4*2,a=s|a,i[o>>>2]|=a<<24-o%4*8,o++)}return c.create(i,o)}(t,e,i)}}}(),i.enc.Base64)},function(t,e,n){"use strict";var i=n(10),s=n.n(i),a=n(17),i=n(28),h=n.n(i),l=n(3),p=n(0),f=n(4),n=function(){var i,c;c=l.a.getRandomWordArray||("undefined"!=typeof Uint32Array&&l.a.getRandomValues?(i=new Uint32Array(4),function(t,e){var t=t/4,n=4==t?i:new Uint32Array(t);l.a.getRandomValues(n,function(t){e(t,f.a.toWordArray(n))})}):function(t,e){p.a.logAction(p.a.LOG_MAJOR,"Ably.Crypto.generateRandom()","Warning: the browser you are using does not support secure cryptographically secure randomness generation; falling back to insecure Math.random()");for(var n=t/4,i=new Array(n),o=0;o<n;o++)i[o]=Math.floor(4294967296*Math.random())-2147483648;e(null,s.a.create(i))});s.a.create([0,0,0,0]);var u=[s.a.create([269488144,269488144,269488144,269488144],16),s.a.create([16777216],1),s.a.create([33685504],2),s.a.create([50529024],3),s.a.create([67372036],4),s.a.create([84215045,83886080],5),s.a.create([101058054,101056512],6),s.a.create([117901063,117901056],7),s.a.create([134744072,134744072],8),s.a.create([151587081,151587081,150994944],9),s.a.create([168430090,168430090,168427520],10),s.a.create([185273099,185273099,185273088],11),s.a.create([202116108,202116108,202116108],12),s.a.create([218959117,218959117,218959117,218103808],13),s.a.create([235802126,235802126,235802126,235798528],14),s.a.create([252645135,252645135,252645135,252645135],15),s.a.create([269488144,269488144,269488144,269488144],16)];function o(){}function r(){this.algorithm=null,this.keyLength=null,this.mode=null,this.key=null}function n(t,e,n){this.algorithm=t.algorithm+"-"+String(t.keyLength)+"-"+t.mode,this.cjsAlgorithm=t.algorithm.toUpperCase().replace(/-\d+$/,""),this.key=f.a.toWordArray(t.key),n&&(this.iv=f.a.toWordArray(n).clone()),this.blockLengthWords=e}return o.CipherParams=r,o.getDefaultParams=function(e){var t;if("function"!=typeof e&&"string"!=typeof e){if(!e.key)throw new Error("Crypto.getDefaultParams: a key is required");t="string"==typeof e.key?Object(a.parse)(e.key.replace("_","/").replace("-","+")):f.a.toWordArray(e.key);var n=new r;if(n.key=t,n.algorithm=e.algorithm||"aes",n.keyLength=32*t.words.length,n.mode=e.mode||"cbc",e.keyLength&&e.keyLength!==n.keyLength)throw new Error("Crypto.getDefaultParams: a keyLength of "+e.keyLength+" was specified, but the key actually has length "+n.keyLength);return function(t){if("aes"===t.algorithm&&"cbc"===t.mode&&128!==t.keyLength&&256!==t.keyLength)throw new Error("Unsupported key length "+t.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}(n),n}if(p.a.deprecated("Crypto.getDefaultParams(key, callback)","Crypto.getDefaultParams({key: key})"),"function"==typeof e)o.generateRandomKey(function(t){e(null,o.getDefaultParams({key:t}))});else{if("function"!=typeof arguments[1])throw new Error("Invalid arguments for Crypto.getDefaultParams");arguments[1](null,o.getDefaultParams({key:e}))}},o.generateRandomKey=function(t,e){1==arguments.length&&"function"==typeof t&&(e=t,t=void 0),c((t||256)/8,e)},o.getCipher=function(t){var e=t instanceof r?t:o.getDefaultParams(t);return{cipherParams:e,cipher:new n(e,4,t.iv)}},n.prototype.encrypt=function(n,i){p.a.logAction(p.a.LOG_MICRO,"CBCCipher.encrypt()","");function o(){a.getIv(function(t,e){t?i(t):(t=a.encryptCipher.process(n.concat(u[s-r])),t=e.concat(t),i(null,t))})}var r=(n=f.a.toWordArray(n)).sigBytes,s=r+16&-16,a=this;this.encryptCipher?o():this.iv?(this.encryptCipher=h.a.algo[this.cjsAlgorithm].createEncryptor(this.key,{iv:this.iv}),o()):c(16,function(t,e){t?i(t):(a.encryptCipher=h.a.algo[a.cjsAlgorithm].createEncryptor(a.key,{iv:e}),a.iv=e,o())})},n.prototype.decrypt=function(t){p.a.logAction(p.a.LOG_MICRO,"CBCCipher.decrypt()",""),t=f.a.toWordArray(t);var e=this.blockLengthWords,n=t.words,t=s.a.create(n.slice(0,e)),n=s.a.create(n.slice(e)),e=h.a.algo[this.cjsAlgorithm].createDecryptor(this.key,{iv:t}),t=e.process(n),n=e.finalize();return e.reset(),n&&n.sigBytes&&t.concat(n),t},n.prototype.getIv=function(n){if(this.iv){var t=this.iv;return this.iv=null,void n(null,t)}var i=this;c(16,function(t,e){t?n(t):n(null,i.encryptCipher.process(e))})},o}();e.a=n},function(t,e,n){"use strict";var i,o,r,s=n(8),a=n(1),c=n(7),u=n(0),h=n(13),l=n(2),n=(i=s.a.Action,o=s.a.fromValues({action:i.CLOSE}),r=s.a.fromValues({action:i.DISCONNECT}),a.a.inherits(p,c.a),p.prototype.connect=function(){},p.prototype.close=function(){this.isConnected&&this.requestClose(),this.finish("closed",h.a.closed)},p.prototype.disconnect=function(t){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",t||h.a.disconnected)},p.prototype.fail=function(t){this.isConnected&&this.requestDisconnect(),this.finish("failed",t||h.a.failed)},p.prototype.finish=function(t,e){this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout(this.idleTimer),this.idleTimer=null,this.emit(t,e),this.dispose())},p.prototype.onProtocolMessage=function(t){switch(u.a.shouldLog(u.a.LOG_MICRO)&&u.a.logAction(u.a.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+s.a.stringify(t)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),t.action){case i.HEARTBEAT:u.a.logAction(u.a.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",t.id);break;case i.CONNECTED:this.onConnect(t),this.emit("connected",t.error,t.connectionId,t.connectionDetails,t);break;case i.CLOSED:this.onClose(t);break;case i.DISCONNECTED:this.onDisconnect(t);break;case i.ACK:this.emit("ack",t.msgSerial,t.count);break;case i.NACK:this.emit("nack",t.msgSerial,t.count,t.error);break;case i.SYNC:if(void 0!==t.connectionId){this.emit("sync",t.connectionId,t);break}this.connectionManager.onChannelMessage(t,this);break;case i.AUTH:this.auth.authorize(function(t){t&&u.a.logAction(u.a.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+a.a.inspectError(t))});break;case i.ERROR:if(u.a.logAction(u.a.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+a.a.inspect(t.error)+(t.channel?", channel: "+t.channel:"")),void 0===t.channel){this.onFatalError(t);break}this.connectionManager.onChannelMessage(t,this);break;default:this.connectionManager.onChannelMessage(t,this)}},p.prototype.onConnect=function(t){this.isConnected=!0;t=t.connectionDetails.maxIdleInterval;t&&(this.maxIdleInterval=t+this.timeouts.realtimeRequestTimeout,this.onActivity())},p.prototype.onDisconnect=function(t){t=t&&t.error;u.a.logAction(u.a.LOG_MINOR,"Transport.onDisconnect()","err = "+a.a.inspectError(t)),this.finish("disconnected",t)},p.prototype.onFatalError=function(t){t=t&&t.error;u.a.logAction(u.a.LOG_MINOR,"Transport.onFatalError()","err = "+a.a.inspectError(t)),this.finish("failed",t)},p.prototype.onClose=function(t){t=t&&t.error;u.a.logAction(u.a.LOG_MINOR,"Transport.onClose()","err = "+a.a.inspectError(t)),this.finish("closed",t)},p.prototype.requestClose=function(){u.a.logAction(u.a.LOG_MINOR,"Transport.requestClose()",""),this.send(o)},p.prototype.requestDisconnect=function(){u.a.logAction(u.a.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(r)},p.prototype.ping=function(t){var e={action:s.a.Action.HEARTBEAT};t&&(e.id=t),this.send(s.a.fromValues(e))},p.prototype.dispose=function(){u.a.logAction(u.a.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()},p.prototype.onActivity=function(){this.maxIdleInterval&&(this.lastActivity=this.connectionManager.lastActivity=a.a.now(),this.setIdleTimer(this.maxIdleInterval+100))},p.prototype.setIdleTimer=function(t){var e=this;this.idleTimer||(this.idleTimer=setTimeout(function(){e.onIdleTimerExpire()},t))},p.prototype.onIdleTimerExpire=function(){this.idleTimer=null;var t=a.a.now()-this.lastActivity,e=this.maxIdleInterval-t;e<=0?(t="No activity seen from realtime in "+t+"ms; assuming connection has dropped",u.a.logAction(u.a.LOG_ERROR,"Transport.onIdleTimerExpire()",t),this.disconnect(new l.a(t,80003,408))):this.setIdleTimer(100+e)},p.prototype.onAuthUpdated=function(){},p);function p(t,e,n){c.a.call(this),(this.connectionManager=t).registerProposedTransport(this),this.auth=e,this.params=n,this.timeouts=n.options.timeouts,this.format=n.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}e.a=n},function(t,e){var n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){"use strict";function i(t,e,n,i){this.previous=t,this.current=e,n&&(this.retryIn=n),i&&(this.reason=i)}e.a=i},function(t,e,n){"use strict";var i=n(0),n=function(n){function t(){for(var t=0;t<n.length;t++){var e=n[t];if(e)try{e.apply(null,arguments)}catch(t){i.a.logAction(i.a.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+t+"; stack = "+t.stack)}}}return n=n||[],t.push=function(){Array.prototype.push.apply(n,arguments)},t};e.a=n},function(t,e,n){"use strict";var o=n(1),r=n(3),s=n(5),a=n(0),c=n(6),n=function(){function t(){}t.levels=["fatal","error","warning","info","debug"];return t.report=function(t,e,n,i){n={event_id:o.a.randomHexString(16),tags:o.a.mixin({lib:r.a.libver},i),platform:"javascript",level:t,release:s.a.version,fingerprint:n&&[n],message:e,request:{headers:{"User-Agent":r.a.userAgent},url:r.a.currentUrl}};a.a.logAction(a.a.LOG_MICRO,"ErrorReporter","POSTing to error reporter: "+e),c.a.postUri(null,s.a.errorReportingUrl,s.a.errorReportingHeaders,JSON.stringify(n),{},function(t,e){a.a.logAction(a.a.LOG_MICRO,"ErrorReporter","POSTing to error reporter resulted in: "+(t?o.a.inspectError(t):o.a.inspectBody(e)))})},t}();e.a=n},function(t,e,n){"use strict";var i=function(){var t={};function p(t,e,n){t.byteLength;for(var i=0,o=n.length;i<o;i++){var r=n.charCodeAt(i);if(r<128)t.setUint8(e++,r>>>0&127|0);else if(r<2048)t.setUint8(e++,r>>>6&31|192),t.setUint8(e++,r>>>0&63|128);else if(r<65536)t.setUint8(e++,r>>>12&15|224),t.setUint8(e++,r>>>6&63|128),t.setUint8(e++,r>>>0&63|128);else{if(!(r<1114112))throw new Error("bad codepoint "+r);t.setUint8(e++,r>>>18&7|240),t.setUint8(e++,r>>>12&63|128),t.setUint8(e++,r>>>6&63|128),t.setUint8(e++,r>>>0&63|128)}}}function n(t,e,n){for(var i="",o=e,r=e+n;o<r;o++){var s=t.getUint8(o);if(0!=(128&s))if(192!=(224&s))if(224!=(240&s)){if(240!=(248&s))throw new Error("Invalid byte "+s.toString(16));i+=String.fromCharCode((7&s)<<18|(63&t.getUint8(++o))<<12|(63&t.getUint8(++o))<<6|(63&t.getUint8(++o))<<0)}else i+=String.fromCharCode((15&s)<<12|(63&t.getUint8(++o))<<6|(63&t.getUint8(++o))<<0);else i+=String.fromCharCode((15&s)<<6|63&t.getUint8(++o));else i+=String.fromCharCode(s)}return i}function f(t){for(var e=0,n=0,i=t.length;n<i;n++){var o=t.charCodeAt(n);if(o<128)e+=1;else if(o<2048)e+=2;else if(o<65536)e+=3;else{if(!(o<1114112))throw new Error("bad codepoint "+o);e+=4}}return e}t.inspect=function(t){if(void 0===t)return"undefined";var e,n;t instanceof ArrayBuffer?(n="ArrayBuffer",e=new DataView(t)):t instanceof DataView&&(n="DataView",e=t);if(!e)return JSON.stringify(t);for(var i=[],o=0;o<t.byteLength;o++){if(20<o){i.push("...");break}var r=e.getUint8(o).toString(16);1===r.length&&(r="0"+r),i.push(r)}return"<"+n+" "+i.join(" ")+">"},t.utf8Write=p,t.utf8Read=n,t.utf8ByteCount=f,t.encode=function(t,e){var n=function t(e,n){var i=typeof e;if("string"==i){var o=f(e);if(o<32)return 1+o;if(o<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}ArrayBuffer.isView&&ArrayBuffer.isView(e)&&(e=e.buffer);if(e instanceof ArrayBuffer){var o=e.byteLength;if(o<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}if("number"==i){if(Math.floor(e)!==e)return 9;if(0<=e){if(e<128)return 1;if(e<256)return 2;if(e<65536)return 3;if(e<4294967296)return 5;if(e<0x10000000000000000)return 9;throw new Error("Number too big 0x"+e.toString(16))}if(-32<=e)return 1;if(-128<=e)return 2;if(-32768<=e)return 3;if(-2147483648<=e)return 5;if(-0x8000000000000000<=e)return 9;throw new Error("Number too small -0x"+e.toString(16).substr(1))}if("boolean"==i)return 1;if(null===e)return n?0:1;if(void 0===e)return n?0:3;if("function"==typeof e.toJSON)return t(e.toJSON(),n);if("object"==i){var r=0;if(Array.isArray(e)){o=e.length;for(var s=0;s<o;s++)r+=t(e[s],n)}else{var a=m(e,n);o=a.length;for(var s=0;s<o;s++){var c=a[s];r+=t(c)+t(e[c],n)}}if(o<16)return 1+r;if(o<65536)return 3+r;if(o<4294967296)return 5+r;throw new Error("Array or object too long 0x"+o.toString(16))}if("function"==i)return 0;throw new Error("Unknown type "+i)}(t,e);if(0!=n){n=new ArrayBuffer(n);return function t(e,n,i,o){var r=typeof e;if("string"==r){var s=f(e);if(s<32)return n.setUint8(i,160|s),p(n,i+1,e),1+s;if(s<256)return n.setUint8(i,217),n.setUint8(i+1,s),p(n,i+2,e),2+s;if(s<65536)return n.setUint8(i,218),n.setUint16(i+1,s),p(n,i+3,e),3+s;if(s<4294967296)return n.setUint8(i,219),n.setUint32(i+1,s),p(n,i+5,e),5+s}ArrayBuffer.isView&&ArrayBuffer.isView(e)&&(e=e.buffer);if(e instanceof ArrayBuffer){var s=e.byteLength;if(s<256)return n.setUint8(i,196),n.setUint8(i+1,s),new Uint8Array(n.buffer).set(new Uint8Array(e),i+2),2+s;if(s<65536)return n.setUint8(i,197),n.setUint16(i+1,s),new Uint8Array(n.buffer).set(new Uint8Array(e),i+3),3+s;if(s<4294967296)return n.setUint8(i,198),n.setUint32(i+1,s),new Uint8Array(n.buffer).set(new Uint8Array(e),i+5),5+s}if("number"==r){if(Math.floor(e)!==e)return n.setUint8(i,203),n.setFloat64(i+1,e),9;if(0<=e){if(e<128)return n.setUint8(i,e),1;if(e<256)return n.setUint8(i,204),n.setUint8(i+1,e),2;if(e<65536)return n.setUint8(i,205),n.setUint16(i+1,e),3;if(e<4294967296)return n.setUint8(i,206),n.setUint32(i+1,e),5;if(e<0x10000000000000000)return n.setUint8(i,207),g(n,i+1,e),9;throw new Error("Number too big 0x"+e.toString(16))}if(-32<=e)return n.setInt8(i,e),1;if(-128<=e)return n.setUint8(i,208),n.setInt8(i+1,e),2;if(-32768<=e)return n.setUint8(i,209),n.setInt16(i+1,e),3;if(-2147483648<=e)return n.setUint8(i,210),n.setInt32(i+1,e),5;if(-0x8000000000000000<=e)return n.setUint8(i,211),d(n,i+1,e),9;throw new Error("Number too small -0x"+(-e).toString(16).substr(1))}if("undefined"==r)return o?0:(n.setUint8(i,212),n.setUint8(i+1,0),n.setUint8(i+2,0),3);if(null===e)return o?0:(n.setUint8(i,192),1);if("boolean"==r)return n.setUint8(i,e?195:194),1;if("function"==typeof e.toJSON)return t(e.toJSON(),n,i,o);if("object"==r){var a,c=0,u=Array.isArray(e);if((s=u?e.length:(a=m(e,o)).length)<16?(n.setUint8(i,s|(u?144:128)),c=1):s<65536?(n.setUint8(i,u?220:222),n.setUint16(i+1,s),c=3):s<4294967296&&(n.setUint8(i,u?221:223),n.setUint32(i+1,s),c=5),u)for(var h=0;h<s;h++)c+=t(e[h],n,i+c,o);else for(var h=0;h<s;h++){var l=a[h];c+=t(l,n,i+c),c+=t(e[l],n,i+c,o)}return c}if("function"==r)return 0;throw new Error("Unknown type "+r)}(t,new DataView(n),0,e),n}},t.decode=function(t){var e=new o(new DataView(t)),n=e.parse();if(e.offset!==t.byteLength)throw new Error(t.byteLength-e.offset+" trailing bytes");return n};var r=4294967296,i=1/r;function d(t,e,n){n<0x8000000000000000?(t.setInt32(e,Math.floor(n*i)),t.setInt32(e+4,-1&n)):(t.setUint32(e,2147483647),t.setUint32(e+4,2147483647))}function g(t,e,n){n<0x10000000000000000?(t.setUint32(e,Math.floor(n*i)),t.setInt32(e+4,-1&n)):(t.setUint32(e,4294967295),t.setUint32(e+4,4294967295))}function o(t,e){this.offset=e||0,this.view=t}function m(e,n){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(t);return i.filter(function(t){t=e[t];return!(n&&null==t||"function"==typeof t&&!t.toJSON)})}return o.prototype.map=function(t){for(var e={},n=0;n<t;n++)e[this.parse()]=this.parse();return e},o.prototype.bin=o.prototype.buf=function(t){var e=new ArrayBuffer(t);return new Uint8Array(e).set(new Uint8Array(this.view.buffer,this.offset,t),0),this.offset+=t,e},o.prototype.str=function(t){var e=n(this.view,this.offset,t);return this.offset+=t,e},o.prototype.array=function(t){for(var e=new Array(t),n=0;n<t;n++)e[n]=this.parse();return e},o.prototype.ext=function(t){var e={};return e.type=this.view.getInt8(this.offset),this.offset++,e.data=this.buf(t),this.offset+=t,e},o.prototype.parse=function(){var t,e,n,i,o=this.view.getUint8(this.offset);if(0==(128&o))return this.offset++,o;if(128==(240&o))return e=15&o,this.offset++,this.map(e);if(144==(240&o))return e=15&o,this.offset++,this.array(e);if(160==(224&o))return e=31&o,this.offset++,this.str(e);if(224==(224&o))return t=this.view.getInt8(this.offset),this.offset++,t;switch(o){case 192:return this.offset++,null;case 193:return void this.offset++;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return e=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(e);case 197:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(e);case 198:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(e);case 199:return e=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(e);case 200:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(e);case 201:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(e);case 202:return t=this.view.getFloat32(this.offset+1),this.offset+=5,t;case 203:return t=this.view.getFloat64(this.offset+1),this.offset+=9,t;case 204:return t=this.view.getUint8(this.offset+1),this.offset+=2,t;case 205:return t=this.view.getUint16(this.offset+1),this.offset+=3,t;case 206:return t=this.view.getUint32(this.offset+1),this.offset+=5,t;case 207:return n=this.view,i=(i=this.offset+1)||0,t=n.getUint32(i)*r+n.getUint32(i+4),this.offset+=9,t;case 208:return t=this.view.getInt8(this.offset+1),this.offset+=2,t;case 209:return t=this.view.getInt16(this.offset+1),this.offset+=3,t;case 210:return t=this.view.getInt32(this.offset+1),this.offset+=5,t;case 211:return n=this.view,i=(i=this.offset+1)||0,t=n.getInt32(i)*r+n.getUint32(i+4),this.offset+=9,t;case 212:return e=1,this.offset++,this.ext(e);case 213:return e=2,this.offset++,this.ext(e);case 214:return e=4,this.offset++,this.ext(e);case 215:return e=8,this.offset++,this.ext(e);case 216:return e=16,this.offset++,this.ext(e);case 217:return e=this.view.getUint8(this.offset+1),this.offset+=2,this.str(e);case 218:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.str(e);case 219:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.str(e);case 220:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.array(e);case 221:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.array(e);case 222:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.map(e);case 223:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.map(e)}throw new Error("Unknown type 0x"+o.toString(16))},t}();e.a=i},function(t,E,x){"use strict";(function(e){var n,r,c,o,h,u,i,s,l=x(8),p=x(1),f=x(34),a=x(5),d=x(3),g=x(7),m=x(26),y=x(0),v=x(21),O=x(13),R=x(2),A=x(14),b=x(6),C=x(9),w=x(22),S=x(23),_=x(16),t=x(41),I=x(40),t=(n=!(void 0===_.a||!_.a.get),r=!(void 0===_.a||!_.a.getSession),c=l.a.Action,o=f.a.PendingMessage,h=a.a.transportPreferenceOrder,u=h[h.length-1],i="ably-transport-preference",s="ably-connection-recovery",T.prototype.getConnectParams=function(t){var e=t?p.a.copy(t):{},n=this.options;switch(this.mode){case"upgrade":e.upgrade=this.connectionKey;break;case"resume":e.resume=this.connectionKey,void 0!==this.timeSerial?e.timeSerial=this.timeSerial:void 0!==this.connectionSerial&&(e.connectionSerial=this.connectionSerial);break;case"recover":t=n.recover.split(":");t&&(e.recover=t[0],t=t[1],isNaN(t)?e.timeSerial=t:e.connectionSerial=t)}return void 0!==n.clientId&&(e.clientId=n.clientId),!1===n.echoMessages&&(e.echo="false"),void 0!==this.format&&(e.format=this.format),void 0!==this.stream&&(e.stream=this.stream),void 0!==this.heartbeats&&(e.heartbeats=this.heartbeats),e.v=a.a.apiVersion,e.lib=a.a.libstring,void 0!==n.transportParams&&p.a.mixin(e,n.transportParams),e},T.prototype.toString=function(){var t="[mode="+this.mode;return this.host&&(t+=",host="+this.host),this.connectionKey&&(t+=",connectionKey="+this.connectionKey),void 0!==this.connectionSerial&&(t+=",connectionSerial="+this.connectionSerial),this.timeSerial&&(t+=",timeSerial="+this.timeSerial),this.format&&(t+=",format="+this.format),t+="]"},p.a.inherits(k,g.a),k.supportedTransports={},Object(I.a)(k),p.a.arrForEach(t.a,function(t){t(k)}),k.prototype.createTransportParams=function(t,e){e=new T(this.options,t,e,this.connectionKey);return this.timeSerial?e.timeSerial=this.timeSerial:void 0!==this.connectionSerial&&(e.connectionSerial=this.connectionSerial),e},k.prototype.getTransportParams=function(n){var i=this;!function(e){if(i.connectionKey)e("resume");else if("string"!=typeof i.options.recover){var t=i.options.recover,n=r&&_.a.getSession(s);if(n&&"function"==typeof t)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data"),t(n,function(t){t?(i.options.recover=n.recoveryKey,e("recover")):e("clean")});e("clean")}else e("recover")}(function(t){var e=i.createTransportParams(null,t);"recover"===t?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+i.options.recover),(t=i.options.recover.split(":"))&&t[2]&&(i.msgSerial=t[2])):y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+e.toString()),n(e)})},k.prototype.tryATransport=function(i,o,r){var s=this;i.host;y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+o),k.supportedTransports[o].tryConnect(this,this.realtime.auth,i,function(t,e){var n=s.state;return n==s.states.closing||n==s.states.closed||n==s.states.failed?(e&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+n.state+" while we were attempting the transport; closing "+e),e.close()),void r(!0)):t?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+o+" "+t.event+", err: "+t.error.toString()),void(!A.a.isTokenErr(t.error)||s.errorReason&&A.a.isTokenErr(s.errorReason)?"failed"===t.event?(s.notifyState({state:"failed",error:t.error}),r(!0)):"disconnected"===t.event&&r(!1):(s.errorReason=t.error,s.realtime.auth._forceNewToken(null,null,function(t){t?s.actOnErrorFromAuthorize(t):s.tryATransport(i,o,r)})))):(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+o+"; setting pending"),s.setTransportPending(e,i),void r(null,e))})},k.prototype.setTransportPending=function(o,r){var s=r.mode;y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+o+"; mode = "+s),p.a.arrDeleteValue(this.proposedTransports,o),this.pendingTransports.push(o);var a=this;o.once("connected",function(t,e,n,i){"upgrade"==s&&a.activeProtocol?o.shortName!==u&&p.a.arrIn(a.getUpgradePossibilities(),u)?setTimeout(function(){a.scheduleTransportActivation(t,o,e,n,i)},a.options.timeouts.parallelUpgradeDelay):a.scheduleTransportActivation(t,o,e,n,i):(a.activateTransport(t,o,e,n,i),p.a.nextTick(function(){a.connectImpl(r)})),"recover"===s&&a.options.recover&&(a.options.recover=null,a.unpersistConnection())}),o.on(["disconnected","closed","failed"],function(t){a.deactivateTransport(o,this.event,t)}),this.emit("transport.pending",o)},k.prototype.scheduleTransportActivation=function(o,r,n,s,a){function c(){r.disconnect(),p.a.arrDeleteValue(u.pendingTransports,r)}var t,e,u=this,i=this.activeProtocol&&this.activeProtocol.getTransport();return this.state!==this.states.connected&&this.state!==this.states.connecting?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+this.state.state+(this.state===this.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+r.shortName),void c()):!i||(t=r,e=i,p.a.arrIndexOf(h,t.shortName)>p.a.arrIndexOf(h,e.shortName))?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Scheduling transport upgrade; transport = "+r),void this.realtime.channels.onceNopending(function(t){var i;if(t)y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unable to activate transport; transport = "+r+"; err = "+t);else{if(!r.isConnected)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+r.shortName+"is no longer connected; abandoning upgrade"),void c();if(u.state===u.states.connected)y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Currently connected, so temporarily pausing events until the upgrade is complete"),u.state=u.states.synchronizing,i=u.activeProtocol;else if(u.state!==u.states.connecting)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+u.state.state+(u.state===u.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+r.shortName),void c();var e=n!==u.connectionId,t=e?a:u;e&&y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Upgrade resulted in new connectionId; resetting library connection position from "+(u.timeSerial||u.connectionSerial)+" to "+(t.timeSerial||t.connectionSerial)+"; upgrade error was "+o),y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Syncing transport; transport = "+r),u.sync(r,t,function(t,e,n){t?u.state===u.states.synchronizing&&(y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unexpected error attempting to sync transport; transport = "+r+"; err = "+t),u.disconnectAllTransports()):(t=function(){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Activating transport; transport = "+r),u.activateTransport(o,r,e,s,n),u.state===u.states.synchronizing?(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, sending queued messages on upgraded transport; transport = "+r),u.state=u.states.connected):y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, but state is now "+u.state.state+", so leaving unchanged"),u.state.sendEvents&&u.sendQueuedMessages()},i?i.onceIdle(t):t())})}})):(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+r.shortName+" is no better than current active transport "+i.shortName+" - abandoning upgrade"),void c())},k.prototype.activateTransport=function(t,i,e,n,o){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+i),t&&y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+t),e&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+e),n&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(n)),o&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.activateTransport()","serial =  "+(o.timeSerial||o.connectionSerial)),this.persistTransportPreference(i);var r=this.state,s=this.states.connected.state;if(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+r.state),r.state==this.states.closing.state||r.state==this.states.closed.state||r.state==this.states.failed.state)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),i.disconnect(),!1;if(p.a.arrDeleteValue(this.pendingTransports,i),!i.isConnected)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+i+" since it appears to no longer be connected"),!1;var a=this.activeProtocol;this.activeProtocol=new f.a(i),this.host=i.params.host;var c=n.connectionKey;c&&this.connectionKey!=c&&this.setConnection(e,n,o,!!t),this.onConnectionDetailsUpdate(n,i);var u=this;return p.a.nextTick(function(){i.on("connected",function(t,e,n){u.onConnectionDetailsUpdate(n,i),u.emit("update",new v.a(s,s,null,t))})}),r.state===this.states.connected.state?t&&(this.errorReason=this.realtime.connection.errorReason=t,this.emit("update",new v.a(s,s,null,t))):(this.notifyState({state:"connected",error:t}),this.errorReason=this.realtime.connection.errorReason=t||null),this.emit("transport.active",i),a&&(0<a.messageQueue.count()&&y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+a.transport.shortName+", new one is "+i.shortName+") finishing with "+a.messageQueue.count()+" messages still pending"),a.transport===i?(t="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+i.shortName+"; stack = "+(new Error).stack,y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()",t),S.a.report("error",t,"transport-previously-active")):a.finish()),p.a.safeArrForEach(this.pendingTransports,function(t){var e;t===i?(e="Assumption violated: activating a transport that is still marked as a pending transport; transport = "+i.shortName+"; stack = "+(new Error).stack,y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()",e),S.a.report("error",e,"transport-activating-pending"),p.a.arrDeleteValue(u.pendingTransports,i)):t.disconnect()}),p.a.safeArrForEach(this.proposedTransports,function(t){var e;t===i?(e="Assumption violated: activating a transport that is still marked as a proposed transport; transport = "+i.shortName+"; stack = "+(new Error).stack,y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()",e),S.a.report("error",e,"transport-activating-proposed"),p.a.arrDeleteValue(u.proposedTransports,i)):t.dispose()}),!0},k.prototype.deactivateTransport=function(t,e,n){var i=this.activeProtocol,o=i&&i.getTransport()===t,r=p.a.arrDeleteValue(this.pendingTransports,t),s=p.a.arrDeleteValue(this.proposedTransports,t),a=this.noTransportsScheduledForActivation();if(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+t),y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+e+(o?"; was active":r?"; was pending":s?"; was proposed":"")+(a?"":"; another transport is scheduled for activation")),n&&n.message&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+n.message),o&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(i.getPendingMessages()),p.a.nextTick(function(){i.clearPendingMessages()}),this.activeProtocol=this.host=null,clearTimeout(this.channelResumeCheckTimer)),this.emit("transport.inactive",t),o&&a||o&&"failed"===e||"closed"===e||null===i&&r&&0===this.pendingTransports.length){if("disconnected"===e&&n&&500<n.statusCode&&1<this.httpHosts.length)return this.unpersistTransportPreference(),this.forceFallbackHost=!0,void this.notifyState({state:e,error:n,retryImmediately:!0});r="failed"===e&&A.a.isTokenErr(n)?"disconnected":e;this.notifyState({state:r,error:n})}else o&&"disconnected"===e&&this.state!==this.states.synchronizing&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.deactivateTransport()","wasActive but another transport is connected and scheduled for activation, so going into the connecting state until it activates"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),this.notifyState({state:"connecting",error:n}))},k.prototype.noTransportsScheduledForActivation=function(){return p.a.isEmpty(this.pendingTransports)||this.pendingTransports.every(function(t){return!t.isConnected})},k.prototype.sync=function(t,e,n){var i=setTimeout(function(){t.off("sync"),n(new R.a("Timeout waiting for sync response",5e4,500))},this.options.timeouts.realtimeRequestTimeout),o=l.a.fromValues({action:c.SYNC,connectionKey:this.connectionKey});e.timeSerial?o.timeSerial=e.timeSerial:void 0!==e.connectionSerial&&(o.connectionSerial=e.connectionSerial),t.send(o),t.once("sync",function(t,e){clearTimeout(i),n(null,t,e)})},k.prototype.setConnection=function(t,e,n,i){var o=this,r=this.connectionid,s=r&&r!==t;(s||!r&&i)&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0),this.connectionId!==t?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),p.a.nextTick(function(){o.realtime.channels.reattach()})):this.options.checkChannelsOnResume&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.setConnection()","Same connectionId; checkChannelsOnResume is enabled"),clearTimeout(this.channelResumeCheckTimer),this.realtime.channels.resetAttachedMsgIndicators(),this.channelResumeCheckTimer=setTimeout(function(){o.realtime.channels.checkAttachedMsgIndicators(t)},3e4)),this.realtime.connection.id=this.connectionId=t,this.realtime.connection.key=this.connectionKey=e.connectionKey;r=s||!r;this.setConnectionSerial(n,r)},k.prototype.clearConnection=function(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.clearConnectionSerial(),this.msgSerial=0,this.unpersistConnection()},k.prototype.setConnectionSerial=function(t,e){var n=t.timeSerial,t=t.connectionSerial;if(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.setConnectionSerial()","Updating connection serial; serial = "+t+"; timeSerial = "+n+"; force = "+e+"; previous = "+this.connectionSerial),void 0!==n)return n<=this.timeSerial&&!e?(y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with timeSerial "+n+", but current timeSerial is "+this.timeSerial+"; assuming message is a duplicate and discarding it"),!0):(this.realtime.connection.timeSerial=this.timeSerial=n,void this.setRecoveryKey());if(void 0!==t){if(t<=this.connectionSerial&&!e)return y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with connectionSerial "+t+", but current connectionSerial is "+this.connectionSerial+"; assuming message is a duplicate and discarding it"),!0;this.realtime.connection.serial=this.connectionSerial=t,this.setRecoveryKey()}},k.prototype.clearConnectionSerial=function(){this.realtime.connection.serial=this.connectionSerial=void 0,this.realtime.connection.timeSerial=this.timeSerial=void 0,this.clearRecoveryKey()},k.prototype.setRecoveryKey=function(){this.realtime.connection.recoveryKey=this.connectionKey+":"+(this.timeSerial||this.connectionSerial)+":"+this.msgSerial},k.prototype.clearRecoveryKey=function(){this.realtime.connection.recoveryKey=null},k.prototype.checkConnectionStateFreshness=function(){var t;this.lastActivity&&this.connectionId&&((t=p.a.now()-this.lastActivity)>this.connectionStateTtl+this.maxIdleInterval&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+t+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended",this.states.connecting.queueEvents=!1))},k.prototype.persistConnection=function(){var t;!r||(t=this.realtime.connection.recoveryKey)&&(t={recoveryKey:t,disconnectedAt:p.a.now(),location:e.location,clientId:this.realtime.auth.clientId},this.connectionStateTtl,r&&_.a.setSession(s,t))},k.prototype.unpersistConnection=function(){r&&_.a.removeSession(s)},k.prototype.getError=function(){return this.errorReason||this.getStateError()},k.prototype.getStateError=function(){return O.a[this.state.state]},k.prototype.activeState=function(){return this.state.queueEvents||this.state.sendEvents},k.prototype.enactStateChange=function(t){var e="failed"===t.current?y.a.LOG_ERROR:y.a.LOG_MAJOR;y.a.logAction(e,"Connection state",t.current+(t.reason?"; reason: "+t.reason:"")),y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+t.current+"; reason = "+(t.reason&&t.reason.message));e=this.state=this.states[t.current];t.reason&&(this.errorReason=t.reason,this.realtime.connection.errorReason=t.reason),!e.terminal&&"suspended"!==e.state||this.clearConnection(),this.emit("connectionstate",t)},k.prototype.startTransitionTimer=function(t){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+t.state),this.transitionTimer&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer));var e=this;this.transitionTimer=setTimeout(function(){e.transitionTimer&&(e.transitionTimer=null,y.a.logAction(y.a.LOG_MINOR,"ConnectionManager "+t.state+" timer expired","requesting new state: "+t.failState),e.notifyState({state:t.failState}))},t.retryDelay)},k.prototype.cancelTransitionTimer=function(){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)},k.prototype.startSuspendTimer=function(){var t=this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){t.suspendTimer&&(t.suspendTimer=null,y.a.logAction(y.a.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),t.states.connecting.failState="suspended",t.states.connecting.queueEvents=!1,t.notifyState({state:"suspended"}))},this.connectionStateTtl))},k.prototype.checkSuspendTimer=function(t){"disconnected"!==t&&"suspended"!==t&&"connecting"!==t&&this.cancelSuspendTimer()},k.prototype.cancelSuspendTimer=function(){this.states.connecting.failState="disconnected",this.states.connecting.queueEvents=!0,this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)},k.prototype.startRetryTimer=function(t){var e=this;this.retryTimer=setTimeout(function(){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),e.retryTimer=null,e.requestState({state:"connecting"})},t)},k.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},k.prototype.notifyState=function(t){var e,n,i,o=t.state,r=this,s="disconnected"===o&&(this.state===this.states.connected||this.state===this.states.synchronizing||t.retryImmediately||this.state===this.states.connecting&&t.error&&A.a.isTokenErr(t.error)&&!(this.errorReason&&A.a.isTokenErr(this.errorReason)));y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+o+(s?"; will retry connection immediately":"")),o!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(t.state),this.state.terminal||(e=this.states[t.state],n=new v.a(this.state.state,e.state,e.retryDelay,t.error||O.a[e.state]),s?(i=function(){r.state===r.states.disconnected&&(r.lastAutoReconnectAttempt=p.a.now(),r.requestState({state:"connecting"}))},(t=this.lastAutoReconnectAttempt&&p.a.now()-this.lastAutoReconnectAttempt+1)&&t<1e3?(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+t+"ms ago, waiting another "+(1e3-t)+"ms before trying again"),setTimeout(i,1e3-t)):p.a.nextTick(i)):"disconnected"!==o&&"suspended"!==o||this.startRetryTimer(e.retryDelay),("disconnected"===o&&!s||"suspended"===o||e.terminal)&&p.a.nextTick(function(){r.disconnectAllTransports()}),"connected"!=o||this.activeProtocol||y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(n),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(o,n.reason),this.failQueuedMessages(n.reason))))},k.prototype.requestState=function(t){var e,n=t.state,i=this;y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+n+"; current state: "+this.state.state),n!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(n),"connecting"==n&&"connected"==this.state.state||"closing"==n&&"closed"==this.state.state||(e=this.states[n],e=new v.a(this.state.state,e.state,null,t.error||O.a[e.state]),this.enactStateChange(e),"connecting"==n&&p.a.nextTick(function(){i.startConnect()}),"closing"==n&&this.closeImpl()))},k.prototype.startConnect=function(){var t,e,n,i,o;this.state===this.states.connecting?(t=this.realtime.auth,n=++(e=this).connectCounter,i=function(){e.checkConnectionStateFreshness(),e.getTransportParams(function(t){n===e.connectCounter&&e.connectImpl(t,n)})},y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),"basic"===t.method?i():(o=function(t){n===e.connectCounter&&(t?e.actOnErrorFromAuthorize(t):i())},this.errorReason&&A.a.isTokenErr(this.errorReason)?t._forceNewToken(null,null,o):t._ensureValidAuthCredentials(!1,o))):y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state)},k.prototype.connectImpl=function(t,e){var n=this.state.state;n!==this.states.connecting.state&&n!==this.states.connected.state?y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect (or connected to upgrade), but was "+n):this.pendingTransports.length?y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectImpl()","Transports "+this.pendingTransports[0].toString()+" currently pending; taking no action"):n==this.states.connected.state?this.upgradeIfNeeded(t):1<this.transports.length&&this.getTransportPreference()?this.connectPreference(t):this.connectBase(t,e)},k.prototype.connectPreference=function(n){var t=this.getTransportPreference(),i=this,o=!1;p.a.arrIn(this.transports,t)||(this.unpersistTransportPreference(),this.connectImpl(n)),y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectPreference()","Trying to connect with stored transport preference "+t);var r=setTimeout(function(){o=!0,i.state.state!==i.states.connected.state&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectPreference()","Shortcircuit connection attempt with "+t+" failed; clearing preference and trying from scratch"),i.disconnectAllTransports(),i.unpersistTransportPreference()),i.connectImpl(n)},this.options.timeouts.preferenceConnectTimeout);n.host=i.httpHosts[0],i.tryATransport(n,t,function(t,e){clearTimeout(r),o&&e?(e.off(),e.disconnect(),p.a.arrDeleteValue(this.pendingTransports,e)):e||t||(i.unpersistTransportPreference(),i.connectImpl(n))})},k.prototype.connectBase=function(n,i){var o=this,r=function(t){o.notifyState({state:o.states.connecting.failState,error:t})},s=this.httpHosts.slice(),a=function(t,e){i===o.connectCounter&&(e||t||c())};y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectBase()","Trying to connect with base transport "+this.baseTransport);var t=s.shift();if(t){if(n.host=t,this.forceFallbackHost&&s.length)return this.forceFallbackHost=!1,void c();this.tryATransport(n,this.baseTransport,a)}else r(new R.a("Unable to connect (no available host)",80003,404));function c(){s.length?b.a.checkConnectivity(function(t,e){i===o.connectCounter&&(t?r(t):e?(n.host=p.a.arrPopRandomElement(s),o.tryATransport(n,o.baseTransport,a)):r(new R.a("Unable to connect (network unreachable)",80003,404)))}):r(new R.a("Unable to connect (and no more fallback hosts to try)",80003,404))}},k.prototype.getUpgradePossibilities=function(){var t=this.activeProtocol.getTransport().shortName,t=p.a.arrIndexOf(this.upgradeTransports,t);return this.upgradeTransports.slice(t+1)},k.prototype.upgradeIfNeeded=function(n){var t=this.getUpgradePossibilities(),i=this;y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.upgradeIfNeeded()","upgrade possibilities: "+p.a.inspect(t)),t.length&&p.a.arrForEach(t,function(t){var e=i.createTransportParams(n.host,"upgrade");i.tryATransport(e,t,M)})},k.prototype.closeImpl=function(){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),p.a.safeArrForEach(this.pendingTransports,function(t){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+t),t&&t.close()}),p.a.safeArrForEach(this.proposedTransports,function(t){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.closeImpl()","Disposing of proposed transport: "+t),t&&t.dispose()}),this.activeProtocol&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})},k.prototype.onAuthUpdated=function(e,n){var t,i=this;switch(this.state.state){case"connected":y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport"),(this.pendingTransports.length||this.proposedTransports.length)&&i.state!==i.states.synchronizing&&(this.disconnectAllTransports(!0),t=this.activeProtocol.getTransport().params,p.a.nextTick(function(){"connected"===i.state.state&&i.upgradeIfNeeded(t)})),this.activeProtocol.getTransport().onAuthUpdated(e);var o=l.a.fromValues({action:c.AUTH,auth:{accessToken:e.token}});this.send(o);var r=function(){i.off(s),n(null,e)},s=function(t){"failed"===t.current&&(i.off(r),i.off(s),n(t.reason||i.getStateError()))};this.once("connectiondetails",r),this.on("connectionstate",s);break;case"connecting":y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");var a=function(t){switch(t.current){case"connected":i.off(a),n(null,e);break;case"failed":case"closed":case"suspended":i.off(a),n(t.reason||i.getStateError())}};i.on("connectionstate",a),"connecting"===this.state.state?i.startConnect():i.requestState({state:"connecting"})}},k.prototype.disconnectAllTransports=function(t){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"+(t?" except the active transport":"")),this.connectCounter++,p.a.safeArrForEach(this.pendingTransports,function(t){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+t),t&&t.disconnect()}),this.pendingTransports=[],p.a.safeArrForEach(this.proposedTransports,function(t){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disposing of proposed transport: "+t),t&&t.dispose()}),this.proposedTransports=[],this.activeProtocol&&!t&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())},k.prototype.send=function(t,e,n){n=n||M;var i=this.state;if(i.sendEvents)return y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.send()","sending event"),void this.sendImpl(new o(t,n));if(!(e&&i.queueEvents||i.forceQueueEvents)){i="rejecting event, queueEvent was "+e+", state was "+i.state;return y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.send()",i),void n(this.errorReason||new R.a(i,9e4,400))}y.a.shouldLog(y.a.LOG_MICRO)&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+l.a.stringify(t)),this.queue(t,n)},k.prototype.sendImpl=function(t){var e=t.message;t.ackRequired&&!t.sendAttempted&&(e.msgSerial=this.msgSerial++,this.setRecoveryKey());try{this.activeProtocol.send(t)}catch(t){y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+t.stack)}},k.prototype.queue=function(t,e){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.queue()","queueing event");var n=this.queuedMessages.last(),i=this.options.maxMessageSize;n&&!n.sendAttempted&&function(t,e,n){if(t.channel===e.channel&&((i=t.action)===c.PRESENCE||i===c.MESSAGE)&&i===e.action){var i=i===c.PRESENCE?"presence":"messages",e=t[i].concat(e[i]);return n<C.a.getMessagesSize(e)?void 0:p.a.allSame(e,"clientId")&&(p.a.arrEvery(e,function(t){return!t.id})&&(t[i]=e,1))}}(n.message,t,i)?(n.merged||(n.callback=Object(w.a)([n.callback]),n.merged=!0),n.callback.push(e)):this.queuedMessages.push(new o(t,e))},k.prototype.sendQueuedMessages=function(){var t;for(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");t=this.queuedMessages.shift();)this.sendImpl(t)},k.prototype.queuePendingMessages=function(t){t&&t.length&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+t.length+" pending messages"),this.queuedMessages.prepend(t))},k.prototype.failQueuedMessages=function(t){var e=this.queuedMessages.count();0<e&&(y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+e+" queued messages, err = "+p.a.inspectError(t)),this.queuedMessages.completeAllMessages(t))},k.prototype.onChannelMessage=function(t,e){var n=this.activeProtocol&&e===this.activeProtocol.getTransport(),i=p.a.arrIn(this.pendingTransports,e)&&this.state==this.states.synchronizing,e=t.action===c.MESSAGE||t.action===c.PRESENCE;if(n||i){if(e){if(this.setConnectionSerial(t))return;if(l.a.isDuplicate(t,this.mostRecentMsg))return void y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.onChannelMessage()","received message with different connectionSerial, but same message id as a previous; discarding; id = "+t.id);this.mostRecentMsg=t}this.realtime.channels.onChannelMessage(t)}else-1<p.a.arrIndexOf([c.ACK,c.NACK,c.ERROR],t.action)?this.realtime.channels.onChannelMessage(t):y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.onChannelMessage()","received message "+JSON.stringify(t)+"on defunct transport; discarding")},k.prototype.ping=function(e,n){if(e){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.ping()","transport = "+e);var i=p.a.now(),o=p.a.cheapRandStr(),r=function(t){t===o&&(e.off("heartbeat",r),clearTimeout(s),t=p.a.now()-i,n(null,t))},s=setTimeout(function(){e.off("heartbeat",r),n(new R.a("Timeout waiting for heartbeat response",5e4,500))},this.options.timeouts.realtimeRequestTimeout);return e.on("heartbeat",r),void e.ping(o)}var a,c,u;"connected"===this.state.state?(a=!1,u=function(){a||(a=!0,p.a.nextTick(function(){c.ping(null,n)}))},(c=this).on("transport.active",u),this.ping(this.activeProtocol.getTransport(),function(t,e){c.off("transport.active",u),a||(a=!0,n(t,e))})):n(new R.a("Unable to ping service; not connected",4e4,400))},k.prototype.abort=function(t){this.activeProtocol.getTransport().fail(t)},k.prototype.registerProposedTransport=function(t){this.proposedTransports.push(t)},k.prototype.getTransportPreference=function(){return this.transportPreference||n&&_.a.get(i)},k.prototype.persistTransportPreference=function(t){p.a.arrIn(a.a.upgradeTransports,t.shortName)&&(this.transportPreference=t.shortName,n&&_.a.set(i,t.shortName))},k.prototype.unpersistTransportPreference=function(){this.transportPreference=null,n&&_.a.remove(i)},k.prototype.actOnErrorFromAuthorize=function(t){var e;40171===t.code?this.notifyState({state:"failed",error:t}):403===t.statusCode?(e="Client configured authentication provider returned 403; failing the connection",y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",e),this.notifyState({state:"failed",error:new R.a(e,80019,403,t)})):(e="Client configured authentication provider request failed",y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",e),this.notifyState({state:this.state.failState,error:new R.a(e,80019,401,t)}))},k.prototype.onConnectionDetailsUpdate=function(t,e){if(t){(this.connectionDetails=t).maxMessageSize&&(this.options.maxMessageSize=t.maxMessageSize);var n=t.clientId;if(n){var i=this.realtime.auth._uncheckedSetClientId(n);if(i)return y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",i.message),void e.fail(i)}i=t.connectionStateTtl;i&&(this.connectionStateTtl=i),this.maxIdleInterval=t.maxIdleInterval,this.emit("connectiondetails",t)}},k);function M(){}function T(t,e,n,i){this.options=t,this.host=e,this.mode=n,this.connectionKey=i,this.format=t.useBinaryProtocol?"msgpack":"json",this.connectionSerial=void 0,this.timeSerial=void 0}function k(t,e){g.a.call(this),this.realtime=t;var n=(this.options=e).timeouts,i=this,t=n.preferenceConnectTimeout+n.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:t,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},synchronizing:{state:"connected",terminal:!1,queueEvents:!0,sendEvents:!1,forceQueueEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:n.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:n.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:n.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new m.a,this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.timeSerial=void 0,this.connectionSerial=void 0,this.connectionStateTtl=n.connectionStateTtl,this.maxIdleInterval=null,this.transports=p.a.intersect(e.transports||a.a.defaultTransports,k.supportedTransports),this.baseTransport=p.a.intersect(a.a.baseTransportOrder,this.transports)[0],this.upgradeTransports=p.a.intersect(this.transports,a.a.upgradeTransports),this.transportPreference=null,this.httpHosts=a.a.getHosts(e),this.activeProtocol=null,this.proposedTransports=[],this.pendingTransports=[],this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.mostRecentMsg=null,this.forceFallbackHost=!1,this.connectCounter=0,y.a.logAction(y.a.LOG_MINOR,"Realtime.ConnectionManager()","started"),y.a.logAction(y.a.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(e.transports||a.a.defaultTransports)+"]"),y.a.logAction(y.a.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),y.a.logAction(y.a.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]"),!this.transports.length){var o="no requested transports available";throw y.a.logAction(y.a.LOG_ERROR,"realtime.ConnectionManager()",o),new Error(o)}o=d.a.addEventListener;o&&(r&&"function"==typeof e.recover&&o("beforeunload",this.persistConnection.bind(this)),!0===e.closeOnUnload&&o("beforeunload",function(){y.a.logAction(y.a.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),i.requestState({state:"closing"})}),o("online",function(){i.state!=i.states.disconnected&&i.state!=i.states.suspended||(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager caught browser ‘online’ event","reattempting connection"),i.requestState({state:"connecting"}))}),o("offline",function(){i.state==i.states.connected&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager caught browser ‘offline’ event","disconnecting active transport"),i.disconnectAllTransports())}))}E.a=t}).call(this,x(20))},function(t,e,n){"use strict";var i=n(1),o=n(7),a=n(0),i=(i.a.inherits(r,o.a),r.prototype.count=function(){return this.messages.length},r.prototype.push=function(t){this.messages.push(t)},r.prototype.shift=function(){return this.messages.shift()},r.prototype.last=function(){return this.messages[this.messages.length-1]},r.prototype.copyAll=function(){return this.messages.slice()},r.prototype.append=function(t){this.messages.push.apply(this.messages,t)},r.prototype.prepend=function(t){this.messages.unshift.apply(this.messages,t)},r.prototype.completeMessages=function(t,e,n){a.a.logAction(a.a.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+t+"; count = "+e),n=n||null;var i=this.messages,o=i[0];if(o){o=o.message.msgSerial,e=t+e;if(o<e)for(var r=i.splice(0,e-o),s=0;s<r.length;s++)r[s].callback(n);0==i.length&&this.emit("idle")}},r.prototype.completeAllMessages=function(t){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,t)},r.prototype.clear=function(){a.a.logAction(a.a.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")},r);function r(){o.a.call(this),this.messages=[]}e.a=i},function(t,n,s){"use strict";(function(t){var v=s(1),p=s(7),i=s(3),O=s(2),o=s(6),R=s(0),f=s(5),A=s(4),r=s(35),e=function(){function n(){}var a=0,c={};var e=void 0!==t&&t.XDomainRequest;function u(){var t;return e&&(t=(t=navigator.userAgent.toString().match(/MSIE\s([\d.]+)/))&&Number(t[1]))&&10===t}function h(t,e,n,i,o,r,s){p.a.call(this),(n=n||{}).rnd=v.a.cheapRandStr(),u()&&!n.envelope&&(n.envelope="json"),this.uri=t+v.a.toQueryString(n),this.headers=e||{},this.body=i,this.method=s?s.toUpperCase():v.a.isEmptyArg(i)?"GET":"POST",this.requestMode=o,this.timeouts=r,this.timedOut=!1,this.requestComplete=!1,c[this.id=String(++a)]=this}v.a.inherits(h,p.a);var l=h.createRequest=function(t,e,n,i,o,r,s){return r=r||f.a.TIMEOUTS,new h(t,e,v.a.copy(n),i,o,r,s)};return h.prototype.complete=function(t,e,n,i,o){this.requestComplete||(this.requestComplete=!0,!t&&e&&this.emit("data",e),this.emit("complete",t,e,n,i,o),this.dispose())},h.prototype.abort=function(){this.dispose()},h.prototype.exec=function(){var t,e=0==this.requestMode?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,r=this,n=this.timer=setTimeout(function(){r.timedOut=!0,a.abort()},e),i=this.body,o=this.method,s=this.headers,a=this.xhr=new XMLHttpRequest,c=s.accept,e="text";for(t in c?0===c.indexOf("application/x-msgpack")&&(e="arraybuffer"):s.accept="application/json",i&&-1<(s["content-type"]||(s["content-type"]="application/json")).indexOf("application/json")&&"string"!=typeof i&&(i=JSON.stringify(i)),a.open(o,this.uri,!0),a.responseType=e,"authorization"in s&&(a.withCredentials=!0),s)a.setRequestHeader(t,s[t]);function u(t,e,n,i){e=e+" (event type: "+t.type+")"+(r.xhr.statusText?", current statusText is "+r.xhr.statusText:""),R.a.logAction(R.a.LOG_ERROR,"Request.on"+t.type+"()",e),r.complete(new O.a(e,n,i))}a.onerror=function(t){u(t,"XHR error occurred",null,400)},a.onabort=function(t){r.timedOut?u(t,"Request aborted due to request timeout expiring",null,408):u(t,"Request cancelled",null,400)},a.ontimeout=function(t){u(t,"Request timed out",null,408)};var h,l,p,f,d=0,g=!1;function m(){try{var t,e,n=(n="content-type",(i=a).getResponseHeader&&i.getResponseHeader(n));(n?0<=n.indexOf("application/json"):"text"==a.responseType)?((e="arraybuffer"===a.responseType?A.a.utf8Decode(a.response):String(a.responseText)).length&&(e=JSON.parse(e)),g=!0):e=a.response,void 0!==e.response?(l=e.statusCode,f=l<400,t=e.headers,e=e.response):t=function(t){for(var e=v.a.trim(t.getAllResponseHeaders()).split("\r\n"),n={},i=0;i<e.length;i++){var o=v.a.arrMap(e[i].split(":"),v.a.trim);n[o[0].toLowerCase()]=o[1]}return n}(a)}catch(t){return void r.complete(new O.a("Malformed response body from server: "+t.message,null,400))}var i,n,o;f||v.a.isArray(e)?r.complete(null,e,t,g,l):(o=(o=e.error&&O.a.fromValues(e.error))||new O.a("Error response received from server: "+l+" body was: "+v.a.inspect(e),null,l),r.complete(o,e,t,g,l))}function y(){for(var t,e,n=(p=a.responseText).length-1;d<n&&-1<(t=p.indexOf("\n",d));)e=p.slice(d,t),d=t+1,function(t){try{t=JSON.parse(t)}catch(t){return r.complete(new O.a("Malformed response body from server: "+t.message,null,400))}r.emit("data",t)}(e)}a.onreadystatechange=function(){var t,e=a.readyState;e<3||0!==a.status&&(void 0===l&&(1223===(l=a.status)&&(l=204),clearTimeout(n),f=l<400,204!=l?h=3==r.requestMode&&f&&((t=a).getResponseHeader&&(t.getResponseHeader("transfer-encoding")||!t.getResponseHeader("content-length"))):r.complete(null,null,null,null,l)),3==e&&h?y():4==e&&(h?(y(),r.streamComplete=!0,v.a.nextTick(function(){r.complete()})):m()))},a.send(i)},h.prototype.dispose=function(){var t,e=this.xhr;e&&(e.onreadystatechange=e.onerror=e.onabort=e.ontimeout=n,this.xhr=null,(t=this.timer)&&(clearTimeout(t),this.timer=null),this.requestComplete||e.abort()),delete c[this.id]},i.a.xhrSupported&&("object"==typeof r.a&&r.a.addUnloadListener(function(){for(var t in c)c[t].dispose()}),void 0!==o.a&&(o.a.supportsAuthHeaders=!0,o.a.Request=function(t,e,n,i,o,r,s){t=l(n,i,o,r,0,e&&e.options.timeouts,t);return t.once("complete",s),t.exec(),t},o.a.checkConnectivity=function(n){var t=f.a.internetUpUrl;R.a.logAction(R.a.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+t),o.a.getUri(null,t,null,null,function(t,e){e=!t&&"yes"==e.replace(/\n/,"");R.a.logAction(R.a.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+e),n(null,e)})})),h}();n.a=e}).call(this,s(20))},function(t,e,n){t.exports=(t=n(12),n(10),n(43),n(17),n(37),n(36),n(29),n(30),n(31),n(44),n(45),t)},function(t,e,n){var i;t.exports=(i=n(12),void function(){var t=i.lib.Base,a=i.enc.Utf8;i.algo.HMAC=t.extend({init:function(t,e){t=this._hasher=new t.init,"string"==typeof e&&(e=a.parse(e));var n=t.blockSize,i=4*n;e.sigBytes>i&&(e=t.finalize(e)),e.clamp();for(var t=this._oKey=e.clone(),e=this._iKey=e.clone(),o=t.words,r=e.words,s=0;s<n;s++)o[s]^=1549556828,r[s]^=909522486;t.sigBytes=e.sigBytes=i,this.reset()},reset:function(){var t=this._hasher;t.reset(),t.update(this._iKey)},update:function(t){return this._hasher.update(t),this},finalize:function(t){var e=this._hasher,t=e.finalize(t);return e.reset(),e.finalize(this._oKey.clone().concat(t))}})}())},function(t,e,n){var r;t.exports=(r=n(12),n(37),n(29),function(){var t=r,e=t.lib,n=e.Base,h=e.WordArray,i=t.algo,e=i.MD5,o=i.EvpKDF=n.extend({cfg:n.extend({keySize:4,hasher:e,iterations:1}),init:function(t){this.cfg=this.cfg.extend(t)},compute:function(t,e){for(var n,i=this.cfg,o=i.hasher.create(),r=h.create(),s=r.words,a=i.keySize,c=i.iterations;s.length<a;){n&&o.update(n),n=o.update(t).finalize(e),o.reset();for(var u=1;u<c;u++)n=o.finalize(n),o.reset();r.concat(n)}return r.sigBytes=4*a,r}});t.EvpKDF=function(t,e,n){return o.create(n).compute(t,e)}}(),r.EvpKDF)},function(t,e,n){var g;t.exports=(g=n(12),n(30),void(g.lib.Cipher||function(){var t=g,e=t.lib,n=e.Base,s=e.WordArray,i=e.BufferedBlockAlgorithm,o=t.enc,r=(o.Utf8,o.Base64),a=t.algo.EvpKDF,c=e.Cipher=i.extend({cfg:n.extend(),createEncryptor:function(t,e){return this.create(this._ENC_XFORM_MODE,t,e)},createDecryptor:function(t,e){return this.create(this._DEC_XFORM_MODE,t,e)},init:function(t,e,n){this.cfg=this.cfg.extend(n),this._xformMode=t,this._key=e,this.reset()},reset:function(){i.reset.call(this),this._doReset()},process:function(t){return this._append(t),this._process()},finalize:function(t){return t&&this._append(t),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(i){return{encrypt:function(t,e,n){return u(e).encrypt(i,t,e,n)},decrypt:function(t,e,n){return u(e).decrypt(i,t,e,n)}}}});function u(t){return"string"==typeof t?d:f}e.StreamCipher=c.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var h=t.mode={},o=e.BlockCipherMode=n.extend({createEncryptor:function(t,e){return this.Encryptor.create(t,e)},createDecryptor:function(t,e){return this.Decryptor.create(t,e)},init:function(t,e){this._cipher=t,this._iv=e}}),o=h.CBC=((h=o.extend()).Encryptor=h.extend({processBlock:function(t,e){var n=this._cipher,i=n.blockSize;l.call(this,t,e,i),n.encryptBlock(t,e),this._prevBlock=t.slice(e,e+i)}}),h.Decryptor=h.extend({processBlock:function(t,e){var n=this._cipher,i=n.blockSize,o=t.slice(e,e+i);n.decryptBlock(t,e),l.call(this,t,e,i),this._prevBlock=o}}),h);function l(t,e,n){var i,o=this._iv;o?(i=o,this._iv=void 0):i=this._prevBlock;for(var r=0;r<n;r++)t[e+r]^=i[r]}var h=(t.pad={}).Pkcs7={pad:function(t,e){for(var e=4*e,n=e-t.sigBytes%e,i=n<<24|n<<16|n<<8|n,o=[],r=0;r<n;r+=4)o.push(i);e=s.create(o,n);t.concat(e)},unpad:function(t){var e=255&t.words[t.sigBytes-1>>>2];t.sigBytes-=e}},p=(e.BlockCipher=c.extend({cfg:c.cfg.extend({mode:o,padding:h}),reset:function(){var t;c.reset.call(this);var e=this.cfg,n=e.iv,e=e.mode;this._xformMode==this._ENC_XFORM_MODE?t=e.createEncryptor:(t=e.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==t?this._mode.init(this,n&&n.words):(this._mode=t.call(e,this,n&&n.words),this._mode.__creator=t)},_doProcessBlock:function(t,e){this._mode.processBlock(t,e)},_doFinalize:function(){var t,e=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(e.pad(this._data,this.blockSize),t=this._process(!0)):(t=this._process(!0),e.unpad(t)),t},blockSize:4}),e.CipherParams=n.extend({init:function(t){this.mixIn(t)},toString:function(t){return(t||this.formatter).stringify(this)}})),h=(t.format={}).OpenSSL={stringify:function(t){var e=t.ciphertext,t=t.salt,e=t?s.create([1398893684,1701076831]).concat(t).concat(e):e;return e.toString(r)},parse:function(t){var e,n=r.parse(t),t=n.words;return 1398893684==t[0]&&1701076831==t[1]&&(e=s.create(t.slice(2,4)),t.splice(0,4),n.sigBytes-=16),p.create({ciphertext:n,salt:e})}},f=e.SerializableCipher=n.extend({cfg:n.extend({format:h}),encrypt:function(t,e,n,i){i=this.cfg.extend(i);var o=t.createEncryptor(n,i),e=o.finalize(e),o=o.cfg;return p.create({ciphertext:e,key:n,iv:o.iv,algorithm:t,mode:o.mode,padding:o.padding,blockSize:t.blockSize,formatter:i.format})},decrypt:function(t,e,n,i){return i=this.cfg.extend(i),e=this._parse(e,i.format),t.createDecryptor(n,i).finalize(e.ciphertext)},_parse:function(t,e){return"string"==typeof t?e.parse(t,this):t}}),t=(t.kdf={}).OpenSSL={execute:function(t,e,n,i){i=i||s.random(8);t=a.create({keySize:e+n}).compute(t,i),n=s.create(t.words.slice(e),4*n);return t.sigBytes=4*e,p.create({key:t,iv:n,salt:i})}},d=e.PasswordBasedCipher=f.extend({cfg:f.cfg.extend({kdf:t}),encrypt:function(t,e,n,i){n=(i=this.cfg.extend(i)).kdf.execute(n,t.keySize,t.ivSize);i.iv=n.iv;i=f.encrypt.call(this,t,e,n.key,i);return i.mixIn(n),i},decrypt:function(t,e,n,i){i=this.cfg.extend(i),e=this._parse(e,i.format);n=i.kdf.execute(n,t.keySize,t.ivSize,e.salt);return i.iv=n.iv,f.decrypt.call(this,t,e,n.key,i)}})}()))},function(t,e,n){t.exports=n(12).enc.Hex},function(t,e,n){t.exports=n(12).enc.Utf8},function(t,e,n){"use strict";var i,o=n(8),r=n(1),s=n(7),a=n(0),c=n(26),u=n(2),n=(i=o.a.Action,r.a.inherits(h,s.a),h.prototype.onAck=function(t,e){a.a.logAction(a.a.LOG_MICRO,"Protocol.onAck()","serial = "+t+"; count = "+e),this.messageQueue.completeMessages(t,e)},h.prototype.onNack=function(t,e,n){a.a.logAction(a.a.LOG_ERROR,"Protocol.onNack()","serial = "+t+"; count = "+e+"; err = "+r.a.inspectError(n)),n=n||new u.a("Unable to send message; channel not responding",50001,500),this.messageQueue.completeMessages(t,e,n)},h.prototype.onceIdle=function(t){var e=this.messageQueue;0!==e.count()?e.once("idle",t):t()},h.prototype.send=function(t){t.ackRequired&&this.messageQueue.push(t),a.a.shouldLog(a.a.LOG_MICRO)&&a.a.logAction(a.a.LOG_MICRO,"Protocol.send()","sending msg; "+o.a.stringify(t.message)),t.sendAttempted=!0,this.transport.send(t.message)},h.prototype.getTransport=function(){return this.transport},h.prototype.getPendingMessages=function(){return this.messageQueue.copyAll()},h.prototype.clearPendingMessages=function(){return this.messageQueue.clear()},h.prototype.finish=function(){var t=this.transport;this.onceIdle(function(){t.disconnect()})},h.PendingMessage=function(t,e){this.message=t,this.callback=e,this.merged=!1,t=t.action,this.sendAttempted=!1,this.ackRequired=t==i.MESSAGE||t==i.PRESENCE},h);function h(t){s.a.call(this),this.transport=t,this.messageQueue=new c.a;var i=this;t.on("ack",function(t,e){i.onAck(t,e)}),t.on("nack",function(t,e,n){i.onNack(t,e,n)})}e.a=n},function(t,i,e){"use strict";(function(e){var t=(n.addListener=function(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent("on"+e,function(){n.apply(t,arguments)})},n.removeListener=function(t,e,n){t.removeEventListener?t.removeEventListener(e,n,!1):t.detachEvent("on"+e,function(){n.apply(t,arguments)})},n.addMessageListener=function(t,e){n.addListener(t,"message",e)},n.removeMessageListener=function(t,e){n.removeListener(t,"message",e)},n.addUnloadListener=function(t){n.addListener(e,"unload",t)},n);function n(){}i.a=t}).call(this,e(20))},function(t,e,n){var s;t.exports=(s=n(12),function(o){var t=s,e=t.lib,n=e.WordArray,i=e.Hasher,e=t.algo,r=[],g=[];!function(){function t(t){return 4294967296*(t-(0|t))|0}for(var e=2,n=0;n<64;)!function(t){for(var e=o.sqrt(t),n=2;n<=e;n++)if(!(t%n))return;return 1}(e)||(n<8&&(r[n]=t(o.pow(e,.5))),g[n]=t(o.pow(e,1/3)),n++),e++}();var m=[],e=e.SHA256=i.extend({_doReset:function(){this._hash=new n.init(r.slice(0))},_doProcessBlock:function(t,e){for(var n=this._hash.words,i=n[0],o=n[1],r=n[2],s=n[3],a=n[4],c=n[5],u=n[6],h=n[7],l=0;l<64;l++){l<16?m[l]=0|t[e+l]:(f=((d=m[l-15])<<25|d>>>7)^(d<<14|d>>>18)^d>>>3,d=((p=m[l-2])<<15|p>>>17)^(p<<13|p>>>19)^p>>>10,m[l]=f+m[l-7]+d+m[l-16]);var p=i&o^i&r^o&r,f=(i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22),d=h+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&c^~a&u)+g[l]+m[l],h=u,u=c,c=a,a=s+d|0,s=r,r=o,o=i,i=d+(f+p)|0}n[0]=n[0]+i|0,n[1]=n[1]+o|0,n[2]=n[2]+r|0,n[3]=n[3]+s|0,n[4]=n[4]+a|0,n[5]=n[5]+c|0,n[6]=n[6]+u|0,n[7]=n[7]+h|0},_doFinalize:function(){var t=this._data,e=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;return e[i>>>5]|=128<<24-i%32,e[14+(64+i>>>9<<4)]=o.floor(n/4294967296),e[15+(64+i>>>9<<4)]=n,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=i.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA256=i._createHelper(e),t.HmacSHA256=i._createHmacHelper(e)}(Math),s.SHA256)},function(t,e,n){var o;t.exports=(o=n(12),function(){var t=o,e=t.lib,n=e.WordArray,i=e.Hasher,e=t.algo,h=[],e=e.SHA1=i.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var n=this._hash.words,i=n[0],o=n[1],r=n[2],s=n[3],a=n[4],c=0;c<80;c++){c<16?h[c]=0|t[e+c]:(u=h[c-3]^h[c-8]^h[c-14]^h[c-16],h[c]=u<<1|u>>>31);var u=(i<<5|i>>>27)+a+h[c];u+=c<20?1518500249+(o&r|~o&s):c<40?1859775393+(o^r^s):c<60?(o&r|o&s|r&s)-1894007588:(o^r^s)-899497514,a=s,s=r,r=o<<30|o>>>2,o=i,i=u}n[0]=n[0]+i|0,n[1]=n[1]+o|0,n[2]=n[2]+r|0,n[3]=n[3]+s|0,n[4]=n[4]+a|0},_doFinalize:function(){var t=this._data,e=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;return e[i>>>5]|=128<<24-i%32,e[14+(64+i>>>9<<4)]=Math.floor(n/4294967296),e[15+(64+i>>>9<<4)]=n,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=i.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA1=i._createHelper(e),t.HmacSHA1=i._createHmacHelper(e)}(),o.SHA1)},function(t,e,n){t.exports=(t=n(12),n(36),n(29),t.HmacSHA256)},function(t,e,o){"use strict";(function(n){var p=o(1),f=o(15),i=o(3),d=o(7),r=o(6),g=o(2),m=o(5),y=o(0);e.a=function(t){function e(){}var s=n._ablyjs_jsonp={};s._=function(t){return s["_"+t]||e};var c=1,a=null;function u(t,e,n){n.stream=!1,f.a.call(this,t,e,n),this.shortName="jsonp"}p.a.inherits(u,f.a),(u.isAvailable=function(){return i.a.jsonpSupported&&i.a.allowComet})()&&(t.supportedTransports.jsonp=u),i.a.jsonpSupported&&(a=document.getElementsByTagName("head")[0]);var o=null;(n.JSONPTransport=u).tryConnect=function(t,e,n,i){function o(t){i({event:this.event,error:t})}var r=new u(t,e,n);r.on(["failed","disconnected"],o),r.on("preconnect",function(){y.a.logAction(y.a.LOG_MINOR,"JSONPTransport.tryConnect()","viable transport "+r),r.off(["failed","disconnected"],o),i(null,r)}),r.connect()},u.prototype.toString=function(){return"JSONPTransport; uri="+this.baseUri+"; isConnected="+this.isConnected};var h=u.prototype.createRequest=function(t,e,n,i,o,r,s){return r=this&&this.timeouts||r||m.a.TIMEOUTS,new l(void 0,t,e,p.a.copy(n),i,o,r,s)};function l(t,e,n,i,o,r,s,a){d.a.call(this),void 0===t&&(t=c++),this.id=t,this.uri=e,this.params=i||{},this.params.rnd=p.a.cheapRandStr(),n&&(n["X-Ably-Version"]&&(this.params.v=n["X-Ably-Version"]),n["X-Ably-Lib"]&&(this.params.lib=n["X-Ably-Lib"])),this.body=o,this.method=a,this.requestMode=r,this.timeouts=s,this.requestComplete=!1}return p.a.inherits(l,d.a),l.prototype.exec=function(){var t=this.id,e=this.body,n=this.method,i=this.uri,o=this.params,r=this;o.callback="_ablyjs_jsonp._("+t+")",o.envelope="jsonp",e&&(o.body=e),n&&"get"!==n&&(o.method=n);n=this.script=document.createElement("script"),o=i+p.a.toQueryString(o);n.src=o,n.src.split("/").slice(-1)[0]!==o.split("/").slice(-1)[0]&&y.a.logAction(y.a.LOG_ERROR,"JSONP Request.exec()","Warning: the browser appears to have truncated the script URI. This will likely result in the request failing due to an unparseable body param"),n.async=!0,n.type="text/javascript",n.charset="UTF-8",n.onerror=function(t){r.complete(new g.a("JSONP script error (event: "+p.a.inspect(t)+")",null,400))},s["_"+t]=function(t){var e;t.statusCode?(e=t.response,204==t.statusCode?r.complete(null,null,null,t.statusCode):e?t.statusCode<400||p.a.isArray(e)?r.complete(null,e,t.headers,t.statusCode):(e=e.error||new g.a("Error response received from server",null,t.statusCode),r.complete(e)):r.complete(new g.a("Invalid server response: no envelope detected",null,500))):r.complete(null,t)};t=this.requestMode==f.a.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout;this.timer=setTimeout(function(){r.abort()},t),a.insertBefore(n,a.firstChild)},l.prototype.complete=function(t,e,n,i){var o;n=n||{},this.requestComplete||(this.requestComplete=!0,e&&(o="string"==typeof e?"text/plain":"application/json",n["content-type"]=o,this.emit("data",e)),this.emit("complete",t,e,n,!0,i),this.dispose())},l.prototype.abort=function(){this.dispose()},l.prototype.dispose=function(){var t=this.timer;t&&(clearTimeout(t),this.timer=null);t=this.script;t.parentNode&&t.parentNode.removeChild(t),delete s[this.id],this.emit("disposed")},i.a.jsonpSupported&&!r.a.Request&&(r.a.Request=function(t,e,n,i,o,r,s){var a=h(n,i,o,r,f.a.REQ_SEND,e&&e.options.timeouts,t);return a.once("complete",s),p.a.nextTick(function(){a.exec()}),a},r.a.checkConnectivity=function(t){var e,n=m.a.jsonpInternetUpUrl;o?o.push(t):(o=[t],y.a.logAction(y.a.LOG_MICRO,"(JSONP)Http.checkConnectivity()","Sending; "+n),(e=new l("isTheInternetUp",n,null,null,null,f.a.REQ_SEND,m.a.TIMEOUTS)).once("complete",function(t,e){var n=!t&&e;y.a.logAction(y.a.LOG_MICRO,"(JSONP)Http.checkConnectivity()","Result: "+n);for(var i=0;i<o.length;i++)o[i](null,n);o=null}),p.a.nextTick(function(){e.exec()}))}),u}}).call(this,o(20))},function(t,e,n){"use strict";var u=n(3),r=n(1),h=n(19),l=n(5),p=n(0),a=n(8),c=n(2);e.a=function(t){var o=u.a.WebSocket,i="web_socket";function s(t,e,n){this.shortName=i,n.heartbeats=u.a.useProtocolHeartbeats,h.a.call(this,t,e,n),this.wsHost=l.a.getHost(n.options,n.host,!0)}return r.a.inherits(s,h.a),(s.isAvailable=function(){return!!o})()&&(t.supportedTransports[i]=s),s.tryConnect=function(t,e,n,i){function o(t){i({event:this.event,error:t})}var r=new s(t,e,n);r.on(["failed","disconnected"],o),r.on("wsopen",function(){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.tryConnect()","viable transport "+r),r.off(["failed","disconnected"],o),i(null,r)}),r.connect()},s.prototype.createWebSocket=function(t,e){var n=0;if(e)for(var i in e)t+=(n++?"&":"?")+i+"="+e[i];return this.uri=t,new o(t)},s.prototype.toString=function(){return"WebSocketTransport; uri="+this.uri},s.prototype.connect=function(){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.connect()","starting"),h.a.prototype.connect.call(this);var s=this,a=this.params,t=a.options,c=(t.tls?"wss://":"ws://")+this.wsHost+":"+l.a.getPort(t)+"/";p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.connect()","uri: "+c),this.auth.getAuthParams(function(t,e){if(!s.isDisposed){var n,i="";for(n in e)i+=" "+n+": "+e[n]+";";if(p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+i+" err: "+t),t)s.disconnect(t);else{var o=a.getConnectParams(e);try{var r=s.wsConnection=s.createWebSocket(c,o);r.binaryType=u.a.binaryType,r.onopen=function(){s.onWsOpen()},r.onclose=function(t){s.onWsClose(t)},r.onmessage=function(t){s.onWsData(t.data)},r.onerror=function(t){s.onWsError(t)},r.on&&r.on("ping",function(){s.onActivity()})}catch(t){p.a.logAction(p.a.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(t.stack||t.message)),s.disconnect(t)}}}})},s.prototype.send=function(t){var e=this.wsConnection;if(e)try{e.send(a.a.serialize(t,this.params.format))}catch(t){var n="Exception from ws connection when trying to send: "+r.a.inspectError(t);p.a.logAction(p.a.LOG_ERROR,"WebSocketTransport.send()",n),this.finish("disconnected",new c.a(n,5e4,500))}else p.a.logAction(p.a.LOG_ERROR,"WebSocketTransport.send()","No socket connection")},s.prototype.onWsData=function(t){p.a.logAction(p.a.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+t.length+"; type = "+typeof t);try{this.onProtocolMessage(a.a.deserialize(t,this.format))}catch(t){p.a.logAction(p.a.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+t.stack)}},s.prototype.onWsOpen=function(){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("wsopen")},s.prototype.onWsClose=function(t){var e,n,i;"object"==typeof t?(e=t.wasClean,n=t.code):e=1e3==(n=t),delete this.wsConnection,e?(p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket"),i=new c.a("Websocket closed",80003,400)):(n="Unclean disconnection of WebSocket ; code = "+n,i=new c.a(n,80003,400),p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.onWsClose()",n)),this.finish("disconnected",i),this.emit("disposed")},s.prototype.onWsError=function(t){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+t.message);var e=this;r.a.nextTick(function(){e.disconnect(t)})},s.prototype.dispose=function(){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;var t=this.wsConnection;t&&(t.onmessage=function(){},delete this.wsConnection,r.a.nextTick(function(){p.a.logAction(p.a.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),t.close()}))},s}},function(t,e,n){"use strict";function i(t){var i="xhr_polling";function s(t,e,n){n.stream=!1,u.a.call(this,t,e,n),this.shortName=i}return r.a.inherits(s,u.a),s.isAvailable=function(){return c.a.xhrSupported&&c.a.allowComet},s.tryConnect=function(t,e,n,i){function o(t){i({event:this.event,error:t})}var r=new s(t,e,n);r.on(["failed","disconnected"],o),r.on("preconnect",function(){a.a.logAction(a.a.LOG_MINOR,"XHRPollingTransport.tryConnect()","viable transport "+r),r.off(["failed","disconnected"],o),i(null,r)}),r.connect()},s.prototype.toString=function(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},s.prototype.createRequest=function(t,e,n,i,o){return h.a.createRequest(t,e,n,i,o,this.timeouts)},void 0!==t&&s.isAvailable()&&(t.supportedTransports[i]=s),s}var o=n(39),r=n(1),a=n(0),c=n(3),u=n(15),h=n(27),n=function(t){var i="xhr_streaming";function s(t,e,n){u.a.call(this,t,e,n),this.shortName=i}return r.a.inherits(s,u.a),s.isAvailable=function(){return c.a.xhrSupported&&c.a.streamingSupported&&c.a.allowComet},s.tryConnect=function(t,e,n,i){function o(t){i({event:this.event,error:t})}var r=new s(t,e,n);r.on(["failed","disconnected"],o),r.on("preconnect",function(){a.a.logAction(a.a.LOG_MINOR,"XHRStreamingTransport.tryConnect()","viable transport "+r),r.off(["failed","disconnected"],o),i(null,r)}),r.connect()},s.prototype.toString=function(){return"XHRStreamingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},s.prototype.createRequest=function(t,e,n,i,o){return h.a.createRequest(t,e,n,i,o,this.timeouts)},void 0!==t&&s.isAvailable()&&(t.supportedTransports[i]=s),s};e.a=[o.a,i,n]},function(t,e){},function(t,e,n){var i;t.exports=(i=n(12),function(){var o=i.lib.WordArray,t=i.enc;t.Utf16=t.Utf16BE={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],o=0;o<n;o+=2){var r=e[o>>>2]>>>16-o%4*8&65535;i.push(String.fromCharCode(r))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i++)n[i>>>1]|=t.charCodeAt(i)<<16-i%2*16;return o.create(n,2*e)}};function s(t){return t<<8&4278255360|t>>>8&16711935}t.Utf16LE={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],o=0;o<n;o+=2){var r=s(e[o>>>2]>>>16-o%4*8&65535);i.push(String.fromCharCode(r))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i++)n[i>>>1]|=s(t.charCodeAt(i)<<16-i%2*16);return o.create(n,2*e)}}}(),i.enc.Utf16)},function(t,e,n){var i;t.exports=(i=n(12),n(31),function(){var e=i.lib.CipherParams,n=i.enc.Hex;i.format.Hex={stringify:function(t){return t.ciphertext.toString(n)},parse:function(t){t=n.parse(t);return e.create({ciphertext:t})}}}(),i.format.Hex)},function(t,e,n){var i;t.exports=(i=n(12),n(17),n(46),n(30),n(31),function(){var t=i,e=t.lib.BlockCipher,n=t.algo,u=[],h=[],l=[],p=[],f=[],d=[],g=[],m=[],y=[],v=[];!function(){for(var t=[],e=0;e<256;e++)t[e]=e<128?e<<1:e<<1^283;for(var n=0,i=0,e=0;e<256;e++){var o=(o=i^i<<1^i<<2^i<<3^i<<4)>>>8^255&o^99;u[n]=o;var r=t[h[o]=n],s=t[r],a=t[s],c=257*t[o]^16843008*o;l[n]=c<<24|c>>>8,p[n]=c<<16|c>>>16,f[n]=c<<8|c>>>24,d[n]=c;c=16843009*a^65537*s^257*r^16843008*n;g[o]=c<<24|c>>>8,m[o]=c<<16|c>>>16,y[o]=c<<8|c>>>24,v[o]=c,n?(n=r^t[t[t[a^r]]],i^=t[t[i]]):n=i=1}}();var O=[0,1,2,4,8,16,32,64,128,27,54],n=n.AES=e.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var t=this._keyPriorReset=this._key,e=t.words,n=t.sigBytes/4,i=4*(1+(this._nRounds=6+n)),o=this._keySchedule=[],r=0;r<i;r++)r<n?o[r]=e[r]:(c=o[r-1],r%n?6<n&&r%n==4&&(c=u[c>>>24]<<24|u[c>>>16&255]<<16|u[c>>>8&255]<<8|u[255&c]):(c=u[(c=c<<8|c>>>24)>>>24]<<24|u[c>>>16&255]<<16|u[c>>>8&255]<<8|u[255&c],c^=O[r/n|0]<<24),o[r]=o[r-n]^c);for(var s=this._invKeySchedule=[],a=0;a<i;a++){var c,r=i-a;c=a%4?o[r]:o[r-4],s[a]=a<4||r<=4?c:g[u[c>>>24]]^m[u[c>>>16&255]]^y[u[c>>>8&255]]^v[u[255&c]]}}},encryptBlock:function(t,e){this._doCryptBlock(t,e,this._keySchedule,l,p,f,d,u)},decryptBlock:function(t,e){var n=t[e+1];t[e+1]=t[e+3],t[e+3]=n,this._doCryptBlock(t,e,this._invKeySchedule,g,m,y,v,h);n=t[e+1];t[e+1]=t[e+3],t[e+3]=n},_doCryptBlock:function(t,e,n,i,o,r,s,a){for(var c=this._nRounds,u=t[e]^n[0],h=t[e+1]^n[1],l=t[e+2]^n[2],p=t[e+3]^n[3],f=4,d=1;d<c;d++)var g=i[u>>>24]^o[h>>>16&255]^r[l>>>8&255]^s[255&p]^n[f++],m=i[h>>>24]^o[l>>>16&255]^r[p>>>8&255]^s[255&u]^n[f++],y=i[l>>>24]^o[p>>>16&255]^r[u>>>8&255]^s[255&h]^n[f++],v=i[p>>>24]^o[u>>>16&255]^r[h>>>8&255]^s[255&l]^n[f++],u=g,h=m,l=y,p=v;g=(a[u>>>24]<<24|a[h>>>16&255]<<16|a[l>>>8&255]<<8|a[255&p])^n[f++],m=(a[h>>>24]<<24|a[l>>>16&255]<<16|a[p>>>8&255]<<8|a[255&u])^n[f++],y=(a[l>>>24]<<24|a[p>>>16&255]<<16|a[u>>>8&255]<<8|a[255&h])^n[f++],v=(a[p>>>24]<<24|a[u>>>16&255]<<16|a[h>>>8&255]<<8|a[255&l])^n[f++];t[e]=g,t[e+1]=m,t[e+2]=y,t[e+3]=v},keySize:8});t.AES=e._createHelper(n)}(),i.AES)},function(t,e,n){var o;t.exports=(o=n(12),function(c){var t=o,e=t.lib,n=e.WordArray,i=e.Hasher,e=t.algo,_=[];!function(){for(var t=0;t<64;t++)_[t]=4294967296*c.abs(c.sin(t+1))|0}();e=e.MD5=i.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(t,e){for(var n=0;n<16;n++){var i=e+n,o=t[i];t[i]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8)}var r=this._hash.words,s=t[e+0],a=t[e+1],c=t[e+2],u=t[e+3],h=t[e+4],l=t[e+5],p=t[e+6],f=t[e+7],d=t[e+8],g=t[e+9],m=t[e+10],y=t[e+11],v=t[e+12],O=t[e+13],R=t[e+14],A=t[e+15],b=I(b=r[0],S=r[1],w=r[2],C=r[3],s,7,_[0]),C=I(C,b,S,w,a,12,_[1]),w=I(w,C,b,S,c,17,_[2]),S=I(S,w,C,b,u,22,_[3]);b=I(b,S,w,C,h,7,_[4]),C=I(C,b,S,w,l,12,_[5]),w=I(w,C,b,S,p,17,_[6]),S=I(S,w,C,b,f,22,_[7]),b=I(b,S,w,C,d,7,_[8]),C=I(C,b,S,w,g,12,_[9]),w=I(w,C,b,S,m,17,_[10]),S=I(S,w,C,b,y,22,_[11]),b=I(b,S,w,C,v,7,_[12]),C=I(C,b,S,w,O,12,_[13]),w=I(w,C,b,S,R,17,_[14]),b=M(b,S=I(S,w,C,b,A,22,_[15]),w,C,a,5,_[16]),C=M(C,b,S,w,p,9,_[17]),w=M(w,C,b,S,y,14,_[18]),S=M(S,w,C,b,s,20,_[19]),b=M(b,S,w,C,l,5,_[20]),C=M(C,b,S,w,m,9,_[21]),w=M(w,C,b,S,A,14,_[22]),S=M(S,w,C,b,h,20,_[23]),b=M(b,S,w,C,g,5,_[24]),C=M(C,b,S,w,R,9,_[25]),w=M(w,C,b,S,u,14,_[26]),S=M(S,w,C,b,d,20,_[27]),b=M(b,S,w,C,O,5,_[28]),C=M(C,b,S,w,c,9,_[29]),w=M(w,C,b,S,f,14,_[30]),b=T(b,S=M(S,w,C,b,v,20,_[31]),w,C,l,4,_[32]),C=T(C,b,S,w,d,11,_[33]),w=T(w,C,b,S,y,16,_[34]),S=T(S,w,C,b,R,23,_[35]),b=T(b,S,w,C,a,4,_[36]),C=T(C,b,S,w,h,11,_[37]),w=T(w,C,b,S,f,16,_[38]),S=T(S,w,C,b,m,23,_[39]),b=T(b,S,w,C,O,4,_[40]),C=T(C,b,S,w,s,11,_[41]),w=T(w,C,b,S,u,16,_[42]),S=T(S,w,C,b,p,23,_[43]),b=T(b,S,w,C,g,4,_[44]),C=T(C,b,S,w,v,11,_[45]),w=T(w,C,b,S,A,16,_[46]),b=k(b,S=T(S,w,C,b,c,23,_[47]),w,C,s,6,_[48]),C=k(C,b,S,w,f,10,_[49]),w=k(w,C,b,S,R,15,_[50]),S=k(S,w,C,b,l,21,_[51]),b=k(b,S,w,C,v,6,_[52]),C=k(C,b,S,w,u,10,_[53]),w=k(w,C,b,S,m,15,_[54]),S=k(S,w,C,b,a,21,_[55]),b=k(b,S,w,C,d,6,_[56]),C=k(C,b,S,w,A,10,_[57]),w=k(w,C,b,S,p,15,_[58]),S=k(S,w,C,b,O,21,_[59]),b=k(b,S,w,C,h,6,_[60]),C=k(C,b,S,w,y,10,_[61]),w=k(w,C,b,S,c,15,_[62]),S=k(S,w,C,b,g,21,_[63]),r[0]=r[0]+b|0,r[1]=r[1]+S|0,r[2]=r[2]+w|0,r[3]=r[3]+C|0},_doFinalize:function(){var t=this._data,e=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;e[i>>>5]|=128<<24-i%32;var o=c.floor(n/4294967296),n=n;e[15+(64+i>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),e[14+(64+i>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),t.sigBytes=4*(e.length+1),this._process();for(var e=this._hash,r=e.words,s=0;s<4;s++){var a=r[s];r[s]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}return e},clone:function(){var t=i.clone.call(this);return t._hash=this._hash.clone(),t}});function I(t,e,n,i,o,r,s){s=t+(e&n|~e&i)+o+s;return(s<<r|s>>>32-r)+e}function M(t,e,n,i,o,r,s){s=t+(e&i|n&~i)+o+s;return(s<<r|s>>>32-r)+e}function T(t,e,n,i,o,r,s){s=t+(e^n^i)+o+s;return(s<<r|s>>>32-r)+e}function k(t,e,n,i,o,r,s){s=t+(n^(e|~i))+o+s;return(s<<r|s>>>32-r)+e}t.MD5=i._createHelper(e),t.HmacMD5=i._createHmacHelper(e)}(Math),o.MD5)},function(t,e,n){"use strict";n.r(e);var i=n(3),y=n(1),v=n(0),o=n(5),O=n(14);function r(){this.id=void 0,this.deviceSecret=void 0,this.platform=void 0,this.formFactor=void 0,this.clientId=void 0,this.metadata=void 0,this.deviceIdentityToken=void 0,this.push={recipient:void 0,state:void 0,error:void 0}}var R,a=(r.prototype.toJSON=function(){return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:this.push.recipient,state:this.push.state,error:this.push.error}}},r.prototype.toString=function(){var t="[DeviceDetails";return this.id&&(t+="; id="+this.id),this.platform&&(t+="; platform="+this.platform),this.formFactor&&(t+="; formFactor="+this.formFactor),this.clientId&&(t+="; clientId="+this.clientId),this.metadata&&(t+="; metadata="+this.metadata),this.deviceIdentityToken&&(t+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),this.push.recipient&&(t+="; push.recipient="+JSON.stringify(this.push.recipient)),this.push.state&&(t+="; push.state="+this.push.state),this.push.error&&(t+="; push.error="+JSON.stringify(this.push.error)),this.push.metadata&&(t+="; push.metadata="+this.push.metadata),t+="]"},r.toRequestBody=y.a.encodeBody,r.fromResponseBody=function(t,e){return e&&(t=y.a.decodeBody(t,e)),y.a.isArray(t)?r.fromValuesArray(t):r.fromValues(t)},r.fromValues=function(t){return t.error=t.error&&ErrorInfo.fromValues(t.error),y.a.mixin(new r,t)},r.fromValuesArray=function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i++)n[i]=r.fromValues(t[i]);return n},r),A=n(6),b=n(4);function c(){}function C(t,n,i,o,r){A.a.supportsAuthHeaders?t.auth.getAuthHeaders(function(t,e){t?o(t):r(y.a.mixin(e,n),i)}):t.auth.getAuthParams(function(t,e){t?o(t):r(n,y.a.mixin(e,i))})}function w(t){var e=[];if(t)for(var n in t)e.push(n+"="+t[n]);return e.join("&")}function S(t,e){return t+(e?"?":"")+w(e)}var u=(R=i.a.msgpack,y.a.arrForEach(A.a.methodsWithoutBody,function(s){c[s]=function(t,e,n,i,o,r){c.do(s,t,e,null,n,i,o,r)}}),y.a.arrForEach(A.a.methodsWithBody,function(a){c[a]=function(t,e,n,i,o,r,s){c.do(a,t,e,n,i,o,r,s)}}),c.do=function(o,s,a,c,u,h,t,l){var r,p,f,d,g,m;v.a.shouldLog(v.a.LOG_MICRO)&&(r=l,p=o,f=a,d=h,l=function(t,e,n,i,o){t?v.a.logAction(v.a.LOG_MICRO,"Resource."+p+"()","Received Error; "+S(f,d)+"; Error: "+y.a.inspectError(t)):v.a.logAction(v.a.LOG_MICRO,"Resource."+p+"()","Received; "+S(f,d)+"; Headers: "+w(n)+"; StatusCode: "+o+"; Body: "+(b.a.isBuffer(e)?e.toString():e)),r&&r(t,e,n,i,o)}),t&&(l=l&&(g=l,m=t,function(t,e,n,i,o){if(!t||e){if(!i)try{e=y.a.decodeBody(e,m)}catch(t){return void g(t)}if(void 0!==e.statusCode){var r=e.statusCode,s=e.response,a=e.headers;if(r<200||300<=r){i=s&&s.error||t;return i||((i=new Error("Error in unenveloping "+e)).statusCode=r),void g(i,s,a,!0,r)}g(t,s,a,!0,r)}else g(t,e,n,!0,o)}else g(t)}),(h=h||{}).envelope=t),C(s,u,h,l,function r(t,e){v.a.shouldLog(v.a.LOG_MICRO)&&v.a.logAction(v.a.LOG_MICRO,"Resource."+o+"()","Sending; "+S(a,e));var n=[s,a,t,c,e,function(t,e,n,i,o){t&&O.a.isTokenErr(t)?s.auth.authorize(null,null,function(t){t?l(t):C(s,u,h,l,r)}):l(t,e,n,i,o)}];if(c||n.splice(3,1),v.a.shouldLog(v.a.LOG_MICRO)){var i=c;if(0<(t["content-type"]||"").indexOf("msgpack"))try{i=R.decode(c)}catch(t){v.a.logAction(v.a.LOG_MICRO,"Resource."+o+"()","Sending MsgPack Decoding Error: "+y.a.inspectError(t))}v.a.logAction(v.a.LOG_MICRO,"Resource."+o+"()","Sending; "+S(a,e)+"; Body: "+i)}A.a[o].apply(this,n)})},c);function l(t){"string"==typeof t&&(t=t.split(","));for(var e={},n=0;n<t.length;n++){var i,o=t[n].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);!o||(i=(i=(i=o[1]).match(/^\.\/(\w+)\?(.*)$/))&&y.a.parseQueryString(i[2]))&&(e[o[2]]=i)}return e}function s(t,e,n,i,o,r){this.rest=t,this.path=e,this.headers=n,this.envelope=i,this.bodyHandler=o,this.useHttpPaginatedResponse=r||!1}function p(t,e,n){var i;this.resource=t,this.items=e,n&&(i=this,"first"in n&&(this.first=function(t){if(!t&&i.resource.rest.options.promises)return y.a.promisify(i,"first",[]);i.get(n.first,t)}),"current"in n&&(this.current=function(t){if(!t&&i.resource.rest.options.promises)return y.a.promisify(i,"current",[]);i.get(n.current,t)}),this.next=function(t){if(!t&&i.resource.rest.options.promises)return y.a.promisify(i,"next",[]);"next"in n?i.get(n.next,t):t(null,null)},this.hasNext=function(){return"next"in n},this.isLast=function(){return!this.hasNext()})}function f(t,e,n,i,o,r){p.call(this,t,e,o),this.statusCode=i,this.success=i<300&&200<=i,this.headers=n,this.errorCode=r&&r.code,this.errorMessage=r&&r.message}var h=(y.a.arrForEach(A.a.methodsWithoutBody,function(e){s.prototype[e]=function(t,r){var s=this;u[e](s.rest,s.path,s.headers,t,s.envelope,function(t,e,n,i,o){s.handlePage(t,e,n,i,o,r)})}}),y.a.arrForEach(A.a.methodsWithBody,function(n){s.prototype[n]=function(t,e,r){var s=this;u[n](s.rest,s.path,e,s.headers,t,s.envelope,function(t,e,n,i,o){r&&s.handlePage(t,e,n,i,o,r)})}}),s.prototype.handlePage=function(e,t,n,i,o,r){if(e&&(s=e,a=t,!this.useHttpPaginatedResponse||!a&&"number"!=typeof s.code))return v.a.logAction(v.a.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+y.a.inspectError(e)),void r(e);var s,a,c,u,h;try{c=this.bodyHandler(t,n,i)}catch(t){return void r(e||t)}n&&(u=n.Link||n.link)&&(h=l(u)),this.useHttpPaginatedResponse?r(null,new f(this,c,n,o,h,e)):r(null,new p(this,c,h))},p.prototype.get=function(t,r){var s=this.resource;u.get(s.rest,s.path,s.headers,t,s.envelope,function(t,e,n,i,o){s.handlePage(t,e,n,i,o,r)})},y.a.inherits(f,p),s),m=n(2);function d(){this.channel=void 0,this.deviceId=void 0,this.clientId=void 0}var g=(d.prototype.toJSON=function(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}},d.prototype.toString=function(){var t="[PushChannelSubscription";return this.channel&&(t+="; channel="+this.channel),this.deviceId&&(t+="; deviceId="+this.deviceId),this.clientId&&(t+="; clientId="+this.clientId),t+="]"},d.toRequestBody=y.a.encodeBody,d.fromResponseBody=function(t,e){return e&&(t=y.a.decodeBody(t,e)),y.a.isArray(t)?d.fromValuesArray(t):d.fromValues(t)},d.fromValues=function(t){return y.a.mixin(new d,t)},d.fromValuesArray=function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i++)n[i]=d.fromValues(t[i]);return n},d);function _(){}function I(t){this.rest=t,this.deviceRegistrations=new M(t),this.channelSubscriptions=new T(t)}function M(t){this.rest=t}function T(t){this.rest=t}var k=(I.prototype.publish=function(t,e,n){var i=this.rest,o=i.options.useBinaryProtocol?"msgpack":"json",r=y.a.mixin({recipient:t},e),t=y.a.defaultPostHeaders(o),e={};if("function"!=typeof n){if(this.rest.options.promises)return y.a.promisify(this,"publish",arguments);n=_}i.options.headers&&y.a.mixin(t,i.options.headers),i.options.pushFullWait&&y.a.mixin(e,{fullWait:"true"}),r=y.a.encodeBody(r,o),u.post(i,"/push/publish",r,t,e,!1,function(t){n(t)})},M.prototype.save=function(t,o){var e=this.rest,r=e.options.useBinaryProtocol?"msgpack":"json",n=a.fromValues(t),i=y.a.defaultPostHeaders(r),s={};if("function"!=typeof o){if(this.rest.options.promises)return y.a.promisify(this,"save",arguments);o=_}e.options.headers&&y.a.mixin(i,e.options.headers),e.options.pushFullWait&&y.a.mixin(s,{fullWait:"true"}),n=y.a.encodeBody(n,r),u.put(e,"/push/deviceRegistrations/"+encodeURIComponent(t.id),n,i,s,!1,function(t,e,n,i){o(t,!t&&a.fromResponseBody(e,!i&&r))})},M.prototype.get=function(t,o){var e=this.rest,r=e.options.useBinaryProtocol?"msgpack":"json",n=y.a.defaultGetHeaders(r),t=t.id||t;if("function"!=typeof o){if(this.rest.options.promises)return y.a.promisify(this,"get",arguments);o=_}"string"==typeof t&&t.length?(e.options.headers&&y.a.mixin(n,e.options.headers),u.get(e,"/push/deviceRegistrations/"+encodeURIComponent(t),n,{},!1,function(t,e,n,i){o(t,!t&&a.fromResponseBody(e,!i&&r))})):o(new m.a("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400))},M.prototype.list=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,r=y.a.defaultGetHeaders(i);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"list",arguments);e=_}n.options.headers&&y.a.mixin(r,n.options.headers),new h(n,"/push/deviceRegistrations",r,o,function(t,e,n){return a.fromResponseBody(t,!n&&i)}).get(t,e)},M.prototype.remove=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=y.a.defaultGetHeaders(i),i={},t=t.id||t;if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"remove",arguments);e=_}"string"==typeof t&&t.length?(n.options.headers&&y.a.mixin(o,n.options.headers),n.options.pushFullWait&&y.a.mixin(i,{fullWait:"true"}),u.delete(n,"/push/deviceRegistrations/"+encodeURIComponent(t),o,i,!1,function(t){e(t)})):e(new m.a("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400))},M.prototype.removeWhere=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",i=y.a.defaultGetHeaders(i);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"removeWhere",arguments);e=_}n.options.headers&&y.a.mixin(i,n.options.headers),n.options.pushFullWait&&y.a.mixin(t,{fullWait:"true"}),u.delete(n,"/push/deviceRegistrations",i,t,!1,function(t){e(t)})},T.prototype.save=function(t,o){var e=this.rest,r=e.options.useBinaryProtocol?"msgpack":"json",n=g.fromValues(t),i=y.a.defaultPostHeaders(r),t={};if("function"!=typeof o){if(this.rest.options.promises)return y.a.promisify(this,"save",arguments);o=_}e.options.headers&&y.a.mixin(i,e.options.headers),e.options.pushFullWait&&y.a.mixin(t,{fullWait:"true"}),n=y.a.encodeBody(n,r),u.post(e,"/push/channelSubscriptions",n,i,t,!1,function(t,e,n,i){o(t,!t&&g.fromResponseBody(e,!i&&r))})},T.prototype.list=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,r=y.a.defaultGetHeaders(i);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"list",arguments);e=_}n.options.headers&&y.a.mixin(r,n.options.headers),new h(n,"/push/channelSubscriptions",r,o,function(t,e,n){return g.fromResponseBody(t,!n&&i)}).get(t,e)},T.prototype.remove=T.prototype.removeWhere=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",i=y.a.defaultGetHeaders(i);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"removeWhere",arguments);e=_}n.options.headers&&y.a.mixin(i,n.options.headers),n.options.pushFullWait&&y.a.mixin(t,{fullWait:"true"}),u.delete(n,"/push/channelSubscriptions",i,t,!1,function(t){e(t)})},T.prototype.listChannels=function(t,e){var n=this.rest,o=n.options.useBinaryProtocol?"msgpack":"json",i=A.a.supportsLinkHeaders?void 0:o,r=y.a.defaultGetHeaders(o);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"listChannels",arguments);e=_}n.options.headers&&y.a.mixin(r,n.options.headers),n.options.pushFullWait&&y.a.mixin(t,{fullWait:"true"}),new h(n,"/push/channels",r,i,function(t,e,n){!n&&o&&(t=y.a.decodeBody(t,o));for(var i=0;i<t.length;i++)t[i]=String(t[i]);return t}).get(t,e)},function(t){this.rest=t,this.admin=new I(t)}),E=n(7),x=n(11);function P(){}function L(t){this.channel=t,this.basePath=t.basePath+"/presence"}var N=(y.a.inherits(L,E.a),L.prototype.get=function(t,e){if(v.a.logAction(v.a.LOG_MICRO,"Presence.get()","channel = "+this.channel.name),void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.channel.rest.options.promises)return y.a.promisify(this,"get",arguments);e=P}var n=this.channel.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,r=y.a.defaultGetHeaders(i);n.options.headers&&y.a.mixin(r,n.options.headers);var s=this.channel.channelOptions;new h(n,this.basePath,r,o,function(t,e,n){return x.a.fromResponseBody(t,s,!n&&i)}).get(t,e)},L.prototype.history=function(t,e){v.a.logAction(v.a.LOG_MICRO,"Presence.history()","channel = "+this.channel.name),this._history(t,e)},L.prototype._history=function(t,e){if(void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.channel.rest.options.promises)return y.a.promisify(this,"_history",arguments);e=P}var n=this.channel.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,r=y.a.defaultGetHeaders(i);this.channel;n.options.headers&&y.a.mixin(r,n.options.headers);var s=this.channel.channelOptions;new h(n,this.basePath+"/history",r,o,function(t,e,n){return x.a.fromResponseBody(t,s,!n&&i)}).get(t,e)},L),U=n(18),G=n(9);function q(){}function B(t,e,n){v.a.logAction(v.a.LOG_MINOR,"Channel()","started; name = "+e),E.a.call(this),this.rest=t,this.name=e,this.basePath="/channels/"+encodeURIComponent(e),this.presence=new N(this),this.setOptions(n)}var H=(y.a.inherits(B,E.a),B.prototype.setOptions=function(t){if(this.channelOptions=t=t||{},t.cipher){if(!U.a)throw new Error("Encryption not enabled; use ably.encryption.js instead");var e=U.a.getCipher(t.cipher);t.cipher=e.cipherParams,t.channelCipher=e.cipher}else"cipher"in t&&(t.cipher=null,t.channelCipher=null)},B.prototype.history=function(t,e){if(v.a.logAction(v.a.LOG_MICRO,"Channel.history()","channel = "+this.name),void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.rest.options.promises)return y.a.promisify(this,"history",arguments);e=q}this._history(t,e)},B.prototype._history=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,r=y.a.defaultGetHeaders(i);n.options.headers&&y.a.mixin(r,n.options.headers);var s=this.channelOptions;new h(n,this.basePath+"/messages",r,o,function(t,e,n){return G.a.fromResponseBody(t,s,!n&&i)}).get(t,e)},B.prototype.publish=function(){var n,i,t=arguments[0],e=arguments[1],o=arguments[arguments.length-1],r=this;if("function"!=typeof o){if(this.rest.options.promises)return y.a.promisify(this,"publish",arguments);o=q}if("string"==typeof t||null===t)n=[G.a.fromValues({name:t,data:e})],i=arguments[2];else if(y.a.isObject(t))n=[G.a.fromValues(t)],i=arguments[1];else{if(!y.a.isArray(t))throw new m.a("The single-argument form of publish() expects a message object or an array of message objects",40013,400);n=G.a.fromValuesArray(t),i=arguments[1]}"object"==typeof i&&i||(i={});var s,t=this.rest,a=t.options,c=a.useBinaryProtocol?"msgpack":"json",t=t.options.idempotentRestPublishing,u=y.a.defaultPostHeaders(c);a.headers&&y.a.mixin(u,a.headers),t&&(t=n,y.a.arrEvery(t,function(t){return!t.id}))&&(s=y.a.randomString(9),y.a.arrForEach(n,function(t,e){t.id=s+":"+e.toString()})),G.a.encodeArray(n,this.channelOptions,function(t){var e;t?o(t):(e=G.a.getMessagesSize(n),(t=a.maxMessageSize)<e?o(new m.a("Maximum size of messages that can be published at once exceeded ( was "+e+" bytes; limit is "+t+" bytes)",40009,400)):r._publish(G.a.serialize(n,c),u,i,o))})},B.prototype._publish=function(t,e,n,i){u.post(this.rest,this.basePath+"/messages",t,e,n,!1,i)},B);function D(t){this.count=t&&t.count||0,this.data=t&&t.data||0,this.uncompressedData=t&&t.uncompressedData||0,this.failed=t&&t.failed||0,this.refused=t&&t.refused||0}function F(e){var n=this;D.call(this,e),this.category=void 0,e&&e.category&&(this.category={},y.a.forInOwnNonNullProps(e.category,function(t){n.category[t]=new D(e.category[t])}))}function j(t){this.peak=t&&t.peak||0,this.min=t&&t.min||0,this.mean=t&&t.mean||0,this.opened=t&&t.opened||0,this.refused=t&&t.refused||0}function z(t){this.succeeded=t&&t.succeeded||0,this.failed=t&&t.failed||0,this.refused=t&&t.refused||0}function V(t){this.plain=new j(t&&t.plain),this.tls=new j(t&&t.tls),this.all=new j(t&&t.all)}function W(t){this.messages=new F(t&&t.messages),this.presence=new F(t&&t.presence),this.all=new F(t&&t.all)}function K(t){this.realtime=new W(t&&t.realtime),this.rest=new W(t&&t.rest),this.webhook=new W(t&&t.webhook),this.sharedQueue=new W(t&&t.sharedQueue),this.externalQueue=new W(t&&t.externalQueue),this.httpEvent=new W(t&&t.httpEvent),this.push=new W(t&&t.push),this.all=new W(t&&t.all)}function J(t){this.all=new W(t&&t.all),this.inbound=new K(t&&t.inbound),this.outbound=new K(t&&t.outbound)}function Q(t){this.all=new W(t&&t.all),this.producerPaid=new J(t&&t.producerPaid),this.consumerPaid=new J(t&&t.consumerPaid)}function X(t){this.messages=t&&t.messages||0;var e=t&&t.notifications;this.notifications={invalid:e&&e.invalid||0,attempted:e&&e.attempted||0,successful:e&&e.successful||0,failed:e&&e.failed||0},this.directPublishes=t&&t.directPublishes||0}function Y(t){this.succeeded=t&&t.succeeded||0,this.skipped=t&&t.skipped||0,this.failed=t&&t.failed||0}function $(e){var n=this;this.delta=void 0,e&&e.delta&&(this.delta={},y.a.forInOwnNonNullProps(e.delta,function(t){n.delta[t]=new Y(e.delta[t])}))}function Z(t){J.call(this,t),this.persisted=new W(t&&t.persisted),this.connections=new V(t&&t.connections),this.channels=new j(t&&t.channels),this.apiRequests=new z(t&&t.apiRequests),this.tokenRequests=new z(t&&t.tokenRequests),this.xchgProducer=new Q(t&&t.xchgProducer),this.xchgConsumer=new Q(t&&t.xchgConsumer),this.push=new X(t&&t.pushStats),this.processed=new $(t&&t.processed),this.inProgress=t&&t.inProgress||void 0,this.unit=t&&t.unit||void 0,this.intervalId=t&&t.intervalId||void 0}var tt,et=(Z.fromValues=function(t){return new Z(t)},Z),nt=(tt=i.a.msgpack,ot.prototype.stats=function(t,e){if(void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.options.promises)return y.a.promisify(this,"stats",arguments);e=it}var n=y.a.defaultGetHeaders(),i=this.options.useBinaryProtocol?"msgpack":"json",i=A.a.supportsLinkHeaders?void 0:i;this.options.headers&&y.a.mixin(n,this.options.headers),new h(this,"/stats",n,i,function(t,e,n){for(var i=n?t:JSON.parse(t),o=0;o<i.length;o++)i[o]=et.fromValues(i[o]);return i}).get(t,e)},ot.prototype.time=function(t,o){if(void 0===o)if("function"==typeof t)o=t,t=null;else{if(this.options.promises)return y.a.promisify(this,"time",arguments);o=it}var e=y.a.defaultGetHeaders();this.options.headers&&y.a.mixin(e,this.options.headers);var r=this;A.a.get(this,function(t){return r.authority(t)+"/time"},e,t,function(t,e,n,i){if(t)o(t);else{i||(e=JSON.parse(e));e=e[0];if(!e)return(t=new Error("Internal error (unexpected result type from GET /time)")).statusCode=500,void o(t);r.serverTimeOffset=e-y.a.now(),o(null,e)}})},ot.prototype.request=function(t,e,n,i,o,r){var s=this.options.useBinaryProtocol,a=s?tt.encode:JSON.stringify,c=s?tt.decode:JSON.parse,u=s?"msgpack":"json",s=A.a.supportsLinkHeaders?void 0:u;n=n||{};u="get"==(t=t.toLowerCase())?y.a.defaultGetHeaders(u):y.a.defaultPostHeaders(u);if(void 0===r){if(this.options.promises)return y.a.promisify(this,"request",[t,e,n,i,o]);r=it}"string"!=typeof i&&(i=a(i)),this.options.headers&&y.a.mixin(u,this.options.headers),o&&y.a.mixin(u,o);s=new h(this,e,u,s,function(t,e,n){return y.a.ensureArray(n?t:c(t))},!0);if(!y.a.arrIn(A.a.methods,t))throw new m.a("Unsupported method "+t,40500,405);y.a.arrIn(A.a.methodsWithBody,t)?s[t](n,i,r):s[t](n,r)},ot.prototype.setLog=function(t){v.a.setLog(t.level,t.handler)},rt.prototype.get=function(t,e){t=String(t);var n=this.all[t];return n?e&&n.setOptions(e):this.all[t]=n=new H(this.rest,t,e),n},rt.prototype.release=function(t){delete this.all[String(t)]},ot);function it(){}function ot(e){if(!(this instanceof ot))return new ot(e);if(!e){var t="no options provided";throw v.a.logAction(v.a.LOG_ERROR,"Rest()",t),new Error(t)}if((e=o.a.objectifyOptions(e)).log&&v.a.setLog(e.log.level,e.log.handler),v.a.logAction(v.a.LOG_MICRO,"Rest()","initialized with clientOptions "+y.a.inspect(e)),this.options=o.a.normaliseOptions(e),e.key){var n=e.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!n){t="invalid key parameter";throw v.a.logAction(v.a.LOG_ERROR,"Rest()",t),new Error(t)}e.keyName=n[1],e.keySecret=n[2]}if("clientId"in e){if("string"!=typeof e.clientId&&null!==e.clientId)throw new m.a("clientId must be either a string or null",40012,400);if("*"===e.clientId)throw new m.a('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}v.a.logAction(v.a.LOG_MINOR,"Rest()","started; version = "+o.a.libstring),this.baseUri=this.authority=function(t){return o.a.getHttpScheme(e)+t+":"+o.a.getPort(e,!1)},this._currentFallback=null,this.serverTimeOffset=null,this.auth=new O.a(this,e),this.channels=new rt(this),this.push=new k(this)}function rt(t){this.rest=t,this.all={}}nt.Promise=function(t){return(t=o.a.objectifyOptions(t)).promises=!0,new nt(t)};var st=nt.Callbacks=nt,at=n(25),ct=n(21);function ut(){}function ht(t,e){E.a.call(this),this.ably=t,this.connectionManager=new at.a(t,e),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.serial=void 0,this.timeSerial=void 0,this.recoveryKey=void 0,this.errorReason=null;var n=this;this.connectionManager.on("connectionstate",function(t){var e=n.state=t.current;y.a.nextTick(function(){n.emit(e,t)})}),this.connectionManager.on("update",function(t){y.a.nextTick(function(){n.emit("update",t)})})}var lt=(y.a.inherits(ht,E.a),ht.prototype.whenState=function(t,e){return E.a.prototype.whenState.call(this,t,this.state,e,new ct.a(void 0,t))},ht.prototype.connect=function(){v.a.logAction(v.a.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})},ht.prototype.ping=function(t){if(v.a.logAction(v.a.LOG_MINOR,"Connection.ping()",""),!t){if(this.ably.options.promises)return y.a.promisify(this,"ping",arguments);t=ut}this.connectionManager.ping(null,t)},ht.prototype.close=function(){v.a.logAction(v.a.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})},ht),pt=n(8),ft=n(13),dt=n(22),gt=function(t,e,n,i){this.previous=t,"attached"===(this.current=e)&&(this.resumed=n),i&&(this.reason=i)};function mt(){}function yt(t){return t.clientId+":"+t.connectionId}function vt(t){var e=t.channel.realtime,t=e.auth.clientId;return(!t||"*"===t)&&"connected"===e.connection.state}function Ot(t,e){N.call(this,t),this.syncComplete=!1,this.members=new Rt(this),this._myMembers=new Rt(this),this.subscriptions=new E.a,this.pendingPresence=[]}function Rt(t){E.a.call(this),this.presence=t,this.map={},this.syncInProgress=!1,this.residualMembers=null}function At(t,e){if(t.isSynthesized()||e.isSynthesized())return t.timestamp>e.timestamp;t=t.parseId(),e=e.parseId();return t.msgSerial===e.msgSerial?t.index>e.index:t.msgSerial>e.msgSerial}var bt,Ct,wt,St=(y.a.inherits(Ot,N),Ot.prototype.enter=function(t,e){if(vt(this))throw new m.a("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,t,"enter",e)},Ot.prototype.update=function(t,e){if(vt(this))throw new m.a("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,t,"update",e)},Ot.prototype.enterClient=function(t,e,n){return this._enterOrUpdateClient(t,e,"enter",n)},Ot.prototype.updateClient=function(t,e,n){return this._enterOrUpdateClient(t,e,"update",n)},Ot.prototype._enterOrUpdateClient=function(t,e,n,i){if(!i)if("function"==typeof e)i=e,e=null;else{if(this.channel.realtime.options.promises)return y.a.promisify(this,"_enterOrUpdateClient",[t,e,n]);i=mt}var o,r,s=this.channel;s.connectionManager.activeState()?(v.a.logAction(v.a.LOG_MICRO,"RealtimePresence."+n+"Client()","channel = "+s.name+", client = "+(t||"(implicit) "+this.channel.realtime.auth.clientId)),o=x.a.fromValues({action:n,data:e}),t&&(o.clientId=t),r=this,x.a.encode(o,s.channelOptions,function(t){if(t)i(t);else switch(s.state){case"attached":s.sendPresence(o,i);break;case"initialized":case"detached":s.attach();case"attaching":r.pendingPresence.push({presence:o,callback:i});break;default:(t=new m.a("Unable to "+n+" presence channel while in "+s.state+" state",90001)).code=90001,i(t)}})):i(s.connectionManager.getError())},Ot.prototype.leave=function(t,e){if(vt(this))throw new m.a("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,t,e)},Ot.prototype.leaveClient=function(t,e,n){if(!n)if("function"==typeof e)n=e,e=null;else{if(this.channel.realtime.options.promises)return y.a.promisify(this,"leaveClient",[t,e]);n=mt}var i=this.channel;if(i.connectionManager.activeState()){v.a.logAction(v.a.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+t);e=x.a.fromValues({action:"leave",data:e});switch(t&&(e.clientId=t),i.state){case"attached":i.sendPresence(e,n);break;case"attaching":this.pendingPresence.push({presence:e,callback:n});break;case"initialized":case"failed":n(new m.a("Unable to leave presence channel (incompatible state)",90001));break;default:n(ft.a.failed)}}else n(i.connectionManager.getError())},Ot.prototype.get=function(){var t=Array.prototype.slice.call(arguments);1==t.length&&"function"==typeof t[0]&&t.unshift(null);var e,n=t[0],i=t[1],o=!n||!("waitForSync"in n)||n.waitForSync;if(!i){if(this.channel.realtime.options.promises)return y.a.promisify(this,"get",t);i=mt}function r(t){i(null,n?t.list(n):t.values())}"suspended"!==this.channel.state?function(t,e,n){switch(t.state){case"attached":case"suspended":n();break;case"initialized":case"detached":case"detaching":case"attaching":t.attach(function(t){t?e(t):n()});break;default:e(m.a.fromValues(Mt.invalidStateError(t.state)))}}((e=this).channel,i,function(){var t=e.members;o?t.waitSync(function(){r(t)}):r(t)}):o?i(m.a.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):r(this.members)},Ot.prototype.history=function(t,e){if(v.a.logAction(v.a.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name),void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.channel.realtime.options.promises)return y.a.promisify(this,"history",arguments);e=mt}t&&t.untilAttach&&("attached"===this.channel.state?(delete t.untilAttach,t.from_serial=this.channel.properties.attachSerial):e(new m.a("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400))),N.prototype._history.call(this,t,e)},Ot.prototype.setPresence=function(t,e,n){v.a.logAction(v.a.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+t.length+" participants; syncChannelSerial = "+n);var i,o,r=this.members,s=this._myMembers,a=[],c=this.channel.connectionManager.connectionId;e&&(this.members.startSync(),n&&(o=n.match(/^[\w\-]+:(.*)$/))&&(i=o[1]));for(var u=0;u<t.length;u++)switch((h=x.a.fromValues(t[u])).action){case"leave":r.remove(h)&&a.push(h),h.connectionId!==c||h.isSynthesized()||s.remove(h);break;case"enter":case"present":case"update":r.put(h)&&a.push(h),h.connectionId===c&&s.put(h)}e&&!i&&(r.endSync(),this._ensureMyMembersPresent(),this.channel.setInProgress(Mt.progressOps.sync,!1),this.channel.syncChannelSerial=null);for(u=0;u<a.length;u++){var h=a[u];this.subscriptions.emit(h.action,h)}},Ot.prototype.onAttached=function(t){v.a.logAction(v.a.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+t),t?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear(),this._ensureMyMembersPresent());var e=this.pendingPresence,n=e.length;if(n){this.pendingPresence=[];var i=[],o=Object(dt.a)();v.a.logAction(v.a.LOG_MICRO,"RealtimePresence.onAttached","sending "+n+" queued presence messages");for(var r=0;r<n;r++){var s=e[r];i.push(s.presence),o.push(s.callback)}this.channel.sendPresence(i,o)}},Ot.prototype.actOnChannelState=function(t,e,n){switch(t){case"attached":this.onAttached(e);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(n)}},Ot.prototype.failPendingPresence=function(t){if(this.pendingPresence.length){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+y.a.inspectError(t));for(var e=0;e<this.pendingPresence.length;e++)try{this.pendingPresence[e].callback(t)}catch(t){}this.pendingPresence=[]}},Ot.prototype._clearMyMembers=function(){this._myMembers.clear()},Ot.prototype._ensureMyMembersPresent=function(){function t(t){var e;t&&(e="Presence auto-re-enter failed: "+t.toString(),t=new m.a(e,91004,400),v.a.logAction(v.a.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()",e),t=new gt(i.channel.state,i.channel.state,!0,t),i.channel.emit("update",t))}var e,n,i=this,o=this.members,r=this._myMembers;for(e in r.map)e in o.map||(n=r.map[e],v.a.logAction(v.a.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+n.clientId+'" into the presence set'),this._enterOrUpdateClient(n.clientId,n.data,"enter",t),delete r.map[e])},Ot.prototype._synthesizeLeaves=function(t){var e=this.subscriptions;y.a.arrForEach(t,function(t){t=x.a.fromValues({action:"leave",connectionId:t.connectionId,clientId:t.clientId,data:t.data,encoding:t.encoding,timestamp:y.a.now()});e.emit("leave",t)})},Ot.prototype.on=function(){v.a.deprecated("presence.on","presence.subscribe"),this.subscribe.apply(this,arguments)},Ot.prototype.off=function(){v.a.deprecated("presence.off","presence.unsubscribe"),this.unsubscribe.apply(this,arguments)},Ot.prototype.subscribe=function(){var t=Mt.processListenerArgs(arguments),e=t[0],n=t[1],i=t[2],t=this.channel;if(!i){if(this.channel.realtime.options.promises)return y.a.promisify(this,"subscribe",[e,n]);i=mt}"failed"!==t.state?(this.subscriptions.on(e,n),t.attach(i)):i(m.a.fromValues(Mt.invalidStateError("failed")))},Ot.prototype.unsubscribe=function(){var t=Mt.processListenerArgs(arguments),e=t[0],t=t[1];this.subscriptions.off(e,t)},y.a.inherits(Rt,E.a),Rt.prototype.get=function(t){return this.map[t]},Rt.prototype.getClient=function(t){var e,n=this.map,i=[];for(e in n){var o=n[e];o.clientId==t&&"absent"!=o.action&&i.push(o)}return i},Rt.prototype.list=function(t){var e,n=this.map,i=t&&t.clientId,o=t&&t.connectionId,r=[];for(e in n){var s=n[e];"absent"!==s.action&&(i&&i!=s.clientId||o&&o!=s.connectionId||r.push(s))}return r},Rt.prototype.put=function(t){"enter"!==t.action&&"update"!==t.action||((t=x.a.fromValues(t)).action="present");var e=this.map,n=yt(t);this.residualMembers&&delete this.residualMembers[n];var i=e[n];return!(i&&!At(t,i))&&(e[n]=t,!0)},Rt.prototype.values=function(){var t,e=this.map,n=[];for(t in e){var i=e[t];"absent"!=i.action&&n.push(i)}return n},Rt.prototype.remove=function(t){var e=this.map,n=yt(t),i=e[n];return!(i&&!At(t,i))&&(this.syncInProgress?((t=x.a.fromValues(t)).action="absent",e[n]=t):delete e[n],!0)},Rt.prototype.startSync=function(){var t=this.map,e=this.syncInProgress;v.a.logAction(v.a.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+e),this.syncInProgress||(this.residualMembers=y.a.copy(t),this.setInProgress(!0))},Rt.prototype.endSync=function(){var t=this.map,e=this.syncInProgress;if(v.a.logAction(v.a.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+e),e){for(var n in t)"absent"===t[n].action&&delete t[n];for(var n in this.presence._synthesizeLeaves(y.a.valuesArray(this.residualMembers)),this.residualMembers)delete t[n];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")},Rt.prototype.waitSync=function(t){var e=this.syncInProgress;v.a.logAction(v.a.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+e),e?this.once("sync",t):t()},Rt.prototype.clear=function(t){this.map={},this.setInProgress(!1),this.residualMembers=null},Rt.prototype.setInProgress=function(t){v.a.logAction(v.a.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+t),this.syncInProgress=t,this.presence.syncComplete=!t},Ot);function _t(){}function It(t,e,n){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel()","started; name = "+e),H.call(this,t,e,n),this.realtime=t,this.presence=new St(this,t.options),this.connectionManager=t.connection.connectionManager,this.state="initialized",this.subscriptions=new E.a,this.syncChannelSerial=void 0,this.properties={attachSerial:void 0},this.setOptions(n),this.errorReason=null,this._requestedFlags=null,this._mode=null,this._attachedMsgIndicator=!1,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:t.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new E.a}var Mt=(bt=pt.a.Action,Ct="statechange",wt="sync",y.a.inherits(It,H),It.invalidStateError=function(t){return{statusCode:400,code:90001,message:"Channel operation failed as channel state is "+t}},It.progressOps={statechange:Ct,sync:wt},It.processListenerArgs=function(t){return"function"==typeof(t=Array.prototype.slice.call(t))[0]&&t.unshift(null),null==t[t.length-1]&&t.pop(),t},It.prototype.setOptions=function(t,e){if(!e){if(this.rest.options.promises)return y.a.promisify(this,"setOptions",arguments);e=function(t){t&&v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.setOptions()","Set options failed: "+t.toString())}}var n=function(t){if(t&&"params"in t&&!y.a.isObject(t.params))return new m.a("options.params must be an object",4e4,400);if(t&&"modes"in t){if(!y.a.isArray(t.modes))return new m.a("options.modes must be an array",4e4,400);for(var e=0;e<t.modes.length;e++){var n=t.modes[e];if(!n||"string"!=typeof n||!y.a.arrIn(pt.a.channelModes,String.prototype.toUpperCase.call(n)))return new m.a("Invalid channel mode: "+n,4e4,400)}}}(t);n?e(n):(H.prototype.setOptions.call(this,t),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(t)?(this.attachImpl(),this._allChannelChanges.once(function(t){switch(this.event){case"update":case"attached":return void e(null);default:return void e(t.reason)}})):e())},It.prototype._shouldReattachToSetOptions=function(t){return("attached"===this.state||"attaching"===this.state)&&(t.params||t.modes)},It.prototype.publish=function(){var t=arguments.length,e=arguments[0],n=arguments[t-1];if("function"!=typeof n){if(this.realtime.options.promises)return y.a.promisify(this,"publish",arguments);n=_t,++t}if(this.connectionManager.activeState()){if(2==t)if(y.a.isObject(e))e=[G.a.fromValues(e)];else{if(!y.a.isArray(e))throw new m.a("The single-argument form of publish() expects a message object or an array of message objects",40013,400);e=G.a.fromValuesArray(e)}else e=[G.a.fromValues({name:arguments[0],data:arguments[1]})];var i=this,o=this.realtime.options.maxMessageSize;G.a.encodeArray(e,this.channelOptions,function(t){t?n(t):(t=G.a.getMessagesSize(e),o<t?n(new m.a("Maximum size of messages that can be published at once exceeded ( was "+t+" bytes; limit is "+o+" bytes)",40009,400)):i._publish(e,n))})}else n(this.connectionManager.getError())},It.prototype._publish=function(t,e){v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.publish()","message count = "+t.length);var n=this.state;switch(n){case"failed":case"suspended":e(m.a.fromValues(It.invalidStateError(n)));break;default:v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+n);n=new pt.a;n.action=bt.MESSAGE,n.channel=this.name,n.messages=t,this.sendMessage(n,e)}},It.prototype.onEvent=function(t){v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var e=this.subscriptions,n=0;n<t.length;n++){var i=t[n];e.emit(i.name,i)}},It.prototype.attach=function(t,e){if("function"==typeof t&&(e=t,t=null),!e){if(this.realtime.options.promises)return y.a.promisify(this,"attach",arguments);e=function(t){t&&v.a.logAction(v.a.LOG_MAJOR,"RealtimeChannel.attach()","Channel attach failed: "+t.toString())}}if(t)v.a.deprecated("channel.attach() with flags","channel.setOptions() with channelOptions.params"),this._requestedFlags=t;else if("attached"===this.state)return void e();this._attach(!1,null,e)},It.prototype._attach=function(t,e,n){n=n||function(t){t&&v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+t.toString())};var i=this.connectionManager;i.activeState()?("attaching"===this.state&&!t||this.requestState("attaching",e),this.once(function(t){switch(this.event){case"attached":n();break;case"detached":case"suspended":case"failed":n(t.reason||i.getError());break;case"detaching":n(new m.a("Attach request superseded by a subsequent detach request",9e4,409))}})):n(i.getError())},It.prototype.attachImpl=function(){v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message"),this.setInProgress(Ct,!0);var t=pt.a.fromValues({action:bt.ATTACH,channel:this.name,params:this.channelOptions.params});this._requestedFlags?t.encodeModesToFlags(this._requestedFlags):this.channelOptions.modes&&t.encodeModesToFlags(y.a.allToUpperCase(this.channelOptions.modes)),this._attachResume&&t.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(t.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(t,_t)},It.prototype.detach=function(e){if(!e){if(this.realtime.options.promises)return y.a.promisify(this,"detach",arguments);e=_t}var n=this.connectionManager;if(n.activeState())switch(this.state){case"detached":case"failed":e();break;default:this.requestState("detaching");case"detaching":this.once(function(t){switch(this.event){case"detached":e();break;case"attached":case"suspended":case"failed":e(t.reason||n.getError());break;case"attaching":e(new m.a("Detach request superseded by a subsequent attach request",9e4,409))}})}else e(n.getError())},It.prototype.detachImpl=function(t){v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message"),this.setInProgress(Ct,!0);var e=pt.a.fromValues({action:bt.DETACH,channel:this.name});this.sendMessage(e,t||_t)},It.prototype.subscribe=function(){var t=It.processListenerArgs(arguments),e=t[0],n=t[1],t=t[2];if(!t){if(this.realtime.options.promises)return y.a.promisify(this,"subscribe",[e,n]);t=_t}if("failed"!==this.state)return this.subscriptions.on(e,n),this.attach(t);t(m.a.fromValues(It.invalidStateError("failed")))},It.prototype.unsubscribe=function(){var t=It.processListenerArgs(arguments),e=t[0],t=t[1];this.subscriptions.off(e,t)},It.prototype.sync=function(){switch(this.state){case"initialized":case"detaching":case"detached":throw new m.a("Unable to sync to channel; not attached",4e4)}var t=this.connectionManager;if(!t.activeState())throw t.getError();var e=pt.a.fromValues({action:bt.SYNC,channel:this.name});this.syncChannelSerial&&(e.channelSerial=this.syncChannelSerial),t.send(e)},It.prototype.sendMessage=function(t,e){this.connectionManager.send(t,this.realtime.options.queueMessages,e)},It.prototype.sendPresence=function(t,e){t=pt.a.fromValues({action:bt.PRESENCE,channel:this.name,presence:y.a.isArray(t)?x.a.fromValuesArray(t):[x.a.fromValues(t)]});this.sendMessage(t,e)},It.prototype.onMessage=function(t){var e=!1;switch(t.action){case bt.ATTACHED:this._attachedMsgIndicator=!0,this.properties.attachSerial=t.channelSerial,this._mode=t.getMode(),this.params=t.params||{};var n=t.decodeModesFromFlags();this.modes=n&&y.a.allToLowerCase(n)||void 0;var i=t.hasFlag("RESUMED"),o=t.hasFlag("HAS_PRESENCE");"attached"===this.state?(this.setInProgress(Ct,!1),i||this.presence.onAttached(o),n=new gt(this.state,this.state,i,t.error),this._allChannelChanges.emit("update",n),i&&!this.channelOptions.updateOnAttached||this.emit("update",n)):this.notifyState("attached",t.error,i,o);break;case bt.DETACHED:var r=t.error?m.a.fromValues(t.error):new m.a("Channel detached",90001,404);"detaching"===this.state?this.notifyState("detached",r):"attaching"===this.state?this.notifyState("suspended",r):this.requestState("attaching",r);break;case bt.SYNC:if(e=!0,d=this.syncChannelSerial=t.channelSerial,!t.presence)break;case bt.PRESENCE:for(var s=t.presence,a=t.id,c=t.connectionId,u=t.timestamp,h=this.channelOptions,l=0;l<s.length;l++){try{var p=s[l];x.a.decode(p,h)}catch(t){v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.onMessage()",t.toString())}p.connectionId||(p.connectionId=c),p.timestamp||(p.timestamp=u),p.id||(p.id=a+":"+l)}this.presence.setPresence(s,e,d);break;case bt.MESSAGE:if("attached"!==this.state)return void v.a.logAction(v.a.LOG_MAJOR,"RealtimeChannel.onMessage()",'Message "'+t.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');var f=t.messages,e=f[0],d=f[f.length-1],a=t.id,c=t.connectionId,u=t.timestamp;if(e.extras&&e.extras.delta&&e.extras.delta.from!==this._lastPayload.messageId){var g='Delta message decode failure - previous message not available for message "'+t.id+'" on this channel "'+this.name+'".';v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.onMessage()",g),this._startDecodeFailureRecovery(new m.a(g,40018,400));break}for(l=0;l<f.length;l++){g=f[l];try{G.a.decode(g,this._decodingContext)}catch(t){switch(v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.onMessage()",t.toString()),t.code){case 40018:return void this._startDecodeFailureRecovery(t);case 40019:case 40021:return void this.notifyState("failed",t)}}g.connectionId||(g.connectionId=c),g.timestamp||(g.timestamp=u),g.id||(g.id=a+":"+l)}this._lastPayload.messageId=d.id,this._lastPayload.protocolMessageChannelSerial=t.channelSerial,this.onEvent(f);break;case bt.ERROR:(r=t.error)&&80016==r.code?this.checkPendingState():this.notifyState("failed",m.a.fromValues(r));break;default:v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.onMessage()","Fatal protocol error: unrecognised action ("+t.action+")"),this.connectionManager.abort(ft.a.unknownChannelErr)}},It.prototype._startDecodeFailureRecovery=function(t){var e=this;this._lastPayload.decodeFailureRecoveryInProgress||(v.a.logAction(v.a.LOG_MAJOR,"RealtimeChannel.onMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,t,function(){e._lastPayload.decodeFailureRecoveryInProgress=!1}))},It.prototype.onAttached=function(){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)},It.prototype.notifyState=function(t,e,n,i){var o;v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+t),this.clearStateTimer(),t!==this.state&&(this.presence.actOnChannelState(t,i,e),"suspended"===t&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),e&&(this.errorReason=e),o=new gt(this.state,t,n,e),n="failed"===t?v.a.LOG_ERROR:v.a.LOG_MAJOR,v.a.logAction(n,'Channel state for channel "'+this.name+'"',t+(e?"; reason: "+e:"")),"attached"===t?(this.onAttached(),this.setInProgress(wt,i),this.setInProgress(Ct,!1)):"detached"!==t&&"failed"!==t&&"suspended"!==t||(this.setInProgress(Ct,!1),this.setInProgress(wt,!1)),"attached"===t?this._attachResume=!0:"detaching"!==t&&"failed"!==t||(this._attachResume=!1),this.state=t,this._allChannelChanges.emit(t,o),this.emit(t,o))},It.prototype.requestState=function(t,e){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+t),this.notifyState(t,e),this.checkPendingState()},It.prototype.checkPendingState=function(){var t=this.connectionManager.state;if(t.sendEvents||t.forceQueueEvents)switch(v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync()}else v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state)},It.prototype.timeoutPendingState=function(){switch(this.state){case"attaching":var t=new m.a("Channel attach timed out",90007,408);this.notifyState("suspended",t);break;case"detaching":t=new m.a("Channel detach timed out",90007,408);this.notifyState("attached",t);break;default:this.checkPendingState()}},It.prototype.startStateTimerIfNotRunning=function(){var t=this;this.stateTimer||(this.stateTimer=setTimeout(function(){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),t.stateTimer=null,t.timeoutPendingState()},this.realtime.options.timeouts.realtimeRequestTimeout))},It.prototype.clearStateTimer=function(){var t=this.stateTimer;t&&(clearTimeout(t),this.stateTimer=null)},It.prototype.startRetryTimer=function(){var t=this;this.retryTimer||(this.retryTimer=setTimeout(function(){"suspended"===t.state&&t.connectionManager.state.sendEvents&&(t.retryTimer=null,v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),t.requestState("attaching"))},this.realtime.options.timeouts.channelRetryTimeout))},It.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.suspendTimer=null)},It.prototype.setInProgress=function(t,e){this.rest.channels.setInProgress(this,t,e)},It.prototype.history=function(t,e){if(v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name),void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.rest.options.promises)return y.a.promisify(this,"history",arguments);e=_t}if(t&&t.untilAttach){if("attached"!==this.state)return void e(new m.a("option untilAttach requires the channel to be attached",4e4,400));if(!this.properties.attachSerial)return void e(new m.a("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400));delete t.untilAttach,t.from_serial=this.properties.attachSerial}H.prototype._history.call(this,t,e)},It.prototype.whenState=function(t,e){return E.a.prototype.whenState.call(this,t,this.state,e)},It.prototype.getReleaseErr=function(){var t=this.state;return"initialized"===t||"detached"===t||"failed"===t?null:new m.a("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+t,90001,400)},It),Tt=n(23),kt=(y.a.inherits(Et,st),Et.prototype.connect=function(){v.a.logAction(v.a.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()},Et.prototype.close=function(){v.a.logAction(v.a.LOG_MINOR,"Realtime.close()",""),this.connection.close()},y.a.inherits(xt,E.a),xt.prototype.onChannelMessage=function(t){var e,n=t.channel;void 0!==n?(e=this.all[n])?e.onMessage(t):v.a.logAction(v.a.LOG_ERROR,"Channels.onChannelMessage()","received event for non-existent channel: "+n):v.a.logAction(v.a.LOG_ERROR,"Channels.onChannelMessage()","received event unspecified channel, action = "+t.action)},xt.prototype.onTransportActive=function(){for(var t in this.all){var e=this.all[t];"attaching"===e.state||"detaching"===e.state?e.checkPendingState():"suspended"===e.state&&e.attach()}},xt.prototype.reattach=function(t){for(var e in this.all){var n=this.all[e];"attached"===n.state&&n.requestState("attaching",t)}},xt.prototype.resetAttachedMsgIndicators=function(){for(var t in this.all){var e=this.all[t];"attached"===e.state&&(e._attachedMsgIndicator=!1)}},xt.prototype.checkAttachedMsgIndicators=function(t){for(var e in this.all){var n,i=this.all[e];"attached"===i.state&&!1===i._attachedMsgIndicator&&(n="30s after a resume, found channel which has not received an attached; channelId = "+e+"; connectionId = "+t,v.a.logAction(v.a.LOG_ERROR,"Channels.checkAttachedMsgIndicators()",n),Tt.a.report("error",n,"channel-no-attached-after-resume"),i.requestState("attaching"))}},xt.prototype.propogateConnectionInterruption=function(t,e){var n,i=["attaching","attached","detaching","suspended"],o={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"}[t];for(n in this.all){var r=this.all[n];y.a.arrIn(i,r.state)&&r.notifyState(o,e)}},xt.prototype.get=function(t,e){t=String(t);var n=this.all[t];if(n){if(e){if(n._shouldReattachToSetOptions(e))throw new m.a("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);n.setOptions(e)}}else n=this.all[t]=new Mt(this.realtime,t,e);return n},xt.prototype.release=function(t){t=String(t);var e=this.all[t];if(e){e=e.getReleaseErr();if(e)throw e;delete this.all[t],delete this.inProgress[t]}},xt.prototype.setInProgress=function(t,e,n){this.inProgress[t.name]=this.inProgress[t.name]||{},!(this.inProgress[t.name][e]=n)&&this.hasNopending()&&this.emit("nopending")},xt.prototype.onceNopending=function(t){this.hasNopending()?t():this.once("nopending",t)},xt.prototype.hasNopending=function(){return y.a.arrEvery(y.a.valuesArray(this.inProgress,!0),function(t){return!y.a.containsValue(t,!0)})},Et);function Et(t){if(!(this instanceof Et))return new Et(t);v.a.logAction(v.a.LOG_MINOR,"Realtime()",""),st.call(this,t),this.connection=new lt(this,this.options),this.channels=new xt(this),!1!==t.autoConnect&&this.connect()}function xt(t){E.a.call(this),this.realtime=t,this.all={},this.inProgress={};var e=this;t.connection.connectionManager.on("transport.active",function(){e.onTransportActive()})}kt.Promise=function(t){return(t=o.a.objectifyOptions(t)).promises=!0,new kt(t)};i=kt.Callbacks=kt,n=n(24);st.Utils=y.a,st.BufferUtils=b.a,st.Crypto=U.a,st.Defaults=o.a,st.Http=A.a,st.Resource=u,st.Message=G.a,st.PresenceMessage=x.a,i.Utils=y.a,i.BufferUtils=b.a,i.Crypto=U.a,i.Defaults=o.a,i.Http=A.a,i.Message=G.a,i.PresenceMessage=x.a,i.ProtocolMessage=pt.a,i.ConnectionManager=at.a;e.default={Rest:st,Realtime:i,msgpack:n.a}}],o.c=i,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=47).default;function o(t){if(i[t])return i[t].exports;var e=i[t]={i:t,l:!1,exports:{}};return n[t].call(e.exports,e,e.exports,o),e.l=!0,e.exports}var n,i});