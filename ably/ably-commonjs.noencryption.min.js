!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Ably=e():t.Ably=e()}(window,function(){return i={},o.m=n=[function(t,e,n){"use strict";(function(c){var u=n(3),t=function(){var t,e;function i(t,e){return("000"+t).slice(-2-(e||0))}"undefined"==typeof Window&&"undefined"==typeof WorkerGlobalScope||c.console&&c.console.log&&"function"==typeof c.console.log.apply?(t=function(){console.log.apply(console,arguments)},e=console.warn?function(){console.warn.apply(console,arguments)}:t):t=e=c.console&&c.console.log?function(){Function.prototype.apply.call(console.log,console,arguments)}:function(){};var n=1;function o(n){return u.a.logTimestamps?function(t){var e=new Date;n(i(e.getHours())+":"+i(e.getMinutes())+":"+i(e.getSeconds())+"."+i(e.getMilliseconds(),!0)+" "+t)}:n}var s=o(t),r=o(e);function a(t){}return a.LOG_NONE=0,a.LOG_ERROR=1,a.LOG_MAJOR=2,a.LOG_MINOR=3,a.LOG_MICRO=4,a.LOG_DEFAULT=1,a.LOG_DEBUG=4,a.logAction=function(t,e,n){a.shouldLog(t)&&(1===t?r:s)("Ably: "+e+": "+n)},a.deprecated=function(t,e){a.deprecatedWithMsg(t,"Please use '"+e+"' instead.")},a.deprecatedWithMsg=function(t,e){a.shouldLog(1)&&r("Ably: Deprecation warning - '"+t+"' is deprecated and will be removed from a future version. "+e)},a.shouldLog=function(t){return t<=n},a.setLog=function(t,e){void 0!==t&&(n=t),void 0!==e&&(s=r=e)},a}();e.a=t}).call(this,n(17))},function(t,e,n){"use strict";var i=n(3),o=n(4),a=n(6),n=function(){var n=i.a.msgpack;function r(){}function s(t){return Math.floor(Math.random()*t.length)}r.mixin=function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];if(!n)break;var i,o=n.hasOwnProperty;for(i in n)o&&!o.call(n,i)||(t[i]=n[i])}return t},r.copy=function(t){return r.mixin({},t)},r.isArray=Array.isArray||function(t){return"[object Array]"==Object.prototype.toString.call(t)},r.ensureArray=function(t){return r.isEmptyArg(t)?[]:r.isArray(t)?t:[t]},r.isObject=function(t){return"[object Object]"==Object.prototype.toString.call(t)},r.isEmpty=function(t){for(var e in t)return!1;return!0},r.isOnlyPropIn=function(t,e){for(var n in t)if(n!==e)return!1;return!0},r.isEmptyArg=function(t){return null==t},r.shallowClone=function(t){var e,n=new Object;for(e in t)n[e]=t[e];return n},r.prototypicalClone=function(t,e){function n(){}n.prototype=t;t=new n;return e&&r.mixin(t,e),t},r.inherits=i.a.inherits||function(t,e){t.super_=e,t.prototype=r.prototypicalClone(e.prototype,{constructor:t})},r.containsValue=function(t,e){for(var n in t)if(t[n]==e)return!0;return!1},r.intersect=function(t,e){return r.isArray(e)?r.arrIntersect(t,e):r.arrIntersectOb(t,e)},r.arrIntersect=function(t,e){for(var n=[],i=0;i<t.length;i++){var o=t[i];-1!=r.arrIndexOf(e,o)&&n.push(o)}return n},r.arrIntersectOb=function(t,e){for(var n=[],i=0;i<t.length;i++){var o=t[i];o in e&&n.push(o)}return n},r.arrSubtract=function(t,e){for(var n=[],i=0;i<t.length;i++){var o=t[i];-1==r.arrIndexOf(e,o)&&n.push(o)}return n},r.arrIndexOf=Array.prototype.indexOf?function(t,e,n){return t.indexOf(e,n)}:function(t,e,n){n=n||0;for(var i=t.length;n<i;n++)if(t[n]===e)return n;return-1},r.arrIn=function(t,e){return-1!==r.arrIndexOf(t,e)},r.arrDeleteValue=function(t,e){var n=r.arrIndexOf(t,e),e=-1!=n;return e&&t.splice(n,1),e},r.arrWithoutValue=function(t,e){t=t.slice();return r.arrDeleteValue(t,e),t},r.keysArray=function(t,e){var n,i=[];for(n in t)e&&!t.hasOwnProperty(n)||i.push(n);return i},r.valuesArray=function(t,e){var n,i=[];for(n in t)e&&!t.hasOwnProperty(n)||i.push(t[n]);return i},r.forInOwnNonNullProps=function(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&t[n]&&e(n)},r.arrForEach=Array.prototype.forEach?function(t,e){t.forEach(e)}:function(t,e){for(var n=t.length,i=0;i<n;i++)e(t[i],i,t)},r.safeArrForEach=function(t,e){return r.arrForEach(t.slice(),e)},r.arrMap=Array.prototype.map?function(t,e){return t.map(e)}:function(t,e){for(var n=[],i=t.length,o=0;o<i;o++)n.push(e(t[o],o,t));return n},r.arrFilter=Array.prototype.filter?function(t,e){return t.filter(e)}:function(t,e){for(var n=[],i=t.length,o=0;o<i;o++)e(t[o])&&n.push(t[o]);return n},r.arrEvery=Array.prototype.every?function(t,e){return t.every(e)}:function(t,e){for(var n=t.length,i=0;i<n;i++)if(!e(t[i],i,t))return!1;return!0},r.allSame=function(t,e){if(0===t.length)return!0;var n=t[0][e];return r.arrEvery(t,function(t){return t[e]===n})},r.nextTick=i.a.nextTick;var e={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};return r.defaultGetHeaders=function(t){return{accept:e[t||"json"],"X-Ably-Version":o.a.apiVersion,"X-Ably-Lib":o.a.libstring}},r.defaultPostHeaders=function(t){return{accept:t=e[t||"json"],"content-type":t,"X-Ably-Version":o.a.apiVersion,"X-Ably-Lib":o.a.libstring}},r.arrPopRandomElement=function(t){return t.splice(s(t),1)[0]},r.toQueryString=function(t){var e=[];if(t)for(var n in t)e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.length?"?"+e.join("&"):""},r.parseQueryString=function(t){for(var e,n=/([^?&=]+)=?([^&]*)/g,i={};e=n.exec(t);)i[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return i},r.now=Date.now||function(){return(new Date).getTime()},r.inspect=i.a.inspect,r.isErrorInfo=function(t){return"ErrorInfo"==t.constructor.name},r.inspectError=function(t){return t&&(r.isErrorInfo(t)||"Error"==t.constructor.name||t instanceof Error)?t.toString():r.inspect(t)},r.inspectBody=function(t){return a.a.isBuffer(t)?t.toString():"string"==typeof t?t:i.a.inspect(t)},r.dataSizeBytes=function(t){if(a.a.isBuffer(t))return a.a.byteLength(t);if("string"==typeof t)return i.a.stringByteSize(t);throw new Error("Expected input of Utils.dataSizeBytes to be a buffer or string, but was: "+typeof t)},r.cheapRandStr=function(){return String(Math.random()).substr(2)},r.randomString=i.a.getRandomValues&&"undefined"!=typeof Uint8Array?function(t){t=new Uint8Array(t);return i.a.getRandomValues(t),a.a.base64Encode(t)}:function(t){for(var e=a.a.base64CharSet,n=Math.round(4*t/3),i="",o=0;o<n;o++)i+=e[s(e)];return i},r.randomHexString=i.a.getRandomValues&&"undefined"!=typeof Uint8Array?function(t){t=new Uint8Array(t);return i.a.getRandomValues(t),a.a.hexEncode(t)}:function(t){for(var e=a.a.hexCharSet,n=2*t,i="",o=0;o<n;o++)i+=e[s(e)];return i},r.arrChooseN=function(t,e){for(var n=Math.min(e,t.length),i=t.slice(),o=[],s=0;s<n;s++)o.push(r.arrPopRandomElement(i));return o},r.trim=String.prototype.trim?function(t){return t.trim()}:function(t){return t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},r.promisify=function(t,e,o){return new Promise(function(n,i){t[e].apply(t,Array.prototype.slice.call(o).concat(function(t,e){t?i(t):n(e)}))})},r.decodeBody=function(t,e){return"msgpack"==e?n.decode(t):JSON.parse(String(t))},r.encodeBody=function(t,e){return"msgpack"==e?n.encode(t,!0):JSON.stringify(t)},r.allToLowerCase=function(t){return r.arrMap(t,function(t){return t&&t.toLowerCase()})},r.allToUpperCase=function(t){return r.arrMap(t,function(t){return t&&t.toUpperCase()})},r}();e.a=n},function(t,e,n){"use strict";var i=n(1),n=(o.prototype.toString=function(){var t="["+this.constructor.name;return this.message&&(t+=": "+this.message),this.statusCode&&(t+="; statusCode="+this.statusCode),this.code&&(t+="; code="+this.code),this.cause&&(t+="; cause="+i.a.inspectError(this.cause)),!this.href||this.message&&-1<this.message.indexOf("help.ably.io")||(t+="; see "+this.href+" "),t+="]"},o.fromValues=function(t){var e=i.a.mixin(new o,t);return t instanceof Error&&(e.message=t.message),e.code&&!e.href&&(e.href="https://help.ably.io/error/"+e.code),e},o);function o(t,e,n,i){this.message=t,this.code=e,this.statusCode=n,this.cause=i,this.href=void 0}e.a=n},function(t,o,s){"use strict";(function(e){var t=s(23);"undefined"==typeof Window&&"undefined"==typeof WorkerGlobalScope&&console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");var n,i=e.navigator&&e.navigator.userAgent.toString(),t={libver:"js-web",logTimestamps:!0,userAgent:i,currentUrl:e.location&&e.location.href,noUpgrade:i&&i.match(/MSIE\s8\.0/),binaryType:"arraybuffer",WebSocket:e.WebSocket||e.MozWebSocket,xhrSupported:e.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,jsonpSupported:"undefined"!=typeof document,allowComet:(n=e.location,!e.WebSocket||!n||!n.origin||-1<n.origin.indexOf("http")),streamingSupported:!0,useProtocolHeartbeats:!0,createHmac:null,msgpack:t.a,supportsBinary:!!e.TextDecoder,preferBinary:!1,ArrayBuffer:e.ArrayBuffer,atob:e.atob,nextTick:function(t){setTimeout(t,0)},addEventListener:e.addEventListener,inspect:JSON.stringify,stringByteSize:function(t){return e.TextDecoder&&(new e.TextEncoder).encode(t).length||t.length},TextEncoder:e.TextEncoder,TextDecoder:e.TextDecoder,Promise:e.Promise,getRandomValues:function(n){if(void 0!==n)return function(t,e){n.getRandomValues(t),e&&e(null)}}(e.crypto||e.msCrypto)};o.a=t}).call(this,s(17))},function(t,e,n){"use strict";var o=n(3),i={internetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",jsonpInternetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up-0-9.js",defaultTransports:["xhr_polling","xhr_streaming","jsonp","web_socket"],baseTransportOrder:["xhr_polling","xhr_streaming","jsonp","web_socket"],transportPreferenceOrder:["jsonp","xhr_polling","xhr_streaming","web_socket"],upgradeTransports:["xhr_streaming","web_socket"]};o.a.noUpgrade&&(i.upgradeTransports=[]);var s=i,r=n(1),a=n(6),c=n(0),u=n(2);function l(t){if("string"!=typeof t)throw new u.a("host must be a string; was a "+typeof t,4e4,400);if(!t.length)throw new u.a("host must not be zero-length",4e4,400)}s.ENVIRONMENT="",s.REST_HOST="rest.ably.io",s.REALTIME_HOST="realtime.ably.io",s.FALLBACK_HOSTS=["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],s.PORT=80,s.TLS_PORT=443,s.TIMEOUTS={disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,preferenceConnectTimeout:6e3,parallelUpgradeDelay:6e3},s.httpMaxRetryCount=3,s.maxMessageSize=65536,s.errorReportingUrl="https://errors.ably.io/api/15/store/",s.errorReportingHeaders={"X-Sentry-Auth":"Sentry sentry_version=7, sentry_key=a04e33c8674c451f8a310fbec029acf5, sentry_client=ably-js/0.1","Content-Type":"application/json"},s.version="1.2.5",s.libstring=o.a.libver+"-"+s.version,s.apiVersion="1.2",s.getHost=function(t,e,n){return e=n?e==t.restHost&&t.realtimeHost||e||t.realtimeHost:e||t.restHost},s.getPort=function(t,e){return e||t.tls?t.tlsPort:t.port},s.getHttpScheme=function(t){return t.tls?"https://":"http://"},s.environmentFallbackHosts=function(t){return[t+"-a-fallback.ably-realtime.com",t+"-b-fallback.ably-realtime.com",t+"-c-fallback.ably-realtime.com",t+"-d-fallback.ably-realtime.com",t+"-e-fallback.ably-realtime.com"]},s.getFallbackHosts=function(t){var e=t.fallbackHosts,t=(void 0!==t.httpMaxRetryCount?t:s).httpMaxRetryCount;return e?r.a.arrChooseN(e,t):[]},s.getHosts=function(t){return[t.restHost].concat(s.getFallbackHosts(t))},s.objectifyOptions=function(t){return"string"==typeof t?-1==t.indexOf(":")?{token:t}:{key:t}:t},s.normaliseOptions=function(t){if(t.host&&(c.a.deprecated("host","restHost"),t.restHost=t.host),t.wsHost&&(c.a.deprecated("wsHost","realtimeHost"),t.realtimeHost=t.wsHost),t.queueEvents&&(c.a.deprecated("queueEvents","queueMessages"),t.queueMessages=t.queueEvents),t.fallbackHostsUseDefault){if(t.fallbackHosts){var e="fallbackHosts and fallbackHostsUseDefault cannot both be set";throw c.a.logAction(c.a.LOG_ERROR,"Defaults.normaliseOptions",e),new u.a(e,4e4,400)}if(t.port||t.tlsPort){e="fallbackHostsUseDefault cannot be set when port or tlsPort are set";throw c.a.logAction(c.a.LOG_ERROR,"Defaults.normaliseOptions",e),new u.a(e,4e4,400)}t.environment?c.a.deprecatedWithMsg("fallbackHostsUseDefault","There is no longer a need to set this when the environment option is also set since the library will now generate the correct fallback hosts using the environment option."):c.a.deprecated("fallbackHostsUseDefault","fallbackHosts: Ably.Defaults.FALLBACK_HOSTS"),t.fallbackHosts=s.FALLBACK_HOSTS}!0===t.recover&&(c.a.deprecated("{recover: true}","{recover: function(lastConnectionDetails, cb) { cb(true); }}"),t.recover=function(t,e){e(!0)}),"function"==typeof t.recover&&!0===t.closeOnUnload&&(c.a.logAction(c.a.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),t.recover=null),"closeOnUnload"in t||(t.closeOnUnload=!t.recover),t.transports&&r.a.arrIn(t.transports,"xhr")&&(c.a.deprecated('transports: ["xhr"]','transports: ["xhr_streaming"]'),r.a.arrDeleteValue(t.transports,"xhr"),t.transports.push("xhr_streaming")),"queueMessages"in t||(t.queueMessages=!0);var n,i=t.environment&&String(t.environment).toLowerCase()||s.ENVIRONMENT,e=!i||"production"===i;for(n in t.fallbackHosts||t.restHost||t.realtimeHost||t.port||t.tlsPort||(t.fallbackHosts=e?s.FALLBACK_HOSTS:s.environmentFallbackHosts(i)),t.realtimeHost||(t.restHost?(c.a.logAction(c.a.LOG_WARN,"Defaults.normaliseOptions",'restHost is set to "'+t.restHost+'" but realtimeHost is not set, so setting realtimeHost to "'+t.restHost+'" too. If this is not what you want, please set realtimeHost explicitly.'),t.realtimeHost=t.restHost):t.realtimeHost=e?s.REALTIME_HOST:i+"-"+s.REALTIME_HOST),t.restHost||(t.restHost=e?s.REST_HOST:i+"-"+s.REST_HOST),r.a.arrForEach((t.fallbackHosts||[]).concat(t.restHost,t.realtimeHost),l),t.port=t.port||s.PORT,t.tlsPort=t.tlsPort||s.TLS_PORT,t.maxMessageSize=t.maxMessageSize||s.maxMessageSize,"tls"in t||(t.tls=!0),t.timeouts={},s.TIMEOUTS)t.timeouts[n]=t[n]||s.TIMEOUTS[n];return"useBinaryProtocol"in t?t.useBinaryProtocol=o.a.supportsBinary&&t.useBinaryProtocol:t.useBinaryProtocol=o.a.preferBinary,t.clientId&&((t.headers=t.headers||{})["X-Ably-ClientId"]=a.a.base64Encode(a.a.utf8Encode(t.clientId))),"idempotentRestPublishing"in t||(t.idempotentRestPublishing=!0),t.promises&&!o.a.Promise&&(c.a.logAction(c.a.LOG_ERROR,"Defaults.normaliseOptions","{promises: true} was specified, but no Promise constructor found; disabling promises"),t.promises=!1),t};e.a=s},function(t,e,n){"use strict";var h,i=n(1),o=n(4),i=(h=Date.now||function(){return(new Date).getTime()},d._getHosts=g,d.methods=["get","delete","post","put","patch"],d.methodsWithoutBody=["get","delete"],d.methodsWithBody=i.a.arrSubtract(d.methods,d.methodsWithoutBody),i.a.arrForEach(d.methodsWithoutBody,function(s){d[s]=function(t,e,n,i,o){d.do(s,t,e,n,null,i,o)},d[s+"Uri"]=function(t,e,n,i,o){d.doUri(s,t,e,n,null,i,o)}}),i.a.arrForEach(d.methodsWithBody,function(r){d[r]=function(t,e,n,i,o,s){d.do(r,t,e,n,i,o,s)},d[r+"Uri"]=function(t,e,n,i,o,s){d.doUri(r,t,e,n,i,o,s)}}),d.do=function(t,o,e,s,r,a,c){c=c||p;var u="function"==typeof e?e:function(t){return o.baseUri(t)+e},n=(s&&s.accept,arguments),i=o._currentFallback;if(i){if(i.validUntil>h())return void d.Request(t,o,u(i.host),s,a,r,function(t){return t&&f(t)?(o._currentFallback=null,void d.do.apply(d,n)):void c.apply(null,arguments)});o._currentFallback=null}var l,i=g(o);1!=i.length?(l=function(e,n){var i=e.shift();d.doUri(t,o,u(i),s,r,a,function(t){t&&f(t)&&e.length?l(e,!0):(n&&(o._currentFallback={host:i,validUntil:h()+o.options.timeouts.fallbackRetryTimeout}),c.apply(null,arguments))})})(i):d.doUri(t,o,u(i[0]),s,r,a,c)},d.doUri=function(t,e,n,i,o,s,r){d.Request(t,e,n,i,s,o,r)},d.supportsAuthHeaders=!1,d.supportsLinkHeaders=!1,d);function p(){}function d(){}function f(t){var e=t.statusCode;return 408===e&&!t.code||400===e&&!t.code||500<=e&&e<=504}function g(t){var e=t.connection,e=e&&e.connectionManager.host;return e?[e].concat(o.a.getFallbackHosts(t.options)):o.a.getHosts(t.options)}e.a=i},function(t,e,n){"use strict";var p=n(27),d=n(28),f=n(22),i=n(31),g=n.n(i),m=n(3),n=function(){var o=m.a.ArrayBuffer,r=m.a.atob,e=m.a.TextEncoder,n=m.a.TextDecoder,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function s(t){return null!=t&&void 0!==t.sigBytes}function a(t){return null!=t&&t.constructor===o}function u(t){return o&&o.isView&&o.isView(t)}function l(){}l.base64CharSet=c,l.hexCharSet="0123456789abcdef";var i=l.isBuffer=function(t){return a(t)||s(t)||u(t)},h=l.toBuffer=function(t){if(!o)throw new Error("Can't convert to Buffer: browser does not support the necessary types");if(a(t))return new Uint8Array(t);if(u(t))return new Uint8Array(t.buffer);if(s(t)){for(var e=new o(t.sigBytes),n=new Uint8Array(e),i=0;i<t.sigBytes;i++)n[i]=t.words[i>>>2]>>>24-i%4*8&255;return n}throw new Error("BufferUtils.toBuffer expected an arraybuffer, typed array, or CryptoJS wordarray")};return l.toArrayBuffer=function(t){return a(t)?t:h(t).buffer},l.toWordArray=function(t){return u(t)&&(t=t.buffer),s(t)?t:g.a.create(t)},l.base64Encode=function(t){return s(t)?Object(f.stringify)(t):function(t){for(var e,n="",i=c,o=t.byteLength,s=o%3,r=o-s,a=0;a<r;a+=3)n+=i[(16515072&(e=t[a]<<16|t[a+1]<<8|t[a+2]))>>18]+i[(258048&e)>>12]+i[(4032&e)>>6]+i[63&e];return 1==s?n+=i[(252&(e=t[r]))>>2]+i[(3&e)<<4]+"==":2==s&&(n+=i[(64512&(e=t[r]<<8|t[1+r]))>>10]+i[(1008&e)>>4]+i[(15&e)<<2]+"="),n}(h(t))},l.base64Decode=function(t){return(o&&r?function(t){for(var e=r(t),n=e.length,i=new Uint8Array(n),o=0;o<n;o++){var s=e.charCodeAt(o);i[o]=s}return i.buffer}:Object(f.parse))(t)},l.hexEncode=function(t){return t=l.toWordArray(t),Object(p.stringify)(t)},l.hexDecode=function(t){t=Object(p.parse)(t);return o?l.toArrayBuffer(t):t},l.utf8Encode=function(t){return e?(new e).encode(t).buffer:Object(d.parse)(t)},l.utf8Decode=function(t){if(!i(t))throw new Error("Expected input of utf8decode to be an arraybuffer, typed array, or CryptoJS wordarray");return n&&!s(t)?(new n).decode(t):(t=l.toWordArray(t),Object(d.stringify)(t))},l.bufferCompare=function(t,e){if(!t)return-1;if(!e)return 1;t=l.toWordArray(t),e=l.toWordArray(e),t.clamp(),e.clamp();var n=t.sigBytes-e.sigBytes;if(0!=n)return n;t=t.words,e=e.words;for(var i=0;i<t.length;i++)if(0!=(n=t[i]-e[i]))return n;return 0},l.byteLength=function(t){return a(t)||u(t)?t.byteLength:s(t)?t.sigBytes:void 0},l.typedArrayToBuffer=function(t){return t.buffer},l}();e.a=n},function(t,e,n){"use strict";var a=n(1),i=n(0),r=n(3),n=(c.prototype.on=function(t,e){var n;1==arguments.length&&"function"==typeof t?this.any.push(t):a.a.isEmptyArg(t)?this.any.push(e):a.a.isArray(t)?(n=this,a.a.arrForEach(t,function(t){n.on(t,e)})):(this.events[t]||(this.events[t]=[])).push(e)},c.prototype.off=function(t,e){if(0==arguments.length||a.a.isEmptyArg(t)&&a.a.isEmptyArg(e))return this.any=[],this.events={},this.anyOnce=[],void(this.eventsOnce={});var n;1==arguments.length&&"function"==typeof t&&(e=t,t=null),e&&a.a.isEmptyArg(t)?l([this.any,this.events,this.anyOnce,this.eventsOnce],e):(a.a.isArray(t)&&(n=this,a.a.arrForEach(t,function(t){n.off(t,e)})),e?l([this.events,this.eventsOnce],e,t):(delete this.events[t],delete this.eventsOnce[t]))},c.prototype.listeners=function(t){if(t){var e=this.events[t]||[];return this.eventsOnce[t]&&Array.prototype.push.apply(e,this.eventsOnce[t]),e.length?e:null}return this.any.length?this.any:null},c.prototype.emit=function(t){var e=Array.prototype.slice.call(arguments,1),n={event:t},i=[];this.anyOnce.length&&(Array.prototype.push.apply(i,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(i,this.any);var o=this.eventsOnce[t];o&&(Array.prototype.push.apply(i,o),delete this.eventsOnce[t]);t=this.events[t];t&&Array.prototype.push.apply(i,t),a.a.arrForEach(i,function(t){u(n,t,e)})},c.prototype.once=function(e,t){var n=arguments.length,i=this;if((0===n||1===n&&"function"!=typeof e)&&r.a.Promise)return new r.a.Promise(function(t){i.once(e,t)});if(1==arguments.length&&"function"==typeof e)this.anyOnce.push(e);else if(a.a.isEmptyArg(e))this.anyOnce.push(t);else{if(a.a.isArray(e))throw"Arrays of events can only be used with on(), not once()";(this.eventsOnce[e]||(this.eventsOnce[e]=[])).push(t)}},c.prototype.whenState=function(e,n,t){var i={event:e},o=this,s=Array.prototype.slice.call(arguments,3);if("string"!=typeof e||"string"!=typeof n)throw"whenState requires a valid event String argument";if("function"!=typeof t&&r.a.Promise)return new r.a.Promise(function(t){c.prototype.whenState.apply(o,[e,n,t].concat(s))});e===n?u(i,t,s):this.once(e,t)},c);function c(){this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={}}function u(t,e,n){try{e.apply(t,n)}catch(t){i.a.logAction(i.a.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+t+"; stack = "+(t&&t.stack))}}function l(t,e,n){for(var i,o,s,r=0;r<t.length;r++)if(i=t[r],n&&(i=i[n]),a.a.isArray(i)){for(;-1!==(o=a.a.arrIndexOf(i,e));)i.splice(o,1);n&&0===i.length&&delete t[r][n]}else if(a.a.isObject(i))for(s in i)i.hasOwnProperty(s)&&a.a.isArray(i[s])&&l([i],e,s)}e.a=n},function(t,e,n){"use strict";var l=n(1),h=n(2),p=n(9),d=n(10),n=function(){function s(){this.action=void 0,this.flags=void 0,this.id=void 0,this.timestamp=void 0,this.count=void 0,this.error=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionSerial=void 0,this.channel=void 0,this.channelSerial=void 0,this.msgSerial=void 0,this.messages=void 0,this.presence=void 0,this.auth=void 0,this.params=void 0}var r=s.Action={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17};s.channelModes=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE"],s.ActionName=[],l.a.arrForEach(l.a.keysArray(s.Action,!0),function(t){s.ActionName[r[t]]=t});var e={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,PRESENCE:65536,PUBLISH:1<<17,SUBSCRIBE:1<<18,PRESENCE_SUBSCRIBE:1<<19},a=l.a.keysArray(e);function c(t){var e=[];if(t)for(var n=0;n<t.length;n++)e.push(t[n].toString());return"[ "+e.join(", ")+" ]"}e.MODE_ALL=e.PRESENCE|e.PUBLISH|e.SUBSCRIBE|e.PRESENCE_SUBSCRIBE,s.prototype.hasFlag=function(t){return 0<(this.flags&e[t])},s.prototype.setFlag=function(t){return this.flags=this.flags|e[t]},s.prototype.getMode=function(){return this.flags&&this.flags&e.MODE_ALL},s.prototype.encodeModesToFlags=function(t){var e=this;l.a.arrForEach(t,function(t){e.setFlag(t)})},s.prototype.decodeModesFromFlags=function(){var e=[],n=this;return l.a.arrForEach(s.channelModes,function(t){n.hasFlag(t)&&e.push(t)}),0<e.length?e:void 0},s.serialize=l.a.encodeBody,s.deserialize=function(t,e){e=l.a.decodeBody(t,e);return s.fromDeserialized(e)},s.fromDeserialized=function(t){var e=t.error;e&&(t.error=h.a.fromValues(e));var n=t.messages;if(n)for(var i=0;i<n.length;i++)n[i]=p.a.fromValues(n[i]);var o=t.presence;if(o)for(i=0;i<o.length;i++)o[i]=d.a.fromValues(o[i],!0);return l.a.mixin(new s,t)},s.fromValues=function(t){return l.a.mixin(new s,t)};var u="id channel channelSerial connectionId connectionKey connectionSerial count msgSerial timestamp".split(" ");return s.stringify=function(e){var t,n="[ProtocolMessage";void 0!==e.action&&(n+="; action="+s.ActionName[e.action]||!1);for(var i,o=0;o<u.length;o++)t=u[o],void 0!==e[t]&&(n+="; "+t+"="+e[t]);return e.messages&&(n+="; messages="+c(p.a.fromValuesArray(e.messages))),e.presence&&(n+="; presence="+c(d.a.fromValuesArray(e.presence))),e.error&&(n+="; error="+h.a.fromValues(e.error).toString()),e.auth&&e.auth.accessToken&&(n+="; token="+e.auth.accessToken),e.flags&&(n+="; flags="+l.a.arrFilter(a,function(t){return e.hasFlag(t)}).join(",")),e.params&&(i="",l.a.forInOwnNonNullProps(e.params,function(t){0<i.length&&(i+="; "),i+=t+"="+e.params[t]}),0<i.length&&(n+="; params=["+i+"]")),n+="]"},s.isDuplicate=function(t,e){if(t&&e&&(t.action===r.MESSAGE||t.action===r.PRESENCE)&&t.action===e.action&&t.channel===e.channel&&t.id===e.id){if(t.action===r.PRESENCE)return!0;if(t.messages.length===e.messages.length){for(var n=0;n<t.messages.length;n++){var i=t.messages[n],o=e.messages[n];if((i.extras&&i.extras.delta&&i.extras.delta.format)!==(o.extras&&o.extras.delta&&o.extras.delta.format))return!1}return!0}}return!1},s}();e.a=n},function(t,e,n){"use strict";var p=n(6),s=n(1),r=n(0),i=n(15),o=n.n(i),d=n(2),n=(a.prototype.toJSON=function(){var t,e={name:this.name,id:this.id,clientId:this.clientId,connectionId:this.connectionId,connectionKey:this.connectionKey,encoding:this.encoding,extras:this.extras},n=this.data;return n&&p.a.isBuffer(n)&&(n=0<arguments.length?(t=this.encoding,e.encoding=t?t+"/base64":"base64",p.a.base64Encode(n)):p.a.toBuffer(n)),e.data=n,e},a.prototype.toString=function(){var t="[Message";return this.name&&(t+="; name="+this.name),this.id&&(t+="; id="+this.id),this.timestamp&&(t+="; timestamp="+this.timestamp),this.clientId&&(t+="; clientId="+this.clientId),this.connectionId&&(t+="; connectionId="+this.connectionId),this.encoding&&(t+="; encoding="+this.encoding),this.extras&&(t+="; extras ="+JSON.stringify(this.extras)),this.data&&("string"==typeof this.data?t+="; data="+this.data:p.a.isBuffer(this.data)?t+="; data (buffer)="+p.a.base64Encode(this.data):t+="; data (json)="+JSON.stringify(this.data)),this.extras&&(t+="; extras="+JSON.stringify(this.extras)),t+="]"},a.encrypt=function(n,t,i){var e=n.data,o=n.encoding,s=t.channelCipher,o=o?o+"/":"";p.a.isBuffer(e)||(e=p.a.utf8Encode(String(e)),o+="utf-8/"),s.encrypt(e,function(t,e){t?i(t):(n.data=e,n.encoding=o+"cipher+"+s.algorithm,i(null,n))})},a.encode=function(t,e,n){var i=t.data;if(!("string"==typeof i||p.a.isBuffer(i)||null==i)){if(!s.a.isObject(i)&&!s.a.isArray(i))throw new d.a("Data type is unsupported",40013,400);t.data=JSON.stringify(i),t.encoding=(i=t.encoding)?i+"/json":"json"}null!=e&&e.cipher?a.encrypt(t,e,n):n(null,t)},a.encodeArray=function(n,t,i){for(var o=0,e=0;e<n.length;e++)a.encode(n[e],t,function(t,e){t?i(t):++o==n.length&&i(null,n)})},a.serialize=s.a.encodeBody,a.decode=function(t,e){e&&e.channelOptions||(e={channelOptions:e,plugins:{},baseEncodedPreviousPayload:void 0});var n=t.data,i=t.encoding;if(i){var o,s=i.split("/"),r=s.length,a=t.data;try{for(;0<(o=r);){var c=s[--r].match(/([\-\w]+)(\+([\w\-]+))?/);if(!c)break;var u=c[1];switch(u){case"base64":a=p.a.base64Decode(String(a)),o==s.length&&(n=a);continue;case"utf-8":a=p.a.utf8Decode(a);continue;case"json":a=JSON.parse(a);continue;case"cipher":if(null!=e.channelOptions&&e.channelOptions.cipher){var l=c[3],c=e.channelOptions.channelCipher;if(l!=c.algorithm)throw new Error("Unable to decrypt message with given cipher; incompatible cipher params");a=c.decrypt(a);continue}throw new Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!e.plugins||!e.plugins.vcdiff)throw new d.a("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if("undefined"==typeof Uint8Array)throw new d.a("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{var h=e.baseEncodedPreviousPayload;"string"==typeof h&&(h=p.a.utf8Encode(h)),h=p.a.toBuffer(h),a=p.a.toBuffer(a),n=a=p.a.typedArrayToBuffer(e.plugins.vcdiff.decode(a,h))}catch(t){throw new d.a("Vcdiff delta decode failed with "+t,40018,400)}continue;default:throw new Error("Unknown encoding")}break}}catch(t){throw new d.a("Error processing the "+u+" encoding, decoder returned ‘"+t.message+"’",t.code||40013,400)}finally{t.encoding=o<=0?null:s.slice(0,o).join("/"),t.data=a}}e.baseEncodedPreviousPayload=n},a.fromResponseBody=function(t,e,n){n&&(t=s.a.decodeBody(t,n));for(var i=0;i<t.length;i++){var o=t[i]=a.fromValues(t[i]);try{a.decode(o,e)}catch(t){r.a.logAction(r.a.LOG_ERROR,"Message.fromResponseBody()",t.toString())}}return t},a.fromValues=function(t){return s.a.mixin(new a,t)},a.fromValuesArray=function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i++)n[i]=a.fromValues(t[i]);return n},a.fromEncoded=function(t,e){var n=a.fromValues(t);c(e);try{a.decode(n,e)}catch(t){r.a.logAction(r.a.LOG_ERROR,"Message.fromEncoded()",t.toString())}return n},a.fromEncodedArray=function(t,e){return c(e),s.a.arrMap(t,function(t){return a.fromEncoded(t,e)})},a.getMessagesSize=function(t){for(var e,n,i=0,o=0;o<t.length;o++)i+=(e=t[o]).size||(e.size=(n=void 0,n=0,(e=e).name&&(n+=e.name.length),e.clientId&&(n+=e.clientId.length),e.extras&&(n+=JSON.stringify(e.extras).length),e.data&&(n+=s.a.dataSizeBytes(e.data)),n));return i},a);function a(){this.name=void 0,this.id=void 0,this.timestamp=void 0,this.clientId=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.data=void 0,this.encoding=void 0,this.extras=void 0,this.size=void 0}function c(t){if(t&&t.cipher&&!t.cipher.channelCipher){if(!o.a)throw new Error("Encryption not enabled; use ably.encryption.js instead");var e=o.a.getCipher(t.cipher);t.cipher=e.cipherParams,t.channelCipher=e.cipher}}e.a=n},function(t,e,n){"use strict";var i=n(3),r=n(0),o=n(6),a=n(9),c=n(1),n=function(){i.a.msgpack;function s(){this.action=void 0,this.id=void 0,this.timestamp=void 0,this.clientId=void 0,this.connectionId=void 0,this.data=void 0,this.encoding=void 0,this.size=void 0}return s.Actions=["absent","present","enter","leave","update"],s.prototype.isSynthesized=function(){return this.id.substring(this.connectionId.length,0)!==this.connectionId},s.prototype.parseId=function(){var t=this.id.split(":");return{connectionId:t[0],msgSerial:parseInt(t[1],10),index:parseInt(t[2],10)}},s.prototype.toJSON=function(){var t,e={clientId:this.clientId,action:(t=this.action,c.a.arrIndexOf(s.Actions,t)),encoding:this.encoding},n=this.data;return n&&o.a.isBuffer(n)&&(n=0<arguments.length?(t=this.encoding,e.encoding=t?t+"/base64":"base64",o.a.base64Encode(n)):o.a.toBuffer(n)),e.data=n,e},s.prototype.toString=function(){var t="[PresenceMessage";return t+="; action="+this.action,this.id&&(t+="; id="+this.id),this.timestamp&&(t+="; timestamp="+this.timestamp),this.clientId&&(t+="; clientId="+this.clientId),this.connectionId&&(t+="; connectionId="+this.connectionId),this.encoding&&(t+="; encoding="+this.encoding),this.data&&("string"==typeof this.data?t+="; data="+this.data:o.a.isBuffer(this.data)?t+="; data (buffer)="+o.a.base64Encode(this.data):t+="; data (json)="+JSON.stringify(this.data)),t+="]"},s.encode=a.a.encode,s.decode=a.a.decode,s.fromResponseBody=function(t,e,n){n&&(t=c.a.decodeBody(t,n));for(var i=0;i<t.length;i++){var o=t[i]=s.fromValues(t[i],!0);try{s.decode(o,e)}catch(t){r.a.logAction(r.a.LOG_ERROR,"PresenceMessage.fromResponseBody()",t.toString())}}return t},s.fromValues=function(t,e){return e&&(t.action=s.Actions[t.action]),c.a.mixin(new s,t)},s.fromValuesArray=function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i++)n[i]=s.fromValues(t[i]);return n},s.fromEncoded=function(t,e){var n=s.fromValues(t,!0);try{s.decode(n,e)}catch(t){r.a.logAction(r.a.LOG_ERROR,"PresenceMessage.fromEncoded()",t.toString())}return n},s.fromEncodedArray=function(t,e){return c.a.arrMap(t,function(t){return s.fromEncoded(t,e)})},s.getMessagesSize=a.a.getMessagesSize,s}();e.a=n},function(t,e,n){"use strict";n=n(2),n={disconnected:n.a.fromValues({statusCode:400,code:80003,message:"Connection to server temporarily unavailable"}),suspended:n.a.fromValues({statusCode:400,code:80002,message:"Connection to server unavailable"}),failed:n.a.fromValues({statusCode:400,code:8e4,message:"Connection failed or disconnected by server"}),closing:n.a.fromValues({statusCode:400,code:80017,message:"Connection closing"}),closed:n.a.fromValues({statusCode:400,code:80017,message:"Connection closed"}),unknownConnectionErr:n.a.fromValues({statusCode:500,code:50002,message:"Internal connection error"}),unknownChannelErr:n.a.fromValues({statusCode:500,code:50001,message:"Internal channel error"})};e.a=n},function(t,e,n){"use strict";var g=n(0),a=n(3),m=n(1),y=n(5),c=n(20),v=n(6),O=n(2),u=function(){function l(){this.buffer=[]}l.prototype.append=function(t){return this.buffer.push(t),this},l.prototype.toString=function(){return this.buffer.join("")};var h={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){for(var e=new l,n=h.codex,i=new p(t);i.moveNext();){var o=i.current;i.moveNext();var s=i.current;i.moveNext();var r=i.current,a=o>>2,c=(3&o)<<4|s>>4,u=(15&s)<<2|r>>6,o=63&r;isNaN(s)?u=o=64:isNaN(r)&&(o=64),e.append(n.charAt(a)+n.charAt(c)+n.charAt(u)+n.charAt(o))}return e.toString()},decode:function(t){for(var e=new l,n=new r(t);n.moveNext();){var i,o,s=n.current;s<128?e.append(String.fromCharCode(s)):191<s&&s<224?(n.moveNext(),i=n.current,e.append(String.fromCharCode((31&s)<<6|63&i))):(n.moveNext(),i=n.current,n.moveNext(),o=n.current,e.append(String.fromCharCode((15&s)<<12|(63&i)<<6|63&o)))}return e.toString()}};function p(t){this._input=t,this._index=-1,this._buffer=[]}function r(t){this._input=t,this._index=-1,this._buffer=[]}return p.prototype={current:Number.NaN,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=Number.NaN,!1;var t=this._input.charCodeAt(++this._index);return 13==t&&10==this._input.charCodeAt(this._index+1)&&(t=10,this._index+=2),t<128?this.current=t:(127<t&&t<2048?this.current=t>>6|192:(this.current=t>>12|224,this._buffer.push(t>>6&63|128)),this._buffer.push(63&t|128)),!0}},r.prototype={current:64,moveNext:function(){if(0<this._buffer.length)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return!(this.current=64);var t=h.codex.indexOf(this._input.charAt(++this._index)),e=h.codex.indexOf(this._input.charAt(++this._index)),n=h.codex.indexOf(this._input.charAt(++this._index)),i=h.codex.indexOf(this._input.charAt(++this._index)),o=t<<2|e>>4,t=(15&e)<<4|n>>2,e=(3&n)<<6|i;return this.current=o,64!=n&&this._buffer.push(t),64!=i&&this._buffer.push(e),!0}},h}(),i=n(32),l=n.n(i),R=n(22),n=function(){var h,i,p=Math.pow(2,17);function s(){}function d(t){return m.a.isErrorInfo(t)?(t.code||(403===t.statusCode?t.code=40300:(t.code=40170,t.statusCode=401)),t):new O.a(m.a.inspectError(t),t.code||40170,t.statusCode||401)}function f(t){if(!t)return"";"string"==typeof t&&(t=JSON.parse(t));var e={},n=m.a.keysArray(t,!0);if(!n)return"";n.sort();for(var i=0;i<n.length;i++)e[n[i]]=t[n[i]].sort();return JSON.stringify(e)}function o(t){if(t.authCallback)g.a.logAction(g.a.LOG_MINOR,"Auth()","using token auth with authCallback");else if(t.authUrl)g.a.logAction(g.a.LOG_MINOR,"Auth()","using token auth with authUrl");else if(t.key)g.a.logAction(g.a.LOG_MINOR,"Auth()","using token auth with client-side signing");else{if(!t.tokenDetails){t="authOptions must include valid authentication parameters";throw g.a.logAction(g.a.LOG_ERROR,"Auth()",t),new Error(t)}g.a.logAction(g.a.LOG_MINOR,"Auth()","using token auth with supplied token only")}}h=a.a.createHmac?(i=function(t){return Buffer.from(t,"ascii").toString("base64")},function(t,e){e=a.a.createHmac("SHA256",e);return e.update(t),e.digest("base64")}):(i=u.encode,function(t,e){return Object(R.stringify)(l()(t,e))});var r=0;function t(t,e){if(this.client=t,this.tokenParams=e.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,(i=e).useTokenAuth||(!("useTokenAuth"in(t=i))||t.useTokenAuth)&&(i.authCallback||i.authUrl||i.token||i.tokenDetails)){if(e.key&&!h){var n="client-side token request signing not supported";throw g.a.logAction(g.a.LOG_ERROR,"Auth()",n),new Error(n)}(i=e).key||i.authCallback||i.authUrl||g.a.logAction(g.a.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(e.defaultTokenParams,e),o(this.authOptions)}else{if(!e.key){n="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw g.a.logAction(g.a.LOG_ERROR,"Auth()",n),new O.a(n,40160,401)}g.a.logAction(g.a.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(e)}var i}return t.prototype.authorize=function(t,e,n){if("function"!=typeof t||n?"function"!=typeof e||n||(n=e,e=null):(n=t,e=t=null),!n){if(this.client.options.promises)return m.a.promisify(this,"authorize",arguments);n=s}var i=this;if(e&&e.key&&this.authOptions.key!==e.key)throw new O.a("Unable to update auth options with incompatible key",40102,401);e&&"force"in e&&(g.a.logAction(g.a.LOG_ERROR,"Auth.authorize","Deprecation warning: specifying {force: true} in authOptions is no longer necessary, authorize() now always gets a new token. Please remove this, as in version 1.0 and later, having a non-null authOptions will overwrite stored library authOptions, which may not be what you want"),m.a.isOnlyPropIn(e,"force")&&(e=null)),this._forceNewToken(t,e,function(t,e){return t?(i.client.connection&&i.client.connection.connectionManager.actOnErrorFromAuthorize(t),void n(t)):void(i.client.connection?i.client.connection.connectionManager.onAuthUpdated(e,n):n(null,e))})},t.prototype.authorise=function(){g.a.deprecated("Auth.authorise","Auth.authorize"),this.authorize.apply(this,arguments)},t.prototype._forceNewToken=function(t,e,n){var i=this;this.tokenDetails=null,this._saveTokenOptions(t,e),o(this.authOptions),this._ensureValidAuthCredentials(!0,function(t,e){delete i.tokenParams.timestamp,delete i.authOptions.queryTime,n(t,e)})},t.prototype.requestToken=function(t,r,a){if("function"!=typeof t||a?"function"!=typeof r||a||(a=r,r=null):(a=t,r=t=null),!a&&this.client.options.promises)return m.a.promisify(this,"requestToken",arguments);r=r||this.authOptions,t=t||m.a.copy(this.tokenParams),a=a||s;var e,c=this.client;if(r.authCallback)g.a.logAction(g.a.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),e=r.authCallback;else if(r.authUrl)g.a.logAction(g.a.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),e=function(t,s){var e=m.a.mixin({accept:"application/json, text/plain"},r.authHeaders),n=r.authMethod&&"post"===r.authMethod.toLowerCase();n||-1<(i=r.authUrl.indexOf("?"))&&(o=m.a.parseQueryString(r.authUrl.slice(i)),r.authUrl=r.authUrl.slice(0,i),r.authParams=m.a.mixin(o,r.authParams));var i=m.a.mixin({},r.authParams||{},t),o=function(t,e,n,i){var o;if(t?g.a.logAction(g.a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+m.a.inspectError(t)):(o=n["content-type"],g.a.logAction(g.a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+o+"; body: "+m.a.inspectBody(e))),t||i)return s(t,e);if(v.a.isBuffer(e)&&(e=e.toString()),o){i=-1<o.indexOf("application/json"),t=-1<o.indexOf("text/plain")||-1<o.indexOf("application/jwt");if(i||t){if(i){if(e.length>p)return void s(new O.a("authUrl response exceeded max permitted length",40170,401));try{e=JSON.parse(e)}catch(t){return void s(new O.a("Unexpected error processing authURL response; err = "+t.message,40170,401))}}s(null,e,o)}else s(new O.a("authUrl responded with unacceptable content-type "+o+", should be either text/plain, application/jwt or application/json",40170,401))}else s(new O.a("authUrl response is missing a content-type header",40170,401))};g.a.logAction(g.a.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+r.authUrl+"; Params: "+JSON.stringify(i)+"; method: "+(n?"POST":"GET")),n?((t=e||{})["content-type"]="application/x-www-form-urlencoded",n=m.a.toQueryString(i).slice(1),y.a.postUri(c,r.authUrl,t,n,{},o)):y.a.getUri(c,r.authUrl,e||{},i,o)};else{if(!r.key)return g.a.logAction(g.a.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),void a(new O.a("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)",40171,403));var n=this;g.a.logAction(g.a.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),e=function(t,e){n.createTokenRequest(t,r,e)}}"capability"in t&&(t.capability=f(t.capability));var u=!1,i=this.client.options.timeouts.realtimeRequestTimeout,l=setTimeout(function(){u=!0;var t="Token request callback timed out after "+i/1e3+" seconds";g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()",t),a(new O.a(t,40170,401))},i);e(t,function(t,e,n){if(!u){if(clearTimeout(l),t)return g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+m.a.inspectError(t)),void a(d(t));if("string"!=typeof e){if("object"!=typeof e){var i="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof e;return g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()",i),void a(new O.a(i,40170,401))}var o,s=JSON.stringify(e).length;if(p<s&&!r.suppressMaxLengthCheck)a(new O.a("Token request/details object exceeded max permitted stringified size (was "+s+" bytes)",40170,401));else if("issued"in e)a(null,e);else{if(!("keyName"in e)){var i="Expected token request callback to call back with a token string, token request object, or token details object";return g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()",i),void a(new O.a(i,40170,401))}t=function(t,e,n,i){return t?(g.a.logAction(g.a.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+m.a.inspectError(t)),void a(d(t))):(i||(e=JSON.parse(e)),g.a.logAction(g.a.LOG_MINOR,"Auth.getToken()","token received"),void a(null,e))},o="/keys/"+(s=e).keyName+"/requestToken",i=m.a.defaultPostHeaders(),r.requestHeaders&&m.a.mixin(i,r.requestHeaders),g.a.logAction(g.a.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+o+"; Token params: "+JSON.stringify(s)),s=JSON.stringify(s),y.a.post(c,function(t){return c.baseUri(t)+o},i,s,null,t)}}else 0===e.length?a(new O.a("Token string is empty",40170,401)):e.length>p?a(new O.a("Token string exceeded max permitted length (was "+e.length+" bytes)",40170,401)):"undefined"===e||"null"===e?a(new O.a("Token string was literal null/undefined",40170,401)):"{"!==e[0]||n&&-1<n.indexOf("application/jwt")?a(null,{token:e}):a(new O.a("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401))}})},t.prototype.createTokenRequest=function(t,e,n){if("function"!=typeof t||n?"function"!=typeof e||n||(n=e,e=null):(n=t,e=t=null),!n&&this.client.options.promises)return m.a.promisify(this,"createTokenRequest",arguments);e=e||this.authOptions,t=t||m.a.copy(this.tokenParams);var i,o,s,r,a,c,u,l=e.key;l?(l=(i=l.split(":"))[0],(o=i[1])?""!==t.clientId?("capability"in t&&(t.capability=f(t.capability)),s=m.a.mixin({keyName:l},t),r=t.clientId||"",a=t.ttl||"",c=t.capability||"",t=this,u=function(){var t=s.nonce||(s.nonce=("000000"+Math.floor(1e16*Math.random())).slice(-16)),e=s.timestamp,t=s.keyName+"\n"+a+"\n"+c+"\n"+r+"\n"+e+"\n"+t+"\n";s.mac=s.mac||h(t,o),g.a.logAction(g.a.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),n(null,s)},s.timestamp?u():t.getTimestamp(e&&e.queryTime,function(t,e){t?n(t):(s.timestamp=e,u())})):n(new O.a("clientId can’t be an empty string",40012,400)):n(new O.a("Invalid key specified",40101,403))):n(new O.a("No key specified",40101,403))},t.prototype.getAuthParams=function(n){"basic"==this.method?n(null,{key:this.key}):this._ensureValidAuthCredentials(!1,function(t,e){t?n(t):n(null,{access_token:e.token})})},t.prototype.getAuthHeaders=function(n){"basic"==this.method?n(null,{authorization:"Basic "+this.basicKey}):this._ensureValidAuthCredentials(!1,function(t,e){t?n(t):n(null,{authorization:"Bearer "+i(e.token)})})},t.prototype.getTimestamp=function(t,e){this.isTimeOffsetSet()||!t&&!this.authOptions.queryTime?e(null,this.getTimestampUsingOffset()):this.client.time(e)},t.prototype.getTimestampUsingOffset=function(){return m.a.now()+(this.client.serverTimeOffset||0)},t.prototype.isTimeOffsetSet=function(){return null!==this.client.serverTimeOffset},t.prototype._saveBasicOptions=function(t){this.method="basic",this.key=t.key,this.basicKey=i(t.key),this.authOptions=t||{},"clientId"in t&&this._userSetClientId(t.clientId)},t.prototype._saveTokenOptions=function(t,e){this.method="token",t&&(this.tokenParams=t),e&&(e.token&&(e.tokenDetails="string"==typeof e.token?{token:e.token}:e.token),e.tokenDetails&&(this.tokenDetails=e.tokenDetails),"clientId"in e&&this._userSetClientId(e.clientId),this.authOptions=e)},t.prototype._ensureValidAuthCredentials=function(t,e){var i,o=this,n=this.tokenDetails;if(n){if(this._tokenClientIdMismatch(n.clientId))return void e(new O.a("Mismatch between clientId in token ("+n.clientId+") and current clientId ("+this.clientId+")",40102,403));if(!this.isTimeOffsetSet()||!n.expires||n.expires>=this.getTimestampUsingOffset())return g.a.logAction(g.a.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+n.expires),void e(null,n);g.a.logAction(g.a.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}(this.waitingForTokenRequest||(this.waitingForTokenRequest=Object(c.a)())).push(e),null!==this.currentTokenRequestId&&!t||(i=this.currentTokenRequestId=r++,this.requestToken(this.tokenParams,this.authOptions,function(t,e){var n;o.currentTokenRequestId>i?g.a.logAction(g.a.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"):(o.currentTokenRequestId=null,n=o.waitingForTokenRequest||s,o.waitingForTokenRequest=null,t?n(t):n(null,o.tokenDetails=e))}))},t.prototype._userSetClientId=function(t){if("string"!=typeof t&&null!==t)throw new O.a("clientId must be either a string or null",40012,400);if("*"===t)throw new O.a('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);t=this._uncheckedSetClientId(t);if(t)throw t},t.prototype._uncheckedSetClientId=function(t){if(this._tokenClientIdMismatch(t)){var e="Unexpected clientId mismatch: client has "+this.clientId+", requested "+t,n=new O.a(e,40102,401);return g.a.logAction(g.a.LOG_ERROR,"Auth._uncheckedSetClientId()",e),n}return this.clientId=this.tokenParams.clientId=t,null},t.prototype._tokenClientIdMismatch=function(t){return this.clientId&&"*"!==this.clientId&&t&&"*"!==t&&this.clientId!==t},t.isTokenErr=function(t){return t.code&&40140<=t.code&&t.code<40150},t}();e.a=n},function(t,e,n){"use strict";var r=n(1),i=n(8),a=n(16),c=n(0),u=n(4),o=n(11),s=n(12),l=n(2),n=(r.a.inherits(p,a.a),p.REQ_SEND=0,p.REQ_RECV=1,p.REQ_RECV_POLL=2,p.REQ_RECV_STREAM=3,p.prototype.connect=function(){c.a.logAction(c.a.LOG_MINOR,"CometTransport.connect()","starting"),a.a.prototype.connect.call(this);var o=this,t=this.params,e=t.options,n=u.a.getHost(e,t.host),t=u.a.getPort(e),e=e.tls?"https://":"http://";this.baseUri=e+n+":"+t+"/comet/";var s=this.baseUri+"connect";c.a.logAction(c.a.LOG_MINOR,"CometTransport.connect()","uri: "+s),this.auth.getAuthParams(function(t,e){var i;t?o.disconnect(t):o.isDisposed||(o.authParams=e,"stream"in(e=o.params.getConnectParams(e))&&(o.stream=e.stream),c.a.logAction(c.a.LOG_MINOR,"CometTransport.connect()","connectParams:"+r.a.toQueryString(e)),i=!1,(e=o.recvRequest=o.createRequest(s,null,e,null,o.stream?3:1)).on("data",function(t){o.recvRequest&&(i||(i=!0,o.emit("preconnect")),o.onData(t))}),e.on("complete",function(t,e,n){o.recvRequest||(t=t||new l.a("Request cancelled",80003,400)),o.recvRequest=null,i||t||(i=!0,o.emit("preconnect")),o.onActivity(),t?t.code?o.onData(h(t)):o.disconnect(t):r.a.nextTick(function(){o.recv()})}),e.exec())})},p.prototype.requestClose=function(){c.a.logAction(c.a.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)},p.prototype.requestDisconnect=function(){c.a.logAction(c.a.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)},p.prototype._requestCloseOrDisconnect=function(e){var n,t=e?this.closeUri:this.disconnectUri;t&&((t=(n=this).createRequest(t,null,this.authParams,null,0)).on("complete",function(t){t&&(c.a.logAction(c.a.LOG_ERROR,"CometTransport.request"+(e?"Close()":"Disconnect()"),"request returned err = "+r.a.inspectError(t)),n.finish("disconnected",t))}),t.exec())},p.prototype.dispose=function(){var t;c.a.logAction(c.a.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(c.a.logAction(c.a.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",o.a.disconnected),t=this,r.a.nextTick(function(){t.emit("disposed")}))},p.prototype.onConnect=function(t){var e;this.isDisposed||(e=t.connectionKey,a.a.prototype.onConnect.call(this,t),e=this.baseUri+e,c.a.logAction(c.a.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+e+"; connectionKey = "+t.connectionKey),this.sendUri=e+"/send",this.recvUri=e+"/recv",this.closeUri=e+"/close",this.disconnectUri=e+"/disconnect")},p.prototype.send=function(t){if(this.sendRequest)return this.pendingItems=this.pendingItems||[],void this.pendingItems.push(t);var e=this.pendingItems||[];e.push(t),this.pendingItems=null,this.sendItems(e)},p.prototype.sendAnyPending=function(){var t=this.pendingItems;t&&(this.pendingItems=null,this.sendItems(t))},p.prototype.sendItems=function(t){var n=this,t=this.sendRequest=n.createRequest(n.sendUri,null,n.authParams,this.encodeRequest(t),0);t.on("complete",function(t,e){t&&c.a.logAction(c.a.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+r.a.inspectError(t)),n.sendRequest=null,t?t.code?n.onData(h(t)):n.disconnect(t):(e&&n.onData(e),n.pendingItems&&r.a.nextTick(function(){n.sendRequest||n.sendAnyPending()}))}),t.exec()},p.prototype.recv=function(){var e,t;this.recvRequest||this.isConnected&&((t=(e=this).recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,e.stream?3:2)).on("data",function(t){e.onData(t)}),t.on("complete",function(t){e.recvRequest=null,e.onActivity(),t?t.code?e.onData(h(t)):e.disconnect(t):r.a.nextTick(function(){e.recv()})}),t.exec())},p.prototype.onData=function(t){try{var e=this.decodeResponse(t);if(e&&e.length)for(var n=0;n<e.length;n++)this.onProtocolMessage(i.a.fromDeserialized(e[n]))}catch(t){c.a.logAction(c.a.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+t.stack)}},p.prototype.encodeRequest=function(t){return JSON.stringify(t)},p.prototype.decodeResponse=function(t){return"string"==typeof t&&(t=JSON.parse(t)),t},p.prototype.onAuthUpdated=function(t){this.authParams={access_token:t.token}},p);function h(t){return(e=t).code&&(!s.a.isTokenErr(e)&&(r.a.arrIn([80015,80017,80030],e.code)||4e4<=e.code&&e.code<5e4))?[i.a.fromValues({action:i.a.Action.ERROR,error:t})]:[i.a.fromValues({action:i.a.Action.DISCONNECTED,error:t})];var e}function p(t,e,n){n.format=void 0,n.heartbeats=!0,a.a.call(this,t,e,n),this.stream=!("stream"in n)||n.stream,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}e.a=n},function(t,e,n){"use strict";(function(c){var u=n(1),t=function(){var e,n,t="ablyjs-storage-test";try{c.sessionStorage.setItem(t,t),c.sessionStorage.removeItem(t),e=!0}catch(t){e=!1}try{c.localStorage.setItem(t,t),c.localStorage.removeItem(t),n=!0}catch(t){n=!1}function i(){}function o(t){return t?c.sessionStorage:c.localStorage}function s(t,e,n,i){e={value:e};return n&&(e.expires=u.a.now()+n),o(i).setItem(t,JSON.stringify(e))}function r(t,e){var n=o(e).getItem(t);if(!n)return null;n=JSON.parse(n);return n.expires&&n.expires<u.a.now()?(o(e).removeItem(t),null):n.value}function a(t,e){return o(e).removeItem(t)}return n&&(i.set=function(t,e,n){return s(t,e,n,!1)},i.get=function(t){return r(t,!1)},i.remove=function(t){return a(t,!1)}),e&&(i.setSession=function(t,e,n){return s(t,e,n,!0)},i.getSession=function(t){return r(t,!0)},i.removeSession=function(t){return a(t,!0)}),i}();e.a=t}).call(this,n(17))},function(t,e){},function(t,e,n){"use strict";var i,o,s,r=n(8),a=n(1),c=n(7),u=n(0),l=n(11),h=n(2),n=(i=r.a.Action,o=r.a.fromValues({action:i.CLOSE}),s=r.a.fromValues({action:i.DISCONNECT}),a.a.inherits(p,c.a),p.prototype.connect=function(){},p.prototype.close=function(){this.isConnected&&this.requestClose(),this.finish("closed",l.a.closed)},p.prototype.disconnect=function(t){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",t||l.a.disconnected)},p.prototype.fail=function(t){this.isConnected&&this.requestDisconnect(),this.finish("failed",t||l.a.failed)},p.prototype.finish=function(t,e){this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout(this.idleTimer),this.idleTimer=null,this.emit(t,e),this.dispose())},p.prototype.onProtocolMessage=function(t){switch(u.a.shouldLog(u.a.LOG_MICRO)&&u.a.logAction(u.a.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+r.a.stringify(t)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),t.action){case i.HEARTBEAT:u.a.logAction(u.a.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",t.id);break;case i.CONNECTED:this.onConnect(t),this.emit("connected",t.error,t.connectionId,t.connectionDetails,t);break;case i.CLOSED:this.onClose(t);break;case i.DISCONNECTED:this.onDisconnect(t);break;case i.ACK:this.emit("ack",t.msgSerial,t.count);break;case i.NACK:this.emit("nack",t.msgSerial,t.count,t.error);break;case i.SYNC:if(void 0!==t.connectionId){this.emit("sync",t.connectionId,t);break}this.connectionManager.onChannelMessage(t,this);break;case i.AUTH:this.auth.authorize(function(t){t&&u.a.logAction(u.a.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+a.a.inspectError(t))});break;case i.ERROR:if(u.a.logAction(u.a.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+a.a.inspect(t.error)+(t.channel?", channel: "+t.channel:"")),void 0===t.channel){this.onFatalError(t);break}this.connectionManager.onChannelMessage(t,this);break;default:this.connectionManager.onChannelMessage(t,this)}},p.prototype.onConnect=function(t){this.isConnected=!0;t=t.connectionDetails.maxIdleInterval;t&&(this.maxIdleInterval=t+this.timeouts.realtimeRequestTimeout,this.onActivity())},p.prototype.onDisconnect=function(t){t=t&&t.error;u.a.logAction(u.a.LOG_MINOR,"Transport.onDisconnect()","err = "+a.a.inspectError(t)),this.finish("disconnected",t)},p.prototype.onFatalError=function(t){t=t&&t.error;u.a.logAction(u.a.LOG_MINOR,"Transport.onFatalError()","err = "+a.a.inspectError(t)),this.finish("failed",t)},p.prototype.onClose=function(t){t=t&&t.error;u.a.logAction(u.a.LOG_MINOR,"Transport.onClose()","err = "+a.a.inspectError(t)),this.finish("closed",t)},p.prototype.requestClose=function(){u.a.logAction(u.a.LOG_MINOR,"Transport.requestClose()",""),this.send(o)},p.prototype.requestDisconnect=function(){u.a.logAction(u.a.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(s)},p.prototype.ping=function(t){var e={action:r.a.Action.HEARTBEAT};t&&(e.id=t),this.send(r.a.fromValues(e))},p.prototype.dispose=function(){u.a.logAction(u.a.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()},p.prototype.onActivity=function(){this.maxIdleInterval&&(this.lastActivity=this.connectionManager.lastActivity=a.a.now(),this.setIdleTimer(this.maxIdleInterval+100))},p.prototype.setIdleTimer=function(t){var e=this;this.idleTimer||(this.idleTimer=setTimeout(function(){e.onIdleTimerExpire()},t))},p.prototype.onIdleTimerExpire=function(){this.idleTimer=null;var t=a.a.now()-this.lastActivity,e=this.maxIdleInterval-t;e<=0?(t="No activity seen from realtime in "+t+"ms; assuming connection has dropped",u.a.logAction(u.a.LOG_ERROR,"Transport.onIdleTimerExpire()",t),this.disconnect(new h.a(t,80003,408))):this.setIdleTimer(100+e)},p.prototype.onAuthUpdated=function(){},p);function p(t,e,n){c.a.call(this),(this.connectionManager=t).registerProposedTransport(this),this.auth=e,this.params=n,this.timeouts=n.options.timeouts,this.format=n.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}e.a=n},function(t,e){var n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(e,t,g){(function(f){var t;e.exports=(t=function(u){var i;if("undefined"!=typeof window&&window.crypto&&(i=window.crypto),!i&&"undefined"!=typeof window&&window.msCrypto&&(i=window.msCrypto),!i&&void 0!==f&&f.crypto&&(i=f.crypto),!i)try{i=g(36)}catch(t){}var n=Object.create||function(t){return e.prototype=t,t=new e,e.prototype=null,t};function e(){}var t={},o=t.lib={},s=o.Base={extend:function(t){var e=n(this);return t&&e.mixIn(t),e.hasOwnProperty("init")&&this.init!==e.init||(e.init=function(){e.$super.init.apply(this,arguments)}),(e.init.prototype=e).$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},l=o.WordArray=s.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,n=t.words,i=this.sigBytes,o=t.sigBytes;if(this.clamp(),i%4)for(var s=0;s<o;s++){var r=n[s>>>2]>>>24-s%4*8&255;e[i+s>>>2]|=r<<24-(i+s)%4*8}else for(s=0;s<o;s+=4)e[i+s>>>2]=n[s>>>2];return this.sigBytes+=o,this},clamp:function(){var t=this.words,e=this.sigBytes;t[e>>>2]&=4294967295<<32-e%4*8,t.length=u.ceil(e/4)},clone:function(){var t=s.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var e=[],n=0;n<t;n+=4)e.push(function(){if(i){if("function"==typeof i.getRandomValues)try{return i.getRandomValues(new Uint32Array(1))[0]}catch(t){}if("function"==typeof i.randomBytes)try{return i.randomBytes(4).readInt32LE()}catch(t){}}throw new Error("Native crypto module could not be used to get secure random number.")}());return new l.init(e,t)}}),r=t.enc={},a=r.Hex={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],o=0;o<n;o++){var s=e[o>>>2]>>>24-o%4*8&255;i.push((s>>>4).toString(16)),i.push((15&s).toString(16))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i+=2)n[i>>>3]|=parseInt(t.substr(i,2),16)<<24-i%8*4;return new l.init(n,e/2)}},c=r.Latin1={stringify:function(t){for(var e=t.words,n=t.sigBytes,i=[],o=0;o<n;o++){var s=e[o>>>2]>>>24-o%4*8&255;i.push(String.fromCharCode(s))}return i.join("")},parse:function(t){for(var e=t.length,n=[],i=0;i<e;i++)n[i>>>2]|=(255&t.charCodeAt(i))<<24-i%4*8;return new l.init(n,e)}},h=r.Utf8={stringify:function(t){try{return decodeURIComponent(escape(c.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return c.parse(unescape(encodeURIComponent(t)))}},p=o.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new l.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=h.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(t){var e,n=this._data,i=n.words,o=n.sigBytes,s=this.blockSize,r=o/(4*s),a=(r=t?u.ceil(r):u.max((0|r)-this._minBufferSize,0))*s,o=u.min(4*a,o);if(a){for(var c=0;c<a;c+=s)this._doProcessBlock(i,c);e=i.splice(0,a),n.sigBytes-=o}return new l.init(e,o)},clone:function(){var t=s.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),d=(o.Hasher=p.extend({cfg:s.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(n){return function(t,e){return new n.init(e).finalize(t)}},_createHmacHelper:function(n){return function(t,e){return new d.HMAC.init(n,e).finalize(t)}}}),t.algo={});return t}(Math),t)}).call(this,g(17))},function(t,e,n){"use strict";function i(t,e,n,i){this.previous=t,this.current=e,n&&(this.retryIn=n),i&&(this.reason=i)}e.a=i},function(t,e,n){"use strict";var i=n(0),n=function(n){function t(){for(var t=0;t<n.length;t++){var e=n[t];if(e)try{e.apply(null,arguments)}catch(t){i.a.logAction(i.a.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+t+"; stack = "+t.stack)}}}return n=n||[],t.push=function(){Array.prototype.push.apply(n,arguments)},t};e.a=n},function(t,e,n){"use strict";var o=n(1),s=n(3),r=n(4),a=n(0),c=n(5),n=function(){function t(){}t.levels=["fatal","error","warning","info","debug"];return t.report=function(t,e,n,i){n={event_id:o.a.randomHexString(16),tags:o.a.mixin({lib:s.a.libver},i),platform:"javascript",level:t,release:r.a.version,fingerprint:n&&[n],message:e,request:{headers:{"User-Agent":s.a.userAgent},url:s.a.currentUrl}};a.a.logAction(a.a.LOG_MICRO,"ErrorReporter","POSTing to error reporter: "+e),c.a.postUri(null,r.a.errorReportingUrl,r.a.errorReportingHeaders,JSON.stringify(n),{},function(t,e){a.a.logAction(a.a.LOG_MICRO,"ErrorReporter","POSTing to error reporter resulted in: "+(t?o.a.inspectError(t):o.a.inspectBody(e)))})},t}();e.a=n},function(t,e,n){var i;t.exports=(i=n(18),function(){var c=i.lib.WordArray;i.enc.Base64={stringify:function(t){var e=t.words,n=t.sigBytes,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";t.clamp();for(var o=[],s=0;s<n;s+=3)for(var r=(e[s>>>2]>>>24-s%4*8&255)<<16|(e[s+1>>>2]>>>24-(s+1)%4*8&255)<<8|e[s+2>>>2]>>>24-(s+2)%4*8&255,a=0;a<4&&s+.75*a<n;a++)o.push(i.charAt(r>>>6*(3-a)&63));var c=i.charAt(64);if(c)for(;o.length%4;)o.push(c);return o.join("")},parse:function(t){var e=t.length,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=this._reverseMap;if(!i){i=this._reverseMap=[];for(var o=0;o<n.length;o++)i[n.charCodeAt(o)]=o}var s=n.charAt(64);return!s||-1!==(s=t.indexOf(s))&&(e=s),function(t,e,n){for(var i=[],o=0,s=0;s<e;s++){var r,a;s%4&&(r=n[t.charCodeAt(s-1)]<<s%4*2,a=n[t.charCodeAt(s)]>>>6-s%4*2,a=r|a,i[o>>>2]|=a<<24-o%4*8,o++)}return c.create(i,o)}(t,e,i)}}}(),i.enc.Base64)},function(t,e,n){"use strict";var i=function(){var t={};function p(t,e,n){t.byteLength;for(var i=0,o=n.length;i<o;i++){var s=n.charCodeAt(i);if(s<128)t.setUint8(e++,s>>>0&127|0);else if(s<2048)t.setUint8(e++,s>>>6&31|192),t.setUint8(e++,s>>>0&63|128);else if(s<65536)t.setUint8(e++,s>>>12&15|224),t.setUint8(e++,s>>>6&63|128),t.setUint8(e++,s>>>0&63|128);else{if(!(s<1114112))throw new Error("bad codepoint "+s);t.setUint8(e++,s>>>18&7|240),t.setUint8(e++,s>>>12&63|128),t.setUint8(e++,s>>>6&63|128),t.setUint8(e++,s>>>0&63|128)}}}function n(t,e,n){for(var i="",o=e,s=e+n;o<s;o++){var r=t.getUint8(o);if(0!=(128&r))if(192!=(224&r))if(224!=(240&r)){if(240!=(248&r))throw new Error("Invalid byte "+r.toString(16));i+=String.fromCharCode((7&r)<<18|(63&t.getUint8(++o))<<12|(63&t.getUint8(++o))<<6|(63&t.getUint8(++o))<<0)}else i+=String.fromCharCode((15&r)<<12|(63&t.getUint8(++o))<<6|(63&t.getUint8(++o))<<0);else i+=String.fromCharCode((15&r)<<6|63&t.getUint8(++o));else i+=String.fromCharCode(r)}return i}function d(t){for(var e=0,n=0,i=t.length;n<i;n++){var o=t.charCodeAt(n);if(o<128)e+=1;else if(o<2048)e+=2;else if(o<65536)e+=3;else{if(!(o<1114112))throw new Error("bad codepoint "+o);e+=4}}return e}t.inspect=function(t){if(void 0===t)return"undefined";var e,n;t instanceof ArrayBuffer?(n="ArrayBuffer",e=new DataView(t)):t instanceof DataView&&(n="DataView",e=t);if(!e)return JSON.stringify(t);for(var i=[],o=0;o<t.byteLength;o++){if(20<o){i.push("...");break}var s=e.getUint8(o).toString(16);1===s.length&&(s="0"+s),i.push(s)}return"<"+n+" "+i.join(" ")+">"},t.utf8Write=p,t.utf8Read=n,t.utf8ByteCount=d,t.encode=function(t,e){var n=function t(e,n){var i=typeof e;if("string"==i){var o=d(e);if(o<32)return 1+o;if(o<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}ArrayBuffer.isView&&ArrayBuffer.isView(e)&&(e=e.buffer);if(e instanceof ArrayBuffer){var o=e.byteLength;if(o<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}if("number"==i){if(Math.floor(e)!==e)return 9;if(0<=e){if(e<128)return 1;if(e<256)return 2;if(e<65536)return 3;if(e<4294967296)return 5;if(e<0x10000000000000000)return 9;throw new Error("Number too big 0x"+e.toString(16))}if(-32<=e)return 1;if(-128<=e)return 2;if(-32768<=e)return 3;if(-2147483648<=e)return 5;if(-0x8000000000000000<=e)return 9;throw new Error("Number too small -0x"+e.toString(16).substr(1))}if("boolean"==i)return 1;if(null===e)return n?0:1;if(void 0===e)return n?0:3;if("function"==typeof e.toJSON)return t(e.toJSON(),n);if("object"==i){var s=0;if(Array.isArray(e)){o=e.length;for(var r=0;r<o;r++)s+=t(e[r],n)}else{var a=m(e,n);o=a.length;for(var r=0;r<o;r++){var c=a[r];s+=t(c)+t(e[c],n)}}if(o<16)return 1+s;if(o<65536)return 3+s;if(o<4294967296)return 5+s;throw new Error("Array or object too long 0x"+o.toString(16))}if("function"==i)return 0;throw new Error("Unknown type "+i)}(t,e);if(0!=n){n=new ArrayBuffer(n);return function t(e,n,i,o){var s=typeof e;if("string"==s){var r=d(e);if(r<32)return n.setUint8(i,160|r),p(n,i+1,e),1+r;if(r<256)return n.setUint8(i,217),n.setUint8(i+1,r),p(n,i+2,e),2+r;if(r<65536)return n.setUint8(i,218),n.setUint16(i+1,r),p(n,i+3,e),3+r;if(r<4294967296)return n.setUint8(i,219),n.setUint32(i+1,r),p(n,i+5,e),5+r}ArrayBuffer.isView&&ArrayBuffer.isView(e)&&(e=e.buffer);if(e instanceof ArrayBuffer){var r=e.byteLength;if(r<256)return n.setUint8(i,196),n.setUint8(i+1,r),new Uint8Array(n.buffer).set(new Uint8Array(e),i+2),2+r;if(r<65536)return n.setUint8(i,197),n.setUint16(i+1,r),new Uint8Array(n.buffer).set(new Uint8Array(e),i+3),3+r;if(r<4294967296)return n.setUint8(i,198),n.setUint32(i+1,r),new Uint8Array(n.buffer).set(new Uint8Array(e),i+5),5+r}if("number"==s){if(Math.floor(e)!==e)return n.setUint8(i,203),n.setFloat64(i+1,e),9;if(0<=e){if(e<128)return n.setUint8(i,e),1;if(e<256)return n.setUint8(i,204),n.setUint8(i+1,e),2;if(e<65536)return n.setUint8(i,205),n.setUint16(i+1,e),3;if(e<4294967296)return n.setUint8(i,206),n.setUint32(i+1,e),5;if(e<0x10000000000000000)return n.setUint8(i,207),g(n,i+1,e),9;throw new Error("Number too big 0x"+e.toString(16))}if(-32<=e)return n.setInt8(i,e),1;if(-128<=e)return n.setUint8(i,208),n.setInt8(i+1,e),2;if(-32768<=e)return n.setUint8(i,209),n.setInt16(i+1,e),3;if(-2147483648<=e)return n.setUint8(i,210),n.setInt32(i+1,e),5;if(-0x8000000000000000<=e)return n.setUint8(i,211),f(n,i+1,e),9;throw new Error("Number too small -0x"+(-e).toString(16).substr(1))}if("undefined"==s)return o?0:(n.setUint8(i,212),n.setUint8(i+1,0),n.setUint8(i+2,0),3);if(null===e)return o?0:(n.setUint8(i,192),1);if("boolean"==s)return n.setUint8(i,e?195:194),1;if("function"==typeof e.toJSON)return t(e.toJSON(),n,i,o);if("object"==s){var a,c=0,u=Array.isArray(e);if((r=u?e.length:(a=m(e,o)).length)<16?(n.setUint8(i,r|(u?144:128)),c=1):r<65536?(n.setUint8(i,u?220:222),n.setUint16(i+1,r),c=3):r<4294967296&&(n.setUint8(i,u?221:223),n.setUint32(i+1,r),c=5),u)for(var l=0;l<r;l++)c+=t(e[l],n,i+c,o);else for(var l=0;l<r;l++){var h=a[l];c+=t(h,n,i+c),c+=t(e[h],n,i+c,o)}return c}if("function"==s)return 0;throw new Error("Unknown type "+s)}(t,new DataView(n),0,e),n}},t.decode=function(t){var e=new o(new DataView(t)),n=e.parse();if(e.offset!==t.byteLength)throw new Error(t.byteLength-e.offset+" trailing bytes");return n};var s=4294967296,i=1/s;function f(t,e,n){n<0x8000000000000000?(t.setInt32(e,Math.floor(n*i)),t.setInt32(e+4,-1&n)):(t.setUint32(e,2147483647),t.setUint32(e+4,2147483647))}function g(t,e,n){n<0x10000000000000000?(t.setUint32(e,Math.floor(n*i)),t.setInt32(e+4,-1&n)):(t.setUint32(e,4294967295),t.setUint32(e+4,4294967295))}function o(t,e){this.offset=e||0,this.view=t}function m(e,n){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(t);return i.filter(function(t){t=e[t];return!(n&&null==t||"function"==typeof t&&!t.toJSON)})}return o.prototype.map=function(t){for(var e={},n=0;n<t;n++)e[this.parse()]=this.parse();return e},o.prototype.bin=o.prototype.buf=function(t){var e=new ArrayBuffer(t);return new Uint8Array(e).set(new Uint8Array(this.view.buffer,this.offset,t),0),this.offset+=t,e},o.prototype.str=function(t){var e=n(this.view,this.offset,t);return this.offset+=t,e},o.prototype.array=function(t){for(var e=new Array(t),n=0;n<t;n++)e[n]=this.parse();return e},o.prototype.ext=function(t){var e={};return e.type=this.view.getInt8(this.offset),this.offset++,e.data=this.buf(t),this.offset+=t,e},o.prototype.parse=function(){var t,e,n,i,o=this.view.getUint8(this.offset);if(0==(128&o))return this.offset++,o;if(128==(240&o))return e=15&o,this.offset++,this.map(e);if(144==(240&o))return e=15&o,this.offset++,this.array(e);if(160==(224&o))return e=31&o,this.offset++,this.str(e);if(224==(224&o))return t=this.view.getInt8(this.offset),this.offset++,t;switch(o){case 192:return this.offset++,null;case 193:return void this.offset++;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return e=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(e);case 197:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(e);case 198:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(e);case 199:return e=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(e);case 200:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(e);case 201:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(e);case 202:return t=this.view.getFloat32(this.offset+1),this.offset+=5,t;case 203:return t=this.view.getFloat64(this.offset+1),this.offset+=9,t;case 204:return t=this.view.getUint8(this.offset+1),this.offset+=2,t;case 205:return t=this.view.getUint16(this.offset+1),this.offset+=3,t;case 206:return t=this.view.getUint32(this.offset+1),this.offset+=5,t;case 207:return n=this.view,i=(i=this.offset+1)||0,t=n.getUint32(i)*s+n.getUint32(i+4),this.offset+=9,t;case 208:return t=this.view.getInt8(this.offset+1),this.offset+=2,t;case 209:return t=this.view.getInt16(this.offset+1),this.offset+=3,t;case 210:return t=this.view.getInt32(this.offset+1),this.offset+=5,t;case 211:return n=this.view,i=(i=this.offset+1)||0,t=n.getInt32(i)*s+n.getUint32(i+4),this.offset+=9,t;case 212:return e=1,this.offset++,this.ext(e);case 213:return e=2,this.offset++,this.ext(e);case 214:return e=4,this.offset++,this.ext(e);case 215:return e=8,this.offset++,this.ext(e);case 216:return e=16,this.offset++,this.ext(e);case 217:return e=this.view.getUint8(this.offset+1),this.offset+=2,this.str(e);case 218:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.str(e);case 219:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.str(e);case 220:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.array(e);case 221:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.array(e);case 222:return e=this.view.getUint16(this.offset+1),this.offset+=3,this.map(e);case 223:return e=this.view.getUint32(this.offset+1),this.offset+=5,this.map(e)}throw new Error("Unknown type 0x"+o.toString(16))},t}();e.a=i},function(t,E,P){"use strict";(function(e){var n,s,c,o,l,u,i,r,h=P(8),p=P(1),d=P(29),a=P(4),f=P(3),g=P(7),m=P(25),y=P(0),v=P(19),O=P(11),R=P(2),A=P(12),b=P(5),C=P(9),w=P(20),S=P(21),T=P(14),t=P(35),I=P(34),t=(n=!(void 0===T.a||!T.a.get),s=!(void 0===T.a||!T.a.getSession),c=h.a.Action,o=d.a.PendingMessage,l=a.a.transportPreferenceOrder,u=l[l.length-1],i="ably-transport-preference",r="ably-connection-recovery",_.prototype.getConnectParams=function(t){var e=t?p.a.copy(t):{},n=this.options;switch(this.mode){case"upgrade":e.upgrade=this.connectionKey;break;case"resume":e.resume=this.connectionKey,void 0!==this.timeSerial?e.timeSerial=this.timeSerial:void 0!==this.connectionSerial&&(e.connectionSerial=this.connectionSerial);break;case"recover":t=n.recover.split(":");t&&(e.recover=t[0],t=t[1],isNaN(t)?e.timeSerial=t:e.connectionSerial=t)}return void 0!==n.clientId&&(e.clientId=n.clientId),!1===n.echoMessages&&(e.echo="false"),void 0!==this.format&&(e.format=this.format),void 0!==this.stream&&(e.stream=this.stream),void 0!==this.heartbeats&&(e.heartbeats=this.heartbeats),e.v=a.a.apiVersion,e.lib=a.a.libstring,void 0!==n.transportParams&&p.a.mixin(e,n.transportParams),e},_.prototype.toString=function(){var t="[mode="+this.mode;return this.host&&(t+=",host="+this.host),this.connectionKey&&(t+=",connectionKey="+this.connectionKey),void 0!==this.connectionSerial&&(t+=",connectionSerial="+this.connectionSerial),this.timeSerial&&(t+=",timeSerial="+this.timeSerial),this.format&&(t+=",format="+this.format),t+="]"},p.a.inherits(k,g.a),k.supportedTransports={},Object(I.a)(k),p.a.arrForEach(t.a,function(t){t(k)}),k.prototype.createTransportParams=function(t,e){e=new _(this.options,t,e,this.connectionKey);return this.timeSerial?e.timeSerial=this.timeSerial:void 0!==this.connectionSerial&&(e.connectionSerial=this.connectionSerial),e},k.prototype.getTransportParams=function(n){var i=this;!function(e){if(i.connectionKey)e("resume");else if("string"!=typeof i.options.recover){var t=i.options.recover,n=s&&T.a.getSession(r);if(n&&"function"==typeof t)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data"),t(n,function(t){t?(i.options.recover=n.recoveryKey,e("recover")):e("clean")});e("clean")}else e("recover")}(function(t){var e=i.createTransportParams(null,t);"recover"===t?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+i.options.recover),(t=i.options.recover.split(":"))&&t[2]&&(i.msgSerial=t[2])):y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+e.toString()),n(e)})},k.prototype.tryATransport=function(i,o,s){var r=this;i.host;y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+o),k.supportedTransports[o].tryConnect(this,this.realtime.auth,i,function(t,e){var n=r.state;return n==r.states.closing||n==r.states.closed||n==r.states.failed?(e&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+n.state+" while we were attempting the transport; closing "+e),e.close()),void s(!0)):t?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+o+" "+t.event+", err: "+t.error.toString()),void(!A.a.isTokenErr(t.error)||r.errorReason&&A.a.isTokenErr(r.errorReason)?"failed"===t.event?(r.notifyState({state:"failed",error:t.error}),s(!0)):"disconnected"===t.event&&s(!1):(r.errorReason=t.error,r.realtime.auth._forceNewToken(null,null,function(t){t?r.actOnErrorFromAuthorize(t):r.tryATransport(i,o,s)})))):(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+o+"; setting pending"),r.setTransportPending(e,i),void s(null,e))})},k.prototype.setTransportPending=function(o,s){var r=s.mode;y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+o+"; mode = "+r),p.a.arrDeleteValue(this.proposedTransports,o),this.pendingTransports.push(o);var a=this;o.once("connected",function(t,e,n,i){"upgrade"==r&&a.activeProtocol?o.shortName!==u&&p.a.arrIn(a.getUpgradePossibilities(),u)?setTimeout(function(){a.scheduleTransportActivation(t,o,e,n,i)},a.options.timeouts.parallelUpgradeDelay):a.scheduleTransportActivation(t,o,e,n,i):(a.activateTransport(t,o,e,n,i),p.a.nextTick(function(){a.connectImpl(s)})),"recover"===r&&a.options.recover&&(a.options.recover=null,a.unpersistConnection())}),o.on(["disconnected","closed","failed"],function(t){a.deactivateTransport(o,this.event,t)}),this.emit("transport.pending",o)},k.prototype.scheduleTransportActivation=function(o,s,n,r,a){function c(){s.disconnect(),p.a.arrDeleteValue(u.pendingTransports,s)}var t,e,u=this,i=this.activeProtocol&&this.activeProtocol.getTransport();return this.state!==this.states.connected&&this.state!==this.states.connecting?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+this.state.state+(this.state===this.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+s.shortName),void c()):!i||(t=s,e=i,p.a.arrIndexOf(l,t.shortName)>p.a.arrIndexOf(l,e.shortName))?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Scheduling transport upgrade; transport = "+s),void this.realtime.channels.onceNopending(function(t){var i;if(t)y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unable to activate transport; transport = "+s+"; err = "+t);else{if(!s.isConnected)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+s.shortName+"is no longer connected; abandoning upgrade"),void c();if(u.state===u.states.connected)y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Currently connected, so temporarily pausing events until the upgrade is complete"),u.state=u.states.synchronizing,i=u.activeProtocol;else if(u.state!==u.states.connecting)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+u.state.state+(u.state===u.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+s.shortName),void c();var e=n!==u.connectionId,t=e?a:u;e&&y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Upgrade resulted in new connectionId; resetting library connection position from "+(u.timeSerial||u.connectionSerial)+" to "+(t.timeSerial||t.connectionSerial)+"; upgrade error was "+o),y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Syncing transport; transport = "+s),u.sync(s,t,function(t,e,n){t?u.state===u.states.synchronizing&&(y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unexpected error attempting to sync transport; transport = "+s+"; err = "+t),u.disconnectAllTransports()):(t=function(){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Activating transport; transport = "+s),u.activateTransport(o,s,e,r,n),u.state===u.states.synchronizing?(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, sending queued messages on upgraded transport; transport = "+s),u.state=u.states.connected):y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, but state is now "+u.state.state+", so leaving unchanged"),u.state.sendEvents&&u.sendQueuedMessages()},i?i.onceIdle(t):t())})}})):(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+s.shortName+" is no better than current active transport "+i.shortName+" - abandoning upgrade"),void c())},k.prototype.activateTransport=function(t,i,e,n,o){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+i),t&&y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+t),e&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+e),n&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(n)),o&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.activateTransport()","serial =  "+(o.timeSerial||o.connectionSerial)),this.persistTransportPreference(i);var s=this.state,r=this.states.connected.state;if(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+s.state),s.state==this.states.closing.state||s.state==this.states.closed.state||s.state==this.states.failed.state)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),i.disconnect(),!1;if(p.a.arrDeleteValue(this.pendingTransports,i),!i.isConnected)return y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+i+" since it appears to no longer be connected"),!1;var a=this.activeProtocol;this.activeProtocol=new d.a(i),this.host=i.params.host;var c=n.connectionKey;c&&this.connectionKey!=c&&this.setConnection(e,n,o,!!t),this.onConnectionDetailsUpdate(n,i);var u=this;return p.a.nextTick(function(){i.on("connected",function(t,e,n){u.onConnectionDetailsUpdate(n,i),u.emit("update",new v.a(r,r,null,t))})}),s.state===this.states.connected.state?t&&(this.errorReason=this.realtime.connection.errorReason=t,this.emit("update",new v.a(r,r,null,t))):(this.notifyState({state:"connected",error:t}),this.errorReason=this.realtime.connection.errorReason=t||null),this.emit("transport.active",i),a&&(0<a.messageQueue.count()&&y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+a.transport.shortName+", new one is "+i.shortName+") finishing with "+a.messageQueue.count()+" messages still pending"),a.transport===i?(t="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+i.shortName+"; stack = "+(new Error).stack,y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()",t),S.a.report("error",t,"transport-previously-active")):a.finish()),p.a.safeArrForEach(this.pendingTransports,function(t){var e;t===i?(e="Assumption violated: activating a transport that is still marked as a pending transport; transport = "+i.shortName+"; stack = "+(new Error).stack,y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()",e),S.a.report("error",e,"transport-activating-pending"),p.a.arrDeleteValue(u.pendingTransports,i)):t.disconnect()}),p.a.safeArrForEach(this.proposedTransports,function(t){var e;t===i?(e="Assumption violated: activating a transport that is still marked as a proposed transport; transport = "+i.shortName+"; stack = "+(new Error).stack,y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.activateTransport()",e),S.a.report("error",e,"transport-activating-proposed"),p.a.arrDeleteValue(u.proposedTransports,i)):t.dispose()}),!0},k.prototype.deactivateTransport=function(t,e,n){var i=this.activeProtocol,o=i&&i.getTransport()===t,s=p.a.arrDeleteValue(this.pendingTransports,t),r=p.a.arrDeleteValue(this.proposedTransports,t),a=this.noTransportsScheduledForActivation();if(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+t),y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+e+(o?"; was active":s?"; was pending":r?"; was proposed":"")+(a?"":"; another transport is scheduled for activation")),n&&n.message&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+n.message),o&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(i.getPendingMessages()),p.a.nextTick(function(){i.clearPendingMessages()}),this.activeProtocol=this.host=null,clearTimeout(this.channelResumeCheckTimer)),this.emit("transport.inactive",t),o&&a||o&&"failed"===e||"closed"===e||null===i&&s&&0===this.pendingTransports.length){if("disconnected"===e&&n&&500<n.statusCode&&1<this.httpHosts.length)return this.unpersistTransportPreference(),this.forceFallbackHost=!0,void this.notifyState({state:e,error:n,retryImmediately:!0});s="failed"===e&&A.a.isTokenErr(n)?"disconnected":e;this.notifyState({state:s,error:n})}else o&&"disconnected"===e&&this.state!==this.states.synchronizing&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.deactivateTransport()","wasActive but another transport is connected and scheduled for activation, so going into the connecting state until it activates"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),this.notifyState({state:"connecting",error:n}))},k.prototype.noTransportsScheduledForActivation=function(){return p.a.isEmpty(this.pendingTransports)||this.pendingTransports.every(function(t){return!t.isConnected})},k.prototype.sync=function(t,e,n){var i=setTimeout(function(){t.off("sync"),n(new R.a("Timeout waiting for sync response",5e4,500))},this.options.timeouts.realtimeRequestTimeout),o=h.a.fromValues({action:c.SYNC,connectionKey:this.connectionKey});e.timeSerial?o.timeSerial=e.timeSerial:void 0!==e.connectionSerial&&(o.connectionSerial=e.connectionSerial),t.send(o),t.once("sync",function(t,e){clearTimeout(i),n(null,t,e)})},k.prototype.setConnection=function(t,e,n,i){var o=this,s=this.connectionid,r=s&&s!==t;(r||!s&&i)&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0),this.connectionId!==t?(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),p.a.nextTick(function(){o.realtime.channels.reattach()})):this.options.checkChannelsOnResume&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.setConnection()","Same connectionId; checkChannelsOnResume is enabled"),clearTimeout(this.channelResumeCheckTimer),this.realtime.channels.resetAttachedMsgIndicators(),this.channelResumeCheckTimer=setTimeout(function(){o.realtime.channels.checkAttachedMsgIndicators(t)},3e4)),this.realtime.connection.id=this.connectionId=t,this.realtime.connection.key=this.connectionKey=e.connectionKey;s=r||!s;this.setConnectionSerial(n,s)},k.prototype.clearConnection=function(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.clearConnectionSerial(),this.msgSerial=0,this.unpersistConnection()},k.prototype.setConnectionSerial=function(t,e){var n=t.timeSerial,t=t.connectionSerial;if(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.setConnectionSerial()","Updating connection serial; serial = "+t+"; timeSerial = "+n+"; force = "+e+"; previous = "+this.connectionSerial),void 0!==n)return n<=this.timeSerial&&!e?(y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with timeSerial "+n+", but current timeSerial is "+this.timeSerial+"; assuming message is a duplicate and discarding it"),!0):(this.realtime.connection.timeSerial=this.timeSerial=n,void this.setRecoveryKey());if(void 0!==t){if(t<=this.connectionSerial&&!e)return y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with connectionSerial "+t+", but current connectionSerial is "+this.connectionSerial+"; assuming message is a duplicate and discarding it"),!0;this.realtime.connection.serial=this.connectionSerial=t,this.setRecoveryKey()}},k.prototype.clearConnectionSerial=function(){this.realtime.connection.serial=this.connectionSerial=void 0,this.realtime.connection.timeSerial=this.timeSerial=void 0,this.clearRecoveryKey()},k.prototype.setRecoveryKey=function(){this.realtime.connection.recoveryKey=this.connectionKey+":"+(this.timeSerial||this.connectionSerial)+":"+this.msgSerial},k.prototype.clearRecoveryKey=function(){this.realtime.connection.recoveryKey=null},k.prototype.checkConnectionStateFreshness=function(){var t;this.lastActivity&&this.connectionId&&((t=p.a.now()-this.lastActivity)>this.connectionStateTtl+this.maxIdleInterval&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+t+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended",this.states.connecting.queueEvents=!1))},k.prototype.persistConnection=function(){var t;!s||(t=this.realtime.connection.recoveryKey)&&(t={recoveryKey:t,disconnectedAt:p.a.now(),location:e.location,clientId:this.realtime.auth.clientId},this.connectionStateTtl,s&&T.a.setSession(r,t))},k.prototype.unpersistConnection=function(){s&&T.a.removeSession(r)},k.prototype.getError=function(){return this.errorReason||this.getStateError()},k.prototype.getStateError=function(){return O.a[this.state.state]},k.prototype.activeState=function(){return this.state.queueEvents||this.state.sendEvents},k.prototype.enactStateChange=function(t){var e="failed"===t.current?y.a.LOG_ERROR:y.a.LOG_MAJOR;y.a.logAction(e,"Connection state",t.current+(t.reason?"; reason: "+t.reason:"")),y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+t.current+"; reason = "+(t.reason&&t.reason.message));e=this.state=this.states[t.current];t.reason&&(this.errorReason=t.reason,this.realtime.connection.errorReason=t.reason),!e.terminal&&"suspended"!==e.state||this.clearConnection(),this.emit("connectionstate",t)},k.prototype.startTransitionTimer=function(t){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+t.state),this.transitionTimer&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer));var e=this;this.transitionTimer=setTimeout(function(){e.transitionTimer&&(e.transitionTimer=null,y.a.logAction(y.a.LOG_MINOR,"ConnectionManager "+t.state+" timer expired","requesting new state: "+t.failState),e.notifyState({state:t.failState}))},t.retryDelay)},k.prototype.cancelTransitionTimer=function(){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)},k.prototype.startSuspendTimer=function(){var t=this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){t.suspendTimer&&(t.suspendTimer=null,y.a.logAction(y.a.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),t.states.connecting.failState="suspended",t.states.connecting.queueEvents=!1,t.notifyState({state:"suspended"}))},this.connectionStateTtl))},k.prototype.checkSuspendTimer=function(t){"disconnected"!==t&&"suspended"!==t&&"connecting"!==t&&this.cancelSuspendTimer()},k.prototype.cancelSuspendTimer=function(){this.states.connecting.failState="disconnected",this.states.connecting.queueEvents=!0,this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)},k.prototype.startRetryTimer=function(t){var e=this;this.retryTimer=setTimeout(function(){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),e.retryTimer=null,e.requestState({state:"connecting"})},t)},k.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},k.prototype.notifyState=function(t){var e,n,i,o=t.state,s=this,r="disconnected"===o&&(this.state===this.states.connected||this.state===this.states.synchronizing||t.retryImmediately||this.state===this.states.connecting&&t.error&&A.a.isTokenErr(t.error)&&!(this.errorReason&&A.a.isTokenErr(this.errorReason)));y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+o+(r?"; will retry connection immediately":"")),o!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(t.state),this.state.terminal||(e=this.states[t.state],n=new v.a(this.state.state,e.state,e.retryDelay,t.error||O.a[e.state]),r?(i=function(){s.state===s.states.disconnected&&(s.lastAutoReconnectAttempt=p.a.now(),s.requestState({state:"connecting"}))},(t=this.lastAutoReconnectAttempt&&p.a.now()-this.lastAutoReconnectAttempt+1)&&t<1e3?(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+t+"ms ago, waiting another "+(1e3-t)+"ms before trying again"),setTimeout(i,1e3-t)):p.a.nextTick(i)):"disconnected"!==o&&"suspended"!==o||this.startRetryTimer(e.retryDelay),("disconnected"===o&&!r||"suspended"===o||e.terminal)&&p.a.nextTick(function(){s.disconnectAllTransports()}),"connected"!=o||this.activeProtocol||y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(n),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(o,n.reason),this.failQueuedMessages(n.reason))))},k.prototype.requestState=function(t){var e,n=t.state,i=this;y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+n+"; current state: "+this.state.state),n!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(n),"connecting"==n&&"connected"==this.state.state||"closing"==n&&"closed"==this.state.state||(e=this.states[n],e=new v.a(this.state.state,e.state,null,t.error||O.a[e.state]),this.enactStateChange(e),"connecting"==n&&p.a.nextTick(function(){i.startConnect()}),"closing"==n&&this.closeImpl()))},k.prototype.startConnect=function(){var t,e,n,i,o;this.state===this.states.connecting?(t=this.realtime.auth,n=++(e=this).connectCounter,i=function(){e.checkConnectionStateFreshness(),e.getTransportParams(function(t){n===e.connectCounter&&e.connectImpl(t,n)})},y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),"basic"===t.method?i():(o=function(t){n===e.connectCounter&&(t?e.actOnErrorFromAuthorize(t):i())},this.errorReason&&A.a.isTokenErr(this.errorReason)?t._forceNewToken(null,null,o):t._ensureValidAuthCredentials(!1,o))):y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state)},k.prototype.connectImpl=function(t,e){var n=this.state.state;n!==this.states.connecting.state&&n!==this.states.connected.state?y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect (or connected to upgrade), but was "+n):this.pendingTransports.length?y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectImpl()","Transports "+this.pendingTransports[0].toString()+" currently pending; taking no action"):n==this.states.connected.state?this.upgradeIfNeeded(t):1<this.transports.length&&this.getTransportPreference()?this.connectPreference(t):this.connectBase(t,e)},k.prototype.connectPreference=function(n){var t=this.getTransportPreference(),i=this,o=!1;p.a.arrIn(this.transports,t)||(this.unpersistTransportPreference(),this.connectImpl(n)),y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectPreference()","Trying to connect with stored transport preference "+t);var s=setTimeout(function(){o=!0,i.state.state!==i.states.connected.state&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectPreference()","Shortcircuit connection attempt with "+t+" failed; clearing preference and trying from scratch"),i.disconnectAllTransports(),i.unpersistTransportPreference()),i.connectImpl(n)},this.options.timeouts.preferenceConnectTimeout);n.host=i.httpHosts[0],i.tryATransport(n,t,function(t,e){clearTimeout(s),o&&e?(e.off(),e.disconnect(),p.a.arrDeleteValue(this.pendingTransports,e)):e||t||(i.unpersistTransportPreference(),i.connectImpl(n))})},k.prototype.connectBase=function(n,i){var o=this,s=function(t){o.notifyState({state:o.states.connecting.failState,error:t})},r=this.httpHosts.slice(),a=function(t,e){i===o.connectCounter&&(e||t||c())};y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.connectBase()","Trying to connect with base transport "+this.baseTransport);var t=r.shift();if(t){if(n.host=t,this.forceFallbackHost&&r.length)return this.forceFallbackHost=!1,void c();this.tryATransport(n,this.baseTransport,a)}else s(new R.a("Unable to connect (no available host)",80003,404));function c(){r.length?b.a.checkConnectivity(function(t,e){i===o.connectCounter&&(t?s(t):e?(n.host=p.a.arrPopRandomElement(r),o.tryATransport(n,o.baseTransport,a)):s(new R.a("Unable to connect (network unreachable)",80003,404)))}):s(new R.a("Unable to connect (and no more fallback hosts to try)",80003,404))}},k.prototype.getUpgradePossibilities=function(){var t=this.activeProtocol.getTransport().shortName,t=p.a.arrIndexOf(this.upgradeTransports,t);return this.upgradeTransports.slice(t+1)},k.prototype.upgradeIfNeeded=function(n){var t=this.getUpgradePossibilities(),i=this;y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.upgradeIfNeeded()","upgrade possibilities: "+p.a.inspect(t)),t.length&&p.a.arrForEach(t,function(t){var e=i.createTransportParams(n.host,"upgrade");i.tryATransport(e,t,M)})},k.prototype.closeImpl=function(){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),p.a.safeArrForEach(this.pendingTransports,function(t){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+t),t&&t.close()}),p.a.safeArrForEach(this.proposedTransports,function(t){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.closeImpl()","Disposing of proposed transport: "+t),t&&t.dispose()}),this.activeProtocol&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})},k.prototype.onAuthUpdated=function(e,n){var t,i=this;switch(this.state.state){case"connected":y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport"),(this.pendingTransports.length||this.proposedTransports.length)&&i.state!==i.states.synchronizing&&(this.disconnectAllTransports(!0),t=this.activeProtocol.getTransport().params,p.a.nextTick(function(){"connected"===i.state.state&&i.upgradeIfNeeded(t)})),this.activeProtocol.getTransport().onAuthUpdated(e);var o=h.a.fromValues({action:c.AUTH,auth:{accessToken:e.token}});this.send(o);var s=function(){i.off(r),n(null,e)},r=function(t){"failed"===t.current&&(i.off(s),i.off(r),n(t.reason||i.getStateError()))};this.once("connectiondetails",s),this.on("connectionstate",r);break;case"connecting":y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");var a=function(t){switch(t.current){case"connected":i.off(a),n(null,e);break;case"failed":case"closed":case"suspended":i.off(a),n(t.reason||i.getStateError())}};i.on("connectionstate",a),"connecting"===this.state.state?i.startConnect():i.requestState({state:"connecting"})}},k.prototype.disconnectAllTransports=function(t){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"+(t?" except the active transport":"")),this.connectCounter++,p.a.safeArrForEach(this.pendingTransports,function(t){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+t),t&&t.disconnect()}),this.pendingTransports=[],p.a.safeArrForEach(this.proposedTransports,function(t){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disposing of proposed transport: "+t),t&&t.dispose()}),this.proposedTransports=[],this.activeProtocol&&!t&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())},k.prototype.send=function(t,e,n){n=n||M;var i=this.state;if(i.sendEvents)return y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.send()","sending event"),void this.sendImpl(new o(t,n));if(!(e&&i.queueEvents||i.forceQueueEvents)){i="rejecting event, queueEvent was "+e+", state was "+i.state;return y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.send()",i),void n(this.errorReason||new R.a(i,9e4,400))}y.a.shouldLog(y.a.LOG_MICRO)&&y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+h.a.stringify(t)),this.queue(t,n)},k.prototype.sendImpl=function(t){var e=t.message;t.ackRequired&&!t.sendAttempted&&(e.msgSerial=this.msgSerial++,this.setRecoveryKey());try{this.activeProtocol.send(t)}catch(t){y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+t.stack)}},k.prototype.queue=function(t,e){y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.queue()","queueing event");var n=this.queuedMessages.last(),i=this.options.maxMessageSize;n&&!n.sendAttempted&&function(t,e,n){if(t.channel===e.channel&&((i=t.action)===c.PRESENCE||i===c.MESSAGE)&&i===e.action){var i=i===c.PRESENCE?"presence":"messages",e=t[i].concat(e[i]);return n<C.a.getMessagesSize(e)?void 0:p.a.allSame(e,"clientId")&&(p.a.arrEvery(e,function(t){return!t.id})&&(t[i]=e,1))}}(n.message,t,i)?(n.merged||(n.callback=Object(w.a)([n.callback]),n.merged=!0),n.callback.push(e)):this.queuedMessages.push(new o(t,e))},k.prototype.sendQueuedMessages=function(){var t;for(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");t=this.queuedMessages.shift();)this.sendImpl(t)},k.prototype.queuePendingMessages=function(t){t&&t.length&&(y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+t.length+" pending messages"),this.queuedMessages.prepend(t))},k.prototype.failQueuedMessages=function(t){var e=this.queuedMessages.count();0<e&&(y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+e+" queued messages, err = "+p.a.inspectError(t)),this.queuedMessages.completeAllMessages(t))},k.prototype.onChannelMessage=function(t,e){var n=this.activeProtocol&&e===this.activeProtocol.getTransport(),i=p.a.arrIn(this.pendingTransports,e)&&this.state==this.states.synchronizing,e=t.action===c.MESSAGE||t.action===c.PRESENCE;if(n||i){if(e){if(this.setConnectionSerial(t))return;if(h.a.isDuplicate(t,this.mostRecentMsg))return void y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.onChannelMessage()","received message with different connectionSerial, but same message id as a previous; discarding; id = "+t.id);this.mostRecentMsg=t}this.realtime.channels.onChannelMessage(t)}else-1<p.a.arrIndexOf([c.ACK,c.NACK,c.ERROR],t.action)?this.realtime.channels.onChannelMessage(t):y.a.logAction(y.a.LOG_MICRO,"ConnectionManager.onChannelMessage()","received message "+JSON.stringify(t)+"on defunct transport; discarding")},k.prototype.ping=function(e,n){if(e){y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.ping()","transport = "+e);var i=p.a.now(),o=p.a.cheapRandStr(),s=function(t){t===o&&(e.off("heartbeat",s),clearTimeout(r),t=p.a.now()-i,n(null,t))},r=setTimeout(function(){e.off("heartbeat",s),n(new R.a("Timeout waiting for heartbeat response",5e4,500))},this.options.timeouts.realtimeRequestTimeout);return e.on("heartbeat",s),void e.ping(o)}var a,c,u;"connected"===this.state.state?(a=!1,u=function(){a||(a=!0,p.a.nextTick(function(){c.ping(null,n)}))},(c=this).on("transport.active",u),this.ping(this.activeProtocol.getTransport(),function(t,e){c.off("transport.active",u),a||(a=!0,n(t,e))})):n(new R.a("Unable to ping service; not connected",4e4,400))},k.prototype.abort=function(t){this.activeProtocol.getTransport().fail(t)},k.prototype.registerProposedTransport=function(t){this.proposedTransports.push(t)},k.prototype.getTransportPreference=function(){return this.transportPreference||n&&T.a.get(i)},k.prototype.persistTransportPreference=function(t){p.a.arrIn(a.a.upgradeTransports,t.shortName)&&(this.transportPreference=t.shortName,n&&T.a.set(i,t.shortName))},k.prototype.unpersistTransportPreference=function(){this.transportPreference=null,n&&T.a.remove(i)},k.prototype.actOnErrorFromAuthorize=function(t){var e;40171===t.code?this.notifyState({state:"failed",error:t}):403===t.statusCode?(e="Client configured authentication provider returned 403; failing the connection",y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",e),this.notifyState({state:"failed",error:new R.a(e,80019,403,t)})):(e="Client configured authentication provider request failed",y.a.logAction(y.a.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",e),this.notifyState({state:this.state.failState,error:new R.a(e,80019,401,t)}))},k.prototype.onConnectionDetailsUpdate=function(t,e){if(t){(this.connectionDetails=t).maxMessageSize&&(this.options.maxMessageSize=t.maxMessageSize);var n=t.clientId;if(n){var i=this.realtime.auth._uncheckedSetClientId(n);if(i)return y.a.logAction(y.a.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",i.message),void e.fail(i)}i=t.connectionStateTtl;i&&(this.connectionStateTtl=i),this.maxIdleInterval=t.maxIdleInterval,this.emit("connectiondetails",t)}},k);function M(){}function _(t,e,n,i){this.options=t,this.host=e,this.mode=n,this.connectionKey=i,this.format=t.useBinaryProtocol?"msgpack":"json",this.connectionSerial=void 0,this.timeSerial=void 0}function k(t,e){g.a.call(this),this.realtime=t;var n=(this.options=e).timeouts,i=this,t=n.preferenceConnectTimeout+n.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:t,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},synchronizing:{state:"connected",terminal:!1,queueEvents:!0,sendEvents:!1,forceQueueEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:n.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:n.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:n.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new m.a,this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.timeSerial=void 0,this.connectionSerial=void 0,this.connectionStateTtl=n.connectionStateTtl,this.maxIdleInterval=null,this.transports=p.a.intersect(e.transports||a.a.defaultTransports,k.supportedTransports),this.baseTransport=p.a.intersect(a.a.baseTransportOrder,this.transports)[0],this.upgradeTransports=p.a.intersect(this.transports,a.a.upgradeTransports),this.transportPreference=null,this.httpHosts=a.a.getHosts(e),this.activeProtocol=null,this.proposedTransports=[],this.pendingTransports=[],this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.mostRecentMsg=null,this.forceFallbackHost=!1,this.connectCounter=0,y.a.logAction(y.a.LOG_MINOR,"Realtime.ConnectionManager()","started"),y.a.logAction(y.a.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(e.transports||a.a.defaultTransports)+"]"),y.a.logAction(y.a.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),y.a.logAction(y.a.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]"),!this.transports.length){var o="no requested transports available";throw y.a.logAction(y.a.LOG_ERROR,"realtime.ConnectionManager()",o),new Error(o)}o=f.a.addEventListener;o&&(s&&"function"==typeof e.recover&&o("beforeunload",this.persistConnection.bind(this)),!0===e.closeOnUnload&&o("beforeunload",function(){y.a.logAction(y.a.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),i.requestState({state:"closing"})}),o("online",function(){i.state!=i.states.disconnected&&i.state!=i.states.suspended||(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager caught browser ‘online’ event","reattempting connection"),i.requestState({state:"connecting"}))}),o("offline",function(){i.state==i.states.connected&&(y.a.logAction(y.a.LOG_MINOR,"ConnectionManager caught browser ‘offline’ event","disconnecting active transport"),i.disconnectAllTransports())}))}E.a=t}).call(this,P(17))},function(t,e,n){"use strict";var i=n(1),o=n(7),a=n(0),i=(i.a.inherits(s,o.a),s.prototype.count=function(){return this.messages.length},s.prototype.push=function(t){this.messages.push(t)},s.prototype.shift=function(){return this.messages.shift()},s.prototype.last=function(){return this.messages[this.messages.length-1]},s.prototype.copyAll=function(){return this.messages.slice()},s.prototype.append=function(t){this.messages.push.apply(this.messages,t)},s.prototype.prepend=function(t){this.messages.unshift.apply(this.messages,t)},s.prototype.completeMessages=function(t,e,n){a.a.logAction(a.a.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+t+"; count = "+e),n=n||null;var i=this.messages,o=i[0];if(o){o=o.message.msgSerial,e=t+e;if(o<e)for(var s=i.splice(0,e-o),r=0;r<s.length;r++)s[r].callback(n);0==i.length&&this.emit("idle")}},s.prototype.completeAllMessages=function(t){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,t)},s.prototype.clear=function(){a.a.logAction(a.a.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")},s);function s(){o.a.call(this),this.messages=[]}e.a=i},function(t,n,r){"use strict";(function(t){var v=r(1),p=r(7),i=r(3),O=r(2),o=r(5),R=r(0),d=r(4),A=r(6),s=r(30),e=function(){function n(){}var a=0,c={};var e=void 0!==t&&t.XDomainRequest;function u(){var t;return e&&(t=(t=navigator.userAgent.toString().match(/MSIE\s([\d.]+)/))&&Number(t[1]))&&10===t}function l(t,e,n,i,o,s,r){p.a.call(this),(n=n||{}).rnd=v.a.cheapRandStr(),u()&&!n.envelope&&(n.envelope="json"),this.uri=t+v.a.toQueryString(n),this.headers=e||{},this.body=i,this.method=r?r.toUpperCase():v.a.isEmptyArg(i)?"GET":"POST",this.requestMode=o,this.timeouts=s,this.timedOut=!1,this.requestComplete=!1,c[this.id=String(++a)]=this}v.a.inherits(l,p.a);var h=l.createRequest=function(t,e,n,i,o,s,r){return s=s||d.a.TIMEOUTS,new l(t,e,v.a.copy(n),i,o,s,r)};return l.prototype.complete=function(t,e,n,i,o){this.requestComplete||(this.requestComplete=!0,!t&&e&&this.emit("data",e),this.emit("complete",t,e,n,i,o),this.dispose())},l.prototype.abort=function(){this.dispose()},l.prototype.exec=function(){var t,e=0==this.requestMode?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,s=this,n=this.timer=setTimeout(function(){s.timedOut=!0,a.abort()},e),i=this.body,o=this.method,r=this.headers,a=this.xhr=new XMLHttpRequest,c=r.accept,e="text";for(t in c?0===c.indexOf("application/x-msgpack")&&(e="arraybuffer"):r.accept="application/json",i&&-1<(r["content-type"]||(r["content-type"]="application/json")).indexOf("application/json")&&"string"!=typeof i&&(i=JSON.stringify(i)),a.open(o,this.uri,!0),a.responseType=e,"authorization"in r&&(a.withCredentials=!0),r)a.setRequestHeader(t,r[t]);function u(t,e,n,i){e=e+" (event type: "+t.type+")"+(s.xhr.statusText?", current statusText is "+s.xhr.statusText:""),R.a.logAction(R.a.LOG_ERROR,"Request.on"+t.type+"()",e),s.complete(new O.a(e,n,i))}a.onerror=function(t){u(t,"XHR error occurred",null,400)},a.onabort=function(t){s.timedOut?u(t,"Request aborted due to request timeout expiring",null,408):u(t,"Request cancelled",null,400)},a.ontimeout=function(t){u(t,"Request timed out",null,408)};var l,h,p,d,f=0,g=!1;function m(){try{var t,e,n=(n="content-type",(i=a).getResponseHeader&&i.getResponseHeader(n));(n?0<=n.indexOf("application/json"):"text"==a.responseType)?((e="arraybuffer"===a.responseType?A.a.utf8Decode(a.response):String(a.responseText)).length&&(e=JSON.parse(e)),g=!0):e=a.response,void 0!==e.response?(h=e.statusCode,d=h<400,t=e.headers,e=e.response):t=function(t){for(var e=v.a.trim(t.getAllResponseHeaders()).split("\r\n"),n={},i=0;i<e.length;i++){var o=v.a.arrMap(e[i].split(":"),v.a.trim);n[o[0].toLowerCase()]=o[1]}return n}(a)}catch(t){return void s.complete(new O.a("Malformed response body from server: "+t.message,null,400))}var i,n,o;d||v.a.isArray(e)?s.complete(null,e,t,g,h):(o=(o=e.error&&O.a.fromValues(e.error))||new O.a("Error response received from server: "+h+" body was: "+v.a.inspect(e),null,h),s.complete(o,e,t,g,h))}function y(){for(var t,e,n=(p=a.responseText).length-1;f<n&&-1<(t=p.indexOf("\n",f));)e=p.slice(f,t),f=t+1,function(t){try{t=JSON.parse(t)}catch(t){return s.complete(new O.a("Malformed response body from server: "+t.message,null,400))}s.emit("data",t)}(e)}a.onreadystatechange=function(){var t,e=a.readyState;e<3||0!==a.status&&(void 0===h&&(1223===(h=a.status)&&(h=204),clearTimeout(n),d=h<400,204!=h?l=3==s.requestMode&&d&&((t=a).getResponseHeader&&(t.getResponseHeader("transfer-encoding")||!t.getResponseHeader("content-length"))):s.complete(null,null,null,null,h)),3==e&&l?y():4==e&&(l?(y(),s.streamComplete=!0,v.a.nextTick(function(){s.complete()})):m()))},a.send(i)},l.prototype.dispose=function(){var t,e=this.xhr;e&&(e.onreadystatechange=e.onerror=e.onabort=e.ontimeout=n,this.xhr=null,(t=this.timer)&&(clearTimeout(t),this.timer=null),this.requestComplete||e.abort()),delete c[this.id]},i.a.xhrSupported&&("object"==typeof s.a&&s.a.addUnloadListener(function(){for(var t in c)c[t].dispose()}),void 0!==o.a&&(o.a.supportsAuthHeaders=!0,o.a.Request=function(t,e,n,i,o,s,r){t=h(n,i,o,s,0,e&&e.options.timeouts,t);return t.once("complete",r),t.exec(),t},o.a.checkConnectivity=function(n){var t=d.a.internetUpUrl;R.a.logAction(R.a.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+t),o.a.getUri(null,t,null,null,function(t,e){e=!t&&"yes"==e.replace(/\n/,"");R.a.logAction(R.a.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+e),n(null,e)})})),l}();n.a=e}).call(this,r(17))},function(t,e,n){t.exports=n(18).enc.Hex},function(t,e,n){t.exports=n(18).enc.Utf8},function(t,e,n){"use strict";var i,o=n(8),s=n(1),r=n(7),a=n(0),c=n(25),u=n(2),n=(i=o.a.Action,s.a.inherits(l,r.a),l.prototype.onAck=function(t,e){a.a.logAction(a.a.LOG_MICRO,"Protocol.onAck()","serial = "+t+"; count = "+e),this.messageQueue.completeMessages(t,e)},l.prototype.onNack=function(t,e,n){a.a.logAction(a.a.LOG_ERROR,"Protocol.onNack()","serial = "+t+"; count = "+e+"; err = "+s.a.inspectError(n)),n=n||new u.a("Unable to send message; channel not responding",50001,500),this.messageQueue.completeMessages(t,e,n)},l.prototype.onceIdle=function(t){var e=this.messageQueue;0!==e.count()?e.once("idle",t):t()},l.prototype.send=function(t){t.ackRequired&&this.messageQueue.push(t),a.a.shouldLog(a.a.LOG_MICRO)&&a.a.logAction(a.a.LOG_MICRO,"Protocol.send()","sending msg; "+o.a.stringify(t.message)),t.sendAttempted=!0,this.transport.send(t.message)},l.prototype.getTransport=function(){return this.transport},l.prototype.getPendingMessages=function(){return this.messageQueue.copyAll()},l.prototype.clearPendingMessages=function(){return this.messageQueue.clear()},l.prototype.finish=function(){var t=this.transport;this.onceIdle(function(){t.disconnect()})},l.PendingMessage=function(t,e){this.message=t,this.callback=e,this.merged=!1,t=t.action,this.sendAttempted=!1,this.ackRequired=t==i.MESSAGE||t==i.PRESENCE},l);function l(t){r.a.call(this),this.transport=t,this.messageQueue=new c.a;var i=this;t.on("ack",function(t,e){i.onAck(t,e)}),t.on("nack",function(t,e,n){i.onNack(t,e,n)})}e.a=n},function(t,i,e){"use strict";(function(e){var t=(n.addListener=function(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent("on"+e,function(){n.apply(t,arguments)})},n.removeListener=function(t,e,n){t.removeEventListener?t.removeEventListener(e,n,!1):t.detachEvent("on"+e,function(){n.apply(t,arguments)})},n.addMessageListener=function(t,e){n.addListener(t,"message",e)},n.removeMessageListener=function(t,e){n.removeListener(t,"message",e)},n.addUnloadListener=function(t){n.addListener(e,"unload",t)},n);function n(){}i.a=t}).call(this,e(17))},function(t,e,n){var i;t.exports=(i=n(18),function(){var t,o;"function"==typeof ArrayBuffer&&(t=i.lib.WordArray,o=t.init,(t.init=function(t){if(t instanceof ArrayBuffer&&(t=new Uint8Array(t)),(t instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array)&&(t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),t instanceof Uint8Array){for(var e=t.byteLength,n=[],i=0;i<e;i++)n[i>>>2]|=t[i]<<24-i%4*8;o.call(this,n,e)}else o.apply(this,arguments)}).prototype=t)}(),i.lib.WordArray)},function(t,e,n){t.exports=(t=n(18),n(37),n(38),t.HmacSHA256)},function(t,e,o){"use strict";(function(n){var p=o(1),d=o(13),i=o(3),f=o(7),s=o(5),g=o(2),m=o(4),y=o(0);e.a=function(t){function e(){}var r=n._ablyjs_jsonp={};r._=function(t){return r["_"+t]||e};var c=1,a=null;function u(t,e,n){n.stream=!1,d.a.call(this,t,e,n),this.shortName="jsonp"}p.a.inherits(u,d.a),(u.isAvailable=function(){return i.a.jsonpSupported&&i.a.allowComet})()&&(t.supportedTransports.jsonp=u),i.a.jsonpSupported&&(a=document.getElementsByTagName("head")[0]);var o=null;(n.JSONPTransport=u).tryConnect=function(t,e,n,i){function o(t){i({event:this.event,error:t})}var s=new u(t,e,n);s.on(["failed","disconnected"],o),s.on("preconnect",function(){y.a.logAction(y.a.LOG_MINOR,"JSONPTransport.tryConnect()","viable transport "+s),s.off(["failed","disconnected"],o),i(null,s)}),s.connect()},u.prototype.toString=function(){return"JSONPTransport; uri="+this.baseUri+"; isConnected="+this.isConnected};var l=u.prototype.createRequest=function(t,e,n,i,o,s,r){return s=this&&this.timeouts||s||m.a.TIMEOUTS,new h(void 0,t,e,p.a.copy(n),i,o,s,r)};function h(t,e,n,i,o,s,r,a){f.a.call(this),void 0===t&&(t=c++),this.id=t,this.uri=e,this.params=i||{},this.params.rnd=p.a.cheapRandStr(),n&&(n["X-Ably-Version"]&&(this.params.v=n["X-Ably-Version"]),n["X-Ably-Lib"]&&(this.params.lib=n["X-Ably-Lib"])),this.body=o,this.method=a,this.requestMode=s,this.timeouts=r,this.requestComplete=!1}return p.a.inherits(h,f.a),h.prototype.exec=function(){var t=this.id,e=this.body,n=this.method,i=this.uri,o=this.params,s=this;o.callback="_ablyjs_jsonp._("+t+")",o.envelope="jsonp",e&&(o.body=e),n&&"get"!==n&&(o.method=n);n=this.script=document.createElement("script"),o=i+p.a.toQueryString(o);n.src=o,n.src.split("/").slice(-1)[0]!==o.split("/").slice(-1)[0]&&y.a.logAction(y.a.LOG_ERROR,"JSONP Request.exec()","Warning: the browser appears to have truncated the script URI. This will likely result in the request failing due to an unparseable body param"),n.async=!0,n.type="text/javascript",n.charset="UTF-8",n.onerror=function(t){s.complete(new g.a("JSONP script error (event: "+p.a.inspect(t)+")",null,400))},r["_"+t]=function(t){var e;t.statusCode?(e=t.response,204==t.statusCode?s.complete(null,null,null,t.statusCode):e?t.statusCode<400||p.a.isArray(e)?s.complete(null,e,t.headers,t.statusCode):(e=e.error||new g.a("Error response received from server",null,t.statusCode),s.complete(e)):s.complete(new g.a("Invalid server response: no envelope detected",null,500))):s.complete(null,t)};t=this.requestMode==d.a.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout;this.timer=setTimeout(function(){s.abort()},t),a.insertBefore(n,a.firstChild)},h.prototype.complete=function(t,e,n,i){var o;n=n||{},this.requestComplete||(this.requestComplete=!0,e&&(o="string"==typeof e?"text/plain":"application/json",n["content-type"]=o,this.emit("data",e)),this.emit("complete",t,e,n,!0,i),this.dispose())},h.prototype.abort=function(){this.dispose()},h.prototype.dispose=function(){var t=this.timer;t&&(clearTimeout(t),this.timer=null);t=this.script;t.parentNode&&t.parentNode.removeChild(t),delete r[this.id],this.emit("disposed")},i.a.jsonpSupported&&!s.a.Request&&(s.a.Request=function(t,e,n,i,o,s,r){var a=l(n,i,o,s,d.a.REQ_SEND,e&&e.options.timeouts,t);return a.once("complete",r),p.a.nextTick(function(){a.exec()}),a},s.a.checkConnectivity=function(t){var e,n=m.a.jsonpInternetUpUrl;o?o.push(t):(o=[t],y.a.logAction(y.a.LOG_MICRO,"(JSONP)Http.checkConnectivity()","Sending; "+n),(e=new h("isTheInternetUp",n,null,null,null,d.a.REQ_SEND,m.a.TIMEOUTS)).once("complete",function(t,e){var n=!t&&e;y.a.logAction(y.a.LOG_MICRO,"(JSONP)Http.checkConnectivity()","Result: "+n);for(var i=0;i<o.length;i++)o[i](null,n);o=null}),p.a.nextTick(function(){e.exec()}))}),u}}).call(this,o(17))},function(t,e,n){"use strict";var u=n(3),s=n(1),l=n(16),h=n(4),p=n(0),a=n(8),c=n(2);e.a=function(t){var o=u.a.WebSocket,i="web_socket";function r(t,e,n){this.shortName=i,n.heartbeats=u.a.useProtocolHeartbeats,l.a.call(this,t,e,n),this.wsHost=h.a.getHost(n.options,n.host,!0)}return s.a.inherits(r,l.a),(r.isAvailable=function(){return!!o})()&&(t.supportedTransports[i]=r),r.tryConnect=function(t,e,n,i){function o(t){i({event:this.event,error:t})}var s=new r(t,e,n);s.on(["failed","disconnected"],o),s.on("wsopen",function(){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.tryConnect()","viable transport "+s),s.off(["failed","disconnected"],o),i(null,s)}),s.connect()},r.prototype.createWebSocket=function(t,e){var n=0;if(e)for(var i in e)t+=(n++?"&":"?")+i+"="+e[i];return this.uri=t,new o(t)},r.prototype.toString=function(){return"WebSocketTransport; uri="+this.uri},r.prototype.connect=function(){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.connect()","starting"),l.a.prototype.connect.call(this);var r=this,a=this.params,t=a.options,c=(t.tls?"wss://":"ws://")+this.wsHost+":"+h.a.getPort(t)+"/";p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.connect()","uri: "+c),this.auth.getAuthParams(function(t,e){if(!r.isDisposed){var n,i="";for(n in e)i+=" "+n+": "+e[n]+";";if(p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+i+" err: "+t),t)r.disconnect(t);else{var o=a.getConnectParams(e);try{var s=r.wsConnection=r.createWebSocket(c,o);s.binaryType=u.a.binaryType,s.onopen=function(){r.onWsOpen()},s.onclose=function(t){r.onWsClose(t)},s.onmessage=function(t){r.onWsData(t.data)},s.onerror=function(t){r.onWsError(t)},s.on&&s.on("ping",function(){r.onActivity()})}catch(t){p.a.logAction(p.a.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(t.stack||t.message)),r.disconnect(t)}}}})},r.prototype.send=function(t){var e=this.wsConnection;if(e)try{e.send(a.a.serialize(t,this.params.format))}catch(t){var n="Exception from ws connection when trying to send: "+s.a.inspectError(t);p.a.logAction(p.a.LOG_ERROR,"WebSocketTransport.send()",n),this.finish("disconnected",new c.a(n,5e4,500))}else p.a.logAction(p.a.LOG_ERROR,"WebSocketTransport.send()","No socket connection")},r.prototype.onWsData=function(t){p.a.logAction(p.a.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+t.length+"; type = "+typeof t);try{this.onProtocolMessage(a.a.deserialize(t,this.format))}catch(t){p.a.logAction(p.a.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+t.stack)}},r.prototype.onWsOpen=function(){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("wsopen")},r.prototype.onWsClose=function(t){var e,n,i;"object"==typeof t?(e=t.wasClean,n=t.code):e=1e3==(n=t),delete this.wsConnection,e?(p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket"),i=new c.a("Websocket closed",80003,400)):(n="Unclean disconnection of WebSocket ; code = "+n,i=new c.a(n,80003,400),p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.onWsClose()",n)),this.finish("disconnected",i),this.emit("disposed")},r.prototype.onWsError=function(t){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+t.message);var e=this;s.a.nextTick(function(){e.disconnect(t)})},r.prototype.dispose=function(){p.a.logAction(p.a.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;var t=this.wsConnection;t&&(t.onmessage=function(){},delete this.wsConnection,s.a.nextTick(function(){p.a.logAction(p.a.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),t.close()}))},r}},function(t,e,n){"use strict";function i(t){var i="xhr_polling";function r(t,e,n){n.stream=!1,u.a.call(this,t,e,n),this.shortName=i}return s.a.inherits(r,u.a),r.isAvailable=function(){return c.a.xhrSupported&&c.a.allowComet},r.tryConnect=function(t,e,n,i){function o(t){i({event:this.event,error:t})}var s=new r(t,e,n);s.on(["failed","disconnected"],o),s.on("preconnect",function(){a.a.logAction(a.a.LOG_MINOR,"XHRPollingTransport.tryConnect()","viable transport "+s),s.off(["failed","disconnected"],o),i(null,s)}),s.connect()},r.prototype.toString=function(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},r.prototype.createRequest=function(t,e,n,i,o){return l.a.createRequest(t,e,n,i,o,this.timeouts)},void 0!==t&&r.isAvailable()&&(t.supportedTransports[i]=r),r}var o=n(33),s=n(1),a=n(0),c=n(3),u=n(13),l=n(26),n=function(t){var i="xhr_streaming";function r(t,e,n){u.a.call(this,t,e,n),this.shortName=i}return s.a.inherits(r,u.a),r.isAvailable=function(){return c.a.xhrSupported&&c.a.streamingSupported&&c.a.allowComet},r.tryConnect=function(t,e,n,i){function o(t){i({event:this.event,error:t})}var s=new r(t,e,n);s.on(["failed","disconnected"],o),s.on("preconnect",function(){a.a.logAction(a.a.LOG_MINOR,"XHRStreamingTransport.tryConnect()","viable transport "+s),s.off(["failed","disconnected"],o),i(null,s)}),s.connect()},r.prototype.toString=function(){return"XHRStreamingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},r.prototype.createRequest=function(t,e,n,i,o){return l.a.createRequest(t,e,n,i,o,this.timeouts)},void 0!==t&&r.isAvailable()&&(t.supportedTransports[i]=r),r};e.a=[o.a,i,n]},function(t,e){},function(t,e,n){var r;t.exports=(r=n(18),function(o){var t=r,e=t.lib,n=e.WordArray,i=e.Hasher,e=t.algo,s=[],g=[];!function(){function t(t){return 4294967296*(t-(0|t))|0}for(var e=2,n=0;n<64;)!function(t){for(var e=o.sqrt(t),n=2;n<=e;n++)if(!(t%n))return;return 1}(e)||(n<8&&(s[n]=t(o.pow(e,.5))),g[n]=t(o.pow(e,1/3)),n++),e++}();var m=[],e=e.SHA256=i.extend({_doReset:function(){this._hash=new n.init(s.slice(0))},_doProcessBlock:function(t,e){for(var n=this._hash.words,i=n[0],o=n[1],s=n[2],r=n[3],a=n[4],c=n[5],u=n[6],l=n[7],h=0;h<64;h++){h<16?m[h]=0|t[e+h]:(d=((f=m[h-15])<<25|f>>>7)^(f<<14|f>>>18)^f>>>3,f=((p=m[h-2])<<15|p>>>17)^(p<<13|p>>>19)^p>>>10,m[h]=d+m[h-7]+f+m[h-16]);var p=i&o^i&s^o&s,d=(i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22),f=l+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&c^~a&u)+g[h]+m[h],l=u,u=c,c=a,a=r+f|0,r=s,s=o,o=i,i=f+(d+p)|0}n[0]=n[0]+i|0,n[1]=n[1]+o|0,n[2]=n[2]+s|0,n[3]=n[3]+r|0,n[4]=n[4]+a|0,n[5]=n[5]+c|0,n[6]=n[6]+u|0,n[7]=n[7]+l|0},_doFinalize:function(){var t=this._data,e=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;return e[i>>>5]|=128<<24-i%32,e[14+(64+i>>>9<<4)]=o.floor(n/4294967296),e[15+(64+i>>>9<<4)]=n,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=i.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA256=i._createHelper(e),t.HmacSHA256=i._createHmacHelper(e)}(Math),r.SHA256)},function(t,e,n){var i;t.exports=(i=n(18),void function(){var t=i.lib.Base,a=i.enc.Utf8;i.algo.HMAC=t.extend({init:function(t,e){t=this._hasher=new t.init,"string"==typeof e&&(e=a.parse(e));var n=t.blockSize,i=4*n;e.sigBytes>i&&(e=t.finalize(e)),e.clamp();for(var t=this._oKey=e.clone(),e=this._iKey=e.clone(),o=t.words,s=e.words,r=0;r<n;r++)o[r]^=1549556828,s[r]^=909522486;t.sigBytes=e.sigBytes=i,this.reset()},reset:function(){var t=this._hasher;t.reset(),t.update(this._iKey)},update:function(t){return this._hasher.update(t),this},finalize:function(t){var e=this._hasher,t=e.finalize(t);return e.reset(),e.finalize(this._oKey.clone().concat(t))}})}())},function(t,e,n){"use strict";n.r(e);var i=n(3),y=n(1),v=n(0),o=n(4),O=n(12);function s(){this.id=void 0,this.deviceSecret=void 0,this.platform=void 0,this.formFactor=void 0,this.clientId=void 0,this.metadata=void 0,this.deviceIdentityToken=void 0,this.push={recipient:void 0,state:void 0,error:void 0}}var R,a=(s.prototype.toJSON=function(){return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:this.push.recipient,state:this.push.state,error:this.push.error}}},s.prototype.toString=function(){var t="[DeviceDetails";return this.id&&(t+="; id="+this.id),this.platform&&(t+="; platform="+this.platform),this.formFactor&&(t+="; formFactor="+this.formFactor),this.clientId&&(t+="; clientId="+this.clientId),this.metadata&&(t+="; metadata="+this.metadata),this.deviceIdentityToken&&(t+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),this.push.recipient&&(t+="; push.recipient="+JSON.stringify(this.push.recipient)),this.push.state&&(t+="; push.state="+this.push.state),this.push.error&&(t+="; push.error="+JSON.stringify(this.push.error)),this.push.metadata&&(t+="; push.metadata="+this.push.metadata),t+="]"},s.toRequestBody=y.a.encodeBody,s.fromResponseBody=function(t,e){return e&&(t=y.a.decodeBody(t,e)),y.a.isArray(t)?s.fromValuesArray(t):s.fromValues(t)},s.fromValues=function(t){return t.error=t.error&&ErrorInfo.fromValues(t.error),y.a.mixin(new s,t)},s.fromValuesArray=function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i++)n[i]=s.fromValues(t[i]);return n},s),A=n(5),b=n(6);function c(){}function C(t,n,i,o,s){A.a.supportsAuthHeaders?t.auth.getAuthHeaders(function(t,e){t?o(t):s(y.a.mixin(e,n),i)}):t.auth.getAuthParams(function(t,e){t?o(t):s(n,y.a.mixin(e,i))})}function w(t){var e=[];if(t)for(var n in t)e.push(n+"="+t[n]);return e.join("&")}function S(t,e){return t+(e?"?":"")+w(e)}var u=(R=i.a.msgpack,y.a.arrForEach(A.a.methodsWithoutBody,function(r){c[r]=function(t,e,n,i,o,s){c.do(r,t,e,null,n,i,o,s)}}),y.a.arrForEach(A.a.methodsWithBody,function(a){c[a]=function(t,e,n,i,o,s,r){c.do(a,t,e,n,i,o,s,r)}}),c.do=function(o,r,a,c,u,l,t,h){var s,p,d,f,g,m;v.a.shouldLog(v.a.LOG_MICRO)&&(s=h,p=o,d=a,f=l,h=function(t,e,n,i,o){t?v.a.logAction(v.a.LOG_MICRO,"Resource."+p+"()","Received Error; "+S(d,f)+"; Error: "+y.a.inspectError(t)):v.a.logAction(v.a.LOG_MICRO,"Resource."+p+"()","Received; "+S(d,f)+"; Headers: "+w(n)+"; StatusCode: "+o+"; Body: "+(b.a.isBuffer(e)?e.toString():e)),s&&s(t,e,n,i,o)}),t&&(h=h&&(g=h,m=t,function(t,e,n,i,o){if(!t||e){if(!i)try{e=y.a.decodeBody(e,m)}catch(t){return void g(t)}if(void 0!==e.statusCode){var s=e.statusCode,r=e.response,a=e.headers;if(s<200||300<=s){i=r&&r.error||t;return i||((i=new Error("Error in unenveloping "+e)).statusCode=s),void g(i,r,a,!0,s)}g(t,r,a,!0,s)}else g(t,e,n,!0,o)}else g(t)}),(l=l||{}).envelope=t),C(r,u,l,h,function s(t,e){v.a.shouldLog(v.a.LOG_MICRO)&&v.a.logAction(v.a.LOG_MICRO,"Resource."+o+"()","Sending; "+S(a,e));var n=[r,a,t,c,e,function(t,e,n,i,o){t&&O.a.isTokenErr(t)?r.auth.authorize(null,null,function(t){t?h(t):C(r,u,l,h,s)}):h(t,e,n,i,o)}];if(c||n.splice(3,1),v.a.shouldLog(v.a.LOG_MICRO)){var i=c;if(0<(t["content-type"]||"").indexOf("msgpack"))try{i=R.decode(c)}catch(t){v.a.logAction(v.a.LOG_MICRO,"Resource."+o+"()","Sending MsgPack Decoding Error: "+y.a.inspectError(t))}v.a.logAction(v.a.LOG_MICRO,"Resource."+o+"()","Sending; "+S(a,e)+"; Body: "+i)}A.a[o].apply(this,n)})},c);function h(t){"string"==typeof t&&(t=t.split(","));for(var e={},n=0;n<t.length;n++){var i,o=t[n].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);!o||(i=(i=(i=o[1]).match(/^\.\/(\w+)\?(.*)$/))&&y.a.parseQueryString(i[2]))&&(e[o[2]]=i)}return e}function r(t,e,n,i,o,s){this.rest=t,this.path=e,this.headers=n,this.envelope=i,this.bodyHandler=o,this.useHttpPaginatedResponse=s||!1}function p(t,e,n){var i;this.resource=t,this.items=e,n&&(i=this,"first"in n&&(this.first=function(t){if(!t&&i.resource.rest.options.promises)return y.a.promisify(i,"first",[]);i.get(n.first,t)}),"current"in n&&(this.current=function(t){if(!t&&i.resource.rest.options.promises)return y.a.promisify(i,"current",[]);i.get(n.current,t)}),this.next=function(t){if(!t&&i.resource.rest.options.promises)return y.a.promisify(i,"next",[]);"next"in n?i.get(n.next,t):t(null,null)},this.hasNext=function(){return"next"in n},this.isLast=function(){return!this.hasNext()})}function d(t,e,n,i,o,s){p.call(this,t,e,o),this.statusCode=i,this.success=i<300&&200<=i,this.headers=n,this.errorCode=s&&s.code,this.errorMessage=s&&s.message}var l=(y.a.arrForEach(A.a.methodsWithoutBody,function(e){r.prototype[e]=function(t,s){var r=this;u[e](r.rest,r.path,r.headers,t,r.envelope,function(t,e,n,i,o){r.handlePage(t,e,n,i,o,s)})}}),y.a.arrForEach(A.a.methodsWithBody,function(n){r.prototype[n]=function(t,e,s){var r=this;u[n](r.rest,r.path,e,r.headers,t,r.envelope,function(t,e,n,i,o){s&&r.handlePage(t,e,n,i,o,s)})}}),r.prototype.handlePage=function(e,t,n,i,o,s){if(e&&(r=e,a=t,!this.useHttpPaginatedResponse||!a&&"number"!=typeof r.code))return v.a.logAction(v.a.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+y.a.inspectError(e)),void s(e);var r,a,c,u,l;try{c=this.bodyHandler(t,n,i)}catch(t){return void s(e||t)}n&&(u=n.Link||n.link)&&(l=h(u)),this.useHttpPaginatedResponse?s(null,new d(this,c,n,o,l,e)):s(null,new p(this,c,l))},p.prototype.get=function(t,s){var r=this.resource;u.get(r.rest,r.path,r.headers,t,r.envelope,function(t,e,n,i,o){r.handlePage(t,e,n,i,o,s)})},y.a.inherits(d,p),r),m=n(2);function f(){this.channel=void 0,this.deviceId=void 0,this.clientId=void 0}var g=(f.prototype.toJSON=function(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}},f.prototype.toString=function(){var t="[PushChannelSubscription";return this.channel&&(t+="; channel="+this.channel),this.deviceId&&(t+="; deviceId="+this.deviceId),this.clientId&&(t+="; clientId="+this.clientId),t+="]"},f.toRequestBody=y.a.encodeBody,f.fromResponseBody=function(t,e){return e&&(t=y.a.decodeBody(t,e)),y.a.isArray(t)?f.fromValuesArray(t):f.fromValues(t)},f.fromValues=function(t){return y.a.mixin(new f,t)},f.fromValuesArray=function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i++)n[i]=f.fromValues(t[i]);return n},f);function T(){}function I(t){this.rest=t,this.deviceRegistrations=new M(t),this.channelSubscriptions=new _(t)}function M(t){this.rest=t}function _(t){this.rest=t}var k=(I.prototype.publish=function(t,e,n){var i=this.rest,o=i.options.useBinaryProtocol?"msgpack":"json",s=y.a.mixin({recipient:t},e),t=y.a.defaultPostHeaders(o),e={};if("function"!=typeof n){if(this.rest.options.promises)return y.a.promisify(this,"publish",arguments);n=T}i.options.headers&&y.a.mixin(t,i.options.headers),i.options.pushFullWait&&y.a.mixin(e,{fullWait:"true"}),s=y.a.encodeBody(s,o),u.post(i,"/push/publish",s,t,e,!1,function(t){n(t)})},M.prototype.save=function(t,o){var e=this.rest,s=e.options.useBinaryProtocol?"msgpack":"json",n=a.fromValues(t),i=y.a.defaultPostHeaders(s),r={};if("function"!=typeof o){if(this.rest.options.promises)return y.a.promisify(this,"save",arguments);o=T}e.options.headers&&y.a.mixin(i,e.options.headers),e.options.pushFullWait&&y.a.mixin(r,{fullWait:"true"}),n=y.a.encodeBody(n,s),u.put(e,"/push/deviceRegistrations/"+encodeURIComponent(t.id),n,i,r,!1,function(t,e,n,i){o(t,!t&&a.fromResponseBody(e,!i&&s))})},M.prototype.get=function(t,o){var e=this.rest,s=e.options.useBinaryProtocol?"msgpack":"json",n=y.a.defaultGetHeaders(s),t=t.id||t;if("function"!=typeof o){if(this.rest.options.promises)return y.a.promisify(this,"get",arguments);o=T}"string"==typeof t&&t.length?(e.options.headers&&y.a.mixin(n,e.options.headers),u.get(e,"/push/deviceRegistrations/"+encodeURIComponent(t),n,{},!1,function(t,e,n,i){o(t,!t&&a.fromResponseBody(e,!i&&s))})):o(new m.a("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400))},M.prototype.list=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,s=y.a.defaultGetHeaders(i);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"list",arguments);e=T}n.options.headers&&y.a.mixin(s,n.options.headers),new l(n,"/push/deviceRegistrations",s,o,function(t,e,n){return a.fromResponseBody(t,!n&&i)}).get(t,e)},M.prototype.remove=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=y.a.defaultGetHeaders(i),i={},t=t.id||t;if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"remove",arguments);e=T}"string"==typeof t&&t.length?(n.options.headers&&y.a.mixin(o,n.options.headers),n.options.pushFullWait&&y.a.mixin(i,{fullWait:"true"}),u.delete(n,"/push/deviceRegistrations/"+encodeURIComponent(t),o,i,!1,function(t){e(t)})):e(new m.a("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400))},M.prototype.removeWhere=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",i=y.a.defaultGetHeaders(i);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"removeWhere",arguments);e=T}n.options.headers&&y.a.mixin(i,n.options.headers),n.options.pushFullWait&&y.a.mixin(t,{fullWait:"true"}),u.delete(n,"/push/deviceRegistrations",i,t,!1,function(t){e(t)})},_.prototype.save=function(t,o){var e=this.rest,s=e.options.useBinaryProtocol?"msgpack":"json",n=g.fromValues(t),i=y.a.defaultPostHeaders(s),t={};if("function"!=typeof o){if(this.rest.options.promises)return y.a.promisify(this,"save",arguments);o=T}e.options.headers&&y.a.mixin(i,e.options.headers),e.options.pushFullWait&&y.a.mixin(t,{fullWait:"true"}),n=y.a.encodeBody(n,s),u.post(e,"/push/channelSubscriptions",n,i,t,!1,function(t,e,n,i){o(t,!t&&g.fromResponseBody(e,!i&&s))})},_.prototype.list=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,s=y.a.defaultGetHeaders(i);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"list",arguments);e=T}n.options.headers&&y.a.mixin(s,n.options.headers),new l(n,"/push/channelSubscriptions",s,o,function(t,e,n){return g.fromResponseBody(t,!n&&i)}).get(t,e)},_.prototype.remove=_.prototype.removeWhere=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",i=y.a.defaultGetHeaders(i);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"removeWhere",arguments);e=T}n.options.headers&&y.a.mixin(i,n.options.headers),n.options.pushFullWait&&y.a.mixin(t,{fullWait:"true"}),u.delete(n,"/push/channelSubscriptions",i,t,!1,function(t){e(t)})},_.prototype.listChannels=function(t,e){var n=this.rest,o=n.options.useBinaryProtocol?"msgpack":"json",i=A.a.supportsLinkHeaders?void 0:o,s=y.a.defaultGetHeaders(o);if("function"!=typeof e){if(this.rest.options.promises)return y.a.promisify(this,"listChannels",arguments);e=T}n.options.headers&&y.a.mixin(s,n.options.headers),n.options.pushFullWait&&y.a.mixin(t,{fullWait:"true"}),new l(n,"/push/channels",s,i,function(t,e,n){!n&&o&&(t=y.a.decodeBody(t,o));for(var i=0;i<t.length;i++)t[i]=String(t[i]);return t}).get(t,e)},function(t){this.rest=t,this.admin=new I(t)}),E=n(7),P=n(10);function L(){}function x(t){this.channel=t,this.basePath=t.basePath+"/presence"}var N=(y.a.inherits(x,E.a),x.prototype.get=function(t,e){if(v.a.logAction(v.a.LOG_MICRO,"Presence.get()","channel = "+this.channel.name),void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.channel.rest.options.promises)return y.a.promisify(this,"get",arguments);e=L}var n=this.channel.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,s=y.a.defaultGetHeaders(i);n.options.headers&&y.a.mixin(s,n.options.headers);var r=this.channel.channelOptions;new l(n,this.basePath,s,o,function(t,e,n){return P.a.fromResponseBody(t,r,!n&&i)}).get(t,e)},x.prototype.history=function(t,e){v.a.logAction(v.a.LOG_MICRO,"Presence.history()","channel = "+this.channel.name),this._history(t,e)},x.prototype._history=function(t,e){if(void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.channel.rest.options.promises)return y.a.promisify(this,"_history",arguments);e=L}var n=this.channel.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,s=y.a.defaultGetHeaders(i);this.channel;n.options.headers&&y.a.mixin(s,n.options.headers);var r=this.channel.channelOptions;new l(n,this.basePath+"/history",s,o,function(t,e,n){return P.a.fromResponseBody(t,r,!n&&i)}).get(t,e)},x),U=n(15),G=n.n(U),q=n(9);function H(){}function B(t,e,n){v.a.logAction(v.a.LOG_MINOR,"Channel()","started; name = "+e),E.a.call(this),this.rest=t,this.name=e,this.basePath="/channels/"+encodeURIComponent(e),this.presence=new N(this),this.setOptions(n)}var D=(y.a.inherits(B,E.a),B.prototype.setOptions=function(t){if(this.channelOptions=t=t||{},t.cipher){if(!G.a)throw new Error("Encryption not enabled; use ably.encryption.js instead");var e=G.a.getCipher(t.cipher);t.cipher=e.cipherParams,t.channelCipher=e.cipher}else"cipher"in t&&(t.cipher=null,t.channelCipher=null)},B.prototype.history=function(t,e){if(v.a.logAction(v.a.LOG_MICRO,"Channel.history()","channel = "+this.name),void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.rest.options.promises)return y.a.promisify(this,"history",arguments);e=H}this._history(t,e)},B.prototype._history=function(t,e){var n=this.rest,i=n.options.useBinaryProtocol?"msgpack":"json",o=A.a.supportsLinkHeaders?void 0:i,s=y.a.defaultGetHeaders(i);n.options.headers&&y.a.mixin(s,n.options.headers);var r=this.channelOptions;new l(n,this.basePath+"/messages",s,o,function(t,e,n){return q.a.fromResponseBody(t,r,!n&&i)}).get(t,e)},B.prototype.publish=function(){var n,i,t=arguments[0],e=arguments[1],o=arguments[arguments.length-1],s=this;if("function"!=typeof o){if(this.rest.options.promises)return y.a.promisify(this,"publish",arguments);o=H}if("string"==typeof t||null===t)n=[q.a.fromValues({name:t,data:e})],i=arguments[2];else if(y.a.isObject(t))n=[q.a.fromValues(t)],i=arguments[1];else{if(!y.a.isArray(t))throw new m.a("The single-argument form of publish() expects a message object or an array of message objects",40013,400);n=q.a.fromValuesArray(t),i=arguments[1]}"object"==typeof i&&i||(i={});var r,t=this.rest,a=t.options,c=a.useBinaryProtocol?"msgpack":"json",t=t.options.idempotentRestPublishing,u=y.a.defaultPostHeaders(c);a.headers&&y.a.mixin(u,a.headers),t&&(t=n,y.a.arrEvery(t,function(t){return!t.id}))&&(r=y.a.randomString(9),y.a.arrForEach(n,function(t,e){t.id=r+":"+e.toString()})),q.a.encodeArray(n,this.channelOptions,function(t){var e;t?o(t):(e=q.a.getMessagesSize(n),(t=a.maxMessageSize)<e?o(new m.a("Maximum size of messages that can be published at once exceeded ( was "+e+" bytes; limit is "+t+" bytes)",40009,400)):s._publish(q.a.serialize(n,c),u,i,o))})},B.prototype._publish=function(t,e,n,i){u.post(this.rest,this.basePath+"/messages",t,e,n,!1,i)},B);function j(t){this.count=t&&t.count||0,this.data=t&&t.data||0,this.uncompressedData=t&&t.uncompressedData||0,this.failed=t&&t.failed||0,this.refused=t&&t.refused||0}function F(e){var n=this;j.call(this,e),this.category=void 0,e&&e.category&&(this.category={},y.a.forInOwnNonNullProps(e.category,function(t){n.category[t]=new j(e.category[t])}))}function V(t){this.peak=t&&t.peak||0,this.min=t&&t.min||0,this.mean=t&&t.mean||0,this.opened=t&&t.opened||0,this.refused=t&&t.refused||0}function z(t){this.succeeded=t&&t.succeeded||0,this.failed=t&&t.failed||0,this.refused=t&&t.refused||0}function W(t){this.plain=new V(t&&t.plain),this.tls=new V(t&&t.tls),this.all=new V(t&&t.all)}function J(t){this.messages=new F(t&&t.messages),this.presence=new F(t&&t.presence),this.all=new F(t&&t.all)}function K(t){this.realtime=new J(t&&t.realtime),this.rest=new J(t&&t.rest),this.webhook=new J(t&&t.webhook),this.sharedQueue=new J(t&&t.sharedQueue),this.externalQueue=new J(t&&t.externalQueue),this.httpEvent=new J(t&&t.httpEvent),this.push=new J(t&&t.push),this.all=new J(t&&t.all)}function Q(t){this.all=new J(t&&t.all),this.inbound=new K(t&&t.inbound),this.outbound=new K(t&&t.outbound)}function X(t){this.all=new J(t&&t.all),this.producerPaid=new Q(t&&t.producerPaid),this.consumerPaid=new Q(t&&t.consumerPaid)}function Y(t){this.messages=t&&t.messages||0;var e=t&&t.notifications;this.notifications={invalid:e&&e.invalid||0,attempted:e&&e.attempted||0,successful:e&&e.successful||0,failed:e&&e.failed||0},this.directPublishes=t&&t.directPublishes||0}function $(t){this.succeeded=t&&t.succeeded||0,this.skipped=t&&t.skipped||0,this.failed=t&&t.failed||0}function Z(e){var n=this;this.delta=void 0,e&&e.delta&&(this.delta={},y.a.forInOwnNonNullProps(e.delta,function(t){n.delta[t]=new $(e.delta[t])}))}function tt(t){Q.call(this,t),this.persisted=new J(t&&t.persisted),this.connections=new W(t&&t.connections),this.channels=new V(t&&t.channels),this.apiRequests=new z(t&&t.apiRequests),this.tokenRequests=new z(t&&t.tokenRequests),this.xchgProducer=new X(t&&t.xchgProducer),this.xchgConsumer=new X(t&&t.xchgConsumer),this.push=new Y(t&&t.pushStats),this.processed=new Z(t&&t.processed),this.inProgress=t&&t.inProgress||void 0,this.unit=t&&t.unit||void 0,this.intervalId=t&&t.intervalId||void 0}var et,nt=(tt.fromValues=function(t){return new tt(t)},tt),it=(et=i.a.msgpack,st.prototype.stats=function(t,e){if(void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.options.promises)return y.a.promisify(this,"stats",arguments);e=ot}var n=y.a.defaultGetHeaders(),i=this.options.useBinaryProtocol?"msgpack":"json",i=A.a.supportsLinkHeaders?void 0:i;this.options.headers&&y.a.mixin(n,this.options.headers),new l(this,"/stats",n,i,function(t,e,n){for(var i=n?t:JSON.parse(t),o=0;o<i.length;o++)i[o]=nt.fromValues(i[o]);return i}).get(t,e)},st.prototype.time=function(t,o){if(void 0===o)if("function"==typeof t)o=t,t=null;else{if(this.options.promises)return y.a.promisify(this,"time",arguments);o=ot}var e=y.a.defaultGetHeaders();this.options.headers&&y.a.mixin(e,this.options.headers);var s=this;A.a.get(this,function(t){return s.authority(t)+"/time"},e,t,function(t,e,n,i){if(t)o(t);else{i||(e=JSON.parse(e));e=e[0];if(!e)return(t=new Error("Internal error (unexpected result type from GET /time)")).statusCode=500,void o(t);s.serverTimeOffset=e-y.a.now(),o(null,e)}})},st.prototype.request=function(t,e,n,i,o,s){var r=this.options.useBinaryProtocol,a=r?et.encode:JSON.stringify,c=r?et.decode:JSON.parse,u=r?"msgpack":"json",r=A.a.supportsLinkHeaders?void 0:u;n=n||{};u="get"==(t=t.toLowerCase())?y.a.defaultGetHeaders(u):y.a.defaultPostHeaders(u);if(void 0===s){if(this.options.promises)return y.a.promisify(this,"request",[t,e,n,i,o]);s=ot}"string"!=typeof i&&(i=a(i)),this.options.headers&&y.a.mixin(u,this.options.headers),o&&y.a.mixin(u,o);r=new l(this,e,u,r,function(t,e,n){return y.a.ensureArray(n?t:c(t))},!0);if(!y.a.arrIn(A.a.methods,t))throw new m.a("Unsupported method "+t,40500,405);y.a.arrIn(A.a.methodsWithBody,t)?r[t](n,i,s):r[t](n,s)},st.prototype.setLog=function(t){v.a.setLog(t.level,t.handler)},rt.prototype.get=function(t,e){t=String(t);var n=this.all[t];return n?e&&n.setOptions(e):this.all[t]=n=new D(this.rest,t,e),n},rt.prototype.release=function(t){delete this.all[String(t)]},st);function ot(){}function st(e){if(!(this instanceof st))return new st(e);if(!e){var t="no options provided";throw v.a.logAction(v.a.LOG_ERROR,"Rest()",t),new Error(t)}if((e=o.a.objectifyOptions(e)).log&&v.a.setLog(e.log.level,e.log.handler),v.a.logAction(v.a.LOG_MICRO,"Rest()","initialized with clientOptions "+y.a.inspect(e)),this.options=o.a.normaliseOptions(e),e.key){var n=e.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!n){t="invalid key parameter";throw v.a.logAction(v.a.LOG_ERROR,"Rest()",t),new Error(t)}e.keyName=n[1],e.keySecret=n[2]}if("clientId"in e){if("string"!=typeof e.clientId&&null!==e.clientId)throw new m.a("clientId must be either a string or null",40012,400);if("*"===e.clientId)throw new m.a('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}v.a.logAction(v.a.LOG_MINOR,"Rest()","started; version = "+o.a.libstring),this.baseUri=this.authority=function(t){return o.a.getHttpScheme(e)+t+":"+o.a.getPort(e,!1)},this._currentFallback=null,this.serverTimeOffset=null,this.auth=new O.a(this,e),this.channels=new rt(this),this.push=new k(this)}function rt(t){this.rest=t,this.all={}}it.Promise=function(t){return(t=o.a.objectifyOptions(t)).promises=!0,new it(t)};var at=it.Callbacks=it,ct=n(24),ut=n(19);function lt(){}function ht(t,e){E.a.call(this),this.ably=t,this.connectionManager=new ct.a(t,e),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.serial=void 0,this.timeSerial=void 0,this.recoveryKey=void 0,this.errorReason=null;var n=this;this.connectionManager.on("connectionstate",function(t){var e=n.state=t.current;y.a.nextTick(function(){n.emit(e,t)})}),this.connectionManager.on("update",function(t){y.a.nextTick(function(){n.emit("update",t)})})}var pt=(y.a.inherits(ht,E.a),ht.prototype.whenState=function(t,e){return E.a.prototype.whenState.call(this,t,this.state,e,new ut.a(void 0,t))},ht.prototype.connect=function(){v.a.logAction(v.a.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})},ht.prototype.ping=function(t){if(v.a.logAction(v.a.LOG_MINOR,"Connection.ping()",""),!t){if(this.ably.options.promises)return y.a.promisify(this,"ping",arguments);t=lt}this.connectionManager.ping(null,t)},ht.prototype.close=function(){v.a.logAction(v.a.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})},ht),dt=n(8),ft=n(11),gt=n(20),mt=function(t,e,n,i){this.previous=t,"attached"===(this.current=e)&&(this.resumed=n),i&&(this.reason=i)};function yt(){}function vt(t){return t.clientId+":"+t.connectionId}function Ot(t){var e=t.channel.realtime,t=e.auth.clientId;return(!t||"*"===t)&&"connected"===e.connection.state}function Rt(t,e){N.call(this,t),this.syncComplete=!1,this.members=new At(this),this._myMembers=new At(this),this.subscriptions=new E.a,this.pendingPresence=[]}function At(t){E.a.call(this),this.presence=t,this.map={},this.syncInProgress=!1,this.residualMembers=null}function bt(t,e){if(t.isSynthesized()||e.isSynthesized())return t.timestamp>e.timestamp;t=t.parseId(),e=e.parseId();return t.msgSerial===e.msgSerial?t.index>e.index:t.msgSerial>e.msgSerial}var Ct,wt,St,Tt=(y.a.inherits(Rt,N),Rt.prototype.enter=function(t,e){if(Ot(this))throw new m.a("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,t,"enter",e)},Rt.prototype.update=function(t,e){if(Ot(this))throw new m.a("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,t,"update",e)},Rt.prototype.enterClient=function(t,e,n){return this._enterOrUpdateClient(t,e,"enter",n)},Rt.prototype.updateClient=function(t,e,n){return this._enterOrUpdateClient(t,e,"update",n)},Rt.prototype._enterOrUpdateClient=function(t,e,n,i){if(!i)if("function"==typeof e)i=e,e=null;else{if(this.channel.realtime.options.promises)return y.a.promisify(this,"_enterOrUpdateClient",[t,e,n]);i=yt}var o,s,r=this.channel;r.connectionManager.activeState()?(v.a.logAction(v.a.LOG_MICRO,"RealtimePresence."+n+"Client()","channel = "+r.name+", client = "+(t||"(implicit) "+this.channel.realtime.auth.clientId)),o=P.a.fromValues({action:n,data:e}),t&&(o.clientId=t),s=this,P.a.encode(o,r.channelOptions,function(t){if(t)i(t);else switch(r.state){case"attached":r.sendPresence(o,i);break;case"initialized":case"detached":r.attach();case"attaching":s.pendingPresence.push({presence:o,callback:i});break;default:(t=new m.a("Unable to "+n+" presence channel while in "+r.state+" state",90001)).code=90001,i(t)}})):i(r.connectionManager.getError())},Rt.prototype.leave=function(t,e){if(Ot(this))throw new m.a("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,t,e)},Rt.prototype.leaveClient=function(t,e,n){if(!n)if("function"==typeof e)n=e,e=null;else{if(this.channel.realtime.options.promises)return y.a.promisify(this,"leaveClient",[t,e]);n=yt}var i=this.channel;if(i.connectionManager.activeState()){v.a.logAction(v.a.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+t);e=P.a.fromValues({action:"leave",data:e});switch(t&&(e.clientId=t),i.state){case"attached":i.sendPresence(e,n);break;case"attaching":this.pendingPresence.push({presence:e,callback:n});break;case"initialized":case"failed":n(new m.a("Unable to leave presence channel (incompatible state)",90001));break;default:n(ft.a.failed)}}else n(i.connectionManager.getError())},Rt.prototype.get=function(){var t=Array.prototype.slice.call(arguments);1==t.length&&"function"==typeof t[0]&&t.unshift(null);var e,n=t[0],i=t[1],o=!n||!("waitForSync"in n)||n.waitForSync;if(!i){if(this.channel.realtime.options.promises)return y.a.promisify(this,"get",t);i=yt}function s(t){i(null,n?t.list(n):t.values())}"suspended"!==this.channel.state?function(t,e,n){switch(t.state){case"attached":case"suspended":n();break;case"initialized":case"detached":case"detaching":case"attaching":t.attach(function(t){t?e(t):n()});break;default:e(m.a.fromValues(_t.invalidStateError(t.state)))}}((e=this).channel,i,function(){var t=e.members;o?t.waitSync(function(){s(t)}):s(t)}):o?i(m.a.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):s(this.members)},Rt.prototype.history=function(t,e){if(v.a.logAction(v.a.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name),void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.channel.realtime.options.promises)return y.a.promisify(this,"history",arguments);e=yt}t&&t.untilAttach&&("attached"===this.channel.state?(delete t.untilAttach,t.from_serial=this.channel.properties.attachSerial):e(new m.a("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400))),N.prototype._history.call(this,t,e)},Rt.prototype.setPresence=function(t,e,n){v.a.logAction(v.a.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+t.length+" participants; syncChannelSerial = "+n);var i,o,s=this.members,r=this._myMembers,a=[],c=this.channel.connectionManager.connectionId;e&&(this.members.startSync(),n&&(o=n.match(/^[\w\-]+:(.*)$/))&&(i=o[1]));for(var u=0;u<t.length;u++)switch((l=P.a.fromValues(t[u])).action){case"leave":s.remove(l)&&a.push(l),l.connectionId!==c||l.isSynthesized()||r.remove(l);break;case"enter":case"present":case"update":s.put(l)&&a.push(l),l.connectionId===c&&r.put(l)}e&&!i&&(s.endSync(),this._ensureMyMembersPresent(),this.channel.setInProgress(_t.progressOps.sync,!1),this.channel.syncChannelSerial=null);for(u=0;u<a.length;u++){var l=a[u];this.subscriptions.emit(l.action,l)}},Rt.prototype.onAttached=function(t){v.a.logAction(v.a.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+t),t?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear(),this._ensureMyMembersPresent());var e=this.pendingPresence,n=e.length;if(n){this.pendingPresence=[];var i=[],o=Object(gt.a)();v.a.logAction(v.a.LOG_MICRO,"RealtimePresence.onAttached","sending "+n+" queued presence messages");for(var s=0;s<n;s++){var r=e[s];i.push(r.presence),o.push(r.callback)}this.channel.sendPresence(i,o)}},Rt.prototype.actOnChannelState=function(t,e,n){switch(t){case"attached":this.onAttached(e);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(n)}},Rt.prototype.failPendingPresence=function(t){if(this.pendingPresence.length){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+y.a.inspectError(t));for(var e=0;e<this.pendingPresence.length;e++)try{this.pendingPresence[e].callback(t)}catch(t){}this.pendingPresence=[]}},Rt.prototype._clearMyMembers=function(){this._myMembers.clear()},Rt.prototype._ensureMyMembersPresent=function(){function t(t){var e;t&&(e="Presence auto-re-enter failed: "+t.toString(),t=new m.a(e,91004,400),v.a.logAction(v.a.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()",e),t=new mt(i.channel.state,i.channel.state,!0,t),i.channel.emit("update",t))}var e,n,i=this,o=this.members,s=this._myMembers;for(e in s.map)e in o.map||(n=s.map[e],v.a.logAction(v.a.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+n.clientId+'" into the presence set'),this._enterOrUpdateClient(n.clientId,n.data,"enter",t),delete s.map[e])},Rt.prototype._synthesizeLeaves=function(t){var e=this.subscriptions;y.a.arrForEach(t,function(t){t=P.a.fromValues({action:"leave",connectionId:t.connectionId,clientId:t.clientId,data:t.data,encoding:t.encoding,timestamp:y.a.now()});e.emit("leave",t)})},Rt.prototype.on=function(){v.a.deprecated("presence.on","presence.subscribe"),this.subscribe.apply(this,arguments)},Rt.prototype.off=function(){v.a.deprecated("presence.off","presence.unsubscribe"),this.unsubscribe.apply(this,arguments)},Rt.prototype.subscribe=function(){var t=_t.processListenerArgs(arguments),e=t[0],n=t[1],i=t[2],t=this.channel;if(!i){if(this.channel.realtime.options.promises)return y.a.promisify(this,"subscribe",[e,n]);i=yt}"failed"!==t.state?(this.subscriptions.on(e,n),t.attach(i)):i(m.a.fromValues(_t.invalidStateError("failed")))},Rt.prototype.unsubscribe=function(){var t=_t.processListenerArgs(arguments),e=t[0],t=t[1];this.subscriptions.off(e,t)},y.a.inherits(At,E.a),At.prototype.get=function(t){return this.map[t]},At.prototype.getClient=function(t){var e,n=this.map,i=[];for(e in n){var o=n[e];o.clientId==t&&"absent"!=o.action&&i.push(o)}return i},At.prototype.list=function(t){var e,n=this.map,i=t&&t.clientId,o=t&&t.connectionId,s=[];for(e in n){var r=n[e];"absent"!==r.action&&(i&&i!=r.clientId||o&&o!=r.connectionId||s.push(r))}return s},At.prototype.put=function(t){"enter"!==t.action&&"update"!==t.action||((t=P.a.fromValues(t)).action="present");var e=this.map,n=vt(t);this.residualMembers&&delete this.residualMembers[n];var i=e[n];return!(i&&!bt(t,i))&&(e[n]=t,!0)},At.prototype.values=function(){var t,e=this.map,n=[];for(t in e){var i=e[t];"absent"!=i.action&&n.push(i)}return n},At.prototype.remove=function(t){var e=this.map,n=vt(t),i=e[n];return!(i&&!bt(t,i))&&(this.syncInProgress?((t=P.a.fromValues(t)).action="absent",e[n]=t):delete e[n],!0)},At.prototype.startSync=function(){var t=this.map,e=this.syncInProgress;v.a.logAction(v.a.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+e),this.syncInProgress||(this.residualMembers=y.a.copy(t),this.setInProgress(!0))},At.prototype.endSync=function(){var t=this.map,e=this.syncInProgress;if(v.a.logAction(v.a.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+e),e){for(var n in t)"absent"===t[n].action&&delete t[n];for(var n in this.presence._synthesizeLeaves(y.a.valuesArray(this.residualMembers)),this.residualMembers)delete t[n];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")},At.prototype.waitSync=function(t){var e=this.syncInProgress;v.a.logAction(v.a.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+e),e?this.once("sync",t):t()},At.prototype.clear=function(t){this.map={},this.setInProgress(!1),this.residualMembers=null},At.prototype.setInProgress=function(t){v.a.logAction(v.a.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+t),this.syncInProgress=t,this.presence.syncComplete=!t},Rt);function It(){}function Mt(t,e,n){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel()","started; name = "+e),D.call(this,t,e,n),this.realtime=t,this.presence=new Tt(this,t.options),this.connectionManager=t.connection.connectionManager,this.state="initialized",this.subscriptions=new E.a,this.syncChannelSerial=void 0,this.properties={attachSerial:void 0},this.setOptions(n),this.errorReason=null,this._requestedFlags=null,this._mode=null,this._attachedMsgIndicator=!1,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:t.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new E.a}var _t=(Ct=dt.a.Action,wt="statechange",St="sync",y.a.inherits(Mt,D),Mt.invalidStateError=function(t){return{statusCode:400,code:90001,message:"Channel operation failed as channel state is "+t}},Mt.progressOps={statechange:wt,sync:St},Mt.processListenerArgs=function(t){return"function"==typeof(t=Array.prototype.slice.call(t))[0]&&t.unshift(null),null==t[t.length-1]&&t.pop(),t},Mt.prototype.setOptions=function(t,e){if(!e){if(this.rest.options.promises)return y.a.promisify(this,"setOptions",arguments);e=function(t){t&&v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.setOptions()","Set options failed: "+t.toString())}}var n=function(t){if(t&&"params"in t&&!y.a.isObject(t.params))return new m.a("options.params must be an object",4e4,400);if(t&&"modes"in t){if(!y.a.isArray(t.modes))return new m.a("options.modes must be an array",4e4,400);for(var e=0;e<t.modes.length;e++){var n=t.modes[e];if(!n||"string"!=typeof n||!y.a.arrIn(dt.a.channelModes,String.prototype.toUpperCase.call(n)))return new m.a("Invalid channel mode: "+n,4e4,400)}}}(t);n?e(n):(D.prototype.setOptions.call(this,t),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(t)?(this.attachImpl(),this._allChannelChanges.once(function(t){switch(this.event){case"update":case"attached":return void e(null);default:return void e(t.reason)}})):e())},Mt.prototype._shouldReattachToSetOptions=function(t){return("attached"===this.state||"attaching"===this.state)&&(t.params||t.modes)},Mt.prototype.publish=function(){var t=arguments.length,e=arguments[0],n=arguments[t-1];if("function"!=typeof n){if(this.realtime.options.promises)return y.a.promisify(this,"publish",arguments);n=It,++t}if(this.connectionManager.activeState()){if(2==t)if(y.a.isObject(e))e=[q.a.fromValues(e)];else{if(!y.a.isArray(e))throw new m.a("The single-argument form of publish() expects a message object or an array of message objects",40013,400);e=q.a.fromValuesArray(e)}else e=[q.a.fromValues({name:arguments[0],data:arguments[1]})];var i=this,o=this.realtime.options.maxMessageSize;q.a.encodeArray(e,this.channelOptions,function(t){t?n(t):(t=q.a.getMessagesSize(e),o<t?n(new m.a("Maximum size of messages that can be published at once exceeded ( was "+t+" bytes; limit is "+o+" bytes)",40009,400)):i._publish(e,n))})}else n(this.connectionManager.getError())},Mt.prototype._publish=function(t,e){v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.publish()","message count = "+t.length);var n=this.state;switch(n){case"failed":case"suspended":e(m.a.fromValues(Mt.invalidStateError(n)));break;default:v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+n);n=new dt.a;n.action=Ct.MESSAGE,n.channel=this.name,n.messages=t,this.sendMessage(n,e)}},Mt.prototype.onEvent=function(t){v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var e=this.subscriptions,n=0;n<t.length;n++){var i=t[n];e.emit(i.name,i)}},Mt.prototype.attach=function(t,e){if("function"==typeof t&&(e=t,t=null),!e){if(this.realtime.options.promises)return y.a.promisify(this,"attach",arguments);e=function(t){t&&v.a.logAction(v.a.LOG_MAJOR,"RealtimeChannel.attach()","Channel attach failed: "+t.toString())}}if(t)v.a.deprecated("channel.attach() with flags","channel.setOptions() with channelOptions.params"),this._requestedFlags=t;else if("attached"===this.state)return void e();this._attach(!1,null,e)},Mt.prototype._attach=function(t,e,n){n=n||function(t){t&&v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+t.toString())};var i=this.connectionManager;i.activeState()?("attaching"===this.state&&!t||this.requestState("attaching",e),this.once(function(t){switch(this.event){case"attached":n();break;case"detached":case"suspended":case"failed":n(t.reason||i.getError());break;case"detaching":n(new m.a("Attach request superseded by a subsequent detach request",9e4,409))}})):n(i.getError())},Mt.prototype.attachImpl=function(){v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message"),this.setInProgress(wt,!0);var t=dt.a.fromValues({action:Ct.ATTACH,channel:this.name,params:this.channelOptions.params});this._requestedFlags?t.encodeModesToFlags(this._requestedFlags):this.channelOptions.modes&&t.encodeModesToFlags(y.a.allToUpperCase(this.channelOptions.modes)),this._attachResume&&t.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(t.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(t,It)},Mt.prototype.detach=function(e){if(!e){if(this.realtime.options.promises)return y.a.promisify(this,"detach",arguments);e=It}var n=this.connectionManager;if(n.activeState())switch(this.state){case"detached":case"failed":e();break;default:this.requestState("detaching");case"detaching":this.once(function(t){switch(this.event){case"detached":e();break;case"attached":case"suspended":case"failed":e(t.reason||n.getError());break;case"attaching":e(new m.a("Detach request superseded by a subsequent attach request",9e4,409))}})}else e(n.getError())},Mt.prototype.detachImpl=function(t){v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message"),this.setInProgress(wt,!0);var e=dt.a.fromValues({action:Ct.DETACH,channel:this.name});this.sendMessage(e,t||It)},Mt.prototype.subscribe=function(){var t=Mt.processListenerArgs(arguments),e=t[0],n=t[1],t=t[2];if(!t){if(this.realtime.options.promises)return y.a.promisify(this,"subscribe",[e,n]);t=It}if("failed"!==this.state)return this.subscriptions.on(e,n),this.attach(t);t(m.a.fromValues(Mt.invalidStateError("failed")))},Mt.prototype.unsubscribe=function(){var t=Mt.processListenerArgs(arguments),e=t[0],t=t[1];this.subscriptions.off(e,t)},Mt.prototype.sync=function(){switch(this.state){case"initialized":case"detaching":case"detached":throw new m.a("Unable to sync to channel; not attached",4e4)}var t=this.connectionManager;if(!t.activeState())throw t.getError();var e=dt.a.fromValues({action:Ct.SYNC,channel:this.name});this.syncChannelSerial&&(e.channelSerial=this.syncChannelSerial),t.send(e)},Mt.prototype.sendMessage=function(t,e){this.connectionManager.send(t,this.realtime.options.queueMessages,e)},Mt.prototype.sendPresence=function(t,e){t=dt.a.fromValues({action:Ct.PRESENCE,channel:this.name,presence:y.a.isArray(t)?P.a.fromValuesArray(t):[P.a.fromValues(t)]});this.sendMessage(t,e)},Mt.prototype.onMessage=function(t){var e=!1;switch(t.action){case Ct.ATTACHED:this._attachedMsgIndicator=!0,this.properties.attachSerial=t.channelSerial,this._mode=t.getMode(),this.params=t.params||{};var n=t.decodeModesFromFlags();this.modes=n&&y.a.allToLowerCase(n)||void 0;var i=t.hasFlag("RESUMED"),o=t.hasFlag("HAS_PRESENCE");"attached"===this.state?(this.setInProgress(wt,!1),i||this.presence.onAttached(o),n=new mt(this.state,this.state,i,t.error),this._allChannelChanges.emit("update",n),i&&!this.channelOptions.updateOnAttached||this.emit("update",n)):this.notifyState("attached",t.error,i,o);break;case Ct.DETACHED:var s=t.error?m.a.fromValues(t.error):new m.a("Channel detached",90001,404);"detaching"===this.state?this.notifyState("detached",s):"attaching"===this.state?this.notifyState("suspended",s):this.requestState("attaching",s);break;case Ct.SYNC:if(e=!0,f=this.syncChannelSerial=t.channelSerial,!t.presence)break;case Ct.PRESENCE:for(var r=t.presence,a=t.id,c=t.connectionId,u=t.timestamp,l=this.channelOptions,h=0;h<r.length;h++){try{var p=r[h];P.a.decode(p,l)}catch(t){v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.onMessage()",t.toString())}p.connectionId||(p.connectionId=c),p.timestamp||(p.timestamp=u),p.id||(p.id=a+":"+h)}this.presence.setPresence(r,e,f);break;case Ct.MESSAGE:if("attached"!==this.state)return void v.a.logAction(v.a.LOG_MAJOR,"RealtimeChannel.onMessage()",'Message "'+t.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');var d=t.messages,e=d[0],f=d[d.length-1],a=t.id,c=t.connectionId,u=t.timestamp;if(e.extras&&e.extras.delta&&e.extras.delta.from!==this._lastPayload.messageId){var g='Delta message decode failure - previous message not available for message "'+t.id+'" on this channel "'+this.name+'".';v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.onMessage()",g),this._startDecodeFailureRecovery(new m.a(g,40018,400));break}for(h=0;h<d.length;h++){g=d[h];try{q.a.decode(g,this._decodingContext)}catch(t){switch(v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.onMessage()",t.toString()),t.code){case 40018:return void this._startDecodeFailureRecovery(t);case 40019:case 40021:return void this.notifyState("failed",t)}}g.connectionId||(g.connectionId=c),g.timestamp||(g.timestamp=u),g.id||(g.id=a+":"+h)}this._lastPayload.messageId=f.id,this._lastPayload.protocolMessageChannelSerial=t.channelSerial,this.onEvent(d);break;case Ct.ERROR:(s=t.error)&&80016==s.code?this.checkPendingState():this.notifyState("failed",m.a.fromValues(s));break;default:v.a.logAction(v.a.LOG_ERROR,"RealtimeChannel.onMessage()","Fatal protocol error: unrecognised action ("+t.action+")"),this.connectionManager.abort(ft.a.unknownChannelErr)}},Mt.prototype._startDecodeFailureRecovery=function(t){var e=this;this._lastPayload.decodeFailureRecoveryInProgress||(v.a.logAction(v.a.LOG_MAJOR,"RealtimeChannel.onMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,t,function(){e._lastPayload.decodeFailureRecoveryInProgress=!1}))},Mt.prototype.onAttached=function(){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)},Mt.prototype.notifyState=function(t,e,n,i){var o;v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+t),this.clearStateTimer(),t!==this.state&&(this.presence.actOnChannelState(t,i,e),"suspended"===t&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),e&&(this.errorReason=e),o=new mt(this.state,t,n,e),n="failed"===t?v.a.LOG_ERROR:v.a.LOG_MAJOR,v.a.logAction(n,'Channel state for channel "'+this.name+'"',t+(e?"; reason: "+e:"")),"attached"===t?(this.onAttached(),this.setInProgress(St,i),this.setInProgress(wt,!1)):"detached"!==t&&"failed"!==t&&"suspended"!==t||(this.setInProgress(wt,!1),this.setInProgress(St,!1)),"attached"===t?this._attachResume=!0:"detaching"!==t&&"failed"!==t||(this._attachResume=!1),this.state=t,this._allChannelChanges.emit(t,o),this.emit(t,o))},Mt.prototype.requestState=function(t,e){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+t),this.notifyState(t,e),this.checkPendingState()},Mt.prototype.checkPendingState=function(){var t=this.connectionManager.state;if(t.sendEvents||t.forceQueueEvents)switch(v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync()}else v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state)},Mt.prototype.timeoutPendingState=function(){switch(this.state){case"attaching":var t=new m.a("Channel attach timed out",90007,408);this.notifyState("suspended",t);break;case"detaching":t=new m.a("Channel detach timed out",90007,408);this.notifyState("attached",t);break;default:this.checkPendingState()}},Mt.prototype.startStateTimerIfNotRunning=function(){var t=this;this.stateTimer||(this.stateTimer=setTimeout(function(){v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),t.stateTimer=null,t.timeoutPendingState()},this.realtime.options.timeouts.realtimeRequestTimeout))},Mt.prototype.clearStateTimer=function(){var t=this.stateTimer;t&&(clearTimeout(t),this.stateTimer=null)},Mt.prototype.startRetryTimer=function(){var t=this;this.retryTimer||(this.retryTimer=setTimeout(function(){"suspended"===t.state&&t.connectionManager.state.sendEvents&&(t.retryTimer=null,v.a.logAction(v.a.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),t.requestState("attaching"))},this.realtime.options.timeouts.channelRetryTimeout))},Mt.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.suspendTimer=null)},Mt.prototype.setInProgress=function(t,e){this.rest.channels.setInProgress(this,t,e)},Mt.prototype.history=function(t,e){if(v.a.logAction(v.a.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name),void 0===e)if("function"==typeof t)e=t,t=null;else{if(this.rest.options.promises)return y.a.promisify(this,"history",arguments);e=It}if(t&&t.untilAttach){if("attached"!==this.state)return void e(new m.a("option untilAttach requires the channel to be attached",4e4,400));if(!this.properties.attachSerial)return void e(new m.a("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400));delete t.untilAttach,t.from_serial=this.properties.attachSerial}D.prototype._history.call(this,t,e)},Mt.prototype.whenState=function(t,e){return E.a.prototype.whenState.call(this,t,this.state,e)},Mt.prototype.getReleaseErr=function(){var t=this.state;return"initialized"===t||"detached"===t||"failed"===t?null:new m.a("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+t,90001,400)},Mt),kt=n(21),Et=(y.a.inherits(Pt,at),Pt.prototype.connect=function(){v.a.logAction(v.a.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()},Pt.prototype.close=function(){v.a.logAction(v.a.LOG_MINOR,"Realtime.close()",""),this.connection.close()},y.a.inherits(Lt,E.a),Lt.prototype.onChannelMessage=function(t){var e,n=t.channel;void 0!==n?(e=this.all[n])?e.onMessage(t):v.a.logAction(v.a.LOG_ERROR,"Channels.onChannelMessage()","received event for non-existent channel: "+n):v.a.logAction(v.a.LOG_ERROR,"Channels.onChannelMessage()","received event unspecified channel, action = "+t.action)},Lt.prototype.onTransportActive=function(){for(var t in this.all){var e=this.all[t];"attaching"===e.state||"detaching"===e.state?e.checkPendingState():"suspended"===e.state&&e.attach()}},Lt.prototype.reattach=function(t){for(var e in this.all){var n=this.all[e];"attached"===n.state&&n.requestState("attaching",t)}},Lt.prototype.resetAttachedMsgIndicators=function(){for(var t in this.all){var e=this.all[t];"attached"===e.state&&(e._attachedMsgIndicator=!1)}},Lt.prototype.checkAttachedMsgIndicators=function(t){for(var e in this.all){var n,i=this.all[e];"attached"===i.state&&!1===i._attachedMsgIndicator&&(n="30s after a resume, found channel which has not received an attached; channelId = "+e+"; connectionId = "+t,v.a.logAction(v.a.LOG_ERROR,"Channels.checkAttachedMsgIndicators()",n),kt.a.report("error",n,"channel-no-attached-after-resume"),i.requestState("attaching"))}},Lt.prototype.propogateConnectionInterruption=function(t,e){var n,i=["attaching","attached","detaching","suspended"],o={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"}[t];for(n in this.all){var s=this.all[n];y.a.arrIn(i,s.state)&&s.notifyState(o,e)}},Lt.prototype.get=function(t,e){t=String(t);var n=this.all[t];if(n){if(e){if(n._shouldReattachToSetOptions(e))throw new m.a("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);n.setOptions(e)}}else n=this.all[t]=new _t(this.realtime,t,e);return n},Lt.prototype.release=function(t){t=String(t);var e=this.all[t];if(e){e=e.getReleaseErr();if(e)throw e;delete this.all[t],delete this.inProgress[t]}},Lt.prototype.setInProgress=function(t,e,n){this.inProgress[t.name]=this.inProgress[t.name]||{},!(this.inProgress[t.name][e]=n)&&this.hasNopending()&&this.emit("nopending")},Lt.prototype.onceNopending=function(t){this.hasNopending()?t():this.once("nopending",t)},Lt.prototype.hasNopending=function(){return y.a.arrEvery(y.a.valuesArray(this.inProgress,!0),function(t){return!y.a.containsValue(t,!0)})},Pt);function Pt(t){if(!(this instanceof Pt))return new Pt(t);v.a.logAction(v.a.LOG_MINOR,"Realtime()",""),at.call(this,t),this.connection=new pt(this,this.options),this.channels=new Lt(this),!1!==t.autoConnect&&this.connect()}function Lt(t){E.a.call(this),this.realtime=t,this.all={},this.inProgress={};var e=this;t.connection.connectionManager.on("transport.active",function(){e.onTransportActive()})}Et.Promise=function(t){return(t=o.a.objectifyOptions(t)).promises=!0,new Et(t)};i=Et.Callbacks=Et,n=n(23);at.Utils=y.a,at.BufferUtils=b.a,at.Crypto=G.a,at.Defaults=o.a,at.Http=A.a,at.Resource=u,at.Message=q.a,at.PresenceMessage=P.a,i.Utils=y.a,i.BufferUtils=b.a,i.Crypto=G.a,i.Defaults=o.a,i.Http=A.a,i.Message=q.a,i.PresenceMessage=P.a,i.ProtocolMessage=dt.a,i.ConnectionManager=ct.a;e.default={Rest:at,Realtime:i,msgpack:n.a}}],o.c=i,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=39).default;function o(t){if(i[t])return i[t].exports;var e=i[t]={i:t,l:!1,exports:{}};return n[t].call(e.exports,e,e.exports,o),e.l=!0,e.exports}var n,i});