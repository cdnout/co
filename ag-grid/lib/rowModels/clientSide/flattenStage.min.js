"use strict";var __decorate=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,l=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(l=(n<3?i(l):3<n?i(t,o,l):i(t,o))||l);return 3<n&&l&&Object.defineProperty(t,o,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../../context/context"),rowNode_1=require("../../entities/rowNode"),gridOptionsWrapper_1=require("../../gridOptionsWrapper"),selectionController_1=require("../../selectionController"),eventService_1=require("../../eventService"),columnController_1=require("../../columnController/columnController"),utils_1=require("../../utils"),FlattenStage=function(){function e(){}return e.prototype.execute=function(e){var t=e.rowNode,o=[],r={value:0},i=this.columnController.isPivotMode(),n=i&&t.leafGroup,e=n?[t]:t.childrenAfterSort;return this.recursivelyAddToRowsToDisplay(e,o,r,i,0),!n&&this.gridOptionsWrapper.isGroupIncludeTotalFooter()&&(this.ensureFooterNodeExists(t),this.addRowNodeToRowsToDisplay(t.sibling,o,r,0)),o},e.prototype.recursivelyAddToRowsToDisplay=function(e,t,o,r,i){if(!utils_1._.missingOrEmpty(e))for(var n=this.gridOptionsWrapper.isGroupSuppressRow(),l=this.gridOptionsWrapper.isGroupHideOpenParents(),s=this.gridOptionsWrapper.isGroupRemoveSingleChildren(),d=!s&&this.gridOptionsWrapper.isGroupRemoveLowestSingleChildren(),a=0;a<e.length;a++){var p=e[a],c=p.hasChildren(),u=n&&c,_=r&&!c,f=s&&c&&1===p.childrenAfterGroup.length,h=d&&c&&p.leafGroup&&1===p.childrenAfterGroup.length,v=r&&p.leafGroup,v=l&&p.expanded&&!v;!(_||u||v||f||h)&&this.addRowNodeToRowsToDisplay(p,t,o,i),r&&p.leafGroup||(c?(h=f||h,(p.expanded||h)&&(h=h?i:i+1,this.recursivelyAddToRowsToDisplay(p.childrenAfterSort,t,o,r,h),this.gridOptionsWrapper.isGroupIncludeFooter()&&(this.ensureFooterNodeExists(p),this.addRowNodeToRowsToDisplay(p.sibling,t,o,i)))):p.master&&p.expanded&&(p=this.createDetailNode(p),this.addRowNodeToRowsToDisplay(p,t,o,i)))}},e.prototype.addRowNodeToRowsToDisplay=function(e,t,o,r){t.push(e);t=this.gridOptionsWrapper.isGroupMultiAutoColumn();e.setUiLevel(t?0:r)},e.prototype.ensureFooterNodeExists=function(t){var o;utils_1._.exists(t.sibling)||(o=new rowNode_1.RowNode,this.context.wireBean(o),Object.keys(t).forEach(function(e){o[e]=t[e]}),o.footer=!0,o.rowTop=null,o.oldRowTop=null,utils_1._.exists(o.id)&&(o.id="rowGroupFooter_"+o.id),(o.sibling=t).sibling=o)},e.prototype.createDetailNode=function(e){if(utils_1._.exists(e.detailNode))return e.detailNode;var t=new rowNode_1.RowNode;return this.context.wireBean(t),t.detail=!0,t.selectable=!1,t.flower=t.detail,t.parent=e,utils_1._.exists(e.id)&&(t.id="detail_"+e.id),t.data=e.data,t.level=e.level+1,e.detailNode=t,e.childFlower=e.detailNode,t},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("selectionController"),__metadata("design:type",selectionController_1.SelectionController)],e.prototype,"selectionController",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Autowired("context"),__metadata("design:type",context_1.Context)],e.prototype,"context",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Bean("flattenStage")],e)}();exports.FlattenStage=FlattenStage;