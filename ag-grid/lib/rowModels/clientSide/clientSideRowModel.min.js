"use strict";var __decorate=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,s=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;0<=a;a--)(i=e[a])&&(s=(n<3?i(s):3<n?i(t,o,s):i(t,o))||s);return 3<n&&s&&Object.defineProperty(t,o,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var RecursionType,constants_1=require("../../constants"),gridOptionsWrapper_1=require("../../gridOptionsWrapper"),columnApi_1=require("../../columnController/columnApi"),columnController_1=require("../../columnController/columnController"),filterManager_1=require("../../filter/filterManager"),rowNode_1=require("../../entities/rowNode"),eventService_1=require("../../eventService"),events_1=require("../../events"),context_1=require("../../context/context"),selectionController_1=require("../../selectionController"),clientSideNodeManager_1=require("./clientSideNodeManager"),changedPath_1=require("./changedPath"),valueService_1=require("../../valueService/valueService"),valueCache_1=require("../../valueService/valueCache"),gridApi_1=require("../../gridApi"),utils_1=require("../../utils");!function(e){e[e.Normal=0]="Normal",e[e.AfterFilter=1]="AfterFilter",e[e.AfterFilterAndSort=2]="AfterFilterAndSort",e[e.PivotNodes=3]="PivotNodes"}(RecursionType=RecursionType||{});var ClientSideRowModel=function(){function e(){}return e.prototype.init=function(){var e=this.refreshModel.bind(this,{step:constants_1.Constants.STEP_EVERYTHING}),t=this.refreshModel.bind(this,{step:constants_1.Constants.STEP_EVERYTHING,afterColumnsChanged:!0});this.eventService.addModalPriorityEventListener(events_1.Events.EVENT_COLUMN_EVERYTHING_CHANGED,t),this.eventService.addModalPriorityEventListener(events_1.Events.EVENT_COLUMN_ROW_GROUP_CHANGED,e),this.eventService.addModalPriorityEventListener(events_1.Events.EVENT_COLUMN_VALUE_CHANGED,this.onValueChanged.bind(this)),this.eventService.addModalPriorityEventListener(events_1.Events.EVENT_COLUMN_PIVOT_CHANGED,this.refreshModel.bind(this,{step:constants_1.Constants.STEP_PIVOT})),this.eventService.addModalPriorityEventListener(events_1.Events.EVENT_ROW_GROUP_OPENED,this.onRowGroupOpened.bind(this)),this.eventService.addModalPriorityEventListener(events_1.Events.EVENT_FILTER_CHANGED,this.onFilterChanged.bind(this)),this.eventService.addModalPriorityEventListener(events_1.Events.EVENT_SORT_CHANGED,this.onSortChanged.bind(this)),this.eventService.addModalPriorityEventListener(events_1.Events.EVENT_COLUMN_PIVOT_MODE_CHANGED,e);e=this.refreshModel.bind(this,{step:constants_1.Constants.STEP_MAP,keepRenderedRows:!0,animate:!0});this.gridOptionsWrapper.addEventListener(gridOptionsWrapper_1.GridOptionsWrapper.PROP_GROUP_REMOVE_SINGLE_CHILDREN,e),this.gridOptionsWrapper.addEventListener(gridOptionsWrapper_1.GridOptionsWrapper.PROP_GROUP_REMOVE_LOWEST_SINGLE_CHILDREN,e),this.rootNode=new rowNode_1.RowNode,this.nodeManager=new clientSideNodeManager_1.ClientSideNodeManager(this.rootNode,this.gridOptionsWrapper,this.context,this.eventService,this.columnController,this.gridApi,this.columnApi,this.selectionController),this.context.wireBean(this.rootNode)},e.prototype.ensureRowHeightsValid=function(e,t,o,r){var i,n=!1;do{i=!1;for(var s=this.getRowIndexAtPixel(e),a=this.getRowIndexAtPixel(t),s=Math.max(s,o),d=Math.min(a,r),p=s;p<=d;p++){var l,c=this.getRow(p);c.rowHeightEstimated&&(l=this.gridOptionsWrapper.getRowHeightForNode(c),c.setRowHeight(l.height),n=i=!0)}}while(i&&this.setRowTops(),i);return n},e.prototype.setRowTops=function(){for(var e=0,t=0;t<this.rowsToDisplay.length;t++){var o=this.gridOptionsWrapper.getDomLayout()===constants_1.Constants.DOM_LAYOUT_NORMAL,r=this.rowsToDisplay[t];utils_1._.missing(r.rowHeight)&&(o=this.gridOptionsWrapper.getRowHeightForNode(r,o),r.setRowHeight(o.height,o.estimated)),r.setRowTop(e),r.setRowIndex(t),e+=r.rowHeight}},e.prototype.resetRowTops=function(e,t){if(e.clearRowTop(),e.hasChildren()){if(e.childrenAfterGroup)if(!(t.isActive()&&!e.expanded))for(var o=0;o<e.childrenAfterGroup.length;o++)this.resetRowTops(e.childrenAfterGroup[o],t);e.sibling&&e.sibling.clearRowTop()}e.detailNode&&e.detailNode.clearRowTop()},e.prototype.ensureRowAtPixel=function(e,t){t=this.getRowIndexAtPixel(t);return this.getRow(t)!==e&&(utils_1._.removeFromArray(this.rootNode.allLeafChildren,e),utils_1._.insertIntoArray(this.rootNode.allLeafChildren,e,t),this.refreshModel({step:constants_1.Constants.STEP_EVERYTHING,keepRenderedRows:!0,animate:!0,keepEditingRows:!0}),!0)},e.prototype.isLastRowFound=function(){return!0},e.prototype.getRowCount=function(){return this.rowsToDisplay?this.rowsToDisplay.length:0},e.prototype.getTopLevelRowCount=function(){return this.rowsToDisplay&&this.rowsToDisplay[0]===this.rootNode?1:this.rootNode.childrenAfterFilter?this.rootNode.childrenAfterFilter.length:0},e.prototype.getTopLevelRowDisplayedIndex=function(e){if(this.rowsToDisplay&&this.rowsToDisplay[0]===this.rootNode)return e;var t=this.rootNode.childrenAfterSort[e];if(this.gridOptionsWrapper.isGroupHideOpenParents())for(;t.expanded&&t.childrenAfterSort&&0<t.childrenAfterSort.length;)t=t.childrenAfterSort[0];return t.rowIndex},e.prototype.getRowBounds=function(e){if(utils_1._.missing(this.rowsToDisplay))return null;e=this.rowsToDisplay[e];return e?{rowTop:e.rowTop,rowHeight:e.rowHeight}:null},e.prototype.onRowGroupOpened=function(){var e=this.gridOptionsWrapper.isAnimateRows();this.refreshModel({step:constants_1.Constants.STEP_MAP,keepRenderedRows:!0,animate:e})},e.prototype.onFilterChanged=function(){var e=this.gridOptionsWrapper.isAnimateRows();this.refreshModel({step:constants_1.Constants.STEP_FILTER,keepRenderedRows:!0,animate:e})},e.prototype.onSortChanged=function(){var e=this.gridOptionsWrapper.isAnimateRows();this.refreshModel({step:constants_1.Constants.STEP_SORT,keepRenderedRows:!0,animate:e,keepEditingRows:!0})},e.prototype.getType=function(){return constants_1.Constants.ROW_MODEL_TYPE_CLIENT_SIDE},e.prototype.onValueChanged=function(){this.columnController.isPivotActive()?this.refreshModel({step:constants_1.Constants.STEP_PIVOT}):this.refreshModel({step:constants_1.Constants.STEP_AGGREGATE})},e.prototype.createChangePath=function(e){var t=utils_1._.missingOrEmpty(e),e=new changedPath_1.ChangedPath(!1,this.rootNode);return(t||this.gridOptionsWrapper.isTreeData())&&e.setInactive(),e},e.prototype.refreshModel=function(e){var t=this,o=this.createChangePath(e.rowNodeTransactions);switch(e.step){case constants_1.Constants.STEP_EVERYTHING:this.doRowGrouping(e.groupState,e.rowNodeTransactions,e.rowNodeOrder,o,e.afterColumnsChanged);case constants_1.Constants.STEP_FILTER:this.doFilter(o);case constants_1.Constants.STEP_PIVOT:this.doPivot(o);case constants_1.Constants.STEP_AGGREGATE:this.doAggregate(o);case constants_1.Constants.STEP_SORT:this.doSort(e.rowNodeTransactions,o);case constants_1.Constants.STEP_MAP:this.doRowsToDisplay()}this.resetRowTops(this.rootNode,o),this.setRowTops();e={type:events_1.Events.EVENT_MODEL_UPDATED,api:this.gridApi,columnApi:this.columnApi,animate:e.animate,keepRenderedRows:e.keepRenderedRows,newData:e.newData,newPage:!1};this.eventService.dispatchEvent(e),this.$scope&&window.setTimeout(function(){t.$scope.$apply()},0)},e.prototype.isEmpty=function(){var e=utils_1._.exists(this.gridOptionsWrapper.getNodeChildDetailsFunc())?utils_1._.missing(this.rootNode.childrenAfterGroup)||0===this.rootNode.childrenAfterGroup.length:utils_1._.missing(this.rootNode.allLeafChildren)||0===this.rootNode.allLeafChildren.length;return utils_1._.missing(this.rootNode)||e||!this.columnController.isReady()},e.prototype.isRowsToRender=function(){return utils_1._.exists(this.rowsToDisplay)&&0<this.rowsToDisplay.length},e.prototype.getNodesInRangeForSelection=function(i,n){var s,a=!n,d=!1,p=[],l=this.gridOptionsWrapper.isGroupSelectsChildren();return this.forEachNodeAfterFilterAndSort(function(e){var t,o,r=a&&!d;a||e!==n&&e!==i||(a=!0),e.group&&l||(t=a&&!d,o=e.isParentOfNode(s),(t||o)&&p.push(e)),r&&(e!==n&&e!==i||(d=!0,s=e===n?n:i))}),p},e.prototype.setDatasource=function(e){console.error("ag-Grid: should never call setDatasource on clientSideRowController")},e.prototype.getTopLevelNodes=function(){return this.rootNode?this.rootNode.childrenAfterGroup:null},e.prototype.getRootNode=function(){return this.rootNode},e.prototype.getRow=function(e){return this.rowsToDisplay[e]},e.prototype.isRowPresent=function(e){return 0<=this.rowsToDisplay.indexOf(e)},e.prototype.getRowIndexAtPixel=function(e){if(this.isEmpty())return-1;var t=0,o=this.rowsToDisplay.length-1;if(e<=0)return 0;if(utils_1._.last(this.rowsToDisplay).rowTop<=e)return this.rowsToDisplay.length-1;for(;;){var r=Math.floor((t+o)/2),i=this.rowsToDisplay[r];if(this.isRowInPixel(i,e))return r;i.rowTop<e?t=r+1:i.rowTop>e&&(o=r-1)}},e.prototype.isRowInPixel=function(e,t){var o=e.rowTop,e=e.rowTop+e.rowHeight;return o<=t&&t<e},e.prototype.getCurrentPageHeight=function(){if(this.rowsToDisplay&&0<this.rowsToDisplay.length){var e=utils_1._.last(this.rowsToDisplay);return e.rowTop+e.rowHeight}return 0},e.prototype.forEachLeafNode=function(o){this.rootNode.allLeafChildren&&this.rootNode.allLeafChildren.forEach(function(e,t){return o(e,t)})},e.prototype.forEachNode=function(e){this.recursivelyWalkNodesAndCallback(this.rootNode.childrenAfterGroup,e,RecursionType.Normal,0)},e.prototype.forEachNodeAfterFilter=function(e){this.recursivelyWalkNodesAndCallback(this.rootNode.childrenAfterFilter,e,RecursionType.AfterFilter,0)},e.prototype.forEachNodeAfterFilterAndSort=function(e){this.recursivelyWalkNodesAndCallback(this.rootNode.childrenAfterSort,e,RecursionType.AfterFilterAndSort,0)},e.prototype.forEachPivotNode=function(e){this.recursivelyWalkNodesAndCallback([this.rootNode],e,RecursionType.PivotNodes,0)},e.prototype.recursivelyWalkNodesAndCallback=function(e,t,o,r){if(e)for(var i=0;i<e.length;i++){var n=e[i];if(t(n,r++),n.hasChildren()){var s=null;switch(o){case RecursionType.Normal:s=n.childrenAfterGroup;break;case RecursionType.AfterFilter:s=n.childrenAfterFilter;break;case RecursionType.AfterFilterAndSort:s=n.childrenAfterSort;break;case RecursionType.PivotNodes:s=n.leafGroup?null:n.childrenAfterSort}s&&(r=this.recursivelyWalkNodesAndCallback(s,t,o,r))}}return r},e.prototype.doAggregate=function(e){this.aggregationStage&&this.aggregationStage.execute({rowNode:this.rootNode,changedPath:e})},e.prototype.expandOrCollapseAll=function(r){var i=this.gridOptionsWrapper.isTreeData();this.rootNode&&!function o(e){if(!e)return;e.forEach(function(e){var t=i?utils_1._.exists(e.childrenAfterGroup):e.group;t&&(e.expanded=r,o(e.childrenAfterGroup))})}(this.rootNode.childrenAfterGroup),this.refreshModel({step:constants_1.Constants.STEP_MAP});var e=r?"expandAll":"collapseAll",e={api:this.gridApi,columnApi:this.columnApi,type:events_1.Events.EVENT_EXPAND_COLLAPSE_ALL,source:e};this.eventService.dispatchEvent(e)},e.prototype.doSort=function(e,t){this.sortStage.execute({rowNode:this.rootNode,rowNodeTransactions:e,changedPath:t})},e.prototype.doRowGrouping=function(e,t,o,r,i){var n=this;utils_1._.exists(this.gridOptionsWrapper.getNodeChildDetailsFunc())||(this.groupStage?(t&&utils_1._.exists(t)?t.forEach(function(e){n.groupStage.execute({rowNode:n.rootNode,rowNodeTransaction:e,rowNodeOrder:o,changedPath:r})}):(this.selectionController.removeGroupsFromSelection(),this.groupStage.execute({rowNode:this.rootNode,changedPath:r,afterColumnsChanged:i}),this.restoreGroupState(e)),this.gridOptionsWrapper.isGroupSelectsChildren()&&this.selectionController.updateGroupsFromChildrenSelections(r)):this.rootNode.childrenAfterGroup=this.rootNode.allLeafChildren)},e.prototype.restoreGroupState=function(o){o&&utils_1._.traverseNodesWithKey(this.rootNode.childrenAfterGroup,function(e,t){"boolean"==typeof o[t]&&(e.expanded=o[t])})},e.prototype.doFilter=function(e){this.filterStage.execute({rowNode:this.rootNode,changedPath:e})},e.prototype.doPivot=function(e){this.pivotStage&&this.pivotStage.execute({rowNode:this.rootNode,changedPath:e})},e.prototype.getGroupState=function(){if(!this.rootNode.childrenAfterGroup||!this.gridOptionsWrapper.isRememberGroupStateWhenNewData())return null;var o={};return utils_1._.traverseNodesWithKey(this.rootNode.childrenAfterGroup,function(e,t){return o[t]=e.expanded}),o},e.prototype.getCopyOfNodesMap=function(){return this.nodeManager.getCopyOfNodesMap()},e.prototype.getRowNode=function(e){return this.nodeManager.getRowNode(e)},e.prototype.setRowData=function(e){var t=this.getGroupState();this.nodeManager.setRowData(e);e={type:events_1.Events.EVENT_ROW_DATA_CHANGED,api:this.gridApi,columnApi:this.columnApi};this.eventService.dispatchEvent(e),this.refreshModel({step:constants_1.Constants.STEP_EVERYTHING,groupState:t,newData:!0})},e.prototype.batchUpdateRowData=function(e,t){var o,r=this;this.rowDataTransactionBatch||(this.rowDataTransactionBatch=[],o=this.gridOptionsWrapper.getBatchUpdateWaitMillis(),window.setTimeout(function(){r.executeBatchUpdateRowData(),r.rowDataTransactionBatch=null},o)),this.rowDataTransactionBatch.push({rowDataTransaction:e,callback:t})},e.prototype.executeBatchUpdateRowData=function(){var o=this;this.valueCache.onDataChanged();var r=[],i=[];this.rowDataTransactionBatch&&this.rowDataTransactionBatch.forEach(function(e){var t=o.nodeManager.updateRowData(e.rowDataTransaction,null);i.push(t),e.callback&&r.push(e.callback.bind(null,t))}),this.commonUpdateRowData(i),0<r.length&&window.setTimeout(function(){r.forEach(function(e){return e()})},0)},e.prototype.updateRowData=function(e,t){this.valueCache.onDataChanged();e=this.nodeManager.updateRowData(e,t);return this.commonUpdateRowData([e],t),e},e.prototype.commonUpdateRowData=function(e,t){this.refreshModel({step:constants_1.Constants.STEP_EVERYTHING,rowNodeTransactions:e,rowNodeOrder:t,keepRenderedRows:!0,animate:!0,keepEditingRows:!0});t={type:events_1.Events.EVENT_ROW_DATA_UPDATED,api:this.gridApi,columnApi:this.columnApi};this.eventService.dispatchEvent(t)},e.prototype.doRowsToDisplay=function(){this.rowsToDisplay=this.flattenStage.execute({rowNode:this.rootNode})},e.prototype.onRowHeightChanged=function(){this.refreshModel({step:constants_1.Constants.STEP_MAP,keepRenderedRows:!0,keepEditingRows:!0})},e.prototype.resetRowHeights=function(){this.forEachNode(function(e){return e.setRowHeight(null)}),this.onRowHeightChanged()},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("filterManager"),__metadata("design:type",filterManager_1.FilterManager)],e.prototype,"filterManager",void 0),__decorate([context_1.Autowired("$scope"),__metadata("design:type",Object)],e.prototype,"$scope",void 0),__decorate([context_1.Autowired("selectionController"),__metadata("design:type",selectionController_1.SelectionController)],e.prototype,"selectionController",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Autowired("context"),__metadata("design:type",context_1.Context)],e.prototype,"context",void 0),__decorate([context_1.Autowired("valueService"),__metadata("design:type",valueService_1.ValueService)],e.prototype,"valueService",void 0),__decorate([context_1.Autowired("valueCache"),__metadata("design:type",valueCache_1.ValueCache)],e.prototype,"valueCache",void 0),__decorate([context_1.Autowired("columnApi"),__metadata("design:type",columnApi_1.ColumnApi)],e.prototype,"columnApi",void 0),__decorate([context_1.Autowired("gridApi"),__metadata("design:type",gridApi_1.GridApi)],e.prototype,"gridApi",void 0),__decorate([context_1.Autowired("filterStage"),__metadata("design:type",Object)],e.prototype,"filterStage",void 0),__decorate([context_1.Autowired("sortStage"),__metadata("design:type",Object)],e.prototype,"sortStage",void 0),__decorate([context_1.Autowired("flattenStage"),__metadata("design:type",Object)],e.prototype,"flattenStage",void 0),__decorate([context_1.Optional("groupStage"),__metadata("design:type",Object)],e.prototype,"groupStage",void 0),__decorate([context_1.Optional("aggregationStage"),__metadata("design:type",Object)],e.prototype,"aggregationStage",void 0),__decorate([context_1.Optional("pivotStage"),__metadata("design:type",Object)],e.prototype,"pivotStage",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),__decorate([context_1.Bean("rowModel")],e)}();exports.ClientSideRowModel=ClientSideRowModel;