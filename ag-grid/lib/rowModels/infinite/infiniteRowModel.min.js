"use strict";var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};return function(e,t){function o(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}(),__decorate=this&&this.__decorate||function(e,t,o,i){var r,n=arguments.length,a=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,i);else for(var s=e.length-1;0<=s;s--)(r=e[s])&&(a=(n<3?r(a):3<n?r(t,o,a):r(t,o))||a);return 3<n&&a&&Object.defineProperty(t,o,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var gridOptionsWrapper_1=require("../../gridOptionsWrapper"),context_1=require("../../context/context"),eventService_1=require("../../eventService"),selectionController_1=require("../../selectionController"),events_1=require("../../events"),sortController_1=require("../../sortController"),filterManager_1=require("../../filter/filterManager"),constants_1=require("../../constants"),infiniteCache_1=require("./infiniteCache"),beanStub_1=require("../../context/beanStub"),rowNodeCache_1=require("../cache/rowNodeCache"),rowNodeBlockLoader_1=require("../cache/rowNodeBlockLoader"),gridApi_1=require("../../gridApi"),columnApi_1=require("../../columnController/columnApi"),utils_1=require("../../utils"),rowRenderer_1=require("../../rendering/rowRenderer"),InfiniteRowModel=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.getRowBounds=function(e){return{rowHeight:this.rowHeight,rowTop:this.rowHeight*e}},t.prototype.ensureRowHeightsValid=function(e,t,o,i){return!1},t.prototype.init=function(){var e=this;this.gridOptionsWrapper.isRowModelInfinite()&&(this.rowHeight=this.gridOptionsWrapper.getRowHeightAsNumber(),this.addEventListeners(),this.setDatasource(this.gridOptionsWrapper.getDatasource()),this.addDestroyFunc(function(){return e.destroyCache()}))},t.prototype.destroyDatasource=function(){this.datasource&&(this.datasource.destroy&&this.datasource.destroy(),this.rowRenderer.datasourceChanged(),this.datasource=null)},t.prototype.isLastRowFound=function(){return!!this.infiniteCache&&this.infiniteCache.isMaxRowFound()},t.prototype.addEventListeners=function(){this.addDestroyableEventListener(this.eventService,events_1.Events.EVENT_FILTER_CHANGED,this.onFilterChanged.bind(this)),this.addDestroyableEventListener(this.eventService,events_1.Events.EVENT_SORT_CHANGED,this.onSortChanged.bind(this)),this.addDestroyableEventListener(this.eventService,events_1.Events.EVENT_COLUMN_EVERYTHING_CHANGED,this.onColumnEverything.bind(this))},t.prototype.onFilterChanged=function(){this.reset()},t.prototype.onSortChanged=function(){this.reset()},t.prototype.onColumnEverything=function(){var e=!this.cacheParams||this.isSortModelDifferent();e&&this.reset()},t.prototype.isSortModelDifferent=function(){return!utils_1._.jsonEquals(this.cacheParams.sortModel,this.sortController.getSortModel())},t.prototype.getType=function(){return constants_1.Constants.ROW_MODEL_TYPE_INFINITE},t.prototype.setDatasource=function(e){this.destroyDatasource(),(this.datasource=e)&&(this.checkForDeprecated(),this.reset())},t.prototype.checkForDeprecated=function(){var e=this.datasource;utils_1._.exists(e.maxConcurrentRequests)&&console.error("ag-Grid: since version 5.1.x, maxConcurrentRequests is replaced with grid property maxConcurrentDatasourceRequests"),utils_1._.exists(e.maxPagesInCache)&&console.error("ag-Grid: since version 5.1.x, maxPagesInCache is replaced with grid property maxPagesInPaginationCache"),utils_1._.exists(e.overflowSize)&&console.error("ag-Grid: since version 5.1.x, overflowSize is replaced with grid property paginationOverflowSize"),utils_1._.exists(e.blockSize)&&console.error("ag-Grid: since version 5.1.x, pageSize/blockSize is replaced with grid property infinitePageSize")},t.prototype.isEmpty=function(){return utils_1._.missing(this.infiniteCache)},t.prototype.isRowsToRender=function(){return utils_1._.exists(this.infiniteCache)},t.prototype.getNodesInRangeForSelection=function(e,t){return this.infiniteCache?this.infiniteCache.getRowNodesInRange(e,t):[]},t.prototype.reset=function(){var e;utils_1._.missing(this.datasource)||(utils_1._.exists(this.gridOptionsWrapper.getRowNodeIdFunc())||this.selectionController.reset(),this.resetCache(),e=this.createModelUpdatedEvent(),this.eventService.dispatchEvent(e))},t.prototype.createModelUpdatedEvent=function(){return{type:events_1.Events.EVENT_MODEL_UPDATED,api:this.gridApi,columnApi:this.columnApi,newPage:!1,newData:!1,keepRenderedRows:!1,animate:!1}},t.prototype.resetCache=function(){this.destroyCache();var e=this.gridOptionsWrapper.getMaxConcurrentDatasourceRequests(),t=this.gridOptionsWrapper.getBlockLoadDebounceMillis();this.rowNodeBlockLoader=new rowNodeBlockLoader_1.RowNodeBlockLoader(e,t),this.getContext().wireBean(this.rowNodeBlockLoader),this.cacheParams={datasource:this.datasource,filterModel:this.filterManager.getFilterModel(),sortModel:this.sortController.getSortModel(),rowNodeBlockLoader:this.rowNodeBlockLoader,maxConcurrentRequests:e,overflowSize:this.gridOptionsWrapper.getCacheOverflowSize(),initialRowCount:this.gridOptionsWrapper.getInfiniteInitialRowCount(),maxBlocksInCache:this.gridOptionsWrapper.getMaxBlocksInCache(),blockSize:this.gridOptionsWrapper.getCacheBlockSize(),rowHeight:this.gridOptionsWrapper.getRowHeightAsNumber(),lastAccessedSequence:new utils_1.NumberSequence},this.cacheParams.maxConcurrentRequests&&1<=this.cacheParams.maxConcurrentRequests||(this.cacheParams.maxConcurrentRequests=2),this.cacheParams.blockSize&&1<=this.cacheParams.blockSize||(this.cacheParams.blockSize=100),1<=this.cacheParams.initialRowCount||(this.cacheParams.initialRowCount=0),1<=this.cacheParams.overflowSize||(this.cacheParams.overflowSize=1),this.infiniteCache=new infiniteCache_1.InfiniteCache(this.cacheParams),this.getContext().wireBean(this.infiniteCache),this.infiniteCache.addEventListener(rowNodeCache_1.RowNodeCache.EVENT_CACHE_UPDATED,this.onCacheUpdated.bind(this))},t.prototype.destroyCache=function(){this.infiniteCache&&(this.infiniteCache.destroy(),this.infiniteCache=null),this.rowNodeBlockLoader&&(this.rowNodeBlockLoader.destroy(),this.rowNodeBlockLoader=null)},t.prototype.onCacheUpdated=function(){var e=this.createModelUpdatedEvent();this.eventService.dispatchEvent(e)},t.prototype.getRow=function(e){return this.infiniteCache?this.infiniteCache.getRow(e):null},t.prototype.getRowNode=function(t){var o=null;return this.forEachNode(function(e){e.id===t&&(o=e)}),o},t.prototype.forEachNode=function(e){this.infiniteCache&&this.infiniteCache.forEachNodeDeep(e,new utils_1.NumberSequence)},t.prototype.getCurrentPageHeight=function(){return this.getRowCount()*this.rowHeight},t.prototype.getTopLevelRowCount=function(){return this.getRowCount()},t.prototype.getTopLevelRowDisplayedIndex=function(e){return e},t.prototype.getRowIndexAtPixel=function(e){if(0===this.rowHeight)return 0;var t=Math.floor(e/this.rowHeight),e=this.getRowCount()-1;return e<t?e:t},t.prototype.getRowCount=function(){return this.infiniteCache?this.infiniteCache.getVirtualRowCount():0},t.prototype.updateRowData=function(e){utils_1._.exists(e.remove)||utils_1._.exists(e.update)?console.warn("ag-Grid: updateRowData for InfiniteRowModel does not support remove or update, only add"):utils_1._.missing(e.addIndex)?console.warn("ag-Grid: updateRowData for InfiniteRowModel requires add and addIndex to be set"):this.infiniteCache&&this.infiniteCache.insertItemsAtIndex(e.addIndex,e.add)},t.prototype.isRowPresent=function(e){return!1},t.prototype.refreshCache=function(){this.infiniteCache&&this.infiniteCache.refreshCache()},t.prototype.purgeCache=function(){this.infiniteCache&&this.infiniteCache.purgeCache()},t.prototype.getVirtualRowCount=function(){return this.infiniteCache?this.infiniteCache.getVirtualRowCount():null},t.prototype.isMaxRowFound=function(){if(this.infiniteCache)return this.infiniteCache.isMaxRowFound()},t.prototype.setVirtualRowCount=function(e,t){this.infiniteCache&&this.infiniteCache.setVirtualRowCount(e,t)},t.prototype.getBlockState=function(){return this.rowNodeBlockLoader?this.rowNodeBlockLoader.getBlockState():null},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],t.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("filterManager"),__metadata("design:type",filterManager_1.FilterManager)],t.prototype,"filterManager",void 0),__decorate([context_1.Autowired("sortController"),__metadata("design:type",sortController_1.SortController)],t.prototype,"sortController",void 0),__decorate([context_1.Autowired("selectionController"),__metadata("design:type",selectionController_1.SelectionController)],t.prototype,"selectionController",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],t.prototype,"eventService",void 0),__decorate([context_1.Autowired("gridApi"),__metadata("design:type",gridApi_1.GridApi)],t.prototype,"gridApi",void 0),__decorate([context_1.Autowired("columnApi"),__metadata("design:type",columnApi_1.ColumnApi)],t.prototype,"columnApi",void 0),__decorate([context_1.Autowired("rowRenderer"),__metadata("design:type",rowRenderer_1.RowRenderer)],t.prototype,"rowRenderer",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],t.prototype,"init",null),__decorate([context_1.PreDestroy,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],t.prototype,"destroyDatasource",null),__decorate([context_1.Bean("rowModel")],t)}(beanStub_1.BeanStub);exports.InfiniteRowModel=InfiniteRowModel;