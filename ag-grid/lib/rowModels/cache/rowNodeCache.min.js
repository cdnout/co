"use strict";var __extends=this&&this.__extends||function(){var r=function(o,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,t){o.__proto__=t}||function(o,t){for(var e in t)t.hasOwnProperty(e)&&(o[e]=t[e])})(o,t)};return function(o,t){function e(){this.constructor=o}r(o,t),o.prototype=null===t?Object.create(t):(e.prototype=t.prototype,new e)}}();Object.defineProperty(exports,"__esModule",{value:!0});var beanStub_1=require("../../context/beanStub"),rowNodeBlock_1=require("./rowNodeBlock"),utils_1=require("../../utils"),RowNodeCache=function(e){function a(o){var t=e.call(this)||this;return t.maxRowFound=!1,t.blocks={},t.blockCount=0,t.virtualRowCount=o.initialRowCount,t.cacheParams=o,t}return __extends(a,e),a.prototype.destroy=function(){var t=this;e.prototype.destroy.call(this),this.forEachBlockInOrder(function(o){return t.destroyBlock(o)})},a.prototype.init=function(){var o=this;this.active=!0,this.addDestroyFunc(function(){return o.active=!1})},a.prototype.isActive=function(){return this.active},a.prototype.getVirtualRowCount=function(){return this.virtualRowCount},a.prototype.hack_setVirtualRowCount=function(o){this.virtualRowCount=o},a.prototype.isMaxRowFound=function(){return this.maxRowFound},a.prototype.onPageLoaded=function(o){this.cacheParams.rowNodeBlockLoader.loadComplete(),this.checkBlockToLoad(),this.isActive()&&(this.logger.log("onPageLoaded: page = "+o.page.getBlockNumber()+", lastRow = "+o.lastRow),o.success&&this.checkVirtualRowCount(o.page,o.lastRow))},a.prototype.purgeBlocksIfNeeded=function(t){var e=this,r=[];this.forEachBlockInOrder(function(o){o!==t&&r.push(o)}),r.sort(function(o,t){return t.getLastAccessed()-o.getLastAccessed()});var c=0<this.cacheParams.maxBlocksInCache,n=c?this.cacheParams.maxBlocksInCache-1:null,i=a.MAX_EMPTY_BLOCKS_TO_KEEP-1;r.forEach(function(o,t){(o.getState()===rowNodeBlock_1.RowNodeBlock.STATE_DIRTY&&i<=t||c&&n<=t)&&(o.isAnyNodeOpen(e.virtualRowCount)||e.removeBlockFromCache(o))})},a.prototype.postCreateBlock=function(o){o.addEventListener(rowNodeBlock_1.RowNodeBlock.EVENT_LOAD_COMPLETE,this.onPageLoaded.bind(this)),this.setBlock(o.getBlockNumber(),o),this.purgeBlocksIfNeeded(o),this.checkBlockToLoad()},a.prototype.removeBlockFromCache=function(o){o&&this.destroyBlock(o)},a.prototype.checkBlockToLoad=function(){this.cacheParams.rowNodeBlockLoader.checkBlockToLoad()},a.prototype.checkVirtualRowCount=function(o,t){"number"==typeof t&&0<=t?(this.virtualRowCount=t,this.maxRowFound=!0,this.onCacheUpdated()):this.maxRowFound||(o=(o.getBlockNumber()+1)*this.cacheParams.blockSize+this.cacheParams.overflowSize,this.virtualRowCount<o?(this.virtualRowCount=o,this.onCacheUpdated()):this.cacheParams.dynamicRowHeight&&this.onCacheUpdated())},a.prototype.setVirtualRowCount=function(o,t){this.virtualRowCount=o,utils_1._.exists(t)&&(this.maxRowFound=t),this.maxRowFound||this.virtualRowCount%this.cacheParams.blockSize==0&&this.virtualRowCount++,this.onCacheUpdated()},a.prototype.forEachNodeDeep=function(t,e){var r=this;void 0===e&&(e=new utils_1.NumberSequence),this.forEachBlockInOrder(function(o){o.forEachNodeDeep(t,e,r.virtualRowCount)})},a.prototype.forEachBlockInOrder=function(o){var t=this.getBlockIdsSorted();this.forEachBlockId(t,o)},a.prototype.forEachBlockInReverseOrder=function(o){var t=this.getBlockIdsSorted().reverse();this.forEachBlockId(t,o)},a.prototype.forEachBlockId=function(o,e){var r=this;o.forEach(function(o){var t=r.blocks[o];e(t,o)})},a.prototype.getBlockIdsSorted=function(){return Object.keys(this.blocks).map(function(o){return parseInt(o,10)}).sort(function(o,t){return o-t})},a.prototype.getBlock=function(o){return this.blocks[o]},a.prototype.setBlock=function(o,t){this.blocks[o]=t,this.blockCount++,this.cacheParams.rowNodeBlockLoader.addBlock(t)},a.prototype.destroyBlock=function(o){delete this.blocks[o.getBlockNumber()],o.destroy(),this.blockCount--,this.cacheParams.rowNodeBlockLoader.removeBlock(o)},a.prototype.onCacheUpdated=function(){var o;this.isActive()&&(o={type:a.EVENT_CACHE_UPDATED},this.dispatchEvent(o))},a.prototype.purgeCache=function(){var t=this;this.forEachBlockInOrder(function(o){return t.removeBlockFromCache(o)}),this.virtualRowCount=this.cacheParams.initialRowCount,this.maxRowFound=!1,this.onCacheUpdated()},a.prototype.getRowNodesInRange=function(e,r){var c=this,n=[],i=-1,a=!1,s=new utils_1.NumberSequence;utils_1._.missing(e)&&(a=!0);var u=!1;return this.forEachBlockInOrder(function(o,t){u||(a&&i+1!==t?u=!0:(i=t,o.forEachNodeShallow(function(o){var t=o===e||o===r;(a||t)&&n.push(o),t&&(a=!a)},s,c.virtualRowCount)))}),u||a?[]:n},a.EVENT_CACHE_UPDATED="cacheUpdated",a.MAX_EMPTY_BLOCKS_TO_KEEP=2,a}(beanStub_1.BeanStub);exports.RowNodeCache=RowNodeCache;