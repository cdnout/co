"use strict";var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(s=(i<3?n(s):3<i?n(t,r,s):n(t,r))||s);return 3<i&&s&&Object.defineProperty(t,r,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),gridSerializer_1=require("./gridSerializer"),downloader_1=require("./downloader"),columnController_1=require("../columnController/columnController"),valueService_1=require("../valueService/valueService"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),constants_1=require("../constants"),utils_1=require("../utils"),LINE_SEPARATOR="\r\n",CsvSerializingSession=function(o){function e(e){var t=o.call(this,{columnController:e.columnController,valueService:e.valueService,gridOptionsWrapper:e.gridOptionsWrapper,processCellCallback:e.processCellCallback,processHeaderCallback:e.processHeaderCallback})||this;t.result="",t.lineOpened=!1;var r=e.suppressQuotes,e=e.columnSeparator;return t.suppressQuotes=r,t.columnSeparator=e,t}return __extends(e,o),e.prototype.prepare=function(e){},e.prototype.addCustomHeader=function(e){e&&(this.result+=e+LINE_SEPARATOR)},e.prototype.addCustomFooter=function(e){e&&(this.result+=e+LINE_SEPARATOR)},e.prototype.onNewHeaderGroupingRow=function(){return this.lineOpened&&(this.result+=LINE_SEPARATOR),{onColumn:this.onNewHeaderGroupingRowColumn.bind(this)}},e.prototype.onNewHeaderGroupingRowColumn=function(e,t,r){0!=t&&(this.result+=this.columnSeparator),this.result+=this.putInQuotes(e,this.suppressQuotes);for(var o=1;o<=r;o++)this.result+=this.columnSeparator+this.putInQuotes("",this.suppressQuotes);this.lineOpened=!0},e.prototype.onNewHeaderRow=function(){return this.lineOpened&&(this.result+=LINE_SEPARATOR),{onColumn:this.onNewHeaderRowColumn.bind(this)}},e.prototype.onNewHeaderRowColumn=function(e,t,r){0!=t&&(this.result+=this.columnSeparator),this.result+=this.putInQuotes(this.extractHeaderValue(e),this.suppressQuotes),this.lineOpened=!0},e.prototype.onNewBodyRow=function(){return this.lineOpened&&(this.result+=LINE_SEPARATOR),{onColumn:this.onNewBodyRowColumn.bind(this)}},e.prototype.onNewBodyRowColumn=function(e,t,r){0!=t&&(this.result+=this.columnSeparator),this.result+=this.putInQuotes(this.extractRowCellValue(e,t,constants_1.Constants.EXPORT_TYPE_CSV,r),this.suppressQuotes),this.lineOpened=!0},e.prototype.putInQuotes=function(e,t){if(t)return e;if(null==e)return'""';e="string"==typeof e?e:"function"==typeof e.toString?e.toString():(console.warn("unknown value type during csv conversion"),"");return'"'+e.replace(/"/g,'""')+'"'},e.prototype.parse=function(){return this.result},e}(gridSerializer_1.BaseGridSerializingSession);exports.CsvSerializingSession=CsvSerializingSession;var BaseCreator=function(){function e(){}return e.prototype.setBeans=function(e){this.beans=e},e.prototype.export=function(e){if(this.isExportSuppressed())return console.warn("ag-grid: Export cancelled. Export is not allowed as per your configuration."),"";var t=this.getMergedParamsAndData(e),e=t.mergedParams,t=t.data,e=e&&e.fileName&&0!==e.fileName.length?e.fileName:this.getDefaultFileName();return-1===e.indexOf(".")&&(e=e+"."+this.getDefaultFileExtension()),this.beans.downloader.download(e,this.packageFile(t)),t},e.prototype.getData=function(e){return this.getMergedParamsAndData(e).data},e.prototype.getMergedParamsAndData=function(e){e=this.mergeDefaultParams(e);return{mergedParams:e,data:this.beans.gridSerializer.serialize(this.createSerializingSession(e),e)}},e.prototype.mergeDefaultParams=function(e){var t=this.beans.gridOptionsWrapper.getDefaultExportParams(),r={};return utils_1._.assign(r,t),utils_1._.assign(r,e),r},e.prototype.packageFile=function(e){return new Blob(["\ufeff",e],{type:window.navigator.msSaveOrOpenBlob?this.getMimeType():"octet/stream"})},e}(),CsvCreator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.postConstruct=function(){this.setBeans({downloader:this.downloader,gridSerializer:this.gridSerializer,gridOptionsWrapper:this.gridOptionsWrapper})},t.prototype.exportDataAsCsv=function(e){return this.export(e)},t.prototype.getDataAsCsv=function(e){return this.getData(e)},t.prototype.getMimeType=function(){return"text/csv;charset=utf-8;"},t.prototype.getDefaultFileName=function(){return"export.csv"},t.prototype.getDefaultFileExtension=function(){return"csv"},t.prototype.createSerializingSession=function(e){var t=this.columnController,r=this.valueService,o=this.gridOptionsWrapper,n=e.processCellCallback,i=e.processHeaderCallback,s=e.suppressQuotes,e=e.columnSeparator;return new CsvSerializingSession({columnController:t,valueService:r,gridOptionsWrapper:o,processCellCallback:n||void 0,processHeaderCallback:i||void 0,suppressQuotes:s||!1,columnSeparator:e||","})},t.prototype.isExportSuppressed=function(){return this.gridOptionsWrapper.isSuppressCsvExport()},__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],t.prototype,"columnController",void 0),__decorate([context_1.Autowired("valueService"),__metadata("design:type",valueService_1.ValueService)],t.prototype,"valueService",void 0),__decorate([context_1.Autowired("downloader"),__metadata("design:type",downloader_1.Downloader)],t.prototype,"downloader",void 0),__decorate([context_1.Autowired("gridSerializer"),__metadata("design:type",gridSerializer_1.GridSerializer)],t.prototype,"gridSerializer",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],t.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],t.prototype,"postConstruct",null),__decorate([context_1.Bean("csvCreator")],t)}(exports.BaseCreator=BaseCreator);exports.CsvCreator=CsvCreator;