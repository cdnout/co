"use strict";var __decorate=this&&this.__decorate||function(e,o,r,t){var n,i=arguments.length,l=i<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,r):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,o,r,t);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(l=(i<3?n(l):3<i?n(o,r,l):n(o,r))||l);return 3<i&&l&&Object.defineProperty(o,r,l),l},__metadata=this&&this.__metadata||function(e,o){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,o)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),columnController_1=require("../columnController/columnController"),constants_1=require("../constants"),selectionController_1=require("../selectionController"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),displayedGroupCreator_1=require("../columnController/displayedGroupCreator"),columnFactory_1=require("../columnController/columnFactory"),groupInstanceIdCreator_1=require("../columnController/groupInstanceIdCreator"),columnGroup_1=require("../entities/columnGroup"),pinnedRowModel_1=require("../rowModels/pinnedRowModel"),utils_1=require("../utils"),BaseGridSerializingSession=function(){function e(e){var o=e.columnController,r=e.valueService,t=e.gridOptionsWrapper,n=e.processCellCallback,i=e.processHeaderCallback,e=e.cellAndHeaderEscaper;this.columnController=o,this.valueService=r,this.gridOptionsWrapper=t,this.processCellCallback=n,this.processHeaderCallback=i,this.cellAndHeaderEscaper=e}return e.prototype.extractHeaderValue=function(e){e=this.getHeaderName(this.processHeaderCallback,e);return null==e&&(e=""),this.cellAndHeaderEscaper?this.cellAndHeaderEscaper(e):e},e.prototype.extractRowCellValue=function(e,o,r,t){var n=0<this.columnController.getRowGroupColumns().length,o=t&&t.group&&n&&0===o?this.createValueForGroupNode(t):this.valueService.getValue(e,t);return null==(o=this.processCell(t,e,o,this.processCellCallback,r))&&(o=""),this.cellAndHeaderEscaper?this.cellAndHeaderEscaper(o):o},e.prototype.getHeaderName=function(e,o){return e?e({column:o,api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext()}):this.columnController.getDisplayNameForColumn(o,"csv",!0)},e.prototype.createValueForGroupNode=function(e){for(var o=[e.key];e.parent;)e=e.parent,o.push(e.key);return o.reverse().join(" -> ")},e.prototype.processCell=function(e,o,r,t,n){return t?t({column:o,node:e,value:r,api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext(),type:n}):r},e}();exports.BaseGridSerializingSession=BaseGridSerializingSession;var RowType,GridSerializer=function(){function e(){}return e.prototype.serialize=function(o,e){var r,n=e&&e.skipGroups,t=e&&e.skipHeader,i=e&&e.columnGroups,l=e&&e.skipFooters,a=e&&e.skipPinnedTop,p=e&&e.skipPinnedBottom,s=e&&e.customHeader,d=e&&e.customFooter,c=e&&e.allColumns,u=e&&e.onlySelected,C=e&&e.columnKeys,h=e&&e.onlySelectedAllPages,_=e&&e.shouldRowBeSkipped||function(){return!1},m=this.gridOptionsWrapper.getApi(),g=this.gridOptionsWrapper.isGroupRemoveSingleChildren(),y=this.gridOptionsWrapper.isGroupRemoveLowestSingleChildren(),f=this.gridOptionsWrapper.getContext(),w=this.columnController.isPivotMode(),G=this.rowModel.getType()===constants_1.Constants.ROW_MODEL_TYPE_CLIENT_SIDE,e=!G&&u,v=[];function A(r){var t,e=y&&r.leafGroup,e=1===r.allChildrenCount&&(g||e);r.group&&(n||e)||l&&r.footer||u&&!r.isSelected()||a&&"top"===r.rowPinned||p&&"bottom"===r.rowPinned||-1===r.level&&!r.leafGroup||_({node:r,api:m,context:f})||(t=o.onNewBodyRow(),v.forEach(function(e,o){t.onColumn(e,o,r)}))}return v=utils_1._.existsAndNotEmpty(C)?this.columnController.getGridColumns(C):c&&!w?(v=this.gridOptionsWrapper.isTreeData()?this.columnController.getGridColumns([constants_1.Constants.GROUP_AUTO_COLUMN_ID]):[]).concat(this.columnController.getAllPrimaryColumns()||[]):this.columnController.getAllDisplayedColumns(),s&&o.addCustomHeader(s),o.prepare(v),i&&(i=new groupInstanceIdCreator_1.GroupInstanceIdCreator,i=this.displayedGroupCreator.createDisplayedGroups(v,this.columnController.getGridBalancedTree(),i,null),this.recursivelyAddHeaderGroups(i,o)),t||(r=o.onNewHeaderRow(),v.forEach(function(e,o){r.onColumn(e,o,void 0)})),this.pinnedRowModel.forEachPinnedTopRow(A),w?this.rowModel.forEachPivotNode?this.rowModel.forEachPivotNode(A):this.rowModel.forEachNode(A):h||e?this.selectionController.getSelectedNodes().forEach(function(e){A(e)}):G?this.rowModel.forEachNodeAfterFilterAndSort(A):this.rowModel.forEachNode(A),this.pinnedRowModel.forEachPinnedBottomRow(A),d&&o.addCustomFooter(d),o.parse()},e.prototype.recursivelyAddHeaderGroups=function(e,o){var r=[];e.forEach(function(e){e.getChildren&&e.getChildren().forEach(function(e){return r.push(e)})}),0<e.length&&e[0]instanceof columnGroup_1.ColumnGroup&&this.doAddHeaderHeader(o,e),r&&0<r.length&&this.recursivelyAddHeaderGroups(r,o)},e.prototype.doAddHeaderHeader=function(e,o){var r=this,t=e.onNewHeaderGroupingRow(),n=0;o.forEach(function(e){var o=e,e=r.columnController.getDisplayNameForColumnGroup(o,"header");t.onColumn(e||"",n++,o.getLeafColumns().length-1)})},__decorate([context_1.Autowired("displayedGroupCreator"),__metadata("design:type",displayedGroupCreator_1.DisplayedGroupCreator)],e.prototype,"displayedGroupCreator",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("rowModel"),__metadata("design:type",Object)],e.prototype,"rowModel",void 0),__decorate([context_1.Autowired("pinnedRowModel"),__metadata("design:type",pinnedRowModel_1.PinnedRowModel)],e.prototype,"pinnedRowModel",void 0),__decorate([context_1.Autowired("selectionController"),__metadata("design:type",selectionController_1.SelectionController)],e.prototype,"selectionController",void 0),__decorate([context_1.Autowired("columnFactory"),__metadata("design:type",columnFactory_1.ColumnFactory)],e.prototype,"columnFactory",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Bean("gridSerializer")],e)}();exports.GridSerializer=GridSerializer,function(e){e[e.HEADER_GROUPING=0]="HEADER_GROUPING",e[e.HEADER=1]="HEADER",e[e.BODY=2]="BODY"}(RowType=exports.RowType||(exports.RowType={}));