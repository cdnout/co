"use strict";var __decorate=this&&this.__decorate||function(e,t,i,r){var o,a=arguments.length,n=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var l=e.length-1;0<=l;l--)(o=e[l])&&(n=(a<3?o(n):3<a?o(t,i,n):o(t,i))||n);return 3<a&&n&&Object.defineProperty(t,i,n),n},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var gridOptionsWrapper_1=require("../gridOptionsWrapper"),expressionService_1=require("./expressionService"),columnController_1=require("../columnController/columnController"),context_1=require("../context/context"),events_1=require("../events"),eventService_1=require("../eventService"),valueCache_1=require("./valueCache"),utils_1=require("../utils"),ValueService=function(){function e(){this.initialised=!1}return e.prototype.init=function(){this.cellExpressions=this.gridOptionsWrapper.isEnableCellExpressions(),this.initialised=!0},e.prototype.getValue=function(e,t,i,r){if(void 0===i&&(i=!1),void 0===r&&(r=!1),this.initialised||this.init(),t){var o,a=e.getColDef(),n=a.field,l=e.getId(),s=t.data,u=t.groupData&&void 0!==t.groupData[l],r=!r&&t.aggData&&void 0!==t.aggData[l];return i&&a.filterValueGetter?o=this.executeFilterValueGetter(a.filterValueGetter,s,e,t):this.gridOptionsWrapper.isTreeData()&&r?o=t.aggData[l]:this.gridOptionsWrapper.isTreeData()&&a.valueGetter?o=this.executeValueGetter(a.valueGetter,s,e,t):this.gridOptionsWrapper.isTreeData()&&n&&s?o=utils_1._.getValueUsingField(s,n,e.isFieldContainsDots()):u?o=t.groupData[l]:r?o=t.aggData[l]:a.valueGetter?o=this.executeValueGetter(a.valueGetter,s,e,t):n&&s&&(o=utils_1._.getValueUsingField(s,n,e.isFieldContainsDots())),this.cellExpressions&&"string"==typeof o&&0===o.indexOf("=")&&(n=o.substring(1),o=this.executeValueGetter(n,s,e,t)),o}},e.prototype.setValue=function(e,t,i){var r,o,a,n,l,s=this.columnController.getPrimaryColumn(t);e&&s&&(r=e.data,utils_1._.missing(r)&&(e.data={}),o=(a=s.getColDef()).field,t=a.newValueHandler,a=a.valueSetter,utils_1._.missing(o)&&utils_1._.missing(t)&&utils_1._.missing(a)?console.warn("ag-Grid: you need either field or valueSetter set on colDef for editing to work"):((n={node:e,data:e.data,oldValue:this.getValue(s,e),newValue:i,colDef:s.getColDef(),column:s,api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext()}).newValue=i,void 0===(i=t&&utils_1._.exists(t)?t(n):utils_1._.exists(a)?this.expressionService.evaluate(a,n):this.setValueUsingField(r,o,i,s.isFieldContainsDots()))&&(i=!0),i&&(e.resetQuickFilterAggregateText(),this.valueCache.onDataChanged(),n.newValue=this.getValue(s,e),"function"==typeof(l=s.getColDef().onCellValueChanged)&&setTimeout(function(){return l(n)},0),e={type:events_1.Events.EVENT_CELL_VALUE_CHANGED,event:null,rowIndex:e.rowIndex,rowPinned:e.rowPinned,column:n.column,api:n.api,colDef:n.colDef,columnApi:n.columnApi,context:n.context,data:e.data,node:e,oldValue:n.oldValue,newValue:n.newValue,value:n.newValue},this.eventService.dispatchEvent(e))))},e.prototype.setValueUsingField=function(e,t,i,r){if(!t)return!1;if(r)for(var o=t.split("."),a=e;0<o.length&&a;){var n=o.shift();0===o.length?a[n]=i:a=a[n]}else e[t]=i;return!0},e.prototype.executeFilterValueGetter=function(e,t,i,r){r={data:t,node:r,column:i,colDef:i.getColDef(),api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext(),getValue:this.getValueCallback.bind(this,r)};return this.expressionService.evaluate(e,r)},e.prototype.executeValueGetter=function(e,t,i,r){var o=i.getId(),a=this.valueCache.getValue(r,o);if(void 0!==a)return a;i={data:t,node:r,column:i,colDef:i.getColDef(),api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext(),getValue:this.getValueCallback.bind(this,r)},i=this.expressionService.evaluate(e,i);return this.valueCache.setValue(r,o,i),i},e.prototype.getValueCallback=function(e,t){t=this.columnController.getPrimaryColumn(t);return t?this.getValue(t,e):null},e.prototype.getKeyForNode=function(e,t){t=this.getValue(e,t),e=e.getColDef().keyCreator,t=e?e({value:t}):t;return"string"==typeof t||null==t||"[object Object]"===(t=String(t))&&utils_1._.doOnce(function(){console.warn("ag-Grid: a column you are grouping or pivoting by has objects as values. If you want to group by complex objects then either a) use a colDef.keyCreator (se ag-Grid docs) or b) to toString() on the object to return a key")},"getKeyForNode - warn about [object,object]"),t},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("expressionService"),__metadata("design:type",expressionService_1.ExpressionService)],e.prototype,"expressionService",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Autowired("valueCache"),__metadata("design:type",valueCache_1.ValueCache)],e.prototype,"valueCache",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),__decorate([context_1.Bean("valueService")],e)}();exports.ValueService=ValueService;