"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,l=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(l=(i<3?n(l):3<i?n(t,r,l):n(t,r))||l);return 3<i&&l&&Object.defineProperty(t,r,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),logger_1=require("../logger"),columnController_1=require("../columnController/columnController"),column_1=require("../entities/column"),utils_1=require("../utils"),dragAndDropService_1=require("../dragAndDrop/dragAndDropService"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),MoveColumnController=function(){function e(e,t){this.needToMoveLeft=!1,this.needToMoveRight=!1,this.pinned=e,this.eContainer=t,this.centerContainer=!utils_1._.exists(e)}return e.prototype.registerGridComp=function(e){this.gridPanel=e},e.prototype.init=function(){this.logger=this.loggerFactory.create("MoveColumnController")},e.prototype.getIconName=function(){return this.pinned?dragAndDropService_1.DragAndDropService.ICON_PINNED:dragAndDropService_1.DragAndDropService.ICON_MOVE},e.prototype.onDragEnter=function(e){var t,r,o=e.dragItem.columns;e.dragSource.type===dragAndDropService_1.DragSourceType.ToolPanel?this.setColumnsVisible(o,!0,"uiColumnDragged"):(t=e.dragItem.visibleState,r=o.filter(function(e){return t[e.getId()]}),this.setColumnsVisible(r,!0,"uiColumnDragged")),this.setColumnsPinned(o,this.pinned,"uiColumnDragged"),this.onDragging(e,!0)},e.prototype.onDragLeave=function(e){this.gridOptionsWrapper.isSuppressDragLeaveHidesColumns()||e.fromNudge||(e=e.dragSource.dragItemCallback().columns,this.setColumnsVisible(e,!1,"uiColumnDragged")),this.ensureIntervalCleared()},e.prototype.setColumnsVisible=function(e,t,r){void 0===r&&(r="api"),e&&(e=e.filter(function(e){return!e.getColDef().lockVisible}),this.columnController.setColumnsVisible(e,t,r))},e.prototype.setColumnsPinned=function(e,t,r){void 0===r&&(r="api"),e&&(e=e.filter(function(e){return!e.getColDef().lockPinned}),this.columnController.setColumnsPinned(e,t,r))},e.prototype.onDragStop=function(){this.ensureIntervalCleared()},e.prototype.normaliseX=function(e){return this.gridOptionsWrapper.isEnableRtl()&&(e=this.eContainer.clientWidth-e),this.centerContainer&&(e+=this.gridPanel.getCenterViewportScrollLeft()),e},e.prototype.checkCenterForScrolling=function(e){var t,r;this.centerContainer&&(r=(t=this.gridPanel.getCenterViewportScrollLeft())+this.gridPanel.getCenterWidth(),this.gridOptionsWrapper.isEnableRtl()?(this.needToMoveRight=e<t+50,this.needToMoveLeft=r-50<e):(this.needToMoveLeft=e<t+50,this.needToMoveRight=r-50<e),this.needToMoveLeft||this.needToMoveRight?this.ensureIntervalStarted():this.ensureIntervalCleared())},e.prototype.onDragging=function(e,t){var r,o,n,i=this;void 0===t&&(t=!1),this.lastDraggingEvent=e,utils_1._.missing(e.hDirection)||(r=this.normaliseX(e.x),t||this.checkCenterForScrolling(r),o=this.normaliseDirection(e.hDirection),n=e.dragSource.type,e=(e=e.dragSource.dragItemCallback().columns).filter(function(e){return!e.getColDef().lockPinned||e.getPinned()==i.pinned}),this.attemptMoveColumns(n,e,o,r,t))},e.prototype.normaliseDirection=function(e){if(!this.gridOptionsWrapper.isEnableRtl())return e;switch(e){case dragAndDropService_1.HDirection.Left:return dragAndDropService_1.HDirection.Right;case dragAndDropService_1.HDirection.Right:return dragAndDropService_1.HDirection.Left;default:console.error("ag-Grid: Unknown direction "+e)}},e.prototype.calculateOldIndex=function(e){var t=this.columnController.getAllGridColumns(),r=[];e.forEach(function(e){return r.push(t.indexOf(e))}),utils_1._.sortNumberArray(r);e=r[0];return utils_1._.last(r)-e!=r.length-1?null:e},e.prototype.attemptMoveColumns=function(e,t,r,o,n){var i=r===dragAndDropService_1.HDirection.Left,l=r===dragAndDropService_1.HDirection.Right,a=this.calculateValidMoves(t,l,o),r=this.calculateOldIndex(t);if(0!==a.length){o=a[0],n=null!==r&&!n;if(e==dragAndDropService_1.DragSourceType.HeaderCell&&(n=null!==r),n){if(i&&r<=o)return;if(l&&o<=r)return}for(var s=0;s<a.length;s++){var d=a[s];if(this.columnController.doesMovePassRules(t,d))return void this.columnController.moveColumns(t,d,"uiColumnDragged")}}},e.prototype.calculateValidMoves=function(t,e,r){var o,n,i=this.columnController.getDisplayedColumns(this.pinned),l=this.columnController.getAllGridColumns(),a=function(e){return t.indexOf(e)<0},s=i.filter(function(e){return 0<=t.indexOf(e)}),d=i.filter(a),a=l.filter(a),c=0,u=r;if(e&&(o=0,s.forEach(function(e){return o+=e.getActualWidth()}),u-=o),0<u){for(var g=0;g<d.length;g++){if((u-=d[g].getActualWidth())<0)break;c++}e&&c++}var p=[n=0<c?(n=d[c-1],a.indexOf(n)+1):0];if(e)for(var h=n+1,v=l.length-1;h<=v;)p.push(h),h++;else{for(var h=n,v=l.length-1,f=l[h];h<=v&&this.isColumnHidden(i,f);)h++,p.push(h),f=l[h];h=n-1;for(;0<=h;)p.push(h),h--}return p},e.prototype.isColumnHidden=function(e,t){return e.indexOf(t)<0},e.prototype.ensureIntervalStarted=function(){this.movingIntervalId||(this.intervalCount=0,this.failedMoveAttempts=0,this.movingIntervalId=window.setInterval(this.moveInterval.bind(this),100),this.needToMoveLeft?this.dragAndDropService.setGhostIcon(dragAndDropService_1.DragAndDropService.ICON_LEFT,!0):this.dragAndDropService.setGhostIcon(dragAndDropService_1.DragAndDropService.ICON_RIGHT,!0))},e.prototype.ensureIntervalCleared=function(){this.moveInterval&&(window.clearInterval(this.movingIntervalId),this.movingIntervalId=null,this.dragAndDropService.setGhostIcon(dragAndDropService_1.DragAndDropService.ICON_MOVE))},e.prototype.moveInterval=function(){var e,t;this.intervalCount++,100<(e=10+5*this.intervalCount)&&(e=100),this.needToMoveLeft?t=this.gridPanel.scrollHorizontally(-e):this.needToMoveRight&&(t=this.gridPanel.scrollHorizontally(e)),0!==t?(this.onDragging(this.lastDraggingEvent),this.failedMoveAttempts=0):(this.failedMoveAttempts++,0<(e=this.lastDraggingEvent.dragItem.columns.filter(function(e){return!e.getColDef().lockPinned})).length&&(this.dragAndDropService.setGhostIcon(dragAndDropService_1.DragAndDropService.ICON_PINNED),7<this.failedMoveAttempts&&(t=this.needToMoveLeft?column_1.Column.PINNED_LEFT:column_1.Column.PINNED_RIGHT,this.setColumnsPinned(e,t,"uiColumnDragged"),this.dragAndDropService.nudge())))},__decorate([context_1.Autowired("loggerFactory"),__metadata("design:type",logger_1.LoggerFactory)],e.prototype,"loggerFactory",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("dragAndDropService"),__metadata("design:type",dragAndDropService_1.DragAndDropService)],e.prototype,"dragAndDropService",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),e}();exports.MoveColumnController=MoveColumnController;