"use strict";var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};return function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}(),__decorate=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,s=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var u=e.length-1;0<=u;u--)(i=e[u])&&(s=(n<3?i(s):3<n?i(t,o,s):i(t,o))||s);return 3<n&&s&&Object.defineProperty(t,o,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var component_1=require("../../widgets/component"),column_1=require("../../entities/column"),columnGroup_1=require("../../entities/columnGroup"),columnApi_1=require("../../columnController/columnApi"),columnController_1=require("../../columnController/columnController"),gridOptionsWrapper_1=require("../../gridOptionsWrapper"),horizontalResizeService_1=require("../horizontalResizeService"),context_1=require("../../context/context"),cssClassApplier_1=require("../cssClassApplier"),dragAndDropService_1=require("../../dragAndDrop/dragAndDropService"),setLeftFeature_1=require("../../rendering/features/setLeftFeature"),gridApi_1=require("../../gridApi"),userComponentFactory_1=require("../../components/framework/userComponentFactory"),beans_1=require("../../rendering/beans"),hoverFeature_1=require("../hoverFeature"),utils_1=require("../../utils"),HeaderGroupWrapperComp=function(i){function n(e,t,o){var r=i.call(this,n.TEMPLATE)||this;return r.childColumnsDestroyFuncs=[],r.columnGroup=e,r.dragSourceDropTarget=t,r.pinned=o,r}return __extends(n,i),n.prototype.postConstruct=function(){cssClassApplier_1.CssClassApplier.addHeaderClassesFromColDef(this.getComponentHolder(),this.getGui(),this.gridOptionsWrapper,null,this.columnGroup);var e=this.columnController.getDisplayNameForColumnGroup(this.columnGroup,"header");this.appendHeaderGroupComp(e),this.setupResize(),this.addClasses(),this.setupWidth(),this.addAttributes(),this.setupMovingCss(),this.setupTooltip(),this.addFeature(this.getContext(),new hoverFeature_1.HoverFeature(this.columnGroup.getOriginalColumnGroup().getLeafColumns(),this.getGui()));e=new setLeftFeature_1.SetLeftFeature(this.columnGroup,this.getGui(),this.beans);e.init(),this.addDestroyFunc(e.destroy.bind(e))},n.prototype.setupMovingCss=function(){var t=this;this.columnGroup.getOriginalColumnGroup().getLeafColumns().forEach(function(e){t.addDestroyableEventListener(e,column_1.Column.EVENT_MOVING_CHANGED,t.onColumnMovingChanged.bind(t))}),this.onColumnMovingChanged()},n.prototype.getColumn=function(){return this.columnGroup},n.prototype.getComponentHolder=function(){return this.columnGroup.getColGroupDef()},n.prototype.getTooltipText=function(){var e=this.getComponentHolder();return e&&e.headerTooltip},n.prototype.setupTooltip=function(){var e=this.getTooltipText();null!=e&&(this.gridOptionsWrapper.isEnableBrowserTooltips()?this.getGui().setAttribute("title",e):this.beans.tooltipManager.registerTooltip(this))},n.prototype.onColumnMovingChanged=function(){utils_1._.addOrRemoveCssClass(this.getGui(),"ag-header-cell-moving",this.columnGroup.isMoving())},n.prototype.addAttributes=function(){this.getGui().setAttribute("col-id",this.columnGroup.getUniqueId())},n.prototype.appendHeaderGroupComp=function(e){var t=this,o={displayName:e,columnGroup:this.columnGroup,setExpanded:function(e){t.columnController.setColumnGroupOpened(t.columnGroup.getOriginalColumnGroup(),e,"gridInitializing")},api:this.gridApi,columnApi:this.columnApi,context:this.gridOptionsWrapper.getContext()};if(!e){for(var r=this.columnGroup,i=r.getLeafColumns();r.getParent()&&r.getParent().getLeafColumns().length===i.length;)r=r.getParent();var n=r.getColGroupDef();n&&(e=n.headerName),e=e||(i?this.columnController.getDisplayNameForColumn(i[0],"header",!0):"")}e=this.afterHeaderCompCreated.bind(this,e);this.userComponentFactory.newHeaderGroupComponent(o).then(e)},n.prototype.afterHeaderCompCreated=function(e,t){this.appendChild(t),this.setupMove(t.getGui(),e)},n.prototype.addClasses=function(){this.columnGroup.isPadding()?this.addCssClass("ag-header-group-cell-no-group"):this.addCssClass("ag-header-group-cell-with-group")},n.prototype.setupMove=function(e,t){var o,r,i=this;e&&(this.isSuppressMoving()||(o=this.columnGroup.getOriginalColumnGroup().getLeafColumns(),e&&(r={type:dragAndDropService_1.DragSourceType.HeaderCell,eElement:e,dragItemName:t,dragItemCallback:this.getDragItemForGroup.bind(this),dragSourceDropTarget:this.dragSourceDropTarget,dragStarted:function(){return o.forEach(function(e){return e.setMoving(!0,"uiColumnDragged")})},dragStopped:function(){return o.forEach(function(e){return e.setMoving(!1,"uiColumnDragged")})}},this.dragAndDropService.addDragSource(r,!0),this.addDestroyFunc(function(){return i.dragAndDropService.removeDragSource(r)}))))},n.prototype.getDragItemForGroup=function(){var t=this.columnGroup.getOriginalColumnGroup().getLeafColumns(),o={};t.forEach(function(e){return o[e.getId()]=e.isVisible()});var r=[];return this.columnController.getAllDisplayedColumns().forEach(function(e){0<=t.indexOf(e)&&(r.push(e),utils_1._.removeFromArray(t,e))}),t.forEach(function(e){return r.push(e)}),{columns:r,visibleState:o}},n.prototype.isSuppressMoving=function(){var t=!1;return this.columnGroup.getLeafColumns().forEach(function(e){(e.getColDef().suppressMovable||e.getColDef().lockPosition)&&(t=!0)}),t||this.gridOptionsWrapper.isSuppressMovableColumns()},n.prototype.setupWidth=function(){this.addListenersToChildrenColumns(),this.addDestroyableEventListener(this.columnGroup,columnGroup_1.ColumnGroup.EVENT_DISPLAYED_CHILDREN_CHANGED,this.onDisplayedChildrenChanged.bind(this)),this.onWidthChanged(),this.addDestroyFunc(this.destroyListenersOnChildrenColumns.bind(this))},n.prototype.onDisplayedChildrenChanged=function(){this.addListenersToChildrenColumns(),this.onWidthChanged()},n.prototype.addListenersToChildrenColumns=function(){var t=this;this.destroyListenersOnChildrenColumns();var o=this.onWidthChanged.bind(this);this.columnGroup.getLeafColumns().forEach(function(e){e.addEventListener(column_1.Column.EVENT_WIDTH_CHANGED,o),e.addEventListener(column_1.Column.EVENT_VISIBLE_CHANGED,o),t.childColumnsDestroyFuncs.push(function(){e.removeEventListener(column_1.Column.EVENT_WIDTH_CHANGED,o),e.removeEventListener(column_1.Column.EVENT_VISIBLE_CHANGED,o)})})},n.prototype.destroyListenersOnChildrenColumns=function(){this.childColumnsDestroyFuncs.forEach(function(e){return e()}),this.childColumnsDestroyFuncs=[]},n.prototype.onWidthChanged=function(){this.getGui().style.width=this.columnGroup.getActualWidth()+"px"},n.prototype.setupResize=function(){var e,o=this;this.eHeaderCellResize=this.getRefElement("agResize"),this.columnGroup.isResizable()?(e=this.horizontalResizeService.addResizeBar({eResizeBar:this.eHeaderCellResize,onResizeStart:this.onResizeStart.bind(this),onResizing:this.onResizing.bind(this,!1),onResizeEnd:this.onResizing.bind(this,!0)}),this.addDestroyFunc(e),this.gridOptionsWrapper.isSuppressAutoSize()||this.eHeaderCellResize.addEventListener("dblclick",function(e){var t=[];o.columnGroup.getDisplayedLeafColumns().forEach(function(e){e.getColDef().suppressAutoSize||t.push(e.getColId())}),0<t.length&&o.columnController.autoSizeColumns(t,"uiColumnResized")})):utils_1._.removeFromParent(this.eHeaderCellResize)},n.prototype.onResizeStart=function(e){var t=this,o=this.columnGroup.getDisplayedLeafColumns();this.resizeCols=utils_1._.filter(o,function(e){return e.isResizable()}),this.resizeStartWidth=0,this.resizeCols.forEach(function(e){return t.resizeStartWidth+=e.getActualWidth()}),this.resizeRatios=[],this.resizeCols.forEach(function(e){return t.resizeRatios.push(e.getActualWidth()/t.resizeStartWidth)});o=null;e&&(o=this.columnController.getDisplayedGroupAfter(this.columnGroup)),o?(o=o.getDisplayedLeafColumns(),this.resizeTakeFromCols=utils_1._.filter(o,function(e){return e.isResizable()}),this.resizeTakeFromStartWidth=0,this.resizeTakeFromCols.forEach(function(e){return t.resizeTakeFromStartWidth+=e.getActualWidth()}),this.resizeTakeFromRatios=[],this.resizeTakeFromCols.forEach(function(e){return t.resizeTakeFromRatios.push(e.getActualWidth()/t.resizeTakeFromStartWidth)})):(this.resizeTakeFromCols=null,this.resizeTakeFromStartWidth=null,this.resizeTakeFromRatios=null),utils_1._.addCssClass(this.getGui(),"ag-column-resizing")},n.prototype.onResizing=function(e,t){var o=[],t=this.normaliseDragChange(t);o.push({columns:this.resizeCols,ratios:this.resizeRatios,width:this.resizeStartWidth+t}),this.resizeTakeFromCols&&o.push({columns:this.resizeTakeFromCols,ratios:this.resizeTakeFromRatios,width:this.resizeTakeFromStartWidth-t}),this.columnController.resizeColumnSets(o,e,"uiColumnDragged"),e&&utils_1._.removeCssClass(this.getGui(),"ag-column-resizing")},n.prototype.normaliseDragChange=function(e){return this.gridOptionsWrapper.isEnableRtl()?this.pinned!==column_1.Column.PINNED_LEFT&&(e*=-1):this.pinned===column_1.Column.PINNED_RIGHT&&(e*=-1),e},n.TEMPLATE='<div class="ag-header-group-cell" role="presentation"><div ref="agResize" class="ag-header-cell-resize" role="presentation"></div></div>',__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],n.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],n.prototype,"columnController",void 0),__decorate([context_1.Autowired("horizontalResizeService"),__metadata("design:type",horizontalResizeService_1.HorizontalResizeService)],n.prototype,"horizontalResizeService",void 0),__decorate([context_1.Autowired("dragAndDropService"),__metadata("design:type",dragAndDropService_1.DragAndDropService)],n.prototype,"dragAndDropService",void 0),__decorate([context_1.Autowired("userComponentFactory"),__metadata("design:type",userComponentFactory_1.UserComponentFactory)],n.prototype,"userComponentFactory",void 0),__decorate([context_1.Autowired("gridApi"),__metadata("design:type",gridApi_1.GridApi)],n.prototype,"gridApi",void 0),__decorate([context_1.Autowired("columnApi"),__metadata("design:type",columnApi_1.ColumnApi)],n.prototype,"columnApi",void 0),__decorate([context_1.Autowired("beans"),__metadata("design:type",beans_1.Beans)],n.prototype,"beans",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],n.prototype,"postConstruct",null),n}(component_1.Component);exports.HeaderGroupWrapperComp=HeaderGroupWrapperComp;