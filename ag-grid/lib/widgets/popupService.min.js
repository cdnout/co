"use strict";var __decorate=this&&this.__decorate||function(e,t,n,o){var i,p=arguments.length,r=p<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,o);else for(var u=e.length-1;0<=u;u--)(i=e[u])&&(r=(p<3?i(r):3<p?i(t,n,r):i(t,n))||r);return 3<p&&r&&Object.defineProperty(t,n,r),r},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var constants_1=require("../constants"),context_1=require("../context/context"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),environment_1=require("../environment"),eventService_1=require("../eventService"),events_1=require("../events"),utils_1=require("../utils"),PopupService=function(){function e(){this.popupList=[]}return e.prototype.registerGridCore=function(e){this.gridCore=e},e.prototype.getDocument=function(){return this.gridOptionsWrapper.getDocument()},e.prototype.getPopupParent=function(){var e=this.gridOptionsWrapper.getPopupParent();return e||this.gridCore.getRootGui()},e.prototype.positionPopupForMenu=function(e){var t=e.eventSource.getBoundingClientRect(),n=this.getDocument(),o=this.getPopupParent(),i=(o===n.body?n.documentElement:o).getBoundingClientRect(),n=t.top-i.top,n=this.keepYWithinBounds(e,n),p=0<e.ePopup.clientWidth?e.ePopup.clientWidth:200;e.ePopup.style.minWidth=p+"px";var r,o=i.right-i.left-p;function u(){return t.right-i.left-2}function s(){return t.left-i.left-p}this.gridOptionsWrapper.isEnableRtl()?((r=s())<0&&(r=u()),o<r&&(r=0)):(o<(r=u())&&(r=s()),r<0&&(r=0)),e.ePopup.style.left=r+"px",e.ePopup.style.top=n+"px"},e.prototype.positionPopupUnderMouseEvent=function(e){var t=this.calculatePointerAlign(e.mouseEvent),n=t.x,o=t.y,i=e.ePopup,p=e.nudgeX,t=e.nudgeY;this.positionPopup({ePopup:i,x:n,y:o,nudgeX:p,nudgeY:t,keepWithinBounds:!0}),this.callPostProcessPopup(e.ePopup,null,e.mouseEvent,e.type,e.column,e.rowNode)},e.prototype.calculatePointerAlign=function(e){var t=this.getDocument(),n=this.getPopupParent(),o=n.getBoundingClientRect(),i=t.documentElement.getBoundingClientRect();return{x:e.clientX-(n===t.body?i:o).left,y:e.clientY-(n===t.body?i:o).top}},e.prototype.positionPopupUnderComponent=function(e){var t=e.eventSource.getBoundingClientRect(),n=this.getDocument(),o=this.getPopupParent(),i=e.alignSide||"left",n=(o===n.body?n.documentElement:o).getBoundingClientRect(),o=t.left-n.left;"right"===i&&(o-=e.ePopup.offsetWidth-t.width),this.positionPopup({ePopup:e.ePopup,minWidth:e.minWidth,minHeight:e.minHeight,nudgeX:e.nudgeX,nudgeY:e.nudgeY,x:o,y:t.top-n.top+t.height,keepWithinBounds:e.keepWithinBounds}),this.callPostProcessPopup(e.ePopup,e.eventSource,null,e.type,e.column,e.rowNode)},e.prototype.positionPopupOverComponent=function(e){var t=e.eventSource.getBoundingClientRect(),n=this.getDocument(),o=this.getPopupParent(),o=(o===n.body?n.documentElement:o).getBoundingClientRect();this.positionPopup({ePopup:e.ePopup,minWidth:e.minWidth,nudgeX:e.nudgeX,nudgeY:e.nudgeY,x:t.left-o.left,y:t.top-o.top,keepWithinBounds:e.keepWithinBounds}),this.callPostProcessPopup(e.ePopup,e.eventSource,null,e.type,e.column,e.rowNode)},e.prototype.callPostProcessPopup=function(e,t,n,o,i,p){var r=this.gridOptionsWrapper.getPostProcessPopupFunc();r&&r({column:i,rowNode:p,ePopup:e,type:o,eventSource:t,mouseEvent:n})},e.prototype.positionPopup=function(e){var t=e.x,n=e.y;e.nudgeX&&(t+=e.nudgeX),e.nudgeY&&(n+=e.nudgeY),e.keepWithinBounds&&(t=this.keepXWithinBounds(e,t),n=this.keepYWithinBounds(e,n)),e.ePopup.style.left=t+"px",e.ePopup.style.top=n+"px"},e.prototype.keepYWithinBounds=function(e,t){var n=this.gridOptionsWrapper.getDocument(),o=n.documentElement,i=this.getPopupParent(),p=i.getBoundingClientRect(),r=n.documentElement.getBoundingClientRect(),u=i===n.body,i=Math.min(200,p.height),n=0;e.minHeight&&e.minHeight<i?i=e.minHeight:0<e.ePopup.offsetHeight&&(i=e.ePopup.clientHeight,n=utils_1._.getAbsoluteHeight(e.ePopup)-i);o=u?utils_1._.getAbsoluteHeight(o)+o.scrollTop:p.height;u&&(o-=Math.abs(r.top-p.top));n=o-i-n-3;return Math.min(Math.max(t,0),Math.abs(n))},e.prototype.keepXWithinBounds=function(e,t){var n=this.gridOptionsWrapper.getDocument(),o=n.documentElement,i=this.getPopupParent(),p=i.getBoundingClientRect(),r=n.documentElement.getBoundingClientRect(),u=i===n.body,s=e.ePopup,i=Math.min(200,p.width),n=0;e.minWidth&&e.minWidth<i?i=e.minWidth:0<s.offsetWidth&&(i=s.offsetWidth,s.style.minWidth=i+"px",n=utils_1._.getAbsoluteWidth(s)-i);o=u?utils_1._.getAbsoluteWidth(o)+o.scrollLeft:p.width;u&&(o-=Math.abs(r.left-p.left));n=o-i-n-3;return Math.min(Math.max(t,0),Math.abs(n))},e.prototype.addAsModalPopup=function(e,t,n,o){return this.addPopup(!0,e,t,n,o)},e.prototype.addPopup=function(e,n,t,o,i,p){var r=this,u=this.gridOptionsWrapper.getDocument();if(!u)return console.warn("ag-grid: could not find the document, document is empty"),function(){};var s=utils_1._.findIndex(this.popupList,function(e){return e.element===n});if(-1!==s)return this.popupList[s].hideFunc;var a=this.getPopupParent();a.appendChild(n),n.style.top="0px",n.style.left="0px";var d=document.createElement("div"),s=this.environment.getTheme().theme;s&&utils_1._.addCssClass(d,s),utils_1._.addCssClass(d,"ag-popup"),utils_1._.addCssClass(n,this.gridOptionsWrapper.isEnableRtl()?"ag-rtl":"ag-ltr"),d.appendChild(n),a.appendChild(d),p?this.setAlwaysOnTop(d,!0):this.bringPopupToFront(d);function l(e){(e.which||e.keyCode)===constants_1.Constants.KEY_ESCAPE&&d.contains(document.activeElement)&&m(null)}function c(e){m(e)}function h(e){m(null,e)}var g=!1,m=function(e,t){r.isEventFromCurrentPopup(e,t,n)||r.isEventSameChainAsOriginalEvent(i,e,t)||g||(g=!0,a.removeChild(d),u.removeEventListener("keydown",l),u.removeEventListener("mousedown",c),u.removeEventListener("touchstart",h),u.removeEventListener("contextmenu",c),r.eventService.removeEventListener(events_1.Events.EVENT_DRAG_STARTED,c),o&&o(),r.popupList=r.popupList.filter(function(e){return e.element!==n}))};return window.setTimeout(function(){t&&u.addEventListener("keydown",l),e&&(u.addEventListener("mousedown",c),r.eventService.addEventListener(events_1.Events.EVENT_DRAG_STARTED,c),u.addEventListener("touchstart",h),u.addEventListener("contextmenu",c))},0),this.popupList.push({element:n,hideFunc:m}),m},e.prototype.isEventFromCurrentPopup=function(e,t,n){var o=e||t;if(!o)return!1;t=utils_1._.findIndex(this.popupList,function(e){return e.element===n});if(-1===t)return!1;for(var i=t;i<this.popupList.length;i++){var p=this.popupList[i];if(utils_1._.isElementInEventPath(p.element,o))return!0}for(var r=o.target;r&&r!=document.body;){if(r.classList.contains("ag-custom-component-popup")||null===r.parentElement)return!0;r=r.parentElement}},e.prototype.isEventSameChainAsOriginalEvent=function(e,t,n){var o=null;if(t?o=t:n&&(o=n.touches[0]),o&&e){o=t?t.screenX:0,t=t?t.screenY:0,o=Math.abs(e.screenX-o)<5,t=Math.abs(e.screenY-t)<5;if(o&&t)return!0}return!1},e.prototype.getWrapper=function(e){for(;!utils_1._.containsClass(e,"ag-popup")&&e.parentElement;)e=e.parentElement;return utils_1._.containsClass(e,"ag-popup")?e:null},e.prototype.setAlwaysOnTop=function(e,t){e=this.getWrapper(e);e&&(utils_1._.addOrRemoveCssClass(e,"ag-always-on-top",!!t),t&&this.bringPopupToFront(e))},e.prototype.bringPopupToFront=function(e){var t=this.getPopupParent(),n=Array.prototype.slice.call(t.querySelectorAll(".ag-popup")),o=n.length,i=Array.prototype.slice.call(t.querySelectorAll(".ag-popup.ag-always-on-top")),p=i.length,r=this.getWrapper(e);!r||o<=1||!t.contains(e)||(e=n.indexOf(r),p?utils_1._.containsClass(r,"ag-always-on-top")?e!==o-1&&utils_1._.last(i).insertAdjacentElement("afterend",r):e!==o-p-1&&i[0].insertAdjacentElement("beforebegin",r):e!==o-1&&utils_1._.last(n).insertAdjacentElement("afterend",r),r={type:"popupToFront",api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),eWrapper:r},this.eventService.dispatchEvent(r))},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("environment"),__metadata("design:type",environment_1.Environment)],e.prototype,"environment",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Bean("popupService")],e)}();exports.PopupService=PopupService;