"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}(),__decorate=this&&this.__decorate||function(t,e,i,o){var s,n=arguments.length,r=n<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;0<=a;a--)(s=t[a])&&(r=(n<3?s(r):3<n?s(e,i,r):s(e,i))||r);return 3<n&&r&&Object.defineProperty(e,i,r),r},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};Object.defineProperty(exports,"__esModule",{value:!0});var dragService_1=require("../dragAndDrop/dragService"),componentAnnotations_1=require("./componentAnnotations"),context_1=require("../context/context"),popupService_1=require("./popupService"),popupComponent_1=require("./popupComponent"),utils_1=require("../utils"),component_1=require("./component"),Dialog=function(i){function o(t){var e=i.call(this,o.TEMPLATE)||this;return e.resizable={},e.isResizable=!1,e.isMaximizable=!1,e.isMaximized=!1,e.maximizeListeners=[],e.movable=!1,e.closable=!0,e.isMoving=!1,e.isResizing=!1,e.dragStartPosition={x:0,y:0},e.position={x:0,y:0},e.size={width:0,height:0},e.lastPosition={x:0,y:0,width:0,height:0},e.config=t,e}return __extends(o,i),o.prototype.postConstruct=function(){var e=this,t=this.config,i=t.alwaysOnTop,o=t.component,s=t.centered,n=t.resizable,r=t.movable,a=t.maximizable,p=t.closable,h=t.title,l=t.minWidth,c=t.width,d=t.minHeight,g=t.height,m=this.config,t=m.x,m=m.y,u=this.getGui();this.popupParent=this.popupService.getPopupParent(),this.minHeight=null!=d?d:250,this.minWidth=null!=l?l:250,o&&this.setBodyComponent(o),n&&this.setResizable(n),h&&this.setTitle(h),this.isResizable&&a&&this.setMaximizable(a),this.setMovable(!!r),this.setClosable(null!=p?p:this.closable),c&&(utils_1._.setFixedWidth(u,c),this.size.width=c),g&&(utils_1._.setFixedHeight(u,g),this.size.height=g),this.close=this.popupService.addPopup(!1,u,!0,this.destroy.bind(this)),i&&(u.style.zIndex="6"),this.refreshSize(),u.focus(),s&&(t=u.offsetParent.clientWidth/2-this.getWidth()/2,m=u.offsetParent.clientHeight/2-this.getHeight()/2),(t||m)&&this.offsetDialog(t,m),this.addDestroyableEventListener(this.eTitleBar,"mousedown",function(t){u.contains(t.relatedTarget)||u.contains(document.activeElement)||(t=e.eContentWrapper.querySelector("button, [href], input, select, textarea, [tabindex]"))&&t.focus()}),this.addDestroyableEventListener(u,"focusin",function(t){u.contains(t.relatedTarget)||e.popupService.bringPopupToFront(u)})},o.prototype.updateDragStartPosition=function(t,e){this.dragStartPosition={x:t,y:e}},o.prototype.getResizerElement=function(t){return{topLeft:this.eTopLeftResizer,top:this.eTopResizer,topRight:this.eTopRightResizer,right:this.eRightResizer,bottomRight:this.eBottomRightResizer,bottom:this.eBottomResizer,bottomLeft:this.eBottomLeftResizer,left:this.eLeftResizer}[t]},o.prototype.setResizable=function(s){var n=this,r=!1;"boolean"==typeof s&&(s={topLeft:s,top:s,topRight:s,right:s,bottomRight:s,bottom:s,bottomLeft:s,left:s}),Object.keys(s).forEach(function(t){var e=t,i=!!s[e],o=n.getResizerElement(e),t={eElement:o,onDragStart:n.onDialogResizeStart.bind(n),onDragging:function(t){return n.onDialogResize(t,e)},onDragStop:n.onDialogResizeEnd.bind(n)};!!n.resizable[e]!=i&&(i?(n.dragService.addDragSource(t),o.style.pointerEvents="all",r=!0):(n.dragService.removeDragSource(t),o.style.pointerEvents="none"))}),this.isResizable=r},o.prototype.onDialogResizeStart=function(t){this.isResizing=!0,this.updateDragStartPosition(t.clientX,t.clientY)},o.prototype.calculateMouseMovement=function(t){var e=this.popupParent.getBoundingClientRect(),i=t.e,o=t.isLeft,s=t.isTop,n=t.anywhereWithin,r=t.topBuffer,a=i.clientX-this.dragStartPosition.x,p=i.clientY-this.dragStartPosition.y,h=this.getWidth(),l=this.getHeight(),t=e.left>=i.clientX&&this.position.x<=0||e.right<=i.clientX&&e.right<=this.position.x+e.left+h;return{movementX:a=(t=t||(o?a<0&&i.clientX>this.position.x+e.left||0<a&&i.clientX<this.position.x+e.left:n?a<0&&i.clientX>this.position.x+e.left+h||0<a&&i.clientX<this.position.x+e.left:a<0&&i.clientX>this.position.x+e.left+h||0<a&&i.clientX<this.position.x+e.left+h))?0:a,movementY:p=e.top>=i.clientY&&this.position.y<=0||e.bottom<=i.clientY&&e.bottom<=this.position.y+e.top+l||s&&(p<0&&i.clientY>this.position.y+e.top+(r||0)||0<p&&i.clientY<this.position.y+e.top)||!s&&(p<0&&i.clientY>this.position.y+e.top+l||0<p&&i.clientY<this.position.y+e.top+l)?0:p}},o.prototype.onDialogResize=function(t,e){var i,o,s,n,r,a,p,h,l;this.isResizing&&(i=!!e.match(/left/i),s=!!e.match(/right/i),o=!!e.match(/top/i),n=!!e.match(/bottom/i),a=i||s,h=o||n,p=(r=this.calculateMouseMovement({e:t,isLeft:i,isTop:o})).movementX,e=r.movementY,n=s=0,a&&p&&(l=i?-1:1,a=(r=this.getWidth())+p*l,p=!1,i&&(s=r-a,(this.position.x+s<=0||a<=this.minWidth)&&(p=!0,s=0)),p||this.setWidth(a)),h&&e&&(l=o?-1:1,e=(h=this.getHeight())+e*l,l=!1,o&&(n=h-e,(this.position.y+n<=0||e<=this.minHeight)&&(l=!0,n=0)),l||this.setHeight(e)),this.updateDragStartPosition(t.clientX,t.clientY),(s||n)&&this.offsetDialog(this.position.x+s,this.position.y+n),this.isMaximized=!1)},o.prototype.onDialogResizeEnd=function(){this.isResizing=!1},o.prototype.refreshSize=function(){var t=this.size,e=t.width,t=t.height;e||this.setWidth(this.getGui().offsetWidth),t||this.setHeight(this.getGui().offsetHeight)},o.prototype.setMovable=function(t){var e;t!==this.movable&&(this.movable=t,e={eElement:this.eTitleBar,onDragStart:this.onDialogMoveStart.bind(this),onDragging:this.onDialogMove.bind(this),onDragStop:this.onDialogMoveEnd.bind(this)},this.dragService[t?"addDragSource":"removeDragSource"](e))},o.prototype.onDialogMoveStart=function(t){this.isMoving=!0,this.updateDragStartPosition(t.clientX,t.clientY)},o.prototype.onDialogMove=function(t){var e,i,o,s;this.isMoving&&(e=(o=this.position).x,i=o.y,o=(s=this.calculateMouseMovement({e:t,isTop:!0,anywhereWithin:!0,topBuffer:this.getHeight()-this.getBodyHeight()})).movementX,s=s.movementY,this.offsetDialog(e+o,i+s),this.updateDragStartPosition(t.clientX,t.clientY))},o.prototype.offsetDialog=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=this.getGui();this.popupService.positionPopup({ePopup:i,x:t,y:e,minWidth:this.minWidth,minHeight:this.minHeight,keepWithinBounds:!0}),this.position.x=parseInt(i.style.left,10),this.position.y=parseInt(i.style.top,10)},o.prototype.onDialogMoveEnd=function(){this.isMoving=!1},o.prototype.setClosable=function(t){t!==this.closable&&(this.closable=t),t?(t=this.closeButtonComp=new component_1.Component(o.CLOSE_BTN_TEMPLATE),this.addTitleBarButton(t),t.addDestroyableEventListener(t.getGui(),"click",this.onBtClose.bind(this))):this.closeButtonComp&&(this.closeButtonComp.destroy(),this.closeButtonComp=void 0)},o.prototype.setMaximizable=function(t){if(!1===t)return this.clearMaximizebleListeners(),void(this.maximizeButtonComp&&(this.maximizeButtonComp.destroy(),this.maximizeButtonComp=void 0));var e=this.eTitleBar;this.isResizable&&e&&t!==this.isMaximizable&&((t=this.maximizeButtonComp=new component_1.Component(o.MAXIMIZE_BTN_TEMPLATE)).addDestroyableEventListener(t.getGui(),"click",this.toggleMaximize.bind(this)),this.addTitleBarButton(t,0),this.maximizeListeners.push(this.addDestroyableEventListener(e,"dblclick",this.toggleMaximize.bind(this))))},o.prototype.toggleMaximize=function(){var t,e,i,o=this.maximizeButtonComp.getGui(),s=o.querySelector(".ag-icon-maximize"),n=o.querySelector(".ag-icon-minimize");this.isMaximized?(t=(i=this.lastPosition).x,e=i.y,o=i.width,i=i.height,this.setWidth(o),this.setHeight(i),this.offsetDialog(t,e)):(this.lastPosition.width=this.getWidth(),this.lastPosition.height=this.getHeight(),this.lastPosition.x=this.position.x,this.lastPosition.y=this.position.y,this.offsetDialog(0,0),this.setHeight(1/0),this.setWidth(1/0)),this.isMaximized=!this.isMaximized,utils_1._.addOrRemoveCssClass(s,"ag-hidden",this.isMaximized),utils_1._.addOrRemoveCssClass(n,"ag-hidden",!this.isMaximized)},o.prototype.clearMaximizebleListeners=function(){this.maximizeListeners.length&&(this.maximizeListeners.forEach(function(t){return t()}),this.maximizeListeners.length=0)},o.prototype.setBodyComponent=function(t){t.setParentComponent(this),this.eContentWrapper.appendChild(t.getGui())},o.prototype.addTitleBarButton=function(t,e){var i=this.eTitleBarButtons,o=i.children,s=o.length;null==e&&(e=s),e=Math.max(0,Math.min(e,s));var n=t.getGui();utils_1._.addCssClass(n,"ag-dialog-button"),0===e?i.insertAdjacentElement("afterbegin",n):e===s?i.insertAdjacentElement("beforeend",n):o[e-1].insertAdjacentElement("afterend",n),t.setParentComponent(this)},o.prototype.getBodyHeight=function(){return utils_1._.getInnerHeight(this.eContentWrapper)},o.prototype.getBodyWidth=function(){return utils_1._.getInnerWidth(this.eContentWrapper)},o.prototype.setTitle=function(t){this.eTitle.innerText=t},o.prototype.getHeight=function(){return this.size.height},o.prototype.setHeight=function(t){var e=Math.max(this.minHeight,t),t=this.getGui();e+this.position.y>t.offsetParent.clientHeight&&(e=t.offsetParent.clientHeight-this.position.y),this.size.height!==e&&(this.size.height=e,utils_1._.setFixedHeight(t,e),utils_1._.setFixedHeight(this.eContentWrapper,t.clientHeight-this.eTitleBar.offsetHeight))},o.prototype.getWidth=function(){return this.size.width},o.prototype.setWidth=function(t){var e=Math.max(this.minWidth,t),t=this.getGui();e+this.position.x>t.offsetParent.clientWidth&&(e=t.offsetParent.clientWidth-this.position.x),this.size.width!==e&&(this.size.width=e,utils_1._.setFixedWidth(t,e))},o.prototype.onBtClose=function(){this.close()},o.prototype.destroy=function(){i.prototype.destroy.call(this),this.closeButtonComp&&(this.closeButtonComp.destroy(),this.closeButtonComp=void 0),this.maximizeButtonComp&&(this.maximizeButtonComp.destroy(),this.maximizeButtonComp=void 0),this.clearMaximizebleListeners();var t=this.getGui();t&&t.offsetParent&&this.close()},o.TEMPLATE='<div class="ag-dialog" tabindex="-1">\n            <div class="ag-resizer-wrapper">\n                <div ref="eTopLeftResizer" class="ag-resizer ag-resizer-topLeft"></div>\n                <div ref="eTopResizer" class="ag-resizer ag-resizer-top"></div>\n                <div ref="eTopRightResizer" class="ag-resizer ag-resizer-topRight"></div>\n                <div ref="eRightResizer" class="ag-resizer ag-resizer-right"></div>\n                <div ref="eBottomRightResizer" class="ag-resizer ag-resizer-bottomRight"></div>\n                <div ref="eBottomResizer" class="ag-resizer ag-resizer-bottom"></div>\n                <div ref="eBottomLeftResizer" class="ag-resizer ag-resizer-bottomLeft"></div>\n                <div ref="eLeftResizer" class="ag-resizer ag-resizer-left"></div>\n            </div>\n            <div ref="eTitleBar" class="ag-dialog-title-bar ag-unselectable">\n                <span ref="eTitle" class="ag-dialog-title-bar-title"></span>\n                <div ref="eTitleBarButtons" class="ag-dialog-title-bar-buttons"></div>\n            </div>\n            <div ref="eContentWrapper" class="ag-dialog-content-wrapper"></div>\n        </div>',o.CLOSE_BTN_TEMPLATE='<div class="ag-dialog-button">\n            <span class="ag-icon ag-icon-cross"></span>\n        </div>\n        ',o.MAXIMIZE_BTN_TEMPLATE='<div class="ag-dialog-button">\n            <span class="ag-icon ag-icon-maximize"></span>\n            <span class="ag-icon ag-icon-minimize ag-hidden"></span>\n        </span>\n        ',__decorate([context_1.Autowired("dragService"),__metadata("design:type",dragService_1.DragService)],o.prototype,"dragService",void 0),__decorate([context_1.Autowired("popupService"),__metadata("design:type",popupService_1.PopupService)],o.prototype,"popupService",void 0),__decorate([componentAnnotations_1.RefSelector("eContentWrapper"),__metadata("design:type",HTMLElement)],o.prototype,"eContentWrapper",void 0),__decorate([componentAnnotations_1.RefSelector("eTitleBar"),__metadata("design:type",HTMLElement)],o.prototype,"eTitleBar",void 0),__decorate([componentAnnotations_1.RefSelector("eTitleBarButtons"),__metadata("design:type",HTMLElement)],o.prototype,"eTitleBarButtons",void 0),__decorate([componentAnnotations_1.RefSelector("eTitle"),__metadata("design:type",HTMLElement)],o.prototype,"eTitle",void 0),__decorate([componentAnnotations_1.RefSelector("eTopLeftResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eTopLeftResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eTopResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eTopResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eTopRightResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eTopRightResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eRightResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eRightResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eBottomRightResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eBottomRightResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eBottomResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eBottomResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eBottomLeftResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eBottomLeftResizer",void 0),__decorate([componentAnnotations_1.RefSelector("eLeftResizer"),__metadata("design:type",HTMLElement)],o.prototype,"eLeftResizer",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],o.prototype,"postConstruct",null),o}(popupComponent_1.PopupComponent);exports.Dialog=Dialog;