"use strict";var __decorate=this&&this.__decorate||function(e,o,t,r){var n,i=arguments.length,a=i<3?o:null===r?r=Object.getOwnPropertyDescriptor(o,t):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,o,t,r);else for(var u=e.length-1;0<=u;u--)(n=e[u])&&(a=(i<3?n(a):3<i?n(o,t,a):n(o,t))||a);return 3<i&&a&&Object.defineProperty(o,t,a),a},__metadata=this&&this.__metadata||function(e,o){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,o)},__param=this&&this.__param||function(t,r){return function(e,o){r(e,o,t)}};Object.defineProperty(exports,"__esModule",{value:!0});var gridOptionsWrapper_1=require("../gridOptionsWrapper"),logger_1=require("../logger"),columnUtils_1=require("./columnUtils"),columnKeyCreator_1=require("./columnKeyCreator"),originalColumnGroup_1=require("../entities/originalColumnGroup"),column_1=require("../entities/column"),context_1=require("../context/context"),defaultColumnTypes_1=require("../entities/defaultColumnTypes"),utils_1=require("../utils"),ColumnFactory=function(){function e(){}return e.prototype.setBeans=function(e){this.logger=e.create("ColumnFactory")},e.prototype.createColumnTree=function(e,o,t){var r,n=new columnKeyCreator_1.ColumnKeyCreator;t&&(r=t.map(function(e){return e.getId()}),n.addExistingKeys(r));t=t?t.slice():null,o=this.recursivelyCreateColumns(e,0,o,t,n,null),t=this.findMaxDept(o,0);this.logger.log("Number of levels for grouped columns is "+t);n=this.balanceColumnTree(o,0,t,n);return this.columnUtils.depthFirstOriginalTreeSearch(null,n,function(e,o){e instanceof originalColumnGroup_1.OriginalColumnGroup&&e.setupExpandable(),e.setOriginalParent(o)}),{columnTree:n,treeDept:t}},e.prototype.createForAutoGroups=function(e,o){var t=this,r=[];return e.forEach(function(e){e=t.createAutoGroupTreeItem(o,e);r.push(e)}),r},e.prototype.createAutoGroupTreeItem=function(e,o){for(var t=o,r=this.findDepth(e)-1;0<=r;r--){var n=new originalColumnGroup_1.OriginalColumnGroup(null,"FAKE_PATH_"+o.getId()+"}_"+r,!0,r);this.context.wireBean(n),n.setChildren([t]),t.setOriginalParent(n),t=n}return t},e.prototype.findDepth=function(e){for(var o=0,t=e;t&&t[0]&&t[0]instanceof originalColumnGroup_1.OriginalColumnGroup;)o++,t=t[0].getChildren();return o},e.prototype.balanceColumnTree=function(e,o,t,r){for(var n=[],i=0;i<e.length;i++){var a=e[i];if(a instanceof originalColumnGroup_1.OriginalColumnGroup){var u=a,l=this.balanceColumnTree(u.getChildren(),o+1,t,r);u.setChildren(l),n.push(u)}else{for(var s=void 0,p=void 0,c=t-1;o<=c;c--){var d=r.getUniqueKey(null,null),g=this.createMergedColGroupDef(null),d=new originalColumnGroup_1.OriginalColumnGroup(g,d,!0,o);this.context.wireBean(d),p&&p.setChildren([d]),p=d,s=s||p}if(s){if(n.push(s),e.some(function(e){return e instanceof originalColumnGroup_1.OriginalColumnGroup})){p.setChildren([a]);continue}p.setChildren(e);break}n.push(a)}}return n},e.prototype.findMaxDept=function(e,o){for(var t=o,r=0;r<e.length;r++){var n=e[r];n instanceof originalColumnGroup_1.OriginalColumnGroup&&(t<(n=this.findMaxDept(n.getChildren(),o+1))&&(t=n))}return t},e.prototype.recursivelyCreateColumns=function(e,o,t,r,n,i){var a=this,u=[];return e&&e.forEach(function(e){e=a.isColumnGroup(e)?a.createColumnGroup(t,e,o,r,n,i):a.createColumn(t,e,r,n,i);u.push(e)}),u},e.prototype.createColumnGroup=function(e,o,t,r,n,i){var a=this.createMergedColGroupDef(o),o=n.getUniqueKey(a.groupId,null),o=new originalColumnGroup_1.OriginalColumnGroup(a,o,!1,t);this.context.wireBean(o);n=this.recursivelyCreateColumns(a.children,t+1,e,r,n,o);return o.setChildren(n),o},e.prototype.createMergedColGroupDef=function(e){var o={};return utils_1._.assign(o,this.gridOptionsWrapper.getDefaultColGroupDef()),utils_1._.assign(o,e),this.checkForDeprecatedItems(o),o},e.prototype.createColumn=function(e,o,t,r,n){var i=this.mergeColDefs(o);this.checkForDeprecatedItems(i);t=this.findExistingColumn(o,t);return t?t.setColDef(i,o):(r=r.getUniqueKey(i.colId,i.field),t=new column_1.Column(i,o,r,e),this.context.wireBean(t)),t},e.prototype.findExistingColumn=function(o,e){var t=utils_1._.find(e,function(e){e=e.getUserProvidedColDef();return!!e&&(e===o||null!==e.colId&&void 0!==e.colId&&e.colId===o.colId)});return t&&utils_1._.removeFromArray(e,t),t},e.prototype.mergeColDefs=function(e){var o={};return utils_1._.assign(o,this.gridOptionsWrapper.getDefaultColDef()),e.type&&this.assignColumnTypes(e,o),utils_1._.assign(o,e),o},e.prototype.assignColumnTypes=function(e,t){var o;if(e.type instanceof Array)e.type.some(function(e){return"string"!=typeof e})?console.warn("ag-grid: if colDef.type is supplied an array it should be of type 'string[]'"):o=e.type;else{if("string"!=typeof e.type)return void console.warn("ag-grid: colDef.type should be of type 'string' | 'string[]'");o=e.type.split(",")}var r=utils_1._.assign({},this.gridOptionsWrapper.getColumnTypes(),defaultColumnTypes_1.DefaultColumnTypes);o.forEach(function(e){var o=r[e.trim()];o?utils_1._.assign(t,o):console.warn("ag-grid: colDef.type '"+e+"' does not correspond to defined gridOptions.columnTypes")})},e.prototype.checkForDeprecatedItems=function(e){e&&(void 0!==(e=e).group&&console.warn("ag-grid: colDef.group is invalid, please check documentation on how to do grouping as it changed in version 3"),void 0!==e.headerGroup&&console.warn("ag-grid: colDef.headerGroup is invalid, please check documentation on how to do grouping as it changed in version 3"),void 0!==e.headerGroupShow&&console.warn("ag-grid: colDef.headerGroupShow is invalid, should be columnGroupShow, please check documentation on how to do grouping as it changed in version 3"),void 0!==e.suppressRowGroup&&console.warn("ag-grid: colDef.suppressRowGroup is deprecated, please use colDef.type instead"),void 0!==e.suppressAggregation&&console.warn("ag-grid: colDef.suppressAggregation is deprecated, please use colDef.type instead"),(e.suppressRowGroup||e.suppressAggregation)&&console.warn("ag-grid: colDef.suppressAggregation and colDef.suppressRowGroup are deprecated, use allowRowGroup, allowPivot and allowValue instead"),e.displayName&&(console.warn("ag-grid: Found displayName "+e.displayName+", please use headerName instead, displayName is deprecated."),e.headerName=e.displayName))},e.prototype.isColumnGroup=function(e){return void 0!==e.children},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("columnUtils"),__metadata("design:type",columnUtils_1.ColumnUtils)],e.prototype,"columnUtils",void 0),__decorate([context_1.Autowired("context"),__metadata("design:type",context_1.Context)],e.prototype,"context",void 0),__decorate([__param(0,context_1.Qualifier("loggerFactory")),__metadata("design:type",Function),__metadata("design:paramtypes",[logger_1.LoggerFactory]),__metadata("design:returntype",void 0)],e.prototype,"setBeans",null),__decorate([context_1.Bean("columnFactory")],e)}();exports.ColumnFactory=ColumnFactory;