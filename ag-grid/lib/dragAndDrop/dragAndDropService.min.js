"use strict";var __decorate=this&&this.__decorate||function(t,e,r,o){var i,n=arguments.length,a=n<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,o);else for(var s=t.length-1;0<=s;s--)(i=t[s])&&(a=(n<3?i(a):3<n?i(e,r,a):i(e,r))||a);return 3<n&&a&&Object.defineProperty(e,r,a),a},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(r,o){return function(t,e){o(t,e,r)}};Object.defineProperty(exports,"__esModule",{value:!0});var DragSourceType,VDirection,HDirection,logger_1=require("../logger"),context_1=require("../context/context"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),dragService_1=require("./dragService"),columnController_1=require("../columnController/columnController"),environment_1=require("../environment"),utils_1=require("../utils");!function(t){t[t.ToolPanel=0]="ToolPanel",t[t.HeaderCell=1]="HeaderCell",t[t.RowDrag=2]="RowDrag"}(DragSourceType=exports.DragSourceType||(exports.DragSourceType={})),function(t){t[t.Up=0]="Up",t[t.Down=1]="Down"}(VDirection=exports.VDirection||(exports.VDirection={})),function(t){t[t.Left=0]="Left",t[t.Right=1]="Right"}(HDirection=exports.HDirection||(exports.HDirection={}));var DragAndDropService=function(){function t(){this.dragSourceAndParamsList=[],this.dropTargets=[]}var o=t;return t.prototype.init=function(){this.ePinnedIcon=utils_1._.createIcon("columnMovePin",this.gridOptionsWrapper,null),this.ePlusIcon=utils_1._.createIcon("columnMoveAdd",this.gridOptionsWrapper,null),this.eHiddenIcon=utils_1._.createIcon("columnMoveHide",this.gridOptionsWrapper,null),this.eMoveIcon=utils_1._.createIcon("columnMoveMove",this.gridOptionsWrapper,null),this.eLeftIcon=utils_1._.createIcon("columnMoveLeft",this.gridOptionsWrapper,null),this.eRightIcon=utils_1._.createIcon("columnMoveRight",this.gridOptionsWrapper,null),this.eGroupIcon=utils_1._.createIcon("columnMoveGroup",this.gridOptionsWrapper,null),this.eAggregateIcon=utils_1._.createIcon("columnMoveValue",this.gridOptionsWrapper,null),this.ePivotIcon=utils_1._.createIcon("columnMovePivot",this.gridOptionsWrapper,null),this.eDropNotAllowedIcon=utils_1._.createIcon("dropNotAllowed",this.gridOptionsWrapper,null)},t.prototype.setBeans=function(t){this.logger=t.create("OldToolPanelDragAndDropService")},t.prototype.getStringType=function(t){switch(t){case DragSourceType.RowDrag:return"row";case DragSourceType.HeaderCell:return"headerCell";case DragSourceType.ToolPanel:return"toolPanel";default:return console.warn("ag-Grid: bug - unknown drag type "+t),null}},t.prototype.addDragSource=function(t,e){void 0===e&&(e=!1);var r={eElement:t.eElement,dragStartPixels:t.dragStartPixels,onDragStart:this.onDragStart.bind(this,t),onDragStop:this.onDragStop.bind(this),onDragging:this.onDragging.bind(this)};this.dragSourceAndParamsList.push({params:r,dragSource:t}),this.dragService.addDragSource(r,e)},t.prototype.removeDragSource=function(e){var t=utils_1._.find(this.dragSourceAndParamsList,function(t){return t.dragSource===e});t&&(this.dragService.removeDragSource(t.params),utils_1._.removeFromArray(this.dragSourceAndParamsList,t))},t.prototype.destroy=function(){var e=this;this.dragSourceAndParamsList.forEach(function(t){e.dragService.removeDragSource(t.params)}),this.dragSourceAndParamsList.length=0},t.prototype.nudge=function(){this.dragging&&this.onDragging(this.eventLastTime,!0)},t.prototype.onDragStart=function(t,e){this.dragging=!0,this.dragSource=t,this.eventLastTime=e,this.dragItem=this.dragSource.dragItemCallback(),this.lastDropTarget=this.dragSource.dragSourceDropTarget,this.dragSource.dragStarted&&this.dragSource.dragStarted(),this.createGhost()},t.prototype.onDragStop=function(t){this.eventLastTime=null,this.dragging=!1,this.dragSource.dragStopped&&this.dragSource.dragStopped(),this.lastDropTarget&&this.lastDropTarget.onDragStop&&(t=this.createDropTargetEvent(this.lastDropTarget,t,null,null,!1),this.lastDropTarget.onDragStop(t)),this.lastDropTarget=null,this.dragItem=null,this.removeGhost()},t.prototype.onDragging=function(t,e){var r=this.workOutHDirection(t),o=this.workOutVDirection(t);this.eventLastTime=t,this.positionGhost(t);var i=utils_1._.find(this.dropTargets,this.isMouseOnDropTarget.bind(this,t));i!==this.lastDropTarget?(this.leaveLastTargetIfExists(t,r,o,e),this.enterDragTargetIfExists(i,t,r,o,e),this.lastDropTarget=i):i&&(e=this.createDropTargetEvent(i,t,r,o,e),i.onDragging(e))},t.prototype.enterDragTargetIfExists=function(t,e,r,o,i){t&&(i=this.createDropTargetEvent(t,e,r,o,i),t.onDragEnter(i),this.setGhostIcon(t.getIconName?t.getIconName():null))},t.prototype.leaveLastTargetIfExists=function(t,e,r,o){this.lastDropTarget&&(o=this.createDropTargetEvent(this.lastDropTarget,t,e,r,o),this.lastDropTarget.onDragLeave(o),this.setGhostIcon(null))},t.prototype.getAllContainersFromDropTarget=function(t){var e=[t.getContainer()],t=t.getSecondaryContainers?t.getSecondaryContainers():null;return t&&(e=e.concat(t)),e},t.prototype.isMouseOnDropTarget=function(r,t){var e=this.getAllContainersFromDropTarget(t),o=!1;return e.forEach(function(t){var e;!t||0!==(e=t.getBoundingClientRect()).width&&0!==e.height&&(t=r.clientX>=e.left&&r.clientX<=e.right,e=r.clientY>=e.top&&r.clientY<=e.bottom,t&&e&&(o=!0))}),!!o&&t.isInterestedIn(this.dragSource.type)},t.prototype.addDropTarget=function(t){this.dropTargets.push(t)},t.prototype.workOutHDirection=function(t){return this.eventLastTime.clientX>t.clientX?HDirection.Left:this.eventLastTime.clientX<t.clientX?HDirection.Right:null},t.prototype.workOutVDirection=function(t){return this.eventLastTime.clientY>t.clientY?VDirection.Up:this.eventLastTime.clientY<t.clientY?VDirection.Down:null},t.prototype.createDropTargetEvent=function(t,e,r,o,i){t=t.getContainer().getBoundingClientRect();return{event:e,x:e.clientX-t.left,y:e.clientY-t.top,vDirection:o,hDirection:r,dragSource:this.dragSource,fromNudge:i,dragItem:this.dragItem}},t.prototype.positionGhost=function(t){var e=this.eGhost.getBoundingClientRect().height,r=utils_1._.getBodyWidth()-2,o=utils_1._.getBodyHeight()-2,i=t.pageY-e/2,n=t.pageX-30,e=this.gridOptionsWrapper.getDocument(),t=window.pageYOffset||e.documentElement.scrollTop,e=window.pageXOffset||e.documentElement.scrollLeft;0<r&&n+this.eGhost.clientWidth>r+e&&(n=r+e-this.eGhost.clientWidth),n<0&&(n=0),0<o&&i+this.eGhost.clientHeight>o+t&&(i=o+t-this.eGhost.clientHeight),i<0&&(i=0),this.eGhost.style.left=n+"px",this.eGhost.style.top=i+"px"},t.prototype.removeGhost=function(){this.eGhost&&this.eGhostParent&&this.eGhostParent.removeChild(this.eGhost),this.eGhost=null},t.prototype.createGhost=function(){this.eGhost=utils_1._.loadTemplate(o.GHOST_TEMPLATE);var t=this.environment.getTheme().theme;t&&utils_1._.addCssClass(this.eGhost,t),this.eGhostIcon=this.eGhost.querySelector(".ag-dnd-ghost-icon"),this.setGhostIcon(null),this.eGhost.querySelector(".ag-dnd-ghost-label").innerHTML=utils_1._.escape(this.dragSource.dragItemName),this.eGhost.style.height="25px",this.eGhost.style.top="20px",this.eGhost.style.left="20px";t=this.gridOptionsWrapper.getDocument();this.eGhostParent=t.querySelector("body"),this.eGhostParent?this.eGhostParent.appendChild(this.eGhost):console.warn("ag-Grid: could not find document body, it is needed for dragging columns")},t.prototype.setGhostIcon=function(t,e){var r;switch(void 0===e&&(e=!1),utils_1._.clearElement(this.eGhostIcon),t){case o.ICON_ADD:r=this.ePlusIcon;break;case o.ICON_PINNED:r=this.ePinnedIcon;break;case o.ICON_MOVE:r=this.eMoveIcon;break;case o.ICON_LEFT:r=this.eLeftIcon;break;case o.ICON_RIGHT:r=this.eRightIcon;break;case o.ICON_GROUP:r=this.eGroupIcon;break;case o.ICON_AGGREGATE:r=this.eAggregateIcon;break;case o.ICON_PIVOT:r=this.ePivotIcon;break;case o.ICON_NOT_ALLOWED:r=this.eDropNotAllowedIcon;break;default:r=this.eHiddenIcon}this.eGhostIcon.appendChild(r),utils_1._.addOrRemoveCssClass(this.eGhostIcon,"ag-shake-left-to-right",e)},t.ICON_PINNED="pinned",t.ICON_ADD="add",t.ICON_MOVE="move",t.ICON_LEFT="left",t.ICON_RIGHT="right",t.ICON_GROUP="group",t.ICON_AGGREGATE="aggregate",t.ICON_PIVOT="pivot",t.ICON_NOT_ALLOWED="notAllowed",t.GHOST_TEMPLATE='<div class="ag-dnd-ghost">  <span class="ag-dnd-ghost-icon ag-shake-left-to-right"></span>  <div class="ag-dnd-ghost-label">  </div></div>',__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],t.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("dragService"),__metadata("design:type",dragService_1.DragService)],t.prototype,"dragService",void 0),__decorate([context_1.Autowired("environment"),__metadata("design:type",environment_1.Environment)],t.prototype,"environment",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],t.prototype,"columnController",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],t.prototype,"init",null),__decorate([__param(0,context_1.Qualifier("loggerFactory")),__metadata("design:type",Function),__metadata("design:paramtypes",[logger_1.LoggerFactory]),__metadata("design:returntype",void 0)],t.prototype,"setBeans",null),__decorate([context_1.PreDestroy,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],t.prototype,"destroy",null),o=__decorate([context_1.Bean("dragAndDropService")],t)}();exports.DragAndDropService=DragAndDropService;