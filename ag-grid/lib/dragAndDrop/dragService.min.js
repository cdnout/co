"use strict";var __decorate=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(s=(i<3?n(s):3<i?n(t,o,s):n(t,o))||s);return 3<i&&s&&Object.defineProperty(t,o,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),logger_1=require("../logger"),eventService_1=require("../eventService"),events_1=require("../events"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),columnApi_1=require("../columnController/columnApi"),gridApi_1=require("../gridApi"),utils_1=require("../utils"),DragService=function(){function e(){this.onMouseUpListener=this.onMouseUp.bind(this),this.onMouseMoveListener=this.onMouseMove.bind(this),this.onTouchEndListener=this.onTouchUp.bind(this),this.onTouchMoveListener=this.onTouchMove.bind(this),this.dragEndFunctions=[],this.dragSources=[]}return e.prototype.init=function(){this.logger=this.loggerFactory.create("DragService")},e.prototype.destroy=function(){this.dragSources.forEach(this.removeListener.bind(this)),this.dragSources.length=0},e.prototype.removeListener=function(e){var t=e.dragSource.eElement,o=e.mouseDownListener;t.removeEventListener("mousedown",o),e.touchEnabled&&(e=e.touchStartListener,t.removeEventListener("touchstart",e,{passive:!0}))},e.prototype.removeDragSource=function(t){var e=utils_1._.find(this.dragSources,function(e){return e.dragSource===t});e&&(this.removeListener(e),utils_1._.removeFromArray(this.dragSources,e))},e.prototype.setNoSelectToBody=function(e){var t=this.gridOptionsWrapper.getDocument().querySelector("body");utils_1._.exists(t)&&utils_1._.addOrRemoveCssClass(t,"ag-unselectable",e)},e.prototype.addDragSource=function(e,t){void 0===t&&(t=!1);var o=this.onMouseDown.bind(this,e);e.eElement.addEventListener("mousedown",o);var r=null,n=this.gridOptionsWrapper.isSuppressTouch();t&&!n&&(r=this.onTouchStart.bind(this,e),e.eElement.addEventListener("touchstart",r,{passive:!1})),this.dragSources.push({dragSource:e,mouseDownListener:o,touchStartListener:r,touchEnabled:t})},e.prototype.onTouchStart=function(e,t){var o=this;this.currentDragParams=e,this.dragging=!1;var r=t.touches[0];this.touchLastTime=r,this.touchStart=r,t.preventDefault(),e.eElement.addEventListener("touchmove",this.onTouchMoveListener,{passive:!0}),e.eElement.addEventListener("touchend",this.onTouchEndListener,{passive:!0}),e.eElement.addEventListener("touchcancel",this.onTouchEndListener,{passive:!0}),this.dragEndFunctions.push(function(){e.eElement.removeEventListener("touchmove",o.onTouchMoveListener,{passive:!0}),e.eElement.removeEventListener("touchend",o.onTouchEndListener,{passive:!0}),e.eElement.removeEventListener("touchcancel",o.onTouchEndListener,{passive:!0})}),0===e.dragStartPixels&&this.onCommonMove(r,this.touchStart)},e.prototype.onMouseDown=function(e,t){var o,r=this;e.skipMouseEvent&&e.skipMouseEvent(t)||t._alreadyProcessedByDragService||(t._alreadyProcessedByDragService=!0,0===t.button&&(this.currentDragParams=e,this.dragging=!1,this.mouseStartEvent=t,o=this.gridOptionsWrapper.getDocument(),this.setNoSelectToBody(!0),o.addEventListener("mousemove",this.onMouseMoveListener),o.addEventListener("mouseup",this.onMouseUpListener),this.dragEndFunctions.push(function(){o.removeEventListener("mousemove",r.onMouseMoveListener),o.removeEventListener("mouseup",r.onMouseUpListener)}),0===e.dragStartPixels&&this.onMouseMove(t)))},e.prototype.isEventNearStartEvent=function(e,t){var o=this.currentDragParams.dragStartPixels,o=utils_1._.exists(o)?o:4;return utils_1._.areEventsNear(e,t,o)},e.prototype.getFirstActiveTouch=function(e){for(var t=0;t<e.length;t++)if(e[t].identifier===this.touchStart.identifier)return e[t];return null},e.prototype.onCommonMove=function(e,t){if(!this.dragging){if(!this.dragging&&this.isEventNearStartEvent(e,t))return;this.dragging=!0;var o={type:events_1.Events.EVENT_DRAG_STARTED,api:this.gridApi,columnApi:this.columnApi};this.eventService.dispatchEvent(o),this.currentDragParams.onDragStart(t)}this.currentDragParams.onDragging(e)},e.prototype.onTouchMove=function(e){e=this.getFirstActiveTouch(e.touches);e&&this.onCommonMove(e,this.touchStart)},e.prototype.onMouseMove=function(e){this.onCommonMove(e,this.mouseStartEvent)},e.prototype.onTouchUp=function(e){e=(e=this.getFirstActiveTouch(e.changedTouches))||this.touchLastTime;this.onUpCommon(e)},e.prototype.onMouseUp=function(e){this.onUpCommon(e)},e.prototype.onUpCommon=function(e){this.dragging&&(this.dragging=!1,this.currentDragParams.onDragStop(e),e={type:events_1.Events.EVENT_DRAG_STOPPED,api:this.gridApi,columnApi:this.columnApi},this.eventService.dispatchEvent(e)),this.setNoSelectToBody(!1),this.mouseStartEvent=null,this.touchStart=null,this.touchLastTime=null,this.currentDragParams=null,this.dragEndFunctions.forEach(function(e){return e()}),this.dragEndFunctions.length=0},__decorate([context_1.Autowired("loggerFactory"),__metadata("design:type",logger_1.LoggerFactory)],e.prototype,"loggerFactory",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("columnApi"),__metadata("design:type",columnApi_1.ColumnApi)],e.prototype,"columnApi",void 0),__decorate([context_1.Autowired("gridApi"),__metadata("design:type",gridApi_1.GridApi)],e.prototype,"gridApi",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),__decorate([context_1.PreDestroy,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"destroy",null),__decorate([context_1.Bean("dragService")],e)}();exports.DragService=DragService;