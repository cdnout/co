"use strict";var __decorate=this&&this.__decorate||function(e,t,i,r){var o,n=arguments.length,l=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,i,r);else for(var s=e.length-1;0<=s;s--)(o=e[s])&&(l=(n<3?o(l):3<n?o(t,i,l):o(t,i))||l);return 3<n&&l&&Object.defineProperty(t,i,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),popupService_1=require("../widgets/popupService"),valueService_1=require("../valueService/valueService"),columnController_1=require("../columnController/columnController"),columnApi_1=require("../columnController/columnApi"),context_1=require("../context/context"),eventService_1=require("../eventService"),events_1=require("../events"),gridApi_1=require("../gridApi"),userComponentFactory_1=require("../components/framework/userComponentFactory"),FilterManager=function(){function e(){this.allFilters={},this.quickFilter=null,this.quickFilterParts=null,this.processingFilterChange=!1}var o=e;return e.prototype.registerGridCore=function(e){this.gridCore=e},e.prototype.init=function(){this.eventService.addEventListener(events_1.Events.EVENT_ROW_DATA_CHANGED,this.onNewRowsLoaded.bind(this)),this.eventService.addEventListener(events_1.Events.EVENT_NEW_COLUMNS_LOADED,this.onNewColumnsLoaded.bind(this)),this.quickFilter=this.parseQuickFilter(this.gridOptionsWrapper.getQuickFilterText()),this.setQuickFilterParts(),this.allowShowChangeAfterFilter=this.gridOptionsWrapper.isAllowShowChangeAfterFilter(),this.checkExternalFilter()},e.prototype.setQuickFilterParts=function(){this.quickFilter?this.quickFilterParts=this.quickFilter.split(" "):this.quickFilterParts=null},e.prototype.setFilterModel=function(i){var r,o=this,n=[];i?(r=Object.keys(i),utils_1._.iterateObject(this.allFilters,function(e,t){utils_1._.removeFromArray(r,e);e=i[e];o.setModelOnFilterWrapper(t.filterPromise,e),n.push(t.filterPromise)}),utils_1._.iterateArray(r,function(e){var t=o.columnController.getPrimaryColumn(e);t?(t=o.getOrCreateFilterWrapper(t,"NO_UI"),o.setModelOnFilterWrapper(t.filterPromise,i[e]),n.push(t.filterPromise)):console.warn("Warning ag-grid setFilterModel - no column found for colId "+e)})):utils_1._.iterateObject(this.allFilters,function(e,t){o.setModelOnFilterWrapper(t.filterPromise,null),n.push(t.filterPromise)}),utils_1.Promise.all(n).then(function(e){o.onFilterChanged()})},e.prototype.setModelOnFilterWrapper=function(e,t){e.then(function(e){"function"==typeof e.setModel?e.setModel(t):console.warn("Warning ag-grid - filter missing setModel method, which is needed for setFilterModel")})},e.prototype.getFilterModel=function(){var i={};return utils_1._.iterateObject(this.allFilters,function(e,t){t=t.filterPromise.resolveNow(null,function(e){return e});if(null==t)return null;"function"==typeof t.getModel?(t=t.getModel(),utils_1._.exists(t)&&(i[e]=t)):console.warn("Warning ag-grid - filter API missing getModel method, which is needed for getFilterModel")}),i},e.prototype.isAdvancedFilterPresent=function(){return this.advancedFilterPresent},e.prototype.setAdvancedFilterPresent=function(){var i=!1;utils_1._.iterateObject(this.allFilters,function(e,t){t.filterPromise.resolveNow(!1,function(e){return e.isFilterActive()})&&(i=!0)}),this.advancedFilterPresent=i},e.prototype.updateFilterFlagInColumns=function(r,o){utils_1._.iterateObject(this.allFilters,function(e,t){var i=t.filterPromise.resolveNow(!1,function(e){return e.isFilterActive()});t.column.setFilterActive(i,r,o)})},e.prototype.isAnyFilterPresent=function(){return this.isQuickFilterPresent()||this.advancedFilterPresent||this.externalFilterPresent},e.prototype.doesFilterPass=function(e,t){for(var i=e.data,r=Object.keys(this.allFilters),o=0,n=r.length;o<n;o++){var l=r[o],s=this.allFilters[l];if(void 0!==s){l=s.filterPromise.resolveNow(void 0,function(e){return e});if(void 0!==l&&l!==t&&l.isFilterActive()){l.doesFilterPass||console.error("Filter is missing method doesFilterPass");s={node:e,data:i};if(!l.doesFilterPass(s))return!1}}}return!0},e.prototype.parseQuickFilter=function(e){return utils_1._.missing(e)||""===e?null:this.gridOptionsWrapper.isRowModelDefault()?e.toUpperCase():(console.warn("ag-grid: quick filtering only works with the Client-side Row Model"),null)},e.prototype.setQuickFilter=function(e){e=this.parseQuickFilter(e);this.quickFilter!==e&&(this.quickFilter=e,this.setQuickFilterParts(),this.onFilterChanged())},e.prototype.checkExternalFilter=function(){this.externalFilterPresent=this.gridOptionsWrapper.isExternalFilterPresent()},e.prototype.onFilterChanged=function(e){this.setAdvancedFilterPresent(),this.updateFilterFlagInColumns("filterChanged",e),this.checkExternalFilter(),utils_1._.iterateObject(this.allFilters,function(e,t){t.filterPromise.then(function(e){e.onAnyFilterChanged&&e.onAnyFilterChanged()})});var t={type:events_1.Events.EVENT_FILTER_CHANGED,api:this.gridApi,columnApi:this.columnApi};e&&utils_1._.mergeDeep(t,e),this.processingFilterChange=!0,this.eventService.dispatchEvent(t),this.processingFilterChange=!1},e.prototype.isSuppressFlashingCellsBecauseFiltering=function(){return!this.allowShowChangeAfterFilter&&this.processingFilterChange},e.prototype.isQuickFilterPresent=function(){return null!==this.quickFilter},e.prototype.doesRowPassOtherFilters=function(e,t){return this.doesRowPassFilter(t,e)},e.prototype.doesRowPassQuickFilterNoCache=function(t,i){var r=this,e=this.columnController.getAllColumnsForQuickFilter(),o=!1;return e.forEach(function(e){o||(e=r.getQuickFilterTextForColumn(e,t),utils_1._.exists(e)&&0<=e.indexOf(i)&&(o=!0))}),o},e.prototype.doesRowPassQuickFilterCache=function(e,t){return e.quickFilterAggregateText||this.aggregateRowForQuickFilter(e),0<=e.quickFilterAggregateText.indexOf(t)},e.prototype.doesRowPassQuickFilter=function(t){var i=this,r=!0,o=this.gridOptionsWrapper.isCacheQuickFilter();return this.quickFilterParts.forEach(function(e){(o?i.doesRowPassQuickFilterCache(t,e):i.doesRowPassQuickFilterNoCache(t,e))||(r=!1)}),r},e.prototype.doesRowPassFilter=function(e,t){return!(this.isQuickFilterPresent()&&!this.doesRowPassQuickFilter(e))&&(!(this.externalFilterPresent&&!this.gridOptionsWrapper.doesExternalFilterPass(e))&&!(this.advancedFilterPresent&&!this.doesFilterPass(e,t)))},e.prototype.getQuickFilterTextForColumn=function(e,t){var i=this.valueService.getValue(e,t,!0),r=e.getColDef();return i=e.getColDef().getQuickFilterText?(r={value:i,node:t,data:t.data,column:e,colDef:r,context:this.gridOptionsWrapper.getContext()},e.getColDef().getQuickFilterText(r)):i,utils_1._.exists(i)?i.toString().toUpperCase():null},e.prototype.aggregateRowForQuickFilter=function(t){var i=this,r=[];this.columnController.getAllColumnsForQuickFilter().forEach(function(e){e=i.getQuickFilterTextForColumn(e,t);utils_1._.exists(e)&&r.push(e)}),t.quickFilterAggregateText=r.join(o.QUICK_FILTER_SEPARATOR)},e.prototype.onNewRowsLoaded=function(e){utils_1._.iterateObject(this.allFilters,function(e,t){t.filterPromise.then(function(e){e.onNewRowsLoaded&&e.onNewRowsLoaded()})}),this.updateFilterFlagInColumns(e),this.setAdvancedFilterPresent()},e.prototype.createValueGetter=function(t){var i=this;return function(e){return i.valueService.getValue(t,e,!0)}},e.prototype.getFilterComponent=function(e,t){return this.getOrCreateFilterWrapper(e,t).filterPromise},e.prototype.isFilterActive=function(e){e=this.cachedFilter(e);return!!e&&e.filterPromise.resolveNow(!1,function(e){return e.isFilterActive()})},e.prototype.getOrCreateFilterWrapper=function(e,t){var i=this.cachedFilter(e);return i?"NO_UI"!==t&&this.putIntoGui(i,t):(i=this.createFilterWrapper(e,t),this.allFilters[e.getColId()]=i),i},e.prototype.cachedFilter=function(e){return this.allFilters[e.getColId()]},e.prototype.createFilterInstance=function(t,e){var i=this,r="agTextColumnFilter";this.gridOptionsWrapper.isEnterprise()&&(r="agSetColumnFilter");var o,n=utils_1._.cloneObject(t.getColDef()),e=this.createFilterParams(t,n,e);e.filterChangedCallback=this.onFilterChanged.bind(this),e.filterModifiedCallback=function(){var e={type:events_1.Events.EVENT_FILTER_MODIFIED,api:i.gridApi,columnApi:i.columnApi,column:t,filterInstance:o};i.eventService.dispatchEvent(e)};r=this.userComponentFactory.newFilterComponent(n,e,r,function(e,t){return utils_1._.assign(e,{doesRowPassOtherFilter:i.doesRowPassOtherFilters.bind(i,t)})});return r.then(function(e){return o=e}),r},e.prototype.createFilterParams=function(e,t,i){void 0===i&&(i=null);e={api:this.gridOptionsWrapper.getApi(),column:e,colDef:t,rowModel:this.rowModel,filterChangedCallback:null,filterModifiedCallback:null,valueGetter:this.createValueGetter(e),context:this.gridOptionsWrapper.getContext(),doesRowPassOtherFilter:null};return i&&(e.$scope=i),e},e.prototype.createFilterWrapper=function(e,t){var i={column:e,filterPromise:null,scope:null,compiledElement:null,guiPromise:utils_1.Promise.external()};return i.scope=this.gridOptionsWrapper.isAngularCompileFilters()?this.$scope.$new():null,i.filterPromise=this.createFilterInstance(e,i.scope),this.putIntoGui(i,t),i},e.prototype.putIntoGui=function(t,i){var r=this,o=document.createElement("div");o.className="ag-filter",t.filterPromise.then(function(e){e=e.getGui();utils_1._.missing(e)&&console.warn("getGui method from filter returned "+e+", it should be a DOM element or an HTML template string."),"string"==typeof e&&(e=utils_1._.loadTemplate(e)),o.appendChild(e),t.scope&&(e=r.$compile(o)(t.scope),t.compiledElement=e,window.setTimeout(function(){return t.scope.$apply()},0)),t.guiPromise.resolve(o),r.eventService.dispatchEvent({type:events_1.Events.EVENT_FILTER_OPENED,column:t.column,source:i,eGui:o,api:r.gridApi,columnApi:r.columnApi})})},e.prototype.onNewColumnsLoaded=function(){var i=this,r=!1;utils_1._.iterateObject(this.allFilters,function(e,t){i.columnController.getPrimaryColumn(t.column)||(r=!0,i.disposeFilterWrapper(t,"filterDestroyed"))}),r&&this.onFilterChanged()},e.prototype.destroyFilter=function(e,t){void 0===t&&(t="api");e=this.allFilters[e.getColId()];e&&(this.disposeFilterWrapper(e,t),this.onFilterChanged())},e.prototype.disposeFilterWrapper=function(t,i){var r=this;t.filterPromise.then(function(e){e.setModel(null),e.destroy&&e.destroy(),t.column.setFilterActive(!1,i),t.scope&&(t.compiledElement&&t.compiledElement.remove(),t.scope.$destroy()),delete r.allFilters[t.column.getColId()]})},e.prototype.destroy=function(){var i=this;utils_1._.iterateObject(this.allFilters,function(e,t){i.disposeFilterWrapper(t,"filterDestroyed")})},e.QUICK_FILTER_SEPARATOR="\n",__decorate([context_1.Autowired("$compile"),__metadata("design:type",Object)],e.prototype,"$compile",void 0),__decorate([context_1.Autowired("$scope"),__metadata("design:type",Object)],e.prototype,"$scope",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("popupService"),__metadata("design:type",popupService_1.PopupService)],e.prototype,"popupService",void 0),__decorate([context_1.Autowired("valueService"),__metadata("design:type",valueService_1.ValueService)],e.prototype,"valueService",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("rowModel"),__metadata("design:type",Object)],e.prototype,"rowModel",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Autowired("enterprise"),__metadata("design:type",Boolean)],e.prototype,"enterprise",void 0),__decorate([context_1.Autowired("context"),__metadata("design:type",context_1.Context)],e.prototype,"context",void 0),__decorate([context_1.Autowired("columnApi"),__metadata("design:type",columnApi_1.ColumnApi)],e.prototype,"columnApi",void 0),__decorate([context_1.Autowired("gridApi"),__metadata("design:type",gridApi_1.GridApi)],e.prototype,"gridApi",void 0),__decorate([context_1.Autowired("userComponentFactory"),__metadata("design:type",userComponentFactory_1.UserComponentFactory)],e.prototype,"userComponentFactory",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),__decorate([context_1.PreDestroy,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"destroy",null),o=__decorate([context_1.Bean("filterManager")],e)}();exports.FilterManager=FilterManager;