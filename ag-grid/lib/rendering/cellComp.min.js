"use strict";var __extends=this&&this.__extends||function(){var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};Object.defineProperty(exports,"__esModule",{value:!0});var column_1=require("../entities/column"),constants_1=require("../constants"),events_1=require("../events"),component_1=require("../widgets/component"),checkboxSelectionComponent_1=require("./checkboxSelectionComponent"),iRangeController_1=require("../interfaces/iRangeController"),rowDragComp_1=require("./rowDragComp"),popupEditorWrapper_1=require("./cellEditors/popupEditorWrapper"),utils_1=require("../utils"),dndSourceComp_1=require("./dndSourceComp"),CellComp=function(a){function l(e,t,i,s,n,o,r){var l=a.call(this)||this;return l.editingCell=!1,l.suppressRefreshCell=!1,l.scope=null,l.cellEditorVersion=0,l.cellRendererVersion=0,l.scope=e,l.beans=t,l.column=i,l.rowNode=s,l.rowComp=n,l.autoHeightCell=o,l.printLayout=r,l.createGridCellVo(),l.rangeSelectionEnabled=t.gridOptionsWrapper.isEnableRangeSelection(),l.cellFocused=l.beans.focusedCellController.isCellFocused(l.cellPosition),l.firstRightPinned=l.column.isFirstRightPinned(),l.lastLeftPinned=l.column.isLastLeftPinned(),l.rangeSelectionEnabled&&(t=l.beans.rangeController,l.rangeCount=t.getCellRangeCount(l.cellPosition),l.rangeCount&&(l.hasChartRange=t.getCellRanges().every(function(e){return utils_1._.exists(e.type)}))),l.getValueAndFormat(),l.setUsingWrapper(),l.chooseCellRenderer(),l.setupColSpan(),l.rowSpan=l.column.getRowSpan(l.rowNode),l}return __extends(l,a),l.prototype.getCreateTemplate=function(){var e=this.beans.gridOptionsWrapper.isEnableCellTextSelection()?"":'unselectable="on"',t=[],i=this.column,s=this.getCellWidth(),n=this.modifyLeftForPrintLayout(this.getCellLeft()),o=this.getInitialValueToRender(),r=utils_1._.get(this.column,"colDef.template",null)?o:utils_1._.escape(o);this.tooltip=this.getToolTip();var l=utils_1._.escape(this.tooltip),a=utils_1._.escape(i.getId()),p="",h="",u=this.preProcessStylesFromColDef(),o=this.getInitialCssClasses(),i=this.getStylesForRowSpanning();return this.usingWrapper&&(p='<div ref="eCellWrapper" class="ag-cell-wrapper"><span ref="eCellValue" class="ag-cell-value" '+e+">",h="</span></div>"),t.push("<div"),t.push(' tabindex="-1"'),t.push(" "+e),t.push(' role="gridcell"'),t.push(' comp-id="'+this.getCompId()+'" '),t.push(' col-id="'+a+'"'),t.push(' class="'+o.join(" ")+'"'),this.beans.gridOptionsWrapper.isEnableBrowserTooltips()&&utils_1._.exists(l)&&t.push('title="'+l+'"'),t.push(' style="width: '+s+"px; left: "+n+"px; "+u+" "+i+'" >'),t.push(p),utils_1._.exists(r,!0)&&t.push(r),t.push(h),t.push("</div>"),t.join("")},l.prototype.getStylesForRowSpanning=function(){return 1===this.rowSpan?"":"height: "+this.beans.gridOptionsWrapper.getRowHeightAsNumber()*this.rowSpan+"px; z-index: 1;"},l.prototype.afterAttached=function(){var e='[comp-id="'+this.getCompId()+'"]',e=this.eParentRow.querySelector(e);this.setGui(e),this.addDomData(),this.populateTemplate(),this.createCellRendererInstance(!0),this.angular1Compile(),this.rangeSelectionEnabled&&this.shouldHaveSelectionHandle()&&this.addSelectionHandle(),utils_1._.exists(this.tooltip)&&!this.beans.gridOptionsWrapper.isEnableBrowserTooltips()&&this.beans.tooltipManager.registerTooltip(this)},l.prototype.onColumnHover=function(){var e=this.beans.columnHoverService.isHovered(this.column);utils_1._.addOrRemoveCssClass(this.getGui(),"ag-column-hover",e)},l.prototype.onCellChanged=function(e){e.column===this.column&&this.refreshCell({})},l.prototype.getCellLeft=function(){var e=this.beans.gridOptionsWrapper.isEnableRtl()&&this.colsSpanning?utils_1._.last(this.colsSpanning):this.column;return e.getLeft()},l.prototype.getCellWidth=function(){if(!this.colsSpanning)return this.column.getActualWidth();var t=0;return this.colsSpanning.forEach(function(e){return t+=e.getActualWidth()}),t},l.prototype.onFlashCells=function(e){var t=this.beans.cellPositionUtils.createId(this.cellPosition);e.cells[t]&&this.animateCell("highlight")},l.prototype.setupColSpan=function(){utils_1._.missing(this.getComponentHolder().colSpan)||(this.addDestroyableEventListener(this.beans.eventService,events_1.Events.EVENT_DISPLAYED_COLUMNS_CHANGED,this.onDisplayColumnsChanged.bind(this)),this.addDestroyableEventListener(this.beans.eventService,events_1.Events.EVENT_DISPLAYED_COLUMNS_WIDTH_CHANGED,this.onWidthChanged.bind(this)),this.colsSpanning=this.getColSpanningList())},l.prototype.getColSpanningList=function(){var e=this.column.getColSpan(this.rowNode),t=[];if(1===e)t.push(this.column);else for(var i=this.column,s=this.column.getPinned(),n=0;i&&n<e&&(t.push(i),(i=this.beans.columnController.getDisplayedColAfter(i))&&!utils_1._.missing(i))&&s===i.getPinned();n++);return t},l.prototype.onDisplayColumnsChanged=function(){var e=this.getColSpanningList();utils_1._.compareArrays(this.colsSpanning,e)||(this.colsSpanning=e,this.onWidthChanged(),this.onLeftChanged())},l.prototype.getInitialCssClasses=function(){var e=["ag-cell","ag-cell-not-inline-editing"];return this.autoHeightCell||e.push("ag-cell-with-height"),!this.beans.gridOptionsWrapper.isSuppressCellSelection()&&this.cellFocused&&e.push("ag-cell-focus"),this.firstRightPinned&&e.push("ag-cell-first-right-pinned"),this.lastLeftPinned&&e.push("ag-cell-last-left-pinned"),this.beans.columnHoverService.isHovered(this.column)&&e.push("ag-column-hover"),utils_1._.pushAll(e,this.preProcessClassesFromColDef()),utils_1._.pushAll(e,this.preProcessCellClassRules()),utils_1._.pushAll(e,this.getInitialRangeClasses()),this.usingWrapper||e.push("ag-cell-value"),e},l.prototype.getInitialValueToRender=function(){if(this.usingCellRenderer)return"string"==typeof this.cellRendererGui?this.cellRendererGui:"";var e=this.getComponentHolder();if(e.template)return e.template;if(e.templateUrl){e=this.beans.templateService.getTemplate(e.templateUrl,this.refreshCell.bind(this,!0));return e||""}return this.getValueToUse()},l.prototype.getRenderedRow=function(){return this.rowComp},l.prototype.isSuppressNavigable=function(){return this.column.isSuppressNavigable(this.rowNode)},l.prototype.getCellRenderer=function(){return this.cellRenderer},l.prototype.getCellEditor=function(){return this.cellEditor},l.prototype.refreshCell=function(e){var t,i,s,n;this.suppressRefreshCell||this.editingCell||(t=this.getComponentHolder(),n=e&&e.newData,i=e&&e.suppressFlash||t.suppressCellFlash,s=e&&e.forceRefresh,e=this.value,this.getValueAndFormat(),e=!this.valuesAreEqual(e,this.value),(s||e)&&(!n&&this.attemptCellRendererRefresh()||this.replaceContentsAfterRefresh(),n=this.beans.filterManager.isSuppressFlashingCellsBecauseFiltering(),i||n||!this.beans.gridOptionsWrapper.isEnableCellChangeFlash()&&!t.enableCellChangeFlash||this.flashCell(),this.postProcessStylesFromColDef(),this.postProcessClassesFromColDef()),this.updateAngular1ScopeAndCompile(),this.refreshToolTip(),this.postProcessCellClassRules())},l.prototype.flashCell=function(){this.animateCell("data-changed")},l.prototype.animateCell=function(e){var t="ag-cell-"+e,i="ag-cell-"+e+"-animation",s=this.getGui();utils_1._.addCssClass(s,t),utils_1._.removeCssClass(s,i),window.setTimeout(function(){utils_1._.removeCssClass(s,t),utils_1._.addCssClass(s,i),window.setTimeout(function(){utils_1._.removeCssClass(s,i)},1e3)},500)},l.prototype.replaceContentsAfterRefresh=function(){utils_1._.clearElement(this.eParentOfValue),this.cellRenderer&&this.cellRenderer.destroy&&this.cellRenderer.destroy(),this.cellRenderer=null,this.cellRendererGui=null,this.putDataIntoCellAfterRefresh(),this.updateAngular1ScopeAndCompile()},l.prototype.updateAngular1ScopeAndCompile=function(){this.beans.gridOptionsWrapper.isAngularCompileRows()&&this.scope&&(this.scope.data=__assign({},this.rowNode.data),this.angular1Compile())},l.prototype.angular1Compile=function(){var e,t;this.beans.gridOptionsWrapper.isAngularCompileRows()&&((e=this.getGui()).classList.contains("ng-scope")&&0!==e.childElementCount||(t=this.beans.$compile(e)(this.scope),this.addDestroyFunc(function(){t.remove()})))},l.prototype.postProcessStylesFromColDef=function(){var e=this.processStylesFromColDef();e&&utils_1._.addStylesToElement(this.getGui(),e)},l.prototype.preProcessStylesFromColDef=function(){var e=this.processStylesFromColDef();return utils_1._.cssStyleObjectToMarkup(e)},l.prototype.processStylesFromColDef=function(){var e=this.getComponentHolder();if(e.cellStyle){var t;return"function"==typeof e.cellStyle?(t={value:this.value,data:this.rowNode.data,node:this.rowNode,colDef:e,column:this.column,$scope:this.scope,context:this.beans.gridOptionsWrapper.getContext(),api:this.beans.gridOptionsWrapper.getApi()},(0,e.cellStyle)(t)):e.cellStyle}},l.prototype.postProcessClassesFromColDef=function(){var t=this;this.processClassesFromColDef(function(e){return utils_1._.addCssClass(t.getGui(),e)})},l.prototype.preProcessClassesFromColDef=function(){var t=[];return this.processClassesFromColDef(function(e){return t.push(e)}),t},l.prototype.processClassesFromColDef=function(e){var t=this.getComponentHolder();this.beans.stylingService.processStaticCellClasses(t,{value:this.value,data:this.rowNode.data,node:this.rowNode,colDef:t,rowIndex:this.rowNode.rowIndex,$scope:this.scope,api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),context:this.beans.gridOptionsWrapper.getContext()},e)},l.prototype.putDataIntoCellAfterRefresh=function(){var e,t=this.getComponentHolder();t.template?this.eParentOfValue.innerHTML=t.template:t.templateUrl?(e=this.beans.templateService.getTemplate(t.templateUrl,this.refreshCell.bind(this,!0)))&&(this.eParentOfValue.innerHTML=e):(this.chooseCellRenderer(),this.usingCellRenderer?this.createCellRendererInstance():null!=(e=this.getValueToUse())&&(this.eParentOfValue.innerHTML=utils_1._.escape(e)))},l.prototype.attemptCellRendererRefresh=function(){if(utils_1._.missing(this.cellRenderer)||!this.cellRenderer||utils_1._.missing(this.cellRenderer.refresh))return!1;var e=this.createCellRendererParams(),e=this.beans.userComponentFactory.createFinalParams(this.getComponentHolder(),this.cellRendererType,e),e=this.cellRenderer.refresh(e);return!0===e||void 0===e},l.prototype.refreshToolTip=function(){var e,t,i=this.getToolTip();this.tooltip!==i&&(e=utils_1._.exists(i),t=utils_1._.exists(this.tooltip),e&&this.tooltip===i.toString()||(this.tooltip=i,this.beans.gridOptionsWrapper.isEnableBrowserTooltips()?e?(i=utils_1._.escape(this.tooltip),this.eParentOfValue.setAttribute("title",i)):this.eParentOfValue.removeAttribute("title"):t?e||this.beans.tooltipManager.unregisterTooltip(this):e&&this.beans.tooltipManager.registerTooltip(this)))},l.prototype.valuesAreEqual=function(e,t){var i=this.getComponentHolder(),i=i?i.equals:null;return i?i(e,t):e===t},l.prototype.getToolTip=function(){var e=this.getComponentHolder(),t=this.rowNode.data;if(e.tooltipField&&utils_1._.exists(t))return utils_1._.getValueUsingField(t,e.tooltipField,this.column.isTooltipFieldContainsDots());t=e.tooltipValueGetter||e.tooltip;return t?t({api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),colDef:e,column:this.getColumn(),context:this.beans.gridOptionsWrapper.getContext(),value:this.value,valueFormatted:this.valueFormatted,rowIndex:this.cellPosition.rowIndex,node:this.rowNode,data:this.rowNode.data,$scope:this.scope}):null},l.prototype.getTooltipText=function(e){return void 0===e&&(e=!0),e?utils_1._.escape(this.tooltip):this.tooltip},l.prototype.processCellClassRules=function(e,t){var i=this.getComponentHolder();this.beans.stylingService.processClassRules(i.cellClassRules,{value:this.value,data:this.rowNode.data,node:this.rowNode,colDef:i,rowIndex:this.cellPosition.rowIndex,api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),$scope:this.scope,context:this.beans.gridOptionsWrapper.getContext()},e,t)},l.prototype.postProcessCellClassRules=function(){var t=this;this.processCellClassRules(function(e){utils_1._.addCssClass(t.getGui(),e)},function(e){utils_1._.removeCssClass(t.getGui(),e)})},l.prototype.preProcessCellClassRules=function(){var t=[];return this.processCellClassRules(function(e){t.push(e)},function(e){}),t},l.prototype.setUsingWrapper=function(){var e=this.getComponentHolder();if(this.rowNode.rowPinned)return this.usingWrapper=!1,this.includeSelectionComponent=!1,this.includeRowDraggingComponent=!1,void(this.includeDndSourceComponent=!1);var t="function"==typeof e.checkboxSelection,i="function"==typeof e.rowDrag,s="function"==typeof e.dndSource;this.includeSelectionComponent=t||!0===e.checkboxSelection,this.includeRowDraggingComponent=i||!0===e.rowDrag,this.includeDndSourceComponent=s||!0===e.dndSource,this.usingWrapper=this.includeRowDraggingComponent||this.includeSelectionComponent||this.includeDndSourceComponent},l.prototype.chooseCellRenderer=function(){var e,t,i=this.getComponentHolder();i.template||i.templateUrl?this.usingCellRenderer=!1:(e=this.createCellRendererParams(),t=this.beans.userComponentFactory.lookupComponentClassDef(i,"cellRenderer",e),this.beans.userComponentFactory.lookupComponentClassDef(i,"pinnedRowCellRenderer",e)&&this.rowNode.rowPinned?(this.cellRendererType=l.CELL_RENDERER_TYPE_PINNED,this.usingCellRenderer=!0):t?(this.cellRendererType=l.CELL_RENDERER_TYPE_NORMAL,this.usingCellRenderer=!0):this.usingCellRenderer=!1)},l.prototype.createCellRendererInstance=function(e){var t,i,s,n,o,r=this;void 0===e&&(e=!1),this.usingCellRenderer&&(t=this.beans.gridOptionsWrapper.isAngularCompileRows(),o=this.beans.gridOptionsWrapper.isSuppressAnimationFrame(),(t||o||this.autoHeightCell)&&(e=!1),i=this.createCellRendererParams(),this.cellRendererVersion++,s=this.afterCellRendererCreated.bind(this,this.cellRendererVersion),n=this.cellRendererType===l.CELL_RENDERER_TYPE_NORMAL,o=function(){var e=n?r.beans.userComponentFactory.newCellRenderer(r.getComponentHolder(),i):r.beans.userComponentFactory.newPinnedRowCellRenderer(r.getComponentHolder(),i);e&&e.then(s)},e?this.beans.taskQueue.addP2Task(o):o())},l.prototype.afterCellRendererCreated=function(e,t){this.isAlive()&&e===this.cellRendererVersion?(this.cellRenderer=t,this.cellRendererGui=this.cellRenderer.getGui(),utils_1._.missing(this.cellRendererGui)||this.editingCell||this.eParentOfValue.appendChild(this.cellRendererGui)):t.destroy&&t.destroy()},l.prototype.createCellRendererParams=function(){var i=this;return{value:this.value,valueFormatted:this.valueFormatted,getValue:this.getValue.bind(this),setValue:function(e){i.beans.valueService.setValue(i.rowNode,i.column,e)},formatValue:this.formatValue.bind(this),data:this.rowNode.data,node:this.rowNode,colDef:this.getComponentHolder(),column:this.column,$scope:this.scope,rowIndex:this.cellPosition.rowIndex,api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),context:this.beans.gridOptionsWrapper.getContext(),refreshCell:this.refreshCell.bind(this),eGridCell:this.getGui(),eParentOfValue:this.eParentOfValue,addRowCompListener:this.rowComp?this.rowComp.addEventListener.bind(this.rowComp):null,addRenderedRowListener:function(e,t){console.warn("ag-Grid: since ag-Grid .v11, params.addRenderedRowListener() is now params.addRowCompListener()"),i.rowComp&&i.rowComp.addEventListener(e,t)}}},l.prototype.formatValue=function(e){var t=this.beans.valueFormatterService.formatValue(this.column,this.rowNode,this.scope,e);return null!=t?t:e},l.prototype.getValueToUse=function(){return null!==this.valueFormatted&&void 0!==this.valueFormatted?this.valueFormatted:this.value},l.prototype.getValueAndFormat=function(){this.value=this.getValue(),this.valueFormatted=this.beans.valueFormatterService.formatValue(this.column,this.rowNode,this.scope,this.value)},l.prototype.getValue=function(){var e=this.rowNode.leafGroup&&this.beans.columnController.isPivotMode(),t=this.rowNode.group&&this.rowNode.expanded&&!this.rowNode.footer&&!e,i=this.beans.gridOptionsWrapper.isGroupIncludeFooter(),e=this.beans.gridOptionsWrapper.isGroupSuppressBlankHeader(),e=t&&i&&!e;return this.beans.valueService.getValue(this.column,this.rowNode,!1,e)},l.prototype.onMouseEvent=function(e,t){if(!utils_1._.isStopPropagationForAgGrid(t))switch(e){case"click":this.onCellClicked(t);break;case"mousedown":this.onMouseDown(t);break;case"dblclick":this.onCellDoubleClicked(t);break;case"mouseout":this.onMouseOut(t);break;case"mouseover":this.onMouseOver(t)}},l.prototype.dispatchCellContextMenuEvent=function(e){var t=this.getComponentHolder(),i=this.createEvent(e,events_1.Events.EVENT_CELL_CONTEXT_MENU);this.beans.eventService.dispatchEvent(i),t.onCellContextMenu&&window.setTimeout(function(){return t.onCellContextMenu(i)},0)},l.prototype.createEvent=function(e,t){t={node:this.rowNode,data:this.rowNode.data,value:this.value,column:this.column,colDef:this.getComponentHolder(),context:this.beans.gridOptionsWrapper.getContext(),api:this.beans.gridApi,columnApi:this.beans.columnApi,rowPinned:this.rowNode.rowPinned,event:e,type:t,rowIndex:this.rowNode.rowIndex};return this.scope&&(t.$scope=this.scope),t},l.prototype.onMouseOut=function(e){e=this.createEvent(e,events_1.Events.EVENT_CELL_MOUSE_OUT);this.beans.eventService.dispatchEvent(e),this.beans.columnHoverService.clearMouseOver()},l.prototype.onMouseOver=function(e){e=this.createEvent(e,events_1.Events.EVENT_CELL_MOUSE_OVER);this.beans.eventService.dispatchEvent(e),this.beans.columnHoverService.setMouseOver([this.column])},l.prototype.onCellDoubleClicked=function(e){var t=this.getComponentHolder(),i=this.createEvent(e,events_1.Events.EVENT_CELL_DOUBLE_CLICKED);this.beans.eventService.dispatchEvent(i),"function"==typeof t.onCellDoubleClicked&&window.setTimeout(function(){return t.onCellDoubleClicked(i)},0),this.beans.gridOptionsWrapper.isSingleClickEdit()||this.beans.gridOptionsWrapper.isSuppressClickEdit()||this.startRowOrCellEdit()},l.prototype.startRowOrCellEdit=function(e,t){this.beans.gridOptionsWrapper.isFullRowEdit()?this.rowComp.startRowEditing(e,t,this):this.startEditingIfEnabled(e,t,!0)},l.prototype.isCellEditable=function(){return this.column.isCellEditable(this.rowNode)},l.prototype.startEditingIfEnabled=function(e,t,i){var s;void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=!1),this.isCellEditable()&&(this.editingCell||(this.editingCell=!0,this.cellEditorVersion++,s=this.afterCellEditorCreated.bind(this,this.cellEditorVersion),t=this.createCellEditorParams(e,t,i),this.createCellEditor(t).then(s),utils_1._.missing(this.cellEditor)&&i&&this.focusCell(!0)))},l.prototype.createCellEditor=function(t){var i=this;return this.beans.userComponentFactory.newCellEditor(this.column.getColDef(),t).map(function(e){if(!(e.isPopup&&e.isPopup()))return e;i.beans.gridOptionsWrapper.isFullRowEdit()&&console.warn("ag-Grid: popup cellEditor does not work with fullRowEdit - you cannot use them both - either turn off fullRowEdit, or stop using popup editors.");e=new popupEditorWrapper_1.PopupEditorWrapper(e);return i.beans.context.wireBean(e),e.init(t),e})},l.prototype.afterCellEditorCreated=function(e,t){if(!(e!==this.cellEditorVersion)&&this.editingCell){if(t.isCancelBeforeStart&&t.isCancelBeforeStart())return t.destroy&&t.destroy(),void(this.editingCell=!1);if(!t.getGui)return console.warn("ag-Grid: cellEditor for column "+this.column.getId()+" is missing getGui() method"),t.render&&console.warn("ag-Grid: we found 'render' on the component, are you trying to set a React renderer but added it as colDef.cellEditor instead of colDef.cellEditorFmk?"),t.destroy&&t.destroy(),void(this.editingCell=!1);this.cellEditor=t,this.cellEditorInPopup=void 0!==t.isPopup&&t.isPopup(),this.setInlineEditingClass(),this.cellEditorInPopup?this.addPopupCellEditor():this.addInCellEditor(),t.afterGuiAttached&&t.afterGuiAttached();e=this.createEvent(null,events_1.Events.EVENT_CELL_EDITING_STARTED);this.beans.eventService.dispatchEvent(e)}else t.destroy&&t.destroy()},l.prototype.addInCellEditor=function(){utils_1._.clearElement(this.getGui()),this.cellEditor&&this.getGui().appendChild(this.cellEditor.getGui()),this.angular1Compile()},l.prototype.addPopupCellEditor=function(){var e=this,t=this.cellEditor?this.cellEditor.getGui():null;this.hideEditorPopup=this.beans.popupService.addAsModalPopup(t,!0,function(){e.onPopupEditorClosed()}),this.beans.popupService.positionPopupOverComponent({column:this.column,rowNode:this.rowNode,type:"popupCellEditor",eventSource:this.getGui(),ePopup:t,keepWithinBounds:!0}),this.angular1Compile()},l.prototype.onPopupEditorClosed=function(){this.editingCell&&(this.stopRowOrCellEdit(),this.beans.focusedCellController.isCellFocused(this.cellPosition)&&this.focusCell(!0))},l.prototype.setInlineEditingClass=function(){var e=this.editingCell&&!this.cellEditorInPopup,t=this.editingCell&&this.cellEditorInPopup;utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-inline-editing",e),utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-not-inline-editing",!e),utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-popup-editing",t),utils_1._.addOrRemoveCssClass(this.getGui().parentNode,"ag-row-inline-editing",e),utils_1._.addOrRemoveCssClass(this.getGui().parentNode,"ag-row-not-inline-editing",!e)},l.prototype.createCellEditorParams=function(e,t,i){return{value:this.getValue(),keyPress:e,charPress:t,column:this.column,colDef:this.column.getColDef(),rowIndex:this.cellPosition.rowIndex,node:this.rowNode,data:this.rowNode.data,api:this.beans.gridOptionsWrapper.getApi(),cellStartedEdit:i,columnApi:this.beans.gridOptionsWrapper.getColumnApi(),context:this.beans.gridOptionsWrapper.getContext(),$scope:this.scope,onKeyDown:this.onKeyDown.bind(this),stopEditing:this.stopEditingAndFocus.bind(this),eGridCell:this.getGui(),parseValue:this.parseValue.bind(this),formatValue:this.formatValue.bind(this)}},l.prototype.stopEditingAndFocus=function(e){void 0===e&&(e=!1),this.stopRowOrCellEdit(),this.focusCell(!0),e||this.navigateAfterEdit()},l.prototype.parseValue=function(e){var t=this.getComponentHolder(),i={node:this.rowNode,data:this.rowNode.data,oldValue:this.value,newValue:e,colDef:t,column:this.column,api:this.beans.gridOptionsWrapper.getApi(),columnApi:this.beans.gridOptionsWrapper.getColumnApi(),context:this.beans.gridOptionsWrapper.getContext()},t=t.valueParser;return utils_1._.exists(t)?this.beans.expressionService.evaluate(t,i):e},l.prototype.focusCell=function(e){void 0===e&&(e=!1),this.beans.focusedCellController.setFocusedCell(this.cellPosition.rowIndex,this.column,this.rowNode.rowPinned,e)},l.prototype.setFocusInOnEditor=function(){this.editingCell&&(this.cellEditor&&this.cellEditor.focusIn?this.cellEditor.focusIn():this.focusCell(!0))},l.prototype.isEditing=function(){return this.editingCell},l.prototype.onKeyDown=function(e){var t=e.which||e.keyCode;switch(t){case constants_1.Constants.KEY_ENTER:this.onEnterKeyDown();break;case constants_1.Constants.KEY_F2:this.onF2KeyDown();break;case constants_1.Constants.KEY_ESCAPE:this.onEscapeKeyDown();break;case constants_1.Constants.KEY_TAB:this.onTabKeyDown(e);break;case constants_1.Constants.KEY_BACKSPACE:case constants_1.Constants.KEY_DELETE:this.onBackspaceOrDeleteKeyPressed(t);break;case constants_1.Constants.KEY_DOWN:case constants_1.Constants.KEY_UP:case constants_1.Constants.KEY_RIGHT:case constants_1.Constants.KEY_LEFT:this.onNavigationKeyPressed(e,t)}},l.prototype.setFocusOutOnEditor=function(){this.editingCell&&this.cellEditor&&this.cellEditor.focusOut&&this.cellEditor.focusOut()},l.prototype.onNavigationKeyPressed=function(e,t){this.editingCell||(e.shiftKey&&this.rangeSelectionEnabled?this.onShiftRangeSelect(t):this.beans.rowRenderer.navigateToNextCell(e,t,this.cellPosition,!0),e.preventDefault())},l.prototype.onShiftRangeSelect=function(e){e=this.beans.rangeController.extendLatestRangeInDirection(e);e&&this.beans.rowRenderer.ensureCellVisible(e)},l.prototype.onTabKeyDown=function(e){this.beans.rowRenderer.onTabKeyDown(this,e)},l.prototype.onBackspaceOrDeleteKeyPressed=function(e){this.editingCell||this.startRowOrCellEdit(e)},l.prototype.onEnterKeyDown=function(){this.editingCell||this.rowComp.isEditing()?this.stopEditingAndFocus():this.beans.gridOptionsWrapper.isEnterMovesDown()?this.beans.rowRenderer.navigateToNextCell(null,constants_1.Constants.KEY_DOWN,this.cellPosition,!1):this.startRowOrCellEdit(constants_1.Constants.KEY_ENTER)},l.prototype.navigateAfterEdit=function(){this.beans.gridOptionsWrapper.isFullRowEdit()||this.beans.gridOptionsWrapper.isEnterMovesDownAfterEdit()&&this.beans.rowRenderer.navigateToNextCell(null,constants_1.Constants.KEY_DOWN,this.cellPosition,!1)},l.prototype.onF2KeyDown=function(){this.editingCell||this.startRowOrCellEdit(constants_1.Constants.KEY_F2)},l.prototype.onEscapeKeyDown=function(){this.editingCell&&(this.stopRowOrCellEdit(!0),this.focusCell(!0))},l.prototype.onKeyPress=function(e){var t;utils_1._.getTarget(e)!==this.getGui()||this.editingCell||(" "===(t=String.fromCharCode(e.charCode))?this.onSpaceKeyPressed(e):utils_1._.isEventFromPrintableCharacter(e)&&(this.startRowOrCellEdit(null,t),e.preventDefault()))},l.prototype.onSpaceKeyPressed=function(e){var t;!this.editingCell&&this.beans.gridOptionsWrapper.isRowSelection()&&(t=this.rowNode.isSelected(),this.rowNode.setSelected(!t)),e.preventDefault()},l.prototype.onMouseDown=function(e){var t=!1,i=e.button,s=e.ctrlKey,n=e.metaKey,o=e.shiftKey,r=e.target,l=this.beans,a=l.eventService,l=l.rangeController;if(l&&(l.isCellInAnyRange(this.getCellPosition())&&2===i))return;utils_1._.isBrowserIE()&&r.classList.contains("ag-cell")&&(t=!0),!o||l&&!l.getCellRanges().length?this.focusCell(t):e.preventDefault(),utils_1._.isElementChildOfClass(r,"ag-selection-checkbox",3)||(utils_1._.isLeftClick(e)&&l&&(r=this.cellPosition,o?l.extendLatestRangeToCell(r):(n=s||n,l.setRangeToCell(r,n))),e=this.createEvent(e,events_1.Events.EVENT_CELL_MOUSE_DOWN),a.dispatchEvent(e))},l.prototype.isDoubleClickOnIPad=function(){if(!utils_1._.isUserAgentIPad())return!1;var e=(new Date).getTime(),t=e-this.lastIPadMouseClickEvent<200;return this.lastIPadMouseClickEvent=e,t},l.prototype.onCellClicked=function(e){if(this.isDoubleClickOnIPad())return this.onCellDoubleClicked(e),void e.preventDefault();var t=this.createEvent(e,events_1.Events.EVENT_CELL_CLICKED);this.beans.eventService.dispatchEvent(t);var i=this.getComponentHolder();i.onCellClicked&&window.setTimeout(function(){return i.onCellClicked(t)},0),!this.beans.gridOptionsWrapper.isSingleClickEdit()&&!i.singleClickEdit||this.beans.gridOptionsWrapper.isSuppressClickEdit()||this.startRowOrCellEdit(),utils_1._.doIeFocusHack(this.getGui())},l.prototype.createGridCellVo=function(){this.cellPosition={rowIndex:this.rowNode.rowIndex,rowPinned:this.rowNode.rowPinned,column:this.column}},l.prototype.getCellPosition=function(){return this.cellPosition},l.prototype.getParentRow=function(){return this.eParentRow},l.prototype.setParentRow=function(e){this.eParentRow=e},l.prototype.getColumn=function(){return this.column},l.prototype.getComponentHolder=function(){return this.column.getColDef()},l.prototype.detach=function(){this.eParentRow.removeChild(this.getGui())},l.prototype.destroy=function(){a.prototype.destroy.call(this),this.cellEditor&&this.cellEditor.destroy&&(this.cellEditor.destroy(),this.cellEditor=null),this.cellRenderer&&this.cellRenderer.destroy&&(this.cellRenderer.destroy(),this.cellRenderer=null),this.selectionHandle&&this.selectionHandle.destroy()},l.prototype.onLeftChanged=function(){var e=this.modifyLeftForPrintLayout(this.getCellLeft());this.getGui().style.left=e+"px"},l.prototype.modifyLeftForPrintLayout=function(e){return!this.printLayout||this.column.getPinned()===column_1.Column.PINNED_LEFT?e:this.column.getPinned()===column_1.Column.PINNED_RIGHT?this.beans.columnController.getPinnedLeftContainerWidth()+this.beans.columnController.getBodyContainerWidth()+e:this.beans.columnController.getPinnedLeftContainerWidth()+e},l.prototype.onWidthChanged=function(){var e=this.getCellWidth();this.getGui().style.width=e+"px"},l.prototype.getRangeBorders=function(){var e,t=this,i=this.beans.gridOptionsWrapper.isEnableRtl(),s=!1,n=!1,o=!1,r=!1,l=this.cellPosition.column,a=this.beans.rangeController,p=i?(e=this.beans.columnController.getDisplayedColAfter(l),this.beans.columnController.getDisplayedColBefore(l)):(e=this.beans.columnController.getDisplayedColBefore(l),this.beans.columnController.getDisplayedColAfter(l)),h=a.getCellRanges().filter(function(e){return a.isCellInSpecificRange(t.cellPosition,e)});e||(r=!0),p||(n=!0);for(var u=0;u<h.length&&!(s&&n&&o&&r);u++){var d=h[u],c=a.getRangeStartRow(d),g=a.getRangeEndRow(d);!s&&this.beans.rowPositionUtils.sameRow(c,this.cellPosition)&&(s=!0),!o&&this.beans.rowPositionUtils.sameRow(g,this.cellPosition)&&(o=!0),!r&&d.columns.indexOf(e)<0&&(r=!0),!n&&d.columns.indexOf(p)<0&&(n=!0)}return{top:s,right:n,bottom:o,left:r}},l.prototype.getInitialRangeClasses=function(){var e=[];if(!this.rangeSelectionEnabled||!this.rangeCount)return e;var t=this.beans.rangeController;e.push("ag-cell-range-selected"),this.hasChartRange&&e.push("ag-cell-range-chart");var i=Math.min(this.rangeCount,4);return e.push("ag-cell-range-selected-"+i),1!==this.rangeCount||t.isMoreThanOneCell()||e.push("ag-cell-range-single-cell"),0<this.rangeCount&&((t=this.getRangeBorders()).top&&e.push("ag-cell-range-top"),t.right&&e.push("ag-cell-range-right"),t.bottom&&e.push("ag-cell-range-bottom"),t.left&&e.push("ag-cell-range-left")),this.selectionHandle&&e.push("ag-cell-range-handle"),e},l.prototype.onRowIndexChanged=function(){this.createGridCellVo(),this.onCellFocused(),this.onRangeSelectionChanged()},l.prototype.onRangeSelectionChanged=function(){var e,t,i,s;this.beans.enterprise&&(i=this.beans,t=this.cellPosition,e=this.rangeCount,i=(s=i.rangeController).getCellRangeCount(t),t=this.getGui(),e!==i&&(utils_1._.addOrRemoveCssClass(t,"ag-cell-range-selected",0!==i),utils_1._.addOrRemoveCssClass(t,"ag-cell-range-selected-1",1===i),utils_1._.addOrRemoveCssClass(t,"ag-cell-range-selected-2",2===i),utils_1._.addOrRemoveCssClass(t,"ag-cell-range-selected-3",3===i),utils_1._.addOrRemoveCssClass(t,"ag-cell-range-selected-4",4<=i),this.rangeCount=i),i=this.rangeCount&&s.getCellRanges().every(function(e){return utils_1._.exists(e.type)}),this.hasChartRange!==i&&(utils_1._.addOrRemoveCssClass(t,"ag-cell-range-chart",i),this.hasChartRange=i),this.updateRangeBorders(),s=1===this.rangeCount&&!s.isMoreThanOneCell(),utils_1._.addOrRemoveCssClass(t,"ag-cell-range-single-cell",s),this.refreshHandle(),utils_1._.addOrRemoveCssClass(t,"ag-cell-range-handle",!!this.selectionHandle))},l.prototype.shouldHaveSelectionHandle=function(){var e=this.beans,t=e.gridOptionsWrapper,i=e.rangeController,s=this.getGui(),n=i.getCellRanges(),o=n.length;if(!o)return!1;var r=utils_1._.last(n),l=n[0].type===iRangeController_1.CellRangeType.DIMENSION,e=(t.isEnableFillHandle()||t.isEnableRangeHandle()||this.hasChartRange&&!l)&&1===o;return!e&&this.hasChartRange&&(t=this.getCellPosition(),e=l&&2===o&&i.isCellInSpecificRange(this.getCellPosition(),r),n=l&&i.isCellInSpecificRange(t,n[0]),utils_1._.addOrRemoveCssClass(s,"ag-cell-range-chart-category",n)),this.rangeCount&&e&&null!=r.endRow&&this.beans.rangeController.isContiguousRange(r)&&(utils_1._.containsClass(s,"ag-cell-range-single-cell")||utils_1._.containsClass(s,"ag-cell-range-bottom")&&utils_1._.containsClass(s,"ag-cell-range-right"))},l.prototype.addSelectionHandle=function(){var e=this.beans,t=e.gridOptionsWrapper,i=e.context,e=e.rangeController,e=utils_1._.last(e.getCellRanges()).type,e=t.isEnableFillHandle()&&utils_1._.missing(e)?"fill":"range";this.selectionHandle&&this.selectionHandle.getType()!==e&&(this.selectionHandle.destroy(),this.selectionHandle=void 0),this.selectionHandle||(this.selectionHandle=i.createComponentFromElement(document.createElement("ag-"+e+"-handle"))),this.selectionHandle.refresh(this)},l.prototype.updateRangeBordersIfRangeCount=function(){0<this.rangeCount&&(this.updateRangeBorders(),this.refreshHandle())},l.prototype.refreshHandle=function(){var e=this.shouldHaveSelectionHandle();this.selectionHandle&&!e&&(this.selectionHandle.destroy(),this.selectionHandle=null),e&&this.addSelectionHandle()},l.prototype.updateRangeBorders=function(){var e=this.getRangeBorders(),t=1===this.rangeCount&&!this.beans.rangeController.isMoreThanOneCell(),i=!t&&e.top,s=!t&&e.right,n=!t&&e.bottom,t=!t&&e.left,e=this.getGui();utils_1._.addOrRemoveCssClass(e,"ag-cell-range-top",i),utils_1._.addOrRemoveCssClass(e,"ag-cell-range-right",s),utils_1._.addOrRemoveCssClass(e,"ag-cell-range-bottom",n),utils_1._.addOrRemoveCssClass(e,"ag-cell-range-left",t)},l.prototype.onFirstRightPinnedChanged=function(){var e=this.column.isFirstRightPinned();this.firstRightPinned!==e&&(this.firstRightPinned=e,utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-first-right-pinned",e))},l.prototype.onLastLeftPinnedChanged=function(){var e=this.column.isLastLeftPinned();this.lastLeftPinned!==e&&(this.lastLeftPinned=e,utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-last-left-pinned",e))},l.prototype.populateTemplate=function(){this.usingWrapper?(this.eParentOfValue=this.getRefElement("eCellValue"),this.eCellWrapper=this.getRefElement("eCellWrapper"),this.includeRowDraggingComponent&&this.addRowDragging(),this.includeDndSourceComponent&&this.addDndSource(),this.includeSelectionComponent&&this.addSelectionCheckbox()):this.eParentOfValue=this.getGui()},l.prototype.getFrameworkOverrides=function(){return this.beans.frameworkOverrides},l.prototype.addRowDragging=function(){var e=this.beans.gridOptionsWrapper.isPagination(),t=this.beans.gridOptionsWrapper.isRowDragManaged(),i=this.beans.gridOptionsWrapper.isRowModelDefault();if(t){if(!i)return void utils_1._.doOnce(function(){return console.warn("ag-Grid: managed row dragging is only allowed in the Client Side Row Model")},"CellComp.addRowDragging");if(e)return void utils_1._.doOnce(function(){return console.warn("ag-Grid: managed row dragging is not possible when doing pagination")},"CellComp.addRowDragging")}e=new rowDragComp_1.RowDragComp(this.rowNode,this.column,this.getValueToUse(),this.beans);this.addFeature(this.beans.context,e),this.eCellWrapper.insertBefore(e.getGui(),this.eParentOfValue)},l.prototype.addDndSource=function(){var e=new dndSourceComp_1.DndSourceComp(this.rowNode,this.column,this.getValueToUse(),this.beans,this.getGui());this.addFeature(this.beans.context,e),this.eCellWrapper.insertBefore(e.getGui(),this.eParentOfValue)},l.prototype.addSelectionCheckbox=function(){var e=new checkboxSelectionComponent_1.CheckboxSelectionComponent;this.beans.context.wireBean(e);var t="function"==typeof(t=this.getComponentHolder().checkboxSelection)?t:null;e.init({rowNode:this.rowNode,column:this.column,visibleFunc:t}),this.addDestroyFunc(function(){return e.destroy()}),this.eCellWrapper.insertBefore(e.getGui(),this.eParentOfValue)},l.prototype.addDomData=function(){var e=this,t=this.getGui();this.beans.gridOptionsWrapper.setDomData(t,l.DOM_DATA_KEY_CELL_COMP,this),this.addDestroyFunc(function(){return e.beans.gridOptionsWrapper.setDomData(t,l.DOM_DATA_KEY_CELL_COMP,null)})},l.prototype.onCellFocused=function(e){var t=this.beans.focusedCellController.isCellFocused(this.cellPosition);t!==this.cellFocused&&(this.beans.gridOptionsWrapper.isSuppressCellSelection()||utils_1._.addOrRemoveCssClass(this.getGui(),"ag-cell-focus",t),this.cellFocused=t),t&&e&&e.forceBrowserFocus&&((i=this.getGui()).focus(),utils_1._.doIeFocusHack(i));var i=this.beans.gridOptionsWrapper.isFullRowEdit();t||i||!this.editingCell||this.stopRowOrCellEdit()},l.prototype.stopRowOrCellEdit=function(e){void 0===e&&(e=!1),this.beans.gridOptionsWrapper.isFullRowEdit()?this.rowComp.stopRowEditing(e):this.stopEditing(e)},l.prototype.stopEditing=function(e){var t,i;void 0===e&&(e=!1),this.editingCell&&(this.cellEditor?(t=!1,e||this.cellEditor.isCancelAfterEnd&&this.cellEditor.isCancelAfterEnd()||(i=this.cellEditor.getValue(),t=!0),this.editingCell=!1,this.cellEditor.destroy&&this.cellEditor.destroy(),this.cellEditor=null,this.cellEditorInPopup&&this.hideEditorPopup?(this.hideEditorPopup(),this.hideEditorPopup=null):(utils_1._.clearElement(this.getGui()),this.usingWrapper?this.getGui().appendChild(this.eCellWrapper):!this.cellRenderer||(e=this.cellRendererGui)&&this.getGui().appendChild(e)),this.setInlineEditingClass(),t&&(this.suppressRefreshCell=!0,this.rowNode.setDataValue(this.column,i),this.suppressRefreshCell=!1),this.refreshCell({forceRefresh:!0,suppressFlash:!0}),i=this.createEvent(null,events_1.Events.EVENT_CELL_EDITING_STOPPED),this.beans.eventService.dispatchEvent(i)):this.editingCell=!1)},l.DOM_DATA_KEY_CELL_COMP="cellComp",l.CELL_RENDERER_TYPE_NORMAL="cellRenderer",l.CELL_RENDERER_TYPE_PINNED="pinnedRowCellRenderer",l}(component_1.Component);exports.CellComp=CellComp;