"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,a=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var l=e.length-1;0<=l;l--)(n=e[l])&&(a=(i<3?n(a):3<i?n(t,r,a):n(t,r))||a);return 3<i&&a&&Object.defineProperty(t,r,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),sortController_1=require("../sortController"),valueService_1=require("../valueService/valueService"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),columnController_1=require("../columnController/columnController"),utils_1=require("../utils"),SortService=function(){function e(){}return e.prototype.init=function(){this.postSortFunc=this.gridOptionsWrapper.getPostSortFunc()},e.prototype.sort=function(r,o,n,i,a,l){var p=this;a.forEachChangedNodeDepthFirst(function(e){var t;p.pullDownGroupDataForHideOpenParents(e.childrenAfterFilter,!0),o?(t=n?p.doDeltaSort(e,r,i,a,l):p.doFullSort(e,r),e.childrenAfterSort=t.map(function(e){return e.rowNode})):e.childrenAfterSort=e.childrenAfterFilter.slice(0),p.updateChildIndexes(e),p.postSortFunc&&p.postSortFunc(e.childrenAfterSort)}),this.updateGroupDataForHiddenOpenParents(a)},e.prototype.doFullSort=function(e,t){e=e.childrenAfterFilter.map(this.mapNodeToSortedNode.bind(this));return e.sort(this.compareRowNodes.bind(this,t)),e},e.prototype.mapNodeToSortedNode=function(e,t){return{currentPos:t,rowNode:e}},e.prototype.doDeltaSort=function(e,t,r,o,n){var i=e.childrenAfterSort.filter(function(e){var t=!r[e.id],e=n||o.canSkip(e);return t&&e}).map(this.mapNodeToSortedNode.bind(this)),a={};i.forEach(function(e){return a[e.rowNode.id]=e.rowNode});e=e.childrenAfterFilter.filter(function(e){return!a[e.id]}).map(this.mapNodeToSortedNode.bind(this));return e.sort(this.compareRowNodes.bind(this,t)),0===e.length?i:0===i.length?e:this.mergeSortedArrays(t,i,e)},e.prototype.mergeSortedArrays=function(e,t,r){for(var o=[],n=0,i=0;n<t.length&&i<r.length;)this.compareRowNodes(e,t[n],r[i])<0?o.push(t[n++]):o.push(r[i++]);for(;n<t.length;)o.push(t[n++]);for(;i<r.length;)o.push(r[i++]);return o},e.prototype.compareRowNodes=function(e,t,r){for(var o=t.rowNode,n=r.rowNode,i=0,a=e.length;i<a;i++){var l=e[i],p=-1===l.inverter,d=this.getValue(o,l.column),u=this.getValue(n,l.column),c=void 0;if(0!==(c=l.column.getColDef().comparator?l.column.getColDef().comparator(d,u,o,n,p):utils_1._.defaultComparator(d,u,this.gridOptionsWrapper.isAccentedSort())))return c*l.inverter}return t.currentPos-r.currentPos},e.prototype.getValue=function(e,t){return this.valueService.getValue(t,e)},e.prototype.updateChildIndexes=function(e){if(!utils_1._.missing(e.childrenAfterSort))for(var t=e.childrenAfterSort,r=0;r<t.length;r++){var o=t[r],n=0===r,i=r===e.childrenAfterSort.length-1;o.setFirstChild(n),o.setLastChild(i),o.setChildIndex(r)}},e.prototype.updateGroupDataForHiddenOpenParents=function(e){var t,r=this;this.gridOptionsWrapper.isGroupHideOpenParents()&&(t=function(e){r.pullDownGroupDataForHideOpenParents(e.childrenAfterSort,!1),e.childrenAfterSort.forEach(function(e){e.hasChildren()&&t(e)})},e.executeFromRootNode(function(e){return t(e)}))},e.prototype.pullDownGroupDataForHideOpenParents=function(e,o){var n=this;utils_1._.missing(e)||this.gridOptionsWrapper.isGroupHideOpenParents()&&e.forEach(function(r){n.columnController.getGroupDisplayColumns().forEach(function(e){var t=e.getColDef().showRowGroup;"string"==typeof t?(t=n.columnController.getPrimaryColumn(t))===r.rowGroupColumn||(o?r.setGroupValue(e.getId(),null):(t=r.getFirstChildOfFirstChild(t))&&r.setGroupValue(e.getId(),t.key)):console.error("ag-Grid: groupHideOpenParents only works when specifying specific columns for colDef.showRowGroup")})})},__decorate([context_1.Autowired("sortController"),__metadata("design:type",sortController_1.SortController)],e.prototype,"sortController",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("valueService"),__metadata("design:type",valueService_1.ValueService)],e.prototype,"valueService",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),__decorate([context_1.Bean("sortService")],e)}();exports.SortService=SortService;