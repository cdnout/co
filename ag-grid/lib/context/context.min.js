"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils"),Context=function(){function t(t,e){this.beanWrappers={},this.registeredModules=[],this.componentsMappedByName={},this.destroyed=!1,t&&t.beans&&(this.contextParams=t,this.registeredModules=t.registeredModules,this.logger=e,this.logger.log(">> creating ag-Application Context"),this.setupComponents(),this.createBeans(),e=this.getBeanInstances(),this.wireBeans(e),this.logger.log(">> ag-Application Context ready - component is alive"))}return t.prototype.getBeanInstances=function(){return utils_1._.mapObject(this.beanWrappers,function(t){return t.beanInstance})},t.prototype.setupComponents=function(){var e=this;this.contextParams.components&&this.contextParams.components.forEach(function(t){return e.addComponent(t)})},t.prototype.addComponent=function(t){var e=t.componentName.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().toUpperCase();this.componentsMappedByName[e]=t.theClass},t.prototype.createComponentFromElement=function(t,e){t=t.nodeName;if(this.componentsMappedByName&&this.componentsMappedByName[t]){t=new this.componentsMappedByName[t];return this.wireBean(t,e),t}return null},t.prototype.wireBean=function(t,e){if(!t)throw Error("Can't wire to bean since it is null");this.wireBeans([t],e)},t.prototype.wireBeans=function(t,e){this.autoWireBeans(t),this.methodWireBeans(t),this.callLifeCycleMethods(t,"preConstructMethods"),utils_1._.exists(e)&&t.forEach(e),this.callLifeCycleMethods(t,"postConstructMethods")},t.prototype.createBeans=function(){var o=this;this.contextParams.beans.forEach(this.createBeanWrapper.bind(this)),this.contextParams.overrideBeans&&this.contextParams.overrideBeans.forEach(this.createBeanWrapper.bind(this)),utils_1._.iterateObject(this.beanWrappers,function(t,e){e.bean.__agBeanMetaData&&e.bean.__agBeanMetaData.autowireMethods&&e.bean.__agBeanMetaData.autowireMethods.agConstructor&&(n=e.bean.__agBeanMetaData.autowireMethods.agConstructor);var n=o.getBeansForParameters(n,e.bean.name),n=applyToConstructor(e.bean,n);e.beanInstance=n,o.logger.log("bean "+o.getBeanName(n)+" created")})},t.prototype.createBeanWrapper=function(t){var e,n=t.__agBeanMetaData;n?(e={bean:t,beanInstance:null,beanName:n.beanName},this.beanWrappers[n.beanName]=e):(e=void 0,e=t.prototype.constructor?t.prototype.constructor.name:""+t,console.error("context item "+e+" is not a bean"))},t.prototype.autoWireBeans=function(t){var r=this;t.forEach(function(o){r.forEachMetaDataInHierarchy(o,function(t,n){t=t.agClassAttributes;t&&t.forEach(function(t){var e=r.lookupBeanInstance(n,t.beanName,t.optional);o[t.attributeName]=e})})})},t.prototype.methodWireBeans=function(t){var r=this;t.forEach(function(o){r.forEachMetaDataInHierarchy(o,function(t,n){utils_1._.iterateObject(t.autowireMethods,function(t,e){"agConstructor"!==t&&(e=r.getBeansForParameters(e,n),o[t].apply(o,e))})})})},t.prototype.forEachMetaDataInHierarchy=function(t,e){for(var n=Object.getPrototypeOf(t);null!=n;){var o=n.constructor;o.hasOwnProperty("__agBeanMetaData")&&e(o.__agBeanMetaData,this.getBeanName(o)),n=Object.getPrototypeOf(n)}},t.prototype.getBeanName=function(t){if(t.__agBeanMetaData&&t.__agBeanMetaData.beanName)return t.__agBeanMetaData.beanName;t=t.toString();return t.substring(9,t.indexOf("("))},t.prototype.getBeansForParameters=function(t,n){var o=this,r=[];return t&&utils_1._.iterateObject(t,function(t,e){e=o.lookupBeanInstance(n,e);r[Number(t)]=e}),r},t.prototype.lookupBeanInstance=function(t,e,n){if(void 0===n&&(n=!1),"context"===e)return this;if(this.contextParams.seed&&this.contextParams.seed.hasOwnProperty(e))return this.contextParams.seed[e];var o=this.beanWrappers[e];return o?o.beanInstance:(n||console.error("ag-Grid: unable to find bean reference "+e+" while initialising "+t),null)},t.prototype.callLifeCycleMethods=function(t,n){var o=this;t.forEach(function(e){o.forEachMetaDataInHierarchy(e,function(t){t=t[n];t&&t.forEach(function(t){return e[t]()})})})},t.prototype.getBean=function(t){return this.lookupBeanInstance("getBean",t,!0)},t.prototype.getEnterpriseDefaultComponents=function(){return this.contextParams.enterpriseDefaultComponents},t.prototype.destroy=function(){var t;this.destroyed||(this.logger.log(">> Shutting down ag-Application Context"),t=this.getBeanInstances(),this.callLifeCycleMethods(t,"preDestroyMethods"),this.contextParams.seed=null,this.destroyed=!0,this.logger.log(">> ag-Application Context shut down - component is dead"))},t.prototype.isModuleRegistered=function(t){return-1!==this.registeredModules.indexOf(t)},t}();function applyToConstructor(t,e){e=[null].concat(e);return new(t.bind.apply(t,e))}function PreConstruct(t,e,n){t=getOrCreateProps(t.constructor);t.postConstructMethods||(t.preConstructMethods=[]),t.preConstructMethods.push(e)}function PostConstruct(t,e,n){t=getOrCreateProps(t.constructor);t.postConstructMethods||(t.postConstructMethods=[]),t.postConstructMethods.push(e)}function PreDestroy(t,e,n){t=getOrCreateProps(t.constructor);t.preDestroyMethods||(t.preDestroyMethods=[]),t.preDestroyMethods.push(e)}function Bean(e){return function(t){getOrCreateProps(t).beanName=e}}function Autowired(o){return function(t,e,n){autowiredFunc(t,o,!1,t,e,null)}}function Optional(o){return function(t,e,n){autowiredFunc(t,o,!0,t,e,null)}}function autowiredFunc(t,e,n,o,r,a){null!==e?"number"!=typeof a?((t=getOrCreateProps(t.constructor)).agClassAttributes||(t.agClassAttributes=[]),t.agClassAttributes.push({attributeName:r,beanName:e,optional:n})):console.error("ag-Grid: Autowired should be on an attribute"):console.error("ag-Grid: Autowired name should not be null")}function Qualifier(a){return function(t,e,n){var o,r="function"==typeof t?t:t.constructor;"number"==typeof n&&(t=void 0,t=e?(o=getOrCreateProps(r),e):(o=getOrCreateProps(r),"agConstructor"),o.autowireMethods||(o.autowireMethods={}),o.autowireMethods[t]||(o.autowireMethods[t]={}),o.autowireMethods[t][n]=a)}}function getOrCreateProps(t){return t.hasOwnProperty("__agBeanMetaData")||(t.__agBeanMetaData={}),t.__agBeanMetaData}exports.Context=Context,exports.PreConstruct=PreConstruct,exports.PostConstruct=PostConstruct,exports.PreDestroy=PreDestroy,exports.Bean=Bean,exports.Autowired=Autowired,exports.Optional=Optional,exports.Qualifier=Qualifier;