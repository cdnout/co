"use strict";const VERSION="4.0.0-rc.1",Avvio=require("avvio"),http=require("http"),querystring=require("querystring");let lightMyRequest;const{kAvvioBoot,kChildren,kServerBindings,kBodyLimit,kRoutePrefix,kLogLevel,kLogSerializers,kHooks,kSchemaController,kRequestAcceptVersion,kReplySerializerDefault,kContentTypeParser,kReply,kRequest,kFourOhFour,kState,kOptions,kPluginNameChain,kSchemaErrorFormatter,kErrorHandler,kKeepAliveConnections,kFourOhFourContext}=require("./lib/symbols.js"),createServer=require("./lib/server"),Reply=require("./lib/reply"),Request=require("./lib/request"),supportedMethods=["DELETE","GET","HEAD","PATCH","POST","PUT","OPTIONS"],decorator=require("./lib/decorate"),ContentTypeParser=require("./lib/contentTypeParser"),SchemaController=require("./lib/schema-controller"),{Hooks,hookRunnerApplication,supportedHooks}=require("./lib/hooks"),createLogger=require("./lib/logger")["createLogger"],pluginUtils=require("./lib/pluginUtils"),reqIdGenFactory=require("./lib/reqIdGenFactory"),{buildRouting,validateBodyLimitOption}=require("./lib/route"),build404=require("./lib/fourOhFour"),getSecuredInitialConfig=require("./lib/initialConfigValidation"),override=require("./lib/pluginOverride"),warning=require("./lib/warnings"),noopSet=require("./lib/noop-set"),defaultInitOptions=getSecuredInitialConfig["defaultInitOptions"],{FST_ERR_BAD_URL,AVVIO_ERRORS_MAP,appendStackTrace}=require("./lib/errors"),buildErrorHandler=require("./lib/error-handler.js")["buildErrorHandler"],onBadUrlContext={config:{},onSend:[],onError:[],[kFourOhFourContext]:null};function defaultBuildPrettyMeta(t){const r={};return["errorHandler","logLevel","logSerializers"].concat(supportedHooks).forEach(e=>{r[e]=t.store[e]}),Object.assign({},r)}function fastify(e){if("object"!=typeof(e=e||{}))throw new TypeError("Options must be an object");if(e.querystringParser&&"function"!=typeof e.querystringParser)throw new Error(`querystringParser option should be a function, instead got '${typeof e.querystringParser}'`);if(e.schemaController&&e.schemaController.bucket&&"function"!=typeof e.schemaController.bucket)throw new Error(`schemaController.bucket option should be a function, instead got '${typeof e.schemaController.bucket}'`);validateBodyLimitOption(e.bodyLimit);var t=e.requestIdHeader||defaultInitOptions.requestIdHeader,r=e.querystringParser||querystring.parse;const i=e.genReqId||reqIdGenFactory();var o=e.requestIdLogLabel||"reqId",n=e.bodyLimit||defaultInitOptions.bodyLimit,s=e.disableRequestLogging||!1,a=Object.assign({customOptions:{},plugins:[]},e.ajv);const l=e.frameworkErrors;if(!a.customOptions||"[object Object]"!==Object.prototype.toString.call(a.customOptions))throw new Error(`ajv.customOptions option should be an object, instead got '${typeof a.customOptions}'`);if(!a.plugins||!Array.isArray(a.plugins))throw new Error(`ajv.plugins option should be an array, instead got '${typeof a.plugins}'`);const{logger:u,hasLogger:c}=createLogger(e);e.connectionTimeout=e.connectionTimeout||defaultInitOptions.connectionTimeout,e.keepAliveTimeout=e.keepAliveTimeout||defaultInitOptions.keepAliveTimeout,e.forceCloseConnections=("boolean"==typeof e.forceCloseConnections?e:defaultInitOptions).forceCloseConnections,e.maxRequestsPerSocket=e.maxRequestsPerSocket||defaultInitOptions.maxRequestsPerSocket,e.requestTimeout=e.requestTimeout||defaultInitOptions.requestTimeout,e.logger=u,e.genReqId=i,e.requestIdHeader=t,e.querystringParser=r,e.requestIdLogLabel=o,e.disableRequestLogging=s,e.ajv=a,e.clientErrorHandler=e.clientErrorHandler||function(e,t){var r;"ECONNRESET"===e.code||t.destroyed||(r=JSON.stringify({error:http.STATUS_CODES[400],message:"Client Error",statusCode:400}),this.log.trace({err:e},"client error"),t.writable&&0===t.bytesWritten&&t.write(`HTTP/1.1 400 Bad Request\r\nContent-Length: ${r.length}\r\nContent-Type: application/json\r\n\r\n${r}`),t.destroy(e))};o=getSecuredInitialConfig(e),s=!0===e.forceCloseConnections?new Set:noopSet();e.exposeHeadRoutes=o.exposeHeadRoutes;let d=e.constraints;e.versioning&&(warning.emit("FSTDEP009"),d={...d,version:{name:"version",mustMatchWhenDerived:!0,storage:e.versioning.storage,deriveConstraint:e.versioning.deriveVersion,validate(e){if("string"!=typeof e)throw new Error("Version constraint should be a string.")}}});const h=buildRouting({config:{defaultRoute:function(e,t){void 0!==e.headers["accept-version"]&&(e.headers[kRequestAcceptVersion]=e.headers["accept-version"],e.headers["accept-version"]=void 0);p.router.lookup(e,t)},onBadUrl:function(e,t,r){if(l){var o=i(t);const n=u.child({reqId:o});n.info({req:t},"incoming request");o=new Request(o,null,t,null,n,onBadUrlContext),t=new Reply(r,o,n);return l(new FST_ERR_BAD_URL(e),o,t)}e=`{"error":"Bad Request","message":"'${e}' is not a valid url component","statusCode":400}`;r.writeHead(400,{"Content-Type":"application/json","Content-Length":e.length}),r.end(e)},constraints:d,ignoreTrailingSlash:e.ignoreTrailingSlash||defaultInitOptions.ignoreTrailingSlash,maxParamLength:e.maxParamLength||defaultInitOptions.maxParamLength,caseSensitive:e.caseSensitive,allowUnsafeRegex:e.allowUnsafeRegex||defaultInitOptions.allowUnsafeRegex,buildPrettyMeta:defaultBuildPrettyMeta},keepAliveConnections:s}),p=build404(e),g=wrapRouting(h.routing,e);e.http2SessionTimeout=o.http2SessionTimeout;const{server:f,listen:m}=createServer(e,g);a=Reply.setupResponseListeners;const y=SchemaController.buildSchemaController(null,e.schemaController),k={[kState]:{listening:!1,closing:!1,started:!1},[kKeepAliveConnections]:s,[kOptions]:e,[kChildren]:[],[kServerBindings]:[],[kBodyLimit]:n,[kRoutePrefix]:"",[kLogLevel]:"",[kLogSerializers]:null,[kHooks]:new Hooks,[kSchemaController]:y,[kSchemaErrorFormatter]:null,[kErrorHandler]:buildErrorHandler(),[kReplySerializerDefault]:null,[kContentTypeParser]:new ContentTypeParser(n,e.onProtoPoisoning||defaultInitOptions.onProtoPoisoning,e.onConstructorPoisoning||defaultInitOptions.onConstructorPoisoning),[kReply]:Reply.buildReply(Reply),[kRequest]:Request.buildRequest(Request,e.trustProxy),[kFourOhFour]:p,[pluginUtils.registeredPlugins]:[],[kPluginNameChain]:[],[kAvvioBoot]:null,routing:g,getDefaultRoute:h.getDefaultRoute.bind(h),setDefaultRoute:h.setDefaultRoute.bind(h),delete:function(e,t,r){return h.prepareRoute.call(this,"DELETE",e,t,r)},get:function(e,t,r){return h.prepareRoute.call(this,"GET",e,t,r)},head:function(e,t,r){return h.prepareRoute.call(this,"HEAD",e,t,r)},patch:function(e,t,r){return h.prepareRoute.call(this,"PATCH",e,t,r)},post:function(e,t,r){return h.prepareRoute.call(this,"POST",e,t,r)},put:function(e,t,r){return h.prepareRoute.call(this,"PUT",e,t,r)},options:function(e,t,r){return h.prepareRoute.call(this,"OPTIONS",e,t,r)},all:function(e,t,r){return h.prepareRoute.call(this,supportedMethods,e,t,r)},route:function(e){return h.route.call(this,e)},log:u,withTypeProvider:function(){return this},addHook:function(r,o){if(S('Cannot call "addHook" when fastify instance is already started!'),"onSend"===r||"preSerialization"===r||"onError"===r||"preParsing"===r){if("AsyncFunction"===o.constructor.name&&4===o.length)throw new Error("Async function has too many arguments. Async hooks should not use the 'done' argument.")}else if("onReady"===r){if("AsyncFunction"===o.constructor.name&&0!==o.length)throw new Error("Async function has too many arguments. Async hooks should not use the 'done' argument.")}else if("AsyncFunction"===o.constructor.name&&3===o.length)throw new Error("Async function has too many arguments. Async hooks should not use the 'done' argument.");"onClose"===r?this.onClose(o):"onReady"===r?this[kHooks].add(r,o):"onRoute"===r?(this[kHooks].validate(r,o),this[kHooks].add(r,o)):this.after((e,t)=>{n.call(this,r,o),t(e)});return this;function n(t,r){this[kHooks].add(t,r),this[kChildren].forEach(e=>n.call(e,t,r))}},addSchema:function(t){return S('Cannot call "addSchema" when fastify instance is already started!'),this[kSchemaController].add(t),this[kChildren].forEach(e=>e.addSchema(t)),this},getSchema:y.getSchema.bind(y),getSchemas:y.getSchemas.bind(y),setValidatorCompiler:function(e){return S('Cannot call "setValidatorCompiler" when fastify instance is already started!'),this[kSchemaController].setValidatorCompiler(e),this},setSerializerCompiler:function(e){return S('Cannot call "setSerializerCompiler" when fastify instance is already started!'),this[kSchemaController].setSerializerCompiler(e),this},setSchemaController:function(e){S('Cannot call "setSchemaController" when fastify instance is already started!');const t=this[kSchemaController],r=SchemaController.buildSchemaController(t,Object.assign({},t.opts,e));return this[kSchemaController]=r,this.getSchema=r.getSchema.bind(r),this.getSchemas=r.getSchemas.bind(r),this},setReplySerializer:function(e){return S('Cannot call "setReplySerializer" when fastify instance is already started!'),this[kReplySerializerDefault]=e,this},setSchemaErrorFormatter:function(e){return S('Cannot call "setSchemaErrorFormatter" when fastify instance is already started!'),validateSchemaErrorFormatter(e),this[kSchemaErrorFormatter]=e.bind(this),this},addContentTypeParser:ContentTypeParser.helpers.addContentTypeParser,hasContentTypeParser:ContentTypeParser.helpers.hasContentTypeParser,getDefaultJsonParser:ContentTypeParser.defaultParsers.getDefaultJsonParser,defaultTextParser:ContentTypeParser.defaultParsers.defaultTextParser,removeContentTypeParser:ContentTypeParser.helpers.removeContentTypeParser,removeAllContentTypeParsers:ContentTypeParser.helpers.removeAllContentTypeParsers,register:null,after:null,ready:null,onClose:null,close:null,printPlugins:null,listen:m,server:f,addresses:function(){const e=this[kServerBindings].map(e=>e.address());return e.push(this.server.address()),e.filter(e=>e)},decorate:decorator.add,hasDecorator:decorator.exist,decorateReply:decorator.decorateReply,decorateRequest:decorator.decorateRequest,hasRequestDecorator:decorator.existRequest,hasReplyDecorator:decorator.existReply,inject:function(t,r){void 0===lightMyRequest&&(lightMyRequest=require("light-my-request"));if(k[kState].started){if(k[kState].closing){var e=new Error("Server is closed");return r?void r(e):Promise.reject(e)}return lightMyRequest(g,t,r)}{if(!r)return lightMyRequest((t,r)=>{this.ready(function(e){e?r.emit("error",e):g(t,r)})},t);this.ready(e=>{e?r(e,null):lightMyRequest(g,t,r)})}},printRoutes:function(e={}){return e.includeMeta=e.includeHooks?e.includeMeta?supportedHooks.concat(e.includeMeta):supportedHooks:e.includeMeta,h.printRoutes(e)},setNotFoundHandler:function(e,t){return S('Cannot call "setNotFoundHandler" when fastify instance is already started!'),p.setNotFoundHandler.call(this,e,t,C,h.routeHandler),this},setErrorHandler:function(e){return S('Cannot call "setErrorHandler" when fastify instance is already started!'),this[kErrorHandler]=buildErrorHandler(this[kErrorHandler],e.bind(this)),this},initialConfig:o};Object.defineProperties(k,{pluginName:{get(){return 1<this[kPluginNameChain].length?this[kPluginNameChain].join(" -> "):this[kPluginNameChain][0]}},prefix:{get(){return this[kRoutePrefix]}},validatorCompiler:{get(){return this[kSchemaController].getValidatorCompiler()}},serializerCompiler:{get(){return this[kSchemaController].getSerializerCompiler()}},version:{get(){return VERSION}},errorHandler:{get(){return this[kErrorHandler].func}}}),e.schemaErrorFormatter&&(validateSchemaErrorFormatter(e.schemaErrorFormatter),k[kSchemaErrorFormatter]=e.schemaErrorFormatter.bind(k));o=Number(e.pluginTimeout);const C=Avvio(k,{autostart:!1,timeout:!1===isNaN(o)?o:defaultInitOptions.pluginTimeout,expose:{use:"register"}});C.override=override,C.on("start",()=>k[kState].started=!0),k[kAvvioBoot]=k.ready,k.ready=function(t){let r,o;if(process.nextTick(function(){k[kAvvioBoot]((e,t)=>{e||k[kState].started?n(e):hookRunnerApplication("onReady",k[kAvvioBoot],k,n),t()})}),!t)return new Promise(function(e,t){r=e,o=t});function n(e){if(e=null!=e&&null!=AVVIO_ERRORS_MAP[e.code]?appendStackTrace(e,new AVVIO_ERRORS_MAP[e.code](e.message)):e,t)e?t(e):t(void 0,k);else{if(e)return o(e);r(k)}}},k.printPlugins=C.prettyPrint.bind(C),C.once("preReady",()=>{k.onClose((e,t)=>{if(k[kState].closing=!0,h.closeRoutes(),k[kState].listening){e.server.close(t);for(const r of k[kKeepAliveConnections])r.destroy(),k[kKeepAliveConnections].delete(r)}else t(null)})}),k.setNotFoundHandler(),p.arrange404(k),h.setup(e,{avvio:C,fourOhFour:p,logger:u,hasLogger:c,setupResponseListeners:a,throwIfAlreadyStarted:S}),f.on("clientError",e.clientErrorHandler.bind(k));try{const R=require("diagnostics_channel"),v=R.channel("fastify.initialization");v.hasSubscribers&&v.publish({fastify:k})}catch(e){}return k;function S(e){if(k[kState].started)throw new Error(e)}}function validateSchemaErrorFormatter(e){if("function"!=typeof e)throw new Error(`schemaErrorFormatter option should be a function, instead got ${typeof e}`);if("AsyncFunction"===e.constructor.name)throw new Error("schemaErrorFormatter option should not be an async function")}function wrapRouting(n,{rewriteUrl:i,logger:s}){return i?function(e,t){var r=e.url,o=i(e);r!==o&&(s.debug({originalUrl:r,url:o},"rewrite url"),"string"==typeof o?e.url=o:e.destroy(new Error(`Rewrite url for "${e.url}" needs to be of type "string" but received "${typeof o}"`))),n(e,t)}:n}module.exports=fastify,module.exports.fastify=fastify,module.exports.default=fastify;