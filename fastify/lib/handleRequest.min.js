"use strict";const validateSchema=require("./validation")["validate"],{hookRunner,hookIterator}=require("./hooks"),wrapThenable=require("./wrapThenable"),kReplyIsError=require("./symbols")["kReplyIsError"];function handleRequest(e,n,r){if(!0!==r.sent){if(null!=e)return r[kReplyIsError]=!0,void r.send(e);var t=n.raw.method,a=n.headers;"GET"!==t&&"HEAD"!==t?(e=a["content-type"],"POST"!==t&&"PUT"!==t&&"PATCH"!==t?"OPTIONS"!==t&&"DELETE"!==t||void 0===e||void 0===a["transfer-encoding"]&&void 0===a["content-length"]?handler(n,r):r.context.contentTypeParser.run(e,handler,n,r):void 0===e?void 0!==a["transfer-encoding"]||"0"!==a["content-length"]&&void 0!==a["content-length"]?r.context.contentTypeParser.run("",handler,n,r):handler(n,r):r.context.contentTypeParser.run(e,handler,n,r)):handler(n,r)}}function handler(n,r){try{null!==r.context.preValidation?hookRunner(r.context.preValidation,hookIterator,n,r,preValidationCallback):preValidationCallback(null,n,r)}catch(e){preValidationCallback(e,n,r)}}function preValidationCallback(e,n,r){if(!0!==r.sent){if(null!=e)return r[kReplyIsError]=!0,void r.send(e);e=validateSchema(r.context,n);if(e){if(!1===r.context.attachValidation)return void r.code(400).send(e);r.request.validationError=e}null!==r.context.preHandler?hookRunner(r.context.preHandler,hookIterator,n,r,preHandlerCallback):preHandlerCallback(null,n,r)}}function preHandlerCallback(n,r,t){if(!t.sent){if(null!=n)return t[kReplyIsError]=!0,void t.send(n);let e;try{e=t.context.handler(r,t)}catch(n){return t[kReplyIsError]=!0,void t.send(n)}void 0!==e&&(null!==e&&"function"==typeof e.then?wrapThenable(e,t):t.send(e))}}module.exports=handleRequest,module.exports[Symbol.for("internals")]={handler:handler,preHandlerCallback:preHandlerCallback};