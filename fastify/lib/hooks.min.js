"use strict";const applicationHooks=["onRoute","onRegister","onReady","onClose"],lifecycleHooks=["onTimeout","onRequest","preParsing","preValidation","preSerialization","preHandler","onSend","onResponse","onError"],supportedHooks=lifecycleHooks.concat(applicationHooks),{FST_ERR_HOOK_INVALID_TYPE:FST_ERR_HOOK_INVALID_TYPE,FST_ERR_HOOK_INVALID_HANDLER:FST_ERR_HOOK_INVALID_HANDLER,FST_ERR_SEND_UNDEFINED_ERR:FST_ERR_SEND_UNDEFINED_ERR}=require("./errors"),{kReplyIsError:kReplyIsError,kChildren:kChildren,kHooks:kHooks}=require("./symbols");function Hooks(){this.onRequest=[],this.preParsing=[],this.preValidation=[],this.preSerialization=[],this.preHandler=[],this.onResponse=[],this.onSend=[],this.onError=[],this.onRoute=[],this.onRegister=[],this.onReady=[],this.onTimeout=[]}function buildHooks(o){const n=new Hooks;return n.onRequest=o.onRequest.slice(),n.preParsing=o.preParsing.slice(),n.preValidation=o.preValidation.slice(),n.preSerialization=o.preSerialization.slice(),n.preHandler=o.preHandler.slice(),n.onSend=o.onSend.slice(),n.onResponse=o.onResponse.slice(),n.onError=o.onError.slice(),n.onRoute=o.onRoute.slice(),n.onRegister=o.onRegister.slice(),n.onTimeout=o.onTimeout.slice(),n.onReady=[],n}function hookRunnerApplication(o,n,e,t){const i=e[kHooks][o];let r=0,s=0;function l(o){o?t(o):t()}!function t(u){if(u)return void l(u);if(r===i.length&&s===e[kChildren].length)return void(0===r&&0===s?l():n(function(o,n){l(o),n(o)}));if(r===i.length&&s<e[kChildren].length){const i=e[kChildren][s++];return void hookRunnerApplication(o,n,i,t)}n(function(o,n){return function(e,t){if(e)return void t(e);if(1===o.length){try{o.call(n,t)}catch(o){t(o)}return}const i=o.call(n);i&&"function"==typeof i.then?i.then(t,t):t(e)}}(i[r++],e));t()}()}function hookRunner(o,n,e,t,i){let r=0;function s(c){if(c||r===o.length)return void i(c,e,t);let R;try{R=n(o[r++],e,t,s)}catch(o){return void s(o)}R&&"function"==typeof R.then&&R.then(l,u)}function l(){s()}function u(o){o?o instanceof Error||(t[kReplyIsError]=!0):o=new FST_ERR_SEND_UNDEFINED_ERR,i(o,e,t)}s()}function onSendHookRunner(o,n,e,t,i){let r=0;function s(c,R){if(c)return void i(c,n,e,t);if(void 0!==R&&(t=R),r===o.length){try{i(null,n,e,t)}catch(c){u(c)}return}let p;try{p=o[r++](n,e,t,s)}catch(o){return void s(o)}p&&"function"==typeof p.then&&p.then(l,u)}function l(o){s(null,o)}function u(o){i(o,n,e,t)}s()}function hookIterator(o,n,e,t){if(!0!==e.sent)return o(n,e,t)}Hooks.prototype.validate=function(o,n){if("string"!=typeof o)throw new FST_ERR_HOOK_INVALID_TYPE;if("function"!=typeof n)throw new FST_ERR_HOOK_INVALID_HANDLER;if(-1===supportedHooks.indexOf(o))throw new Error(`${o} hook not supported!`)},Hooks.prototype.add=function(o,n){this.validate(o,n),this[o].push(n)},module.exports={Hooks:Hooks,buildHooks:buildHooks,hookRunner:hookRunner,onSendHookRunner:onSendHookRunner,hookIterator:hookIterator,hookRunnerApplication:hookRunnerApplication,lifecycleHooks:lifecycleHooks};