"use strict";const applicationHooks=["onRoute","onRegister","onReady","onClose"],lifecycleHooks=["onTimeout","onRequest","preParsing","preValidation","preSerialization","preHandler","onSend","onResponse","onError"],supportedHooks=lifecycleHooks.concat(applicationHooks),{FST_ERR_HOOK_INVALID_TYPE,FST_ERR_HOOK_INVALID_HANDLER,FST_ERR_SEND_UNDEFINED_ERR,FST_ERR_HOOK_TIMEOUT,AVVIO_ERRORS_MAP,appendStackTrace}=require("./errors"),{kChildren,kHooks}=require("./symbols");function Hooks(){this.onRequest=[],this.preParsing=[],this.preValidation=[],this.preSerialization=[],this.preHandler=[],this.onResponse=[],this.onSend=[],this.onError=[],this.onRoute=[],this.onRegister=[],this.onReady=[],this.onTimeout=[]}function buildHooks(o){const n=new Hooks;return n.onRequest=o.onRequest.slice(),n.preParsing=o.preParsing.slice(),n.preValidation=o.preValidation.slice(),n.preSerialization=o.preSerialization.slice(),n.preHandler=o.preHandler.slice(),n.onSend=o.onSend.slice(),n.onResponse=o.onResponse.slice(),n.onError=o.onError.slice(),n.onRoute=o.onRoute.slice(),n.onRegister=o.onRegister.slice(),n.onTimeout=o.onTimeout.slice(),n.onReady=[],n}function hookRunnerApplication(t,i,r,n){const s=r[kHooks][t];let l=0,c=0;function u(o){if(o)return o="AVV_ERR_READY_TIMEOUT"===o.code?appendStackTrace(o,new FST_ERR_HOOK_TIMEOUT(t)):null!=AVVIO_ERRORS_MAP[o.code]?appendStackTrace(o,new AVVIO_ERRORS_MAP[o.code](o.message)):o,void n(o);n()}function R(t,i){return function(o,n){if(o)n(o);else if(1!==t.length){const e=t.call(i);e&&"function"==typeof e.then?e.then(n,n):n(o)}else try{t.call(i,n)}catch(o){n(o)}}}!function o(n){if(n)return void u(n);if(l===s.length&&c===r[kChildren].length)return void(0===l&&0===c?u():i(function(o,n){u(o),n(o)}));if(l===s.length&&c<r[kChildren].length){const e=r[kChildren][c++];return void hookRunnerApplication(t,i,e,o)}i(R(s[l++],r));o()}()}function hookRunner(n,e,t,i,r){let s=0;function l(o){if(o||s===n.length)r(o,t,i);else{let o;try{o=e(n[s++],t,i,l)}catch(o){return void l(o)}o&&"function"==typeof o.then&&o.then(c,u)}}function c(){l()}function u(o){o=o||new FST_ERR_SEND_UNDEFINED_ERR,r(o,t,i)}l()}function onSendHookRunner(e,t,i,r,s){let l=0;function c(o,n){if(o)s(o,t,i,r);else if(void 0!==n&&(r=n),l!==e.length){let o;try{o=e[l++](t,i,r,c)}catch(o){return void c(o)}o&&"function"==typeof o.then&&o.then(u,R)}else s(null,t,i,r)}function u(o){c(null,o)}function R(o){s(o,t,i,r)}c()}function hookIterator(o,n,e,t){if(!0!==e.sent)return o(n,e,t)}Hooks.prototype.validate=function(o,n){if("string"!=typeof o)throw new FST_ERR_HOOK_INVALID_TYPE;if("function"!=typeof n)throw new FST_ERR_HOOK_INVALID_HANDLER;if(-1===supportedHooks.indexOf(o))throw new Error(`${o} hook not supported!`)},Hooks.prototype.add=function(o,n){this.validate(o,n),this[o].push(n)},module.exports={Hooks:Hooks,buildHooks:buildHooks,hookRunner:hookRunner,onSendHookRunner:onSendHookRunner,hookIterator:hookIterator,hookRunnerApplication:hookRunnerApplication,lifecycleHooks:lifecycleHooks,supportedHooks:supportedHooks};