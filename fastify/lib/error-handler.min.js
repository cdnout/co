"use strict";const statusCodes=require("http").STATUS_CODES,wrapThenable=require("./wrapThenable"),{kReplyHeaders,kReplyNextErrorHandler,kReplyIsRunningOnErrorHook,kReplyHasStatusCode}=require("./symbols.js"),FST_ERR_REP_INVALID_PAYLOAD_TYPE=require("./errors")["FST_ERR_REP_INVALID_PAYLOAD_TYPE"],getSchemaSerializer=require("./schemas")["getSchemaSerializer"],serializeError=require("./error-serializer"),rootErrorHandler={func:defaultErrorHandler,toJSON(){return this.func.name.toString()+"()"}};function handleError(e,r,t){e[kReplyIsRunningOnErrorHook]=!1;var s=e.context;if(!1!==e[kReplyNextErrorHandler]){s=e[kReplyNextErrorHandler]||s.errorHandler;e[kReplyNextErrorHandler]=Object.getPrototypeOf(s),delete e[kReplyHeaders]["content-length"];const a=s.func;if(!a)return e[kReplyNextErrorHandler]=!1,void fallbackErrorHandler(r,e,t);t=a(r,e.request,e);void 0!==t&&(null!==t&&"function"==typeof t.then?wrapThenable(t,e):e.send(t))}else fallbackErrorHandler(r,e,function(r,e){try{r.raw.writeHead(r.raw.statusCode,r[kReplyHeaders])}catch(e){r.log.warn({req:r.request,res:r,err:e},e&&e.message),r.raw.writeHead(r.raw.statusCode)}r.raw.end(e)})}function defaultErrorHandler(e,r,t){var s;setErrorHeaders(e,t),t[kReplyHasStatusCode]&&200!==t.statusCode||(s=e.statusCode||e.status,t.code(400<=s?s:500)),t.statusCode<500?t.log.info({res:t,err:e},e&&e.message):t.log.error({req:r,res:t,err:e},e&&e.message),t.send(e)}function fallbackErrorHandler(e,r,t){var s=r.raw,a=r.statusCode;let o;try{const n=getSchemaSerializer(r.context,a);o=!1===n?serializeError({error:statusCodes[a+""],code:e.code,message:e.message,statusCode:a}):n(Object.create(e,{error:{value:statusCodes[a+""]},message:{value:e.message},statusCode:{value:a}}))}catch(e){r.log.error({err:e,statusCode:s.statusCode},"The serializer for the given status code failed"),r.code(500),o=serializeError({error:statusCodes[500],message:e.message,statusCode:500})}"string"==typeof o||Buffer.isBuffer(o)||(o=serializeError(new FST_ERR_REP_INVALID_PAYLOAD_TYPE(typeof o))),r[kReplyHeaders]["content-type"]="application/json; charset=utf-8",r[kReplyHeaders]["content-length"]=""+Buffer.byteLength(o),t(r,o)}function buildErrorHandler(e=rootErrorHandler,r){if(!r)return e;const t=Object.create(e);return t.func=r,t}function setErrorHeaders(e,r){const t=r.raw;let s=t.statusCode;s=400<=s?s:500,null!=e&&(void 0!==e.headers&&r.headers(e.headers),400<=e.status?s=e.status:400<=e.statusCode&&(s=e.statusCode)),t.statusCode=s}module.exports={buildErrorHandler:buildErrorHandler,handleError:handleError};