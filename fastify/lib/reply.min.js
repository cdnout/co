"use strict";const eos=require("readable-stream").finished,statusCodes=require("http").STATUS_CODES,flatstr=require("flatstr"),FJS=require("fast-json-stringify"),{kSchemaResponse:kSchemaResponse,kFourOhFourContext:kFourOhFourContext,kReplyErrorHandlerCalled:kReplyErrorHandlerCalled,kReplySent:kReplySent,kReplySentOverwritten:kReplySentOverwritten,kReplyStartTime:kReplyStartTime,kReplySerializer:kReplySerializer,kReplySerializerDefault:kReplySerializerDefault,kReplyIsError:kReplyIsError,kReplyHeaders:kReplyHeaders,kReplyHasStatusCode:kReplyHasStatusCode,kReplyIsRunningOnErrorHook:kReplyIsRunningOnErrorHook,kDisableRequestLogging:kDisableRequestLogging}=require("./symbols.js"),{hookRunner:hookRunner,hookIterator:hookIterator,onSendHookRunner:onSendHookRunner}=require("./hooks"),internals=require("./handleRequest")[Symbol.for("internals")],loggerUtils=require("./logger"),now=loggerUtils.now,wrapThenable=require("./wrapThenable"),serializeError=FJS({type:"object",properties:{statusCode:{type:"number"},code:{type:"string"},error:{type:"string"},message:{type:"string"}}}),CONTENT_TYPE={JSON:"application/json; charset=utf-8",PLAIN:"text/plain; charset=utf-8",OCTET:"application/octet-stream"},{FST_ERR_REP_INVALID_PAYLOAD_TYPE:FST_ERR_REP_INVALID_PAYLOAD_TYPE,FST_ERR_REP_ALREADY_SENT:FST_ERR_REP_ALREADY_SENT,FST_ERR_REP_SENT_VALUE:FST_ERR_REP_SENT_VALUE,FST_ERR_SEND_INSIDE_ONERR:FST_ERR_SEND_INSIDE_ONERR,FST_ERR_BAD_STATUS_CODE:FST_ERR_BAD_STATUS_CODE}=require("./errors"),warning=require("./warnings");function Reply(e,t,r){this.raw=e,this[kReplySent]=!1,this[kReplySerializer]=null,this[kReplyErrorHandlerCalled]=!1,this[kReplyIsError]=!1,this[kReplyIsRunningOnErrorHook]=!1,this.request=t,this[kReplyHeaders]={},this[kReplyHasStatusCode]=!1,this[kReplyStartTime]=void 0,this.log=r}function preserializeHook(e,t){null!==e.context.preSerialization?onSendHookRunner(e.context.preSerialization,e.request,e,t,preserializeHookEnd):preserializeHookEnd(null,e.request,e,t)}function preserializeHookEnd(e,t,r,n){null==e?(n=null!==r[kReplySerializer]?r[kReplySerializer](n):r.context&&r.context[kReplySerializerDefault]?r.context[kReplySerializerDefault](n,r.raw.statusCode):serialize(r.context,n,r.raw.statusCode),flatstr(n),onSendHook(r,n)):onErrorHook(r,e)}function onSendHook(e,t){e[kReplySent]=!0,null!==e.context.onSend?onSendHookRunner(e.context.onSend,e.request,e,t,wrapOnSendEnd):onSendEnd(e,t)}function wrapOnSendEnd(e,t,r,n){null!=e?onErrorHook(r,e):onSendEnd(r,n)}function onSendEnd(e,t){const r=e.raw,n=e.request,o=r.statusCode;if(null==t)return e[kReplySent]=!0,o>=200&&204!==o&&304!==o&&"HEAD"!==n.method&&(e[kReplyHeaders]["content-length"]="0"),r.writeHead(o,e[kReplyHeaders]),void r.end(null,null,null);if("function"!=typeof t.pipe){if("string"!=typeof t&&!Buffer.isBuffer(t))throw new FST_ERR_REP_INVALID_PAYLOAD_TYPE(typeof t);e[kReplyHeaders]["content-length"]||(e[kReplyHeaders]["content-length"]=""+Buffer.byteLength(t)),e[kReplySent]=!0,r.writeHead(o,e[kReplyHeaders]),r.end(t,null,null)}else sendStream(t,r,e)}function logStreamError(e,t,r){"ERR_STREAM_PREMATURE_CLOSE"===t.code?e[kDisableRequestLogging]||e.info({res:r},"stream closed prematurely"):e.warn({err:t},"response terminated with an error with headers already sent")}function sendStream(e,t,r){let n=!0,o=!1;if(eos(e,{readable:!0,writable:!1},function(e){n=!1,null!=e&&(t.headersSent?(o||(o=!0,logStreamError(r.log,e,t)),t.destroy()):onErrorHook(r,e))}),eos(t,function(s){null!=s&&n&&(t.headersSent&&(o||(o=!0,logStreamError(r.log,s,t))),e.destroy?e.destroy():"function"==typeof e.close?e.close(noop):"function"==typeof e.abort&&e.abort())}),t.headersSent)r.log.warn("response will send, but you shouldn't use res.writeHead in stream mode");else for(const e in r[kReplyHeaders])t.setHeader(e,r[kReplyHeaders][e]);e.pipe(t)}function onErrorHook(e,t,r){e[kReplySent]=!0,null!==e.context.onError&&!0===e[kReplyErrorHandlerCalled]?(e[kReplyIsRunningOnErrorHook]=!0,onSendHookRunner(e.context.onError,e.request,e,t,()=>handleError(e,t,r))):handleError(e,t,r)}function handleError(e,t,r){e[kReplyIsRunningOnErrorHook]=!1;const n=e.raw;let o=n.statusCode;o=o>=400?o:500,null!=t&&(void 0!==t.headers&&e.headers(t.headers),t.status>=400?o=t.status:t.statusCode>=400&&(o=t.statusCode)),n.statusCode=o;const s=e.context.errorHandler;if(s&&!1===e[kReplyErrorHandlerCalled]){e[kReplySent]=!1,e[kReplyIsError]=!1,e[kReplyErrorHandlerCalled]=!0,e[kReplyHeaders]["content-length"]=void 0;const r=s(t,e.request,e);return void(r&&"function"==typeof r.then&&wrapThenable(r,e))}const i=getSchemaSerializer(e.context,o),l=!1===i?serializeError({error:statusCodes[o+""],code:t.code,message:t.message||"",statusCode:o}):i(Object.create(t,{error:{value:statusCodes[o+""]},message:{value:t.message||""},statusCode:{value:o}}));flatstr(l),e[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON,e[kReplyHeaders]["content-length"]=""+Buffer.byteLength(l),r?r(e,l):(e[kReplySent]=!0,n.writeHead(n.statusCode,e[kReplyHeaders]),n.end(l))}function setupResponseListeners(e){e[kReplyStartTime]=now();const t=r=>{e.raw.removeListener("finish",t),e.raw.removeListener("error",t);const n=e.context;n&&null!==n.onResponse?hookRunner(n.onResponse,onResponseIterator,e.request,e,onResponseCallback):onResponseCallback(r,e.request,e)};e.raw.on("finish",t),e.raw.on("error",t)}function onResponseIterator(e,t,r,n){return e(t,r,n)}function onResponseCallback(e,t,r){if(r.log[kDisableRequestLogging])return;const n=r.getResponseTime();null==e?r.log.info({res:r,responseTime:n},"request completed"):r.log.error({res:r,err:e,responseTime:n},"request errored")}function buildReply(e){function t(e,t,r){this.raw=e,this[kReplyIsError]=!1,this[kReplyErrorHandlerCalled]=!1,this[kReplySent]=!1,this[kReplySentOverwritten]=!1,this[kReplySerializer]=null,this.request=t,this[kReplyHeaders]={},this[kReplyStartTime]=void 0,this.log=r}return t.prototype=new e,t}function notFound(e){if(e[kReplySent]=!1,e[kReplyIsError]=!1,null===e.context[kFourOhFourContext])return e.log.warn("Trying to send a NotFound error inside a 404 handler. Sending basic 404 response."),void e.code(404).send("404 Not Found");e.request.context=e.context[kFourOhFourContext],null!==e.context.preHandler?hookRunner(e.context.preHandler,hookIterator,e.request,e,internals.preHandlerCallback):internals.preHandlerCallback(null,e.request,e)}function serialize(e,t,r){const n=getSchemaSerializer(e,r);return n?n(t):JSON.stringify(t)}function getSchemaSerializer(e,t){const r=e[kSchemaResponse];if(!r)return!1;if(r[t])return r[t];const n=(t+"")[0]+"xx";return!!r[n]&&r[n]}function noop(){}Object.defineProperties(Reply.prototype,{context:{get(){return this.request.context}},res:{get(){return warning.emit("FSTDEP002"),this.raw}},sent:{enumerable:!0,get(){return this[kReplySent]},set(e){if(!0!==e)throw new FST_ERR_REP_SENT_VALUE;if(this[kReplySent])throw new FST_ERR_REP_ALREADY_SENT;this[kReplySentOverwritten]=!0,this[kReplySent]=!0}},statusCode:{get(){return this.raw.statusCode},set(e){this.code(e)}}}),Reply.prototype.hijack=function(){return this[kReplySent]=!0,this},Reply.prototype.send=function(e){if(!0===this[kReplyIsRunningOnErrorHook])throw new FST_ERR_SEND_INSIDE_ONERR;if(this[kReplySent])return this.log.warn({err:new FST_ERR_REP_ALREADY_SENT},"Reply already sent"),this;if(e instanceof Error||!0===this[kReplyIsError])return onErrorHook(this,e,onSendHook),this;if(void 0===e)return onSendHook(this,e),this;const t=this.getHeader("content-type"),r=void 0!==t;if(null!==e){if(Buffer.isBuffer(e)||"function"==typeof e.pipe)return!1===r&&(this[kReplyHeaders]["content-type"]=CONTENT_TYPE.OCTET),onSendHook(this,e),this;if(!1===r&&"string"==typeof e)return this[kReplyHeaders]["content-type"]=CONTENT_TYPE.PLAIN,onSendHook(this,e),this}if(null!==this[kReplySerializer]){if("string"!=typeof e)return preserializeHook(this,e),this;e=this[kReplySerializer](e)}else if(!1===r||t.indexOf("json")>-1){if(!1===r)this[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON;else if(-1===t.indexOf("charset"))if(t.indexOf("/json")>-1)this[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON;else{const e=this[kReplyHeaders]["content-type"],t=e.substring(e.indexOf("/"),e.indexOf("json")+4);this[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON.replace("/json",t)}if("string"!=typeof e)return preserializeHook(this,e),this}return onSendHook(this,e),this},Reply.prototype.getHeader=function(e){e=e.toLowerCase();const t=this.raw;let r=this[kReplyHeaders][e];return void 0===r&&t.hasHeader(e)&&(r=t.getHeader(e)),r},Reply.prototype.getHeaders=function(){return{...this.raw.getHeaders(),...this[kReplyHeaders]}},Reply.prototype.hasHeader=function(e){return void 0!==this[kReplyHeaders][e.toLowerCase()]},Reply.prototype.removeHeader=function(e){return delete this[kReplyHeaders][e.toLowerCase()],this},Reply.prototype.header=function(e,t){const r=e.toLowerCase();return t=void 0===t?"":t,this[kReplyHeaders][r]&&"set-cookie"===r?("string"==typeof this[kReplyHeaders][r]&&(this[kReplyHeaders][r]=[this[kReplyHeaders][r]]),Array.isArray(t)?Array.prototype.push.apply(this[kReplyHeaders][r],t):this[kReplyHeaders][r].push(t)):this[kReplyHeaders][r]=t,this},Reply.prototype.headers=function(e){const t=Object.keys(e);for(var r=0;r<t.length;r++)this.header(t[r],e[t[r]]);return this},Reply.prototype.code=function(e){const t=parseInt(e);if(isNaN(t)||t<100||t>600)throw new FST_ERR_BAD_STATUS_CODE(e||String(e));return this.raw.statusCode=t,this[kReplyHasStatusCode]=!0,this},Reply.prototype.status=Reply.prototype.code,Reply.prototype.serialize=function(e){return null!==this[kReplySerializer]?this[kReplySerializer](e):this.context&&this.context[kReplySerializerDefault]?this.context[kReplySerializerDefault](e,this.raw.statusCode):serialize(this.context,e,this.raw.statusCode)},Reply.prototype.serializer=function(e){return this[kReplySerializer]=e,this},Reply.prototype.type=function(e){return this[kReplyHeaders]["content-type"]=e,this},Reply.prototype.redirect=function(e,t){"string"==typeof e&&(t=e,e=this[kReplyHasStatusCode]?this.raw.statusCode:302),this.header("location",t).code(e).send()},Reply.prototype.callNotFound=function(){notFound(this)},Reply.prototype.getResponseTime=function(){let e=0;return void 0!==this[kReplyStartTime]&&(e=now()-this[kReplyStartTime]),e},Reply.prototype.then=function(e,t){this.sent?e():eos(this.raw,function(r){r&&"ERR_STREAM_PREMATURE_CLOSE"!==r.code?t&&t(r):e()})},module.exports=Reply,module.exports.buildReply=buildReply,module.exports.setupResponseListeners=setupResponseListeners;