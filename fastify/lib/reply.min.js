"use strict";const eos=require("stream").finished,{kFourOhFourContext,kReplyErrorHandlerCalled,kReplyHijacked,kReplyStartTime,kReplyEndTime,kReplySerializer,kReplySerializerDefault,kReplyIsError,kReplyHeaders,kReplyTrailers,kReplyHasStatusCode,kReplyIsRunningOnErrorHook,kReplyNextErrorHandler,kDisableRequestLogging}=require("./symbols.js"),{hookRunner,hookIterator,onSendHookRunner}=require("./hooks"),internals=require("./handleRequest")[Symbol.for("internals")],loggerUtils=require("./logger"),now=loggerUtils.now,handleError=require("./error-handler")["handleError"],getSchemaSerializer=require("./schemas")["getSchemaSerializer"],CONTENT_TYPE={JSON:"application/json; charset=utf-8",PLAIN:"text/plain; charset=utf-8",OCTET:"application/octet-stream"},{FST_ERR_REP_INVALID_PAYLOAD_TYPE,FST_ERR_REP_ALREADY_SENT,FST_ERR_REP_SENT_VALUE,FST_ERR_SEND_INSIDE_ONERR,FST_ERR_BAD_STATUS_CODE,FST_ERR_BAD_TRAILER_NAME,FST_ERR_BAD_TRAILER_VALUE}=require("./errors"),warning=require("./warnings");function Reply(e,r,t){this.raw=e,this[kReplySerializer]=null,this[kReplyErrorHandlerCalled]=!1,this[kReplyIsError]=!1,this[kReplyIsRunningOnErrorHook]=!1,this.request=r,this[kReplyHeaders]={},this[kReplyTrailers]=null,this[kReplyHasStatusCode]=!1,this[kReplyStartTime]=void 0,this.log=t}Reply.props=[],Object.defineProperties(Reply.prototype,{context:{get(){return this.request.context}},server:{get(){return this.request.context.server}},sent:{enumerable:!0,get(){return!0===(this[kReplyHijacked]||this.raw.writableEnded)},set(e){if(warning.emit("FSTDEP010"),!0!==e)throw new FST_ERR_REP_SENT_VALUE;if(this.sent&&this[kReplyHijacked])throw new FST_ERR_REP_ALREADY_SENT;this[kReplyHijacked]=!0}},statusCode:{get(){return this.raw.statusCode},set(e){this.code(e)}}}),Reply.prototype.hijack=function(){return this[kReplyHijacked]=!0,this},Reply.prototype.send=function(e){if(!0===this[kReplyIsRunningOnErrorHook])throw new FST_ERR_SEND_INSIDE_ONERR;if(this.sent)return this.log.warn({err:new FST_ERR_REP_ALREADY_SENT},"Reply already sent"),this;if(e instanceof Error||!0===this[kReplyIsError])return this[kReplyIsError]=!1,onErrorHook(this,e,onSendHook),this;if(void 0===e)return onSendHook(this,e),this;const r=this.getHeader("content-type");var t=void 0!==r;if(null!==e){if("function"==typeof e.pipe)return onSendHook(this,e),this;if(Buffer.isBuffer(e))return!1==t&&(this[kReplyHeaders]["content-type"]=CONTENT_TYPE.OCTET),onSendHook(this,e),this;if(!1==t&&"string"==typeof e)return this[kReplyHeaders]["content-type"]=CONTENT_TYPE.PLAIN,onSendHook(this,e),this}if(null!==this[kReplySerializer]){if("string"!=typeof e)return preserializeHook(this,e),this;e=this[kReplySerializer](e)}else if(!1==t||-1<r.indexOf("json")){if(!1==t)this[kReplyHeaders]["content-type"]=CONTENT_TYPE.JSON;else if(-1===r.indexOf("charset")){const n=r.trim();n.endsWith(";")?this[kReplyHeaders]["content-type"]=`${n} charset=utf-8`:this[kReplyHeaders]["content-type"]=`${n}; charset=utf-8`}if("string"!=typeof e)return preserializeHook(this,e),this}return onSendHook(this,e),this},Reply.prototype.getHeader=function(e){e=e.toLowerCase();const r=this.raw;let t=this[kReplyHeaders][e];return void 0===t&&r.hasHeader(e)&&(t=r.getHeader(e)),t},Reply.prototype.getHeaders=function(){return{...this.raw.getHeaders(),...this[kReplyHeaders]}},Reply.prototype.hasHeader=function(e){return e=e.toLowerCase(),void 0!==this[kReplyHeaders][e]||this.raw.hasHeader(e)},Reply.prototype.removeHeader=function(e){return delete this[kReplyHeaders][e.toLowerCase()],this},Reply.prototype.header=function(e,r){e=e.toLowerCase();return r=void 0===r?"":r,this[kReplyHeaders][e]&&"set-cookie"===e?("string"==typeof this[kReplyHeaders][e]&&(this[kReplyHeaders][e]=[this[kReplyHeaders][e]]),Array.isArray(r)?Array.prototype.push.apply(this[kReplyHeaders][e],r):this[kReplyHeaders][e].push(r)):this[kReplyHeaders][e]=r,this},Reply.prototype.headers=function(e){for(var r=Object.keys(e),t=0;t!==r.length;++t){var n=r[t];this.header(n,e[n])}return this};const INVALID_TRAILERS=new Set(["transfer-encoding","content-length","host","cache-control","max-forwards","te","authorization","set-cookie","content-encoding","content-type","content-range","trailer"]);function preserializeHook(e,r){null!==e.context.preSerialization?onSendHookRunner(e.context.preSerialization,e.request,e,r,preserializeHookEnd):preserializeHookEnd(null,e.request,e,r)}function preserializeHookEnd(e,r,t,n){if(null==e){try{n=null!==t[kReplySerializer]?t[kReplySerializer](n):t.context&&t.context[kReplySerializerDefault]?t.context[kReplySerializerDefault](n,t.raw.statusCode):serialize(t.context,n,t.raw.statusCode)}catch(e){return wrapSeralizationError(e,t),void onErrorHook(t,e)}onSendHook(t,n)}else onErrorHook(t,e)}function wrapSeralizationError(e,r){e.serialization=r.context.config}function onSendHook(e,r){null!==e.context.onSend?onSendHookRunner(e.context.onSend,e.request,e,r,wrapOnSendEnd):onSendEnd(e,r)}function wrapOnSendEnd(e,r,t,n){null!=e?onErrorHook(t,e):onSendEnd(t,n)}function onSendEnd(r,e){const t=r.raw;var n=r.request,o=t.statusCode;if(null!==r[kReplyTrailers]){let e="";for(const i of Object.keys(r[kReplyTrailers]))"function"==typeof r[kReplyTrailers][i]&&(e+=" ",e+=i);r.header("Transfer-Encoding","chunked"),r.header("Trailer",e.trim())}if(null==e)return 200<=o&&204!==o&&304!==o&&"HEAD"!==n.method&&null===r[kReplyTrailers]&&(r[kReplyHeaders]["content-length"]="0"),t.writeHead(o,r[kReplyHeaders]),sendTrailer(e,t,r),void t.end(null,null,null);if("function"!=typeof e.pipe){if("string"!=typeof e&&!Buffer.isBuffer(e))throw new FST_ERR_REP_INVALID_PAYLOAD_TYPE(typeof e);null!==r[kReplyTrailers]||r[kReplyHeaders]["content-length"]&&("HEAD"===n.raw.method||r[kReplyHeaders]["content-length"]===Buffer.byteLength(e))||(r[kReplyHeaders]["content-length"]=""+Buffer.byteLength(e)),t.writeHead(o,r[kReplyHeaders]),t.write(e),sendTrailer(e,t,r),t.end(null,null,null)}else sendStream(e,t,r)}function logStreamError(e,r,t){"ERR_STREAM_PREMATURE_CLOSE"===r.code?e[kDisableRequestLogging]||e.info({res:t},"stream closed prematurely"):e.warn({err:r},"response terminated with an error with headers already sent")}function sendStream(r,t,n){let o=!0,i=!1;if(sendStreamTrailer(r,t,n),eos(r,{readable:!0,writable:!1},function(e){o=!1,null!=e&&(t.headersSent||!0===n.request.raw.aborted?(i||(i=!0,logStreamError(n.log,e,t)),t.destroy()):onErrorHook(n,e))}),eos(t,function(e){o&&(null!=e&&t.headersSent&&!i&&(i=!0,logStreamError(n.log,e,t)),"function"==typeof r.destroy?r.destroy():"function"==typeof r.close?r.close(noop):"function"==typeof r.abort?r.abort():n.log.warn("stream payload does not end properly"))}),t.headersSent)n.log.warn("response will send, but you shouldn't use res.writeHead in stream mode");else for(const e in n[kReplyHeaders])t.setHeader(e,n[kReplyHeaders][e]);r.pipe(t)}function sendTrailer(e,r,t){if(null!==t[kReplyTrailers]){const n={};for(const o of Object.keys(t[kReplyTrailers]))"function"==typeof t[kReplyTrailers][o]&&(n[o]=t[kReplyTrailers][o](t,e));r.addTrailers(n)}}function sendStreamTrailer(e,r,t){null!==t[kReplyTrailers]&&e.on("end",()=>sendTrailer(null,r,t))}function onErrorHook(e,r,t){null===e.context.onError||e[kReplyNextErrorHandler]?handleError(e,r,t):(e[kReplyIsRunningOnErrorHook]=!0,onSendHookRunner(e.context.onError,e.request,e,r,()=>handleError(e,r,t)))}function setupResponseListeners(t){t[kReplyStartTime]=now();const n=e=>{t[kReplyEndTime]=now(),t.raw.removeListener("finish",n),t.raw.removeListener("error",n);var r=t.context;r&&null!==r.onResponse?hookRunner(r.onResponse,onResponseIterator,t.request,t,onResponseCallback):onResponseCallback(e,t.request,t)};t.raw.on("finish",n),t.raw.on("error",n)}function onResponseIterator(e,r,t,n){return e(r,t,n)}function onResponseCallback(e,r,t){var n;t.log[kDisableRequestLogging]||(n=t.getResponseTime(),null==e?t.log.info({res:t,responseTime:n},"request completed"):t.log.error({res:t,err:e,responseTime:n},"request errored"))}function buildReply(e){const i=[...e.props];function r(e,r,t){var n;this.raw=e,this[kReplyIsError]=!1,this[kReplyErrorHandlerCalled]=!1,this[kReplyHijacked]=!1,this[kReplySerializer]=null,this.request=r,this[kReplyHeaders]={},this[kReplyTrailers]=null,this[kReplyStartTime]=void 0,this[kReplyEndTime]=void 0,this.log=t;for(var o=0;o<i.length;o++)this[(n=i[o]).key]=n.value}return Object.setPrototypeOf(r.prototype,e.prototype),Object.setPrototypeOf(r,e),r.parent=e,r.props=i,r}function notFound(e){if(null===e.context[kFourOhFourContext])return e.log.warn("Trying to send a NotFound error inside a 404 handler. Sending basic 404 response."),void e.code(404).send("404 Not Found");e.request.context=e.context[kFourOhFourContext],null!==e.context.preHandler?hookRunner(e.context.preHandler,hookIterator,e.request,e,internals.preHandlerCallback):internals.preHandlerCallback(null,e.request,e)}function serialize(e,r,t){const n=getSchemaSerializer(e,t);return n?n(r):JSON.stringify(r)}function noop(){}Reply.prototype.trailer=function(e,r){if(e=e.toLowerCase(),INVALID_TRAILERS.has(e))throw new FST_ERR_BAD_TRAILER_NAME(e);if("function"!=typeof r)throw new FST_ERR_BAD_TRAILER_VALUE(e,typeof r);return null===this[kReplyTrailers]&&(this[kReplyTrailers]={}),this[kReplyTrailers][e]=r,this},Reply.prototype.hasTrailer=function(e){return null!==this[kReplyTrailers]&&void 0!==this[kReplyTrailers][e.toLowerCase()]},Reply.prototype.removeTrailer=function(e){return null===this[kReplyTrailers]||(this[kReplyTrailers][e.toLowerCase()]=void 0),this},Reply.prototype.code=function(e){var r=parseInt(e);if(isNaN(r)||r<100||600<r)throw new FST_ERR_BAD_STATUS_CODE(e||String(e));return this.raw.statusCode=r,this[kReplyHasStatusCode]=!0,this},Reply.prototype.status=Reply.prototype.code,Reply.prototype.serialize=function(e){return null!==this[kReplySerializer]?this[kReplySerializer](e):this.context&&this.context[kReplySerializerDefault]?this.context[kReplySerializerDefault](e,this.raw.statusCode):serialize(this.context,e,this.raw.statusCode)},Reply.prototype.serializer=function(e){return this[kReplySerializer]=e,this},Reply.prototype.type=function(e){return this[kReplyHeaders]["content-type"]=e,this},Reply.prototype.redirect=function(e,r){"string"==typeof e&&(r=e,e=this[kReplyHasStatusCode]?this.raw.statusCode:302),this.header("location",r).code(e).send()},Reply.prototype.callNotFound=function(){notFound(this)},Reply.prototype.getResponseTime=function(){let e=0;return void 0!==this[kReplyStartTime]&&(e=(this[kReplyEndTime]||now())-this[kReplyStartTime]),e},Reply.prototype.then=function(r,t){this.sent?r():eos(this.raw,e=>{e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code?t?t(e):this.log&&this.log.warn("unhandled rejection on reply.then"):r()})},module.exports=Reply,module.exports.buildReply=buildReply,module.exports.setupResponseListeners=setupResponseListeners;