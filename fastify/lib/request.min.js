"use strict";const proxyAddr=require("proxy-addr"),semver=require("semver"),warning=require("./warnings"),kHasBeenDecorated=require("./symbols")["kHasBeenDecorated"];function Request(t,e,r,s,i,o){this.id=t,this.context=o,this.params=e,this.raw=r,this.query=s,this.log=i,this.body=void 0}function getTrustProxyFn(r){if("function"==typeof r)return r;if(!0===r)return function(){return!0};if("number"==typeof r)return function(t,e){return e<r};if("string"!=typeof r)return proxyAddr.compile(r);var t=r.split(",").map(t=>t.trim());return proxyAddr.compile(t)}function buildRequest(t,e){return e?buildRequestWithTrustProxy(t,e):buildRegularRequest(t)}function buildRegularRequest(t){const a=[...t.props];function e(t,e,r,s,i,o){var n;this.id=t,this.context=o,this.params=e,this.raw=r,this.query=s,this.log=i,this.body=void 0;for(var u=0;u<a.length;u++)this[(n=a[u]).key]=n.value}return Object.setPrototypeOf(e.prototype,Request.prototype),Object.setPrototypeOf(e,Request),e.props=a,e.parent=t,e}function getLastEntryInMultiHeaderValue(t){var e=t.lastIndexOf(",");return(-1===e?t:t.slice(e+1)).trim()}function buildRequestWithTrustProxy(t,e){const r=buildRegularRequest(t),s=getTrustProxyFn(e);return r[kHasBeenDecorated]=!0,Object.defineProperties(r.prototype,{ip:{get(){return proxyAddr(this.raw,s)}},ips:{get(){return proxyAddr.all(this.raw,s)}},hostname:{get(){return void 0!==this.ip&&this.headers["x-forwarded-host"]?getLastEntryInMultiHeaderValue(this.headers["x-forwarded-host"]):this.headers.host||this.headers[":authority"]}},protocol:{get(){return this.headers["x-forwarded-proto"]?getLastEntryInMultiHeaderValue(this.headers["x-forwarded-proto"]):this.socket?this.socket.encrypted?"https":"http":void 0}}}),r}Request.props=[],Object.defineProperties(Request.prototype,{server:{get(){return this.context.server}},url:{get(){return this.raw.url}},method:{get(){return this.raw.method}},routerPath:{get(){return this.context.config.url}},routerMethod:{get(){return this.context.config.method}},is404:{get(){return void 0===this.context.config.url}},connection:{get(){return semver.gte(process.versions.node,"13.0.0")&&warning.emit("FSTDEP005"),this.raw.connection}},socket:{get(){return this.raw.socket}},ip:{get(){if(this.socket)return this.socket.remoteAddress}},hostname:{get(){return this.raw.headers.host||this.raw.headers[":authority"]}},protocol:{get(){if(this.socket)return this.socket.encrypted?"https":"http"}},headers:{get(){return this.additionalHeaders?Object.assign({},this.raw.headers,this.additionalHeaders):this.raw.headers},set(t){this.additionalHeaders=t}}}),module.exports=Request,module.exports.buildRequest=buildRequest;