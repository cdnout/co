"use strict";const proxyAddr=require("proxy-addr"),semver=require("semver"),warning=require("./warnings");function Request(t,e,r,s,i,o){this.id=t,this.context=o,this.params=e,this.raw=r,this.query=s,this.log=i,this.body=null}function getTrustProxyFn(t){if("function"==typeof t)return t;if(!0===t)return function(){return!0};if("number"==typeof t)return function(e,r){return r<t};if("string"==typeof t){const e=t.split(",").map(t=>t.trim());return proxyAddr.compile(e)}return proxyAddr.compile(t)}function buildRequest(t,e){return e?buildRequestWithTrustProxy(t,e):buildRegularRequest(t)}function buildRegularRequest(t){function e(t,e,r,s,i,o){this.id=t,this.context=o,this.params=e,this.raw=r,this.query=s,this.log=i,this.body=null}return e.prototype=new t,e}function getLastEntryInMultiHeaderValue(t){const e=t.lastIndexOf(",");return-1===e?t.trim():t.slice(e+1).trim()}function buildRequestWithTrustProxy(t,e){const r=buildRegularRequest(t),s=getTrustProxyFn(e);return Object.defineProperties(r.prototype,{ip:{get(){return proxyAddr(this.raw,s)}},ips:{get(){return proxyAddr.all(this.raw,s)}},hostname:{get(){return void 0!==this.ip&&this.headers["x-forwarded-host"]?getLastEntryInMultiHeaderValue(this.headers["x-forwarded-host"]):this.headers.host||this.headers[":authority"]}},protocol:{get(){return this.headers["x-forwarded-proto"]?getLastEntryInMultiHeaderValue(this.headers["x-forwarded-proto"]):this.socket.encrypted?"https":"http"}}}),r}Object.defineProperties(Request.prototype,{req:{get(){return warning.emit("FSTDEP001"),this.raw}},url:{get(){return this.raw.url}},method:{get(){return this.raw.method}},routerPath:{get(){return this.context.config.url}},routerMethod:{get(){return this.context.config.method}},is404:{get(){return void 0===this.context.config.url}},connection:{get(){return semver.gte(process.versions.node,"13.0.0")&&warning.emit("FSTDEP005"),this.raw.connection}},socket:{get(){return this.raw.socket}},ip:{get(){return this.socket.remoteAddress}},hostname:{get(){return this.raw.headers.host||this.raw.headers[":authority"]}},protocol:{get(){return this.socket.encrypted?"https":"http"}},headers:{get(){return this.raw.headers}}}),module.exports=Request,module.exports.buildRequest=buildRequest;