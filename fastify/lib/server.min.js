"use strict";const http=require("http"),https=require("https"),dns=require("dns"),warnings=require("./warnings"),{kState,kOptions,kServerBindings}=require("./symbols"),{FST_ERR_HTTP2_INVALID_VERSION,FST_ERR_REOPENED_CLOSE_SERVER,FST_ERR_REOPENED_SERVER}=require("./errors");function createServer(i,o){const l=getServerInstance(i,o);return{server:l,listen:function(r,...e){let s=e.slice(-1).pop();var t=Object.prototype.toString.call(arguments[0]);0===arguments.length?r=normalizeListenArgs([]):0<arguments.length&&"[object Object]"!==t&&"[object Function]"!==t?(warnings.emit("FSTDEP011"),r=normalizeListenArgs(Array.from(arguments)),s=r.cb):1<e.length?(warnings.emit("FSTDEP011"),t=r.path?[r.path]:[r.port??0,r.host??"localhost"],Object.assign(r,normalizeListenArgs([...t,...e]))):r.cb=s;var{host:e="localhost"}=r;!1===Object.prototype.hasOwnProperty.call(r,"host")&&(r.host=e);"localhost"===e&&(r.cb=(e,t)=>{e?s(e,t):multipleBindings.call(this,l,o,i,r,()=>{this[kState].listening=!0,s(null,t)})});if(void 0===s){const n=listenPromise.call(this,l,r);return"localhost"===e?n.then(s=>new Promise((e,t)=>{multipleBindings.call(this,l,o,i,r,()=>{this[kState].listening=!0,e(s)})})):n}this.ready(listenCallback.call(this,l,r))}}}function multipleBindings(h,u,S,p,g){this[kState].listening=!1,dns.lookup(p.host,{all:!0},(e,r)=>{if(e)g();else{let t=0,s=0;var n=h.address();for(const l of r)if(l.address!==n.address){t++;var i=Object.assign({},p,{host:l.address,port:n.port,cb:e=>{s++,e||this[kServerBindings].push(c),s===t&&g()}});const c=getServerInstance(S,u);var o=()=>{c.close(()=>{})};h.on("unref",o),h.on("close",o),h.on("error",o),listenCallback.call(this,c,i)()}if(0!==t){const a=h.unref;h.unref=function(){a.call(h),h.emit("unref")}}else g()}})}function listenCallback(t,s){const r=e=>{t.removeListener("error",r),e?(this[kState].listening=!1,s.cb(e,null)):(e=logServerAddress.call(this,t),s.cb(null,e))};return e=>null!=e?s.cb(e):this[kState].listening&&this[kState].closing?s.cb(new FST_ERR_REOPENED_CLOSE_SERVER,null):this[kState].listening?s.cb(new FST_ERR_REOPENED_SERVER,null):(t.once("error",r),t.listen(s,r),void(this[kState].listening=!0))}function listenPromise(r,n){return this[kState].listening&&this[kState].closing?Promise.reject(new FST_ERR_REOPENED_CLOSE_SERVER):this[kState].listening?Promise.reject(new FST_ERR_REOPENED_SERVER):this.ready().then(()=>{let s;var e=new Promise((e,t)=>{s=e=>{this[kState].listening=!1,t(e)},r.once("error",s)}),t=new Promise((e,t)=>{r.listen(n,()=>{r.removeListener("error",s),e(logServerAddress.call(this,r))}),this[kState].listening=!0});return Promise.race([e,t])})}function getServerInstance(e,t){let s=null;return e.serverFactory?s=e.serverFactory(t,e):e.http2?(s=e.https?http2().createSecureServer(e.https,t):http2().createServer(t),s.on("session",sessionTimeout(e.http2SessionTimeout))):(s=e.https?https.createServer(e.https,t):http.createServer(t),s.keepAliveTimeout=e.keepAliveTimeout,s.requestTimeout=e.requestTimeout,0<e.maxRequestsPerSocket&&(s.maxRequestsPerSocket=e.maxRequestsPerSocket)),e.serverFactory||s.setTimeout(e.connectionTimeout),s}function normalizeListenArgs(e){if(0===e.length)return{port:0,host:"localhost"};const t={cb:"function"==typeof e[e.length-1]?e.pop():void 0};var s=e[0],r=e.length,n=e[r-1];return"string"==typeof s&&isNaN(s)?(t.path=s,t.backlog=1<r?n:void 0):(t.port=1<=r&&Number.isInteger(s)?s:0,t.host=2<=r&&e[1]?e[1]:"localhost",t.backlog=3<=r?e[2]:void 0),t}function logServerAddress(e){let t=e.address();e="string"==typeof t;return e||(t=-1===t.address.indexOf(":")?t.address+":"+t.port:"["+t.address+"]:"+t.port),t=(e?"":"http"+(this[kOptions].https?"s":"")+"://")+t,this.log.info("Server listening at "+t),t}function http2(){try{return require("http2")}catch(e){throw new FST_ERR_HTTP2_INVALID_VERSION}}function sessionTimeout(t){return function(e){e.setTimeout(t,close)}}function close(){this.close()}module.exports=createServer;