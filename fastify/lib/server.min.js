"use strict";const assert=require("assert"),http=require("http"),https=require("https"),{kState:kState,kOptions:kOptions}=require("./symbols"),{FST_ERR_HTTP2_INVALID_VERSION:FST_ERR_HTTP2_INVALID_VERSION,FST_ERR_REOPENED_CLOSE_SERVER:FST_ERR_REOPENED_CLOSE_SERVER,FST_ERR_REOPENED_SERVER:FST_ERR_REOPENED_SERVER}=require("./errors");function createServer(e,t){assert(e,"Missing options"),assert(t,"Missing http handler");let r=null;return e.serverFactory?r=e.serverFactory(t,e):e.https?e.http2?(r=http2().createSecureServer(e.https,t)).on("session",sessionTimeout(e.http2SessionTimeout)):(r=https.createServer(e.https,t)).keepAliveTimeout=e.keepAliveTimeout:e.http2?(r=http2().createServer(t)).on("session",sessionTimeout(e.http2SessionTimeout)):(r=http.createServer(t)).keepAliveTimeout=e.keepAliveTimeout,e.serverFactory||r.setTimeout(e.connectionTimeout),{server:r,listen:function(){const e=(e=>{if(0===e.length)return{port:0,host:"localhost"};const t="function"==typeof e[e.length-1]?e.pop():void 0,r={cb:t},s=e[0],i=e.length,n=e[i-1];return"object"==typeof s&&null!==s?(r.backlog=i>1?n:void 0,Object.assign(r,s)):"string"==typeof s&&isNaN(s)?(r.path=s,r.backlog=i>1?n:void 0):(r.port=i>=1&&s?s:0,r.host=i>=2&&e[1]?e[1]:"localhost",r.backlog=i>=3?e[2]:void 0),r})(Array.from(arguments)),t=e.cb,s=e=>{if(r.removeListener("error",s),e)this[kState].listening=!1,t(e,null);else{const e=i();t(null,e)}},i=()=>{let e=r.address();const t="string"==typeof e;return t||(e=-1===e.address.indexOf(":")?e.address+":"+e.port:"["+e.address+"]:"+e.port),e=(t?"":"http"+(this[kOptions].https?"s":"")+"://")+e,this.log.info("Server listening at "+e),e};if(void 0===t)return(e=>{if(this[kState].listening&&this[kState].closing)return Promise.reject(new FST_ERR_REOPENED_CLOSE_SERVER);if(this[kState].listening)return Promise.reject(new FST_ERR_REOPENED_SERVER);return this.ready().then(()=>{let t;const s=new Promise((e,s)=>{t=(e=>{this[kState].listening=!1,s(e)}),r.once("error",t)}),n=new Promise((s,n)=>{r.listen(e,()=>{r.removeListener("error",t),s(i())}),this[kState].listening=!0});return Promise.race([s,n])})})(e);this.ready(i=>null!=i?t(i):this[kState].listening&&this[kState].closing?t(new FST_ERR_REOPENED_CLOSE_SERVER,null):this[kState].listening?t(new FST_ERR_REOPENED_SERVER,null):(r.once("error",s),r.listen(e,s),void(this[kState].listening=!0)))}}}function http2(){try{return require("http2")}catch(e){throw new FST_ERR_HTTP2_INVALID_VERSION}}function sessionTimeout(e){return function(t){t.setTimeout(e,close)}}function close(){this.close()}module.exports={createServer:createServer};