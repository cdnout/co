"use strict";const FindMyWay=require("find-my-way"),Reply=require("./reply"),Request=require("./request"),Context=require("./context"),{kRoutePrefix,kCanSetNotFoundHandler,kFourOhFourLevelInstance,kFourOhFourContext,kHooks}=require("./symbols.js"),lifecycleHooks=require("./hooks")["lifecycleHooks"],buildErrorHandler=require("./error-handler.js")["buildErrorHandler"],fourOhFourContext={config:{},onSend:[],onError:[],errorHandler:buildErrorHandler()};function fourOhFour(e){const{logger:u,genReqId:a}=e,l=FindMyWay({onBadUrl:function(e,o,r){var n=a(o),t=u.child({reqId:n}),i=this[kFourOhFourLevelInstance][kFourOhFourContext],i=new Request(n,null,o,null,t,i),t=new Reply(r,i,t);d(i,t)},defaultRoute:function(e,o){const r=a(e),n=u.child({reqId:r});n.info({req:e},"incoming request");const t=new Request(r,null,e,null,n,fourOhFourContext),i=new Reply(o,t,n);t.log.warn("the default handler for 404 did not catch this, this is likely a fastify bug, please report it"),t.log.warn(l.prettyPrint()),i.code(404).send(new Error("Not Found"))}});let d=null;return{router:l,setNotFoundHandler:function(r,n,t,i){void 0===this[kCanSetNotFoundHandler]&&(this[kCanSetNotFoundHandler]=!0);void 0===this[kFourOhFourContext]&&(this[kFourOhFourContext]=null);const o=this,u=this[kRoutePrefix]||"/";if(!1===this[kCanSetNotFoundHandler])throw new Error(`Not found handler already set for Fastify instance with prefix: '${u}'`);"object"==typeof r&&(r.preHandler&&(Array.isArray(r.preHandler)?r.preHandler=r.preHandler.map(e=>e.bind(o)):r.preHandler=r.preHandler.bind(o)),r.preValidation&&(Array.isArray(r.preValidation)?r.preValidation=r.preValidation.map(e=>e.bind(o)):r.preValidation=r.preValidation.bind(o)));"function"==typeof r&&(n=r,r=void 0);r=r||{},d=n?(this[kFourOhFourLevelInstance][kCanSetNotFoundHandler]=!1,n=n.bind(this),n):(n=s,s);this.after((e,o)=>{!function(e,n,o,r,t){o=new Context({schema:n.schema,handler:o,config:n.config||{},server:this});r.once("preReady",()=>{const e=this[kFourOhFourContext];for(const r of lifecycleHooks){var o=this[kHooks][r].concat(n[r]||[]).map(e=>e.bind(this));e[r]=o.length?o:null}}),null===this[kFourOhFourContext]||"/"!==e?(this[kFourOhFourLevelInstance][kFourOhFourContext]=o,l.all(e+(e.endsWith("/")?"*":"/*"),t,o),l.all(e,t,o)):Object.assign(this[kFourOhFourContext],o)}.call(this,u,r,n,t,i),o(e)})},setContext:function(e,o){const r=Object.assign({},e[kFourOhFourContext]);r.onSend=o.onSend,o[kFourOhFourContext]=r},arrange404:function(e){(e[kFourOhFourLevelInstance]=e)[kCanSetNotFoundHandler]=!0,l.onBadUrl=l.onBadUrl.bind(e)}};function s(e,o){var{url:r,method:n}=e.raw,r=`Route ${n}:${r} not found`;e.log.info(r),o.code(404).send({message:r,error:"Not Found",statusCode:404})}}module.exports=fourOhFour;