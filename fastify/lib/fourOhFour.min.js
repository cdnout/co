"use strict";const FindMyWay=require("find-my-way"),Reply=require("./reply"),Request=require("./request"),Context=require("./context"),{kRoutePrefix:kRoutePrefix,kCanSetNotFoundHandler:kCanSetNotFoundHandler,kFourOhFourLevelInstance:kFourOhFourLevelInstance,kReply:kReply,kRequest:kRequest,kContentTypeParser:kContentTypeParser,kBodyLimit:kBodyLimit,kLogLevel:kLogLevel,kFourOhFourContext:kFourOhFourContext,kHooks:kHooks,kErrorHandler:kErrorHandler}=require("./symbols.js"),{lifecycleHooks:lifecycleHooks}=require("./hooks"),fourOhFourContext={config:{},onSend:[],onError:[]};function fourOhFour(e){const{logger:o,genReqId:t}=e,n=FindMyWay({defaultRoute:function(e,r){const i=t(e),u=o.child({reqId:i});u.info({req:e},"incoming request");const s=new Request(i,null,e,null,u,fourOhFourContext),a=new Reply(r,s,u);s.log.warn("the default handler for 404 did not catch this, this is likely a fastify bug, please report it"),s.log.warn(n.prettyPrint()),a.code(404).send(new Error("Not Found"))}});return{router:n,setNotFoundHandler:function(e,o,t,i){void 0===this[kCanSetNotFoundHandler]&&(this[kCanSetNotFoundHandler]=!0);void 0===this[kFourOhFourContext]&&(this[kFourOhFourContext]=null);const u=this,s=this[kRoutePrefix]||"/";if(!1===this[kCanSetNotFoundHandler])throw new Error(`Not found handler already set for Fastify instance with prefix: '${s}'`);"object"==typeof e&&(e.preHandler&&(Array.isArray(e.preHandler)?e.preHandler=e.preHandler.map(e=>e.bind(u)):e.preHandler=e.preHandler.bind(u)),e.preValidation&&(Array.isArray(e.preValidation)?e.preValidation=e.preValidation.map(e=>e.bind(u)):e.preValidation=e.preValidation.bind(u)));"function"==typeof e&&(o=e,e=void 0);e=e||{},o?(this[kFourOhFourLevelInstance][kCanSetNotFoundHandler]=!1,o=o.bind(this)):o=r;this.after((r,u)=>{(function(e,o,t,r,i){const u=new Context(o.schema,t,this[kReply],this[kRequest],this[kContentTypeParser],o.config||{},this[kErrorHandler],this[kBodyLimit],this[kLogLevel]);if(r.once("preReady",()=>{const e=this[kFourOhFourContext];for(const t of lifecycleHooks){const n=this[kHooks][t].concat(o[t]||[]).map(e=>e.bind(this));e[t]=n.length?n:null}}),null!==this[kFourOhFourContext]&&"/"===e)return void Object.assign(this[kFourOhFourContext],u);this[kFourOhFourLevelInstance][kFourOhFourContext]=u,n.all(e+(e.endsWith("/")?"*":"/*"),i,u),n.all(e,i,u)}).call(this,s,e,o,t,i),u(r)})},setContext:function(e,o){const t=Object.assign({},e[kFourOhFourContext]);t.onSend=o.onSend,o[kFourOhFourContext]=t},arrange404:function(e){e[kFourOhFourLevelInstance]=e,e[kCanSetNotFoundHandler]=!0}};function r(e,o){const{url:t,method:n}=e.raw,r=`Route ${n}:${t} not found`;e.log.info(r),o.code(404).send({message:r,error:"Not Found",statusCode:404})}}module.exports=fourOhFour;