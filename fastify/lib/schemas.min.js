"use strict";const fastClone=require("rfdc")({circles:!1,proto:!0}),{kSchemaVisited:kSchemaVisited}=require("./symbols"),kFluentSchema=Symbol.for("fluent-schema-object"),{FST_ERR_SCH_MISSING_ID:FST_ERR_SCH_MISSING_ID,FST_ERR_SCH_ALREADY_PRESENT:FST_ERR_SCH_ALREADY_PRESENT,FST_ERR_SCH_DUPLICATE:FST_ERR_SCH_DUPLICATE}=require("./errors"),SCHEMAS_SOURCE=["params","body","querystring","query","headers"];function Schemas(e){this.store=e||{}}function normalizeSchema(e){if(e[kSchemaVisited])return e;if(e.query){if(e.querystring)throw new FST_ERR_SCH_DUPLICATE("querystring");e.querystring=e.query}generateFluentSchema(e);for(const t of["headers","querystring","params","body"])if("object"==typeof e[t]&&Object.getPrototypeOf(e[t])!==Object.prototype)return e;if(e.body&&(e.body=getSchemaAnyway(e.body)),e.headers&&(e.headers=getSchemaAnyway(e.headers)),e.querystring&&(e.querystring=getSchemaAnyway(e.querystring)),e.params&&(e.params=getSchemaAnyway(e.params)),e.response){const t=Object.keys(e.response);for(const r of t)e.response[r]=getSchemaAnyway(e.response[r])}return e[kSchemaVisited]=!0,e}function generateFluentSchema(e){for(const t of SCHEMAS_SOURCE)e[t]&&(e[t].isFluentSchema||e[t][kFluentSchema])&&(e[t]=e[t].valueOf());if(e.response){const t=Object.keys(e.response);for(const r of t)(e.response[r].isFluentSchema||e.response[r][kFluentSchema])&&(e.response[r]=e.response[r].valueOf())}}function getSchemaAnyway(e){return e.$ref||e.oneOf||e.allOf||e.anyOf||e.$merge||e.$patch?e:e.type||e.properties?e:{type:"object",properties:e}}Schemas.prototype.add=function(e){const t=fastClone(e.isFluentSchema||e.isFluentJSONSchema||e[kFluentSchema]?e.valueOf():e),r=t.$id;if(!r)throw new FST_ERR_SCH_MISSING_ID;if(this.store[r])throw new FST_ERR_SCH_ALREADY_PRESENT(r);this.store[r]=t},Schemas.prototype.getSchemas=function(){return Object.assign({},this.store)},Schemas.prototype.getSchema=function(e){return this.store[e]},module.exports={buildSchemas:e=>new Schemas(e),normalizeSchema:normalizeSchema};