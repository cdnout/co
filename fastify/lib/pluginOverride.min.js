"use strict";const{kAvvioBoot:kAvvioBoot,kChildren:kChildren,kRoutePrefix:kRoutePrefix,kLogLevel:kLogLevel,kLogSerializers:kLogSerializers,kHooks:kHooks,kSchemaController:kSchemaController,kContentTypeParser:kContentTypeParser,kReply:kReply,kRequest:kRequest,kFourOhFour:kFourOhFour,kPluginNameChain:kPluginNameChain}=require("./symbols.js"),Reply=require("./reply"),Request=require("./request"),SchemaController=require("./schema-controller"),ContentTypeParser=require("./contentTypeParser"),{buildHooks:buildHooks}=require("./hooks"),pluginUtils=require("./pluginUtils");function buildRoutePrefix(e,r){return r?(e.endsWith("/")&&"/"===r[0]?r=r.slice(1):"/"!==r[0]&&(r="/"+r),e+r):e}module.exports=function(e,r,o){if(pluginUtils.registerPlugin.call(e,r))return e[kPluginNameChain].push(pluginUtils.getDisplayName(r)),e;const l=Object.create(e);e[kChildren].push(l),l.ready=e[kAvvioBoot].bind(l),l[kChildren]=[],l[kReply]=Reply.buildReply(l[kReply]),l[kRequest]=Request.buildRequest(l[kRequest]),l[kContentTypeParser]=ContentTypeParser.helpers.buildContentTypeParser(l[kContentTypeParser]),l[kHooks]=buildHooks(l[kHooks]),l[kRoutePrefix]=buildRoutePrefix(l[kRoutePrefix],o.prefix),l[kLogLevel]=o.logLevel||l[kLogLevel],l[kSchemaController]=SchemaController.buildSchemaController(e[kSchemaController]),l.getSchema=l[kSchemaController].getSchema.bind(l[kSchemaController]),l.getSchemas=l[kSchemaController].getSchemas.bind(l[kSchemaController]),l[pluginUtils.registeredPlugins]=Object.create(l[pluginUtils.registeredPlugins]),l[kPluginNameChain]=[pluginUtils.getPluginName(r)||pluginUtils.getFuncPreview(r)],(l[kLogSerializers]||o.logSerializers)&&(l[kLogSerializers]=Object.assign(Object.create(l[kLogSerializers]),o.logSerializers)),o.prefix&&l[kFourOhFour].arrange404(l);for(const e of l[kHooks].onRegister)e.call(this,l,o);return l};