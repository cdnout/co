"use strict";const{kAvvioBoot,kChildren,kRoutePrefix,kLogLevel,kLogSerializers,kHooks,kSchemaController,kContentTypeParser,kReply,kRequest,kFourOhFour,kPluginNameChain}=require("./symbols.js"),Reply=require("./reply"),Request=require("./request"),SchemaController=require("./schema-controller"),ContentTypeParser=require("./contentTypeParser"),buildHooks=require("./hooks")["buildHooks"],pluginUtils=require("./pluginUtils");function buildRoutePrefix(e,r){return r?(e.endsWith("/")&&"/"===r[0]?r=r.slice(1):"/"!==r[0]&&(r="/"+r),e+r):e}module.exports=function(e,r,l){if(pluginUtils.registerPlugin.call(e,r))return e[kPluginNameChain].push(pluginUtils.getDisplayName(r)),e;const i=Object.create(e);e[kChildren].push(i),i.ready=e[kAvvioBoot].bind(i),i[kChildren]=[],i[kReply]=Reply.buildReply(i[kReply]),i[kRequest]=Request.buildRequest(i[kRequest]),i[kContentTypeParser]=ContentTypeParser.helpers.buildContentTypeParser(i[kContentTypeParser]),i[kHooks]=buildHooks(i[kHooks]),i[kRoutePrefix]=buildRoutePrefix(i[kRoutePrefix],l.prefix),i[kLogLevel]=l.logLevel||i[kLogLevel],i[kSchemaController]=SchemaController.buildSchemaController(e[kSchemaController]),i.getSchema=i[kSchemaController].getSchema.bind(i[kSchemaController]),i.getSchemas=i[kSchemaController].getSchemas.bind(i[kSchemaController]),i[pluginUtils.registeredPlugins]=Object.create(i[pluginUtils.registeredPlugins]),i[kPluginNameChain]=[pluginUtils.getPluginName(r)||pluginUtils.getFuncPreview(r)],(i[kLogSerializers]||l.logSerializers)&&(i[kLogSerializers]=Object.assign(Object.create(i[kLogSerializers]),l.logSerializers)),l.prefix&&i[kFourOhFour].arrange404(i);for(const o of i[kHooks].onRegister)o.call(this,i,l);return i};