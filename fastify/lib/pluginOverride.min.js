"use strict";const{kAvvioBoot:kAvvioBoot,kChildren:kChildren,kRoutePrefix:kRoutePrefix,kLogLevel:kLogLevel,kLogSerializers:kLogSerializers,kHooks:kHooks,kSchemas:kSchemas,kContentTypeParser:kContentTypeParser,kReply:kReply,kRequest:kRequest,kFourOhFour:kFourOhFour,kPluginNameChain:kPluginNameChain}=require("./symbols.js"),Reply=require("./reply"),Request=require("./request"),ContentTypeParser=require("./contentTypeParser"),{buildHooks:buildHooks}=require("./hooks"),{buildSchemas:buildSchemas}=require("./schemas"),pluginUtils=require("./pluginUtils");function buildRoutePrefix(e,i){return i?(e.endsWith("/")&&"/"===i[0]?i=i.slice(1):"/"!==i[0]&&(i="/"+i),e+i):e}module.exports=function(e,i,r){if(pluginUtils.registerPlugin.call(e,i))return e[kPluginNameChain].push(pluginUtils.getDisplayName(i)),e;const s=Object.create(e);e[kChildren].push(s),s.ready=e[kAvvioBoot].bind(s),s[kChildren]=[],s[kReply]=Reply.buildReply(s[kReply]),s[kRequest]=Request.buildRequest(s[kRequest]),s[kContentTypeParser]=ContentTypeParser.helpers.buildContentTypeParser(s[kContentTypeParser]),s[kHooks]=buildHooks(s[kHooks]),s[kRoutePrefix]=buildRoutePrefix(s[kRoutePrefix],r.prefix),s[kLogLevel]=r.logLevel||s[kLogLevel],s[kSchemas]=buildSchemas(e[kSchemas]),s.getSchema=s[kSchemas].getSchema.bind(s[kSchemas]),s.getSchemas=s[kSchemas].getSchemas.bind(s[kSchemas]),s[pluginUtils.registeredPlugins]=Object.create(s[pluginUtils.registeredPlugins]),s[kPluginNameChain]=[pluginUtils.getPluginName(i)||pluginUtils.getFuncPreview(i)],(s[kLogSerializers]||r.logSerializers)&&(s[kLogSerializers]=Object.assign(Object.create(s[kLogSerializers]),r.logSerializers)),r.prefix&&s[kFourOhFour].arrange404(s);for(const e of s[kHooks].onRegister)e.call(this,s,r);return s};