(function(b,a){if(typeof define=="function"&&define.amd){define(["./rangy-core"],b)}else{if(typeof module!="undefined"&&typeof exports=="object"){module.exports=b(require("rangy"))}else{b(a.rangy)}}})(function(a){a.createModule("Highlighter",["ClassApplier"],function(j,b){var m=j.dom;var i=m.arrayContains;var s=m.getBody;var l=j.util.createOptions;var n=j.util.forEach;var k=1;function p(u,t){return u.characterRange.start-t.characterRange.start}function g(t,u){return u?t.getElementById(u):s(t)}var d={};function o(t,u){this.type=t;this.converterCreator=u}o.prototype.create=function(){var t=this.converterCreator();t.type=this.type;return t};function q(t,u){d[t]=new o(t,u)}function c(u){var t=d[u];if(t instanceof o){return t.create()}else{throw new Error("Highlighter type '"+u+"' is not valid")}}j.registerHighlighterType=q;function e(u,t){this.start=u;this.end=t}e.prototype={intersects:function(t){return this.start<t.end&&this.end>t.start},isContiguousWith:function(t){return this.start==t.end||this.end==t.start},union:function(t){return new e(Math.min(this.start,t.start),Math.max(this.end,t.end))},intersection:function(t){return new e(Math.max(this.start,t.start),Math.min(this.end,t.end))},getComplements:function(u){var t=[];if(this.start>=u.start){if(this.end<=u.end){return[]}t.push(new e(u.end,this.end))}else{t.push(new e(this.start,Math.min(this.end,u.start)));if(this.end>u.end){t.push(new e(u.end,this.end))}}return t},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}};e.fromCharacterRange=function(t){return new e(t.start,t.end)};var r={rangeToCharacterRange:function(u,t){var v=u.getBookmark(t);return new e(v.start,v.end)},characterRangeToRange:function(v,w,t){var u=j.createRange(v);u.moveToBookmark({start:w.start,end:w.end,containerNode:t});return u},serializeSelection:function(y,u){var v=y.getAllRanges(),w=v.length;var z=[];var A=w==1&&y.isBackward();for(var x=0,t=v.length;x<t;++x){z[x]={characterRange:this.rangeToCharacterRange(v[x],u),backward:A}}return z},restoreSelection:function(z,B,t){z.removeAllRanges();var y=z.win.document;for(var v=0,x=B.length,w,A,u;v<x;++v){A=B[v];u=A.characterRange;w=this.characterRangeToRange(y,A.characterRange,t);z.addRange(w,A.backward)}}};q("textContent",function(){return r});q("TextRange",(function(){var t;return function(){if(!t){var u=j.modules.TextRange;if(!u){throw new Error("TextRange module is missing.")}else{if(!u.supported){throw new Error("TextRange module is present but not supported.")}}t={rangeToCharacterRange:function(w,v){return e.fromCharacterRange(w.toCharacterRange(v))},characterRangeToRange:function(x,y,v){var w=j.createRange(x);w.selectCharacters(v,y.start,y.end);return w},serializeSelection:function(w,v){return w.saveCharacterRanges(v)},restoreSelection:function(x,w,v){x.restoreCharacterRanges(v,w)}}}return t}})());function h(u,v,y,t,x,w){if(x){this.id=x;k=Math.max(k,x+1)}else{this.id=k++}this.characterRange=v;this.doc=u;this.classApplier=y;this.converter=t;this.containerElementId=w||null;this.applied=false}h.prototype={getContainerElement:function(){return g(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(t){this.characterRange=this.converter.rangeToCharacterRange(t,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(t){return this.getRange().containsNodeContents(t.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange());this.applied=false},apply:function(){this.classApplier.applyToRange(this.getRange());this.applied=true},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}};function f(u,t){t=t||"textContent";this.doc=u||document;this.classAppliers={};this.highlights=[];this.converter=c(t)}f.prototype={addClassApplier:function(t){this.classAppliers[t.className]=t},getHighlightForElement:function(v){var w=this.highlights;for(var u=0,t=w.length;u<t;++u){if(w[u].containsElement(v)){return w[u]}}return null},removeHighlights:function(w){for(var v=0,t=this.highlights.length,u;v<t;++v){u=this.highlights[v];if(i(w,u)){u.unapply();this.highlights.splice(v--,1)}}},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(t){var u=[],v=this.highlights;n(t,function(w){n(v,function(x){if(w.intersectsRange(x.getRange())&&!i(u,x)){u.push(x)}})});return u},highlightCharacterRanges:function(w,G,y){var J,K,H;var z=this.highlights;var N=this.converter;var P=this.doc;var A=[];var D=w?this.classAppliers[w]:null;y=l(y,{containerElementId:null,exclusive:true});var F=y.containerElementId;var L=y.exclusive;var t,E,M;if(F){t=this.doc.getElementById(F);if(t){E=j.createRange(this.doc);E.selectNodeContents(t);M=new e(0,E.toString().length)}}var v,B,C,O,x,u;for(J=0,K=G.length;J<K;++J){v=G[J];x=[];if(M){v=v.intersection(M)}if(v.start==v.end){continue}for(H=0;H<z.length;++H){C=false;if(F==z[H].containerElementId){B=z[H].characterRange;O=(D==z[H].classApplier);u=!O&&L;if((B.intersects(v)||B.isContiguousWith(v))&&(O||u)){if(u){n(B.getComplements(v),function(Q){x.push(new h(P,Q,z[H].classApplier,N,null,F))})}C=true;if(O){v=B.union(v)}}}if(C){A.push(z[H]);z[H]=new h(P,B.union(v),D,N,null,F)}else{x.push(z[H])}}if(D){x.push(new h(P,v,D,N,null,F))}this.highlights=z=x}n(A,function(Q){Q.unapply()});var I=[];n(z,function(Q){if(!Q.applied){Q.apply();I.push(Q)}});return I},highlightRanges:function(y,t,v){var u=[];var x=this.converter;v=l(v,{containerElement:null,exclusive:true});var A=v.containerElement;var z=A?A.id:null;var w;if(A){w=j.createRange(A);w.selectNodeContents(A)}n(t,function(C){var B=A?w.intersection(C):C;u.push(x.rangeToCharacterRange(B,A||s(C.getDocument())))});return this.highlightCharacterRanges(y,u,{containerElementId:z,exclusive:v.exclusive})},highlightSelection:function(z,E){var x=this.converter;var A=z?this.classAppliers[z]:false;E=l(E,{containerElementId:null,selection:j.getSelection(this.doc),exclusive:true});var y=E.containerElementId;var t=E.exclusive;var C=E.selection;var B=C.win.document;var D=g(B,y);if(!A&&z!==false){throw new Error("No class applier found for class '"+z+"'")}var u=x.serializeSelection(C,D);var w=[];n(u,function(F){w.push(e.fromCharacterRange(F.characterRange))});var v=this.highlightCharacterRanges(z,w,{containerElementId:y,exclusive:t});x.restoreSelection(C,u,D);return v},unhighlightSelection:function(u){u=u||j.getSelection(this.doc);var t=this.getIntersectingHighlights(u.getAllRanges());this.removeHighlights(t);u.removeAllRanges();return t},getHighlightsInSelection:function(t){t=t||j.getSelection(this.doc);return this.getIntersectingHighlights(t.getAllRanges())},selectionOverlapsHighlight:function(t){return this.getHighlightsInSelection(t).length>0},serialize:function(v){var u=this;var x=u.highlights;var t,z,w,y;x.sort(p);v=l(v,{serializeHighlightText:false,type:u.converter.type});t=v.type;w=(t!=u.converter.type);if(w){y=c(t)}z=["type:"+t];n(x,function(A){var C=A.characterRange;var D;if(w){D=A.getContainerElement();C=y.rangeToCharacterRange(u.converter.characterRangeToRange(u.doc,C,D),D)}var B=[C.start,C.end,A.id,A.classApplier.className,A.containerElementId];if(v.serializeHighlightText){B.push(A.getText())}z.push(B.join("$"))});return z.join("|")},deserialize:function(B){var v=B.split("|");var E=[];var t=v[0];var z;var u,A,G=false;if(t&&(z=/^type:(\w+)$/.exec(t))){u=z[1];if(u!=this.converter.type){A=c(u);G=true}v.shift()}else{throw new Error("Serialized highlights are invalid.")}var F,w,D,x,H;for(var C=v.length,y;C-->0;){y=v[C].split("$");D=new e(+y[0],+y[1]);x=y[4]||null;if(G){H=g(this.doc,x);D=this.converter.rangeToCharacterRange(A.characterRangeToRange(this.doc,D,H),H)}F=this.classAppliers[y[3]];if(!F){throw new Error("No class applier found for class '"+y[3]+"'")}w=new h(this.doc,D,F,this.converter,parseInt(y[2]),x);w.apply();E.push(w)}this.highlights=E}};j.Highlighter=f;j.createHighlighter=function(u,t){return new f(u,t)}});return a},this);