var PruneCluster,__extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(t,e){function o(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}();!function(t){function e(){}t.Point=e;function o(){}t.ClusterObject=o;var n,l=1,s=Math.pow(2,53)-1,a=(__extends(r,n=o),r.prototype.Move=function(t,e){this.position.lat=+t,this.position.lng=+e},r.prototype.SetData=function(t){for(var e in t)this.data[e]=t[e]},r);function r(t,e,o,a,r,s){void 0===o&&(o={}),void 0===r&&(r=1),void 0===s&&(s=!1);var i=n.call(this)||this;return i.data=o,i.position={lat:+t,lng:+e},i.weight=r,i.category=a,i.filtered=s,i.hashCode=l++,i}t.Marker=a;var i,v=(__extends(h,i=o),h.prototype.AddMarker=function(t){h.ENABLE_MARKERS_LIST&&this._clusterMarkers.push(t);var e=((e=this.hashCode)<<5)-e+t.hashCode;this.hashCode=s<=e?e%s:e;var o=(this.lastMarker=t).weight,a=this.totalWeight,r=o+a;this.averagePosition.lat=(this.averagePosition.lat*a+t.position.lat*o)/r,this.averagePosition.lng=(this.averagePosition.lng*a+t.position.lng*o)/r,++this.population,this.totalWeight=r,void 0!==t.category&&(this.stats[t.category]=this.stats[t.category]+1||1)},h.prototype.Reset=function(){this.hashCode=1,this.lastMarker=void 0,this.population=0,this.totalWeight=0,this.stats=[0,0,0,0,0,0,0,0],h.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[])},h.prototype.ComputeBounds=function(t){var e=t.Project(this.position.lat,this.position.lng),o=t.Size,a=Math.floor(e.x/o)*o,r=Math.floor(e.y/o)*o,s=t.UnProject(a,r),i=t.UnProject(a+o,r+o);this.bounds={minLat:i.lat,maxLat:s.lat,minLng:s.lng,maxLng:i.lng}},h.prototype.GetClusterMarkers=function(){return this._clusterMarkers},h.prototype.ApplyCluster=function(t){this.hashCode=41*this.hashCode+43*t.hashCode,this.hashCode>s&&(this.hashCode=this.hashCode=s);var e=t.totalWeight,o=this.totalWeight,a=e+o;for(var r in this.averagePosition.lat=(this.averagePosition.lat*o+t.averagePosition.lat*e)/a,this.averagePosition.lng=(this.averagePosition.lng*o+t.averagePosition.lng*e)/a,this.population+=t.population,this.totalWeight=a,this.bounds.minLat=Math.min(this.bounds.minLat,t.bounds.minLat),this.bounds.minLng=Math.min(this.bounds.minLng,t.bounds.minLng),this.bounds.maxLat=Math.max(this.bounds.maxLat,t.bounds.maxLat),this.bounds.maxLng=Math.max(this.bounds.maxLng,t.bounds.maxLng),t.stats)t.stats.hasOwnProperty(r)&&(this.stats.hasOwnProperty(r)?this.stats[r]+=t.stats[r]:this.stats[r]=t.stats[r]);h.ENABLE_MARKERS_LIST&&(this._clusterMarkers=this._clusterMarkers.concat(t.GetClusterMarkers()))},h.ENABLE_MARKERS_LIST=!1,h);function h(t){var e=i.call(this)||this;return e.stats=[0,0,0,0,0,0,0,0],e.data={},t?(h.ENABLE_MARKERS_LIST&&(e._clusterMarkers=[t]),e.lastMarker=t,e.hashCode=31+t.hashCode,e.population=1,void 0!==t.category&&(e.stats[t.category]=1),e.totalWeight=t.weight,e.position={lat:t.position.lat,lng:t.position.lng},e.averagePosition={lat:t.position.lat,lng:t.position.lng}):(e.hashCode=1,h.ENABLE_MARKERS_LIST&&(e._clusterMarkers=[])),e}function u(t){for(var e,o,a,r=1,s=t.length;r<s;++r){for(a=(o=t[r]).position.lng,e=r-1;0<=e&&t[e].position.lng>a;--e)t[e+1]=t[e];t[e+1]=o}}t.Cluster=v;var p=(d.prototype.RegisterMarker=function(t){t._removeFlag&&delete t._removeFlag,this._markers.push(t),this._nbChanges+=1},d.prototype.RegisterMarkers=function(t){var e=this;t.forEach(function(t){e.RegisterMarker(t)})},d.prototype._sortMarkers=function(){var t,e,o=this._markers,a=o.length;this._nbChanges&&(t=a,300<(e=this._nbChanges)||!(e/t<.2))?this._markers.sort(function(t,e){return t.position.lng-e.position.lng}):u(o),this._nbChanges=0},d.prototype._sortClusters=function(){u(this._clusters)},d.prototype._indexLowerBoundLng=function(t){for(var e,o,a=this._markers,r=0,s=a.length;0<s;)a[e=r+(o=Math.floor(s/2))].position.lng<t?(r=++e,s-=o+1):s=o;return r},d.prototype._resetClusterViews=function(){for(var t=0,e=this._clusters.length;t<e;++t){var o=this._clusters[t];o.Reset(),o.ComputeBounds(this)}},d.prototype.ProcessView=function(t){var e=Math.abs(t.maxLat-t.minLat)*this.ViewPadding,o=Math.abs(t.maxLng-t.minLng)*this.ViewPadding,a={minLat:t.minLat-e-e,maxLat:t.maxLat+e+e,minLng:t.minLng-o-o,maxLng:t.maxLng+o+o};this._sortMarkers(),this._resetClusterViews();for(var r,s,i=this._indexLowerBoundLng(a.minLng),n=this._markers,l=this._clusters,h=l.slice(0),u=i,p=n.length;u<p;++u){var d=n[u],m=d.position;if(m.lng>a.maxLng)break;if(m.lat>a.minLat&&m.lat<a.maxLat&&!d.filtered){for(var _,g=!1,f=0,c=h.length;f<c;++f)if((_=h[f]).bounds.maxLng<d.position.lng)h.splice(f,1),--f,--c;else if(r=m,s=_.bounds,r.lat>=s.minLat&&r.lat<=s.maxLat&&r.lng>=s.minLng&&r.lng<=s.maxLng){_.AddMarker(d),g=!0;break}g||((_=new v(d)).ComputeBounds(this),l.push(_),h.push(_))}}for(var L=[],u=0,p=l.length;u<p;++u)0<(_=l[u]).population&&L.push(_);return this._clusters=L,this._sortClusters(),this._clusters},d.prototype.RemoveMarkers=function(t){if(t){for(var e=0,o=t.length;e<o;++e)t[e]._removeFlag=!0;for(var a=[],e=0,o=this._markers.length;e<o;++e)this._markers[e]._removeFlag?delete this._markers[e]._removeFlag:a.push(this._markers[e]);this._markers=a}else this._markers=[]},d.prototype.FindMarkersInArea=function(t){for(var e=t.minLat,o=t.maxLat,a=t.minLng,r=t.maxLng,s=this._markers,i=[],n=this._indexLowerBoundLng(a),l=s.length;n<l;++n){var h=s[n].position;if(h.lng>r)break;h.lat>=e&&h.lat<=o&&h.lng>=a&&i.push(s[n])}return i},d.prototype.ComputeBounds=function(t,e){if(void 0===e&&(e=!0),!t||!t.length)return null;for(var o,a=Number.MAX_VALUE,r=-Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=0,l=t.length;n<l;++n)!e&&t[n].filtered||((o=t[n].position).lat<a&&(a=o.lat),o.lat>r&&(r=o.lat),o.lng<s&&(s=o.lng),o.lng>i&&(i=o.lng));return{minLat:a,maxLat:r,minLng:s,maxLng:i}},d.prototype.FindMarkersBoundsInArea=function(t){return this.ComputeBounds(this.FindMarkersInArea(t))},d.prototype.ComputeGlobalBounds=function(t){return void 0===t&&(t=!0),this.ComputeBounds(this._markers,t)},d.prototype.GetMarkers=function(){return this._markers},d.prototype.GetPopulation=function(){return this._markers.length},d.prototype.ResetClusters=function(){this._clusters=[]},d);function d(){this._markers=[],this._nbChanges=0,this._clusters=[],this.Size=166,this.ViewPadding=.2}t.PruneCluster=p}(PruneCluster=PruneCluster||{}),PruneCluster=PruneCluster||{};var PruneClusterForLeaflet=(L.Layer?L.Layer:L.Class).extend({initialize:function(t,e){var o=this;void 0===t&&(t=120),void 0===e&&(e=20),this.Cluster=new PruneCluster.PruneCluster,this.Cluster.Size=t,this.clusterMargin=Math.min(e,t/4),this.Cluster.Project=function(t,e){return o._map.project(new L.LatLng(t,e),Math.floor(o._map.getZoom()))},this.Cluster.UnProject=function(t,e){return o._map.unproject(new L.Point(t,e),Math.floor(o._map.getZoom()))},this._objectsOnMap=[],this.spiderfier=new PruneClusterLeafletSpiderfier(this),this._hardMove=!1,this._resetIcons=!1,this._removeTimeoutId=0,this._markersRemoveListTimeout=[]},RegisterMarker:function(t){this.Cluster.RegisterMarker(t)},RegisterMarkers:function(t){this.Cluster.RegisterMarkers(t)},RemoveMarkers:function(t){this.Cluster.RemoveMarkers(t)},BuildLeafletCluster:function(t,e){var f=this,c=new L.Marker(e,{icon:this.BuildLeafletClusterIcon(t)});return c._leafletClusterBounds=t.bounds,c.on("click",function(){var t=c._leafletClusterBounds,e=f.Cluster.FindMarkersInArea(t),o=f.Cluster.ComputeBounds(e);if(o){var a=new L.LatLngBounds(new L.LatLng(o.minLat,o.maxLng),new L.LatLng(o.maxLat,o.minLng)),r=f._map.getZoom(),s=f._map.getBoundsZoom(a,!1,new L.Point(20,20));if(s===r){for(var i=[],n=0,l=f._objectsOnMap.length;n<l;++n){var h=f._objectsOnMap[n];h.data._leafletMarker!==c&&h.bounds.minLat>=t.minLat&&h.bounds.maxLat<=t.maxLat&&h.bounds.minLng>=t.minLng&&h.bounds.maxLng<=t.maxLng&&i.push(h.bounds)}if(0<i.length){for(var u=[],p=i.length,n=0,l=e.length;n<l;++n){for(var d=e[n].position,m=!1,_=0;_<p;++_){var g=i[_];if(d.lat>=g.minLat&&d.lat<=g.maxLat&&d.lng>=g.minLng&&d.lng<=g.maxLng){m=!0;break}}m||u.push(e[n])}e=u}e.length<200||s>=f._map.getMaxZoom()?f._map.fire("overlappingmarkers",{cluster:f,markers:e,center:c.getLatLng(),marker:c}):s++,f._map.setView(c.getLatLng(),s)}else f._map.fitBounds(a)}}),c},BuildLeafletClusterIcon:function(t){var e="prunecluster prunecluster-",o=38,a=this.Cluster.GetPopulation();return t.population<Math.max(10,.01*a)?e+="small":o=t.population<Math.max(100,.05*a)?(e+="medium",40):(e+="large",44),new L.DivIcon({html:"<div><span>"+t.population+"</span></div>",className:e,iconSize:L.point(o,o)})},BuildLeafletMarker:function(t,e){var o=new L.Marker(e);return this.PrepareLeafletMarker(o,t.data,t.category),o},PrepareLeafletMarker:function(t,e,o){var a;e.icon&&("function"==typeof e.icon?t.setIcon(e.icon(e,o)):t.setIcon(e.icon)),e.popup&&(a="function"==typeof e.popup?e.popup(e,o):e.popup,t.getPopup()?t.setPopupContent(a,e.popupOptions):t.bindPopup(a,e.popupOptions))},onAdd:function(t){(this._map=t).on("movestart",this._moveStart,this),t.on("moveend",this._moveEnd,this),t.on("zoomend",this._zoomStart,this),t.on("zoomend",this._zoomEnd,this),this.ProcessView(),t.addLayer(this.spiderfier)},onRemove:function(t){t.off("movestart",this._moveStart,this),t.off("moveend",this._moveEnd,this),t.off("zoomend",this._zoomStart,this),t.off("zoomend",this._zoomEnd,this);for(var e=0,o=this._objectsOnMap.length;e<o;++e)t.removeLayer(this._objectsOnMap[e].data._leafletMarker);this._objectsOnMap=[],this.Cluster.ResetClusters(),t.removeLayer(this.spiderfier),this._map=null},_moveStart:function(){this._moveInProgress=!0},_moveEnd:function(t){this._moveInProgress=!1,this._hardMove=t.hard,this.ProcessView()},_zoomStart:function(){this._zoomInProgress=!0},_zoomEnd:function(){this._zoomInProgress=!1,this.ProcessView()},ProcessView:function(){var i=this;if(this._map&&!this._zoomInProgress&&!this._moveInProgress){for(var t=this._map,e=t.getBounds(),n=Math.floor(t.getZoom()),o=this.clusterMargin/this.Cluster.Size,l=this._resetIcons,a=e.getSouthWest(),r=e.getNorthEast(),s=this.Cluster.ProcessView({minLat:a.lat,minLng:a.lng,maxLat:r.lat,maxLng:r.lng}),h=this._objectsOnMap,u=[],p=new Array(h.length),d=0,m=h.length;d<m;++d){var _=h[d].data._leafletMarker;(p[d]=_)._removeFromMap=!0}var g=[],f=[],c=[],v=[];for(d=0,m=s.length;d<m;++d){for(var M=s[d],k=M.data,C=(M.bounds.maxLat-M.bounds.minLat)*o,P=(M.bounds.maxLng-M.bounds.minLng)*o,y=0,w=v.length;y<w;++y){var b=v[y];if(b.bounds.maxLng<M.bounds.minLng)v.splice(y,1),--y,--w;else{var x=b.averagePosition.lng+P,I=b.averagePosition.lat-C,S=b.averagePosition.lat+C,B=M.averagePosition.lng-P,R=M.averagePosition.lat-C,O=M.averagePosition.lat+C;if(B<x&&R<S&&I<O){k._leafletCollision=!0,b.ApplyCluster(M);break}}}k._leafletCollision||v.push(M)}for(s.forEach(function(t){var e=void 0,o=t.data;if(o._leafletCollision)return o._leafletCollision=!1,o._leafletOldPopulation=0,void(o._leafletOldHashCode=0);var a,r=new L.LatLng(t.averagePosition.lat,t.averagePosition.lng),s=o._leafletMarker;s&&(1===t.population&&1===o._leafletOldPopulation&&t.hashCode===s._hashCode?((l||s._zoomLevel!==n||t.lastMarker.data.forceIconRedraw)&&(i.PrepareLeafletMarker(s,t.lastMarker.data,t.lastMarker.category),t.lastMarker.data.forceIconRedraw&&(t.lastMarker.data.forceIconRedraw=!1)),s.setLatLng(r),e=s):1<t.population&&1<o._leafletOldPopulation&&(s._zoomLevel===n||o._leafletPosition.equals(r))&&(s.setLatLng(r),!l&&t.population==o._leafletOldPopulation&&t.hashCode===o._leafletOldHashCode||(a={},L.Util.extend(a,t.bounds),s._leafletClusterBounds=a,s.setIcon(i.BuildLeafletClusterIcon(t))),o._leafletOldPopulation=t.population,o._leafletOldHashCode=t.hashCode,e=s)),e?(e._removeFromMap=!1,u.push(t),e._zoomLevel=n,e._hashCode=t.hashCode,e._population=t.population,o._leafletMarker=e,o._leafletPosition=r):(1===t.population?f.push(t):g.push(t),o._leafletPosition=r,o._leafletOldPopulation=t.population,o._leafletOldHashCode=t.hashCode)}),g=f.concat(g),d=0,m=h.length;d<m;++d){var A=(M=h[d]).data,_=A._leafletMarker;if(A._leafletMarker._removeFromMap){var E=!0;if(_._zoomLevel===n)for(var z=M.averagePosition,C=(M.bounds.maxLat-M.bounds.minLat)*o,P=(M.bounds.maxLng-M.bounds.minLng)*o,y=0,w=g.length;y<w;++y){var T,F,j,U,V=g[y],N=V.data;if(1===_._population&&1===V.population&&_._hashCode===V.hashCode?((l||V.lastMarker.data.forceIconRedraw)&&(this.PrepareLeafletMarker(_,V.lastMarker.data,V.lastMarker.category),V.lastMarker.data.forceIconRedraw&&(V.lastMarker.data.forceIconRedraw=!1)),_.setLatLng(N._leafletPosition),E=!1):(T=V.averagePosition,F=z.lng-P,j=T.lng+P,x=z.lng+P,I=z.lat-C,S=z.lat+C,B=T.lng-P,R=T.lat-C,O=T.lat+C,1<_._population&&1<V.population&&B<x&&F<j&&R<S&&I<O&&(_.setLatLng(N._leafletPosition),_.setIcon(this.BuildLeafletClusterIcon(V)),U={},L.Util.extend(U,V.bounds),_._leafletClusterBounds=U,N._leafletOldPopulation=V.population,N._leafletOldHashCode=V.hashCode,_._population=V.population,E=!1)),!E){(N._leafletMarker=_)._removeFromMap=!1,u.push(V),g.splice(y,1),--y,--w;break}}E&&(_._removeFromMap||console.error("wtf"))}}for(d=0,m=g.length;d<m;++d){var D=(A=(M=g[d]).data)._leafletPosition,G=1===M.population?this.BuildLeafletMarker(M.lastMarker,D):this.BuildLeafletCluster(M,D);G.addTo(t),G.setOpacity(0),c.push(G),(A._leafletMarker=G)._zoomLevel=n,G._hashCode=M.hashCode,G._population=M.population,u.push(M)}if(window.setTimeout(function(){for(d=0,m=c.length;d<m;++d){var t=c[d];t._icon&&L.DomUtil.addClass(t._icon,"prunecluster-anim"),t._shadow&&L.DomUtil.addClass(t._shadow,"prunecluster-anim"),t.setOpacity(1)}},1),this._hardMove)for(d=0,m=p.length;d<m;++d)(_=p[d])._removeFromMap&&t.removeLayer(_);else{if(0!==this._removeTimeoutId)for(window.clearTimeout(this._removeTimeoutId),d=0,m=this._markersRemoveListTimeout.length;d<m;++d)t.removeLayer(this._markersRemoveListTimeout[d]);for(var W=[],d=0,m=p.length;d<m;++d)(_=p[d])._removeFromMap&&(_.setOpacity(0),W.push(_));0<W.length&&(this._removeTimeoutId=window.setTimeout(function(){for(d=0,m=W.length;d<m;++d)t.removeLayer(W[d]);i._removeTimeoutId=0},300)),this._markersRemoveListTimeout=W}this._objectsOnMap=u,this._hardMove=!1,this._resetIcons=!1}},FitBounds:function(t){void 0===t&&(t=!0);var e=this.Cluster.ComputeGlobalBounds(t);e&&this._map.fitBounds(new L.LatLngBounds(new L.LatLng(e.minLat,e.maxLng),new L.LatLng(e.maxLat,e.minLng)))},GetMarkers:function(){return this.Cluster.GetMarkers()},RedrawIcons:function(t){void 0===t&&(t=!0),this._resetIcons=!0,t&&this.ProcessView()}}),PruneClusterLeafletSpiderfier=(L.Layer?L.Layer:L.Class).extend({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_spiralCountTrigger:8,spiderfyDistanceMultiplier:1,initialize:function(t){this._cluster=t,this._currentMarkers=[],this._multiLines=!!L.multiPolyline,this._lines=this._multiLines?L.multiPolyline([],{weight:1.5,color:"#222"}):L.polyline([],{weight:1.5,color:"#222"})},onAdd:function(t){this._map=t,this._map.on("overlappingmarkers",this.Spiderfy,this),this._map.on("click",this.Unspiderfy,this),this._map.on("zoomend",this.Unspiderfy,this)},Spiderfy:function(l){var h=this;if(l.cluster===this._cluster){this.Unspiderfy();var t=l.markers.filter(function(t){return!t.filtered});this._currentCenter=l.center;for(var e=this._map.latLngToLayerPoint(l.center),u=t.length>=this._spiralCountTrigger?this._generatePointsSpiral(t.length,e):(this._multiLines&&(e.y+=10),this._generatePointsCircle(t.length,e)),p=[],o=[],d=[],m=0,_=u.length;m<_;++m){var a=this._map.layerPointToLatLng(u[m]),r=this._cluster.BuildLeafletMarker(t[m],l.center);r.setZIndexOffset(5e3),r.setOpacity(0),this._currentMarkers.push(r),this._map.addLayer(r),o.push(r),d.push(a)}window.setTimeout(function(){for(m=0,_=u.length;m<_;++m)o[m].setLatLng(d[m]).setOpacity(1);var i=+new Date,n=window.setInterval(function(){p=[];var t=+new Date-i,e=290<=t?(window.clearInterval(n),1):t/290,o=l.center;for(m=0,_=u.length;m<_;++m){var a=d[m],r=a.lat-o.lat,s=a.lng-o.lng;p.push([o,new L.LatLng(o.lat+r*e,o.lng+s*e)])}h._lines.setLatLngs(p)},42)},1),this._lines.setLatLngs(p),this._map.addLayer(this._lines),l.marker&&(this._clusterMarker=l.marker.setOpacity(.3))}},_generatePointsCircle:function(t,e){for(var o,a=this.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+t)/this._2PI,r=this._2PI/t,s=[],i=(s.length=t)-1;0<=i;i--)o=this._circleStartAngle+i*r,s[i]=new L.Point(Math.round(e.x+a*Math.cos(o)),Math.round(e.y+a*Math.sin(o)));return s},_generatePointsSpiral:function(t,e){for(var o=this.spiderfyDistanceMultiplier*this._spiralLengthStart,a=this.spiderfyDistanceMultiplier*this._spiralFootSeparation,r=this.spiderfyDistanceMultiplier*this._spiralLengthFactor,s=0,i=[],n=(i.length=t)-1;0<=n;n--)s+=a/o+5e-4*n,i[n]=new L.Point(Math.round(e.x+o*Math.cos(s)),Math.round(e.y+o*Math.sin(s))),o+=this._2PI*r/s;return i},Unspiderfy:function(){for(var t=this,e=0,o=this._currentMarkers.length;e<o;++e)this._currentMarkers[e].setLatLng(this._currentCenter).setOpacity(0);var a=this._currentMarkers;window.setTimeout(function(){for(e=0,o=a.length;e<o;++e)t._map.removeLayer(a[e])},300),this._currentMarkers=[],this._map.removeLayer(this._lines),this._clusterMarker&&this._clusterMarker.setOpacity(1)},onRemove:function(t){this.Unspiderfy(),t.off("overlappingmarkers",this.Spiderfy,this),t.off("click",this.Unspiderfy,this),t.off("zoomend",this.Unspiderfy,this)}});