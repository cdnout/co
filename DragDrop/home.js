/**
 * DragDrop.js
 *
 * A JavaScript micro-framework for adding drag-and-drop functionality
 * to elements for advanced UI development.
 *
 * @author     James Brumond
 * @version    0.3.0
 * @copyright  Copyright 2011 James Brumond
 * @license    Dual licensed under MIT and GPL
 */(function(){function q(a){var b=0,c=0;if(a.targetTouches)b=a.targetTouches[0].pageX,c=a.targetTouches[0].pageY;else if(a.pageX||a.pageY)b=a.pageX,c=a.pageY;else if(a.clientX||a.clientY)b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c=a.clientY+document.body.scrollTop+document.documentElement.scrollTop;return{x:b,y:c}}var a="ontouchstart"in window,b="drag",c=function(){var d={},j=a?{start:"touchstart",move:"touchmove",end:"touchend"}:{start:"mousedown",move:"mousemove",end:"mouseup"},q=[],r=function(a,b){for(var c=0,d=q.length;c<d;c++)if(q[c]&&q[c].element===a&&q[c].anchor===b)return!0;return!1},s=function(a,b,c){q[a._id]&&q[a._id].events[b]&&c(q[a._id].events[b])},t=function(a,b){b=b||{},b.element=a,b.anchor=b.anchor||a,b.boundingBox=b.boundingBox||null;return b},u=1,v=function(){this._id=u++};v.prototype.unbind=function(){return c.unbind(this)},v.prototype.bindEvent=function(a,b){return c.bindEvent(this,a,b)},v.prototype.unbindEvent=function(a,b){return c.unbindEvent(this,a,b)},v.prototype.invokeEvent=function(a,b){return c.invokeEvent(this,a,b)},v.prototype.setBoundingBox=function(a){q[this._id].boundingBox=a},d.bind=function(d,e){e=t(d,e);if(!m(e.element))throw new Error("Must give an element to drag");if(g(e.anchor,"position")==="static")throw new Error("Cannot drag-drop an element with position:static");if(!r(e.element,e.anchor)){var s=new v,u={element:e.element,anchor:e.anchor,dragging:!1,event:null,shouldUnbind:!1,boundingBox:e.boundingBox,events:{beforedrag:n(e.beforedrag),dragstart:n(e.dragstart),dragend:n(e.dragend),drag:n(e.drag),unbind:n(e.unbind)}};u.event=p.bind(u.anchor,j.start,function(d){if(window.event&&d.button===1||d.button===0||a){i(d),u.events.beforedrag.call(u.element,new o("beforedrag",d,u)),u.dragging=!0,l(u.element,b);var e=f(u.element,"left"),g=f(u.element,"top"),m=[],n=a?u.anchor:document;m.push(p.bind(n,j.move,function(a){var b=a.clientX-d.clientX,c=a.clientY-d.clientY,f=u.element.offsetWidth,j=u.element.offsetHeight,k=e+b,l=g+c;if(u.boundingBox){var m=u.boundingBox,n,p,q,r;if(m==="offsetParent"){var s=u.element.offsetParent;n=q=0,p=s.offsetWidth,r=s.offsetHeight}else if(m==="windowSize"){var t=h();n=q=0,p=t.x,r=t.y}else n=m.x.min,p=m.x.max,q=m.y.min,r=m.y.max;k=Math.max(n,Math.min(p-f,k)),l=Math.max(q,Math.min(r-j,l))}u.element.style.left=k+"px",u.element.style.top=l+"px",u.events.drag.call(u.element,new o("drag",a,u));return i(a)})),m.push(p.bind(n,j.end,function(a){for(var d=0,e=m.length;d<e;d++)p.unbind(m[d]);u.dragging=!1,k(u.element,b),u.shouldUnbind&&c.unbind(u.element,u.anchor),u.events.dragend.call(u.element,new o("dragend",a,u));return i(a)})),document.body.focus(),m.push(p.bind(document,"selectstart",!1)),m.push(p.bind(u.anchor,"dragstart",!1)),u.events.dragstart.call(u.element,new o("dragstart",d,u));return!1}}),q[s._id]=u;return s}},d.unbind=function(a){if(a instanceof v){var b=a._id;q[b]&&(q[b].dragging?q[b].shouldUnbind=!0:(p.unbind(q[b].event),q[b]=null),binding.events.unbind.call(binding.element,new o("unbind",e,binding)))}},d.bindEvent=function(a,b,c){s(a,b,function(a){a.push(c)})},d.unbindEvent=function(a,b,c){s(a,b,function(a){a.remove(c)})},d.invokeEvent=function(a,b,c){s(a,b,function(d){d.call(q[a._id].element,new o(b,c,a))})};return d}(),d=function(a,b,c){var d=a.slice((c||b)+1||a.length);a.length=b<0?a.length+b:b;return a.push.apply(a,d)},f=function(a,b){var c=parseFloat(g(a,b));return isNaN(c)?0:c},g=function(a,b){if(a.currentStyle)return a.currentStyle[b];if(window.getComputedStyle)return document.defaultView.getComputedStyle(a,null).getPropertyValue(b);if(a.style)return a.style[b]},h=function(){return{x:window.innerWidth||document.documentElement.clientWidth||body().clientWidth,y:window.innerHeight||document.documentElement.clientHeight||body().clientHeight}},i=function(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1;return!1},j={},k=function(a,b){j[b]||(j[b]=new RegExp("(^|\\s)+"+b+"(\\s|$)+")),a.className=a.className.replace(j[b]," ")},l=function(a,b){k(a,b),a.className+=" "+b},m=function(a){return!!a&&typeof a=="object"},n=function(a){var b=[],c=function(){var a;for(var c=0,d=b.length;c<d;c++)a=b[c].apply(this,arguments);return a};c.push=function(){b.push.apply(b,arguments)},c.remove=function(){var a=Array.prototype.slice.call(arguments),c=[];OUTER:for(var d=0,e=b.length;d<e;d++){for(var f=0,g=a.length;f<g;f++)if(b[d]===a[f])continue OUTER;c.push(b[d])}b=c},typeof a=="function"&&b.push(a);return c},o=function(b,c,d){this.type=b,this.originalEvent=c,this.altKey=c.altKey||!1,this.ctrlKey=c.ctrlKey||!1,this.shiftKey=c.shiftKey||!1,this.timestamp=c.timestamp||+(new Date),this.pos=q(c),this.binding=d},p=function(){var a=function(){return document.addEventListener?function(a,b,c){a.addEventListener(b,c,!1)}:document.attachEvent?function(a,b,c){a.attachEvent("on"+b,c)}:function(){}}(),b=function(){return document.removeEventListener?function(a,b,c){a.removeEventListener(b,c,!1)}:document.detachEvent?function(a,b,c){a.detachEvent("on"+b,c)}:function(){}}();return{bind:function(c,d,e){var f=e===!1?function(a){return i(a)}:e;e=function(a){return f.call(c,a||window.event)},a(c,d,e);var g=function(){b(c,d,e)};g.unbind=function(){g()};return g},unbind:function(a){a()}}}();window.DragDrop=c})()
