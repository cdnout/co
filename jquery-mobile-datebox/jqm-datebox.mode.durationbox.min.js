/*
 * jQuery Mobile Framework : plugin to provide a date and time picker.
 * Copyright (c) JTSage
 * CC 3.0 Attribution.  May be relicensed without permission/notification.
 * https://github.com/jtsage/jquery-mobile-datebox
 */
(function(a){a.extend(a.mobile.datebox.prototype.options,{themeButton:"a",themeInput:"a",useSetButton:true,repButton:true,durationSteppers:{d:1,h:1,i:1,s:1}});a.extend(a.mobile.datebox.prototype,{_durbox_run:function(){var b=this;b.drag.didRun=true;b._offset(b.drag.target[0],b.drag.target[1],false);b._durbox_run_update();b.runButton=setTimeout(function(){b._durbox_run()},100)},_durbox_run_update:function(){var c=this,e,b=[],d={d:60*60*24,h:60*60,i:60};e=c.theDate.getEpoch()-c.initDate.getEpoch();if(e<0){e=0;c.theDate.setTime(c.initDate.getTime())}c.lastDuration=e;b[0]=parseInt(e/d.d,10);e=e%d.d;b[1]=parseInt(e/d.h,10);e=e%d.h;b[2]=parseInt(e/d.i,10);b[3]=e%d.i;c.d.divIn.find("input").each(function(){switch(a(this).parent().jqmData("field")){case"d":a(this).val(b[0]);break;case"h":a(this).val(b[1]);break;case"i":a(this).val(b[2]);break;case"s":a(this).val(b[3]);break}})},_durbox_valid:function(b){if(b.toString().search(/^[0-9]+$/)===0){return parseInt(b,10)}return 0},_durbox_enter:function(d){var b=this,c=b.initDate.getEpoch();b.d.intHTML.find("input").each(function(){switch(a(this).parent().jqmData("field")){case"d":c+=(60*60*24)*b._durbox_valid(a(this).val());break;case"h":c+=(60*60)*b._durbox_valid(a(this).val());break;case"i":c+=(60)*b._durbox_valid(a(this).val());break;case"s":c+=b._durbox_valid(a(this).val());break}});b.theDate.setTime(c*1000);b.refresh()}});a.extend(a.mobile.datebox.prototype._build,{durationbox:function(){var u=this,n=this.drag,f=this.options,l,s,h=[0,0,0,0],m,t={d:60*60*24,h:60*60,i:60},q="ui-datebox-",r=a("<div>"),c=a("<fieldset>"),j=r.clone().addClass("ui-datebox-dboxin"),k=c.clone(),e=a("<input type='"+u.inputType+"' />").addClass("ui-input-text ui-corner-all ui-shadow-inset ui-body-"+f.themeInput),p=a("<div><a href='#'> </a></div>"),b={theme:f.themeButton,icon:"plus",iconpos:"bottom",corners:true,shadow:true},d=a.extend({},b,{icon:"minus",iconpos:"top"});if(typeof u.d.intHTML!=="boolean"){u.d.intHTML.empty().remove()}u.d.headerText=((u._grabLabel()!==false)?u._grabLabel():u.__("titleDateDialogLabel"));u.d.intHTML=a("<span>");if(u.inputType!=="number"){e.attr("pattern","[0-9]*")}u.fldOrder=u.__("durationOrder");for(l=0;l<=u.fldOrder.length;l++){switch(u.fldOrder[l]){case"d":case"h":case"i":case"s":s=a.inArray(u.fldOrder[l],["d","h","i","s"]);a("<div>").jqmData("field",u.fldOrder[l]).addClass("ui-block-"+["a","b","c","d"][l]).append(e.clone()).appendTo(j).prepend("<label>"+u.__("durationLabel")[s]+"</label>");u._makeEl(p,{attr:{field:u.fldOrder[l]}}).addClass("ui-block-"+["a","b","c","d"][l]).buttonMarkup(b).appendTo(c);u._makeEl(p,{attr:{field:u.fldOrder[l]}}).addClass("ui-block-"+["a","b","c","d"][l]).buttonMarkup(d).appendTo(k);break}}l=u.theDate.getEpoch()-u.initDate.getEpoch();if(l<0){l=0;u.theDate.setTime(u.initDate.getTime())}u.lastDuration=l;h[0]=parseInt(l/t.d,10);l=l%t.d;h[1]=parseInt(l/t.h,10);l=l%t.h;h[2]=parseInt(l/t.i,10);h[3]=l%t.i;j.find("input").each(function(){switch(a(this).parent().jqmData("field")){case"d":a(this).val(h[0]);break;case"h":a(this).val(h[1]);break;case"i":a(this).val(h[2]);break;case"s":a(this).val(h[3]);break}});u.d.divIn=j;c.addClass("ui-grid-"+["a","b","c"][u.fldOrder.length-2]).appendTo(u.d.intHTML);j.addClass("ui-grid-"+["a","b","c"][u.fldOrder.length-2]).appendTo(u.d.intHTML);k.addClass("ui-grid-"+["a","b","c"][u.fldOrder.length-2]).appendTo(u.d.intHTML);if(f.mobVer>=140){k.find("div").css({"min-height":"2.3em"});c.find("div").css({"min-height":"2.3em"})}if(f.useSetButton||f.useClearButton){s=a("<div>",{"class":q+"controls"});if(f.useSetButton){a('<a href="#">'+u.__("setDurationButtonLabel")+"</a>").appendTo(s).buttonMarkup({theme:f.theme,icon:"check",iconpos:"left",corners:true,shadow:true}).on(f.clickEventAlt,function(g){g.preventDefault();u.d.input.trigger("datebox",{method:"set",value:u._formatter(u.__fmt(),u.theDate),date:u.theDate});u.d.input.trigger("datebox",{method:"close"})})}if(f.useClearButton){a('<a href="#">'+u.__("clearButton")+"</a>").appendTo(s).buttonMarkup({theme:f.theme,icon:"delete",iconpos:"left",corners:true,shadow:true}).on(f.clickEventAlt,function(g){g.preventDefault();u.d.input.val("");u.d.input.trigger("datebox",{method:"clear"});u.d.input.trigger("datebox",{method:"close"})})}if(f.useCollapsedBut){s.addClass("ui-datebox-collapse")}s.appendTo(u.d.intHTML)}if(f.repButton===false){c.on(f.clickEvent,"div",function(g){g.preventDefault();u._offset(a(this).jqmData("field"),f.durationSteppers[a(this).jqmData("field")])});k.on(f.clickEvent,"div",function(g){g.preventDefault();u._offset(a(this).jqmData("field"),f.durationSteppers[a(this).jqmData("field")]*-1)})}j.on("change","input",function(){u._durbox_enter(a(this))});if(u.wheelExists){j.on("mousewheel","input",function(g,i){g.preventDefault();u._offset(a(this).parent().jqmData("field"),((i<0)?-1:1)*f.durationSteppers[a(this).parent().jqmData("field")])})}if(f.repButton===true){c.on(u.drag.eStart,"div",function(g){m=[a(this).jqmData("field"),f.durationSteppers[a(this).jqmData("field")]];u.drag.move=true;u._dbox_delta=1;u._offset(m[0],m[1],false);u._durbox_run_update();if(!u.runButton){u.drag.target=m;u.runButton=setTimeout(function(){u._durbox_run()},500)}});k.on(u.drag.eStart,"div",function(g){m=[a(this).jqmData("field"),f.durationSteppers[a(this).jqmData("field")]*-1];u.drag.move=true;u._dbox_delta=-1;u._offset(m[0],m[1],false);u._durbox_run_update();if(!u.runButton){u.drag.target=m;u.runButton=setTimeout(function(){u._durbox_run()},500)}});c.on(n.eEndA,function(g){if(n.move){g.preventDefault();clearTimeout(u.runButton);u.runButton=false;n.move=false}});k.on(n.eEndA,function(g){if(n.move){g.preventDefault();clearTimeout(u.runButton);u.runButton=false;n.move=false}})}}})})(jQuery);