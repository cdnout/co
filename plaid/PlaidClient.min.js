"use strict";var P=require("bluebird"),R=require("ramda"),plaidEnvironments=require("./plaidEnvironments"),plaidRequest=require("./plaidRequest"),wrapPromise=require("./wrapPromise");const DEFAULT_VERSION="2020-09-14";function Client(t){if(!R.is(Object,t))throw new Error("Unexpected parameter type. Refer to https://github.com/plaid/plaid-node for how to create a Plaid client.");if(R.isNil(t.clientID))throw new Error('Missing Plaid "clientID"');if(R.isNil(t.secret))throw new Error('Missing Plaid "secret"');if(!R.any(R.equals(t.env),R.values(plaidEnvironments)))throw new Error("Invalid Plaid environment");if(arguments.length>1)throw new Error("Too many arguments to constructor");this.client_id=t.clientID,this.secret=t.secret,this.env=t.env,null==t.options&&(t.options={}),null==t.options.version&&(t.options.version=DEFAULT_VERSION),this.client_request_opts=t.options}var requestWithAccessToken=function(t){return function(e,n,i){return this._authenticatedRequest({path:t,body:{access_token:e}},n,i)}},requestWithIncomeVerificationId=function(t){return function(e,n,i){return this._authenticatedRequest({path:t,body:{income_verification_id:e}},i)}};Client.prototype._authenticatedRequest=function(t,e,n){"function"==typeof e?(n=e,e={}):t.body.options=e;var i=R.merge({env:this.env},{client_id:this.client_id,secret:this.secret});return plaidRequest(i,t,this.client_request_opts,n)},Client.prototype.createPublicToken=function(t,e,n){const i=requestWithAccessToken("/item/public_token/create",!1);return console.warn("Warning: this method will be deprecated in a future version.\n  To replace the public_token for initializing Link,\n  look into the link_token at\n  https://plaid.com/docs/api/tokens/#linktokencreate"),i.call(this,t,e,n)};const linkTokenConfigFields=["user","client_name","products","country_codes","language","webhook","access_token","link_customization_name","redirect_uri","android_package_name","account_filters","cross_app_item_add","payment_initiation"];Client.prototype.createLinkToken=function(t,e){const n=linkTokenConfigFields.reduce((e,n)=>(e[n]=t[n],e),{});return this._authenticatedRequest({path:"/link/token/create",body:n},e)},Client.prototype.getLinkToken=function(t,e){return this._authenticatedRequest({path:"/link/token/get",body:{link_token:t}},e)},Client.prototype.exchangePublicToken=function(t,e){return this._authenticatedRequest({path:"/item/public_token/exchange",body:{public_token:t}},e)},Client.prototype.updateItemWebhook=function(t,e,n){return this._authenticatedRequest({path:"/item/webhook/update",body:{access_token:t,webhook:e}},n)},Client.prototype.createProcessorToken=function(t,e,n,i){var o="/processor/token/create";const r={access_token:t,account_id:e,processor:n};return"stripe"===n?(o="/processor/stripe/bank_account_token/create",delete r.processor):"apex"===n&&(o="/processor/apex/processor_token/create",delete r.processor),this._authenticatedRequest({path:o,body:r},i)},Client.prototype.createStripeToken=function(t,e,n){return this.createProcessorToken(t,e,"stripe",n)},Client.prototype.invalidateAccessToken=requestWithAccessToken("/item/access_token/invalidate"),Client.prototype.removeItem=requestWithAccessToken("/item/remove"),Client.prototype.getItem=requestWithAccessToken("/item/get"),Client.prototype.importItem=function(t,e,n,i){return this._authenticatedRequest({path:"/item/import",body:{products:t,user_auth:e}},n,i)},Client.prototype.getAccounts=requestWithAccessToken("/accounts/get"),Client.prototype.getBalance=requestWithAccessToken("/accounts/balance/get"),Client.prototype.getAuth=requestWithAccessToken("/auth/get"),Client.prototype.getIdentity=requestWithAccessToken("/identity/get"),Client.prototype.getIncome=requestWithAccessToken("/income/get"),Client.prototype.getTransactions=function(t,e,n,i,o){return this._authenticatedRequest({path:"/transactions/get",body:{access_token:t,start_date:e,end_date:n}},i,o)},Client.prototype.getAllTransactions=function(t,e,n,i,o){"function"==typeof i?(o=i,i={}):i=R.defaultTo({},i);var r=this;return wrapPromise(P.coroutine(function*(){for(var o=[],s=0,a={};;){const c=yield r.getTransactions(t,e,n,R.merge(i,{count:500,offset:o.length}));if(a.accounts=c.accounts,a.item=c.item,null!=c.transactions&&(o=R.concat(o,c.transactions),s+=c.transactions.length),s>=c.total_transactions)break}return a.total_transactions=s,a.transactions=o,a})(),o,{no_spread:!0})},Client.prototype.refreshTransactions=requestWithAccessToken("/transactions/refresh"),Client.prototype.getCreditDetails=requestWithAccessToken("/credit_details/get"),Client.prototype.getHoldings=requestWithAccessToken("/investments/holdings/get"),Client.prototype.getPaystub=requestWithIncomeVerificationId("/income/verification/paystub/get"),Client.prototype.getSummary=requestWithIncomeVerificationId("/income/verification/summary/get"),Client.prototype.getInvestmentTransactions=function(t,e,n,i,o){return this._authenticatedRequest({path:"/investments/transactions/get",body:{access_token:t,start_date:e,end_date:n}},i,o)},Client.prototype.getLiabilities=requestWithAccessToken("/liabilities/get"),Client.prototype.createAssetReport=function(t,e,n,i){return this._authenticatedRequest({path:"/asset_report/create",body:{access_tokens:t,days_requested:e}},n,i)},Client.prototype.filterAssetReport=function(t,e,n){return this._authenticatedRequest({path:"/asset_report/filter",body:{asset_report_token:t,account_ids_to_exclude:e}},n)},Client.prototype.refreshAssetReport=function(t,e,n,i){return this._authenticatedRequest({path:"/asset_report/refresh",body:{asset_report_token:t,days_requested:e}},n,i)},Client.prototype.getAssetReport=function(t,e,n){return this._authenticatedRequest({path:"/asset_report/get",body:{asset_report_token:t,include_insights:e}},n)},Client.prototype.getAssetReportPdf=function(t,e){return this._authenticatedRequest({path:"/asset_report/pdf/get",body:{asset_report_token:t},binary:!0},e)},Client.prototype.createAuditCopy=function(t,e,n){return this._authenticatedRequest({path:"/asset_report/audit_copy/create",body:{asset_report_token:t,auditor_id:e}},n)},Client.prototype.getAuditCopy=function(t,e){return this._authenticatedRequest({path:"/asset_report/audit_copy/get",body:{audit_copy_token:t}},e)},Client.prototype.removeAuditCopy=function(t,e){return this._authenticatedRequest({path:"/asset_report/audit_copy/remove",body:{audit_copy_token:t}},e)},Client.prototype.removeAssetReport=function(t,e){return this._authenticatedRequest({path:"/asset_report/remove",body:{asset_report_token:t}},e)},Client.prototype.createPaymentRecipient=function(t,e,n,i,o){return this._authenticatedRequest({path:"/payment_initiation/recipient/create",body:{name:t,iban:null!=e?e:void 0,address:n,bacs:null!=i?i:void 0}},o)},Client.prototype.getPaymentRecipient=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/recipient/get",body:{recipient_id:t}},e)},Client.prototype.listPaymentRecipients=function(t){return this._authenticatedRequest({path:"/payment_initiation/recipient/list"},t)},Client.prototype.createPayment=function(t,e,n,i){return this._authenticatedRequest({path:"/payment_initiation/payment/create",body:{recipient_id:t,reference:e,amount:n}},i)},Client.prototype.createPaymentToken=function(t,e){return console.warn("Warning: this method will be deprecated in a future version.\n    To replace the payment_token,\n    look into the link_token at\n    https://plaid.com/docs/api/tokens/#linktokencreate."),this._authenticatedRequest({path:"/payment_initiation/payment/token/create",body:{payment_id:t}},e)},Client.prototype.getPayment=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/payment/get",body:{payment_id:t}},e)},Client.prototype.listPayments=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/payment/list",body:t},e)},Client.prototype.getDepositSwitch=function(t,e,n){return this._authenticatedRequest({path:"/deposit_switch/get",body:{deposit_switch_id:t}},e,n)},Client.prototype.createDepositSwitch=function(t,e,n,i){return this._authenticatedRequest({path:"/deposit_switch/create",body:{target_account_id:t,target_access_token:e}},n,i)},Client.prototype.createDepositSwitchToken=function(t,e,n){return this._authenticatedRequest({path:"/deposit_switch/token/create",body:{deposit_switch_id:t}},e,n)},Client.prototype.getInstitutions=function(t,e,n,i,o){return this._authenticatedRequest({path:"/institutions/get",body:{count:t,offset:e,country_codes:n}},i,o)},Client.prototype.getInstitutionById=function(t,e,n,i){return this._authenticatedRequest({path:"/institutions/get_by_id",body:{institution_id:t,country_codes:e}},n,i)},Client.prototype.searchInstitutionsByName=function(t,e,n,i,o){return this._authenticatedRequest({path:"/institutions/search",body:{query:t,products:e,country_codes:n}},i,o)},Client.prototype.getCategories=function(t){return plaidRequest({env:this.env},{path:"/categories/get"},this.client_request_opts,t)},Client.prototype.resetLogin=requestWithAccessToken("/sandbox/item/reset_login"),Client.prototype.getWebhookVerificationKey=function(t,e){return this._authenticatedRequest({path:"/webhook_verification_key/get",body:{key_id:t}},e)},Client.prototype.sandboxPublicTokenCreate=function(t,e,n,i){return this._authenticatedRequest({path:"/sandbox/public_token/create",body:{institution_id:t,initial_products:e}},n,i)},Client.prototype.sandboxItemFireWebhook=function(t,e,n){return this._authenticatedRequest({path:"/sandbox/item/fire_webhook",body:{access_token:t,webhook_code:e}},n)},Client.prototype.sandboxItemSetVerificationStatus=function(t,e,n,i){return this._authenticatedRequest({path:"/sandbox/item/set_verification_status",body:{access_token:t,account_id:e,verification_status:n}},i)},module.exports=Client;