"use strict";var P=require("bluebird"),R=require("ramda"),plaidEnvironments=require("./plaidEnvironments"),plaidRequest=require("./plaidRequest"),wrapPromise=require("./wrapPromise");const DEFAULT_VERSION="2020-09-14";function Client(t){if(!R.is(Object,t))throw new Error("Unexpected parameter type. Refer to https://github.com/plaid/plaid-node for how to create a Plaid client.");if(R.isNil(t.clientID))throw new Error('Missing Plaid "clientID"');if(R.isNil(t.secret))throw new Error('Missing Plaid "secret"');if(!R.any(R.equals(t.env),R.values(plaidEnvironments)))throw new Error("Invalid Plaid environment");if(1<arguments.length)throw new Error("Too many arguments to constructor");this.client_id=t.clientID,this.secret=t.secret,this.env=t.env,null==t.options&&(t.options={}),null==t.options.version&&(t.options.version=DEFAULT_VERSION),this.client_request_opts=t.options}var requestWithAccessToken=function(n){return function(t,e,i){return this._authenticatedRequest({path:n,body:{access_token:t}},e,i)}},requestWithIncomeVerificationId=function(n){return function(t,e,i){return this._authenticatedRequest({path:n,body:{income_verification_id:t}},i)}};Client.prototype._authenticatedRequest=function(t,e,i){"function"==typeof e?(i=e,e={}):t.body.options=e;e=R.merge({env:this.env},{client_id:this.client_id,secret:this.secret});return plaidRequest(e,t,this.client_request_opts,i)},Client.prototype.createPublicToken=function(t,e,i){const n=requestWithAccessToken("/item/public_token/create",!1);return console.warn(`Warning: this method will be deprecated in a future version.
  To replace the public_token for initializing Link,
  look into the link_token at
  https://plaid.com/docs/api/tokens/#linktokencreate`),n.call(this,t,e,i)};const linkTokenConfigFields=["user","client_name","products","country_codes","language","webhook","access_token","link_customization_name","redirect_uri","android_package_name","account_filters","cross_app_item_add","payment_initiation","deposit_switch","income_verification","institution_id","eu_config"];Client.prototype.createLinkToken=function(i,t){var e=linkTokenConfigFields.reduce((t,e)=>(t[e]=i[e],t),{});return this._authenticatedRequest({path:"/link/token/create",body:e},t)},Client.prototype.getLinkToken=function(t,e){return this._authenticatedRequest({path:"/link/token/get",body:{link_token:t}},e)},Client.prototype.exchangePublicToken=function(t,e){return this._authenticatedRequest({path:"/item/public_token/exchange",body:{public_token:t}},e)},Client.prototype.updateItemWebhook=function(t,e,i){return this._authenticatedRequest({path:"/item/webhook/update",body:{access_token:t,webhook:e}},i)},Client.prototype.createProcessorToken=function(t,e,i,n){var o="/processor/token/create";const r={access_token:t,account_id:e,processor:i};return"stripe"===i?(o="/processor/stripe/bank_account_token/create",delete r.processor):"apex"===i&&(o="/processor/apex/processor_token/create",delete r.processor),this._authenticatedRequest({path:o,body:r},n)},Client.prototype.createStripeToken=function(t,e,i){return this.createProcessorToken(t,e,"stripe",i)},Client.prototype.invalidateAccessToken=requestWithAccessToken("/item/access_token/invalidate"),Client.prototype.removeItem=requestWithAccessToken("/item/remove"),Client.prototype.getItem=requestWithAccessToken("/item/get"),Client.prototype.importItem=function(t,e,i,n){return this._authenticatedRequest({path:"/item/import",body:{products:t,user_auth:e}},i,n)},Client.prototype.getAccounts=requestWithAccessToken("/accounts/get"),Client.prototype.getBalance=requestWithAccessToken("/accounts/balance/get"),Client.prototype.getAuth=requestWithAccessToken("/auth/get"),Client.prototype.getIdentity=requestWithAccessToken("/identity/get"),Client.prototype.getIncome=requestWithAccessToken("/income/get"),Client.prototype.getTransactions=function(t,e,i,n,o){return this._authenticatedRequest({path:"/transactions/get",body:{access_token:t,start_date:e,end_date:i}},n,o)},Client.prototype.getAllTransactions=function(o,r,s,a,t){a="function"==typeof a?(t=a,{}):R.defaultTo({},a);var c=this;return wrapPromise(P.coroutine(function*(){for(var t=[],e=0,i={};;){var n=yield c.getTransactions(o,r,s,R.merge(a,{count:500,offset:t.length}));if(i.accounts=n.accounts,i.item=n.item,null!=n.transactions&&(t=R.concat(t,n.transactions),e+=n.transactions.length),e>=n.total_transactions)break}return i.total_transactions=e,i.transactions=t,i})(),t,{no_spread:!0})},Client.prototype.refreshTransactions=requestWithAccessToken("/transactions/refresh"),Client.prototype.getCreditDetails=requestWithAccessToken("/credit_details/get"),Client.prototype.getHoldings=requestWithAccessToken("/investments/holdings/get"),Client.prototype.getPaystub=requestWithIncomeVerificationId("/income/verification/paystub/get"),Client.prototype.getPaystubs=requestWithIncomeVerificationId("/income/verification/paystubs/get"),Client.prototype.getSummary=requestWithIncomeVerificationId("/income/verification/summary/get"),Client.prototype.getInvestmentTransactions=function(t,e,i,n,o){return this._authenticatedRequest({path:"/investments/transactions/get",body:{access_token:t,start_date:e,end_date:i}},n,o)},Client.prototype.getLiabilities=requestWithAccessToken("/liabilities/get"),Client.prototype.createAssetReport=function(t,e,i,n){return this._authenticatedRequest({path:"/asset_report/create",body:{access_tokens:t,days_requested:e}},i,n)},Client.prototype.filterAssetReport=function(t,e,i){return this._authenticatedRequest({path:"/asset_report/filter",body:{asset_report_token:t,account_ids_to_exclude:e}},i)},Client.prototype.refreshAssetReport=function(t,e,i,n){return this._authenticatedRequest({path:"/asset_report/refresh",body:{asset_report_token:t,days_requested:e}},i,n)},Client.prototype.getAssetReport=function(t,e,i){return this._authenticatedRequest({path:"/asset_report/get",body:{asset_report_token:t,include_insights:e}},i)},Client.prototype.getAssetReportPdf=function(t,e){return this._authenticatedRequest({path:"/asset_report/pdf/get",body:{asset_report_token:t},binary:!0},e)},Client.prototype.createAuditCopy=function(t,e,i){return this._authenticatedRequest({path:"/asset_report/audit_copy/create",body:{asset_report_token:t,auditor_id:e}},i)},Client.prototype.getAuditCopy=function(t,e){return this._authenticatedRequest({path:"/asset_report/audit_copy/get",body:{audit_copy_token:t}},e)},Client.prototype.removeAuditCopy=function(t,e){return this._authenticatedRequest({path:"/asset_report/audit_copy/remove",body:{audit_copy_token:t}},e)},Client.prototype.removeAssetReport=function(t,e){return this._authenticatedRequest({path:"/asset_report/remove",body:{asset_report_token:t}},e)},Client.prototype.createPaymentRecipient=function(t,e,i,n,o){return this._authenticatedRequest({path:"/payment_initiation/recipient/create",body:{name:t,iban:null!=e?e:void 0,address:i,bacs:null!=n?n:void 0}},o)},Client.prototype.getPaymentRecipient=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/recipient/get",body:{recipient_id:t}},e)},Client.prototype.listPaymentRecipients=function(t){return this._authenticatedRequest({path:"/payment_initiation/recipient/list"},t)},Client.prototype.createPayment=function(t,e,i,n,o){return this._authenticatedRequest({path:"/payment_initiation/payment/create",body:{recipient_id:t,reference:e,amount:i}},n,o)},Client.prototype.createPaymentToken=function(t,e){return console.warn(`Warning: this method will be deprecated in a future version.
    To replace the payment_token,
    look into the link_token at
    https://plaid.com/docs/api/tokens/#linktokencreate.`),this._authenticatedRequest({path:"/payment_initiation/payment/token/create",body:{payment_id:t}},e)},Client.prototype.getPayment=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/payment/get",body:{payment_id:t}},e)},Client.prototype.listPayments=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/payment/list",body:t},e)},Client.prototype.getDepositSwitch=function(t,e,i){return this._authenticatedRequest({path:"/deposit_switch/get",body:{deposit_switch_id:t}},e,i)},Client.prototype.createDepositSwitch=function(t,e,i,n){return this._authenticatedRequest({path:"/deposit_switch/create",body:{target_account_id:t,target_access_token:e}},i,n)},Client.prototype.createDepositSwitchAlt=function(t,e,i,n){return this._authenticatedRequest({path:"/deposit_switch/alt/create",body:{target_account:t,target_user:e}},i,n)},Client.prototype.createDepositSwitchToken=function(t,e,i){return this._authenticatedRequest({path:"/deposit_switch/token/create",body:{deposit_switch_id:t}},e,i)},Client.prototype.createIncomeVerification=function(t,e){return this._authenticatedRequest({path:"/income/verification/create",body:{webhook:t}},e)},Client.prototype.getInstitutions=function(t,e,i,n,o){return this._authenticatedRequest({path:"/institutions/get",body:{count:t,offset:e,country_codes:i}},n,o)},Client.prototype.getInstitutionById=function(t,e,i,n){return this._authenticatedRequest({path:"/institutions/get_by_id",body:{institution_id:t,country_codes:e}},i,n)},Client.prototype.searchInstitutionsByName=function(t,e,i,n,o){return this._authenticatedRequest({path:"/institutions/search",body:{query:t,products:e,country_codes:i}},n,o)},Client.prototype.getCategories=function(t){return plaidRequest({env:this.env},{path:"/categories/get"},this.client_request_opts,t)},Client.prototype.resetLogin=requestWithAccessToken("/sandbox/item/reset_login"),Client.prototype.getWebhookVerificationKey=function(t,e){return this._authenticatedRequest({path:"/webhook_verification_key/get",body:{key_id:t}},e)},Client.prototype.sandboxPublicTokenCreate=function(t,e,i,n){return this._authenticatedRequest({path:"/sandbox/public_token/create",body:{institution_id:t,initial_products:e}},i,n)},Client.prototype.sandboxItemFireWebhook=function(t,e,i){return this._authenticatedRequest({path:"/sandbox/item/fire_webhook",body:{access_token:t,webhook_code:e}},i)},Client.prototype.sandboxItemSetVerificationStatus=function(t,e,i,n){return this._authenticatedRequest({path:"/sandbox/item/set_verification_status",body:{access_token:t,account_id:e,verification_status:i}},n)},module.exports=Client;