(function(){angular.module("ModelCore",["ng"]).factory("ModelCore",["$http","$q","$filter","$rootScope",function(e,b,d,a){var c=function c(f){this.$init.apply(this,arguments)};c.prototype={$uuid:null,$pkField:null,$settings:{},$mapping:{},$hasMany:{},$hasOne:{},$dataset:[],$scope:null,$init:function(g){var f=this;f.$settings=angular.extend({headers:{"Content-Type":"application/json"},dataField:{one:"content",many:"items"},urls:{base:null},httpMethods:{create:"PUT",read:"GET",update:"POST",destroy:"DELETE"}},f.$settings);f.$uuid=c.getUUID()},$offline:false,$resetTo:function(h){var f=this;h=!h||{};for(var g in f.$mapping){if(f.$mapping.hasOwnProperty(g)){f.__proto__[g]=typeof h[g]!=="undefined"?h[g]:null}}return f},$reset:function(){return this.$resetTo({})},$add:function(f){this.$dataset.push(f)},$new:function(h){var f=this;h=typeof h==="undefined"?f.$mapping:h;var j=new new c.newInstance({},f);j._cache={};for(var g in f.$mapping){j._cache[g]=c.clone(h[g]);j[g]=c.clone(h[g])}return j},$fetch:function(){return this.next()},$incremental:function(g,f){return this.$find(g,f,true)},$find:function(h,g,i){var f=this;i=!(typeof i==="undefined"||i==false);g=angular.extend({url:f.$url("get"),method:f.$settings.httpMethods.read,query:h},g?g:{});return f.$call({url:g.url,method:g.method},f,g.query).success(function(j){if(i!==true){f.$dataset=[]}return f.$parse(j)})},$getRelationship:function(j,l,h){var g=this;for(var f in g.$hasMany){if(f===j){g[f]=new g.$mapping[f]();l=l||{};for(var k in g.$hasMany[f]){l[k]=g[g.$hasMany[f][k]]}return g[f].$find(l,h)}}for(var f in g.$hasOne){if(f===j){g[f]=g.$mapping[f]();var n=g[g.$hasMany[f].id];var m=g.$hasMany[f].field||null;return g[f].$get(n,m)}}},$get:function(j,i,g){var f=this;if(f.$pkField==null&&typeof i==="undefined"){throw"You must setup a model.$pkField to perform this operation or define the second parameter field"}i=typeof i!=="undefined"?i:f.$pkField;var h={};h[i]=j;g=angular.extend({url:f.$url("get",h),method:f.$settings.httpMethods.read,query:{}},g?g:{});return f.$call({url:g.url,method:g.method},f,g.query).success(function(k){f.$dataset=[];f.$parse(k);f.$fetch();f.$dataset=f.$dataset.length===1?f.$dataset:d("filter")(f.$dataset,function(l){return l[i]==j?l:false});return f.$dataset})},$save:function(h){var g=this;var f=g[g.$pkField]===""||g[g.$pkField]===undefined||g[g.$pkField]==null?true:false;var k=f?g.$settings.httpMethods.create:g.$settings.httpMethods.update;var i={};if(!f){var j=g.$pkField;i[j]=g[j]}h=angular.extend({url:g.$url(k.toLowerCase(),i),method:k,query:{}},h?h:{});return g.$call({url:h.url,method:h.method,data:g.$toObject()},g,h.query).success(function(){g.$cleanDiff()})},$cleanDiff:function(){var f=this;if(typeof f._cache==="undefined"){f._cache={}}var g=f.$toObject();for(var h in g){if(g.hasOwnProperty(h)){if(typeof g[h]==="object"){f._cache[h]=c.clone(g[h])}else{f._cache[h]=g[h]}}}},$delete:function(j,i,g){var f=this;if(f.$pkField==null&&typeof i==="undefined"){throw"You must setup a model.$pkField to perform this operation or define the second parameter field"}i=typeof i!=="undefined"?i:f.$pkField;j=typeof j==="undefined"?f[i]:j;var h={};h[i]=j;g=angular.extend({url:f.$url("delete",h),method:f.$settings.httpMethods.destroy,query:{}},g?g:{});return f.$call({url:g.url,method:g.method,data:f.$toObject()},f,g.query).success(function(){c.destroy(f)})},$toObject:function(){var f=this;var h;var g={};for(h in f.$mapping){if(f.$mapping.hasOwnProperty(h)){g[h]=f[h]}}return g},$original:function(){var f=this;var h;var g={};if(typeof f._cache==="undefined"){f._cache={};return false}for(h in f.$mapping){if(f.$mapping.hasOwnProperty(h)){if(typeof g[h]!=="object"){g[h]=f._cache[h]}else{g[h]=angular.extend(g[h],f._cache[h])}}}return g},$isChanged:function(h){var f=this;var g=f.$diff();if(typeof h==="undefined"&&g!==false){return Object.keys(g).length>0}else{if(g[h]){return !!g[h]}else{return false}}},$diff:function(i,g){var f=this;var h={};i=typeof i==="undefined"?f.$original():i;g=typeof g==="undefined"?f.$toObject():g;if(i===false){return false}for(var k in g){if(g.hasOwnProperty(k)){if(!i||i[k]!==g[k]){if(typeof g[k]==="object"&&g[k]!==null&&typeof i[k]!=="undefined"){var j=f.$diff(i[k],g[k]);if(!c.isEmpty(j)){h[k]=j}}else{h[k]=g[k]}}}}return h},$call:function(h,g,i){var f=this;return !f.$offline?c.call(h,g,i):c.callOffline(h,g,i)},$parse:function(g){var f=this;return f.$dataset=f.$dataset.concat(c.parse(g,f))},__cursor:0,next:function(){var f=this;var g=f.__cursor;f.__cursor++;return f.$goTo(g)},prev:function(){var f=this;var g=f.__cursor;f.__cursor--;return f.$goTo(g)},$goTo:function(g){var f=this;if(f.__cursor>f.$dataset.length){f.__cursor=0;return false}else{if(f.__cursor<0){f.__cursor=0;return false}}f.$mapping=f.$dataset[g].$mapping;if(typeof f._cache==="undefined"){f._cache={}}f._cache=f.$dataset[g]._cache;for(var h in f.$dataset[g].$toObject()){f[h]=f.$dataset[g][h];f.__proto__[h]=f.$dataset[g][h]}return f.$dataset[g]},$url:function(f,m){var n=this;var h=(typeof n.$settings.urls[f]==="undefined"||n.$settings.urls[f]==null)?n.$settings.urls.base:n.$settings.urls[f];if(h==null||typeof h==="undefined"){throw ("Model URL missing for "+typeof n+" in ["+f+"].")}var g=/(:[A-z]+\/?)/g;var o=h.match(g);var k;for(k in o){if(o.hasOwnProperty(k)){var j=o[k].replace("/","");var l=j.replace(":","");if(!m||typeof m[l]==="undefined"){h=h.replace(o[k],"")}else{h=h.replace(j,m[l])}}}h=h.replace("/.",".");return h}};c.destroy=function(g){if(typeof g.$parentModel!=="undefined"){var f=g.$parentModel.$dataset.indexOf(g);g.$parentModel.$dataset.splice(f,1)}};c.OfflineSettings={key:"_ModelCoreOfflineData"};c.call=function(h,g,i){var f=this;if(typeof h==="undefined"){h={}}if(!h.method){throw"You must setup a method"}if(!h.url){throw"You must setup an url"}if(i){h.params=i}h.headers=g.$settings.headers;h.withCredentials=g.$settings.withCredentials;return e(h)};c.__call=function(i,h,l){var g=b.defer();var j=c.OfflineSettings.key;if(typeof Storage!=="undefined"){var k={calls:[]};var f=sessionStorage.getItem(j);if(typeof f==="undefined"||f==null){sessionStorage.setItem(j,"{}");f=sessionStorage.getItem(j)}f=JSON.parse(f);k.calls[i.method].push({options:i,uuid:h.$uuid});angular.extend(f,k);sessionStorage.setItem(j,JSON.stringify(k));g.resolve(h)}else{g.reject("Error processing offline call: "+k.toString())}return g};c.newInstance=function(g,f){return c.instance(g,f)};c.parse=function(l,g){var j=l[g.$settings.dataField.one]?[l[g.$settings.dataField.one]]:l[g.$settings.dataField.many];var h;var f=this;var k=function(i){angular.extend(i,g);return c.instance(i,g)};var n=[];for(h in j){if(j.hasOwnProperty(h)){var m;j[h].$mapping={};if(typeof g.$mapping!=="undefined"){angular.extend(j[h].$mapping,g.$mapping)}j[h]._cache={};for(m in j[h]){if(j[h].hasOwnProperty(m)){if(m!="$mapping"&&m!="_cache"){j[h].$mapping[m]=true;if(typeof j[h][m]==="object"){j[h]._cache[m]=c.clone(j[h][m])}else{j[h]._cache[m]=j[h][m]}}}}j[h].$parentModel=g;n.push(new new c.newInstance(j[h],g))}}return n};c.clone=function(j){if(null==j||"object"!==typeof j){return j}if(j instanceof Date){var k=new Date();k.setTime(j.getTime());return k}if(j instanceof Array){var k=[];for(var h=0,g=j.length;h<g;h++){k[h]=c.clone(j[h])}return k}if(j instanceof Object){var k={};for(var f in j){if(j.hasOwnProperty(f)){k[f]=c.clone(j[f])}}return k}throw new Error("Unable to copy obj! Its type isn't supported.")};c.instance=function(j,g){var f;var i=window._ModelCoreConstructor=this;var h=g?g.$type:j.$type;f=new Function("return function "+h+"(settings) { window._ModelCoreConstructor.apply(this,arguments) }")();var k=function(){this.$__construct=f};k.prototype=i.prototype;f.prototype=new k();if(g){angular.extend(f.prototype,g.__proto__)}if(j){angular.extend(f.prototype,j)}angular.extend(f,i,g);f.__super__=i.prototype;return f};c.urlencode=function(f){f=(f+"").toString();return encodeURIComponent(f).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")};c.buildQuery=function(m,i,g){var j,l,f=[];var n=this;var k=function(r,s,o){var p,q=[];if(s===true){s="1"}else{if(s===false){s="0"}}if(s!=null){if(typeof(s)==="object"){for(p in s){if(s.hasOwnProperty(p)&&s[p]!=null){q.push(k(r+"["+p+"]",s[p],o))}}return q.join(o)}else{if(typeof(s)!=="function"){return n.urlencode(r)+"="+n.urlencode(s)}else{throw new Error("There was an error processing for http_build_query().")}}}else{return""}};if(!g){g="&"}for(l in m){if(m.hasOwnProperty(l)){j=m[l];if(i&&!isNaN(l)){l=String(i)+l}var h=k(l,j,g);if(h!==""){f.push(h)}}}return f.join(g)};c.isEmpty=function(g){if(g==null){return true}if(g.toString()==="[object Array]"||g.toString()==="[object String]"){return g.length===0}for(var f in g){if(g.hasOwnProperty(f)){return false}}return true};c.getUUID=function(){var g=[],h="0123456789ABCDEF";for(var f=0;f<36;f++){g[f]=Math.floor(Math.random()*16)}g[14]=4;g[19]=(g[19]&3)|8;for(f=0;f<36;f++){g[f]=h[g[f]]}g[8]=g[13]=g[18]=g[23]="-";return g.join("")};c.queryToObject=function(j){var k=j||window.location.search||"";var i=[];var h={};k=k.replace(/.*?\?/,"");if(k.length){i=k.split("&");for(var f in i){var g=i[f].split("=")[0];if(!g.length){continue}if(typeof h[g]==="undefined"){h[g]=[]}h[g].push(i[f].split("=")[1])}}return h};return c}])})();