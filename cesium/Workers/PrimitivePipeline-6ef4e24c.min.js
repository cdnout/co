define(["exports","./Transforms-dca21951","./ComponentDatatype-a15c9a19","./defaultValue-81eec7ed","./RuntimeError-8952249c","./Matrix2-37e55508","./GeometryAttribute-cc3a5bc9","./GeometryAttributes-32b29525","./GeometryPipeline-20022973","./IndexDatatype-f1dcdf35","./WebMercatorProjection-2839e524"],function(e,y,b,l,t,f,x,G,m,S,s){"use strict";function a(e,t,n){e=l.defaultValue(e,0),t=l.defaultValue(t,0),n=l.defaultValue(n,0),this.value=new Float32Array([e,t,n])}function h(e,t){const n=e.attributes,r=n.position,o=r.values.length/r.componentsPerAttribute;n.batchId=new x.GeometryAttribute({componentDatatype:b.ComponentDatatype.FLOAT,componentsPerAttribute:1,values:new Float32Array(o)});const i=n.batchId.values;for(let e=0;e<o;++e)i[e]=t}function g(e){const t=e.instances,n=e.projection,r=e.elementIndexUintSupported,i=e.scene3DOnly,o=e.vertexCacheOptimize,s=e.compressVertices,a=e.modelMatrix;let c,d,p=t.length;for(c=0;c<p;++c)if(l.defined(t[c].geometry)){t[c].geometry.primitiveType;break}if(function(e,t){let n=!i;var r=e.length;let o;if(!n&&1<r){const t=e[0].modelMatrix;for(o=1;o<r;++o)if(!f.Matrix4.equals(t,e[o].modelMatrix)){n=!0;break}}if(n)for(o=0;o<r;++o)l.defined(e[o].geometry)&&m.GeometryPipeline.transformToWorldCoordinates(e[o]);else f.Matrix4.multiplyTransformation(t,e[0].modelMatrix,t)}(t,a),!i)for(c=0;c<p;++c)l.defined(t[c].geometry)&&m.GeometryPipeline.splitLongitude(t[c]);if(function(t){const n=t.length;for(let e=0;e<n;++e){const n=t[e];l.defined(n.geometry)?h(n.geometry,e):l.defined(n.westHemisphereGeometry)&&l.defined(n.eastHemisphereGeometry)&&(h(n.westHemisphereGeometry,e),h(n.eastHemisphereGeometry,e))}}(t),o)for(c=0;c<p;++c){const e=t[c];l.defined(e.geometry)?(m.GeometryPipeline.reorderForPostVertexCache(e.geometry),m.GeometryPipeline.reorderForPreVertexCache(e.geometry)):l.defined(e.westHemisphereGeometry)&&l.defined(e.eastHemisphereGeometry)&&(m.GeometryPipeline.reorderForPostVertexCache(e.westHemisphereGeometry),m.GeometryPipeline.reorderForPreVertexCache(e.westHemisphereGeometry),m.GeometryPipeline.reorderForPostVertexCache(e.eastHemisphereGeometry),m.GeometryPipeline.reorderForPreVertexCache(e.eastHemisphereGeometry))}let u=m.GeometryPipeline.combineInstances(t);for(p=u.length,c=0;c<p;++c){d=u[c];const e=d.attributes;if(i)for(const y in e)e.hasOwnProperty(y)&&e[y].componentDatatype===b.ComponentDatatype.DOUBLE&&m.GeometryPipeline.encodeAttribute(d,y,`${y}3DHigh`,`${y}3DLow`);else for(const t in e)if(e.hasOwnProperty(t)&&e[t].componentDatatype===b.ComponentDatatype.DOUBLE){const e=`${t}3D`,b=`${t}2D`;m.GeometryPipeline.projectTo2D(d,t,e,b,n),l.defined(d.boundingSphere)&&"position"===t&&(d.boundingSphereCV=y.BoundingSphere.fromVertices(d.attributes.position2D.values)),m.GeometryPipeline.encodeAttribute(d,e,`${e}High`,`${e}Low`),m.GeometryPipeline.encodeAttribute(d,b,`${b}High`,`${b}Low`)}s&&m.GeometryPipeline.compressVertices(d)}if(!r){let e=[];for(p=u.length,c=0;c<p;++c)d=u[c],e=e.concat(m.GeometryPipeline.fitToUnsignedShortIndices(d));u=e}return u}function P(t,n,r,o){let i,s,a;var c,e=o.length-1;if(0<=e){const t=o[e];i=t.offset+t.count,a=t.index,s=r[a].indices.length}else i=0,a=0,s=r[a].indices.length;const d=t.length;for(let e=0;e<d;++e){const d=t[e][n];l.defined(d)&&(c=d.indices.length,i+c>s&&(i=0,s=r[++a].indices.length),o.push({index:a,offset:i,count:c}),i+=c)}}Object.defineProperties(a.prototype,{componentDatatype:{get:function(){return b.ComponentDatatype.FLOAT}},componentsPerAttribute:{get:function(){return 3}},normalize:{get:function(){return!1}}}),a.fromCartesian3=function(e){return new a(e.x,e.y,e.z)},a.toValue=function(e,t){return(t=!l.defined(t)?new Float32Array([e.x,e.y,e.z]):t)[0]=e.x,t[1]=e.y,t[2]=e.z,t};const c={};function o(t){const n=t.length,e=1+(y.BoundingSphere.packedLength+1)*n,r=new Float32Array(e);let o=0;r[o++]=n;for(let e=0;e<n;++e){const n=t[e];l.defined(n)?(r[o++]=1,y.BoundingSphere.pack(t[e],r,o)):r[o++]=0,o+=y.BoundingSphere.packedLength}return r}function n(e){const t=new Array(e[0]);let n=0,r=1;for(;r<e.length;)1===e[r++]&&(t[n]=y.BoundingSphere.unpack(e,r)),++n,r+=y.BoundingSphere.packedLength;return t}c.combineGeometry=function(e){let t,n;const r=e.instances,o=r.length;let i,s,a=!1;var c,d,p;0<o&&(t=g(e),0<t.length&&(n=m.GeometryPipeline.createAttributeLocations(t[0]),e.createPickOffsets&&(i=(c=r,d=t,P(c,"geometry",d,p=[]),P(c,"westHemisphereGeometry",d,p),P(c,"eastHemisphereGeometry",d,p),p))),l.defined(r[0].attributes)&&l.defined(r[0].attributes.offset)&&(s=new Array(o),a=!0));const u=new Array(o),f=new Array(o);for(let e=0;e<o;++e){const t=r[e],n=t.geometry;l.defined(n)&&(u[e]=n.boundingSphere,f[e]=n.boundingSphereCV,a&&(s[e]=t.geometry.offsetAttribute));const o=t.eastHemisphereGeometry,i=t.westHemisphereGeometry;l.defined(o)&&l.defined(i)&&(l.defined(o.boundingSphere)&&l.defined(i.boundingSphere)&&(u[e]=y.BoundingSphere.union(o.boundingSphere,i.boundingSphere)),l.defined(o.boundingSphereCV)&&l.defined(i.boundingSphereCV)&&(f[e]=y.BoundingSphere.union(o.boundingSphereCV,i.boundingSphereCV)))}return{geometries:t,modelMatrix:e.modelMatrix,attributeLocations:n,pickOffsets:i,offsetInstanceExtend:s,boundingSpheres:u,boundingSpheresCV:f}},c.packCreateGeometryResults=function(t,n){const r=new Float64Array(function(t){let n=1;const r=t.length;for(let e=0;e<r;e++){const r=t[e];if(++n,l.defined(r)){const o=r.attributes;n+=7+2*y.BoundingSphere.packedLength+(l.defined(r.indices)?r.indices.length:0);for(const t in o)o.hasOwnProperty(t)&&l.defined(o[t])&&(n+=5+o[t].values.length)}}return n}(t)),o=[],i={},s=t.length;let a=0;r[a++]=s;for(let e=0;e<s;e++){const s=t[e],d=l.defined(s);if(r[a++]=d?1:0,d){r[a++]=s.primitiveType,r[a++]=s.geometryType,r[a++]=l.defaultValue(s.offsetAttribute,-1);var c=l.defined(s.boundingSphere)?1:0;(r[a++]=c)&&y.BoundingSphere.pack(s.boundingSphere,r,a),a+=y.BoundingSphere.packedLength;c=l.defined(s.boundingSphereCV)?1:0;(r[a++]=c)&&y.BoundingSphere.pack(s.boundingSphereCV,r,a),a+=y.BoundingSphere.packedLength;const p=s.attributes,u=[];for(const t in p)p.hasOwnProperty(t)&&l.defined(p[t])&&(u.push(t),l.defined(i[t])||(i[t]=o.length,o.push(t)));r[a++]=u.length;for(let e=0;e<u.length;e++){const y=u[e],n=p[y];r[a++]=i[y],r[a++]=n.componentDatatype,r[a++]=n.componentsPerAttribute,r[a++]=n.normalize?1:0,r[a++]=n.values.length,r.set(n.values,a),a+=n.values.length}c=l.defined(s.indices)?s.indices.length:0;0<(r[a++]=c)&&(r.set(s.indices,a),a+=c)}}return n.push(r.buffer),{stringTable:o,packedData:r}},c.unpackCreateGeometryResults=function(a){var c=a.stringTable,d=a.packedData;let p;const u=new Array(d[0]);let f=0,l=1;for(;l<d.length;)if(1===d[l++]){const a=d[l++],m=d[l++];let e,t,n=d[l++];-1===n&&(n=void 0),1===d[l++]&&(e=y.BoundingSphere.unpack(d,l)),l+=y.BoundingSphere.packedLength;let r,o,i;1===d[l++]&&(t=y.BoundingSphere.unpack(d,l)),l+=y.BoundingSphere.packedLength;const h=new G.GeometryAttributes,g=d[l++];for(p=0;p<g;p++){const a=c[d[l++]],y=d[l++];i=d[l++];const p=0!==d[l++];r=d[l++],o=b.ComponentDatatype.createTypedArray(y,r);for(let e=0;e<r;e++)o[e]=d[l++];h[a]=new x.GeometryAttribute({componentDatatype:y,componentsPerAttribute:i,normalize:p,values:o})}let s;if(r=d[l++],0<r){const a=o.length/i;for(s=S.IndexDatatype.createTypedArray(a,r),p=0;p<r;p++)s[p]=d[l++]}u[f++]=new x.Geometry({primitiveType:a,geometryType:m,boundingSphere:e,boundingSphereCV:t,indices:s,attributes:h,offsetAttribute:n})}else u[f++]=void 0;return u},c.packCombineGeometryParameters=function(e,t){var n=e.createGeometryResults,r=n.length;for(let e=0;e<r;e++)t.push(n[e].packedData.buffer);return{createGeometryResults:e.createGeometryResults,packedInstances:function(t,e){const n=t.length,r=new Float64Array(1+19*n);let o=0;r[o++]=n;for(let e=0;e<n;e++){const n=t[e];if(f.Matrix4.pack(n.modelMatrix,r,o),o+=f.Matrix4.packedLength,l.defined(n.attributes)&&l.defined(n.attributes.offset)){const t=n.attributes.offset.value;r[o]=t[0],r[o+1]=t[1],r[o+2]=t[2]}o+=3}return e.push(r.buffer),r}(e.instances,t),ellipsoid:e.ellipsoid,isGeographic:e.projection instanceof y.GeographicProjection,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e.createPickOffsets}},c.unpackCombineGeometryParameters=function(e){const t=function(t){const n=t,r=new Array(n[0]);let o=0,i=1;for(;i<n.length;){const t=f.Matrix4.unpack(n,i);let e;i+=f.Matrix4.packedLength,l.defined(n[i])&&(e={offset:new a(n[i],n[i+1],n[i+2])}),i+=3,r[o++]={modelMatrix:t,attributes:e}}return r}(e.packedInstances),n=e.createGeometryResults,r=n.length;let o=0;for(let e=0;e<r;e++){const y=c.unpackCreateGeometryResults(n[e]),l=y.length;for(let e=0;e<l;e++){const l=y[e];t[o].geometry=l,++o}}var i=f.Ellipsoid.clone(e.ellipsoid);return{instances:t,ellipsoid:i,projection:new(e.isGeographic?y.GeographicProjection:s.WebMercatorProjection)(i),elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:f.Matrix4.clone(e.modelMatrix),createPickOffsets:e.createPickOffsets}},c.packCombineGeometryResults=function(e,t){l.defined(e.geometries)&&function(t,n){var r=t.length;for(let e=0;e<r;++e)!function(e,t){const n=e.attributes;for(const e in n){var r;n.hasOwnProperty(e)&&(r=n[e],l.defined(r)&&l.defined(r.values)&&t.push(r.values.buffer))}l.defined(e.indices)&&t.push(e.indices.buffer)}(t[e],n)}(e.geometries,t);var n=o(e.boundingSpheres),r=o(e.boundingSpheresCV);return t.push(n.buffer,r.buffer),{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:n,boundingSpheresCV:r}},c.unpackCombineGeometryResults=function(e){return{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:n(e.boundingSpheres),boundingSpheresCV:n(e.boundingSpheresCV)}},e.PrimitivePipeline=c});