define(["exports","./Transforms-dca21951","./Matrix2-37e55508","./RuntimeError-8952249c","./defaultValue-81eec7ed","./AttributeCompression-27507afe","./ComponentDatatype-a15c9a19"],function(t,r,p,e,x,m,h){"use strict";function i(t,e){this._ellipsoid=t,this._cameraPosition=new p.Cartesian3,this._cameraPositionInScaledSpace=new p.Cartesian3,this._distanceToLimbInScaledSpaceSquared=0,x.defined(e)&&(this.cameraPosition=e)}Object.defineProperties(i.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(t){var e=this._ellipsoid.transformPositionToScaledSpace(t,this._cameraPositionInScaledSpace),i=p.Cartesian3.magnitudeSquared(e)-1;p.Cartesian3.clone(t,this._cameraPosition),this._cameraPositionInScaledSpace=e,this._distanceToLimbInScaledSpaceSquared=i}}});const a=new p.Cartesian3;i.prototype.isPointVisible=function(t){return S(this._ellipsoid.transformPositionToScaledSpace(t,a),this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},i.prototype.isScaledSpacePointVisible=function(t){return S(t,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};const o=new p.Cartesian3;i.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(t,e){var i=this._ellipsoid;let a,r;return a=x.defined(e)&&e<0&&i.minimumRadius>-e?(r=o,r.x=this._cameraPosition.x/(i.radii.x+e),r.y=this._cameraPosition.y/(i.radii.y+e),r.z=this._cameraPosition.z/(i.radii.z+e),r.x*r.x+r.y*r.y+r.z*r.z-1):(r=this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared),S(t,r,a)},i.prototype.computeHorizonCullingPoint=function(t,e,i){return u(this._ellipsoid,t,e,i)};const n=p.Ellipsoid.clone(p.Ellipsoid.UNIT_SPHERE);i.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(t,e,i,a){return u(d(this._ellipsoid,i,n),t,e,a)},i.prototype.computeHorizonCullingPointFromVertices=function(t,e,i,a,r){return f(this._ellipsoid,t,e,i,a,r)},i.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(t,e,i,a,r,o){return f(d(this._ellipsoid,r,n),t,e,i,a,o)};const s=[];i.prototype.computeHorizonCullingPointFromRectangle=function(t,e,i){var a=p.Rectangle.subsample(t,e,0,s),t=r.BoundingSphere.fromPoints(a);if(!(p.Cartesian3.magnitude(t.center)<.1*e.minimumRadius))return this.computeHorizonCullingPoint(t.center,a,i)};const c=new p.Cartesian3;function d(t,e,i){if(x.defined(e)&&e<0&&t.minimumRadius>-e){const x=p.Cartesian3.fromElements(t.radii.x+e,t.radii.y+e,t.radii.z+e,c);t=p.Ellipsoid.fromCartesian3(x,i)}return t}function u(i,t,a,e){x.defined(e)||(e=new p.Cartesian3);var r=T(i,t);let o=0;for(let t=0,e=a.length;t<e;++t){const p=y(i,a[t],r);if(p<0)return;o=Math.max(o,p)}return N(r,o,e)}const l=new p.Cartesian3;function f(i,t,a,r,o,e){x.defined(e)||(e=new p.Cartesian3),r=x.defaultValue(r,3),o=x.defaultValue(o,p.Cartesian3.ZERO);var n=T(i,t);let s=0;for(let t=0,e=a.length;t<e;t+=r){l.x=a[t]+o.x,l.y=a[t+1]+o.y,l.z=a[t+2]+o.z;const p=y(i,l,n);if(p<0)return;s=Math.max(s,p)}return N(n,s,e)}function S(t,e,i){t=p.Cartesian3.subtract(t,e,a),e=-p.Cartesian3.dot(t,e);return!(i<0?0<e:i<e&&e*e/p.Cartesian3.magnitudeSquared(t)>i)}const C=new p.Cartesian3,g=new p.Cartesian3;function y(t,e,i){var a=t.transformPositionToScaledSpace(e,C),t=p.Cartesian3.magnitudeSquared(a),e=Math.sqrt(t),a=p.Cartesian3.divideByScalar(a,e,g),t=Math.max(1,t),e=1/(e=Math.max(1,e));return 1/(p.Cartesian3.dot(a,i)*e-p.Cartesian3.magnitude(p.Cartesian3.cross(a,i,a))*(Math.sqrt(t-1)*e))}function N(t,e,i){if(!(e<=0||e===1/0||e!=e))return p.Cartesian3.multiplyByScalar(t,e,i)}const M=new p.Cartesian3;function T(t,e){return p.Cartesian3.equals(e,p.Cartesian3.ZERO)?e:(t.transformPositionToScaledSpace(e,M),p.Cartesian3.normalize(M,M))}const P={getHeight:function(t,e,i){return(t-i)*e+i}},b=new p.Cartesian3;P.getPosition=function(t,e,i,a,r){t=e.cartesianToCartographic(t,b),a=P.getHeight(t.height,i,a);return p.Cartesian3.fromRadians(t.longitude,t.latitude,a,e,r)};var z=Object.freeze({NONE:0,BITS12:1});const _=new p.Cartesian3,E=new p.Cartesian3,H=new p.Cartesian2,w=new p.Matrix4,A=new p.Matrix4,v=Math.pow(2,12);function I(t,e,i,a,r,o,n,s,c,d){let u,l,m=z.NONE;if(x.defined(e)&&x.defined(i)&&x.defined(a)&&x.defined(r)){const t=e.minimum,x=e.maximum,o=p.Cartesian3.subtract(x,t,E),n=a-i;m=Math.max(p.Cartesian3.maximumComponent(o),n)<v-1?z.BITS12:z.NONE,u=p.Matrix4.inverseTransformation(r,new p.Matrix4);const s=p.Cartesian3.negate(t,_);p.Matrix4.multiply(p.Matrix4.fromTranslation(s,w),u,u);const c=_;c.x=1/o.x,c.y=1/o.y,c.z=1/o.z,p.Matrix4.multiply(p.Matrix4.fromScale(c,w),u,u),l=p.Matrix4.clone(r),p.Matrix4.setTranslation(l,p.Cartesian3.ZERO,l),r=p.Matrix4.clone(r,new p.Matrix4);const d=p.Matrix4.fromTranslation(t,w),h=p.Matrix4.fromScale(o,A),f=p.Matrix4.multiply(d,h,w);p.Matrix4.multiply(r,f,r),p.Matrix4.multiply(l,f,l)}this.quantization=m,this.minimumHeight=i,this.maximumHeight=a,this.center=p.Cartesian3.clone(t),this.toScaledENU=u,this.fromScaledENU=r,this.matrix=l,this.hasVertexNormals=o,this.hasWebMercatorT=x.defaultValue(n,!1),this.hasGeodeticSurfaceNormals=x.defaultValue(s,!1),this.exaggeration=x.defaultValue(c,1),this.exaggerationRelativeHeight=x.defaultValue(d,0),this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}I.prototype.encode=function(t,e,i,a,r,o,n,s){var c=a.x,d=a.y;if(this.quantization===z.BITS12){(i=p.Matrix4.multiplyByPoint(this.toScaledENU,i,_)).x=h.CesiumMath.clamp(i.x,0,1),i.y=h.CesiumMath.clamp(i.y,0,1),i.z=h.CesiumMath.clamp(i.z,0,1);const l=this.maximumHeight-this.minimumHeight,o=h.CesiumMath.clamp((r-this.minimumHeight)/l,0,1);p.Cartesian2.fromElements(i.x,i.y,H);const s=m.AttributeCompression.compressTextureCoordinates(H);p.Cartesian2.fromElements(i.z,o,H);var u=m.AttributeCompression.compressTextureCoordinates(H);p.Cartesian2.fromElements(c,d,H);a=m.AttributeCompression.compressTextureCoordinates(H);if(t[e++]=s,t[e++]=u,t[e++]=a,this.hasWebMercatorT){p.Cartesian2.fromElements(n,0,H);const i=m.AttributeCompression.compressTextureCoordinates(H);t[e++]=i}}else p.Cartesian3.subtract(i,this.center,_),t[e++]=_.x,t[e++]=_.y,t[e++]=_.z,t[e++]=r,t[e++]=c,t[e++]=d,this.hasWebMercatorT&&(t[e++]=n);return this.hasVertexNormals&&(t[e++]=m.AttributeCompression.octPackFloat(o)),this.hasGeodeticSurfaceNormals&&(t[e++]=s.x,t[e++]=s.y,t[e++]=s.z),e};const V=new p.Cartesian3,q=new p.Cartesian3;I.prototype.addGeodeticSurfaceNormals=function(i,a,t){if(!this.hasGeodeticSurfaceNormals){const o=this.stride,n=i.length/o;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();var r=this.stride;for(let e=0;e<n;e++){for(let t=0;t<o;t++){const n=e*o+t;a[e*r+t]=i[n]}const n=this.decodePosition(a,e,V),s=t.geodeticSurfaceNormal(n,q),c=e*r+this._offsetGeodeticSurfaceNormal;a[c]=s.x,a[c+1]=s.y,a[c+2]=s.z}}},I.prototype.removeGeodeticSurfaceNormals=function(i,a){if(this.hasGeodeticSurfaceNormals){var r=this.stride,t=i.length/r;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();var o=this.stride;for(let e=0;e<t;e++)for(let t=0;t<o;t++){var n=e*r+t;a[e*o+t]=i[n]}}},I.prototype.decodePosition=function(t,e,i){if(x.defined(i)||(i=new p.Cartesian3),e*=this.stride,this.quantization!==z.BITS12)return i.x=t[e],i.y=t[e+1],i.z=t[e+2],p.Cartesian3.add(i,this.center,i);{const x=m.AttributeCompression.decompressTextureCoordinates(t[e],H);i.x=x.x,i.y=x.y;e=m.AttributeCompression.decompressTextureCoordinates(t[e+1],H);return i.z=e.x,p.Matrix4.multiplyByPoint(this.fromScaledENU,i,i)}},I.prototype.getExaggeratedPosition=function(t,e,i){i=this.decodePosition(t,e,i);var a,r=this.exaggeration,o=this.exaggerationRelativeHeight;return 1!==r&&this.hasGeodeticSurfaceNormals&&(a=this.decodeGeodeticSurfaceNormal(t,e,q),e=this.decodeHeight(t,e),e=P.getHeight(e,r,o)-e,i.x+=a.x*e,i.y+=a.y*e,i.z+=a.z*e),i},I.prototype.decodeTextureCoordinates=function(t,e,i){return x.defined(i)||(i=new p.Cartesian2),e*=this.stride,this.quantization===z.BITS12?m.AttributeCompression.decompressTextureCoordinates(t[e+2],i):p.Cartesian2.fromElements(t[e+4],t[e+5],i)},I.prototype.decodeHeight=function(t,e){return e*=this.stride,this.quantization===z.BITS12?m.AttributeCompression.decompressTextureCoordinates(t[e+1],H).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight:t[e+3]},I.prototype.decodeWebMercatorT=function(t,e){return e*=this.stride,this.quantization===z.BITS12?m.AttributeCompression.decompressTextureCoordinates(t[e+3],H).x:t[e+6]},I.prototype.getOctEncodedNormal=function(t,e,i){t=t[e=e*this.stride+this._offsetVertexNormal]/256,e=Math.floor(t);return p.Cartesian2.fromElements(e,256*(t-e),i)},I.prototype.decodeGeodeticSurfaceNormal=function(t,e,i){return e=e*this.stride+this._offsetGeodeticSurfaceNormal,i.x=t[e],i.y=t[e+1],i.z=t[e+2],i},I.prototype._calculateStrideAndOffsets=function(){let t=0;this.quantization===z.BITS12?t+=3:t+=6,this.hasWebMercatorT&&(t+=1),this.hasVertexNormals&&(this._offsetVertexNormal=t,t+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=t,t+=3),this.stride=t};const G={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},O={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};I.prototype.getAttributes=function(i){const a=h.ComponentDatatype.FLOAT,r=h.ComponentDatatype.getSizeInBytes(a),o=this.stride*r;let n=0;const s=[];function t(t,e){s.push({index:t,vertexBuffer:i,componentDatatype:a,componentsPerAttribute:e,offsetInBytes:n,strideInBytes:o}),n+=e*r}if(this.quantization===z.NONE){t(G.position3DAndHeight,4);var e=2;e+=this.hasWebMercatorT?1:0,e+=this.hasVertexNormals?1:0,t(G.textureCoordAndEncodedNormals,e),this.hasGeodeticSurfaceNormals&&t(G.geodeticSurfaceNormal,3)}else{const i=this.hasWebMercatorT||this.hasVertexNormals,a=this.hasWebMercatorT&&this.hasVertexNormals;t(O.compressed0,i?4:3),a&&t(O.compressed1,1),this.hasGeodeticSurfaceNormals&&t(O.geodeticSurfaceNormal,3)}return s},I.prototype.getAttributeLocations=function(){return this.quantization===z.NONE?G:O},I.clone=function(t,e){if(x.defined(t))return(e=!x.defined(e)?new I:e).quantization=t.quantization,e.minimumHeight=t.minimumHeight,e.maximumHeight=t.maximumHeight,e.center=p.Cartesian3.clone(t.center),e.toScaledENU=p.Matrix4.clone(t.toScaledENU),e.fromScaledENU=p.Matrix4.clone(t.fromScaledENU),e.matrix=p.Matrix4.clone(t.matrix),e.hasVertexNormals=t.hasVertexNormals,e.hasWebMercatorT=t.hasWebMercatorT,e.hasGeodeticSurfaceNormals=t.hasGeodeticSurfaceNormals,e.exaggeration=t.exaggeration,e.exaggerationRelativeHeight=t.exaggerationRelativeHeight,e._calculateStrideAndOffsets(),e},t.EllipsoidalOccluder=i,t.TerrainEncoding=I});