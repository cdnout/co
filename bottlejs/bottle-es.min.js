var Bottle,DELIMITER=".",FUNCTION_TYPE="function",STRING_TYPE="string",GLOBAL_NAME="__global__",PROVIDER_SUFFIX="Provider",id=0,slice=Array.prototype.slice,getNested=function(e,t){var r=e[t];if(void 0===r&&Bottle.config.strict)throw new Error("Bottle was unable to resolve a service.  `"+t+"` is undefined.");return r},getNestedBottle=function(e){var t;return this.nested[e]||(t=Bottle.pop(),this.nested[e]=t,this.factory(e,function(){return t.container})),this.nested[e]},getNestedService=function(e){return e.split(DELIMITER).reduce(getNested,this)},applyMiddleware=function(e,t,r,i){var n={configurable:!0,enumerable:!0};return e.length?n.get=function(){var t=0,i=function(n){if(n)throw n;e[t]&&e[t++](r,i)};return i(),r}:(n.value=r,n.writable=!0),Object.defineProperty(i,t,n),i[t]},middleware=function(e,t){var r,i;return typeof e===FUNCTION_TYPE&&(t=e,e=GLOBAL_NAME),i=(r=e.split(DELIMITER)).shift(),r.length?getNestedBottle.call(this,i).middleware(r.join(DELIMITER),t):(this.middlewares[i]||(this.middlewares[i]=[]),this.middlewares[i].push(t)),this},reducer=function(e,t){return t(e)},getWithGlobal=function(e,t){return(e[t]||[]).concat(e.__global__||[])},createProvider=function(e,t){var r,i,n,o,s;return this.id,n=this.container,o=this.decorators,s=this.middlewares,r=e+PROVIDER_SUFFIX,(i=Object.create(null))[r]={configurable:!0,enumerable:!0,get:function(){var e=new t;return delete n[r],n[r]=e,e}},i[e]={configurable:!0,enumerable:!0,get:function(){var t,i=n[r];return i&&(t=getWithGlobal(o,e).reduce(reducer,i.$get(n)),delete n[r],delete n[e]),void 0===t?t:applyMiddleware(getWithGlobal(s,e),e,t,n)}},Object.defineProperties(n,i),this},provider=function(e,t){var r,i;return r=e.split(DELIMITER),this.providerMap[e]&&1===r.length&&!this.container[e+PROVIDER_SUFFIX]?console.error(e+" provider already instantiated."):(this.originalProviders[e]=t,this.providerMap[e]=!0,i=r.shift(),r.length?(getNestedBottle.call(this,i).provider(r.join(DELIMITER),t),this):createProvider.call(this,i,t))},factory=function(e,t){return provider.call(this,e,function(){this.$get=t})},createService=function(e,t,r){var i=arguments.length>3?slice.call(arguments,3):[],n=this;return factory.call(this,e,function(){var e=t,o=i.map(getNestedService,n.container);return r?new(t.bind.apply(t,[null].concat(o))):e.apply(null,o)})},service=function(e,t){return createService.apply(this,[e,t,!0].concat(slice.call(arguments,2)))},serviceFactory=function(e,t){return createService.apply(this,[e,t,!1].concat(slice.call(arguments,2)))},defineValue=function(e,t){Object.defineProperty(this,e,{configurable:!0,enumerable:!0,value:t,writable:!0})},setValueObject=function(e,t){var r=e[t];return r||(r={},defineValue.call(e,t,r)),r},value=function(e,t){var r;return e=(r=e.split(DELIMITER)).pop(),defineValue.call(r.reduce(setValueObject,this.container),e,t),this},defineConstant=function(e,t){Object.defineProperty(this,e,{configurable:!1,enumerable:!0,value:t,writable:!1})},constant=function(e,t){var r=e.split(DELIMITER);return e=r.pop(),defineConstant.call(r.reduce(setValueObject,this.container),e,t),this},decorator=function(e,t){var r,i;return typeof e===FUNCTION_TYPE&&(t=e,e=GLOBAL_NAME),i=(r=e.split(DELIMITER)).shift(),r.length?getNestedBottle.call(this,i).decorator(r.join(DELIMITER),t):(this.decorators[i]||(this.decorators[i]=[]),this.decorators[i].push(t)),this},defer=function(e){return this.deferred.push(e),this},digest=function(e){return(e||[]).map(getNestedService,this.container)},instanceFactory=function(e,t){return factory.call(this,e,function(e){return{instance:t.bind(t,e)}})},byMethod=function(e){return!/^\$(?:decorator|register|list)$|Provider$/.test(e)},list=function(e){return Object.keys(e||this.container||{}).filter(byMethod)},bottles={},pop=function(e){var t;return typeof e===STRING_TYPE?((t=bottles[e])||(bottles[e]=t=new Bottle,t.constant("BOTTLE_NAME",e)),t):new Bottle},clear=function(e){typeof e===STRING_TYPE?delete bottles[e]:bottles={}},register=function(e){var t=void 0===e.$value?e:e.$value;return this[e.$type||"service"].apply(this,[e.$name,t].concat(e.$inject||[]))},removeProviderMap=function(e){delete this.providerMap[e],delete this.container[e],delete this.container[e+PROVIDER_SUFFIX]},resetProviders=function(e){var t=this.originalProviders,r=Array.isArray(e);Object.keys(this.originalProviders).forEach(function(i){if(!r||-1!==e.indexOf(i)){var n=i.split(DELIMITER);n.length>1&&n.forEach(removeProviderMap,getNestedBottle.call(this,n[0])),removeProviderMap.call(this,i),this.provider(i,t[i])}},this)},resolve=function(e){return this.deferred.forEach(function(t){t(e)}),this};(Bottle=function e(t){if(!(this instanceof e))return e.pop(t);this.id=id++,this.decorators={},this.middlewares={},this.nested={},this.providerMap={},this.originalProviders={},this.deferred=[],this.container={$decorator:decorator.bind(this),$register:register.bind(this),$list:list.bind(this)}}).prototype={constant:constant,decorator:decorator,defer:defer,digest:digest,factory:factory,instanceFactory:instanceFactory,list:list,middleware:middleware,provider:provider,resetProviders:resetProviders,register:register,resolve:resolve,service:service,serviceFactory:serviceFactory,value:value},Bottle.pop=pop,Bottle.clear=clear,Bottle.list=list,Bottle.config={strict:!1};export default Bottle;