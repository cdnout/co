import{interpolateHslLong}from"d3-interpolate";import{hsl}from"d3-color";import{scaleSequential,scaleLog,scaleSequentialLog}from"d3-scale";import"d3-selection";import"d3-brush";import{axisRight}from"d3-axis";import{format}from"d3-format";var _extendStatics=function(t,e){return(_extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function __extends(t,e){function n(){this.constructor=t}if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+e+" is not a constructor or null");_extendStatics(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function __spreadArrays(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var a=arguments[e],i=0,s=a.length;i<s;i++,o++)r[o]=a[i];return r}var CLASS={arc:"bb-arc",arcLabelLine:"bb-arc-label-line",arcs:"bb-arcs",area:"bb-area",areas:"bb-areas",axis:"bb-axis",axisX:"bb-axis-x",axisXLabel:"bb-axis-x-label",axisY:"bb-axis-y",axisY2:"bb-axis-y2",axisY2Label:"bb-axis-y2-label",axisYLabel:"bb-axis-y-label",bar:"bb-bar",bars:"bb-bars",brush:"bb-brush",button:"bb-button",buttonZoomReset:"bb-zoom-reset",chart:"bb-chart",chartArc:"bb-chart-arc",chartArcs:"bb-chart-arcs",chartArcsBackground:"bb-chart-arcs-background",chartArcsGaugeMax:"bb-chart-arcs-gauge-max",chartArcsGaugeMin:"bb-chart-arcs-gauge-min",chartArcsGaugeUnit:"bb-chart-arcs-gauge-unit",chartArcsTitle:"bb-chart-arcs-title",chartArcsGaugeTitle:"bb-chart-arcs-gauge-title",chartBar:"bb-chart-bar",chartBars:"bb-chart-bars",chartCircles:"bb-chart-circles",chartLine:"bb-chart-line",chartLines:"bb-chart-lines",chartRadar:"bb-chart-radar",chartRadars:"bb-chart-radars",chartText:"bb-chart-text",chartTexts:"bb-chart-texts",circle:"bb-circle",circles:"bb-circles",colorPattern:"bb-color-pattern",colorScale:"bb-colorscale",defocused:"bb-defocused",dragarea:"bb-dragarea",empty:"bb-empty",eventRect:"bb-event-rect",eventRects:"bb-event-rects",eventRectsMultiple:"bb-event-rects-multiple",eventRectsSingle:"bb-event-rects-single",focused:"bb-focused",gaugeValue:"bb-gauge-value",grid:"bb-grid",gridLines:"bb-grid-lines",legend:"bb-legend",legendBackground:"bb-legend-background",legendItem:"bb-legend-item",legendItemEvent:"bb-legend-item-event",legendItemFocused:"bb-legend-item-focused",legendItemHidden:"bb-legend-item-hidden",legendItemPoint:"bb-legend-item-point",legendItemTile:"bb-legend-item-tile",level:"bb-level",levels:"bb-levels",line:"bb-line",lines:"bb-lines",main:"bb-main",region:"bb-region",regions:"bb-regions",selectedCircle:"bb-selected-circle",selectedCircles:"bb-selected-circles",shape:"bb-shape",shapes:"bb-shapes",stanfordElements:"bb-stanford-elements",stanfordLine:"bb-stanford-line",stanfordLines:"bb-stanford-lines",stanfordRegion:"bb-stanford-region",stanfordRegions:"bb-stanford-regions",subchart:"bb-subchart",target:"bb-target",text:"bb-text",texts:"bb-texts",title:"bb-title",tooltip:"bb-tooltip",tooltipContainer:"bb-tooltip-container",tooltipName:"bb-tooltip-name",xgrid:"bb-xgrid",xgridFocus:"bb-xgrid-focus",xgridLine:"bb-xgrid-line",xgridLines:"bb-xgrid-lines",xgrids:"bb-xgrids",ygrid:"bb-ygrid",ygridFocus:"bb-ygrid-focus",ygridLine:"bb-ygrid-line",ygridLines:"bb-ygrid-lines",ygrids:"bb-ygrids",zoomBrush:"bb-zoom-brush",EXPANDED:"_expanded_",SELECTED:"_selected_",INCLUDED:"_included_",TextOverlapping:"text-overlapping"},win="object"==typeof globalThis&&null!==globalThis&&globalThis.Object===Object&&globalThis||"object"==typeof global&&null!==global&&global.Object===Object&&global||"object"==typeof self&&null!==self&&self.Object===Object&&self||Function("return this")(),doc=win&&win.document,isFunction=function(t){return"function"==typeof t},isString=function(t){return"string"==typeof t},isNumber=function(t){return"number"==typeof t},isUndefined=function(t){return void 0===t},isDefined=function(t){return void 0!==t},isObjectType=function(t){return"object"==typeof t},isEmpty=function(t){return isUndefined(t)||null===t||isString(t)&&0===t.length||isObjectType(t)&&!(t instanceof Date)&&0===Object.keys(t).length||isNumber(t)&&isNaN(t)},isArray=function(t){return Array.isArray(t)},isObject=function(t){return t&&!t.nodeType&&isObjectType(t)&&!isArray(t)};function mergeObj(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(!e.length||1===e.length&&!e[0])return t;var r=e.shift();return isObject(t)&&isObject(r)&&Object.keys(r).forEach(function(e){var n=r[e];isObject(n)?(!t[e]&&(t[e]={}),t[e]=mergeObj(t[e],n)):t[e]=isArray(n)?n.concat():n}),mergeObj.apply(void 0,__spreadArrays([t],e))}var getRange=function(t,e,n){void 0===n&&(n=1);for(var r=[],o=0|Math.max(0,Math.ceil((e-t)/n)),a=t;a<o;a++)r.push(t+a*n);return r};function parseDate(t){var e;if(t instanceof Date)e=t;else if(isString(t)){var n=this.config;e=this.format.dataTime(n.data_xFormat)(t)}else isNumber(t)&&!isNaN(t)&&(e=new Date(+t));return e&&!isNaN(+e)||console&&console.error&&console.error("Failed to parse x '"+t+"' to Date object"),e}function loadConfig(t){var e,n,r,o=this.config,a=function(){var t=n.shift();return t&&e&&isObjectType(e)&&t in e?(e=e[t],a()):t?void 0:e};Object.keys(o).forEach(function(i){e=t,n=i.split("_"),r=a(),isDefined(r)&&(o[i]=r)})}(function(){try{new MouseEvent("t")}catch(t){return function(t,e,n){void 0===n&&(n={bubbles:!1,cancelable:!1,screenX:0,screenY:0,clientX:0,clientY:0});var r=doc.createEvent("MouseEvent");r.initMouseEvent(e,n.bubbles,n.cancelable,win,0,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),t.dispatchEvent(r)}}})();var Plugin=function(){function t(t){void 0===t&&(t={}),this.$$,this.options=t}var e=t.prototype;return e.$beforeInit=function(){},e.$init=function(){},e.$afterInit=function(){},e.$redraw=function(){},e.$willDestroy=function(){var t=this;Object.keys(this).forEach(function(e){t[e]=null,delete t[e]})},t}();Plugin.version="#2.2.3#";var Options=function(){return function(){return{colors:void 0,epochs:[],lines:[],scale_min:void 0,scale_max:void 0,scale_width:20,scale_format:void 0,padding_top:0,padding_right:0,padding_bottom:0,padding_left:0,regions:[]}}}(),CLASS$1={colorScale:"bb-colorscale",stanfordElements:"bb-stanford-elements",stanfordLine:"bb-stanford-line",stanfordLines:"bb-stanford-lines",stanfordRegion:"bb-stanford-region",stanfordRegions:"bb-stanford-regions"};function pointInRegion(t,e){for(var n=t.x,r=t.value,o=!1,a=0,i=e.length-1;a<e.length;i=a++){var s=e[a].x,c=e[a].y,l=e[i].x,b=e[i].y;c>r!=b>r&&n<(l-s)*(r-c)/(b-c)+s&&(o=!o)}return o}function compareEpochs(t,e){return t.epochs<e.epochs?-1:t.epochs>e.epochs?1:0}function getRegionArea(t){for(var e,n,r=0,o=0,a=t.length,i=a-1;o<a;i=o,o++)e=t[o],n=t[i],r+=e.x*n.y,r-=e.y*n.x;return r/=2}function getCentroid(t){for(var e,n=getRegionArea(t),r=0,o=0,a=0,i=t.length,s=i-1;a<i;s=a,a++){var c=t[a],l=t[s];e=c.x*l.y-l.x*c.y,r+=(c.x+l.x)*e,o+=(c.y+l.y)*e}return{x:r/(e=6*n),y:o/e}}var Elements=function(){function t(t){this.owner=t;var e=t.$$.$el.main.select(".bb-chart").append("g").attr("class",CLASS$1.stanfordElements);e.append("g").attr("class",CLASS$1.stanfordLines),e.append("g").attr("class",CLASS$1.stanfordRegions)}return t.prototype.updateStanfordLines=function(t){var e=this.owner.$$,n=e.config,r=e.$el.main,o=n.axis_rotated,a=this.xvCustom.bind(e),i=this.yvCustom.bind(e),s=r.select("."+CLASS$1.stanfordLines).style("shape-rendering","geometricprecision").selectAll("."+CLASS$1.stanfordLine).data(this.owner.config.lines);s.exit().transition().duration(t).style("opacity","0").remove();var c=s.enter().append("g");c.append("line").style("opacity","0"),c.merge(s).attr("class",function(t){return CLASS$1.stanfordLine+(t.class?" "+t.class:"")}).select("line").transition().duration(t).attr("x1",function(t){return o?i(t,"y1"):a(t,"x1")}).attr("x2",function(t){return o?i(t,"y2"):a(t,"x2")}).attr("y1",function(t){return o?a(t,"x1"):i(t,"y1")}).attr("y2",function(t){return o?a(t,"x2"):i(t,"y2")}).transition().style("opacity","1")},t.prototype.updateStanfordRegions=function(t){var e=this.owner.$$,n=e.config,r=e.$el.main,o=n.axis_rotated,a=this.xvCustom.bind(e),i=this.yvCustom.bind(e),s=this.owner.countEpochsInRegion.bind(e),c=r.select("."+CLASS$1.stanfordRegions).selectAll("."+CLASS$1.stanfordRegion).data(this.owner.config.regions);c.exit().transition().duration(t).style("opacity","0").remove();var l=c.enter().append("g");l.append("polygon").style("opacity","0"),l.append("text").attr("transform",o?"rotate(-90)":"").style("opacity","0"),(c=l.merge(c)).attr("class",function(t){return CLASS$1.stanfordRegion+(t.class?" "+t.class:"")}).select("polygon").transition().duration(t).attr("points",function(t){return t.points.map(function(t){return[o?i(t,"y"):a(t,"x"),o?a(t,"x"):i(t,"y")].join(",")}).join(" ")}).transition().style("opacity",function(t){return String(t.opacity?t.opacity:.2)}),c.select("text").transition().duration(t).attr("x",function(t){return o?i(getCentroid(t.points),"y"):a(getCentroid(t.points),"x")}).attr("y",function(t){return o?a(getCentroid(t.points),"x"):i(getCentroid(t.points),"y")}).text(function(t){if(t.text){var e=s(t.points),n=e.value,r=e.percentage;return t.text(n,r)}return""}).attr("text-anchor","middle").attr("dominant-baseline","middle").transition().style("opacity","1")},t.prototype.updateStanfordElements=function(t){void 0===t&&(t=0),this.updateStanfordLines(t),this.updateStanfordRegions(t)},t.prototype.xvCustom=function(t,e){var n=this,r=n.axis,o=n.config,a=e?t[e]:n.getBaseValue(t);return r.isTimeSeries()?a=parseDate.call(n,a):r.isCategorized()&&isString(a)&&(a=o.axis_x_categories.indexOf(t.value)),Math.ceil(n.scale.x(a))},t.prototype.yvCustom=function(t,e){var n=t.axis&&"y2"===t.axis?this.scale.y2:this.scale.y,r=e?t[e]:this.getBaseValue(t);return Math.ceil(n(r))},t}(),ColorScale=function(){function t(t){this.owner=t}return t.prototype.drawColorScale=function(){var t=this.owner,e=t.$$,n=t.config,r=e.data.targets[0],o=e.state.height-n.padding_bottom-n.padding_top,a=n.scale_width,i=getRange(n.padding_bottom,o,5),s=scaleSequential(r.colors).domain([i[i.length-1],i[0]]);this.colorScale&&this.colorScale.remove(),this.colorScale=e.$el.svg.append("g").attr("width",50).attr("height",o).attr("class",CLASS$1.colorScale),this.colorScale.append("g").attr("transform","translate(0, "+n.padding_top+")").selectAll("bars").data(i).enter().append("rect").attr("y",function(t,e){return 5*e}).attr("x",0).attr("width",a).attr("height",5).attr("fill",function(t){return s(t)});var c=scaleLog().domain([r.minEpochs,r.maxEpochs]).range([i[0]+n.padding_top+i[i.length-1]+5-1,i[0]+n.padding_top]),l=axisRight(c),b=n.scale_format;"pow10"===b?l.tickValues([1,10,100,1e3,1e4,1e5,1e6,1e7]):isFunction(b)?l.tickFormat(b):l.tickFormat(format("d"));var d=this.colorScale.append("g").attr("class","legend axis").attr("transform","translate("+a+",0)").call(l);"pow10"===b&&d.selectAll(".tick text").text(null).filter(function(t){return t/Math.pow(10,Math.ceil(Math.log(t)/Math.LN10-1e-12))==1}).text(10).append("tspan").attr("dy","-.7em").text(function(t){return Math.round(Math.log(t)/Math.LN10)}),this.colorScale.attr("transform","translate("+(e.state.current.width-this.xForColorScale())+", 0)")},t.prototype.xForColorScale=function(){return this.owner.config.padding_right+this.colorScale.node().getBBox().width},t.prototype.getColorScalePadding=function(){return this.xForColorScale()+this.owner.config.padding_left+20},t}(),Stanford=function(t){function e(e){var n=t.call(this,e)||this;return n.config=new Options,n}return __extends(e,t),e.prototype.$beforeInit=function(){var t=this,e=this.$$;e.config.data_xSort=!1,e.isMultipleX=function(){return!0},e.showGridFocus=function(){},e.labelishData=function(t){return t.values},e.opacityForCircle=function(){return 1};var n=e.getCurrentPaddingRight.bind(e);e.getCurrentPaddingRight=function(){return n()+(t.colorScale?t.colorScale.getColorScalePadding():0)}},e.prototype.$init=function(){var t=this.$$;loadConfig.call(this,this.options),t.color=this.getStanfordPointColor.bind(t),this.colorScale=new ColorScale(this),this.elements=new Elements(this),this.convertData(),this.initStanfordData(),this.setStanfordTooltip(),this.colorScale.drawColorScale(),this.$redraw()},e.prototype.$redraw=function(t){this.colorScale&&this.colorScale.drawColorScale(),this.elements&&this.elements.updateStanfordElements(t)},e.prototype.getOptions=function(){return new Options},e.prototype.convertData=function(){var t=this.$$.data.targets,e=this.options.epochs;t.forEach(function(t){t.values.forEach(function(t,n){t.epochs=e[n]}),t.minEpochs=void 0,t.maxEpochs=void 0,t.colors=void 0,t.colorscale=void 0})},e.prototype.xvCustom=function(t,e){var n=this,r=n.axis,o=n.config,a=e?t[e]:n.getBaseValue(t);return r.isTimeSeries()?a=parseDate.call(n,a):r.isCategorized()&&isString(a)&&(a=o.axis_x_categories.indexOf(t.value)),Math.ceil(n.scale.x(a))},e.prototype.yvCustom=function(t,e){var n=this.scale,r=t.axis&&"y2"===t.axis?n.y2:n.y,o=e?t[e]:this.getBaseValue(t);return Math.ceil(r(o))},e.prototype.initStanfordData=function(){var t=this.config,e=this.$$.data.targets[0];e.values.sort(compareEpochs);var n=e.values.map(function(t){return t.epochs});e.minEpochs=isNaN(t.scale_min)?Math.min.apply(Math,n):t.scale_min,e.maxEpochs=isNaN(t.scale_max)?Math.max.apply(Math,n):t.scale_max,e.colors=isFunction(t.colors)?t.colors:interpolateHslLong(hsl(250,1,.5),hsl(0,1,.5)),e.colorscale=scaleSequentialLog(e.colors).domain([e.minEpochs,e.maxEpochs])},e.prototype.getStanfordPointColor=function(t){return this.data.targets[0].colorscale(t.epochs)},e.prototype.setStanfordTooltip=function(){var t=this.$$.config;isEmpty(t.tooltip_contents)&&(t.tooltip_contents=function(e,n,r,o){var a='<table class="'+CLASS.tooltip+'"><tbody>';return e.forEach(function(e){a+="<tr>\n\t\t\t\t\t\t\t<th>"+n(t.data_x)+'</th>\n\t\t\t\t\t\t\t<th class="value">'+r(e.x)+"</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th>"+n(e.id)+'</th>\n\t\t\t\t\t\t\t<th class="value">'+r(e.value)+'</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr class="'+CLASS.tooltipName+"-"+e.id+'">\n\t\t\t\t\t\t\t<td class="name"><span style="background-color:'+o(e)+'"></span>'+n("Epochs")+'</td>\n\t\t\t\t\t\t\t<td class="value">'+r(e.epochs)+"</td>\n\t\t\t\t\t\t</tr>"}),a+"</tbody></table>"})},e.prototype.countEpochsInRegion=function(t){var e=this.data.targets[0],n=e.values.reduce(function(t,e){return t+Number(e.epochs)},0),r=e.values.reduce(function(e,n){return pointInRegion(n,t)?e+Number(n.epochs):e},0);return{value:r,percentage:0!==r?+(r/n*100).toFixed(1):0}},e}(Plugin);export default Stanford;