import{KEY_VALUE_CELLS}from"./cellx";import{logError}from"./utils";const hasOwn=Object.prototype.hasOwnProperty;let currentlySubscribing=!1,transactionLevel=0,transactionEvents=[],silently=0;export class EventEmitter{constructor(){this._events=new Map}static get currentlySubscribing(){return currentlySubscribing}static transact(t){transactionLevel++;try{t()}catch(t){logError(t)}if(--transactionLevel)return;let e=transactionEvents;transactionEvents=[];for(let t of e)t.target.handleEvent(t)}static silently(t){silently++;try{t()}catch(t){logError(t)}silently--}getEvents(t){if(t){let e=this._events.get(t);return e?Array.isArray(e)?e:[e]:[]}let e=new Map;for(let[t,r]of this._events)e.set(t,Array.isArray(r)?r:[r]);return e}on(t,e,r){if("object"==typeof t){r=void 0!==e?e:this;let n=t;for(t in n)hasOwn.call(n,t)&&this._on(t,n[t],r);for(let t of Object.getOwnPropertySymbols(n))this._on(t,n[t],r)}else this._on(t,e,void 0!==r?r:this);return this}off(t,e,r){if(t)if("object"==typeof t){r=void 0!==e?e:this;let n=t;for(t in n)hasOwn.call(n,t)&&this._off(t,n[t],r);for(let t of Object.getOwnPropertySymbols(n))this._off(t,n[t],r)}else this._off(t,e,void 0!==r?r:this);else this._events.clear();return this}_on(t,e,r){let n;if("string"==typeof t&&-1!=(n=t.indexOf(":"))){let s=t.slice(n+1);currentlySubscribing=!0,((this[KEY_VALUE_CELLS]||(this[KEY_VALUE_CELLS]=new Map)).get(s)||(this[s],this[KEY_VALUE_CELLS]).get(s)).on(t.slice(0,n),e,r),currentlySubscribing=!1}else{let n=this._events.get(t),s={listener:e,context:r};n?Array.isArray(n)?n.push(s):this._events.set(t,[n,s]):this._events.set(t,s)}}_off(t,e,r){let n;if("string"==typeof t&&-1!=(n=t.indexOf(":"))){let s=this[KEY_VALUE_CELLS]&&this[KEY_VALUE_CELLS].get(t.slice(n+1));s&&s.off(t.slice(0,n),e,r)}else{let n,s=this._events.get(t);if(!s)return;if(Array.isArray(s)){if(1!=s.length){for(let t=s.length;t;)if((n=s[--t]).listener==e&&n.context===r){s.splice(t,1);break}return}n=s[0]}else n=s;n.listener==e&&n.context===r&&this._events.delete(t)}}once(t,e,r){function n(s){return this._off(t,n,r),e.call(this,s)}return void 0===r&&(r=this),this._on(t,n,r),n}emit(t,e){if("object"==typeof t)if(t.target){if(t.target!=this)throw TypeError("Event cannot be emitted on this target")}else t.target=this;else t={target:this,type:t};if(e&&(t.data=e),!silently)if(transactionLevel)for(let e=transactionEvents.length;;){if(!e){(t.data||(t.data={})).prevEvent=null,transactionEvents.push(t);break}let r=transactionEvents[--e];if(r.target==this&&r.type===t.type){(t.data||(t.data={})).prevEvent=r,transactionEvents[e]=t;break}}else this.handleEvent(t);return t}handleEvent(t){let e=this._events.get(t.type);if(e)if(Array.isArray(e))if(1==e.length)!1===this._tryEventListener(e[0],t)&&(t.propagationStopped=!0);else{e=e.slice();for(let r=0;r<e.length;r++)!1===this._tryEventListener(e[r],t)&&(t.propagationStopped=!0)}else!1===this._tryEventListener(e,t)&&(t.propagationStopped=!0)}_tryEventListener(t,e){try{return t.listener.call(t.context,e)}catch(t){logError(t)}}};