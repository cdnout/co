"use strict";var _createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}();function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var esTokenizer=require("./es-tokenizer"),tplTokenizer=require("./tpl-tokenizer"),DATA="$data",IMPORTS="$imports",ESCAPE="$escape",EACH="$each",PRINT="print",INCLUDE="include",EXTEND="extend",BLOCK="block",OUT="$$out",LINE="$$line",BLOCKS="$$blocks",SLICE="$$slice",FROM="$$from",OPTIONS="$$options",has=function(e,t){return Object.hasOwnProperty.call(e,t)},stringify=JSON.stringify,Compiler=function(){function a(e){var t,r,n=this;_classCallCheck(this,a);var i=e.source,s=e.minimize,o=e.htmlMinifier;if(this.options=e,this.stacks=[],this.context=[],this.scripts=[],this.CONTEXT_MAP={},this.ignore=[DATA,IMPORTS,OPTIONS].concat(_toConsumableArray(e.ignore)),this.internal=(_defineProperty(t={},OUT,"''"),_defineProperty(t,LINE,"[0,0]"),_defineProperty(t,BLOCKS,"arguments[1]||{}"),_defineProperty(t,FROM,"null"),_defineProperty(t,PRINT,"function(){var s=''.concat.apply('',arguments);"+OUT+"+=s;return s}"),_defineProperty(t,INCLUDE,"function(src,data){var s="+OPTIONS+".include(src,data||"+DATA+",arguments[2]||"+BLOCKS+","+OPTIONS+");"+OUT+"+=s;return s}"),_defineProperty(t,EXTEND,"function(from){"+FROM+"=from}"),_defineProperty(t,SLICE,"function(c,p,s){p="+OUT+";"+OUT+"='';c();s="+OUT+";"+OUT+"=p+s;return s}"),_defineProperty(t,BLOCK,"function(){var a=arguments,s;if(typeof a[0]==='function'){return "+SLICE+"(a[0])}else if("+FROM+"){if(!"+BLOCKS+"[a[0]]){"+BLOCKS+"[a[0]]="+SLICE+"(a[1])}else{"+OUT+"+="+BLOCKS+"[a[0]]}}else{s="+BLOCKS+"[a[0]];if(typeof s==='string'){"+OUT+"+=s}else{s="+SLICE+"(a[1])}return s}}"),t),this.dependencies=(_defineProperty(r={},PRINT,[OUT]),_defineProperty(r,INCLUDE,[OUT,OPTIONS,DATA,BLOCKS]),_defineProperty(r,EXTEND,[FROM,INCLUDE]),_defineProperty(r,BLOCK,[SLICE,FROM,OUT,BLOCKS]),r),this.importContext(OUT),e.compileDebug&&this.importContext(LINE),s)try{i=o(i,e)}catch(e){}this.source=i,this.getTplTokens(i,e.rules,this).forEach(function(e){e.type===tplTokenizer.TYPE_STRING?n.parseString(e):n.parseExpression(e)})}return _createClass(a,[{key:"getTplTokens",value:function(){return tplTokenizer.apply(void 0,arguments)}},{key:"getEsTokens",value:function(e){return esTokenizer(e)}},{key:"getVariables",value:function(e){var t=!1;return e.filter(function(e){return"whitespace"!==e.type&&"comment"!==e.type}).filter(function(e){return"name"===e.type&&!t||(t="punctuator"===e.type&&"."===e.value,!1)}).map(function(e){return e.value})}},{key:"importContext",value:function(e){var t=this,r="",n=this.internal,i=this.dependencies,s=this.ignore,o=this.context,a=this.options.imports,u=this.CONTEXT_MAP;has(u,e)||-1!==s.indexOf(e)||(has(n,e)?(r=n[e],has(i,e)&&i[e].forEach(function(e){return t.importContext(e)})):r=e===ESCAPE||e===EACH||has(a,e)?IMPORTS+"."+e:DATA+"."+e,u[e]=r,o.push({name:e,value:r}))}},{key:"parseString",value:function(e){var t,r=e.value;r&&(t=OUT+"+="+stringify(r),this.scripts.push({source:r,tplToken:e,code:t}))}},{key:"parseExpression",value:function(e){var t=this,r=e.value,n=e.script,i=n.output,s=this.options.escape,o=n.code;i&&(o=!1===s||i===tplTokenizer.TYPE_RAW?OUT+"+="+n.code:OUT+"+="+ESCAPE+"("+n.code+")");var a=this.getEsTokens(o);this.getVariables(a).forEach(function(e){return t.importContext(e)}),this.scripts.push({source:r,tplToken:e,code:o})}},{key:"checkExpression",value:function(e){for(var t=[[/^\s*}[\w\W]*?{?[\s;]*$/,""],[/(^[\w\W]*?\([\w\W]*?(?:=>|\([\w\W]*?\))\s*{[\s;]*$)/,"$1})"],[/(^[\w\W]*?\([\w\W]*?\)\s*{[\s;]*$)/,"$1}"]],r=0;r<t.length;){if(t[r][0].test(e)){e=e.replace.apply(e,_toConsumableArray(t[r]));break}r++}try{return new Function(e),!0}catch(e){return!1}}},{key:"build",value:function(){function t(e,t){var r=t.line,n=t.start,i={generated:{line:s.length+l+1,column:1},original:{line:r+1,column:n+1}};return l+=e.split(/\n/).length-1,i}function r(e){return e.replace(/^[\t ]+|[\t ]$/g,"")}var e=this.options,n=this.context,i=this.scripts,s=this.stacks,o=this.source,a=e.filename,u=e.imports,c=[],p=has(this.CONTEXT_MAP,EXTEND),l=0;s.push("function("+DATA+"){"),s.push("'use strict'"),s.push(DATA+"="+DATA+"||{}"),s.push("var "+n.map(function(e){return e.name+"="+e.value}).join(",")),e.compileDebug?(s.push("try{"),i.forEach(function(e){e.tplToken.type===tplTokenizer.TYPE_EXPRESSION&&s.push(LINE+"=["+[e.tplToken.line,e.tplToken.start].join(",")+"]"),c.push(t(e.code,e.tplToken)),s.push(r(e.code))}),s.push("}catch(error){"),s.push("throw {"+["name:'RuntimeError'","path:"+stringify(a),"message:error.message","line:"+LINE+"[0]+1","column:"+LINE+"[1]+1","source:"+stringify(o),"stack:error.stack"].join(",")+"}"),s.push("}")):i.forEach(function(e){c.push(t(e.code,e.tplToken)),s.push(r(e.code))}),p&&(s.push(OUT+"=''"),s.push(INCLUDE+"("+FROM+","+DATA+","+BLOCKS+")")),s.push("return "+OUT),s.push("}");var T=s.join("\n");try{var h=new Function(IMPORTS,OPTIONS,"return "+T)(u,e);return h.mappings=c,h.sourcesContent=[o],h}catch(e){for(var f=0,O=0,E=0,C=void 0;f<i.length;){var y=i[f];if(!this.checkExpression(y.code)){O=y.tplToken.line,E=y.tplToken.start,C=y.code;break}f++}throw{name:"CompileError",path:a,message:e.message,line:O+1,column:E+1,source:o,generated:C,stack:e.stack}}}}]),a}();Compiler.CONSTS={DATA:DATA,IMPORTS:IMPORTS,PRINT:PRINT,INCLUDE:INCLUDE,EXTEND:EXTEND,BLOCK:BLOCK,OPTIONS:OPTIONS,OUT:OUT,LINE:LINE,BLOCKS:BLOCKS,SLICE:SLICE,FROM:FROM,ESCAPE:ESCAPE,EACH:EACH},module.exports=Compiler;