"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _inheritsLoose=require("@babel/runtime/helpers/inheritsLoose"),Stream=require("@videojs/vhs-utils/cjs/stream.js"),_extends=require("@babel/runtime/helpers/extends"),_assertThisInitialized=require("@babel/runtime/helpers/assertThisInitialized"),decodeB64ToUint8Array=require("@videojs/vhs-utils/cjs/decode-b64-to-uint8-array.js");function _interopDefaultLegacy(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var _inheritsLoose__default=_interopDefaultLegacy(_inheritsLoose),Stream__default=_interopDefaultLegacy(Stream),_extends__default=_interopDefaultLegacy(_extends),_assertThisInitialized__default=_interopDefaultLegacy(_assertThisInitialized),decodeB64ToUint8Array__default=_interopDefaultLegacy(decodeB64ToUint8Array),LineStream=function(e){function t(){var t=e.call(this)||this;return t.buffer="",t}return _inheritsLoose__default.default(t,e),t.prototype.push=function(t){var e;for(this.buffer+=t,e=this.buffer.indexOf("\n");-1<e;e=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)},t}(Stream__default.default),attributeSeparator=function(){return new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')},parseAttributes=function(t){for(var e,i=t.split(attributeSeparator()),a={},r=i.length;r--;)""!==i[r]&&((e=/([^=]*)=(.*)/.exec(i[r]).slice(1))[0]=e[0].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^['"](.*)['"]$/g,"$1"),a[e[0]]=e[1]);return a},ParseStream=function(e){function t(){var t=e.call(this)||this;return t.customParsers=[],t.tagMappers=[],t}_inheritsLoose__default.default(t,e);var i=t.prototype;return i.push=function(i){var s,n,u=this;0!==(i=i.trim()).length&&("#"===i[0]?this.tagMappers.reduce(function(t,e){e=e(i);return e===i?t:t.concat([e])},[i]).forEach(function(t){for(var e,i,a,r=0;r<u.customParsers.length;r++)if(u.customParsers[r].call(u,t))return;if(0===t.indexOf("#EXT"))if(t=t.replace("\r",""),s=/^#EXTM3U/.exec(t))u.trigger("data",{type:"tag",tagType:"m3u"});else{if(s=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(t))return n={type:"tag",tagType:"inf"},s[1]&&(n.duration=parseFloat(s[1])),s[2]&&(n.title=s[2]),void u.trigger("data",n);if(s=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(t))return n={type:"tag",tagType:"targetduration"},s[1]&&(n.duration=parseInt(s[1],10)),void u.trigger("data",n);if(s=/^#ZEN-TOTAL-DURATION:?([0-9.]*)?/.exec(t))return n={type:"tag",tagType:"totalduration"},s[1]&&(n.duration=parseInt(s[1],10)),void u.trigger("data",n);if(s=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(t))return n={type:"tag",tagType:"version"},s[1]&&(n.version=parseInt(s[1],10)),void u.trigger("data",n);if(s=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))return n={type:"tag",tagType:"media-sequence"},s[1]&&(n.number=parseInt(s[1],10)),void u.trigger("data",n);if(s=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))return n={type:"tag",tagType:"discontinuity-sequence"},s[1]&&(n.number=parseInt(s[1],10)),void u.trigger("data",n);if(s=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(t))return n={type:"tag",tagType:"playlist-type"},s[1]&&(n.playlistType=s[1]),void u.trigger("data",n);if(s=/^#EXT-X-BYTERANGE:?([0-9.]*)?@?([0-9.]*)?/.exec(t))return n={type:"tag",tagType:"byterange"},s[1]&&(n.length=parseInt(s[1],10)),s[2]&&(n.offset=parseInt(s[2],10)),void u.trigger("data",n);if(s=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(t))return n={type:"tag",tagType:"allow-cache"},s[1]&&(n.allowed=!/NO/.test(s[1])),void u.trigger("data",n);if(s=/^#EXT-X-MAP:?(.*)$/.exec(t),s)return n={type:"tag",tagType:"map"},s[1]&&((e=parseAttributes(s[1])).URI&&(n.uri=e.URI),e.BYTERANGE&&(a=(i=e.BYTERANGE.split("@"))[0],i=i[1],n.byterange={},a&&(n.byterange.length=parseInt(a,10)),i&&(n.byterange.offset=parseInt(i,10)))),void u.trigger("data",n);if(s=/^#EXT-X-STREAM-INF:?(.*)$/.exec(t),s)return n={type:"tag",tagType:"stream-inf"},s[1]&&(n.attributes=parseAttributes(s[1]),n.attributes.RESOLUTION&&(a={},(i=n.attributes.RESOLUTION.split("x"))[0]&&(a.width=parseInt(i[0],10)),i[1]&&(a.height=parseInt(i[1],10)),n.attributes.RESOLUTION=a),n.attributes.BANDWIDTH&&(n.attributes.BANDWIDTH=parseInt(n.attributes.BANDWIDTH,10)),n.attributes["PROGRAM-ID"]&&(n.attributes["PROGRAM-ID"]=parseInt(n.attributes["PROGRAM-ID"],10))),void u.trigger("data",n);if(s=/^#EXT-X-MEDIA:?(.*)$/.exec(t))return n={type:"tag",tagType:"media"},s[1]&&(n.attributes=parseAttributes(s[1])),void u.trigger("data",n);if(s=/^#EXT-X-ENDLIST/.exec(t))u.trigger("data",{type:"tag",tagType:"endlist"});else{if(!(s=/^#EXT-X-DISCONTINUITY/.exec(t)))return(s=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(t))?(n={type:"tag",tagType:"program-date-time"},s[1]&&(n.dateTimeString=s[1],n.dateTimeObject=new Date(s[1])),void u.trigger("data",n)):(s=/^#EXT-X-KEY:?(.*)$/.exec(t))?(n={type:"tag",tagType:"key"},s[1]&&(n.attributes=parseAttributes(s[1]),n.attributes.IV&&("0x"===n.attributes.IV.substring(0,2).toLowerCase()&&(n.attributes.IV=n.attributes.IV.substring(2)),n.attributes.IV=n.attributes.IV.match(/.{8}/g),n.attributes.IV[0]=parseInt(n.attributes.IV[0],16),n.attributes.IV[1]=parseInt(n.attributes.IV[1],16),n.attributes.IV[2]=parseInt(n.attributes.IV[2],16),n.attributes.IV[3]=parseInt(n.attributes.IV[3],16),n.attributes.IV=new Uint32Array(n.attributes.IV))),void u.trigger("data",n)):(s=/^#EXT-X-START:?(.*)$/.exec(t))?(n={type:"tag",tagType:"start"},s[1]&&(n.attributes=parseAttributes(s[1]),n.attributes["TIME-OFFSET"]=parseFloat(n.attributes["TIME-OFFSET"]),n.attributes.PRECISE=/YES/.test(n.attributes.PRECISE)),void u.trigger("data",n)):(s=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(t))?(n={type:"tag",tagType:"cue-out-cont"},s[1]?n.data=s[1]:n.data="",void u.trigger("data",n)):(s=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(t))?(n={type:"tag",tagType:"cue-out"},s[1]?n.data=s[1]:n.data="",void u.trigger("data",n)):(s=/^#EXT-X-CUE-IN:?(.*)?$/.exec(t))?(n={type:"tag",tagType:"cue-in"},s[1]?n.data=s[1]:n.data="",void u.trigger("data",n)):void u.trigger("data",{type:"tag",data:t.slice(4)});u.trigger("data",{type:"tag",tagType:"discontinuity"})}}else u.trigger("data",{type:"comment",text:t.slice(1)})}):this.trigger("data",{type:"uri",uri:i}))},i.addParser=function(t){var e=this,i=t.expression,a=t.customType,r=t.dataParser,s=t.segment;"function"!=typeof r&&(r=function(t){return t}),this.customParsers.push(function(t){if(i.exec(t))return e.trigger("data",{type:"custom",data:r(t),customType:a,segment:s}),!0})},i.addTagMapper=function(t){var e=t.expression,i=t.map;this.tagMappers.push(function(t){return e.test(t)?i(t):t})},t}(Stream__default.default),Parser=function(e){function t(){var t=e.call(this)||this;t.lineStream=new LineStream,t.parseStream=new ParseStream,t.lineStream.pipe(t.parseStream);var r,s,n=_assertThisInitialized__default.default(t),u=[],o={},g={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},d=0;t.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var f=0;return t.parseStream.on("data",function(e){var i,a;({tag:function(){({"allow-cache":function(){this.manifest.allowCache=e.allowed,"allowed"in e||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var t={};"length"in e&&((o.byterange=t).length=e.length,"offset"in e||(e.offset=f)),"offset"in e&&((o.byterange=t).offset=e.offset),f=t.offset+t.length},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),0<e.duration&&(o.duration=e.duration),0===e.duration&&(o.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=u},key:function(){if(e.attributes)if("NONE"!==e.attributes.METHOD)if(e.attributes.URI){if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===e.attributes.KEYFORMAT)return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(e.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===e.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==e.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):e.attributes.KEYID&&"0x"===e.attributes.KEYID.substring(0,2)?void(this.manifest.contentProtection={"com.widevine.alpha":{attributes:{schemeIdUri:e.attributes.KEYFORMAT,keyId:e.attributes.KEYID.substring(2)},pssh:decodeB64ToUint8Array__default.default(e.attributes.URI.split(",")[1])}}):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}));e.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),s={method:e.attributes.METHOD||"AES-128",uri:e.attributes.URI},void 0!==e.attributes.IV&&(s.iv=e.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else s=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(e.number)?this.manifest.mediaSequence=e.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+e.number})},"discontinuity-sequence":function(){isFinite(e.number)?(this.manifest.discontinuitySequence=e.number,d=e.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+e.number})},"playlist-type":function(){/VOD|EVENT/.test(e.playlistType)?this.manifest.playlistType=e.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+e.playlist})},map:function(){r={},e.uri&&(r.uri=e.uri),e.byterange&&(r.byterange=e.byterange)},"stream-inf":function(){this.manifest.playlists=u,this.manifest.mediaGroups=this.manifest.mediaGroups||g,e.attributes?(o.attributes||(o.attributes={}),_extends__default.default(o.attributes,e.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){var t;this.manifest.mediaGroups=this.manifest.mediaGroups||g,e.attributes&&e.attributes.TYPE&&e.attributes["GROUP-ID"]&&e.attributes.NAME?((t=this.manifest.mediaGroups[e.attributes.TYPE])[e.attributes["GROUP-ID"]]=t[e.attributes["GROUP-ID"]]||{},i=t[e.attributes["GROUP-ID"]],(a={default:/yes/i.test(e.attributes.DEFAULT)}).default?a.autoselect=!0:a.autoselect=/yes/i.test(e.attributes.AUTOSELECT),e.attributes.LANGUAGE&&(a.language=e.attributes.LANGUAGE),e.attributes.URI&&(a.uri=e.attributes.URI),e.attributes["INSTREAM-ID"]&&(a.instreamId=e.attributes["INSTREAM-ID"]),e.attributes.CHARACTERISTICS&&(a.characteristics=e.attributes.CHARACTERISTICS),e.attributes.FORCED&&(a.forced=/yes/i.test(e.attributes.FORCED)),i[e.attributes.NAME]=a):this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){d+=1,o.discontinuity=!0,this.manifest.discontinuityStarts.push(u.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=e.dateTimeString,this.manifest.dateTimeObject=e.dateTimeObject),o.dateTimeString=e.dateTimeString,o.dateTimeObject=e.dateTimeObject},targetduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+e.duration}):this.manifest.targetDuration=e.duration},totalduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid total duration: "+e.duration}):this.manifest.totalDuration=e.duration},start:function(){e.attributes&&!isNaN(e.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:e.attributes["TIME-OFFSET"],precise:e.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){o.cueOut=e.data},"cue-out-cont":function(){o.cueOutCont=e.data},"cue-in":function(){o.cueIn=e.data}}[e.tagType]||function(){}).call(n)},uri:function(){o.uri=e.uri,u.push(o),!this.manifest.targetDuration||"duration"in o||(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),o.duration=this.manifest.targetDuration),s&&(o.key=s),o.timeline=d,r&&(o.map=r),o={}},comment:function(){},custom:function(){e.segment?(o.custom=o.custom||{},o.custom[e.customType]=e.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[e.customType]=e.data)}})[e.type].call(n)}),t}_inheritsLoose__default.default(t,e);var i=t.prototype;return i.push=function(t){this.lineStream.push(t)},i.end=function(){this.lineStream.push("\n")},i.addParser=function(t){this.parseStream.addParser(t)},i.addTagMapper=function(t){this.parseStream.addTagMapper(t)},t}(Stream__default.default);exports.LineStream=LineStream,exports.ParseStream=ParseStream,exports.Parser=Parser;