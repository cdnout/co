import Mmenu from"./../oncanvas/mmenu.oncanvas";import options from"./_options";import configs from"./_configs";import{extendShorthandOptions}from"./_options";import*as DOM from"../../_modules/dom";import*as events from"../../_modules/eventlisteners";import{extend,transitionend,uniqueId,originalId}from"../../_modules/helpers";Mmenu.options.offCanvas=options,Mmenu.configs.offCanvas=configs;export default function(){var e=this;if(this.opts.offCanvas){var n=extendShorthandOptions(this.opts.offCanvas);this.opts.offCanvas=extend(n,Mmenu.options.offCanvas);var o=this.conf.offCanvas;this._api.push("open","close","setPage"),this.vars.opened=!1,this.bind("initMenu:before",function(){o.clone&&(e.node.menu=e.node.menu.cloneNode(!0),e.node.menu.id&&(e.node.menu.id="mm-"+e.node.menu.id),DOM.find(e.node.menu,"[id]").forEach(function(e){e.id="mm-"+e.id})),e.node.wrpr=document.body,document.querySelector(o.menu.insertSelector)[o.menu.insertMethod](e.node.menu)}),this.bind("initMenu:after",function(){initBlocker.call(e),e.setPage(Mmenu.node.page),initWindow.call(e),e.node.menu.classList.add("mm-menu_offcanvas");var n=window.location.hash;if(n){var o=originalId(e.node.menu.id);o&&o==n.slice(1)&&setTimeout(function(){e.open()},1e3)}}),this.bind("setPage:after",function(e){Mmenu.node.blck&&DOM.children(Mmenu.node.blck,"a").forEach(function(n){n.setAttribute("href","#"+e.id)})}),this.bind("open:start:sr-aria",function(){Mmenu.sr_aria(e.node.menu,"hidden",!1)}),this.bind("close:finish:sr-aria",function(){Mmenu.sr_aria(e.node.menu,"hidden",!0)}),this.bind("initMenu:after:sr-aria",function(){Mmenu.sr_aria(e.node.menu,"hidden",!0)}),this.bind("initBlocker:after:sr-text",function(){DOM.children(Mmenu.node.blck,"a").forEach(function(n){n.innerHTML=Mmenu.sr_text(e.i18n(e.conf.screenReader.text.closeMenu))})}),this.clck.push(function(n,o){var t=originalId(e.node.menu.id);if(t&&n.matches('[href="#'+t+'"]')){if(o.inMenu)return e.open(),!0;var i=n.closest(".mm-menu");if(i){var r=i.mmApi;if(r&&r.close)return r.close(),transitionend(i,function(){e.open()},e.conf.transitionDuration),!0}return e.open(),!0}if((t=Mmenu.node.page.id)&&n.matches('[href="#'+t+'"]'))return e.close(),!0})}};Mmenu.prototype.open=function(){var e=this;this.trigger("open:before"),this.vars.opened||(this._openSetup(),setTimeout(function(){e._openStart()},this.conf.openingInterval),this.trigger("open:after"))},Mmenu.prototype._openSetup=function(){var e=this,n=this.opts.offCanvas;this.closeAllOthers(),events.trigger(window,"resize.page",{force:!0});var o=["mm-wrapper_opened"];n.blockUI&&o.push("mm-wrapper_blocking"),"modal"==n.blockUI&&o.push("mm-wrapper_modal"),n.moveBackground&&o.push("mm-wrapper_background"),o.forEach(function(n){e.node.wrpr.classList.add(n)}),setTimeout(function(){e.vars.opened=!0},this.conf.openingInterval),this.node.menu.classList.add("mm-menu_opened")},Mmenu.prototype._openStart=function(){var e=this;transitionend(Mmenu.node.page,function(){e.trigger("open:finish")},this.conf.transitionDuration),this.trigger("open:start"),this.node.wrpr.classList.add("mm-wrapper_opening")},Mmenu.prototype.close=function(){var e=this;this.trigger("close:before"),this.vars.opened&&(transitionend(Mmenu.node.page,function(){e.node.menu.classList.remove("mm-menu_opened");["mm-wrapper_opened","mm-wrapper_blocking","mm-wrapper_modal","mm-wrapper_background"].forEach(function(n){e.node.wrpr.classList.remove(n)}),e.vars.opened=!1,e.trigger("close:finish")},this.conf.transitionDuration),this.trigger("close:start"),this.node.wrpr.classList.remove("mm-wrapper_opening"),this.trigger("close:after"))},Mmenu.prototype.closeAllOthers=function(){var e=this;DOM.find(document.body,".mm-menu_offcanvas").forEach(function(n){if(n!==e.node.menu){var o=n.mmApi;o&&o.close&&o.close()}})},Mmenu.prototype.setPage=function(e){this.trigger("setPage:before",[e]);var n=this.conf.offCanvas;if(!e){var o="string"==typeof n.page.selector?DOM.find(document.body,n.page.selector):DOM.children(document.body,n.page.nodetype);if(o=o.filter(function(e){return!e.matches(".mm-menu, .mm-wrapper__blocker")}),n.page.noSelector.length&&(o=o.filter(function(e){return!e.matches(n.page.noSelector.join(", "))})),o.length>1){var t=DOM.create("div");o[0].before(t),o.forEach(function(e){t.append(e)}),o=[t]}e=o[0]}e.classList.add("mm-page"),e.classList.add("mm-slideout"),e.id=e.id||uniqueId(),Mmenu.node.page=e,this.trigger("setPage:after",[e])};var initWindow=function(){var e=this;events.off(document.body,"keydown.tabguard"),events.on(document.body,"keydown.tabguard",function(n){9==n.keyCode&&e.node.wrpr.matches(".mm-wrapper_opened")&&n.preventDefault()})},initBlocker=function(){var e=this;this.trigger("initBlocker:before");var n=this.opts.offCanvas,o=this.conf.offCanvas;if(n.blockUI){if(!Mmenu.node.blck){var t=DOM.create("div.mm-wrapper__blocker.mm-slideout");t.innerHTML="<a></a>",document.querySelector(o.menu.insertSelector).append(t),Mmenu.node.blck=t}var i=function(n){n.preventDefault(),n.stopPropagation(),e.node.wrpr.matches(".mm-wrapper_modal")||e.close()};Mmenu.node.blck.addEventListener("mousedown",i),Mmenu.node.blck.addEventListener("touchstart",i),Mmenu.node.blck.addEventListener("touchmove",i),this.trigger("initBlocker:after")}};