import options from"./_options";import configs from"./_configs";import translate from"./translations/translate";import*as DOM from"../../_modules/dom";import*as i18n from"../../_modules/i18n";import*as media from"../../_modules/matchmedia";import{type,extend,transitionend,uniqueId,valueOrFn}from"../../_modules/helpers";translate();var Mmenu=function(){function e(t,i,n){return this.opts=extend(i,e.options),this.conf=extend(n,e.configs),this._api=["bind","initPanel","initListview","openPanel","closePanel","closeAllPanels","setSelected"],this.node={},this.vars={},this.hook={},this.clck=[],this.node.menu="string"==typeof t?document.querySelector(t):t,"function"==typeof this._deprecatedWarnings&&this._deprecatedWarnings(),this._initWrappers(),this._initAddons(),this._initExtensions(),this._initHooks(),this._initAPI(),this._initMenu(),this._initPanels(),this._initOpened(),this._initAnchors(),media.watch(),this}return e.prototype.openPanel=function(e,t){var i=this;if(this.trigger("openPanel:before",[e]),e&&(e.matches(".mm-panel")||(e=e.closest(".mm-panel")),e)){if("boolean"!=typeof t&&(t=!0),e.parentElement.matches(".mm-listitem_vertical")){DOM.parents(e,".mm-listitem_vertical").forEach(function(e){e.classList.add("mm-listitem_opened"),DOM.children(e,".mm-panel").forEach(function(e){e.classList.remove("mm-hidden")})});var n=DOM.parents(e,".mm-panel").filter(function(e){return!e.parentElement.matches(".mm-listitem_vertical")});this.trigger("openPanel:start",[e]),n.length&&this.openPanel(n[0]),this.trigger("openPanel:finish",[e])}else{if(e.matches(".mm-panel_opened"))return;var s=DOM.children(this.node.pnls,".mm-panel"),a=DOM.children(this.node.pnls,".mm-panel_opened")[0];s.filter(function(t){return t!==e}).forEach(function(e){e.classList.remove("mm-panel_opened-parent")});for(var r=e.mmParent;r;)(r=r.closest(".mm-panel"))&&(r.parentElement.matches(".mm-listitem_vertical")||r.classList.add("mm-panel_opened-parent"),r=r.mmParent);s.forEach(function(e){e.classList.remove("mm-panel_highest")}),s.filter(function(e){return e!==a}).filter(function(t){return t!==e}).forEach(function(e){e.classList.add("mm-hidden")}),e.classList.remove("mm-hidden");var o=function(){a&&a.classList.remove("mm-panel_opened"),e.classList.add("mm-panel_opened"),e.matches(".mm-panel_opened-parent")?(a&&a.classList.add("mm-panel_highest"),e.classList.remove("mm-panel_opened-parent")):(a&&a.classList.add("mm-panel_opened-parent"),e.classList.add("mm-panel_highest")),i.trigger("openPanel:start",[e])},l=function(){a&&(a.classList.remove("mm-panel_highest"),a.classList.add("mm-hidden")),e.classList.remove("mm-panel_highest"),i.trigger("openPanel:finish",[e])};t&&!e.matches(".mm-panel_noanimation")?setTimeout(function(){transitionend(e,function(){l()},i.conf.transitionDuration),o()},this.conf.openingInterval):(o(),l())}this.trigger("openPanel:after",[e])}},e.prototype.closePanel=function(e){this.trigger("closePanel:before",[e]);var t=e.parentElement;t.matches(".mm-listitem_vertical")&&(t.classList.remove("mm-listitem_opened"),e.classList.add("mm-hidden"),this.trigger("closePanel",[e])),this.trigger("closePanel:after",[e])},e.prototype.closeAllPanels=function(e){this.trigger("closeAllPanels:before"),this.node.pnls.querySelectorAll(".mm-listitem").forEach(function(e){e.classList.remove("mm-listitem_selected"),e.classList.remove("mm-listitem_opened")});var t=DOM.children(this.node.pnls,".mm-panel"),i=e||t[0];DOM.children(this.node.pnls,".mm-panel").forEach(function(e){e!==i&&(e.classList.remove("mm-panel_opened"),e.classList.remove("mm-panel_opened-parent"),e.classList.remove("mm-panel_highest"),e.classList.add("mm-hidden"))}),this.openPanel(i,!1),this.trigger("closeAllPanels:after")},e.prototype.togglePanel=function(e){var t=e.parentElement;t.matches(".mm-listitem_vertical")&&this[t.matches(".mm-listitem_opened")?"closePanel":"openPanel"](e)},e.prototype.setSelected=function(e){this.trigger("setSelected:before",[e]),DOM.find(this.node.menu,".mm-listitem_selected").forEach(function(e){e.classList.remove("mm-listitem_selected")}),e.classList.add("mm-listitem_selected"),this.trigger("setSelected:after",[e])},e.prototype.bind=function(e,t){this.hook[e]=this.hook[e]||[],this.hook[e].push(t)},e.prototype.trigger=function(e,t){if(this.hook[e])for(var i=0,n=this.hook[e].length;i<n;i++)this.hook[e][i].apply(this,t)},e.prototype._initAPI=function(){var e=this,t=this;this.API={},this._api.forEach(function(i){e.API[i]=function(){var e=t[i].apply(t,arguments);return void 0===e?t.API:e}}),this.node.menu.mmApi=this.API},e.prototype._initHooks=function(){for(var e in this.opts.hooks)this.bind(e,this.opts.hooks[e])},e.prototype._initWrappers=function(){this.trigger("initWrappers:before");for(var t=0;t<this.opts.wrappers.length;t++){var i=e.wrappers[this.opts.wrappers[t]];"function"==typeof i&&i.call(this)}this.trigger("initWrappers:after")},e.prototype._initAddons=function(){for(var t in this.trigger("initAddons:before"),e.addons)e.addons[t].call(this);this.trigger("initAddons:after")},e.prototype._initExtensions=function(){var e=this;this.trigger("initExtensions:before"),"array"==type(this.opts.extensions)&&(this.opts.extensions={all:this.opts.extensions}),Object.keys(this.opts.extensions).forEach(function(t){var i=e.opts.extensions[t].map(function(e){return"mm-menu_"+e});i.length&&media.add(t,function(){i.forEach(function(t){e.node.menu.classList.add(t)})},function(){i.forEach(function(t){e.node.menu.classList.remove(t)})})}),this.trigger("initExtensions:after")},e.prototype._initMenu=function(){var e=this;this.trigger("initMenu:before"),this.node.wrpr=this.node.wrpr||this.node.menu.parentElement,this.node.wrpr.classList.add("mm-wrapper"),this.node.menu.id=this.node.menu.id||uniqueId();var t=DOM.create("div.mm-panels");DOM.children(this.node.menu).forEach(function(i){e.conf.panelNodetype.indexOf(i.nodeName.toLowerCase())>-1&&t.append(i)}),this.node.menu.append(t),this.node.pnls=t,this.node.menu.classList.add("mm-menu"),this.trigger("initMenu:after")},e.prototype._initPanels=function(){var e=this;this.trigger("initPanels:before"),this.clck.push(function(t,i){if(i.inMenu){var n=t.getAttribute("href");if(n&&n.length>1&&"#"==n.slice(0,1))try{var s=DOM.find(e.node.menu,n)[0];if(s&&s.matches(".mm-panel"))return t.parentElement.matches(".mm-listitem_vertical")?e.togglePanel(s):e.openPanel(s),!0}catch(e){}}}),DOM.children(this.node.pnls).forEach(function(t){e.initPanel(t)}),this.trigger("initPanels:after")},e.prototype.initPanel=function(e){var t=this,i=this.conf.panelNodetype.join(", ");if(e.matches(i)&&(e.matches(".mm-panel")||(e=this._initPanel(e)),e)){var n=[];n.push.apply(n,DOM.children(e,"."+this.conf.classNames.panel)),DOM.children(e,".mm-listview").forEach(function(e){DOM.children(e,".mm-listitem").forEach(function(e){n.push.apply(n,DOM.children(e,i))})}),n.forEach(function(e){t.initPanel(e)})}},e.prototype._initPanel=function(e){var t=this;if(this.trigger("initPanel:before",[e]),DOM.reClass(e,this.conf.classNames.panel,"mm-panel"),DOM.reClass(e,this.conf.classNames.nopanel,"mm-nopanel"),DOM.reClass(e,this.conf.classNames.inset,"mm-listview_inset"),e.matches(".mm-listview_inset")&&e.classList.add("mm-nopanel"),e.matches(".mm-nopanel"))return null;var i=e.id||uniqueId(),n=e.matches("."+this.conf.classNames.vertical)||!this.opts.slidingSubmenus;if(e.classList.remove(this.conf.classNames.vertical),e.matches("ul, ol")){e.removeAttribute("id");var s=DOM.create("div");e.before(s),s.append(e),e=s}e.id=i,e.classList.add("mm-panel"),e.classList.add("mm-hidden");var a=[e.parentElement].filter(function(e){return e.matches("li")})[0];if(n?a&&a.classList.add("mm-listitem_vertical"):this.node.pnls.append(e),a&&(a.mmChild=e,e.mmParent=a,a&&a.matches(".mm-listitem")&&!DOM.children(a,".mm-btn").length)){var r=DOM.children(a,".mm-listitem__text")[0];if(r){var o=DOM.create("a.mm-btn.mm-btn_next.mm-listitem__btn");o.setAttribute("href","#"+e.id),r.matches("span")?(o.classList.add("mm-listitem__text"),o.innerHTML=r.innerHTML,a.insertBefore(o,r.nextElementSibling),r.remove()):a.insertBefore(o,DOM.children(a,".mm-panel")[0])}}return this._initNavbar(e),DOM.children(e,"ul, ol").forEach(function(e){t.initListview(e)}),this.trigger("initPanel:after",[e]),e},e.prototype._initNavbar=function(e){if(this.trigger("initNavbar:before",[e]),!DOM.children(e,".mm-navbar").length){var t=null,i=null;if(e.getAttribute("data-mm-parent")?i=DOM.find(this.node.pnls,e.getAttribute("data-mm-parent"))[0]:(t=e.mmParent)&&(i=t.closest(".mm-panel")),!t||!t.matches(".mm-listitem_vertical")){var n=DOM.create("div.mm-navbar");if(this.opts.navbar.add?this.opts.navbar.sticky&&n.classList.add("mm-navbar_sticky"):n.classList.add("mm-hidden"),i){var s=DOM.create("a.mm-btn.mm-btn_prev.mm-navbar__btn");s.setAttribute("href","#"+i.id),n.append(s)}var a=null;t?a=DOM.children(t,".mm-listitem__text")[0]:i&&(a=DOM.find(i,'a[href="#'+e.id+'"]')[0]);var r=DOM.create("a.mm-navbar__title"),o=DOM.create("span");switch(r.append(o),o.innerHTML=e.getAttribute("data-mm-title")||(a?a.textContent:"")||this.i18n(this.opts.navbar.title)||this.i18n("Menu"),this.opts.navbar.titleLink){case"anchor":a&&r.setAttribute("href",a.getAttribute("href"));break;case"parent":i&&r.setAttribute("href","#"+i.id)}n.append(r),e.prepend(n),this.trigger("initNavbar:after",[e])}}},e.prototype.initListview=function(e){var t=this;this.trigger("initListview:before",[e]),DOM.reClass(e,this.conf.classNames.nolistview,"mm-nolistview"),e.matches(".mm-nolistview")||(e.classList.add("mm-listview"),DOM.children(e).forEach(function(e){e.classList.add("mm-listitem"),DOM.reClass(e,t.conf.classNames.selected,"mm-listitem_selected"),DOM.children(e,"a, span").forEach(function(e){e.matches(".mm-btn")||e.classList.add("mm-listitem__text")})})),this.trigger("initListview:after",[e])},e.prototype._initOpened=function(){this.trigger("initOpened:before");var e=this.node.pnls.querySelectorAll(".mm-listitem_selected"),t=null;e.forEach(function(e){t=e,e.classList.remove("mm-listitem_selected")}),t&&t.classList.add("mm-listitem_selected");var i=t?t.closest(".mm-panel"):DOM.children(this.node.pnls,".mm-panel")[0];this.openPanel(i,!1),this.trigger("initOpened:after")},e.prototype._initAnchors=function(){var e=this;this.trigger("initAnchors:before"),document.addEventListener("click",function(t){var i=t.target.closest("a[href]");if(i){for(var n={inMenu:i.closest(".mm-menu")===e.node.menu,inListview:i.matches(".mm-listitem > a"),toExternal:i.matches('[rel="external"]')||i.matches('[target="_blank"]')},s={close:null,setSelected:null,preventDefault:"#"==i.getAttribute("href").slice(0,1)},a=0;a<e.clck.length;a++){var r=e.clck[a].call(e,i,n);if(r){if("boolean"==typeof r)return void t.preventDefault();"object"==type(r)&&(s=extend(r,s))}}n.inMenu&&n.inListview&&!n.toExternal&&(valueOrFn(i,e.opts.onClick.setSelected,s.setSelected)&&e.setSelected(i.parentElement),valueOrFn(i,e.opts.onClick.preventDefault,s.preventDefault)&&t.preventDefault(),valueOrFn(i,e.opts.onClick.close,s.close)&&e.opts.offCanvas&&"function"==typeof e.close&&e.close())}},!0),this.trigger("initAnchors:after")},e.prototype.i18n=function(e){return i18n.get(e,this.conf.language)},e.options=options,e.configs=configs,e.addons={},e.wrappers={},e.node={},e.vars={},e}();export default Mmenu;