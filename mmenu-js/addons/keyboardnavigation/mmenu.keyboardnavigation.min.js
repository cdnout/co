import Mmenu from"../../core/oncanvas/mmenu.oncanvas";import options from"./_options";import{extendShorthandOptions}from"./_options";import*as DOM from"../../_modules/dom";import*as events from"../../_modules/eventlisteners";import*as support from"../../_modules/support";import{extend}from"../../_modules/helpers";Mmenu.options.keyboardNavigation=options;export default function(){var e=this;if(!support.touch){var n=extendShorthandOptions(this.opts.keyboardNavigation);if(this.opts.keyboardNavigation=extend(n,Mmenu.options.keyboardNavigation),n.enable){var t=DOM.create("button.mm-tabstart.mm-sronly"),o=DOM.create("button.mm-tabend.mm-sronly"),a=DOM.create("button.mm-tabend.mm-sronly");this.bind("initMenu:after",function(){n.enhance&&e.node.menu.classList.add("mm-menu_keyboardfocus"),initWindow.call(e,n.enhance)}),this.bind("initOpened:before",function(){e.node.menu.prepend(t),e.node.menu.append(o),DOM.children(e.node.menu,".mm-navbars-top, .mm-navbars-bottom").forEach(function(e){e.querySelectorAll(".mm-navbar__title").forEach(function(e){e.setAttribute("tabindex","-1")})})}),this.bind("initBlocker:after",function(){Mmenu.node.blck.append(a),DOM.children(Mmenu.node.blck,"a")[0].classList.add("mm-tabstart")});var m="input, select, textarea, button, label, a[href]",i=function(t){t=t||DOM.children(e.node.pnls,".mm-panel_opened")[0];var o=null,a=document.activeElement.closest(".mm-navbar");if(!a||a.closest(".mm-menu")!=e.node.menu){if("default"==n.enable&&((o=DOM.find(t,".mm-listview a[href]:not(.mm-hidden)")[0])||(o=DOM.find(t,m+":not(.mm-hidden)")[0]),!o)){var i=[];DOM.children(e.node.menu,".mm-navbars_top, .mm-navbars_bottom").forEach(function(e){i.push.apply(i,DOM.find(e,m+":not(.mm-hidden)"))}),o=i[0]}o||(o=DOM.children(e.node.menu,".mm-tabstart")[0]),o&&o.focus()}};this.bind("open:finish",i),this.bind("openPanel:finish",i),this.bind("initOpened:after:sr-aria",function(){[e.node.menu,Mmenu.node.blck].forEach(function(e){DOM.children(e,".mm-tabstart, .mm-tabend").forEach(function(e){Mmenu.sr_aria(e,"hidden",!0),Mmenu.sr_role(e,"presentation")})})})}}};var initWindow=function(e){var n=this;events.off(document.body,"keydown.tabguard"),events.off(document.body,"focusin.tabguard"),events.on(document.body,"focusin.tabguard",function(e){if(n.node.wrpr.matches(".mm-wrapper_opened")){var t=e.target;if(t.matches(".mm-tabend")){var o=void 0;t.parentElement.matches(".mm-menu")&&Mmenu.node.blck&&(o=Mmenu.node.blck),t.parentElement.matches(".mm-wrapper__blocker")&&(o=DOM.find(document.body,".mm-menu_offcanvas.mm-menu_opened")[0]),o||(o=t.parentElement),o&&DOM.children(o,".mm-tabstart")[0].focus()}}}),events.off(document.body,"keydown.navigate"),events.on(document.body,"keydown.navigate",function(n){var t=n.target,o=t.closest(".mm-menu");if(o){o.mmApi;if(!t.matches("input, textarea"))switch(n.keyCode){case 13:(t.matches(".mm-toggle")||t.matches(".mm-check"))&&t.dispatchEvent(new Event("click"));break;case 32:case 37:case 38:case 39:case 40:n.preventDefault()}if(e)if(t.matches("input"))switch(n.keyCode){case 27:t.value=""}else{var a=o.mmApi;switch(n.keyCode){case 8:var m=DOM.find(o,".mm-panel_opened")[0].mmParent;m&&a.openPanel(m.closest(".mm-panel"));break;case 27:o.matches(".mm-menu_offcanvas")&&a.close()}}}})};