!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():e.Bag=t()}(this,function(){"use strict";function e(e,t){if(c(e)){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n++)t(e[n],n,e)}else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(e[r],r)}function t(t,n){return e(n,function(e,r){t[r]||(t[r]=n[r])}),t}function n(t){var n=this,r=t+"__";this.init=function(){return s.resolve()},this.remove=function(e){return localStorage.removeItem(r+e),s.resolve()},this.set=function(t,o,i){var u={value:o,expire:i};return new s(function(o,i){try{localStorage.setItem(r+t,JSON.stringify(u)),o()}catch(a){if(a.name.toUpperCase().indexOf("QUOTA")>=0)try{e(localStorage,function(e,t){var o=t.split(r)[1];o&&n.remove(o)}),localStorage.setItem(r+t,JSON.stringify(u)),o()}catch(e){i(e)}else i(a)}})},this.get=function(e,t){return new s(function(n,o){try{var i=localStorage.getItem(r+e);if(null===i)return n();i=JSON.parse(localStorage.getItem(r+e)),n(i=t?i:i.value)}catch(t){o(new Error("Can't read key: "+e))}})},this.clear=function(t){var o=+new Date,i=s.resolve();return e(localStorage,function(e,u){var a=u.split(r)[1];if(a)return t?void(i=i.then(function(){return n.get(a,!0).then(function(e){e&&e.expire>0&&e.expire-o<0&&n.remove(a)})})):void(i=i.then(function(){n.remove(a)}))}),i}}function r(e){var t;this.init=function(){return new s(function(n,r){return(t=window.openDatabase(e,"1.0","bag.js db",2e5))?void t.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS kv (key TEXT PRIMARY KEY, value TEXT, expire INTEGER KEY)",[],function(){n()},function(e,t){r(t)})}):void r("Can't open websql database")})},this.remove=function(e){return new s(function(n,r){t.transaction(function(t){t.executeSql("DELETE FROM kv WHERE key = ?",[e],function(){n()},function(e,t){r(t)})})})},this.set=function(e,n,r){return new s(function(o,i){t.transaction(function(t){t.executeSql("INSERT OR REPLACE INTO kv (key, value, expire) VALUES (?, ?, ?)",[e,JSON.stringify(n),r],function(){o()},function(e,t){i(t)})})})},this.get=function(e){return new s(function(n,r){t.readTransaction(function(t){t.executeSql("SELECT value FROM kv WHERE key = ?",[e],function(e,t){if(0===t.rows.length)return n();var o=t.rows.item(0).value;try{n(JSON.parse(o))}catch(e){r(new Error("Can't unserialise data: "+o))}},function(e,t){r(t)})})})},this.clear=function(e){return new s(function(n,r){t.transaction(function(t){t.executeSql(e?"DELETE FROM kv WHERE expire > 0 AND expire < ?":"DELETE FROM kv",e?[+new Date]:[],function(){n()},function(e,t){r(t)})})})}}function o(e){var t;this.init=function(){return new s(function(n,r){var o=window.indexedDB,i=o.open(e,2);i.onsuccess=function(e){t=e.target.result,n()},i.onblocked=function(e){r(new Error("IndexedDB blocked. "+e.target.errorCode))},i.onerror=function(e){r(new Error("IndexedDB opening error. "+e.target.errorCode))},i.onupgradeneeded=function(e){t=e.target.result,t.objectStoreNames.contains("kv")&&t.deleteObjectStore("kv");var n=t.createObjectStore("kv",{keyPath:"key"});n.createIndex("expire","expire",{unique:!1})}})},this.remove=function(e){return new s(function(n,r){var o=t.transaction("kv","readwrite");o.oncomplete=function(){n()},o.onerror=o.onabort=function(e){r(e.target)},o.objectStore("kv").delete(e).onerror=function(){o.abort()}})},this.set=function(e,n,r){return new s(function(o,i){var u=t.transaction("kv","readwrite");u.oncomplete=function(){o()},u.onerror=u.onabort=function(e){i(e.target)},u.objectStore("kv").put({key:e,value:n,expire:r}).onerror=function(){u.abort()}})},this.get=function(e){return new s(function(n,r){var o=t.transaction("kv");o.onerror=o.onabort=function(e){r(new Error("Key get error: "+e.target))},o.objectStore("kv").get(e).onsuccess=function(e){e.target.result?n(e.target.result.value):n()}})},this.clear=function(e){return new s(function(n,r){var o=window.IDBKeyRange,i=t.transaction("kv","readwrite"),u=i.objectStore("kv");if(i=t.transaction("kv","readwrite"),u=i.objectStore("kv"),i.oncomplete=function(){n()},i.onerror=i.onabort=function(e){r(new Error("Clear error: ",e.target))},e){var a=u.index("expire").openCursor(o.bound(1,+new Date));return void(a.onsuccess=function(e){var t=e.target.result;t&&(u.delete(t.primaryKey).onerror=function(){i.abort()},t.continue())})}i.objectStore("kv").clear().onerror=function(){i.abort()}})}}function i(t,n){function r(){return s.resolve().then(function(){if(!o)throw new Error("No available db");return o.init().then(function(){o.clear(!0)})})}var o=null;e(n,function(e){if(e=e.toLowerCase(),!f[e])throw new Error("Wrong storage adapter name: "+e,n);if(f[e].exists()&&!o)return o=new f[e](t),!1}),o||"undefined"!=typeof console&&console.log&&console.log("None of requested storages available: "+n);var i;this.init=function(){return i||(i=r()),i},this.set=function(e,t,n){return this.init().then(function(){return o.set(e,t,n?+new Date+1e3*n:0)})},this.get=function(e){return this.init().then(function(){return o.get(e)})},this.remove=function(e){return this.init().then(function(){return o.remove(e)})},this.clear=function(e){return this.init().then(function(){return o.clear(e)})}}function u(n){function r(){y||(y=new i(w.prefix,w.stores))}function o(e){return new s(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?t({content:r.responseText,type:r.getResponseHeader("content-type")}):n(new Error("Can't open url "+e+(r.status?r.statusText+" ("+r.status+")":""))))},setTimeout(function(){r.readyState<4&&(r.abort(),n(new Error("Timeout")))},1e3*w.timeout);try{r.send()}catch(e){n(e)}})}function f(t,n){var r={};e(["url","key","unique"],function(e){t[e]&&(r[e]=t[e])});var o=+new Date;return r.data=n.content,r.originalType=n.type,r.type=t.type||n.type,r.stamp=o,r}function l(e){return o(e.url_real).then(function(n){var r=60*(e.expire||w.expire)*60,o=f(e,n);return y.set(e.key,o,r).then(function(){return t(e,o)},function(){return t(e,o)})})}function d(e,t){return!e||e.expire-+new Date<0||t.unique!==e.unique||t.url!==e.url||w.isValidItem&&!w.isValidItem(e,t)}function p(e){return e.url?(e.key=e.key||e.url,y.get(e.key).then(function(e){return e},function(){return null}).then(function(n){if(!n&&e.cached)throw new Error("Cache not exists");e.execute=e.execute!==!1;var r=!n||d(n,e);return e.live||r?(e.url_real=e.url,e.unique&&(e.url_real=e.url+(e.url.indexOf("?")>0?"&":"?")+"bag-unique="+e.unique),l(e).then(function(){return e},function(r){if(!n)throw r;return e.type=e.type||n.originalType,t(e,n)})):(e.type=e.type||n.originalType,t(e,n))})):s.resolve()}function v(e){var t=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),n=e.match(t);return{scheme:n[2],authority:n[4],path:n[5],query:n[7],fragment:n[9]}}function h(e){var t=v(e.url),n=!1,r=e.data.replace(m,function(e,r,o,i,u,a,c){if(!e)return null;n=!0,r||(r=u,o=a,i=c);var s=v(o),f=(s.scheme?s.scheme:t.scheme)||window.location.protocol.slice(0,-1),l=(s.authority?s.authority:t.authority)||window.location.host,d="/"===s.path[0]?s.path:t.path.split("/").slice(0,-1).join("/")+"/"+s.path;return r+(f+"://"+l+d)+i});return n?r:""}function g(e){if(e.type){var t=e.type.split(";")[0];"application/x-javascript"!==t&&"text/javascript"!==t||(t="application/javascript"),x[t]&&x[t](e)}}if(!(this instanceof u))return new u(n);var w=this;n=n||{},this.prefix=n.prefix||"bag",this.timeout=n.timeout||20,this.expire=n.expire||720,this.isValidItem=n.isValidItem||null,this.stores=c(n.stores)?n.stores:["indexeddb","websql","localstorage"];var y=null,m=/(?:^([ \t]*\/\/[@|#][ \t]+sourceMappingURL=)(.+?)([ \t]*)$)|(?:^([ \t]*\/\*[@#][ \t]+sourceMappingURL=)(.+?)([ \t]*\*\/[ \t])*$)/gm,x={"application/javascript":function(e){var t,n=document.createElement("script");t=h(e),t||(t=e.data+"\n//# sourceURL="+e.url),n.text=t,a.appendChild(n)},"text/css":function(e){var t,n=document.createElement("style");t=h(e),t||(t=e.data+"\n/*# sourceURL="+e.url+" */"),n.setAttribute("type","text/css"),n.styleSheet?(a.appendChild(n),n.styleSheet.cssText=t):(n.appendChild(document.createTextNode(t)),a.appendChild(n))}};this.require=function(t){return r(),new s(function(n,r){var o=[],i=0,u=c(t)?t:[t];return t?(e(u,function(e,t){o[t]=!1}),void e(u,function(e,a){"string"==typeof e&&(u[a]={url:e}),p(u[a]).then(function(){o[a]=u[a].data;var e;for(e=i;e<o.length&&o[e]!==!1;e++)u[e].execute&&g(u[e]);i=e,i>=u.length&&n(c(t)?o:o[0])},function(e){r(e)})})):void n()})},e(["remove","get","set","clear"],function(e){w[e]=function(){return r(),y[e].apply(y,arguments)}}),this.addHandler=function(t,n){t=c(t)?t:[t],e(t,function(e){x[e]=n})},this.removeHandler=function(e){w.addHandler(e)}}var a=document.head||document.getElementsByTagName("head")[0],c=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},s=window.Promise;n.exists=function(){try{return localStorage.setItem("__ls_test__","__ls_test__"),localStorage.removeItem("__ls_test__"),!0}catch(e){return!1}},r.exists=function(){return!!window.openDatabase},o.exists=function(){var e=window.indexedDB;if(!e)return!1;var t="__idb_test__",n=null===e.open(t,1).onupgradeneeded;return e.deleteDatabase&&e.deleteDatabase(t),n};var f={indexeddb:o,websql:r,localstorage:n};return u});
//# sourceMappingURL=bag.min.js.map