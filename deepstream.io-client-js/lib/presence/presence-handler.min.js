"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function s(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,t,i){return t&&s(e.prototype,t),i&&s(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var EventEmitter=require("component-emitter2"),C=require("../constants/constants"),ResubscribeNotifier=require("../utils/resubscribe-notifier");function validateArguments(e,t,i){if(e="function"==typeof e&&void 0===t?(t=e,i):void 0===e&&void 0===t?i:[e],void 0!==t&&"function"!=typeof t)throw new Error("invalid argument callback");return{userId:e,callback:t}}module.exports=function(){function s(e,t,i){_classCallCheck(this,s),this._options=e,this._connection=t,this._client=i,this._queryEmitter=new EventEmitter,this._subscribeEmitter=new EventEmitter,this._ackTimeoutRegistry=i._$getAckTimeoutRegistry(),this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._resubscribe.bind(this)),this._counter=1,this._flush=this._flush.bind(this),this._flushTimeout=null,this._pendingSubscribes={},this._pendingUnsubscribes={}}return _createClass(s,[{key:"getAll",value:function(e,t){if("function"==typeof e)this._connection.sendMsg(C.TOPIC.PRESENCE,C.ACTIONS.QUERY,[C.ACTIONS.QUERY]),this._queryEmitter.once(C.ACTIONS.QUERY,e);else{var i=this._counter++;this._connection.sendMsg(C.TOPIC.PRESENCE,C.ACTIONS.QUERY,[i,e]),this._queryEmitter.once(i,t)}}},{key:"subscribe",value:function(e,t){var i=validateArguments(e,t,C.ACTIONS.SUBSCRIBE);this._subscribeEmitter.hasListeners(i.userId)||(i.userId===C.ACTIONS.SUBSCRIBE?(this._sendGlobalSubscription(C.ACTIONS.SUBSCRIBE),this._subscribeEmitter.on(C.ACTIONS.SUBSCRIBE,i.callback)):(delete this._pendingUnsubscribes[i.userId],this._pendingSubscribes[i.userId]=!0,this._flushTimeout||(this._flushTimeout=setTimeout(this._flush,0)),this._subscribeEmitter.on(i.userId,i.callback)))}},{key:"unsubscribe",value:function(e,t){var i=validateArguments(e,t,C.ACTIONS.UNSUBSCRIBE);i.userId===C.ACTIONS.UNSUBSCRIBE?this._subscribeEmitter.off(C.ACTIONS.SUBSCRIBE,i.callback):this._subscribeEmitter.off(i.userId,i.callback),this._subscribeEmitter.hasListeners(i.userId)||(i.userId===C.ACTIONS.UNSUBSCRIBE?this._sendGlobalSubscription(C.ACTIONS.UNSUBSCRIBE):(delete this._pendingSubscribes[i.userId],this._pendingUnsubscribes[i.userId]=!0,this._flushTimeout||(this._flushTimeout=setTimeout(this._flush,0))))}},{key:"_$handle",value:function(e){if(e.action===C.ACTIONS.ERROR&&e.data[0]===C.EVENT.MESSAGE_DENIED)this._ackTimeoutRegistry.remove(C.TOPIC.PRESENCE,e.data[1]),e.processedError=!0,this._client._$onError(C.TOPIC.PRESENCE,C.EVENT.MESSAGE_DENIED,e.data[1]);else if(e.action===C.ACTIONS.ACK)this._ackTimeoutRegistry.clear(e);else if(e.action===C.ACTIONS.PRESENCE_JOIN)this._subscribeEmitter.emit(C.ACTIONS.SUBSCRIBE,e.data[0],!0),this._subscribeEmitter.emit(e.data[0],!0,e.data[0]);else if(e.action===C.ACTIONS.PRESENCE_LEAVE)this._subscribeEmitter.emit(C.ACTIONS.SUBSCRIBE,e.data[0],!1),this._subscribeEmitter.emit(e.data[0],!1,e.data[0]);else if(e.action===C.ACTIONS.QUERY){try{var t=JSON.parse(e.data[1]);if("object"===(void 0===t?"undefined":_typeof(t)))return void this._queryEmitter.emit(e.data[0],t)}catch(e){}this._queryEmitter.emit(C.ACTIONS.QUERY,e.data)}else this._client._$onError(C.TOPIC.PRESENCE,C.EVENT.UNSOLICITED_MESSAGE,e.action)}},{key:"_resubscribe",value:function(){var e=Object.keys(this._subscribeEmitter._callbacks||{});-1<e.indexOf(C.ACTIONS.SUBSCRIBE)&&(e.splice(e.indexOf(C.ACTIONS.SUBSCRIBE),1),this._sendGlobalSubscription(C.ACTIONS.SUBSCRIBE)),0<e.length&&this._sendSubscriptionBulk(C.ACTIONS.SUBSCRIBE,e)}},{key:"_flush",value:function(){var e=Object.keys(this._pendingSubscribes);0<e.length&&(this._sendSubscriptionBulk(C.ACTIONS.SUBSCRIBE,e),this._pendingSubscribes={});var t=Object.keys(this._pendingUnsubscribes);0<t.length&&(this._sendSubscriptionBulk(C.ACTIONS.UNSUBSCRIBE,t),this._pendingUnsubscribes={}),this._flushTimeout=null}},{key:"_sendSubscriptionBulk",value:function(e,t){var i=this._counter++;this._ackTimeoutRegistry.add({topic:C.TOPIC.PRESENCE,action:e,name:i}),this._connection.sendMsg(C.TOPIC.PRESENCE,e,[i,t])}},{key:"_sendGlobalSubscription",value:function(e){this._ackTimeoutRegistry.add({topic:C.TOPIC.PRESENCE,action:e,name:e}),this._connection.sendMsg(C.TOPIC.PRESENCE,e,[e])}}]),s}();