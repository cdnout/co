"use strict";var messageBuilder=require("../message/message-builder"),messageParser=require("../message/message-parser"),ResubscribeNotifier=require("../utils/resubscribe-notifier"),C=require("../constants/constants"),Listener=require("../utils/listener"),EventEmitter=require("component-emitter2"),EventHandler=function(e,t,i){this._options=e,this._connection=t,this._client=i,this._emitter=new EventEmitter,this._listener={},this._ackTimeoutRegistry=i._$getAckTimeoutRegistry(),this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._resubscribe.bind(this))};EventHandler.prototype.eventNames=function(){return this._emitter.eventNames()},EventHandler.prototype.subscribe=function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if("function"!=typeof t)throw new Error("invalid argument callback");this._emitter.hasListeners(e)||(this._ackTimeoutRegistry.add({topic:C.TOPIC.EVENT,action:C.ACTIONS.SUBSCRIBE,name:e}),this._connection.sendMsg(C.TOPIC.EVENT,C.ACTIONS.SUBSCRIBE,[e])),this._emitter.on(e,t)},EventHandler.prototype.unsubscribe=function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(void 0!==t&&"function"!=typeof t)throw new Error("invalid argument callback");this._emitter.off(e,t),this._emitter.hasListeners(e)||(this._ackTimeoutRegistry.add({topic:C.TOPIC.EVENT,action:C.ACTIONS.UNSUBSCRIBE,name:e}),this._connection.sendMsg(C.TOPIC.EVENT,C.ACTIONS.UNSUBSCRIBE,[e]))},EventHandler.prototype.emit=function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");this._connection.sendMsg(C.TOPIC.EVENT,C.ACTIONS.EVENT,[e,messageBuilder.typed(t)]),this._emitter.emit(e,t)},EventHandler.prototype.listen=function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument pattern");if("function"!=typeof t)throw new Error("invalid argument callback");!this._listener[e]||this._listener[e].destroyPending?(this._listener[e]&&this._listener[e].destroy(),this._listener[e]=new Listener(C.TOPIC.EVENT,e,t,this._options,this._client,this._connection)):this._client._$onError(C.TOPIC.EVENT,C.EVENT.LISTENER_EXISTS,e)},EventHandler.prototype.unlisten=function(e){if("string"!=typeof e||0===e.length)throw new Error("invalid argument pattern");var t=this._listener[e];t&&!t.destroyPending?t.sendDestroy():this._listener[e]?(this._ackTimeoutRegistry.add({topic:C.TOPIC.EVENT,action:C.EVENT.UNLISTEN,name:e}),this._listener[e].destroy(),delete this._listener[e]):this._client._$onError(C.TOPIC.RECORD,C.EVENT.NOT_LISTENING,e)},EventHandler.prototype._$handle=function(e){var t=e.data[e.action===C.ACTIONS.ACK?1:0];if(e.action!==C.ACTIONS.EVENT){if(e.action===C.ACTIONS.ACK&&e.data[0]===C.ACTIONS.UNLISTEN&&this._listener[t]&&this._listener[t].destroyPending)return this._listener[t].destroy(),void delete this._listener[t];if(this._listener[t])this._listener[t]._$onMessage(e);else if(e.action!==C.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED&&e.action!==C.ACTIONS.SUBSCRIPTION_HAS_PROVIDER){if(e.action!==C.ACTIONS.ACK)return e.action===C.ACTIONS.ERROR?(e.data[0]===C.EVENT.MESSAGE_DENIED?this._ackTimeoutRegistry.remove({topic:C.TOPIC.EVENT,name:e.data[1],action:e.data[2]}):e.data[0]===C.EVENT.NOT_SUBSCRIBED&&this._ackTimeoutRegistry.remove({topic:C.TOPIC.EVENT,name:e.data[1],action:C.ACTIONS.UNSUBSCRIBE}),e.processedError=!0,void this._client._$onError(C.TOPIC.EVENT,e.data[0],e.data[1])):void this._client._$onError(C.TOPIC.EVENT,C.EVENT.UNSOLICITED_MESSAGE,t);this._ackTimeoutRegistry.clear(e)}}else e.data&&2===e.data.length?this._emitter.emit(t,messageParser.convertTyped(e.data[1],this._client)):this._emitter.emit(t)},EventHandler.prototype._resubscribe=function(){var e=this._emitter._callbacks;for(var t in e)this._connection.sendMsg(C.TOPIC.EVENT,C.ACTIONS.SUBSCRIBE,[t])},module.exports=EventHandler;