"use strict";var EventEmitter=require("component-emitter2"),Record=require("./record"),C=require("../constants/constants"),ENTRY_ADDED_EVENT="entry-added",ENTRY_REMOVED_EVENT="entry-removed",ENTRY_MOVED_EVENT="entry-moved",List=function(t,e,r){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");this._recordHandler=t,this._record=this._recordHandler.getRecord(e,r),this._record._applyUpdate=this._applyUpdate.bind(this),this._record.on("delete",this.emit.bind(this,"delete")),this._record.on("discard",this._onDiscard.bind(this)),this._record.on("ready",this._onReady.bind(this)),this.isDestroyed=this._record.isDestroyed,this.isReady=this._record.isReady,this.name=e,this._queuedMethods=[],this._beforeStructure=null,this._hasAddListener=null,this._hasRemoveListener=null,this._hasMoveListener=null,this.delete=this._record.delete.bind(this._record),this.discard=this._record.discard.bind(this._record),this.whenReady=this._record.whenReady.bind(this)};EventEmitter(List.prototype),List.prototype.getEntries=function(){var t=this._record.get();return t instanceof Array?t:[]},List.prototype.isEmpty=function(){return 0===this.getEntries().length},List.prototype.setEntries=function(t,e){var r="entries must be an array of record names",i=void 0;if(!(t instanceof Array))throw new Error(r);for(i=0;i<t.length;i++)if("string"!=typeof t[i])throw new Error(r);!1===this._record.isReady?this._queuedMethods.push(this.setEntries.bind(this,t,e)):(this._beforeChange(),e?this._record.set(t,e):this._record.set(t),this._afterChange())},List.prototype.setEntriesWithAck=function(t,e){var i=this;return e?this.setEntries(t,e):new Promise(function(e,r){i.setEntries(t,function(t){return null===t?e():r(t)})})},List.prototype.removeEntry=function(t,e,r){var i=e,s=r;if("function"==typeof e&&(s=e,i=void 0),!1!==this._record.isReady){var o=this._record.get(),n=this._hasIndex(i),h=[],d=void 0;for(d=0;d<o.length;d++)(o[d]!==t||n&&i!==d)&&h.push(o[d]);this._beforeChange(),s?this._record.set(h,s):this._record.set(h),this._afterChange()}else this._queuedMethods.push(this.removeEntry.bind(this,t,i,s))},List.prototype.removeEntryWithAck=function(t,i,e){var s=this;return"number"==typeof i&&e?this.removeEntry(t,i,e):"function"==typeof i?this.removeEntry(t,i):new Promise(function(e,r){s.removeEntry(t,i,function(t){return null===t?e():r(t)})})},List.prototype.addEntry=function(t,e,r){if("string"!=typeof t)throw new Error("Entry must be a recordName");var i=e,s=r;if("function"==typeof e&&(s=e,i=void 0),!1!==this._record.isReady){var o=this._hasIndex(i),n=this.getEntries();o?n.splice(i,0,t):n.push(t),this._beforeChange(),s?this._record.set(n,s):this._record.set(n),this._afterChange()}else this._queuedMethods.push(this.addEntry.bind(this,t,i,s))},List.prototype.addEntryWithAck=function(t,i,e){var s=this;return"number"==typeof i&&e?this.addEntry(t,i,e):"function"==typeof i?this.addEntry(t,i):new Promise(function(e,r){s.addEntry(t,i,function(t){return null===t?e():r(t)})})},List.prototype.subscribe=function(){var t=Record.prototype._normalizeArguments(arguments);if(t.path)throw new Error("path is not supported for List.subscribe");var e=function(t){t(this.getEntries())}.bind(this,t.callback);t.callback.wrappedCallback=e,t.callback=e,this._record.subscribe(t)},List.prototype.unsubscribe=function(){var t=Record.prototype._normalizeArguments(arguments);if(t.path)throw new Error("path is not supported for List.unsubscribe");t.callback=t.callback.wrappedCallback,this._record.unsubscribe(t)},List.prototype._onReady=function(){this.isReady=!0;for(var t=0;t<this._queuedMethods.length;t++)this._queuedMethods[t]();this._queuedMethods=[],this.emit("ready")},List.prototype._onDiscard=function(){this.isDestroyed=!0,this.emit("discard")},List.prototype._applyUpdate=function(t){if(t.action===C.ACTIONS.PATCH)throw new Error("PATCH is not supported for Lists");"["!==t.data[2].charAt(0)&&(t.data[2]="[]"),this._beforeChange(),Record.prototype._applyUpdate.call(this._record,t),this._afterChange()},List.prototype._hasIndex=function(t){var e=!1,r=this.getEntries();if(void 0!==t){if(isNaN(t))throw new Error("Index must be a number");if(t!==r.length&&(t>=r.length||t<0))throw new Error("Index must be within current entries");e=!0}return e},List.prototype._beforeChange=function(){this._hasAddListener=0<this.listeners(ENTRY_ADDED_EVENT).length,this._hasRemoveListener=0<this.listeners(ENTRY_REMOVED_EVENT).length,this._hasMoveListener=0<this.listeners(ENTRY_MOVED_EVENT).length,this._hasAddListener||this._hasRemoveListener||this._hasMoveListener?this._beforeStructure=this._getStructure():this._beforeStructure=null},List.prototype._afterChange=function(){if(null!==this._beforeStructure){var t=this._getStructure(),e=this._beforeStructure,r=void 0,i=void 0;if(this._hasRemoveListener)for(r in e)for(i=0;i<e[r].length;i++)void 0!==t[r]&&void 0!==t[r][i]||this.emit(ENTRY_REMOVED_EVENT,r,e[r][i]);if(this._hasAddListener||this._hasMoveListener)for(r in t)if(void 0===e[r])for(i=0;i<t[r].length;i++)this.emit(ENTRY_ADDED_EVENT,r,t[r][i]);else for(i=0;i<t[r].length;i++)e[r][i]!==t[r][i]&&(void 0===e[r][i]?this.emit(ENTRY_ADDED_EVENT,r,t[r][i]):this.emit(ENTRY_MOVED_EVENT,r,t[r][i]))}},List.prototype._getStructure=function(){var t={},e=void 0,r=this._record.get();for(e=0;e<r.length;e++)void 0===t[r[e]]?t[r[e]]=[e]:t[r[e]].push(e);return t},module.exports=List;