"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Record=require("./record"),AnonymousRecord=require("./anonymous-record"),List=require("./list"),Listener=require("../utils/listener"),SingleNotifier=require("../utils/single-notifier"),C=require("../constants/constants"),messageParser=require("../message/message-parser"),messageBuilder=require("../message/message-builder"),EventEmitter=require("component-emitter2"),RecordHandler=function(e,t,r){this._options=e,this._connection=t,this._client=r,this._records={},this._lists={},this._listener={},this._writeCallbacks={},this._destroyEventEmitter=new EventEmitter,this._hasRegistry=new SingleNotifier(r,t,C.TOPIC.RECORD,C.ACTIONS.HAS,this._options.recordReadTimeout),this._snapshotRegistry=new SingleNotifier(r,t,C.TOPIC.RECORD,C.ACTIONS.SNAPSHOT,this._options.recordReadTimeout),this._headRegistry=new SingleNotifier(r,t,C.TOPIC.RECORD,C.ACTIONS.HEAD,this._options.recordReadTimeout)};RecordHandler.prototype.recordNames=function(){return Object.keys(this._records)},RecordHandler.prototype.getRecord=function(e,t){return this._records[e]||(this._records[e]=new Record(e,t||{},this._connection,this._options,this._client),this._records[e].on("error",this._onRecordError.bind(this,e)),this._records[e].on("destroyPending",this._onDestroyPending.bind(this,e)),this._records[e].on("delete",this._removeRecord.bind(this,e)),this._records[e].on("discard",this._removeRecord.bind(this,e))),this._records[e].usages++,this._records[e]},RecordHandler.prototype.getList=function(e,t){return this._lists[e]?this._records[e].usages++:this._lists[e]=new List(this,e,t),this._lists[e]},RecordHandler.prototype.getAnonymousRecord=function(){return new AnonymousRecord(this)},RecordHandler.prototype.listen=function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument pattern");if("function"!=typeof t)throw new Error("invalid argument callback");!this._listener[e]||this._listener[e].destroyPending?(this._listener[e]&&this._listener[e].destroy(),this._listener[e]=new Listener(C.TOPIC.RECORD,e,t,this._options,this._client,this._connection)):this._client._$onError(C.TOPIC.RECORD,C.EVENT.LISTENER_EXISTS,e)},RecordHandler.prototype.unlisten=function(e){if("string"!=typeof e||0===e.length)throw new Error("invalid argument pattern");var t=this._listener[e];t&&!t.destroyPending?t.sendDestroy():this._listener[e]?(this._listener[e].destroy(),delete this._listener[e]):this._client._$onError(C.TOPIC.RECORD,C.EVENT.NOT_LISTENING,e)},RecordHandler.prototype.snapshot=function(r,e){var i=this;if("string"!=typeof r||0===r.length)throw new Error("invalid argument: name");var t=this._records[r];return t&&t.isReady?e?void e(null,t.get()):Promise.resolve(t.get()):e?void this._snapshotRegistry.request(r,{callback:e}):new Promise(function(e,t){i._snapshotRegistry.request(r,{resolve:e,reject:t})})},RecordHandler.prototype.has=function(r,e){var i=this;if("string"!=typeof r||0===r.length)throw new Error("invalid argument: name");return this._records[r]?e?void e(null,!0):Promise.resolve(!0):e?void this._hasRegistry.request(r,{callback:e}):new Promise(function(e,t){i._hasRegistry.request(r,{resolve:e,reject:t})})},RecordHandler.prototype.head=function(r,e){var i=this;if("string"!=typeof r||0===r.length)throw new Error("invalid argument: name");var t=this._records[r];return t&&t.isReady?e?void e(null,t.version):Promise.resolve(t.version):e?void this._headRegistry.request(r,{callback:e}):new Promise(function(e,t){i._headRegistry.request(r,{resolve:e,reject:t})})},RecordHandler.prototype.setDataWithAck=function(e,i,s,t){var o=this;if(s&&t)this.setData(e,i,s,t);else{if("object"!==(void 0===i?"undefined":_typeof(i))||!s)return i&&s?new Promise(function(t,r){o.setData(e,i,s,function(e){return null===e?t():r(e)})}):new Promise(function(t,r){o.setData(e,i,function(e){return null===e?t():r(e)})});this.setData(e,i,s)}},RecordHandler.prototype.setData=function(e,t,r,i){var s=void 0,o=void 0,n=void 0;if(4===arguments.length?(s=t,o=r,n=i):3===arguments.length?"function"!=typeof r?(s=t,o=r):(s=null,o=t,n=r):2===arguments.length&&(o=t),"string"!=typeof e||0===e.length)throw new Error("invalid argument: recordName");if(i&&"function"!=typeof i)throw new Error("invalid argument: callback");if(s&&("string"!=typeof s||0===s.length))throw new Error("invalid argument: path");if(!s&&(null===o||"object"!==(void 0===o?"undefined":_typeof(o))))throw new Error("invalid argument: data must be an object when no path is provided");var a=this._records[e];if(a)s&&n?a.set(s,o,n):s?a.set(s,o):n?a.set(o,n):a.set(o);else{var d=s?[e,-1,s,messageBuilder.typed(o)]:[e,-1,o],c={};n&&(c.writeSuccess=!0,this._writeCallbacks[e]={},this._writeCallbacks[e][-1]=n),d.push(c),this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.CREATEANDUPDATE,d)}},RecordHandler.prototype._$handle=function(e){var t=void 0;if(e.action===C.ACTIONS.ERROR&&e.data[0]!==C.EVENT.VERSION_EXISTS&&e.data[0]!==C.ACTIONS.SNAPSHOT&&e.data[0]!==C.ACTIONS.HAS&&e.data[0]!==C.ACTIONS.HEAD&&e.data[0]!==C.EVENT.MESSAGE_DENIED)return e.processedError=!0,void this._client._$onError(C.TOPIC.RECORD,e.data[0],e.data[1]);if(e.action===C.ACTIONS.ACK||e.action===C.ACTIONS.ERROR){if(t=e.data[1],e.data[0]===C.ACTIONS.DELETE||e.data[0]===C.ACTIONS.UNSUBSCRIBE||e.data[0]===C.EVENT.MESSAGE_DENIED&&e.data[2]===C.ACTIONS.DELETE)return this._destroyEventEmitter.emit("destroy_ack_"+t,e),void(e.data[0]===C.ACTIONS.DELETE&&this._records[t]&&this._records[t]._$onMessage(e));if(e.data[0]===C.ACTIONS.SNAPSHOT)return e.processedError=!0,void this._snapshotRegistry.recieve(t,e.data[2]);if(e.data[0]===C.ACTIONS.HAS)return e.processedError=!0,void this._hasRegistry.recieve(t,e.data[2]);if(e.data[0]===C.ACTIONS.HEAD)return e.processedError=!0,void this._headRegistry.recieve(t,e.data[2])}else t=e.data[0];var r=!1,i=this._records[t];if(i&&(r=!0,i._$onMessage(e)),e.action===C.ACTIONS.READ&&this._snapshotRegistry.hasRequest(t)?(r=!0,this._snapshotRegistry.recieve(t,null,JSON.parse(e.data[2]))):e.action===C.ACTIONS.HAS&&this._hasRegistry.hasRequest(t)?(r=!0,this._hasRegistry.recieve(t,null,messageParser.convertTyped(e.data[1],this._client))):e.action===C.ACTIONS.HEAD&&this._headRegistry.hasRequest(t)?(r=!0,this._headRegistry.recieve(t,null,Number(e.data[1]))):e.action!==C.ACTIONS.WRITE_ACKNOWLEDGEMENT||i?e.action===C.ACTIONS.ACK&&e.data[0]===C.ACTIONS.UNLISTEN&&this._listener[t]&&this._listener[t].destroyPending?(r=!0,this._listener[t].destroy(),delete this._listener[t]):this._listener[t]?(r=!0,this._listener[t]._$onMessage(e)):e.action===C.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED?r=!0:e.action===C.ACTIONS.SUBSCRIPTION_HAS_PROVIDER&&(r=!0):(r=!0,Record._handleWriteAcknowledgements(e,this._writeCallbacks[t],this._client)),e.action===C.ACTIONS.ERROR&&e.data[0]===C.EVENT.MESSAGE_DENIED)return e.processedError=!0,void this._client._$onError(C.TOPIC.RECORD,e.data[0],e.data[1]);r||(e.processedError=!0,this._client._$onError(C.TOPIC.RECORD,C.EVENT.UNSOLICITED_MESSAGE,t))},RecordHandler.prototype._onRecordError=function(e,t){this._client._$onError(C.TOPIC.RECORD,t,e)},RecordHandler.prototype._onDestroyPending=function(e){if(this._records[e]){var t=this._records[e]._$onMessage.bind(this._records[e]);this._destroyEventEmitter.once("destroy_ack_"+e,t),this._removeRecord(e)}else this._client._$onError(C.TOPIC.RECORD,"Record attempted to be destroyed but does not exists",e)},RecordHandler.prototype._removeRecord=function(e){delete this._records[e],delete this._lists[e]},module.exports=RecordHandler;