"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},jsonPath=require("./json-path"),ResubscribeNotifier=require("../utils/resubscribe-notifier"),EventEmitter=require("component-emitter2"),C=require("../constants/constants"),messageBuilder=require("../message/message-builder"),messageParser=require("../message/message-parser"),utils=require("../utils/utils"),Record=function(e,t,i,s,o){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");this.name=e,this.usages=0,this._recordOptions=t,this._connection=i,this._client=o,this._options=s,this.isReady=!1,this.isDestroyed=!1,this.hasProvider=!1,this._$data=Object.create(null),this.version=null,this._eventEmitter=new EventEmitter,this._queuedMethodCalls=[],this._writeCallbacks={},this._mergeStrategy=null,s.mergeStrategy&&this.setMergeStrategy(s.mergeStrategy),this._ackTimeoutRegistry=o._$getAckTimeoutRegistry(),this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._sendRead.bind(this)),this._readAckTimeout=this._ackTimeoutRegistry.add({topic:C.TOPIC.RECORD,name:e,action:C.ACTIONS.SUBSCRIBE,timeout:this._options.recordReadAckTimeout}),this._responseTimeout=this._ackTimeoutRegistry.add({topic:C.TOPIC.RECORD,name:e,action:C.ACTIONS.READ,event:C.EVENT.RESPONSE_TIMEOUT,timeout:this._options.recordReadTimeout}),this._sendRead()};EventEmitter(Record.prototype),Record.prototype.setMergeStrategy=function(e){if("function"!=typeof e)throw new Error("Invalid merge strategy: Must be a Function");this._mergeStrategy=e},Record.prototype.get=function(e){return jsonPath.get(this._$data,e,this._options.recordDeepCopy)},Record.prototype.setWithAck=function(e,s,t){var o=this;if(e&&s&&t)this.set(e,s,t);else{if(!e||"function"!=typeof s)return e&&"object"===(void 0===s?"undefined":_typeof(s))?new Promise(function(t,i){o.set(e,s,function(e){return null===e?t():i(e)})}):new Promise(function(t,i){o.set(e,function(e){return null===e?t():i(e)})});this.set(e,s)}},Record.prototype.set=function(e,t,i){var s=void 0,o=void 0;if(1===arguments.length){if("object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("invalid argument data");o=e}else if(2===arguments.length)if("string"==typeof e&&0!==e.length&&"function"!=typeof t)s=e,o=t;else{if("object"!==(void 0===e?"undefined":_typeof(e))||"function"!=typeof t)throw new Error("invalid argument path");o=e,i=t}else if(3===arguments.length){if("string"!=typeof e||0===e.length||"function"!=typeof i)throw new Error("invalid arguments, must pass in a string, a value and a function");s=e,o=t}if(!s&&(null===o||"object"!==(void 0===o?"undefined":_typeof(o))))throw new Error("invalid arguments, scalar values cannot be set without path");if(this._checkDestroyed("set"))return this;if(!this.isReady)return this._queuedMethodCalls.push({method:"set",args:arguments}),this;var r=this._$data,n=jsonPath.set(r,s,o,this._options.recordDeepCopy);if(r===n){if("function"==typeof i){var a=null;utils.isConnected(this._client)||(a="Connection error: error updating record as connection was closed"),utils.requestIdleCallback(function(){return i(a)})}return this}var c=void 0;return"function"==typeof i&&(c={writeSuccess:!0},utils.isConnected(this._client)?this._setUpCallback(this.version,i):utils.requestIdleCallback(function(){return i("Connection error: error updating record as connection was closed")})),this._sendUpdate(s,o,c),this._applyChange(n),this},Record.prototype.subscribe=function(e,t,i){var s=this,o=this._normalizeArguments(arguments);if(void 0!==o.path&&("string"!=typeof o.path||0===o.path.length))throw new Error("invalid argument path");if("function"!=typeof o.callback)throw new Error("invalid argument callback");this._checkDestroyed("subscribe")||(o.triggerNow?this.whenReady(function(){s._eventEmitter.on(o.path,o.callback),o.callback(s.get(o.path))}):this._eventEmitter.on(o.path,o.callback))},Record.prototype.unsubscribe=function(e,t){var i=this._normalizeArguments(arguments);if(void 0!==i.path&&("string"!=typeof i.path||0===i.path.length))throw new Error("invalid argument path");if(void 0!==i.callback&&"function"!=typeof i.callback)throw new Error("invalid argument callback");this._checkDestroyed("unsubscribe")||this._eventEmitter.off(i.path,i.callback)},Record.prototype.discard=function(){var e=this;this._checkDestroyed("discard")||this.whenReady(function(){e.usages--,e.usages<=0&&(e.emit("destroyPending"),e._discardTimeout=e._ackTimeoutRegistry.add({topic:C.TOPIC.RECORD,name:e.name,action:C.ACTIONS.UNSUBSCRIBE}),e._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.UNSUBSCRIBE,[e.name]))})},Record.prototype.delete=function(){var e=this;this._checkDestroyed("delete")||this.whenReady(function(){e.emit("destroyPending"),e._deleteAckTimeout=e._ackTimeoutRegistry.add({topic:C.TOPIC.RECORD,name:e.name,action:C.ACTIONS.DELETE,event:C.EVENT.DELETE_TIMEOUT,timeout:e._options.recordDeleteTimeout}),e._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.DELETE,[e.name])})},Record.prototype.whenReady=function(e){var t=this;return!0===this.isReady?e?void e(this):Promise.resolve(this):e?void this.once("ready",e.bind(this,this)):new Promise(function(e){return t.once("ready",e.bind(t,t))})},Record.prototype._$onMessage=function(e){if(e.action===C.ACTIONS.READ)null===this.version?(this._ackTimeoutRegistry.clear(e),this._onRead(e)):this._applyUpdate(e,this._client);else if(e.action===C.ACTIONS.ACK)this._processAckMessage(e);else if(e.action===C.ACTIONS.UPDATE||e.action===C.ACTIONS.PATCH)this._applyUpdate(e,this._client);else if(e.action===C.ACTIONS.WRITE_ACKNOWLEDGEMENT)Record._handleWriteAcknowledgements(e,this._writeCallbacks,this._client);else if(e.data[0]===C.EVENT.VERSION_EXISTS)this._recoverRecord(e.data[2],JSON.parse(e.data[3]),e);else if(e.data[0]===C.EVENT.MESSAGE_DENIED)this._clearTimeouts();else if(e.action===C.ACTIONS.SUBSCRIPTION_HAS_PROVIDER){var t=messageParser.convertTyped(e.data[1],this._client);this.hasProvider=t,this.emit("hasProviderChanged",t)}},Record._handleWriteAcknowledgements=function(e,t,i){for(var s=JSON.parse(e.data[1]),o=0;o<s.length;o++){var r=t[s[o]];void 0!==r&&(r(messageParser.convertTyped(e.data[2],i)),delete t[s[o]])}},Record.prototype._recoverRecord=function(e,t,i){i.processedError=!0,this._mergeStrategy?this._mergeStrategy(this,t,e,this._onRecordRecovered.bind(this,e,t,i)):this.emit("error",C.EVENT.VERSION_EXISTS,"received update for "+e+" but version is "+this.version)},Record.prototype._sendUpdate=function(e,t,i){this.version++;var s=void 0;e?(s=void 0===i?[this.name,this.version,e,messageBuilder.typed(t)]:[this.name,this.version,e,messageBuilder.typed(t),i],this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.PATCH,s)):(s=void 0===i?[this.name,this.version,t]:[this.name,this.version,t,i],this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.UPDATE,s))},Record.prototype._onRecordRecovered=function(e,t,i,s,o){if(s)this.emit("error",C.EVENT.VERSION_EXISTS,"received update for "+e+" but version is "+this.version);else{var r=this.version;this.version=e;var n=this._$data;if(utils.deepEquals(n,t))return;var a=jsonPath.set(n,void 0,o,!1);if(utils.deepEquals(o,t)){this._applyChange(o);var c=this._writeCallbacks[e];return void(void 0!==c&&(c(null),delete this._writeCallbacks[e]))}var d=i.data[4];if(d&&JSON.parse(d).writeSuccess){var h=this._writeCallbacks[r];delete this._writeCallbacks[r],this._setUpCallback(this.version,h)}this._sendUpdate(void 0,o,d),this._applyChange(a)}},Record.prototype._processAckMessage=function(e){var t=e.data[0];t===C.ACTIONS.SUBSCRIBE?this._ackTimeoutRegistry.clear(e):t===C.ACTIONS.DELETE?(this.emit("delete"),this._destroy()):t===C.ACTIONS.UNSUBSCRIBE&&(this.emit("discard"),this._destroy())},Record.prototype._applyUpdate=function(e){var t=parseInt(e.data[1],10),i=void 0;if(i=e.action===C.ACTIONS.PATCH?messageParser.convertTyped(e.data[3],this._client):JSON.parse(e.data[2]),null===this.version)this.version=t;else if(this.version+1!==t)return void(e.action===C.ACTIONS.PATCH?this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.SNAPSHOT,[this.name]):this._recoverRecord(t,i,e));this.version=t,this._applyChange(jsonPath.set(this._$data,e.action===C.ACTIONS.PATCH?e.data[2]:void 0,i))},Record.prototype._onRead=function(e){this.version=parseInt(e.data[1],10),this._applyChange(jsonPath.set(this._$data,void 0,JSON.parse(e.data[2]))),this._setReady()},Record.prototype._setReady=function(){this.isReady=!0;for(var e=0;e<this._queuedMethodCalls.length;e++)this[this._queuedMethodCalls[e].method].apply(this,this._queuedMethodCalls[e].args);this._queuedMethodCalls=[],this.emit("ready")},Record.prototype._setUpCallback=function(e,t){var i=Number(this.version)+1;this._writeCallbacks[i]=t},Record.prototype._sendRead=function(){this._connection.sendMsg(C.TOPIC.RECORD,C.ACTIONS.CREATEORREAD,[this.name])},Record.prototype._applyChange=function(e){if(!this.isDestroyed){var t=this._$data;this._$data=e;for(var i=this._eventEmitter.eventNames(),s=0;s<i.length;s++){jsonPath.get(e,i[s],!1)!==jsonPath.get(t,i[s],!1)&&this._eventEmitter.emit(i[s],this.get(i[s]))}}},Record.prototype._normalizeArguments=function(e){if(1===e.length&&"object"===_typeof(e[0]))return e[0];for(var t=Object.create(null),i=0;i<e.length;i++)"string"==typeof e[i]?t.path=e[i]:"function"==typeof e[i]?t.callback=e[i]:"boolean"==typeof e[i]&&(t.triggerNow=e[i]);return t},Record.prototype._clearTimeouts=function(){this._ackTimeoutRegistry.remove({ackId:this._readAckTimeout,silent:!0}),this._ackTimeoutRegistry.remove({ackId:this._responseTimeout,silent:!0}),this._ackTimeoutRegistry.remove({ackId:this._deleteAckTimeout,silent:!0}),this._ackTimeoutRegistry.remove({ackId:this._discardTimeout,silent:!0})},Record.prototype._checkDestroyed=function(e){return!!this.isDestroyed&&(this.emit("error","Can't invoke '"+e+"'. Record '"+this.name+"' is already destroyed"),!0)},Record.prototype._destroy=function(){this._clearTimeouts(),this._eventEmitter.off(),this._resubscribeNotifier.destroy(),this.isDestroyed=!0,this.isReady=!1,this._client=null,this._eventEmitter=null,this._connection=null},module.exports=Record;