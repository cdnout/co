"use strict";var C=require("../constants/constants"),EventEmitter=require("component-emitter2"),AckTimeoutRegistry=function(t,e){this._options=e,this._client=t,this._register={},this._counter=1,t.on("connectionStateChanged",this._onConnectionStateChanged.bind(this))};EventEmitter(AckTimeoutRegistry.prototype),AckTimeoutRegistry.prototype.add=function(t){var e=t.timeout||this._options.subscriptionTimeout;return this._client.getConnectionState()!==C.CONNECTION_STATE.OPEN||e<1?-1:(this.remove(t),t.ackId=this._counter++,t.event=t.event||C.EVENT.ACK_TIMEOUT,t.__timeout=setTimeout(this._onTimeout.bind(this,t),e),(this._register[this._getUniqueName(t)]=t).ackId)},AckTimeoutRegistry.prototype.remove=function(t){if(t.ackId)for(var e in this._register)t.ackId===this._register[e].ackId&&this.clear({topic:this._register[e].topic,action:this._register[e].action,data:[this._register[e].name]});this._register[this._getUniqueName(t)]&&this.clear({topic:t.topic,action:t.action,data:[t.name]})},AckTimeoutRegistry.prototype.clear=function(t){var e=void 0;e=t.action===C.ACTIONS.ACK&&1<t.data.length?t.topic+t.data[0]+(t.data[1]?t.data[1]:""):t.topic+t.action+t.data[0],this._register[e]&&clearTimeout(this._register[e].__timeout),delete this._register[e]},AckTimeoutRegistry.prototype._onTimeout=function(t){if(delete this._register[this._getUniqueName(t)],t.callback)delete t.__timeout,delete t.timeout,t.callback(t);else{var e="No ACK message received in time"+(t.name?" for "+t.name:"");this._client._$onError(t.topic,t.event,e)}},AckTimeoutRegistry.prototype._getUniqueName=function(t){return t.topic+t.action+(t.name?t.name:"")},AckTimeoutRegistry.prototype._onConnectionStateChanged=function(t){if(t!==C.CONNECTION_STATE.OPEN)for(var e in this._register)clearTimeout(this._register[e].__timeout)},module.exports=AckTimeoutRegistry;