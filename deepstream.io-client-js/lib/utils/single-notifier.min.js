"use strict";var C=require("../constants/constants"),ResubscribeNotifier=require("./resubscribe-notifier"),SingleNotifier=function(e,t,i,s,o){this._client=e,this._connection=t,this._topic=i,this._action=s,this._timeoutDuration=o,this._requests={},this._ackTimeoutRegistry=e._$getAckTimeoutRegistry(),this._resubscribeNotifier=new ResubscribeNotifier(this._client,this._resendRequests.bind(this)),this._onResponseTimeout=this._onResponseTimeout.bind(this)};SingleNotifier.prototype.hasRequest=function(e){return!!this._requests[e]},SingleNotifier.prototype.request=function(e,t){this._requests[e]||(this._requests[e]=[],this._connection.sendMsg(this._topic,this._action,[e]));var i=this._ackTimeoutRegistry.add({topic:this._topic,event:C.EVENT.RESPONSE_TIMEOUT,name:e,action:this._action,timeout:this._timeoutDuration,callback:this._onResponseTimeout});this._requests[e].push({response:t,ackId:i})},SingleNotifier.prototype.recieve=function(e,t,i){var s=this._requests[e];if(s){for(var o=0;o<s.length;o++){var n=s[o];this._ackTimeoutRegistry.remove({ackId:n.ackId}),n.response.callback?n.response.callback(t,i):t?n.response.reject(i):n.response.resolve(i)}delete this._requests[e]}else this._client._$onError(this._topic,C.EVENT.UNSOLICITED_MESSAGE,"no entry for "+e)},SingleNotifier.prototype._onResponseTimeout=function(e){var t="No response received in time for "+this._topic+"|"+this._action+"|"+e.name;this._client._$onError(this._topic,C.EVENT.RESPONSE_TIMEOUT,t)},SingleNotifier.prototype._resendRequests=function(){for(var e in this._requests)this._connection.sendMsg(this._topic,this._action,[e])},module.exports=SingleNotifier;