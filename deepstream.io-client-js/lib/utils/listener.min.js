"use strict";var C=require("../constants/constants"),ResubscribeNotifier=require("./resubscribe-notifier"),Listener=function(t,i,e,s,n,o){this._topic=t,this._callback=e,this._pattern=i,this._options=s,this._client=n,this._connection=o,this._ackTimeoutRegistry=n._$getAckTimeoutRegistry(),this._ackTimeoutRegistry.add({topic:this._topic,name:i,action:C.ACTIONS.LISTEN}),this._resubscribeNotifier=new ResubscribeNotifier(n,this._sendListen.bind(this)),this._sendListen(),this.destroyPending=!1};Listener.prototype.sendDestroy=function(){this.destroyPending=!0,this._connection.sendMsg(this._topic,C.ACTIONS.UNLISTEN,[this._pattern]),this._resubscribeNotifier.destroy()},Listener.prototype.destroy=function(){this._callback=null,this._pattern=null,this._client=null,this._connection=null},Listener.prototype.accept=function(t){this._connection.sendMsg(this._topic,C.ACTIONS.LISTEN_ACCEPT,[this._pattern,t])},Listener.prototype.reject=function(t){this._connection.sendMsg(this._topic,C.ACTIONS.LISTEN_REJECT,[this._pattern,t])},Listener.prototype._createCallbackResponse=function(t){return{accept:this.accept.bind(this,t.data[1]),reject:this.reject.bind(this,t.data[1])}},Listener.prototype._$onMessage=function(t){t.action===C.ACTIONS.ACK?this._ackTimeoutRegistry.clear(t):t.action===C.ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND?this._callback(t.data[1],!0,this._createCallbackResponse(t)):t.action===C.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED?this._callback(t.data[1],!1):this._client._$onError(this._topic,C.EVENT.UNSOLICITED_MESSAGE,t.data[0]+"|"+t.data[1])},Listener.prototype._sendListen=function(){this._connection.sendMsg(this._topic,C.ACTIONS.LISTEN,[this._pattern])},module.exports=Listener;