!function(t,e){if("function"==typeof define&&define.amd)define(["backbone"],e);else{if("function"==typeof require&&null!=("undefined"!=typeof module&&null!==module?module.exports:void 0))return module.exports=e(require("backbone"));e(t.Backbone)}}(this,function(t){var e,r,o,n,i,s,a,u,c,l=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};t.DualStorage={offlineStatusCodes:[408,502]},t.Model.prototype.hasTempId=function(){return _.isString(this.id)&&36===this.id.length&&0===this.id.indexOf("t")},i=function(t,e){return e||(e=t.model.prototype),_.result(t,"storeName")||_.result(e,"storeName")||_.result(t,"url")||_.result(e,"urlRoot")||_.result(e,"url")},t.Collection.prototype.syncDirty=function(t){var e,r,o,n,s,a,u;for(u=localStorage.getItem(i(this)+"_dirty"),o=u&&u.split(",")||[],a=[],e=0,n=o.length;n>e;e++)r=o[e],a.push(null!=(s=this.get(r))?s.save(null,t):void 0);return a},t.Collection.prototype.dirtyModels=function(){var t,e,r,o;return o=localStorage.getItem(i(this)+"_dirty"),e=o&&o.split(",")||[],r=function(){var r,o,n;for(n=[],r=0,o=e.length;o>r;r++)t=e[r],n.push(this.get(t));return n}.call(this),_.compact(r)},t.Collection.prototype.syncDestroyed=function(t){var e,r,o,n,s,a,u;for(u=localStorage.getItem(i(this)+"_destroyed"),o=u&&u.split(",")||[],a=[],e=0,n=o.length;n>e;e++)r=o[e],s=new this.model,s.set(s.idAttribute,r),s.collection=this,a.push(s.destroy(t));return a},t.Collection.prototype.destroyedModelIds=function(){var t,e;return e=localStorage.getItem(i(this)+"_destroyed"),t=e&&e.split(",")||[]},t.Collection.prototype.syncDirtyAndDestroyed=function(t){return this.syncDirty(t),this.syncDestroyed(t)},e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},window.Store=function(){function t(t){this.name=t,this.records=this.recordsOn(this.name)}return t.prototype.sep="",t.prototype.generateId=function(){return"t"+e().substring(1)+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t.prototype.save=function(){return localStorage.setItem(this.name,this.records.join(","))},t.prototype.recordsOn=function(t){var e;return e=localStorage.getItem(t),e&&e.split(",")||[]},t.prototype.dirty=function(t){var e;return e=this.recordsOn(this.name+"_dirty"),_.include(e,t.id.toString())||(e.push(t.id),localStorage.setItem(this.name+"_dirty",e.join(","))),t},t.prototype.clean=function(t,e){var r,o;return o=this.name+"_"+e,r=this.recordsOn(o),_.include(r,t.id.toString())&&localStorage.setItem(o,_.without(r,t.id.toString()).join(",")),t},t.prototype.destroyed=function(t){var e;return e=this.recordsOn(this.name+"_destroyed"),_.include(e,t.id.toString())||(e.push(t.id),localStorage.setItem(this.name+"_destroyed",e.join(","))),t},t.prototype.create=function(t,e){return _.isObject(t)?(t.id||t.set(t.idAttribute,this.generateId()),localStorage.setItem(this.name+this.sep+t.id,JSON.stringify(t.toJSON?t.toJSON(e):t)),this.records.push(t.id.toString()),this.save(),t):t},t.prototype.update=function(t,e){return localStorage.setItem(this.name+this.sep+t.id,JSON.stringify(t.toJSON?t.toJSON(e):t)),_.include(this.records,t.id.toString())||this.records.push(t.id.toString()),this.save(),t},t.prototype.clear=function(){var t,e,r,o;for(o=this.records,t=0,r=o.length;r>t;t++)e=o[t],localStorage.removeItem(this.name+this.sep+e);return this.records=[],this.save()},t.prototype.hasDirtyOrDestroyed=function(){return!_.isEmpty(localStorage.getItem(this.name+"_dirty"))||!_.isEmpty(localStorage.getItem(this.name+"_destroyed"))},t.prototype.find=function(t){var e;return e=localStorage.getItem(this.name+this.sep+t.id),null===e?null:JSON.parse(e)},t.prototype.findAll=function(){var t,e,r,o,n;for(o=this.records,n=[],t=0,r=o.length;r>t;t++)e=o[t],n.push(JSON.parse(localStorage.getItem(this.name+this.sep+e)));return n},t.prototype.destroy=function(t){return localStorage.removeItem(this.name+this.sep+t.id),this.records=_.reject(this.records,function(e){return e===t.id.toString()}),this.save(),t},t}(),window.Store.exists=function(t){return null!==localStorage.getItem(t)},o={needsTranslation:"0.9.10"===t.VERSION,forBackboneCaller:function(t){return this.needsTranslation?function(e,r,o){return t.call(null,r)}:t},forDualstorageCaller:function(t,e,r){return this.needsTranslation?function(o){return t.call(null,e,o,r)}:t}},s=function(e,r,o){var n,i,s,a;if(n="clear"===e||"hasDirtyOrDestroyed"===e,n||(n=r instanceof t.Model),n||(n=r instanceof t.Collection),!n)throw new Error("model parameter is required to be a backbone model or collection.");return a=new Store(o.storeName),s=function(){switch(e){case"read":return r instanceof t.Model?a.find(r):a.findAll();case"hasDirtyOrDestroyed":return a.hasDirtyOrDestroyed();case"clear":return a.clear();case"create":return o.add&&!o.merge&&(i=a.find(r))?i:(r=a.create(r,o),o.dirty&&a.dirty(r),r);case"update":return a.update(r,o),o.dirty?a.dirty(r):a.clean(r,"dirty");case"delete":return a.destroy(r),o.dirty&&!r.hasTempId()?a.destroyed(r):r.hasTempId()?a.clean(r,"dirty"):a.clean(r,"destroyed")}}(),s&&(s.toJSON&&(s=s.toJSON(o)),s.attributes&&(s=s.attributes)),o.ignoreCallbacks||(s?o.success(s):o.error("Record not found")),s},c=function(t,e){return t&&t.parseBeforeLocalSave?_.isFunction(t.parseBeforeLocalSave)?t.parseBeforeLocalSave(e):void 0:e},a=function(e,r){var o;return o=new t.Model,o.idAttribute=e.idAttribute,o.set(e.attributes),o.set(e.parse(r)),o},r=t.DualStorage.originalSync=t.sync,u=function(e,r,n){return n.success=o.forBackboneCaller(n.success),n.error=o.forBackboneCaller(n.error),t.DualStorage.originalSync(e,r,n)},n=function(e,r,n){var d,f,h,p,y,g,m;if(n.storeName=i(r.collection,r),n.storeExists=Store.exists(n.storeName),n.success=o.forDualstorageCaller(n.success,r,n),n.error=o.forDualstorageCaller(n.error,r,n),_.result(r,"remote")||_.result(r.collection,"remote"))return u(e,r,n);if(h=_.result(r,"local")||_.result(r.collection,"local"),n.dirty=n.remote===!1&&!h,n.remote===!1||h)return s(e,r,n);switch(n.ignoreCallbacks=!0,y=n.success,d=n.error,m=function(){return n.dirty=!0,n.ignoreCallbacks=!1,n.success=y,n.error=d,s(e,r,n)},f=function(e){var r,o;return r=t.DualStorage.offlineStatusCodes,_.isFunction(r)&&(r=r(e)),0===e.status||(o=e.status,l.call(r,o)>=0)},p=function(t){var r;return r=!f(t),r||"read"===e&&!n.storeExists?d(t):m()},e){case"read":return s("hasDirtyOrDestroyed",r,n)?m():(n.success=function(e,o,i){var u,l,d,h,p,g;if(f(n.xhr))return m();if(e=c(r,e),r instanceof t.Collection)for(u=r,d=u.model.prototype.idAttribute,n.add||s("clear",u,n),l=0,h=e.length;h>l;l++)p=e[l],r=u.get(p[d]),g=r?a(r,p):new u.model(p),s("update",g,n);else g=a(r,e),s("update",g,n);return y(e,o,i)},n.error=function(t){return p(t)},n.xhr=u(e,r,n));case"create":return n.success=function(t,o,i){var u;return f(n.xhr)?m():(u=a(r,t),s(e,u,n),y(t,o,i))},n.error=function(t){return p(t)},n.xhr=u(e,r,n);case"update":return r.hasTempId()?(g=r.id,n.success=function(t,e,o){var i;return r.set(r.idAttribute,g,{silent:!0}),f(n.xhr)?m():(i=a(r,t),s("delete",r,n),s("create",i,n),y(t,e,o))},n.error=function(t){return r.set(r.idAttribute,g,{silent:!0}),p(t)},r.set(r.idAttribute,null,{silent:!0}),n.xhr=u("create",r,n)):(n.success=function(t,o,i){var u;return f(n.xhr)?m():(u=a(r,t),s(e,u,n),y(t,o,i))},n.error=function(t){return p(t)},n.xhr=u(e,r,n));case"delete":return r.hasTempId()?(n.ignoreCallbacks=!1,s(e,r,n)):(n.success=function(t,o,i){return f(n.xhr)?m():(s(e,r,n),y(t,o,i))},n.error=function(t){return p(t)},n.xhr=u(e,r,n))}},t.sync=n});
//# sourceMappingURL=./backbone.dualstorage.amd.min.js.map