jQuery.fn.springy=function(t){var e=this.graph=t.graph||new Springy.Graph,a="16px Verdana, sans-serif",i=t.stiffness||400,o=t.repulsion||400,n=t.damping||.5,r=t.minEnergyThreshold||1e-5,d=t.nodeSelected||null,l={},g=this[0],s=g.getContext("2d"),y=this.layout=new Springy.Layout.ForceDirected(e,i,o,n,r),h=y.getBoundingBox(),u={bottomleft:new Springy.Vector(-2,-2),topright:new Springy.Vector(2,2)};Springy.requestAnimationFrame(function t(){u=y.getBoundingBox(),h={bottomleft:h.bottomleft.add(u.bottomleft.subtract(h.bottomleft).divide(10)),topright:h.topright.add(u.topright.subtract(h.topright).divide(10))},Springy.requestAnimationFrame(t)});var f=function(t){var e=h.topright.subtract(h.bottomleft),a=t.subtract(h.bottomleft).divide(e.x).x*g.width,i=t.subtract(h.bottomleft).divide(e.y).y*g.height;return new Springy.Vector(a,i)},c=function(t){var e=h.topright.subtract(h.bottomleft),a=t.x/g.width*e.x+h.bottomleft.x,i=t.y/g.height*e.y+h.bottomleft.y;return new Springy.Vector(a,i)},x=null,p=null,v=null;jQuery(g).mousedown(function(t){var e=jQuery(this).offset(),a=c({x:t.pageX-e.left,y:t.pageY-e.top});null!==(x=p=v=y.nearest(a)).node&&(v.point.m=1e4,d&&d(x.node)),m.start()}),jQuery(g).dblclick(function(t){var e=jQuery(this).offset(),a=c({x:t.pageX-e.left,y:t.pageY-e.top});x=y.nearest(a),node=x.node,node&&node.data&&node.data.ondoubleclick&&node.data.ondoubleclick()}),jQuery(g).mousemove(function(t){var e=jQuery(this).offset(),a=c({x:t.pageX-e.left,y:t.pageY-e.top});p=y.nearest(a),null!==v&&null!==v.node&&(v.point.p.x=a.x,v.point.p.y=a.y),m.start()}),jQuery(window).bind("mouseup",function(t){v=null}),Springy.Node.prototype.getHeight=function(){var t;return null==this.data.image?16:this.data.image.src in l&&l[this.data.image.src].loaded?void 0!==(t=this).data.image.height?t.data.image.height:l[t.data.image.src].object.height:10},Springy.Node.prototype.getWidth=function(){var t;return null==this.data.image?function(t){var e=void 0!==t.data.label?t.data.label:t.id;if(t._width&&t._width[e])return t._width[e];s.save(),s.font=void 0!==t.data.font?t.data.font:a;var i=s.measureText(e).width;return s.restore(),t._width||(t._width={}),t._width[e]=i,i}(this):this.data.image.src in l&&l[this.data.image.src].loaded?void 0!==(t=this).data.image.width?t.data.image.width:l[t.data.image.src].object.width:10};var m=this.renderer=new Springy.Renderer(y,function(){s.clearRect(0,0,g.width,g.height)},function(t,a,i){for(var o=f(a).x,n=f(a).y,r=f(i).x,d=f(i).y,l=new Springy.Vector(r-o,d-n),g=l.normal().normalise(),y=e.getEdges(t.source,t.target),h=e.getEdges(t.target,t.source),u=y.length+h.length,c=0,x=0;x<y.length;x++)y[x].id===t.id&&(c=x);var p,v,m,w,S,F,j,E,T,Q,V=g.multiply(-12*(u-1)/2+12*c),B=f(a).add(V),M=f(i).add(V),P=t.target.getWidth()+6,_=t.target.getHeight()+6,k=(p=B,v=M,w=P,S=_,j={x:(m={x:r-P/2,y:d-_/2}).x,y:m.y},E={x:m.x+w,y:m.y},T={x:m.x,y:m.y+S},Q={x:m.x+w,y:m.y+S},(F=b(p,v,j,E))?F:(F=b(p,v,E,Q))?F:(F=b(p,v,Q,T))?F:!!(F=b(p,v,T,j))&&F);k||(k=M);var I,W=void 0!==t.data.color?t.data.color:"#000000",A=void 0!==t.data.weight?t.data.weight:1;s.lineWidth=Math.max(2*A,.1),I=1+s.lineWidth;var R,H=void 0===t.data.directional||t.data.directional;if(R=H?k.subtract(l.normalise().multiply(4)):M,s.strokeStyle=W,s.beginPath(),s.moveTo(B.x,B.y),s.lineTo(R.x,R.y),s.stroke(),H&&(s.save(),s.fillStyle=W,s.translate(k.x,k.y),s.rotate(Math.atan2(d-n,r-o)),s.beginPath(),s.moveTo(-8,I),s.lineTo(0,0),s.lineTo(-8,-I),s.lineTo(-6.4,-0),s.closePath(),s.fill(),s.restore()),void 0!==t.data.label){text=t.data.label,s.save(),s.textAlign="center",s.textBaseline="top",s.font=void 0!==t.data.font?t.data.font:"8px Verdana, sans-serif",s.fillStyle=W;var X=Math.atan2(M.y-B.y,M.x-B.x),Y=-8;(X>Math.PI/2||X<-Math.PI/2)&&(Y=8,X+=Math.PI);var q=B.add(M).divide(2).add(g.multiply(Y));s.translate(q.x,q.y),s.rotate(X),s.fillText(text,0,-2),s.restore()}},function(t,e){var i=f(e);s.save();var o=t.getWidth(),n=t.getHeight(),r=o+6,d=n+6;if(s.clearRect(i.x-r/2,i.y-d/2,r,d),null!==x&&null!==x.node&&x.node.id===t.id?s.fillStyle="#FFFFE0":null!==p&&null!==p.node&&p.node.id===t.id?s.fillStyle="#EEEEEE":s.fillStyle="#FFFFFF",s.fillRect(i.x-r/2,i.y-d/2,r,d),null==t.data.image){s.textAlign="left",s.textBaseline="top",s.font=void 0!==t.data.font?t.data.font:a,s.fillStyle=void 0!==t.data.color?t.data.color:"#000000";var g=void 0!==t.data.label?t.data.label:t.id;s.fillText(g,i.x-o/2,i.y-n/2)}else{var y=t.data.image.src;if(y in l)l[y].loaded&&s.drawImage(l[y].object,i.x-o/2,i.y-n/2,o,n);else{l[y]={};var h=new Image;l[y].object=h,h.addEventListener("load",function(){l[y].loaded=!0}),h.src=y}}s.restore()});function b(t,e,a,i){var o=(i.y-a.y)*(e.x-t.x)-(i.x-a.x)*(e.y-t.y);if(0===o)return!1;var n=((i.x-a.x)*(t.y-a.y)-(i.y-a.y)*(t.x-a.x))/o,r=((e.x-t.x)*(t.y-a.y)-(e.y-t.y)*(t.x-a.x))/o;return!(n<0||n>1||r<0||r>1)&&new Springy.Vector(t.x+n*(e.x-t.x),t.y+n*(e.y-t.y))}return m.start(),this};