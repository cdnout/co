import _objectSpread from"@babel/runtime/helpers/objectSpread2";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inherits from"@babel/runtime/helpers/inherits";import _createSuper from"@babel/runtime/helpers/createSuper";import _defineProperty from"@babel/runtime/helpers/defineProperty";var _excluded=["id"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import{Touch}from"../Touch/Touch";import TouchRootContext from"../Touch/TouchContext";import{getClassName}from"../../helpers/getClassName";import{classNames}from"../../lib/classNames";import{setTransformStyle}from"../../lib/styles";import{rubber}from"../../lib/touch";import{ANDROID,IOS,VKCOM}from"../../lib/platform";import{transitionEvent}from"../../lib/supportEvents";import{withPlatform}from"../../hoc/withPlatform";import{withContext}from"../../hoc/withContext";import ModalRootContext from"./ModalRootContext";import{ConfigProviderContext,WebviewType}from"../ConfigProvider/ConfigProviderContext";import{ModalType}from"./types";import{MODAL_PAGE_DEFAULT_PERCENT_HEIGHT}from"./constants";import{withDOM}from"../../lib/dom";import{getNavId}from"../../lib/getNavId";import{warnOnce}from"../../lib/warnOnce";import{FocusTrap}from"../FocusTrap/FocusTrap";import{withModalManager}from"./useModalManager";import"./ModalRoot.css";var warn=warnOnce("ModalRoot"),IS_DEV="development"===process.env.NODE_ENV;function numberInRange(t,e){return!!e&&(t>=e[0]&&t<=e[1])}function rangeTranslate(t){return Math.max(0,Math.min(98,t))}var ModalRootTouchComponent=function(t){_inherits(o,t);var e=_createSuper(o);function o(t){var n;return _classCallCheck(this,o),n=e.call(this,t),_defineProperty(_assertThisInitialized(n),"documentScrolling",!1),_defineProperty(_assertThisInitialized(n),"maskElementRef",void 0),_defineProperty(_assertThisInitialized(n),"viewportRef",React.createRef()),_defineProperty(_assertThisInitialized(n),"maskAnimationFrame",void 0),_defineProperty(_assertThisInitialized(n),"modalRootContext",void 0),_defineProperty(_assertThisInitialized(n),"frameIds",void 0),_defineProperty(_assertThisInitialized(n),"restoreFocusTo",void 0),_defineProperty(_assertThisInitialized(n),"preventTouch",function(t){if(!t)return!1;for(;t.originalEvent;)t=t.originalEvent;return t.preventDefault&&t.preventDefault(),!1}),_defineProperty(_assertThisInitialized(n),"updateModalTranslate",function(){var t=n.getModalState(n.props.activeModal);t&&n.animateTranslate(t,t.translateY)}),_defineProperty(_assertThisInitialized(n),"updateModalHeight",function(){var t=n.getModalState(n.props.activeModal);t&&t.type===ModalType.PAGE&&t.dynamicContentHeight&&(n.props.enteringModal?n.waitTransitionFinish(t,function(){requestAnimationFrame(function(){return n.checkPageContentHeight()})}):requestAnimationFrame(function(){return n.checkPageContentHeight()}))}),_defineProperty(_assertThisInitialized(n),"onTouchMove",function(t){if(!n.props.exitingModal){var e=n.getModalState(n.props.activeModal);if(e)return e.type===ModalType.PAGE?n.onPageTouchMove(t,e):e.type===ModalType.CARD?n.onCardTouchMove(t,e):void 0}}),_defineProperty(_assertThisInitialized(n),"onTouchEnd",function(t){var e=n.getModalState(n.props.activeModal);return(null==e?void 0:e.type)===ModalType.PAGE?n.onPageTouchEnd(t,e):(null==e?void 0:e.type)===ModalType.CARD?n.onCardTouchEnd(t,e):void 0}),_defineProperty(_assertThisInitialized(n),"onScroll",function(t){var e,o=n.props.activeModal,t=t.target;!o||(null==(e=n.getModalState(o))?void 0:e.type)===ModalType.PAGE&&null!=e&&null!=(o=e.contentElement)&&o.contains(t)&&(e.contentScrolled=!0,e.contentScrollStopTimeout&&clearTimeout(e.contentScrollStopTimeout),e.contentScrollStopTimeout=setTimeout(function(){e.contentScrolled&&(e.contentScrolled=!1)},250))}),n.state={touchDown:!1,dragging:!1},n.maskElementRef=React.createRef(),n.modalRootContext={updateModalHeight:n.updateModalHeight,registerModal:function(t){var e=t.id,t=_objectWithoutProperties(t,_excluded);return Object.assign(n.getModalState(e),t)},onClose:function(){return n.props.onExit()},isInsideModal:!0},n.frameIds={},n}return _createClass(o,[{key:"timeout",get:function(){return this.props.platform===ANDROID||this.props.platform===VKCOM?320:400}},{key:"document",get:function(){return this.props.document}},{key:"window",get:function(){return this.props.window}},{key:"getModalState",value:function(t){if(t)return this.props.getModalState(t)}},{key:"getModals",value:function(){return React.Children.toArray(this.props.children)}},{key:"componentDidMount",value:function(){var t;this.props.platform===IOS&&null!=(t=this.window)&&t.addEventListener("resize",this.updateModalTranslate,!1)}},{key:"componentWillUnmount",value:function(){this.toggleDocumentScrolling(!0),this.window.removeEventListener("resize",this.updateModalTranslate,!1)}},{key:"componentDidUpdate",value:function(t){var e,o,n=this;this.props.exitingModal&&this.props.exitingModal!==t.exitingModal&&this.closeModal(this.props.exitingModal),this.props.enteringModal&&this.props.enteringModal!==t.enteringModal&&(e=this.props.enteringModal,o=this.getModalState(e),this.props.onEnter(),this.waitTransitionFinish(o,function(){null!=o&&o.innerElement&&(o.innerElement.style.transitionDelay=""),n.props.onEntered(e)}),null!=o&&o.innerElement&&(o.innerElement.style.transitionDelay=this.props.delayEnter?"".concat(this.timeout,"ms"):"",this.animateTranslate(o,o.translateY))),this.props.activeModal&&!t.activeModal&&(this.restoreFocusTo=this.document.activeElement),this.props.activeModal||this.props.exitingModal||!this.restoreFocusTo||(this.restoreFocusTo.focus(),this.restoreFocusTo=null),this.toggleDocumentScrolling(!this.props.activeModal&&!this.props.exitingModal)}},{key:"toggleDocumentScrolling",value:function(t){this.documentScrolling!==t&&((this.documentScrolling=t)?this.window.removeEventListener("touchmove",this.preventTouch,{passive:!1}):this.window.addEventListener("touchmove",this.preventTouch,{passive:!1}))}},{key:"checkPageContentHeight",value:function(){var t,e,o,n=this.getModalState(this.props.activeModal);(null==n?void 0:n.type)===ModalType.PAGE&&null!=n&&n.modalElement&&(t=_objectSpread({},n),initPageModal(n),e=_objectSpread({},n),o=!1,(o=t.expandable!==e.expandable||t.translateYFrom!==e.translateYFrom?!0:o)&&this.animateTranslate(n,n.translateY))}},{key:"closeModal",value:function(t){var e,o,n,a=this,i=(this.setState({touchDown:!1}),this.getModalState(t));i?(n=!!(e=this.getModalState(this.props.activeModal))&&e.type===ModalType.PAGE,o=!!i&&i.type===ModalType.PAGE,this.waitTransitionFinish(i,function(){return a.props.onExited(t)}),n=o&&n&&(null!=(o=i.translateY)?o:0)<=(null!=(n=null==e?void 0:e.translateYFrom)?n:0)&&!this.props.isBack?(null!=(o=null==e?void 0:e.translateYFrom)?o:0)+10:100,this.animateTranslate(i,n),e||this.setMaskOpacity(i,0)):t&&warn("closeActiveModal: Modal ".concat(t," does not exist - not closing"),"error")}},{key:"onPageTouchMove",value:function(t,e){var o=t.shiftY,n=t.originalEvent,a=n.target;if(t.isY){if(null==(t=e.innerElement)||!t.contains(a))return n.preventDefault();n.stopPropagation();var i,t=e.expandable,r=e.contentScrolled,l=e.collapsed,s=e.expanded;this.state.touchDown||(e.touchStartContentScrollTop=null==(i=e.contentElement)?void 0:i.scrollTop,this.setState({touchDown:!0})),r||(null===e.touchMovePositive&&(e.touchMovePositive=0<o),(!e.expandable||l||s&&e.touchMovePositive&&0===e.touchStartContentScrollTop||null!=(i=e.headerElement)&&i.contains(a))&&(n.preventDefault(),!t&&o<0||!this.window||(this.state.dragging||this.setState({dragging:!0}),r=o/this.window.innerHeight*100,l=rubber(r,72,.8,this.props.platform===ANDROID||this.props.platform===VKCOM),e.touchShiftYPercent=r,e.translateYCurrent=rangeTranslate((null!=(s=e.translateY)?s:0)+l),this.animateTranslate(e,e.translateYCurrent),this.setMaskOpacity(e))))}else null!=(i=this.viewportRef.current)&&i.contains(a)&&n.preventDefault()}},{key:"onCardTouchMove",value:function(t,e){var o,n=t.originalEvent,t=t.shiftY,n=n.target;null!=(o=e.innerElement)&&o.contains(n)&&(this.state.touchDown||this.setState({touchDown:!0,dragging:!0}),o=t/e.innerElement.offsetHeight*100,n=rubber(o,72,1.2,this.props.platform===ANDROID||this.props.platform===VKCOM),e.touchShiftYPercent=o,e.translateYCurrent=Math.max(0,(null!=(t=e.translateY)?t:0)+n),this.animateTranslate(e,e.translateYCurrent),this.setMaskOpacity(e))}},{key:"onPageTouchEnd",value:function(t,e){var o,n=this,a=t.startY,i=t.shiftY;e.contentScrolled=!1,e.touchMovePositive=null,this.state.dragging&&this.window&&(a=(a+i)/this.window.innerHeight*100,i=rangeTranslate((i=null!=(i=e.translateYCurrent)?i:0)+i/t.duration*240*.6*((null!=(t=e.touchShiftYPercent)?t:0)<0?-1:1)),i=100!==e.settlingHeight?numberInRange(i,e.expandedRange)?null!=(t=null==(t=e.expandedRange)?void 0:t[0])?t:0:numberInRange(i,e.collapsedRange)?null!=(t=e.translateYFrom)?t:0:numberInRange(i,e.hiddenRange)?100:null!=(t=e.translateYFrom)?t:0:numberInRange(i,[0,25])?0:100,e.translateY=i=100!==i&&75<=a?100:i,e.translateYCurrent=i,e.collapsed=0<i&&i<a,e.expanded=0===i,e.hidden=100===i,e.hidden&&this.props.onExit(),o=function(){e.hidden||n.animateTranslate(e,e.translateY),n.setMaskOpacity(e)}),this.setState({touchDown:!1,dragging:!1},o)}},{key:"onCardTouchEnd",value:function(t,e){var o,n=this,t=t.duration;this.state.dragging&&(t=(o=null!=(o=e.translateYCurrent)?o:0)/t*240*.6*((null!=(t=e.touchShiftYPercent)?t:0)<0?-1:1),o=Math.max(0,o+t),e.translateY=o=30<=o?100:0,e.hidden=100===o,e.hidden&&this.props.onExit(),o=function(){e.hidden||n.animateTranslate(e,e.translateY),n.setMaskOpacity(e)}),this.setState({touchDown:!1,dragging:!1},o)}},{key:"waitTransitionFinish",value:function(o,n){var t;transitionEvent.supported?null!=o&&null!=(t=o.innerElement)&&t.addEventListener(transitionEvent.name,function t(){var e;null!=o&&null!=(e=o.innerElement)&&e.removeEventListener(transitionEvent.name,t),n()}):setTimeout(n,this.timeout)}},{key:"animateTranslate",value:function(t,e){var o="animateTranslateFrame".concat(t.id);cancelAnimationFrame(this.frameIds[o]),this.frameIds[o]=requestAnimationFrame(function(){setTransformStyle(t.innerElement,"translate3d(0, ".concat(e,"%, 0)"))})}},{key:"setMaskOpacity",value:function(o){var t,n=this,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;null===a&&(null==(t=this.props.history)?void 0:t[0])!==o.id||(this.maskAnimationFrame&&cancelAnimationFrame(this.maskAnimationFrame),this.maskAnimationFrame=requestAnimationFrame(function(){var t,e;n.maskElementRef.current&&(t=void 0===(t=o.translateY)?0:t,e=o.translateYCurrent,n.maskElementRef.current.style.opacity=Math.max(0,Math.min(100,null===a?1-((void 0===e?0:e)-t)/(100-t)||0:a)).toString())}))}},{key:"render",value:function(){var i=this,t=this.props,r=t.activeModal,l=t.exitingModal,s=t.enteringModal,t=this.state,e=t.touchDown,d=t.dragging;return r||l?createScopedElement(TouchRootContext.Provider,{value:!0},createScopedElement(ModalRootContext.Provider,{value:this.modalRootContext},createScopedElement(Touch,{vkuiClass:classNames(getClassName("ModalRoot",this.props.platform),{"ModalRoot--vkapps":(null==(t=this.props.configProvider)?void 0:t.webviewType)===WebviewType.VKAPPS,"ModalRoot--touched":e,"ModalRoot--switching":!(!s&&!l)}),onMove:this.onTouchMove,onEnd:this.onTouchEnd,onScroll:this.onScroll},createScopedElement("div",{vkuiClass:"ModalRoot__mask",onClick:this.props.onExit,ref:this.maskElementRef}),createScopedElement("div",{vkuiClass:"ModalRoot__viewport",ref:this.viewportRef},this.getModals().map(function(t){var o=getNavId(t.props,warn),e=i.getModalState(o);if(o!==r&&o!==l||!e)return null;var e=_objectSpread({},e),n=e.type===ModalType.PAGE,a="modal-".concat(o);return createScopedElement(FocusTrap,{key:a,getRootRef:function(t){var e=i.getModalState(o);e&&(e.modalElement=t)},onClose:i.props.onExit,timeout:i.timeout,vkuiClass:classNames("ModalRoot__modal",{"ModalRoot__modal--active":o===r,"ModalRoot__modal--prev":o===l,"ModalRoot__modal--next":l&&o===r||o===s,"ModalRoot__modal--dragging":d,"ModalRoot__modal--expandable":n&&e.expandable,"ModalRoot__modal--expanded":n&&e.expanded,"ModalRoot__modal--collapsed":n&&e.collapsed}),restoreFocus:!1},t)}))))):null}}]),o}(React.Component),ModalRootTouch=withContext(withPlatform(withDOM(withModalManager(initModal)(ModalRootTouchComponent))),ConfigProviderContext,"configProvider");function initModal(t){switch(t.type){case ModalType.PAGE:return t.settlingHeight=t.settlingHeight||MODAL_PAGE_DEFAULT_PERCENT_HEIGHT,initPageModal(t);case ModalType.CARD:return initCardModal(t);default:IS_DEV&&warn("initActiveModal: modalState.type is unknown","error")}}function initPageModal(t){var e,o,n,a,i,r=t.contentElement,l=(null==r?void 0:r.firstElementChild).offsetHeight,s=t.translateY,r=(t.expandable=l>(null!=(r=null==r?void 0:r.clientHeight)?r:0)||100===t.settlingHeight,!1),d=!1;t.expandable?(o=[0,a=(e=100-(null!=(e=t.settlingHeight)?e:0))/2],n=[a,e+(a=100-e)/4],a=[e+a/4,100],r=0<e,d=e<=0,i=e):(o=[i=e=100-(l+(null!=(l=null==(l=t.headerElement)?void 0:l.offsetHeight)?l:0))/(null!=(l=null==(l=t.innerElement)||null==(l=l.parentElement)?void 0:l.offsetHeight)?l:0)*100,i+25],n=[i+25,i+25],a=[i+25,i+100]),(t.expandable&&(null!=s?s:0)<i||100===t.settlingHeight)&&(i=0),t.expandedRange=o,t.collapsedRange=n,t.hiddenRange=a,t.translateY=i,t.translateYFrom=e,t.collapsed=r,t.expanded=d}function initCardModal(t){t.translateY=0}export{ModalRootTouch};