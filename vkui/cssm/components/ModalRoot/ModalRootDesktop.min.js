import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inherits from"@babel/runtime/helpers/inherits";import _createSuper from"@babel/runtime/helpers/createSuper";import _defineProperty from"@babel/runtime/helpers/defineProperty";var _excluded=["id"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import{classNames}from"../../lib/classNames";import{transitionEvent}from"../../lib/supportEvents";import{withPlatform}from"../../hoc/withPlatform";import{withContext}from"../../hoc/withContext";import ModalRootContext from"./ModalRootContext";import{ConfigProviderContext,WebviewType}from"../ConfigProvider/ConfigProviderContext";import{ANDROID,VKCOM}from"../../lib/platform";import{getClassName}from"../../helpers/getClassName";import{withDOM}from"../../lib/dom";import{getNavId}from"../../lib/getNavId";import{warnOnce}from"../../lib/warnOnce";import{FocusTrap}from"../FocusTrap/FocusTrap";import{withModalManager}from"./useModalManager";import"./ModalRoot.css";var warn=warnOnce("ModalRoot"),ModalRootDesktopComponent=function(t){_inherits(i,t);var e=_createSuper(i);function i(t){var o;return _classCallCheck(this,i),o=e.call(this,t),_defineProperty(_assertThisInitialized(o),"maskElementRef",void 0),_defineProperty(_assertThisInitialized(o),"maskAnimationFrame",void 0),_defineProperty(_assertThisInitialized(o),"modalRootContext",void 0),_defineProperty(_assertThisInitialized(o),"restoreFocusTo",void 0),o.maskElementRef=React.createRef(),o.modalRootContext={updateModalHeight:function(){},registerModal:function(t){var e=t.id,t=_objectWithoutProperties(t,_excluded);return Object.assign(o.getModalState(e),t)},onClose:function(){return o.props.onExit()},isInsideModal:!0},o}return _createClass(i,[{key:"timeout",get:function(){return this.props.platform===ANDROID||this.props.platform===VKCOM?320:400}},{key:"modals",get:function(){return React.Children.toArray(this.props.children)}},{key:"getModalState",value:function(t){if(null!==t)return this.props.getModalState(t)}},{key:"componentDidUpdate",value:function(t){var e,o,i=this;this.props.exitingModal&&this.props.exitingModal!==t.exitingModal&&this.closeModal(this.props.exitingModal),this.props.enteringModal&&this.props.enteringModal!==t.enteringModal&&(e=this.props.enteringModal,o=this.getModalState(e),this.props.onEnter(),requestAnimationFrame(function(){i.props.enteringModal===e&&(i.waitTransitionFinish(o,function(){return i.props.onEntered(e)}),i.animateModalOpacity(o,!0))})),this.props.activeModal&&!t.activeModal&&(this.restoreFocusTo=null!=(t=null==(t=this.props.document)?void 0:t.activeElement)?t:void 0),this.props.activeModal||this.props.exitingModal||!this.restoreFocusTo||(this.restoreFocusTo.focus(),this.restoreFocusTo=void 0)}},{key:"closeModal",value:function(t){var e=this,o=this.getModalState(t);o&&(this.waitTransitionFinish(o,function(){return e.props.onExited(t)}),this.animateModalOpacity(o,!1),this.props.activeModal||this.setMaskOpacity(o,0))}},{key:"waitTransitionFinish",value:function(o,i){var t;transitionEvent.supported?null!=o&&null!=(t=o.innerElement)&&t.addEventListener(transitionEvent.name,function t(){var e;null!=o&&null!=(e=o.innerElement)&&e.removeEventListener(transitionEvent.name,t),i()}):setTimeout(i,this.timeout)}},{key:"animateModalOpacity",value:function(t,e){null!=t&&t.innerElement&&(t.innerElement.style.transitionDelay=e&&this.props.delayEnter?"".concat(this.timeout,"ms"):"",t.innerElement.style.opacity=e?"1":"0")}},{key:"setMaskOpacity",value:function(o){var t,i=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;null===r&&(null==(t=this.props.history)?void 0:t[0])!==o.id||(this.maskAnimationFrame&&cancelAnimationFrame(this.maskAnimationFrame),this.maskAnimationFrame=requestAnimationFrame(function(){var t,e;i.maskElementRef.current&&(t=void 0===(t=o.translateY)?0:t,e=o.translateYCurrent,i.maskElementRef.current.style.opacity=Math.max(0,Math.min(100,null===r?1-((void 0===e?0:e)-t)/(100-t)||0:r)).toString())}))}},{key:"render",value:function(){var i=this,t=this.props,r=t.exitingModal,a=t.activeModal,n=t.enteringModal;return a||r?createScopedElement(ModalRootContext.Provider,{value:this.modalRootContext},createScopedElement("div",{vkuiClass:classNames(getClassName("ModalRoot",this.props.platform),{"ModalRoot--vkapps":(null==(t=this.props.configProvider)?void 0:t.webviewType)===WebviewType.VKAPPS},"ModalRoot--desktop")},createScopedElement("div",{vkuiClass:"ModalRoot__mask",ref:this.maskElementRef,onClick:this.props.onExit}),createScopedElement("div",{vkuiClass:"ModalRoot__viewport"},this.modals.map(function(t){var e=getNavId(t.props,warn);if(e!==a&&e!==r)return null;var o="modal-".concat(e);return createScopedElement(FocusTrap,{restoreFocus:!1,onClose:i.props.onExit,timeout:i.timeout,key:o,vkuiClass:classNames("ModalRoot__modal",{"ModalRoot__modal--active":!r&&!n&&e===a,"ModalRoot__modal--prev":e===r,"ModalRoot__modal--next":Boolean(r)&&e===a})},t)})))):null}}]),i}(React.Component),ModalRootDesktop=withContext(withPlatform(withDOM(withModalManager()(ModalRootDesktopComponent))),ConfigProviderContext,"configProvider");export{ModalRootDesktop};