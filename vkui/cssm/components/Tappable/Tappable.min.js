import _extends from"@babel/runtime/helpers/extends";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";var _excluded=["children","Component","onClick","onKeyDown","activeEffectDelay","stopPropagation","getRootRef","sizeX","hasMouse","deviceHasHover","hasHover","hoverMode","hasActive","activeMode","focusVisibleMode","onEnter","onLeave"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import mitt from"mitt";import{noop}from"@vkontakte/vkjs";import{Touch}from"../Touch/Touch";import TouchRootContext from"../Touch/TouchContext";import{classNames}from"../../lib/classNames";import{getClassName}from"../../helpers/getClassName";import{ANDROID}from"../../lib/platform";import{getOffsetRect}from"../../lib/offset";import{coordX,coordY}from"../../lib/touch";import{withAdaptivity}from"../../hoc/withAdaptivity";import{shouldTriggerClickOnEnterOrSpace}from"../../lib/accessibility";import{useIsomorphicLayoutEffect}from"../../lib/useIsomorphicLayoutEffect";import{FocusVisible}from"../FocusVisible/FocusVisible";import{useTimeout}from"../../hooks/useTimeout";import{useExternRef}from"../../hooks/useExternRef";import{usePlatform}from"../../hooks/usePlatform";import{useFocusVisible}from"../../hooks/useFocusVisible";import{callMultiple}from"../../lib/callMultiple";import{useBooleanState}from"../../hooks/useBooleanState";import"./Tappable.css";var ACTIVE_DELAY=70,ACTIVE_EFFECT_DELAY=600,activeBus=mitt(),TapState={none:0,pending:1,active:2,exiting:3},TappableContext=React.createContext({onHoverChange:noop});function useActivity(e,t){function o(){return s(TapState.none)}function a(){return e&&s(TapState.active)}var i=React.useMemo(function(){return Math.round(1e8*Math.random()).toString(16)},[]),r=React.useState(TapState.none),r=_slicedToArray(r,2),n=r[0],s=r[1],c=useTimeout(a,ACTIVE_DELAY),u=useTimeout(o,t);useIsomorphicLayoutEffect(function(){return n===TapState.pending?(c.set(),c.clear):n===TapState.exiting?u.clear:(n===TapState.active&&activeBus.emit("active",i),noop)},[n]),useIsomorphicLayoutEffect(function(){if(n===TapState.none)return noop;function e(e){e!==i&&o()}return activeBus.on("active",e),function(){return activeBus.off("active",e)}},[n===TapState.none]),useIsomorphicLayoutEffect(function(){e||o()},[e]);return[n,{delayStart:function(){e&&s(TapState.pending)},start:a,stop:function(e){if(e)return s(TapState.exiting),u.set(e);o()}}]}var Tappable=function(e){var t=e.children,o=e.Component,a=e.onClick,i=e.onKeyDown,r=e.activeEffectDelay,n=void 0===r?ACTIVE_EFFECT_DELAY:r,r=e.stopPropagation,r=void 0!==r&&r,s=e.getRootRef,c=e.sizeX,u=e.hasMouse,l=e.deviceHasHover,p=e.hasHover,p=void 0===p||p,d=e.hoverMode,d=void 0===d?"background":d,f=e.hasActive,f=void 0===f||f,m=e.activeMode,m=void 0===m?"background":m,v=e.focusVisibleMode,v=void 0===v?"inside":v,b=e.onEnter,T=e.onLeave,e=_objectWithoutProperties(e,_excluded),o=o||(e.href?"a":"div"),h=React.useContext(TappableContext).onHoverChange,E=React.useContext(TouchRootContext),C=usePlatform(),y=useFocusVisible(),S=y.focusVisible,g=y.onBlur,y=y.onFocus,A=React.useState([]),A=_slicedToArray(A,2),_=A[0],x=A[1],A=React.useState(!1),A=_slicedToArray(A,2),R=A[0],A=A[1],k=useBooleanState(!1),M=k.value,H=k.setTrue,k=k.setFalse,D=M&&!e.disabled,F=f&&!R&&!e.disabled,M=l&&p&&!R,I="a"!==o&&"button"!==o&&!e.contentEditable,f=["opacity","background"].includes(d),l=["opacity","background"].includes(m),p=["inside","outside"].includes(v),R=useActivity(F,n),R=_slicedToArray(R,2),V=R[0],R=R[1],w=R.start,L=R.stop,B=R.delayStart,R=V===TapState.active||V===TapState.exiting,P=useExternRef(s),s=React.useRef({onHoverChange:A}).current;useIsomorphicLayoutEffect(function(){return D?(h(!0),function(){return h(!1)}):noop},[D]);c=classNames(getClassName("Tappable",C),"Tappable--sizeX-".concat(c),M&&"Tappable--hasHover",F&&"Tappable--hasActive",M&&D&&!f&&d,F&&R&&!l&&m,S&&!p&&v,(_defineProperty(A={"Tappable--active":F&&R,"Tappable--mouse":u},"Tappable--hover-".concat(d),M&&D&&f),_defineProperty(A,"Tappable--active-".concat(m),F&&R&&l),_defineProperty(A,"Tappable--focus-visible",S),A)),f={onStart:callMultiple(function(e){var t,o,e=e.originalEvent;if(F){if(e.touches&&1<e.touches.length)return L();C===ANDROID&&(t=(o=getOffsetRect(P.current)).top,o=o.left,o=coordX(e)-(null!=o?o:0),e=coordY(e)-(null!=t?t:0),x([].concat(_toConsumableArray(_),[{x:o,y:e,id:Date.now().toString()}]))),B()}},e.onStart),onMove:callMultiple(function(e){e.isSlide&&L()},e.onMove),onEnd:callMultiple(function(e){var e=e.duration;V!==TapState.none&&(V===TapState.pending&&w(),L(100<=(e=e-ACTIVE_DELAY)?0:n-e))},e.onEnd),onClick:a,onKeyDown:callMultiple(function(e){I&&shouldTriggerClickOnEnterOrSpace(e)&&(e.preventDefault(),null!=(e=P.current)&&e.click())},i)},R=e.href?"link":"button";return createScopedElement(Touch,_extends({onEnter:callMultiple(H,b),onLeave:callMultiple(k,T),type:"button"===o?"button":void 0,tabIndex:I&&!e.disabled?0:void 0,role:I?R:void 0,"aria-disabled":I?e.disabled:void 0,stopPropagation:r&&!E&&!e.disabled},e,{slideThreshold:20,usePointerHover:!0,vkuiClass:c,Component:o,getRootRef:P,onBlur:callMultiple(g,e.onBlur),onFocus:callMultiple(y,e.onFocus)},e.disabled?{}:f),createScopedElement(TappableContext.Provider,{value:s},t),C===ANDROID&&!u&&F&&"background"===m&&createScopedElement("span",{"aria-hidden":"true",vkuiClass:"Tappable__waves"},_.map(function(t){return createScopedElement(Wave,_extends({},t,{key:t.id,onClear:function(){return x(_.filter(function(e){return e.id!==t.id}))}}))})),M&&"background"===d&&createScopedElement("span",{"aria-hidden":"true",vkuiClass:"Tappable__hoverShadow"}),!e.disabled&&p&&createScopedElement(FocusVisible,{mode:v}))};export default withAdaptivity(Tappable,{sizeX:!0,hasMouse:!0,deviceHasHover:!0});function Wave(e){var t=e.x,o=e.y,e=e.onClear,a=useTimeout(e,225);return React.useEffect(function(){return a.set()},[a]),createScopedElement("span",{vkuiClass:"Tappable__wave",style:{top:o,left:t}})}export{ACTIVE_DELAY,ACTIVE_EFFECT_DELAY};