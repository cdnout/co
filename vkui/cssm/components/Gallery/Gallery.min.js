import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import _extends from"@babel/runtime/helpers/extends";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inherits from"@babel/runtime/helpers/inherits";import _createSuper from"@babel/runtime/helpers/createSuper";import _defineProperty from"@babel/runtime/helpers/defineProperty";var _excluded=["children","slideWidth","slideIndex","isDraggable","onDragStart","onDragEnd","onChange","onEnd","align","bullets","platform","hasMouse","showArrows","window","document","getRef","getRootRef"],_excluded2=["initialSlideIndex","children","timeout","onChange"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import{getClassName}from"../../helpers/getClassName";import{Touch}from"../Touch/Touch";import{classNames}from"../../lib/classNames";import{withPlatform}from"../../hoc/withPlatform";import{withDOM}from"../../lib/dom";import{setRef}from"../../lib/utils";import{withAdaptivity}from"../../hoc/withAdaptivity";import HorizontalScrollArrow from"../HorizontalScroll/HorizontalScrollArrow";import{clamp}from"../../helpers/math";import{useTimeout}from"../../hooks/useTimeout";import"./Gallery.css";var BaseGallery=function(e){_inherits(i,e);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),r=t.call(this,e),_defineProperty(_assertThisInitialized(r),"container",null),_defineProperty(_assertThisInitialized(r),"slidesStore",void 0),_defineProperty(_assertThisInitialized(r),"viewport",null),_defineProperty(_assertThisInitialized(r),"onStart",function(){r.setState({animation:!1})}),_defineProperty(_assertThisInitialized(r),"onMoveX",function(e){r.props.isDraggable&&!r.isFullyVisible&&(e.originalEvent.preventDefault(),e.isSlideX&&(r.props.onDragStart&&r.props.onDragStart(e),r.state.deltaX===e.shiftX&&r.state.dragging===e.isSlideX||r.setState({deltaX:e.shiftX,dragging:e.isSlideX})))}),_defineProperty(_assertThisInitialized(r),"onEnd",function(e){var t,i=e.isSlide?r.getTarget(e):null!=(t=r.props.slideIndex)?t:0;r.props.onDragEnd&&r.props.onDragEnd(e),r.setState({deltaX:0,animation:!0},function(){var e,t;return null==(e=(t=r.props).onChange)?void 0:e.call(t,i)}),r.props.onEnd&&r.props.onEnd({targetIndex:i})}),_defineProperty(_assertThisInitialized(r),"onResize",function(){return r.initializeSlides({animation:!1})}),_defineProperty(_assertThisInitialized(r),"slideLeft",function(){var e=r.props,t=e.slideIndex,i=void 0===t?0:t,n=e.onChange,t=e.onPrevClick;r.canSlideLeft&&(r.setState({deltaX:0,animation:!0},function(){return null==n?void 0:n(i-1)}),null!=t&&t())}),_defineProperty(_assertThisInitialized(r),"slideRight",function(){var e=r.props,t=e.slideIndex,i=void 0===t?0:t,n=e.onChange,t=e.onNextClick;r.canSlideRight&&(r.setState({deltaX:0,animation:!0},function(){return null==n?void 0:n(i+1)}),null!=t&&t())}),_defineProperty(_assertThisInitialized(r),"getSlideRef",function(t){return function(e){r.slidesStore["slide-".concat(t)]=e}}),_defineProperty(_assertThisInitialized(r),"getViewportRef",function(e){r.viewport=e,r.props.getRef&&setRef(e,r.props.getRef)}),_defineProperty(_assertThisInitialized(r),"getRootRef",function(e){r.container=e,r.props.getRootRef&&setRef(e,r.props.getRootRef)}),r.state={containerWidth:0,deltaX:0,shiftX:0,slides:[],animation:!0,duration:.24},r.slidesStore={},r}return _createClass(i,[{key:"isCenterWithCustomWidth",get:function(){return"custom"===this.props.slideWidth&&"center"===this.props.align}},{key:"initializeSlides",value:function(){var n=this,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=null!=(e=React.Children.map(this.props.children,function(e,t){var i,t=n.slidesStore["slide-".concat(t)];return{coordX:null!=(i=null==t?void 0:t.offsetLeft)?i:0,width:null!=(i=null==t?void 0:t.offsetWidth)?i:0}}))?e:[],t=null!=(t=null==(t=this.container)?void 0:t.offsetWidth)?t:0,i=e.reduce(function(e,t){return t.width+e},0),s=this.calcMin({containerWidth:t,layerWidth:i,slides:e}),l=this.calcMax({slides:e});this.setState({min:s,max:l,layerWidth:i,containerWidth:t,slides:e},function(){var e,t,i;void 0!==n.props.slideIndex&&(e=n.calculateIndent(n.props.slideIndex),n.state.shiftX!==e&&(t=n.state.shiftX===n.validateIndent(n.state.shiftX),i=r.animation,n.setState({shiftX:e,animation:void 0===i?t:i},function(){var e;n.state.animation||null!=(e=n.props.window)&&e.requestAnimationFrame(function(){return n.setState({animation:!0})})})))})}},{key:"calcMin",value:function(e){var t,i=e.containerWidth,n=e.layerWidth,r=void 0===n?0:n,s=e.slides,l=null!=(e=null==(n=this.viewport)?void 0:n.offsetWidth)?e:0;switch(this.props.align){case"left":return i-r;case"right":return l-r;case"center":return this.isCenterWithCustomWidth&&s.length?l/2-(t=s[s.length-1]).coordX-t.width/2:l-(i-l)/2-r}}},{key:"calcMax",value:function(e){var t,e=e.slides,i=null!=(i=null==(i=this.viewport)?void 0:i.offsetWidth)?i:0;return this.isCenterWithCustomWidth&&e.length?(t=(e=e[0]).width,i/2-e.coordX-t/2):0}},{key:"calculateIndent",value:function(e){var t=this.state.slides;if(this.isFullyVisible)return 0;var i,t=t.length?t[e]:null;return t?(e=t.coordX,t=t.width,this.isCenterWithCustomWidth?(null!=(i=null==(i=this.viewport)?void 0:i.offsetWidth)?i:0)/2-e-t/2:this.validateIndent(-1*e)):0}},{key:"calculateDragIndent",value:function(){var e=this.state,t=e.shiftX,i=e.deltaX,n=e.min,n=void 0===n?0:n,e=e.max,e=void 0===e?0:e,t=t+i;return e<t?e+Number((t-e)/3):t<n?n+Number((t-n)/3):t}},{key:"validateIndent",value:function(e){var t=this.state,i=t.min,i=void 0===i?0:i,t=t.max,t=void 0===t?0:t;return e<i?i:t<e?t:e}},{key:"isFullyVisible",get:function(){var e;return(null!=(e=this.state.layerWidth)?e:0)<=this.state.containerWidth}},{key:"getTarget",value:function(e){var t=this.state,n=t.slides,i=t.deltaX,r=t.shiftX,t=t.max,s=this.props.slideIndex,s=void 0===s?0:s,l=r+i+i/e.duration*240*.6-(void 0===t?0:t),r=i<0?1:-1,e=n.reduce(function(e,t,i){return Math.abs(n[e].coordX+l)<Math.abs(t.coordX+l)?e:i},s);return e=e===s&&0<=(t=s+r)&&t<n.length&&Math.abs(i)>.05*n[t].width?t:e}},{key:"canSlideLeft",get:function(){return!this.isFullyVisible&&this.state.shiftX<0}},{key:"canSlideRight",get:function(){var e=this.state,t=e.containerWidth,i=e.layerWidth,n=e.shiftX,e=e.slides,r=this.props,s=r.align,r=r.slideIndex;return!this.isFullyVisible&&("left"===s&&t-n<(void 0===i?0:i)||"left"!==s&&(void 0===r?0:r)<e.length-1)}},{key:"componentDidMount",value:function(){this.initializeSlides({animation:!1}),this.props.window.addEventListener("resize",this.onResize)}},{key:"componentDidUpdate",value:function(e){var t=this.props.slideWidth!==e.slideWidth,i=this.props!==e,n=React.Children.count(this.props.children)!==React.Children.count(e.children),r="custom"===this.props.slideWidth;t||n||r&&i?this.initializeSlides():this.props.slideIndex!==e.slideIndex&&this.setState({animation:!0,deltaX:0,shiftX:this.calculateIndent(null!=(t=this.props.slideIndex)?t:0)})}},{key:"componentWillUnmount",value:function(){this.props.window.removeEventListener("resize",this.onResize)}},{key:"render",value:function(){var i=this,e=this.state,t=e.animation,n=e.duration,e=e.dragging,r=this.props,s=r.children,l=r.slideWidth,o=r.slideIndex,a=void 0===o?0:o,o=(r.isDraggable,r.onDragStart,r.onDragEnd,r.onChange,r.onEnd,r.align),d=r.bullets,c=r.platform,h=r.hasMouse,u=r.showArrows,r=(r.window,r.document,r.getRef,r.getRootRef,_objectWithoutProperties(r,_excluded)),p=e?this.calculateDragIndent():this.calculateIndent(a),p={WebkitTransform:"translateX(".concat(p,"px)"),transform:"translateX(".concat(p,"px)"),WebkitTransition:t?"-webkit-transform ".concat(n,"s cubic-bezier(.1, 0, .25, 1)"):"none",transition:t?"transform ".concat(n,"s cubic-bezier(.1, 0, .25, 1)"):"none"};return createScopedElement("div",_extends({},r,{vkuiClass:classNames(getClassName("Gallery",c),"Gallery--".concat(o),{"Gallery--dragging":e,"Gallery--custom-width":"custom"===l}),ref:this.getRootRef}),createScopedElement(Touch,{vkuiClass:"Gallery__viewport",onStartX:this.onStart,onMoveX:this.onMoveX,onEnd:this.onEnd,noSlideClick:!0,style:{width:"custom"===l?"100%":l},getRootRef:this.getViewportRef},createScopedElement("div",{vkuiClass:"Gallery__layer",style:p},React.Children.map(s,function(e,t){return createScopedElement("div",{vkuiClass:"Gallery__slide",key:"slide-".concat(t),ref:i.getSlideRef(t)},e)}))),d&&createScopedElement("div",{"aria-hidden":"true",vkuiClass:classNames("Gallery__bullets","Gallery__bullets--".concat(d))},React.Children.map(s,function(e,t){return createScopedElement("div",{vkuiClass:classNames("Gallery__bullet",{"Gallery__bullet--active":t===a}),key:t})})),u&&h&&this.canSlideLeft&&createScopedElement(HorizontalScrollArrow,{direction:"left",onClick:this.slideLeft}),u&&h&&this.canSlideRight&&createScopedElement(HorizontalScrollArrow,{direction:"right",onClick:this.slideRight}))}}]),i}(React.Component),BaseGalleryAdaptive=(_defineProperty(BaseGallery,"defaultProps",{slideWidth:"100%",children:"",align:"left",bullets:!1,isDraggable:!0}),withAdaptivity(withDOM(BaseGallery),{hasMouse:!0})),Gallery=function(e){var t=e.initialSlideIndex,t=void 0===t?0:t,i=e.children,n=e.timeout,r=void 0===n?0:n,s=e.onChange,n=_objectWithoutProperties(e,_excluded2),e=React.useState(t),t=_slicedToArray(e,2),e=t[0],l=t[1],o="number"==typeof n.slideIndex,a=o?null!=(t=n.slideIndex)?t:0:e,t=!o||Boolean(s),e=React.Children.toArray(i).filter(function(e){return Boolean(e)}),d=e.length,c=React.useCallback(function(e){e!==a&&(o||l(e),s&&s(e))},[o,s,a]),h=useTimeout(function(){return c((a+1)%d)},r),u=(React.useEffect(function(){return r?h.set():h.clear()},[r,a,h]),0<d?clamp(a,0,d-1):a);return React.useEffect(function(){s&&u!==a&&s(u)},[s,u,a]),createScopedElement(BaseGalleryAdaptive,_extends({isDraggable:t},n,{slideIndex:u,onChange:c}),e)};export default withPlatform(Gallery);