import _extends from"@babel/runtime/helpers/extends";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _objectSpread from"@babel/runtime/helpers/objectSpread2";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inherits from"@babel/runtime/helpers/inherits";import _createSuper from"@babel/runtime/helpers/createSuper";import _defineProperty from"@babel/runtime/helpers/defineProperty";var _excluded=["popout","modal","platform","activePanel","splitCol","configProvider","history","id","nav","onTransition","onSwipeBack","onSwipeBackStart","onSwipeBackCancel","window","document","scroll","isBackCheck"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import{classNames}from"../../lib/classNames";import{transitionEvent,animationEvent}from"../../lib/supportEvents";import{getClassName}from"../../helpers/getClassName";import{IOS,ANDROID,VKCOM}from"../../lib/platform";import{Touch}from"../Touch/Touch";import{withPlatform}from"../../hoc/withPlatform";import{withContext}from"../../hoc/withContext";import{ConfigProviderContext}from"../ConfigProvider/ConfigProviderContext";import{SplitColContext}from"../SplitCol/SplitCol";import{AppRootPortal}from"../AppRoot/AppRootPortal";import{canUseDOM,withDOM}from"../../lib/dom";import{ScrollContext}from"../AppRoot/ScrollContext";import{NavTransitionProvider}from"../NavTransitionContext/NavTransitionContext";import{getNavId}from"../../lib/getNavId";import{warnOnce}from"../../lib/warnOnce";import{swipeBackExcluded}from"./utils";import"./View.css";var SwipeBackResults,warn=warnOnce("ViewInfinite"),scrollsCache=(!function(e){e[e.fail=1]="fail",e[e.success=2]="success"}(SwipeBackResults=SwipeBackResults||{}),{}),ViewInfiniteComponent=function(e){_inherits(i,e);var t=_createSuper(i);function i(e){var a;return _classCallCheck(this,i),a=t.call(this,e),_defineProperty(_assertThisInitialized(a),"scrolls",scrollsCache[getNavId(a.props,warn)]||{}),_defineProperty(_assertThisInitialized(a),"transitionFinishTimeout",void 0),_defineProperty(_assertThisInitialized(a),"animationFinishTimeout",void 0),_defineProperty(_assertThisInitialized(a),"panelNodes",{}),_defineProperty(_assertThisInitialized(a),"transitionEndHandler",function(e){e&&!["vkui-animation-ios-next-forward","vkui-animation-ios-prev-back","vkui-animation-view-next-forward","vkui-animation-view-prev-back"].includes(e.animationName)||null===a.state.prevPanel||a.flushTransition(a.state.prevPanel,Boolean(a.state.isBack))}),_defineProperty(_assertThisInitialized(a),"swipingBackTransitionEndHandler",function(e){if(!e||e.propertyName.includes("transform")&&e.target===a.pickPanel(a.state.swipeBackNextPanel))switch(a.state.swipeBackResult){case SwipeBackResults.fail:a.onSwipeBackCancel();break;case SwipeBackResults.success:a.onSwipeBackSuccess()}}),_defineProperty(_assertThisInitialized(a),"onMoveX",function(e){var t,i;!swipeBackExcluded(e)&&a.window&&(i=(t=a.props).platform,t=t.configProvider,i!==IOS||null!=t&&t.isWebView||!(e.startX<=70||e.startX>=a.window.innerWidth-70)||a.state.browserSwipe||a.setState({browserSwipe:!0}),i===IOS&&null!=t&&t.isWebView&&a.props.onSwipeBack&&(a.state.animated&&e.startX<=70||(e.startX<=70&&!a.state.swipingBack&&1<(null!=(t=null==(i=a.props.history)?void 0:i.length)?t:0)&&(null!==a.state.activePanel&&(i=a.scrolls[a.state.activePanel]||[],a.scrolls=_objectSpread(_objectSpread({},a.scrolls),{},_defineProperty({},a.state.activePanel,[].concat(_toConsumableArray(i),[null==(t=a.props.scroll)?void 0:t.getScroll().y])))),a.setState({swipingBack:!0,swipebackStartX:e.startX,swipeBackPrevPanel:a.state.activePanel,swipeBackNextPanel:a.props.history.slice(-2)[0]})),a.state.swipingBack&&(i=e.shiftX<0?0:e.shiftX>a.window.innerWidth-a.state.swipebackStartX?a.window.innerWidth:e.shiftX,a.setState({swipeBackShift:i})))))}),_defineProperty(_assertThisInitialized(a),"onEnd",function(e){a.state.swipingBack&&a.window&&(e=a.state.swipeBackShift/e.duration*1e3,0===a.state.swipeBackShift?a.onSwipeBackCancel():a.state.swipeBackShift>=a.window.innerWidth?a.onSwipeBackSuccess():250<e||a.state.swipebackStartX+a.state.swipeBackShift>a.window.innerWidth/2?a.setState({swipeBackResult:SwipeBackResults.success}):a.setState({swipeBackResult:SwipeBackResults.fail}))}),a.state={animated:!1,visiblePanels:[e.activePanel],activePanel:e.activePanel,isBack:void 0,prevPanel:null,nextPanel:null,swipingBack:!1,swipebackStartX:0,swipeBackShift:0,swipeBackNextPanel:null,swipeBackPrevPanel:null,swipeBackResult:null,browserSwipe:!1},a}return _createClass(i,[{key:"document",get:function(){return this.props.document}},{key:"window",get:function(){return this.props.window}},{key:"panels",get:function(){return React.Children.toArray(this.props.children)}},{key:"componentWillUnmount",value:function(){var e=getNavId(this.props);e&&(scrollsCache[e]=this.scrolls),this.animationFinishTimeout&&clearTimeout(this.animationFinishTimeout)}},{key:"componentDidUpdate",value:function(t,e){var i,a,s,n,o,r=this;this.props.popout&&!t.popout&&this.blurActiveElement(),this.props.modal&&!t.modal&&this.blurActiveElement(),t.activePanel===this.props.activePanel||e.swipingBack||e.browserSwipe||(o=!1,o=this.props.isBackCheck?this.props.isBackCheck({from:t.activePanel,to:this.props.activePanel}):this.panels.map(function(e){return getNavId(e.props,warn)}).find(function(e){return e===t.activePanel||e===r.props.activePanel})===this.props.activePanel,this.blurActiveElement(),n=this.scrolls[t.activePanel]||[],n=_objectSpread(_objectSpread({},this.scrolls),{},_defineProperty({},t.activePanel,[].concat(_toConsumableArray(n),[null==(n=this.props.scroll)?void 0:n.getScroll().y]))),this.scrolls=n,this.shouldDisableTransitionMotion()?this.flushTransition(t.activePanel,o):(this.setState({visiblePanels:[t.activePanel,this.props.activePanel],prevPanel:t.activePanel,nextPanel:this.props.activePanel,activePanel:null,animated:!0,isBack:o}),animationEvent.supported||(this.animationFinishTimeout&&clearTimeout(this.animationFinishTimeout),this.animationFinishTimeout=setTimeout(this.transitionEndHandler,this.props.platform===ANDROID||this.props.platform===VKCOM?300:600)))),t.activePanel!==this.props.activePanel&&e.swipingBack&&(i=this.state.swipeBackNextPanel,a=this.state.swipeBackPrevPanel,s=void 0,this.scrolls=_objectSpread({},this.scrolls),null!==a&&(n=_toConsumableArray(this.scrolls[a]||[]).slice(0,-1),this.scrolls[a]=n),null!==i&&(o=_toConsumableArray(this.scrolls[i]||[]),s=o.pop(),this.scrolls[i]=o),this.setState({swipeBackPrevPanel:null,swipeBackNextPanel:null,swipingBack:!1,swipeBackResult:null,swipebackStartX:0,swipeBackShift:0,activePanel:i,visiblePanels:[i]},function(){var e;null!=(e=r.props.scroll)&&e.scrollTo(0,s),t.onTransition&&t.onTransition({isBack:!0,from:a,to:i})})),!e.swipingBack&&this.state.swipingBack&&this.props.onSwipeBackStart&&this.props.onSwipeBackStart(),!e.swipeBackResult&&this.state.swipeBackResult&&this.waitTransitionFinish(this.pickPanel(this.state.swipeBackNextPanel),this.swipingBackTransitionEndHandler),e.swipeBackResult!==SwipeBackResults.fail||this.state.swipeBackResult||null===this.state.activePanel||(o=(n=_toConsumableArray(this.scrolls[this.state.activePanel]||[])).pop(),this.scrolls=_objectSpread(_objectSpread({},this.scrolls),{},_defineProperty({},this.state.activePanel,n)),null!=(e=this.props.scroll)&&e.scrollTo(0,o)),t.activePanel!==this.props.activePanel&&this.state.browserSwipe&&this.setState({browserSwipe:!1,nextPanel:null,prevPanel:null,animated:!1,visiblePanels:[this.props.activePanel],activePanel:this.props.activePanel})}},{key:"shouldDisableTransitionMotion",value:function(){var e;return!1===(null==(e=this.props.configProvider)?void 0:e.transitionMotionEnabled)||!(null!=(e=this.props.splitCol)&&e.animate)}},{key:"waitTransitionFinish",value:function(e,t){transitionEvent.supported&&transitionEvent.name&&e?(e.removeEventListener(transitionEvent.name,t),e.addEventListener(transitionEvent.name,t)):(this.transitionFinishTimeout&&clearTimeout(this.transitionFinishTimeout),this.transitionFinishTimeout=setTimeout(t,this.props.platform===ANDROID||this.props.platform===VKCOM?300:600))}},{key:"blurActiveElement",value:function(){var e;void 0!==this.window&&null!=(e=this.document)&&e.activeElement&&this.document.activeElement.blur()}},{key:"pickPanel",value:function(e){if(null!==e)return this.panelNodes[e]}},{key:"flushTransition",value:function(t,i){var e,a=this,s=this.props.activePanel,n=_toConsumableArray(this.scrolls[t]||[]).slice(0,-1),o=_toConsumableArray(this.scrolls[s]||[]),r=i?o.pop():0;i&&(this.scrolls=_objectSpread(_objectSpread({},this.scrolls),{},(_defineProperty(e={},t,n),_defineProperty(e,s,o),e))),this.setState({prevPanel:null,nextPanel:null,visiblePanels:[s],activePanel:s,animated:!1,isBack:void 0},function(){var e;null!=(e=a.props.scroll)&&e.scrollTo(0,i?r:0),a.props.onTransition&&a.props.onTransition({isBack:i,from:t,to:s})})}},{key:"onSwipeBackSuccess",value:function(){this.props.onSwipeBack&&this.props.onSwipeBack()}},{key:"onSwipeBackCancel",value:function(){this.props.onSwipeBackCancel&&this.props.onSwipeBackCancel(),this.setState({swipeBackPrevPanel:null,swipeBackNextPanel:null,swipingBack:!1,swipeBackResult:null,swipebackStartX:0,swipeBackShift:0})}},{key:"calcPanelSwipeStyles",value:function(e){if(!canUseDOM||!this.window)return{};var t=e===this.state.swipeBackPrevPanel,e=e===this.state.swipeBackNextPanel;if(!t&&!e||this.state.swipeBackResult)return{};var i="".concat(this.state.swipeBackShift,"px"),a="".concat(100*this.state.swipeBackShift/this.window.innerWidth/2-50,"%"),s=.3*(this.window.innerWidth-this.state.swipeBackShift)/this.window.innerWidth;return this.state.swipeBackResult?t?{boxShadow:"-2px 0 12px rgba(0, 0, 0, ".concat(s,")")}:{}:e?{transform:"translate3d(".concat(a,", 0, 0)"),WebkitTransform:"translate3d(".concat(a,", 0, 0)")}:t?{transform:"translate3d(".concat(i,", 0, 0)"),WebkitTransform:"translate3d(".concat(i,", 0, 0)"),boxShadow:"-2px 0 12px rgba(0, 0, 0, ".concat(s,")")}:{}}},{key:"render",value:function(){var n=this,e=this.props,t=e.popout,i=e.modal,a=e.platform,e=(e.activePanel,e.splitCol,e.configProvider,e.history,e.id,e.nav,e.onTransition,e.onSwipeBack,e.onSwipeBackStart,e.onSwipeBackCancel,e.window,e.document,e.scroll,e.isBackCheck,_objectWithoutProperties(e,_excluded)),s=this.state,o=s.prevPanel,r=s.nextPanel,l=s.activePanel,c=s.isBack,p=s.animated,h=s.swipeBackPrevPanel,u=s.swipeBackNextPanel,w=s.swipeBackResult,d=s.swipingBack,s=!!t,m=!!i,v=this.panels.filter(function(e){e=getNavId(e.props,warn);return void 0!==e&&n.state.visiblePanels.includes(e)||e===h||e===u}).sort(function(e){e=getNavId(e.props,warn);return e===r||e===u?d||n.state.isBack?-1:1:e===o||e===h?d||n.state.isBack?1:-1:0}),k=this.shouldDisableTransitionMotion(),k={"View--animated":!k&&this.state.animated,"View--swiping-back":!k&&this.state.swipingBack,"View--no-motion":k};return createScopedElement(Touch,_extends({Component:"section"},e,{vkuiClass:classNames(getClassName("View",a),k),onMoveX:this.onMoveX,onEnd:this.onEnd}),createScopedElement("div",{vkuiClass:"View__panels"},v.map(function(e){var t=getNavId(e.props,warn),i=t===o||t===h||t===u||t===r&&c,a=p&&t===(c?o:r),s=t&&n.scrolls[t]||[],s=s[s.length-1]||0;return createScopedElement("div",{vkuiClass:classNames("View__panel",{"View__panel--active":t===l,"View__panel--prev":t===o,"View__panel--next":t===r,"View__panel--swipe-back-prev":t===h,"View__panel--swipe-back-next":t===u,"View__panel--swipe-back-success":w===SwipeBackResults.success,"View__panel--swipe-back-failed":w===SwipeBackResults.fail}),onAnimationEnd:a?n.transitionEndHandler:void 0,ref:function(e){return void 0!==t&&(n.panelNodes[t]=e)},style:n.calcPanelSwipeStyles(t),key:t},createScopedElement("div",{vkuiClass:"View__panel-in",style:{marginTop:i?-s:void 0}},createScopedElement(NavTransitionProvider,{entering:t===r||t===u},e)))})),createScopedElement(AppRootPortal,null,s&&createScopedElement("div",{vkuiClass:"View__popout"},t),m&&createScopedElement("div",{vkuiClass:"View__modal"},i)))}}]),i}(React.Component),ViewInfinite=(_defineProperty(ViewInfiniteComponent,"defaultProps",{history:[]}),withContext(withContext(withContext(withPlatform(withDOM(ViewInfiniteComponent)),SplitColContext,"splitCol"),ConfigProviderContext,"configProvider"),ScrollContext,"scroll"));export{ViewInfinite};