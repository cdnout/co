import _extends from"@babel/runtime/helpers/extends";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inherits from"@babel/runtime/helpers/inherits";import _createSuper from"@babel/runtime/helpers/createSuper";import _defineProperty from"@babel/runtime/helpers/defineProperty";var SwipeBackResults,_excluded=["popout","modal","platform","activePanel","splitCol","configProvider","history","nav","onTransition","onSwipeBack","onSwipeBackStart","onSwipeBackCancel","window","document","scroll"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import{classNames}from"../../lib/classNames";import{transitionEvent,animationEvent}from"../../lib/supportEvents";import{getClassName}from"../../helpers/getClassName";import{IOS,ANDROID,VKCOM}from"../../lib/platform";import{Touch}from"../Touch/Touch";import{withPlatform}from"../../hoc/withPlatform";import{withContext}from"../../hoc/withContext";import{ConfigProviderContext}from"../ConfigProvider/ConfigProviderContext";import{SplitColContext}from"../SplitCol/SplitCol";import{AppRootPortal}from"../AppRoot/AppRootPortal";import{canUseDOM,withDOM}from"../../lib/dom";import{ScrollContext}from"../AppRoot/ScrollContext";import{NavTransitionProvider}from"../NavTransitionContext/NavTransitionContext";import{getNavId}from"../../lib/getNavId";import{warnOnce}from"../../lib/warnOnce";import{swipeBackExcluded}from"./utils";!function(e){e[e.fail=1]="fail",e[e.success=2]="success"}(SwipeBackResults=SwipeBackResults||{});var scrollsCache={},warn=warnOnce("View"),View=function(e){_inherits(i,e);var t=_createSuper(i);function i(e){var a;return _classCallCheck(this,i),a=t.call(this,e),_defineProperty(_assertThisInitialized(a),"scrolls",scrollsCache[getNavId(a.props)]||{}),_defineProperty(_assertThisInitialized(a),"transitionFinishTimeout",void 0),_defineProperty(_assertThisInitialized(a),"animationFinishTimeout",void 0),_defineProperty(_assertThisInitialized(a),"panelNodes",{}),_defineProperty(_assertThisInitialized(a),"transitionEndHandler",function(e){e&&!["vkui-animation-ios-next-forward","vkui-animation-ios-prev-back","vkui-animation-view-next-forward","vkui-animation-view-prev-back"].includes(e.animationName)||null===a.state.prevPanel||a.flushTransition(a.state.prevPanel,Boolean(a.state.isBack))}),_defineProperty(_assertThisInitialized(a),"swipingBackTransitionEndHandler",function(e){if(!e||null!=e&&e.propertyName.includes("transform")&&(null==e?void 0:e.target)===a.pickPanel(a.state.swipeBackNextPanel))switch(a.state.swipeBackResult){case SwipeBackResults.fail:a.onSwipeBackCancel();break;case SwipeBackResults.success:a.onSwipeBackSuccess()}}),_defineProperty(_assertThisInitialized(a),"onMoveX",function(e){var t,i;swipeBackExcluded(e)||(t=(i=a.props).platform,i=i.configProvider,t!==IOS||null!=i&&i.isWebView||!(e.startX<=70||e.startX>=a.window.innerWidth-70)||a.state.browserSwipe||a.setState({browserSwipe:!0}),t===IOS&&null!=i&&i.isWebView&&a.props.onSwipeBack&&(a.state.animated&&e.startX<=70||!a.window||(e.startX<=70&&!a.state.swipingBack&&1<(null!=(i=null==(t=a.props.history)?void 0:t.length)?i:0)&&(null!==a.state.activePanel&&(a.scrolls[a.state.activePanel]=null==(t=a.props.scroll)?void 0:t.getScroll().y),a.setState({swipingBack:!0,swipebackStartX:e.startX,swipeBackPrevPanel:a.state.activePanel,swipeBackNextPanel:a.props.history.slice(-2)[0]})),a.state.swipingBack&&(i=e.shiftX<(i=0)?0:e.shiftX>a.window.innerWidth-a.state.swipebackStartX?null==(t=a.window)?void 0:t.innerWidth:e.shiftX,a.setState({swipeBackShift:i})))))}),_defineProperty(_assertThisInitialized(a),"onEnd",function(e){var t;a.state.swipingBack&&a.window&&(e=a.state.swipeBackShift/e.duration*1e3,0===a.state.swipeBackShift?a.onSwipeBackCancel():a.state.swipeBackShift>=(null!=(t=null==(t=a.window)?void 0:t.innerWidth)?t:0)?a.onSwipeBackSuccess():250<e||a.state.swipebackStartX+a.state.swipeBackShift>a.window.innerWidth/2?a.setState({swipeBackResult:SwipeBackResults.success}):a.setState({swipeBackResult:SwipeBackResults.fail}))}),a.state={animated:!1,visiblePanels:[e.activePanel],activePanel:e.activePanel,isBack:void 0,prevPanel:null,nextPanel:null,swipingBack:!1,swipebackStartX:0,swipeBackShift:0,swipeBackNextPanel:null,swipeBackPrevPanel:null,swipeBackResult:null,browserSwipe:!1},a}return _createClass(i,[{key:"document",get:function(){return this.props.document}},{key:"window",get:function(){return this.props.window}},{key:"panels",get:function(){return React.Children.toArray(this.props.children)}},{key:"componentDidMount",value:function(){var e,t;"development"===process.env.NODE_ENV&&(e=(t=this.props).popout,t=t.modal,e&&warn("Свойство popout устарело и будет удалено в 5.0.0. Используйте одноименное свойство у SplitLayout."),t&&warn("Свойство modal устарело и будет удалено в 5.0.0. Используйте одноименное свойство у SplitLayout."))}},{key:"componentWillUnmount",value:function(){var e=getNavId(this.props);e&&(scrollsCache[e]=this.scrolls),this.animationFinishTimeout&&clearTimeout(this.animationFinishTimeout)}},{key:"componentDidUpdate",value:function(t,e){var i,a,n,s,o=this;this.props.popout&&!t.popout&&this.blurActiveElement(),this.props.modal&&!t.modal&&this.blurActiveElement(),t.activePanel===this.props.activePanel||e.swipingBack||e.browserSwipe||(i=this.panels.map(function(e){return getNavId(e.props,warn)}).find(function(e){return e===t.activePanel||e===o.props.activePanel})===this.props.activePanel,this.scrolls[t.activePanel]=null==(s=this.props.scroll)?void 0:s.getScroll().y,this.shouldDisableTransitionMotion()?this.flushTransition(t.activePanel,i):(this.blurActiveElement(),this.setState({visiblePanels:[t.activePanel,this.props.activePanel],prevPanel:t.activePanel,nextPanel:this.props.activePanel,activePanel:null,animated:!0,isBack:i}),animationEvent.supported||(this.animationFinishTimeout&&clearTimeout(this.animationFinishTimeout),this.animationFinishTimeout=setTimeout(this.transitionEndHandler,this.props.platform===ANDROID||this.props.platform===VKCOM?300:600)))),t.activePanel!==this.props.activePanel&&e.swipingBack&&(a=this.props.activePanel,n=t.activePanel,null!==e.swipeBackPrevPanel&&(this.scrolls[e.swipeBackPrevPanel]=0),this.setState({swipeBackPrevPanel:null,swipeBackNextPanel:null,swipingBack:!1,swipeBackResult:null,swipebackStartX:0,swipeBackShift:0,activePanel:a,visiblePanels:[a]},function(){var e;null!==o.state.activePanel&&null!=(e=o.props.scroll)&&e.scrollTo(0,o.scrolls[o.state.activePanel]),t.onTransition&&t.onTransition({isBack:!0,from:n,to:a})})),!e.swipingBack&&this.state.swipingBack&&this.props.onSwipeBackStart&&this.props.onSwipeBackStart(),!e.swipeBackResult&&this.state.swipeBackResult&&this.waitTransitionFinish(this.pickPanel(this.state.swipeBackNextPanel),this.swipingBackTransitionEndHandler),e.swipeBackResult!==SwipeBackResults.fail||this.state.swipeBackResult||null===this.state.activePanel||null!=(s=this.props.scroll)&&s.scrollTo(0,this.scrolls[this.state.activePanel]),t.activePanel!==this.props.activePanel&&this.state.browserSwipe&&this.setState({browserSwipe:!1,nextPanel:null,prevPanel:null,animated:!1,visiblePanels:[this.props.activePanel],activePanel:this.props.activePanel})}},{key:"shouldDisableTransitionMotion",value:function(){var e;return!1===(null==(e=this.props.configProvider)?void 0:e.transitionMotionEnabled)||!(null!=(e=this.props.splitCol)&&e.animate)}},{key:"waitTransitionFinish",value:function(e,t){transitionEvent.supported&&transitionEvent.name&&e?(e.removeEventListener(transitionEvent.name,t),e.addEventListener(transitionEvent.name,t)):(this.transitionFinishTimeout&&clearTimeout(this.transitionFinishTimeout),this.transitionFinishTimeout=setTimeout(t,this.props.platform===ANDROID||this.props.platform===VKCOM?300:600))}},{key:"blurActiveElement",value:function(){var e;void 0!==this.window&&null!=(e=this.document)&&e.activeElement&&this.document.activeElement.blur()}},{key:"pickPanel",value:function(e){if(null!==e)return this.panelNodes[e]}},{key:"flushTransition",value:function(t,i){var a=this,n=this.props.activePanel;i&&(this.scrolls[t]=0),this.setState({prevPanel:null,nextPanel:null,visiblePanels:[n],activePanel:n,animated:!1,isBack:void 0},function(){var e;null!=(e=a.props.scroll)&&e.scrollTo(0,i?a.scrolls[n]:0),a.props.onTransition&&a.props.onTransition({isBack:i,from:t,to:n})})}},{key:"onSwipeBackSuccess",value:function(){this.props.onSwipeBack&&this.props.onSwipeBack()}},{key:"onSwipeBackCancel",value:function(){this.props.onSwipeBackCancel&&this.props.onSwipeBackCancel(),this.setState({swipeBackPrevPanel:null,swipeBackNextPanel:null,swipingBack:!1,swipeBackResult:null,swipebackStartX:0,swipeBackShift:0})}},{key:"calcPanelSwipeStyles",value:function(e){if(!canUseDOM||!this.window)return{};var t=e===this.state.swipeBackPrevPanel,e=e===this.state.swipeBackNextPanel;if(!t&&!e||this.state.swipeBackResult)return{};var i="".concat(this.state.swipeBackShift,"px"),a="".concat(100*this.state.swipeBackShift/this.window.innerWidth/2-50,"%"),n=.3*(this.window.innerWidth-this.state.swipeBackShift)/this.window.innerWidth;return this.state.swipeBackResult?t?{boxShadow:"-2px 0 12px rgba(0, 0, 0, ".concat(n,")")}:{}:e?{transform:"translate3d(".concat(a,", 0, 0)"),WebkitTransform:"translate3d(".concat(a,", 0, 0)")}:t?{transform:"translate3d(".concat(i,", 0, 0)"),WebkitTransform:"translate3d(".concat(i,", 0, 0)"),boxShadow:"-2px 0 12px rgba(0, 0, 0, ".concat(n,")")}:{}}},{key:"render",value:function(){var n=this,e=this.props,t=e.popout,i=e.modal,a=e.platform,e=(e.activePanel,e.splitCol,e.configProvider,e.history,e.nav,e.onTransition,e.onSwipeBack,e.onSwipeBackStart,e.onSwipeBackCancel,e.window,e.document,e.scroll,_objectWithoutProperties(e,_excluded)),s=this.state,o=s.prevPanel,l=s.nextPanel,r=s.activePanel,p=s.swipeBackPrevPanel,c=s.swipeBackNextPanel,u=s.swipeBackResult,h=s.isBack,w=s.animated,s=!!t,d=!!i,v=this.panels.filter(function(e){e=getNavId(e.props,warn);return void 0!==e&&n.state.visiblePanels.includes(e)||e===p||e===c}),m=this.shouldDisableTransitionMotion(),m={"View--animated":!m&&w,"View--swiping-back":!m&&this.state.swipingBack,"View--no-motion":m};return createScopedElement(Touch,_extends({Component:"section"},e,{vkuiClass:classNames(getClassName("View",a),m),onMoveX:this.onMoveX,onEnd:this.onEnd}),createScopedElement("div",{vkuiClass:"View__panels"},v.map(function(e){var t=getNavId(e.props,warn),i=w&&t===(h?o:l),a=t===o||t===p||t===c||t===l&&h;return createScopedElement("div",{vkuiClass:classNames("View__panel",{"View__panel--active":t===r,"View__panel--prev":t===o,"View__panel--next":t===l,"View__panel--swipe-back-prev":t===p,"View__panel--swipe-back-next":t===c,"View__panel--swipe-back-success":u===SwipeBackResults.success,"View__panel--swipe-back-failed":u===SwipeBackResults.fail}),onAnimationEnd:i?n.transitionEndHandler:void 0,ref:function(e){return void 0!==t&&(n.panelNodes[t]=e)},style:n.calcPanelSwipeStyles(t),key:t},createScopedElement("div",{vkuiClass:"View__panel-in",style:{marginTop:a?-(null!=(i=n.scrolls[t])?i:0):void 0}},createScopedElement(NavTransitionProvider,{entering:t===l||t===c},e)))})),createScopedElement(AppRootPortal,null,s&&createScopedElement("div",{vkuiClass:"View__popout"},t),d&&createScopedElement("div",{vkuiClass:"View__modal"},i)))}}]),i}(React.Component);_defineProperty(View,"defaultProps",{history:[]});export default withContext(withContext(withContext(withPlatform(withDOM(View)),SplitColContext,"splitCol"),ConfigProviderContext,"configProvider"),ScrollContext,"scroll");export{scrollsCache};