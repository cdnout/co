import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import vkBridge from"@vkontakte/vk-bridge";import{canUseDOM,useDOM}from"../../lib/dom";import{ConfigProviderContext,WebviewType}from"./ConfigProviderContext";import{useIsomorphicLayoutEffect}from"../../lib/useIsomorphicLayoutEffect";import{useObjectMemo}from"../../hooks/useObjectMemo";import{noop}from"../../lib/utils";import{warnOnce}from"../../lib/warnOnce";import{normalizeScheme,Scheme}from"../../helpers/scheme";import{AppearanceProvider,generateVKUITokensClassName}from"../AppearanceProvider/AppearanceProvider";import{LocaleProviderContext}from"../LocaleProviderContext/LocaleProviderContext";import{platform as resolvePlatform}from"../../lib/platform";var warn=warnOnce("ConfigProvider");function useSchemeDetector(r,e){var o="inherit"===e,t=React.useCallback(function(){if(o&&canUseDOM&&r)return r.getAttribute("scheme")},[o,r]),i=React.useState(t()),i=_slicedToArray(i,2),n=i[0],a=i[1];return React.useEffect(function(){if(!o||!r)return noop;a(t());var e=new MutationObserver(function(){return a(t())});return e.observe(r,{attributes:!0,attributeFilter:["scheme"]}),function(){return e.disconnect()}},[t,o,r]),"inherit"===e?n:e}var deriveAppearance=function(e){return e===Scheme.SPACE_GRAY||e===Scheme.VKCOM_DARK?"dark":"light"},ConfigProvider=function(e){var r=e.children,o=e.webviewType,o=void 0===o?WebviewType.VKAPPS:o,t=e.isWebView,t=void 0===t?vkBridge.isWebView():t,i=e.transitionMotionEnabled,i=void 0===i||i,n=e.platform,a=void 0===n?resolvePlatform():n,n=e.hasNewTokens,n=void 0!==n&&n,c=e.appearance,m=e.scheme,e=e.locale,e=void 0===e?"ru":e,s=normalizeScheme({scheme:m,platform:a,appearance:c}),u=useDOM().document,l=null==u?void 0:u.body,u=(useIsomorphicLayoutEffect(function(){return"inherit"===s?noop:("development"===process.env.NODE_ENV&&null!=l&&l.hasAttribute("scheme")&&warn('<body scheme> was set before VKUI mount - did you forget scheme="inherit"?'),null!=l&&l.setAttribute("scheme",s),function(){return null==l?void 0:l.removeAttribute("scheme")})},[s]),useSchemeDetector(l,s)),p=deriveAppearance(u),u=(useIsomorphicLayoutEffect(function(){var e=generateVKUITokensClassName(a,p);return null!=l&&l.classList.add(e),function(){null!=l&&l.classList.remove(e)}},[a,p]),useObjectMemo({webviewType:o,isWebView:t,transitionMotionEnabled:i,hasNewTokens:n,platform:a,scheme:m,appearance:c||p}));return createScopedElement(ConfigProviderContext.Provider,{value:u},createScopedElement(LocaleProviderContext.Provider,{value:e},createScopedElement(AppearanceProvider,{appearance:u.appearance},r)))};export default ConfigProvider;