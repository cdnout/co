import _typeof from"@babel/runtime/helpers/typeof";import _extends from"@babel/runtime/helpers/extends";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _objectSpread from"@babel/runtime/helpers/objectSpread2";var _excluded=["option"],_excluded2=["style","onFocus","onKeyDown","className","fetching","renderOption","emptyText","getRef","getRootRef","disabled","placeholder","tabIndex","getOptionValue","getOptionLabel","showSelected","getNewOptionData","renderChip","popupDirection","creatable","filterFn","inputValue","creatableText","sizeY","closeAfterSelect","onChangeStart","after","options"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import{DropdownIcon}from"../DropdownIcon/DropdownIcon";import{classNames}from"../../lib/classNames";import{ChipsInput,chipsInputDefaultProps}from"../ChipsInput/ChipsInput";import{CustomSelectOption}from"../CustomSelectOption/CustomSelectOption";import{useChipsSelect}from"./useChipsSelect";import{withAdaptivity}from"../../hoc/withAdaptivity";import{noop}from"../../lib/utils";import{useDOM}from"../../lib/dom";import{Caption}from"../Typography/Caption/Caption";import{prefixClass}from"../../lib/prefixClass";import{useExternRef}from"../../hooks/useExternRef";import{useGlobalEventListener}from"../../hooks/useGlobalEventListener";import{defaultFilterFn}from"../../lib/select";import{CustomSelectDropdown}from"../CustomSelectDropdown/CustomSelectDropdown";var FOCUS_ACTION_NEXT="next",FOCUS_ACTION_PREV="prev",chipsSelectDefaultProps=_objectSpread(_objectSpread({},chipsInputDefaultProps),{},{emptyText:"Ничего не найдено",creatableText:"Создать значение",onChangeStart:noop,creatable:!1,fetching:!1,showSelected:!0,closeAfterSelect:!0,options:[],filterFn:defaultFilterFn,renderOption:function(e){e.option;e=_objectWithoutProperties(e,_excluded);return createScopedElement(CustomSelectOption,e)}}),ChipsSelectComponent=function(e){function o(e,t){e="number"!=typeof e?-1:e,t===FOCUS_ACTION_NEXT?e+=1:t===FOCUS_ACTION_PREV&&(e-=1),null!=N&&B(e,N)}var e=_objectSpread(_objectSpread({},chipsSelectDefaultProps),e),t=e.style,n=e.onFocus,r=e.onKeyDown,l=e.className,i=e.fetching,p=e.renderOption,a=e.emptyText,c=e.getRef,s=(e.getRootRef,e.disabled),j=e.placeholder,V=e.tabIndex,u=e.getOptionValue,f=e.getOptionLabel,L=(e.showSelected,e.getNewOptionData),M=e.renderChip,U=e.popupDirection,d=e.creatable,m=(e.filterFn,e.inputValue,e.creatableText),z=e.sizeY,h=e.closeAfterSelect,C=e.onChangeStart,W=(e.after,e.options,_objectWithoutProperties(e,_excluded2)),S=useDOM().document,b=React.useState(void 0),b=_slicedToArray(b,2),v=b[0],_=b[1],O=React.useRef(null),g=useExternRef(c),b=useChipsSelect(e),e=b.fieldValue,D=b.selectedOptions,R=void 0===D?[]:D,x=b.opened,y=b.setOpened,D=b.addOptionFromInput,E=b.filteredOptions,I=b.addOption,Y=b.handleInputChange,T=b.clearInput,w=b.focusedOption,F=b.setFocusedOption,N=b.focusedOptionIndex,P=b.setFocusedOptionIndex,A=Boolean(d&&m&&!E.length&&e),k=React.useRef([]).current,B=function(e,t){var o=E.length;e<0?e=o-1:o<=e&&(e=0),e!==t&&(function(e){var t,o,n,r=O.current,l=k[e];l&&r&&(t=r.offsetHeight,o=r.scrollTop,n=l.offsetTop,l=l.offsetHeight,1<arguments.length&&void 0!==arguments[1]&&arguments[1]?r.scrollTop=n-t/2+l/2:t+o<n+l?r.scrollTop=n-t+l:n<o&&(r.scrollTop=n))}(e),P(e))},b=(React.useEffect(function(){null!=N&&E[N]?F(E[N]):null!==N&&0!==N||F(null)},[N,E,F]),React.useEffect(function(){-1===(w?E.findIndex(function(e){return e.value===w.value}):-1)&&E.length&&!A&&h&&F(E[0])},[E,w,A,h,F]),useGlobalEventListener(S,"click",function(e){var t=g.current;t&&e.target!==t&&!t.contains(e.target)&&y(!1)}),null==v?void 0:v.includes("top")),S=React.useCallback(function(e){_(e)},[_]),v=React.useCallback(function(){P(null)},[P]);return createScopedElement("div",{vkuiClass:classNames("ChipsSelect","ChipsSelect--sizeY-".concat(z)),ref:g,style:t,className:l},createScopedElement(ChipsInput,_extends({},W,{tabIndex:V,value:R,inputValue:e,getNewOptionData:L,getOptionLabel:f,getOptionValue:u,renderChip:function(n){if(void 0===n)return null;return M(_objectSpread(_objectSpread({},n),{},{onRemove:function(e,t){var o;null!=e&&e.preventDefault(),null!=e&&e.stopPropagation(),null!=(o=n.onRemove)&&o.call(n,e,t)}}))},onFocus:function(e){y(!0),P(0),n(e)},onKeyDown:function(e){var t;r(e),"ArrowUp"!==e.key||e.defaultPrevented||(e.preventDefault(),x?o(N,FOCUS_ACTION_PREV):(y(!0),P(0))),"ArrowDown"!==e.key||e.defaultPrevented||(e.preventDefault(),x?o(N,FOCUS_ACTION_NEXT):(y(!0),P(0))),"Enter"===e.key&&!e.defaultPrevented&&x&&null!=N&&((t=E[N])?(C(e,t),e.defaultPrevented||(I(t),P(null),T(),h&&y(!1),e.preventDefault())):d||e.preventDefault()),["Escape","Tab"].includes(e.key)&&!e.defaultPrevented&&x&&y(!1)},placeholder:j,vkuiClass:classNames(x&&"ChipsSelect__open",b&&"ChipsSelect__open--popupDirectionTop"),getRef:c,disabled:s,onInputChange:Y,after:createScopedElement(DropdownIcon,null)})),x&&createScopedElement(CustomSelectDropdown,{targetRef:g,placement:U,scrollBoxRef:O,onPlacementChange:S,onMouseLeave:v,fetching:i,vkuiClass:"ChipsSelect__options"},A&&createScopedElement(CustomSelectOption,{hovered:0===N,onMouseDown:D,onMouseEnter:function(){return P(0)}},m),null!=E&&E.length||A||!a?E.map(function(t,o){var e=f(t),n=w&&u(t)===u(w),r=R.find(function(e){return u(e)===u(t)}),l=u(t);return createScopedElement(React.Fragment,{key:"".concat(_typeof(l),"-").concat(l)},p({className:prefixClass("ChipsSelect__option"),option:t,hovered:Boolean(n),children:e,selected:!!r,getRootRef:function(e){if(e)return k[o]=e},onMouseDown:function(e){null!=C&&C(e,t),e.defaultPrevented||(h&&y(!1),I(t),T())},onMouseEnter:function(){return P(o)}}))}):createScopedElement(Caption,{vkuiClass:"ChipsSelect__empty"},a)))},ChipsSelect=withAdaptivity(ChipsSelectComponent,{sizeY:!0});export{ChipsSelect};