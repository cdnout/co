import _extends from"@babel/runtime/helpers/extends";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inherits from"@babel/runtime/helpers/inherits";import _createSuper from"@babel/runtime/helpers/createSuper";import _defineProperty from"@babel/runtime/helpers/defineProperty";var _excluded=["children","onRefresh","isFetching","platform","window","document","scroll"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import{Touch}from"../Touch/Touch";import TouchRootContext from"../Touch/TouchContext";import FixedLayout from"../FixedLayout/FixedLayout";import{classNames}from"../../lib/classNames";import{IOS,ANDROID,VKCOM}from"../../lib/platform";import{getClassName}from"../../helpers/getClassName";import PullToRefreshSpinner from"./PullToRefreshSpinner";import{withPlatform}from"../../hoc/withPlatform";import{canUseDOM,withDOM}from"../../lib/dom";import{runTapticImpactOccurred}from"../../lib/taptic";import{withContext}from"../../hoc/withContext";import{ScrollContext}from"../AppRoot/ScrollContext";function cancelEvent(e){if(!e)return!1;for(;e.originalEvent;)e=e.originalEvent;return e.preventDefault&&e.cancelable&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1}var PullToRefresh=function(e){_inherits(r,e);var t=_createSuper(r);function r(e){var l;return _classCallCheck(this,r),l=t.call(this,e),_defineProperty(_assertThisInitialized(l),"params",void 0),_defineProperty(_assertThisInitialized(l),"contentRef",void 0),_defineProperty(_assertThisInitialized(l),"waitFetchingTimeout",void 0),_defineProperty(_assertThisInitialized(l),"onTouchStart",function(e){l.state.refreshing&&cancelEvent(e),l.setState({touchDown:!0})}),_defineProperty(_assertThisInitialized(l),"onWindowTouchMove",function(e){l.state.refreshing&&(e.preventDefault(),e.stopPropagation())}),_defineProperty(_assertThisInitialized(l),"onTouchMove",function(e){var t,r=e.isY,i=e.shiftY,o=l.params,n=o.start,o=o.max,s=null==(s=l.props.scroll)?void 0:s.getScroll().y,a=l.state,h=a.refreshing,c=a.watching,a=a.touchDown;c&&a?(cancelEvent(e),c=l.params.positionMultiplier,t=Math.max(0,i-l.state.touchY),c=-10<(t=Math.max(n,Math.min(l.params.maxY,n+t*c)))?80*Math.abs((t+10)/o):0,l.setState({spinnerY:t,spinnerProgress:Math.min(80,Math.max(0,c)),canRefresh:80<c,contentShift:2.3*(t+10)}),85<c&&!h&&l.props.platform===IOS&&l.runRefreshing()):r&&0===s&&0<i&&!h&&a&&(cancelEvent(e),l.setState({watching:!0,touchY:i,spinnerY:n,spinnerProgress:0}))}),_defineProperty(_assertThisInitialized(l),"onTouchEnd",function(){l.setState({watching:!1,touchDown:!1})}),_defineProperty(_assertThisInitialized(l),"onRefreshingFinish",function(){l.state.touchDown||l.resetRefreshingState()}),l.params={start:e.platform===ANDROID||e.platform===VKCOM?-45:-10,max:e.platform===ANDROID||e.platform===VKCOM?80:50,maxY:e.platform===ANDROID||e.platform===VKCOM?80:400,refreshing:e.platform===ANDROID||e.platform===VKCOM?50:36,positionMultiplier:e.platform===ANDROID||e.platform===VKCOM?1:.21},l.state={watching:!1,refreshing:!1,canRefresh:!1,touchDown:!1,touchY:0,spinnerY:l.params.start,spinnerProgress:0,contentShift:0},l.contentRef=React.createRef(),l}return _createClass(r,[{key:"document",get:function(){return this.props.document}},{key:"componentDidMount",value:function(){canUseDOM&&this.document.addEventListener("touchmove",this.onWindowTouchMove,{cancelable:!0,passive:!1})}},{key:"componentWillUnmount",value:function(){canUseDOM&&this.document.removeEventListener("touchmove",this.onWindowTouchMove,{cancelable:!0,passive:!1}),this.waitFetchingTimeout&&clearTimeout(this.waitFetchingTimeout)}},{key:"componentDidUpdate",value:function(e,t){e.isFetching&&!this.props.isFetching&&this.onRefreshingFinish(),!e.isFetching&&this.props.isFetching&&this.waitFetchingTimeout&&clearTimeout(this.waitFetchingTimeout),t.touchDown&&!this.state.touchDown&&(t=(e=this.state).refreshing,e=e.canRefresh,!t&&e?this.runRefreshing():t&&!this.props.isFetching?this.resetRefreshingState():this.setState({spinnerY:t?this.params.refreshing:this.params.start,spinnerProgress:0,contentShift:0}))}},{key:"runRefreshing",value:function(){!this.state.refreshing&&this.props.onRefresh&&(this.waitFetchingTimeout=setTimeout(this.onRefreshingFinish,1e3),this.setState({refreshing:!0,spinnerY:this.props.platform===ANDROID||this.props.platform===VKCOM?this.params.refreshing:this.state.spinnerY}),this.props.onRefresh(),runTapticImpactOccurred("light"))}},{key:"resetRefreshingState",value:function(){this.setState({watching:!1,canRefresh:!1,refreshing:!1,spinnerY:this.params.start,spinnerProgress:0,contentShift:0})}},{key:"render",value:function(){var e=this.props,t=e.children,r=(e.onRefresh,e.isFetching,e.platform),e=(e.window,e.document,e.scroll,_objectWithoutProperties(e,_excluded)),i=this.state,o=i.watching,n=i.refreshing,s=i.spinnerY,a=i.spinnerProgress,h=i.canRefresh,c=i.touchDown,i=i.contentShift,s="translate3d(0, ".concat(s,"px, 0)"),l="";return r===IOS&&n&&!c?l="translate3d(0, 100px, 0)":r===IOS&&(i||n)&&(l="translate3d(0, ".concat(i,"px, 0)")),createScopedElement(TouchRootContext.Provider,{value:!0},createScopedElement(Touch,_extends({},e,{onStart:this.onTouchStart,onMove:this.onTouchMove,onEnd:this.onTouchEnd,vkuiClass:classNames(getClassName("PullToRefresh",r),{"PullToRefresh--watching":o,"PullToRefresh--refreshing":n})}),createScopedElement(FixedLayout,{vkuiClass:"PullToRefresh__controls"},createScopedElement(PullToRefreshSpinner,{style:{transform:s,WebkitTransform:s,opacity:o||n||h?1:0},on:n,progress:n?void 0:a})),createScopedElement("div",{vkuiClass:"PullToRefresh__content",ref:this.contentRef,style:{transform:l,WebkitTransform:l}},t)))}}]),r}(React.PureComponent);export default withContext(withPlatform(withDOM(PullToRefresh)),ScrollContext,"scroll");