import _extends from"@babel/runtime/helpers/extends";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import _assertThisInitialized from"@babel/runtime/helpers/assertThisInitialized";import _inherits from"@babel/runtime/helpers/inherits";import _createSuper from"@babel/runtime/helpers/createSuper";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _typeof from"@babel/runtime/helpers/typeof";var _excluded=["searchable","name","className","getRef","getRootRef","popupDirection","options","sizeY","platform","style","onChange","onBlur","onFocus","onClick","renderOption","children","emptyText","onInputChange","filterFn","renderDropdown","onOpen","onClose","fetching","icon","dropdownOffsetDistance","fixDropdownWidth","forceDropdownPortal","selectType"],_excluded2=["option"];import{createScopedElement}from"../../lib/jsxRuntime";import*as React from"react";import SelectMimicry from"../SelectMimicry/SelectMimicry";import{debounce,setRef,multiRef}from"../../lib/utils";import{classNames}from"../../lib/classNames";import{withAdaptivity}from"../../hoc/withAdaptivity";import{withPlatform}from"../../hoc/withPlatform";import{CustomSelectOption}from"../CustomSelectOption/CustomSelectOption";import{getClassName}from"../../helpers/getClassName";import{Input}from"../Input/Input";import{DropdownIcon}from"../DropdownIcon/DropdownIcon";import{Caption}from"../Typography/Caption/Caption";import{warnOnce}from"../../lib/warnOnce";import{defaultFilterFn}from"../../lib/select";import{is}from"../../lib/is";import{CustomSelectDropdown}from"../CustomSelectDropdown/CustomSelectDropdown";var SelectType,findIndexAfter=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;return n>=e.length-1?-1:e.findIndex(function(e,t){return n<t&&!e.disabled})},findIndexBefore=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:e.length,n=-1;if(void 0===e||t<=0)return n;for(var o=t-1;0<=o;o--)if(!e[o].disabled){n=o;break}return n},warn=warnOnce("CustomSelect"),checkOptionsValueType=function(e){1<new Set(e.map(function(e){return _typeof(e.value)})).size&&warn("Some values of your options have different types. CustomSelect onChange always returns a string type.","error")},CustomSelectComponent=(!function(e){e.Default="default",e.Plain="plain"}(SelectType=SelectType||{}),function(e){_inherits(i,e);var o=_createSuper(i);function i(e){_classCallCheck(this,i),r=o.call(this,e),_defineProperty(_assertThisInitialized(r),"keyboardInput",void 0),_defineProperty(_assertThisInitialized(r),"isControlledOutside",!1),_defineProperty(_assertThisInitialized(r),"selectEl",null),_defineProperty(_assertThisInitialized(r),"scrollBoxRef",React.createRef()),_defineProperty(_assertThisInitialized(r),"containerRef",React.createRef()),_defineProperty(_assertThisInitialized(r),"resetKeyboardInput",function(){r.keyboardInput=""}),_defineProperty(_assertThisInitialized(r),"getSelectedItem",function(){var e=r.state,t=e.selectedOptionIndex,e=e.options;return null!=e&&e.length?void 0!==t?e[t]:void 0:null}),_defineProperty(_assertThisInitialized(r),"filter",function(e,t,n){return"function"==typeof n?e.filter(function(e){return n(t,e)}):e}),_defineProperty(_assertThisInitialized(r),"open",function(){r.setState(function(e){return{opened:!0,focusedOptionIndex:e.selectedOptionIndex}},function(){var e=r.state.selectedOptionIndex;void 0!==e&&r.isValidIndex(e)&&r.scrollToElement(e,!0)}),"function"==typeof r.props.onOpen&&r.props.onOpen()}),_defineProperty(_assertThisInitialized(r),"close",function(){r.resetKeyboardInput(),r.setState(function(){return{inputValue:"",opened:!1,focusedOptionIndex:-1,options:r.props.options}}),"function"==typeof r.props.onClose&&r.props.onClose()}),_defineProperty(_assertThisInitialized(r),"selectFocused",function(){var e=r.state.focusedOptionIndex;void 0!==e&&r.select(e)}),_defineProperty(_assertThisInitialized(r),"select",function(e){var t;r.isValidIndex(e)&&(t=null==(t=r.state.options)?void 0:t[e],r.setState({nativeSelectValue:null==t?void 0:t.value},function(){var e,t=new Event("change",{bubbles:!0});null!=(e=r.selectEl)&&e.dispatchEvent(t)}),r.close())}),_defineProperty(_assertThisInitialized(r),"onClick",function(){r.state.opened?r.close():r.open()}),_defineProperty(_assertThisInitialized(r),"onFocus",function(){var e,t=new Event("focus");null!=(e=r.selectEl)&&e.dispatchEvent(t)}),_defineProperty(_assertThisInitialized(r),"onBlur",function(){r.close();var e,t=new Event("blur");null!=(e=r.selectEl)&&e.dispatchEvent(t)}),_defineProperty(_assertThisInitialized(r),"focusOptionByIndex",function(t){var e;void 0===t||t<0||t>(null!=(e=null==(e=r.state.options)?void 0:e.length)?e:0)-1||(null!=(e=null==(e=r.state.options)?void 0:e[t])&&e.disabled||(1<arguments.length&&void 0!==arguments[1]&&!arguments[1]||r.scrollToElement(t),r.setState(function(e){return e.focusedOptionIndex!==t?{focusedOptionIndex:t}:null})))}),_defineProperty(_assertThisInitialized(r),"focusOption",function(e){var t,n=r.state.focusedOptionIndex;"next"===e?n=-1===(t=findIndexAfter(r.state.options,n))?findIndexAfter(r.state.options):t:"prev"===e&&(n=-1===(t=findIndexBefore(r.state.options,n))?findIndexBefore(r.state.options):t),r.focusOptionByIndex(n)}),_defineProperty(_assertThisInitialized(r),"handleOptionHover",function(e){var t;r.focusOptionByIndex(Array.prototype.indexOf.call(null==(t=e.currentTarget.parentNode)?void 0:t.children,e.currentTarget),!1)}),_defineProperty(_assertThisInitialized(r),"handleOptionDown",function(e){e.preventDefault()}),_defineProperty(_assertThisInitialized(r),"handleOptionClick",function(e){var t=Array.prototype.indexOf.call(null==(t=e.currentTarget.parentNode)?void 0:t.children,e.currentTarget),e=null==(e=r.state.options)?void 0:e[t];e&&!e.disabled&&r.selectFocused()}),_defineProperty(_assertThisInitialized(r),"resetFocusedOption",function(){r.setState({focusedOptionIndex:-1})}),_defineProperty(_assertThisInitialized(r),"onKeyboardInput",function(e){var t=r.keyboardInput+e,e=null==(e=r.state.options)?void 0:e.findIndex(function(e){return e.label.toLowerCase().includes(t)});void 0!==e&&-1<e&&r.focusOptionByIndex(e),r.keyboardInput=t}),_defineProperty(_assertThisInitialized(r),"onLabelClick",function(e){var t;null!=(t=r.scrollBoxRef.current)&&t.contains(e.target)&&e.preventDefault()}),_defineProperty(_assertThisInitialized(r),"onNativeSelectChange",function(e){var t,n=r.findSelectedIndex(r.state.options,e.currentTarget.value);r.state.selectedOptionIndex!==n&&(r.isControlledOutside||r.setState({selectedOptionIndex:n}),null!=(t=(n=r.props).onChange)&&t.call(n,e))}),_defineProperty(_assertThisInitialized(r),"onInputChange",function(e){var t;r.props.onInputChange?(t=r.props.onInputChange(e,r.props.options))?("development"===process.env.NODE_ENV&&warn("This filtration method is deprecated. Return value of onInputChange will be ignored in v5.0.0. For custom filtration please update props.options by yourself or use filterFn property"),r.setState({options:t,selectedOptionIndex:r.findSelectedIndex(t,r.state.nativeSelectValue),inputValue:e.target.value})):r.setState({inputValue:e.target.value}):(t=r.filter(r.props.options,e.target.value,r.props.filterFn),r.setState({options:t,selectedOptionIndex:r.findSelectedIndex(t,r.state.nativeSelectValue),inputValue:e.target.value}))}),_defineProperty(_assertThisInitialized(r),"onInputKeyDown",function(e){switch(["ArrowUp","ArrowDown","Escape","Enter"].includes(e.key)&&r.areOptionsShown&&e.preventDefault(),e.key){case"ArrowUp":r.areOptionsShown&&r.focusOption("prev");break;case"ArrowDown":r.areOptionsShown&&r.focusOption("next");break;case"Escape":r.close();break;case"Enter":r.areOptionsShown&&r.selectFocused()}}),_defineProperty(_assertThisInitialized(r),"handleKeyDownSelect",function(e){var t=r.state.opened;if(1===e.key.length&&" "!==e.key)r.onKeyboardInput(e.key);else switch(["ArrowUp","ArrowDown","Escape","Enter"].includes(e.key)&&r.areOptionsShown&&e.preventDefault(),e.key){case"ArrowUp":t?r.areOptionsShown&&r.focusOption("prev"):r.open();break;case"ArrowDown":t?r.areOptionsShown&&r.focusOption("next"):r.open();break;case"Escape":r.close();break;case"Enter":case"Spacebar":case" ":t?r.areOptionsShown&&r.selectFocused():r.open()}}),_defineProperty(_assertThisInitialized(r),"handleKeyUp",debounce(r.resetKeyboardInput,1e3)),_defineProperty(_assertThisInitialized(r),"renderOption",function(e,t){var n=r.state,o=n.focusedOptionIndex,n=n.selectedOptionIndex,i=r.props.renderOption,o=t===o,t=t===n;return createScopedElement(React.Fragment,{key:"".concat(e.value)},i({option:e,hovered:o,children:e.label,selected:t,disabled:e.disabled,onClick:r.handleOptionClick,onMouseDown:r.handleOptionDown,onMouseOver:r.handleOptionHover}))}),_defineProperty(_assertThisInitialized(r),"selectRef",function(e){r.selectEl=e,r.props.getRef&&setRef(e,r.props.getRef)}),_defineProperty(_assertThisInitialized(r),"onPlacementChange",function(e){r.setState(function(){return{popperPlacement:e}})});var r,t=e.value,n=e.defaultValue,t=void 0!==t?t:n;return r.keyboardInput="","development"===process.env.NODE_ENV&&checkOptionsValueType(e.options),r.state={opened:!1,focusedOptionIndex:-1,selectedOptionIndex:r.findSelectedIndex(e.options,t),nativeSelectValue:t,options:e.options,inputValue:""},void 0!==e.value&&(r.isControlledOutside=!0),r}return _createClass(i,[{key:"areOptionsShown",get:function(){return null!==this.scrollBoxRef.current}},{key:"findSelectedIndex",value:function(e,t){return null!=(e=null==e?void 0:e.findIndex(function(e){return t="number"==typeof e.value?Number(t):t,e.value===t}))?e:-1}},{key:"isValidIndex",value:function(e){return 0<=e&&e<(null!=(e=null==(e=this.state.options)?void 0:e.length)?e:0)}},{key:"scrollToElement",value:function(e){var t,n,o,i=this.scrollBoxRef.current,r=i?i.children[e]:null;r&&i&&(t=i.offsetHeight,n=i.scrollTop,o=r.offsetTop,r=r.offsetHeight,1<arguments.length&&void 0!==arguments[1]&&arguments[1]?i.scrollTop=o-t/2+r/2:t+n<o+r?i.scrollTop=o-t+r:o<n&&(i.scrollTop=o))}},{key:"componentDidUpdate",value:function(e){var t;is(e.value,this.props.value)&&e.options===this.props.options||("development"===process.env.NODE_ENV&&checkOptionsValueType(this.props.options),this.isControlledOutside=void 0!==this.props.value,e=void 0===this.props.value?this.state.nativeSelectValue:this.props.value,t=this.props.searchable&&void 0!==this.state.inputValue?this.filter(this.props.options,this.state.inputValue,this.props.filterFn):this.props.options,this.setState({nativeSelectValue:e,selectedOptionIndex:this.findSelectedIndex(t,e),options:t}))}},{key:"render",value:function(){var e=this.state,t=e.opened,n=e.nativeSelectValue,e=e.options,o=this.props,i=o.searchable,r=o.name,s=o.className,l=(o.getRef,o.getRootRef),a=o.popupDirection,p=o.options,c=(o.sizeY,o.platform),d=o.style,u=(o.onChange,o.onBlur),f=o.onFocus,h=o.onClick,m=(o.renderOption,o.children,o.emptyText,o.onInputChange,o.filterFn,o.renderDropdown),v=(o.onOpen,o.onClose,o.fetching),y=o.icon,_=o.dropdownOffsetDistance,I=o.fixDropdownWidth,C=o.forceDropdownPortal,S=o.selectType,o=_objectWithoutProperties(o,_excluded),O=this.getSelectedItem(),O=O?O.label:void 0,e=void 0!==e&&0<e.length?e.map(this.renderOption):createScopedElement(Caption,{vkuiClass:"CustomSelect__empty"},this.props.emptyText),m="function"==typeof m?m({defaultDropdownContent:e}):e,e=null==(e=this.state.popperPlacement)?void 0:e.includes("top");return createScopedElement("label",{vkuiClass:getClassName("CustomSelect",c),className:s,style:d,ref:multiRef(this.containerRef,l),onClick:this.onLabelClick},t&&i?createScopedElement(Input,_extends({},o,{autoFocus:!0,onBlur:this.onBlur,vkuiClass:classNames(t&&"CustomSelect__open",e&&"CustomSelect__open--popupDirectionTop",0<_&&"CustomSelect__open--not-adjacent"),value:this.state.inputValue,onKeyDown:this.onInputKeyDown,onChange:this.onInputChange,onClick:h,after:y,placeholder:o.placeholder})):createScopedElement(SelectMimicry,_extends({},o,{"aria-hidden":!0,onClick:this.onClick,onKeyDown:this.handleKeyDownSelect,onKeyUp:this.handleKeyUp,onFocus:this.onFocus,onBlur:this.onBlur,vkuiClass:classNames(t&&"CustomSelect__open",e&&"CustomSelect__open--popupDirectionTop",0<_&&"CustomSelect__open--not-adjacent"),after:y,selectType:S}),O),createScopedElement("select",{ref:this.selectRef,name:r,onChange:this.onNativeSelectChange,onBlur:u,onFocus:f,onClick:h,value:n,"aria-hidden":!0,vkuiClass:"CustomSelect__control"},p.map(function(e){return createScopedElement("option",{key:"".concat(e.value),value:e.value})})),t&&createScopedElement(CustomSelectDropdown,{targetRef:this.containerRef,placement:a,scrollBoxRef:this.scrollBoxRef,onPlacementChange:this.onPlacementChange,onMouseLeave:this.resetFocusedOption,fetching:v,offsetDistance:_,sameWidth:I,forcePortal:C},m))}}]),i}(React.Component)),CustomSelect=(_defineProperty(CustomSelectComponent,"defaultProps",{searchable:!1,renderOption:function(e){e.option;e=_objectWithoutProperties(e,_excluded2);return createScopedElement(CustomSelectOption,e)},options:[],emptyText:"Ничего не найдено",filterFn:defaultFilterFn,icon:createScopedElement(DropdownIcon,null),dropdownOffsetDistance:0,fixDropdownWidth:!0,selectType:SelectType.Default}),withPlatform(withAdaptivity(CustomSelectComponent,{sizeY:!0})));export{SelectType,CustomSelect};