"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault").default,_interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard").default,_jsxRuntime=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModalRootTouch=void 0,require("../../lib/jsxRuntime")),_objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread2")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_createSuper2=_interopRequireDefault(require("@babel/runtime/helpers/createSuper")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),React=_interopRequireWildcard(require("react")),_Touch=require("../Touch/Touch"),_TouchContext=_interopRequireDefault(require("../Touch/TouchContext")),_getClassName=require("../../helpers/getClassName"),_classNames=require("../../lib/classNames"),_styles=require("../../lib/styles"),_touch=require("../../lib/touch"),_platform=require("../../lib/platform"),_supportEvents=require("../../lib/supportEvents"),_withPlatform=require("../../hoc/withPlatform"),_withContext=require("../../hoc/withContext"),_ModalRootContext=_interopRequireDefault(require("./ModalRootContext")),_ConfigProviderContext=require("../ConfigProvider/ConfigProviderContext"),_types=require("./types"),_constants=require("./constants"),_dom=require("../../lib/dom"),_getNavId=require("../../lib/getNavId"),_warnOnce=require("../../lib/warnOnce"),_FocusTrap=require("../FocusTrap/FocusTrap"),_useModalManager=require("./useModalManager"),_excluded=["id"],warn=(0,_warnOnce.warnOnce)("ModalRoot"),IS_DEV="development"===process.env.NODE_ENV;function numberInRange(e,t){return!!t&&(e>=t[0]&&e<=t[1])}function rangeTranslate(e){return Math.max(0,Math.min(98,e))}var ModalRootTouchComponent=function(e){(0,_inherits2.default)(n,e);var t=(0,_createSuper2.default)(n);function n(e){var a;return(0,_classCallCheck2.default)(this,n),a=t.call(this,e),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"documentScrolling",!1),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"maskElementRef",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"viewportRef",React.createRef()),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"maskAnimationFrame",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"modalRootContext",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"frameIds",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"restoreFocusTo",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"preventTouch",function(e){if(!e)return!1;for(;e.originalEvent;)e=e.originalEvent;return e.preventDefault&&e.preventDefault(),!1}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"updateModalTranslate",function(){var e=a.getModalState(a.props.activeModal);e&&a.animateTranslate(e,e.translateY)}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"updateModalHeight",function(){var e=a.getModalState(a.props.activeModal);e&&e.type===_types.ModalType.PAGE&&e.dynamicContentHeight&&(a.props.enteringModal?a.waitTransitionFinish(e,function(){requestAnimationFrame(function(){return a.checkPageContentHeight()})}):requestAnimationFrame(function(){return a.checkPageContentHeight()}))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"onTouchMove",function(e){if(!a.props.exitingModal){var t=a.getModalState(a.props.activeModal);if(t)return t.type===_types.ModalType.PAGE?a.onPageTouchMove(e,t):t.type===_types.ModalType.CARD?a.onCardTouchMove(e,t):void 0}}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"onTouchEnd",function(e){var t=a.getModalState(a.props.activeModal);return(null==t?void 0:t.type)===_types.ModalType.PAGE?a.onPageTouchEnd(e,t):(null==t?void 0:t.type)===_types.ModalType.CARD?a.onCardTouchEnd(e,t):void 0}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"onScroll",function(e){var t,n=a.props.activeModal,e=e.target;!n||(null==(t=a.getModalState(n))?void 0:t.type)===_types.ModalType.PAGE&&null!=t&&null!=(n=t.contentElement)&&n.contains(e)&&(t.contentScrolled=!0,t.contentScrollStopTimeout&&clearTimeout(t.contentScrollStopTimeout),t.contentScrollStopTimeout=setTimeout(function(){t.contentScrolled&&(t.contentScrolled=!1)},250))}),a.state={touchDown:!1,dragging:!1},a.maskElementRef=React.createRef(),a.modalRootContext={updateModalHeight:a.updateModalHeight,registerModal:function(e){var t=e.id,e=(0,_objectWithoutProperties2.default)(e,_excluded);return Object.assign(a.getModalState(t),e)},onClose:function(){return a.props.onExit()},isInsideModal:!0},a.frameIds={},a}return(0,_createClass2.default)(n,[{key:"timeout",get:function(){return this.props.platform===_platform.ANDROID||this.props.platform===_platform.VKCOM?320:400}},{key:"document",get:function(){return this.props.document}},{key:"window",get:function(){return this.props.window}},{key:"getModalState",value:function(e){if(e)return this.props.getModalState(e)}},{key:"getModals",value:function(){return React.Children.toArray(this.props.children)}},{key:"componentDidMount",value:function(){var e;this.props.platform===_platform.IOS&&null!=(e=this.window)&&e.addEventListener("resize",this.updateModalTranslate,!1)}},{key:"componentWillUnmount",value:function(){this.toggleDocumentScrolling(!0),this.window.removeEventListener("resize",this.updateModalTranslate,!1)}},{key:"componentDidUpdate",value:function(e){var t,n,a=this;this.props.exitingModal&&this.props.exitingModal!==e.exitingModal&&this.closeModal(this.props.exitingModal),this.props.enteringModal&&this.props.enteringModal!==e.enteringModal&&(t=this.props.enteringModal,n=this.getModalState(t),this.props.onEnter(),this.waitTransitionFinish(n,function(){null!=n&&n.innerElement&&(n.innerElement.style.transitionDelay=""),a.props.onEntered(t)}),null!=n&&n.innerElement&&(n.innerElement.style.transitionDelay=this.props.delayEnter?"".concat(this.timeout,"ms"):"",this.animateTranslate(n,n.translateY))),this.props.activeModal&&!e.activeModal&&(this.restoreFocusTo=this.document.activeElement),this.props.activeModal||this.props.exitingModal||!this.restoreFocusTo||(this.restoreFocusTo.focus(),this.restoreFocusTo=null),this.toggleDocumentScrolling(!this.props.activeModal&&!this.props.exitingModal)}},{key:"toggleDocumentScrolling",value:function(e){this.documentScrolling!==e&&((this.documentScrolling=e)?this.window.removeEventListener("touchmove",this.preventTouch,{passive:!1}):this.window.addEventListener("touchmove",this.preventTouch,{passive:!1}))}},{key:"checkPageContentHeight",value:function(){var e,t,n,a=this.getModalState(this.props.activeModal);(null==a?void 0:a.type)===_types.ModalType.PAGE&&null!=a&&a.modalElement&&(e=(0,_objectSpread2.default)({},a),initPageModal(a),t=(0,_objectSpread2.default)({},a),n=!1,(n=e.expandable!==t.expandable||e.translateYFrom!==t.translateYFrom?!0:n)&&this.animateTranslate(a,a.translateY))}},{key:"closeModal",value:function(e){var t,n,a,o=this,i=(this.setState({touchDown:!1}),this.getModalState(e));i?(a=!!(t=this.getModalState(this.props.activeModal))&&t.type===_types.ModalType.PAGE,n=!!i&&i.type===_types.ModalType.PAGE,this.waitTransitionFinish(i,function(){return o.props.onExited(e)}),a=n&&a&&(null!=(n=i.translateY)?n:0)<=(null!=(a=null==t?void 0:t.translateYFrom)?a:0)&&!this.props.isBack?(null!=(n=null==t?void 0:t.translateYFrom)?n:0)+10:100,this.animateTranslate(i,a),t||this.setMaskOpacity(i,0)):e&&warn("closeActiveModal: Modal ".concat(e," does not exist - not closing"),"error")}},{key:"onPageTouchMove",value:function(e,t){var n=e.shiftY,a=e.originalEvent,o=a.target;if(e.isY){if(null==(e=t.innerElement)||!e.contains(o))return a.preventDefault();a.stopPropagation();var i,e=t.expandable,r=t.contentScrolled,l=t.collapsed,s=t.expanded;this.state.touchDown||(t.touchStartContentScrollTop=null==(i=t.contentElement)?void 0:i.scrollTop,this.setState({touchDown:!0})),r||(null===t.touchMovePositive&&(t.touchMovePositive=0<n),(!t.expandable||l||s&&t.touchMovePositive&&0===t.touchStartContentScrollTop||null!=(i=t.headerElement)&&i.contains(o))&&(a.preventDefault(),!e&&n<0||!this.window||(this.state.dragging||this.setState({dragging:!0}),r=n/this.window.innerHeight*100,l=(0,_touch.rubber)(r,72,.8,this.props.platform===_platform.ANDROID||this.props.platform===_platform.VKCOM),t.touchShiftYPercent=r,t.translateYCurrent=rangeTranslate((null!=(s=t.translateY)?s:0)+l),this.animateTranslate(t,t.translateYCurrent),this.setMaskOpacity(t))))}else null!=(i=this.viewportRef.current)&&i.contains(o)&&a.preventDefault()}},{key:"onCardTouchMove",value:function(e,t){var n,a=e.originalEvent,e=e.shiftY,a=a.target;null!=(n=t.innerElement)&&n.contains(a)&&(this.state.touchDown||this.setState({touchDown:!0,dragging:!0}),n=e/t.innerElement.offsetHeight*100,a=(0,_touch.rubber)(n,72,1.2,this.props.platform===_platform.ANDROID||this.props.platform===_platform.VKCOM),t.touchShiftYPercent=n,t.translateYCurrent=Math.max(0,(null!=(e=t.translateY)?e:0)+a),this.animateTranslate(t,t.translateYCurrent),this.setMaskOpacity(t))}},{key:"onPageTouchEnd",value:function(e,t){var n,a=this,o=e.startY,i=e.shiftY;t.contentScrolled=!1,t.touchMovePositive=null,this.state.dragging&&this.window&&(o=(o+i)/this.window.innerHeight*100,i=rangeTranslate((i=null!=(i=t.translateYCurrent)?i:0)+i/e.duration*240*.6*((null!=(e=t.touchShiftYPercent)?e:0)<0?-1:1)),i=100!==t.settlingHeight?numberInRange(i,t.expandedRange)?null!=(e=null==(e=t.expandedRange)?void 0:e[0])?e:0:numberInRange(i,t.collapsedRange)?null!=(e=t.translateYFrom)?e:0:numberInRange(i,t.hiddenRange)?100:null!=(e=t.translateYFrom)?e:0:numberInRange(i,[0,25])?0:100,t.translateY=i=100!==i&&75<=o?100:i,t.translateYCurrent=i,t.collapsed=0<i&&i<o,t.expanded=0===i,t.hidden=100===i,t.hidden&&this.props.onExit(),n=function(){t.hidden||a.animateTranslate(t,t.translateY),a.setMaskOpacity(t)}),this.setState({touchDown:!1,dragging:!1},n)}},{key:"onCardTouchEnd",value:function(e,t){var n,a=this,e=e.duration;this.state.dragging&&(e=(n=null!=(n=t.translateYCurrent)?n:0)/e*240*.6*((null!=(e=t.touchShiftYPercent)?e:0)<0?-1:1),n=Math.max(0,n+e),t.translateY=n=30<=n?100:0,t.hidden=100===n,t.hidden&&this.props.onExit(),n=function(){t.hidden||a.animateTranslate(t,t.translateY),a.setMaskOpacity(t)}),this.setState({touchDown:!1,dragging:!1},n)}},{key:"waitTransitionFinish",value:function(n,a){var e;_supportEvents.transitionEvent.supported?null!=n&&null!=(e=n.innerElement)&&e.addEventListener(_supportEvents.transitionEvent.name,function e(){var t;null!=n&&null!=(t=n.innerElement)&&t.removeEventListener(_supportEvents.transitionEvent.name,e),a()}):setTimeout(a,this.timeout)}},{key:"animateTranslate",value:function(e,t){var n="animateTranslateFrame".concat(e.id);cancelAnimationFrame(this.frameIds[n]),this.frameIds[n]=requestAnimationFrame(function(){(0,_styles.setTransformStyle)(e.innerElement,"translate3d(0, ".concat(t,"%, 0)"))})}},{key:"setMaskOpacity",value:function(n){var e,a=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;null===o&&(null==(e=this.props.history)?void 0:e[0])!==n.id||(this.maskAnimationFrame&&cancelAnimationFrame(this.maskAnimationFrame),this.maskAnimationFrame=requestAnimationFrame(function(){var e,t;a.maskElementRef.current&&(e=void 0===(e=n.translateY)?0:e,t=n.translateYCurrent,a.maskElementRef.current.style.opacity=Math.max(0,Math.min(100,null===o?1-((void 0===t?0:t)-e)/(100-e)||0:o)).toString())}))}},{key:"render",value:function(){var i=this,e=this.props,r=e.activeModal,l=e.exitingModal,s=e.enteringModal,e=this.state,t=e.touchDown,u=e.dragging;return r||l?(0,_jsxRuntime.createScopedElement)(_TouchContext.default.Provider,{value:!0},(0,_jsxRuntime.createScopedElement)(_ModalRootContext.default.Provider,{value:this.modalRootContext},(0,_jsxRuntime.createScopedElement)(_Touch.Touch,{vkuiClass:(0,_classNames.classNames)((0,_getClassName.getClassName)("ModalRoot",this.props.platform),{"ModalRoot--vkapps":(null==(e=this.props.configProvider)?void 0:e.webviewType)===_ConfigProviderContext.WebviewType.VKAPPS,"ModalRoot--touched":t,"ModalRoot--switching":!(!s&&!l)}),onMove:this.onTouchMove,onEnd:this.onTouchEnd,onScroll:this.onScroll},(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"ModalRoot__mask",onClick:this.props.onExit,ref:this.maskElementRef}),(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"ModalRoot__viewport",ref:this.viewportRef},this.getModals().map(function(e){var n=(0,_getNavId.getNavId)(e.props,warn),t=i.getModalState(n);if(n!==r&&n!==l||!t)return null;var t=(0,_objectSpread2.default)({},t),a=t.type===_types.ModalType.PAGE,o="modal-".concat(n);return(0,_jsxRuntime.createScopedElement)(_FocusTrap.FocusTrap,{key:o,getRootRef:function(e){var t=i.getModalState(n);t&&(t.modalElement=e)},onClose:i.props.onExit,timeout:i.timeout,vkuiClass:(0,_classNames.classNames)("ModalRoot__modal",{"ModalRoot__modal--active":n===r,"ModalRoot__modal--prev":n===l,"ModalRoot__modal--next":l&&n===r||n===s,"ModalRoot__modal--dragging":u,"ModalRoot__modal--expandable":a&&t.expandable,"ModalRoot__modal--expanded":a&&t.expanded,"ModalRoot__modal--collapsed":a&&t.collapsed}),restoreFocus:!1},e)}))))):null}}]),n}(React.Component),ModalRootTouch=(0,_withContext.withContext)((0,_withPlatform.withPlatform)((0,_dom.withDOM)((0,_useModalManager.withModalManager)(initModal)(ModalRootTouchComponent))),_ConfigProviderContext.ConfigProviderContext,"configProvider");function initModal(e){switch(e.type){case _types.ModalType.PAGE:return e.settlingHeight=e.settlingHeight||_constants.MODAL_PAGE_DEFAULT_PERCENT_HEIGHT,initPageModal(e);case _types.ModalType.CARD:return initCardModal(e);default:IS_DEV&&warn("initActiveModal: modalState.type is unknown","error")}}function initPageModal(e){var t,n,a,o,i,r=e.contentElement,l=(null==r?void 0:r.firstElementChild).offsetHeight,s=e.translateY,r=(e.expandable=l>(null!=(r=null==r?void 0:r.clientHeight)?r:0)||100===e.settlingHeight,!1),u=!1;e.expandable?(n=[0,o=(t=100-(null!=(t=e.settlingHeight)?t:0))/2],a=[o,t+(o=100-t)/4],o=[t+o/4,100],r=0<t,u=t<=0,i=t):(n=[i=t=100-(l+(null!=(l=null==(l=e.headerElement)?void 0:l.offsetHeight)?l:0))/(null!=(l=null==(l=e.innerElement)||null==(l=l.parentElement)?void 0:l.offsetHeight)?l:0)*100,i+25],a=[i+25,i+25],o=[i+25,i+100]),(e.expandable&&(null!=s?s:0)<i||100===e.settlingHeight)&&(i=0),e.expandedRange=n,e.collapsedRange=a,e.hiddenRange=o,e.translateY=i,e.translateYFrom=t,e.collapsed=r,e.expanded=u}function initCardModal(e){e.translateY=0}exports.ModalRootTouch=ModalRootTouch;