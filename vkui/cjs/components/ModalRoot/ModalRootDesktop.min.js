"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault").default,_interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard").default,_jsxRuntime=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModalRootDesktop=void 0,require("../../lib/jsxRuntime")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_createSuper2=_interopRequireDefault(require("@babel/runtime/helpers/createSuper")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),React=_interopRequireWildcard(require("react")),_classNames=require("../../lib/classNames"),_supportEvents=require("../../lib/supportEvents"),_withPlatform=require("../../hoc/withPlatform"),_withContext=require("../../hoc/withContext"),_ModalRootContext=_interopRequireDefault(require("./ModalRootContext")),_ConfigProviderContext=require("../ConfigProvider/ConfigProviderContext"),_platform=require("../../lib/platform"),_getClassName=require("../../helpers/getClassName"),_dom=require("../../lib/dom"),_getNavId=require("../../lib/getNavId"),_warnOnce=require("../../lib/warnOnce"),_FocusTrap=require("../FocusTrap/FocusTrap"),_useModalManager=require("./useModalManager"),_excluded=["id"],warn=(0,_warnOnce.warnOnce)("ModalRoot"),ModalRootDesktopComponent=function(e){(0,_inherits2.default)(i,e);var t=(0,_createSuper2.default)(i);function i(e){var o;return(0,_classCallCheck2.default)(this,i),o=t.call(this,e),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(o),"maskElementRef",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(o),"maskAnimationFrame",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(o),"modalRootContext",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(o),"restoreFocusTo",void 0),o.maskElementRef=React.createRef(),o.modalRootContext={updateModalHeight:function(){},registerModal:function(e){var t=e.id,e=(0,_objectWithoutProperties2.default)(e,_excluded);return Object.assign(o.getModalState(t),e)},onClose:function(){return o.props.onExit()},isInsideModal:!0},o}return(0,_createClass2.default)(i,[{key:"timeout",get:function(){return this.props.platform===_platform.ANDROID||this.props.platform===_platform.VKCOM?320:400}},{key:"modals",get:function(){return React.Children.toArray(this.props.children)}},{key:"getModalState",value:function(e){if(null!==e)return this.props.getModalState(e)}},{key:"componentDidUpdate",value:function(e){var t,o,i=this;this.props.exitingModal&&this.props.exitingModal!==e.exitingModal&&this.closeModal(this.props.exitingModal),this.props.enteringModal&&this.props.enteringModal!==e.enteringModal&&(t=this.props.enteringModal,o=this.getModalState(t),this.props.onEnter(),requestAnimationFrame(function(){i.props.enteringModal===t&&(i.waitTransitionFinish(o,function(){return i.props.onEntered(t)}),i.animateModalOpacity(o,!0))})),this.props.activeModal&&!e.activeModal&&(this.restoreFocusTo=null!=(e=null==(e=this.props.document)?void 0:e.activeElement)?e:void 0),this.props.activeModal||this.props.exitingModal||!this.restoreFocusTo||(this.restoreFocusTo.focus(),this.restoreFocusTo=void 0)}},{key:"closeModal",value:function(e){var t=this,o=this.getModalState(e);o&&(this.waitTransitionFinish(o,function(){return t.props.onExited(e)}),this.animateModalOpacity(o,!1),this.props.activeModal||this.setMaskOpacity(o,0))}},{key:"waitTransitionFinish",value:function(o,i){var e;_supportEvents.transitionEvent.supported?null!=o&&null!=(e=o.innerElement)&&e.addEventListener(_supportEvents.transitionEvent.name,function e(){var t;null!=o&&null!=(t=o.innerElement)&&t.removeEventListener(_supportEvents.transitionEvent.name,e),i()}):setTimeout(i,this.timeout)}},{key:"animateModalOpacity",value:function(e,t){null!=e&&e.innerElement&&(e.innerElement.style.transitionDelay=t&&this.props.delayEnter?"".concat(this.timeout,"ms"):"",e.innerElement.style.opacity=t?"1":"0")}},{key:"setMaskOpacity",value:function(o){var e,i=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;null===r&&(null==(e=this.props.history)?void 0:e[0])!==o.id||(this.maskAnimationFrame&&cancelAnimationFrame(this.maskAnimationFrame),this.maskAnimationFrame=requestAnimationFrame(function(){var e,t;i.maskElementRef.current&&(e=void 0===(e=o.translateY)?0:e,t=o.translateYCurrent,i.maskElementRef.current.style.opacity=Math.max(0,Math.min(100,null===r?1-((void 0===t?0:t)-e)/(100-e)||0:r)).toString())}))}},{key:"render",value:function(){var i=this,e=this.props,r=e.exitingModal,a=e.activeModal,n=e.enteringModal;return a||r?(0,_jsxRuntime.createScopedElement)(_ModalRootContext.default.Provider,{value:this.modalRootContext},(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:(0,_classNames.classNames)((0,_getClassName.getClassName)("ModalRoot",this.props.platform),{"ModalRoot--vkapps":(null==(e=this.props.configProvider)?void 0:e.webviewType)===_ConfigProviderContext.WebviewType.VKAPPS},"ModalRoot--desktop")},(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"ModalRoot__mask",ref:this.maskElementRef,onClick:this.props.onExit}),(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"ModalRoot__viewport"},this.modals.map(function(e){var t=(0,_getNavId.getNavId)(e.props,warn);if(t!==a&&t!==r)return null;var o="modal-".concat(t);return(0,_jsxRuntime.createScopedElement)(_FocusTrap.FocusTrap,{restoreFocus:!1,onClose:i.props.onExit,timeout:i.timeout,key:o,vkuiClass:(0,_classNames.classNames)("ModalRoot__modal",{"ModalRoot__modal--active":!r&&!n&&t===a,"ModalRoot__modal--prev":t===r,"ModalRoot__modal--next":Boolean(r)&&t===a})},e)})))):null}}]),i}(React.Component),ModalRootDesktop=(0,_withContext.withContext)((0,_withPlatform.withPlatform)((0,_dom.withDOM)((0,_useModalManager.withModalManager)()(ModalRootDesktopComponent))),_ConfigProviderContext.ConfigProviderContext,"configProvider");exports.ModalRootDesktop=ModalRootDesktop;