"use strict";var SelectType,_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault").default,_interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard").default,_extends2=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.SelectType=exports.CustomSelect=void 0,_interopRequireDefault(require("@babel/runtime/helpers/extends"))),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_jsxRuntime=require("../../lib/jsxRuntime"),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_createSuper2=_interopRequireDefault(require("@babel/runtime/helpers/createSuper")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),React=_interopRequireWildcard(require("react")),_SelectMimicry=_interopRequireDefault(require("../SelectMimicry/SelectMimicry")),_utils=require("../../lib/utils"),_classNames=require("../../lib/classNames"),_withAdaptivity=require("../../hoc/withAdaptivity"),_withPlatform=require("../../hoc/withPlatform"),_CustomSelectOption=require("../CustomSelectOption/CustomSelectOption"),_getClassName=require("../../helpers/getClassName"),_Input=require("../Input/Input"),_DropdownIcon=require("../DropdownIcon/DropdownIcon"),_Caption=require("../Typography/Caption/Caption"),_warnOnce=require("../../lib/warnOnce"),_select=require("../../lib/select"),_is=require("../../lib/is"),_CustomSelectDropdown=require("../CustomSelectDropdown/CustomSelectDropdown"),_excluded=["searchable","name","className","getRef","getRootRef","popupDirection","options","sizeY","platform","style","onChange","onBlur","onFocus","onClick","renderOption","children","emptyText","onInputChange","filterFn","renderDropdown","onOpen","onClose","fetching","icon","dropdownOffsetDistance","fixDropdownWidth","forceDropdownPortal","selectType"],_excluded2=["option"],findIndexAfter=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;return n>=e.length-1?-1:e.findIndex(function(e,t){return n<t&&!e.disabled})},findIndexBefore=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:e.length,n=-1;if(void 0===e||t<=0)return n;for(var o=t-1;0<=o;o--)if(!e[o].disabled){n=o;break}return n},warn=(0,_warnOnce.warnOnce)("CustomSelect"),checkOptionsValueType=function(e){1<new Set(e.map(function(e){return(0,_typeof2.default)(e.value)})).size&&warn("Some values of your options have different types. CustomSelect onChange always returns a string type.","error")},CustomSelectComponent=(!function(e){e.Default="default",e.Plain="plain"}((exports.SelectType=SelectType)||(exports.SelectType=SelectType={})),function(e){(0,_inherits2.default)(i,e);var o=(0,_createSuper2.default)(i);function i(e){(0,_classCallCheck2.default)(this,i),r=o.call(this,e),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"keyboardInput",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"isControlledOutside",!1),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"selectEl",null),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"scrollBoxRef",React.createRef()),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"containerRef",React.createRef()),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"resetKeyboardInput",function(){r.keyboardInput=""}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"getSelectedItem",function(){var e=r.state,t=e.selectedOptionIndex,e=e.options;return null!=e&&e.length?void 0!==t?e[t]:void 0:null}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"filter",function(e,t,n){return"function"==typeof n?e.filter(function(e){return n(t,e)}):e}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"open",function(){r.setState(function(e){return{opened:!0,focusedOptionIndex:e.selectedOptionIndex}},function(){var e=r.state.selectedOptionIndex;void 0!==e&&r.isValidIndex(e)&&r.scrollToElement(e,!0)}),"function"==typeof r.props.onOpen&&r.props.onOpen()}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"close",function(){r.resetKeyboardInput(),r.setState(function(){return{inputValue:"",opened:!1,focusedOptionIndex:-1,options:r.props.options}}),"function"==typeof r.props.onClose&&r.props.onClose()}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"selectFocused",function(){var e=r.state.focusedOptionIndex;void 0!==e&&r.select(e)}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"select",function(e){var t;r.isValidIndex(e)&&(t=null==(t=r.state.options)?void 0:t[e],r.setState({nativeSelectValue:null==t?void 0:t.value},function(){var e,t=new Event("change",{bubbles:!0});null!=(e=r.selectEl)&&e.dispatchEvent(t)}),r.close())}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onClick",function(){r.state.opened?r.close():r.open()}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onFocus",function(){var e,t=new Event("focus");null!=(e=r.selectEl)&&e.dispatchEvent(t)}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onBlur",function(){r.close();var e,t=new Event("blur");null!=(e=r.selectEl)&&e.dispatchEvent(t)}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"focusOptionByIndex",function(t){var e;void 0===t||t<0||t>(null!=(e=null==(e=r.state.options)?void 0:e.length)?e:0)-1||(null!=(e=null==(e=r.state.options)?void 0:e[t])&&e.disabled||(1<arguments.length&&void 0!==arguments[1]&&!arguments[1]||r.scrollToElement(t),r.setState(function(e){return e.focusedOptionIndex!==t?{focusedOptionIndex:t}:null})))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"focusOption",function(e){var t,n=r.state.focusedOptionIndex;"next"===e?n=-1===(t=findIndexAfter(r.state.options,n))?findIndexAfter(r.state.options):t:"prev"===e&&(n=-1===(t=findIndexBefore(r.state.options,n))?findIndexBefore(r.state.options):t),r.focusOptionByIndex(n)}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"handleOptionHover",function(e){var t;r.focusOptionByIndex(Array.prototype.indexOf.call(null==(t=e.currentTarget.parentNode)?void 0:t.children,e.currentTarget),!1)}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"handleOptionDown",function(e){e.preventDefault()}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"handleOptionClick",function(e){var t=Array.prototype.indexOf.call(null==(t=e.currentTarget.parentNode)?void 0:t.children,e.currentTarget),e=null==(e=r.state.options)?void 0:e[t];e&&!e.disabled&&r.selectFocused()}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"resetFocusedOption",function(){r.setState({focusedOptionIndex:-1})}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onKeyboardInput",function(e){var t=r.keyboardInput+e,e=null==(e=r.state.options)?void 0:e.findIndex(function(e){return e.label.toLowerCase().includes(t)});void 0!==e&&-1<e&&r.focusOptionByIndex(e),r.keyboardInput=t}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onLabelClick",function(e){var t;null!=(t=r.scrollBoxRef.current)&&t.contains(e.target)&&e.preventDefault()}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onNativeSelectChange",function(e){var t,n=r.findSelectedIndex(r.state.options,e.currentTarget.value);r.state.selectedOptionIndex!==n&&(r.isControlledOutside||r.setState({selectedOptionIndex:n}),null!=(t=(n=r.props).onChange)&&t.call(n,e))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onInputChange",function(e){var t;r.props.onInputChange?(t=r.props.onInputChange(e,r.props.options))?("development"===process.env.NODE_ENV&&warn("This filtration method is deprecated. Return value of onInputChange will be ignored in v5.0.0. For custom filtration please update props.options by yourself or use filterFn property"),r.setState({options:t,selectedOptionIndex:r.findSelectedIndex(t,r.state.nativeSelectValue),inputValue:e.target.value})):r.setState({inputValue:e.target.value}):(t=r.filter(r.props.options,e.target.value,r.props.filterFn),r.setState({options:t,selectedOptionIndex:r.findSelectedIndex(t,r.state.nativeSelectValue),inputValue:e.target.value}))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onInputKeyDown",function(e){switch(["ArrowUp","ArrowDown","Escape","Enter"].includes(e.key)&&r.areOptionsShown&&e.preventDefault(),e.key){case"ArrowUp":r.areOptionsShown&&r.focusOption("prev");break;case"ArrowDown":r.areOptionsShown&&r.focusOption("next");break;case"Escape":r.close();break;case"Enter":r.areOptionsShown&&r.selectFocused()}}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"handleKeyDownSelect",function(e){var t=r.state.opened;if(1===e.key.length&&" "!==e.key)r.onKeyboardInput(e.key);else switch(["ArrowUp","ArrowDown","Escape","Enter"].includes(e.key)&&r.areOptionsShown&&e.preventDefault(),e.key){case"ArrowUp":t?r.areOptionsShown&&r.focusOption("prev"):r.open();break;case"ArrowDown":t?r.areOptionsShown&&r.focusOption("next"):r.open();break;case"Escape":r.close();break;case"Enter":case"Spacebar":case" ":t?r.areOptionsShown&&r.selectFocused():r.open()}}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"handleKeyUp",(0,_utils.debounce)(r.resetKeyboardInput,1e3)),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"renderOption",function(e,t){var n=r.state,o=n.focusedOptionIndex,n=n.selectedOptionIndex,i=r.props.renderOption,o=t===o,t=t===n;return(0,_jsxRuntime.createScopedElement)(React.Fragment,{key:"".concat(e.value)},i({option:e,hovered:o,children:e.label,selected:t,disabled:e.disabled,onClick:r.handleOptionClick,onMouseDown:r.handleOptionDown,onMouseOver:r.handleOptionHover}))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"selectRef",function(e){r.selectEl=e,r.props.getRef&&(0,_utils.setRef)(e,r.props.getRef)}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onPlacementChange",function(e){r.setState(function(){return{popperPlacement:e}})});var r,t=e.value,n=e.defaultValue,t=void 0!==t?t:n;return r.keyboardInput="","development"===process.env.NODE_ENV&&checkOptionsValueType(e.options),r.state={opened:!1,focusedOptionIndex:-1,selectedOptionIndex:r.findSelectedIndex(e.options,t),nativeSelectValue:t,options:e.options,inputValue:""},void 0!==e.value&&(r.isControlledOutside=!0),r}return(0,_createClass2.default)(i,[{key:"areOptionsShown",get:function(){return null!==this.scrollBoxRef.current}},{key:"findSelectedIndex",value:function(e,t){return null!=(e=null==e?void 0:e.findIndex(function(e){return t="number"==typeof e.value?Number(t):t,e.value===t}))?e:-1}},{key:"isValidIndex",value:function(e){return 0<=e&&e<(null!=(e=null==(e=this.state.options)?void 0:e.length)?e:0)}},{key:"scrollToElement",value:function(e){var t,n,o,i=this.scrollBoxRef.current,e=i?i.children[e]:null;e&&i&&(t=i.offsetHeight,n=i.scrollTop,o=e.offsetTop,e=e.offsetHeight,1<arguments.length&&void 0!==arguments[1]&&arguments[1]?i.scrollTop=o-t/2+e/2:t+n<o+e?i.scrollTop=o-t+e:o<n&&(i.scrollTop=o))}},{key:"componentDidUpdate",value:function(e){var t;(0,_is.is)(e.value,this.props.value)&&e.options===this.props.options||("development"===process.env.NODE_ENV&&checkOptionsValueType(this.props.options),this.isControlledOutside=void 0!==this.props.value,e=void 0===this.props.value?this.state.nativeSelectValue:this.props.value,t=this.props.searchable&&void 0!==this.state.inputValue?this.filter(this.props.options,this.state.inputValue,this.props.filterFn):this.props.options,this.setState({nativeSelectValue:e,selectedOptionIndex:this.findSelectedIndex(t,e),options:t}))}},{key:"render",value:function(){var e=this.state,t=e.opened,n=e.nativeSelectValue,e=e.options,o=this.props,i=o.searchable,r=o.name,l=o.className,s=(o.getRef,o.getRootRef),a=o.popupDirection,u=o.options,p=(o.sizeY,o.platform),d=o.style,c=(o.onChange,o.onBlur),f=o.onFocus,h=o.onClick,_=(o.renderOption,o.children,o.emptyText,o.onInputChange,o.filterFn,o.renderDropdown),v=(o.onOpen,o.onClose,o.fetching),y=o.icon,m=o.dropdownOffsetDistance,I=o.fixDropdownWidth,C=o.forceDropdownPortal,S=o.selectType,o=(0,_objectWithoutProperties2.default)(o,_excluded),x=this.getSelectedItem(),x=x?x.label:void 0,e=void 0!==e&&0<e.length?e.map(this.renderOption):(0,_jsxRuntime.createScopedElement)(_Caption.Caption,{vkuiClass:"CustomSelect__empty"},this.props.emptyText),_="function"==typeof _?_({defaultDropdownContent:e}):e,e=null==(e=this.state.popperPlacement)?void 0:e.includes("top");return(0,_jsxRuntime.createScopedElement)("label",{vkuiClass:(0,_getClassName.getClassName)("CustomSelect",p),className:l,style:d,ref:(0,_utils.multiRef)(this.containerRef,s),onClick:this.onLabelClick},t&&i?(0,_jsxRuntime.createScopedElement)(_Input.Input,(0,_extends2.default)({},o,{autoFocus:!0,onBlur:this.onBlur,vkuiClass:(0,_classNames.classNames)(t&&"CustomSelect__open",e&&"CustomSelect__open--popupDirectionTop",0<m&&"CustomSelect__open--not-adjacent"),value:this.state.inputValue,onKeyDown:this.onInputKeyDown,onChange:this.onInputChange,onClick:h,after:y,placeholder:o.placeholder})):(0,_jsxRuntime.createScopedElement)(_SelectMimicry.default,(0,_extends2.default)({},o,{"aria-hidden":!0,onClick:this.onClick,onKeyDown:this.handleKeyDownSelect,onKeyUp:this.handleKeyUp,onFocus:this.onFocus,onBlur:this.onBlur,vkuiClass:(0,_classNames.classNames)(t&&"CustomSelect__open",e&&"CustomSelect__open--popupDirectionTop",0<m&&"CustomSelect__open--not-adjacent"),after:y,selectType:S}),x),(0,_jsxRuntime.createScopedElement)("select",{ref:this.selectRef,name:r,onChange:this.onNativeSelectChange,onBlur:c,onFocus:f,onClick:h,value:n,"aria-hidden":!0,vkuiClass:"CustomSelect__control"},u.map(function(e){return(0,_jsxRuntime.createScopedElement)("option",{key:"".concat(e.value),value:e.value})})),t&&(0,_jsxRuntime.createScopedElement)(_CustomSelectDropdown.CustomSelectDropdown,{targetRef:this.containerRef,placement:a,scrollBoxRef:this.scrollBoxRef,onPlacementChange:this.onPlacementChange,onMouseLeave:this.resetFocusedOption,fetching:v,offsetDistance:m,sameWidth:I,forcePortal:C},_))}}]),i}(React.Component)),CustomSelect=((0,_defineProperty2.default)(CustomSelectComponent,"defaultProps",{searchable:!1,renderOption:function(e){e.option;e=(0,_objectWithoutProperties2.default)(e,_excluded2);return(0,_jsxRuntime.createScopedElement)(_CustomSelectOption.CustomSelectOption,e)},options:[],emptyText:"Ничего не найдено",filterFn:_select.defaultFilterFn,icon:(0,_jsxRuntime.createScopedElement)(_DropdownIcon.DropdownIcon,null),dropdownOffsetDistance:0,fixDropdownWidth:!0,selectType:SelectType.Default}),(0,_withPlatform.withPlatform)((0,_withAdaptivity.withAdaptivity)(CustomSelectComponent,{sizeY:!0})));exports.CustomSelect=CustomSelect;