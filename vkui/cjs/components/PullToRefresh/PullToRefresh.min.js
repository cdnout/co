"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault").default,_interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard").default,_jsxRuntime=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("../../lib/jsxRuntime")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_createSuper2=_interopRequireDefault(require("@babel/runtime/helpers/createSuper")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),React=_interopRequireWildcard(require("react")),_Touch=require("../Touch/Touch"),_TouchContext=_interopRequireDefault(require("../Touch/TouchContext")),_FixedLayout=_interopRequireDefault(require("../FixedLayout/FixedLayout")),_classNames=require("../../lib/classNames"),_platform=require("../../lib/platform"),_getClassName=require("../../helpers/getClassName"),_PullToRefreshSpinner=_interopRequireDefault(require("./PullToRefreshSpinner")),_withPlatform=require("../../hoc/withPlatform"),_dom=require("../../lib/dom"),_taptic=require("../../lib/taptic"),_withContext=require("../../hoc/withContext"),_ScrollContext=require("../AppRoot/ScrollContext"),_excluded=["children","onRefresh","isFetching","platform","window","document","scroll"];function cancelEvent(e){if(!e)return!1;for(;e.originalEvent;)e=e.originalEvent;return e.preventDefault&&e.cancelable&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1}var PullToRefresh=function(e){(0,_inherits2.default)(r,e);var t=(0,_createSuper2.default)(r);function r(e){var h;return(0,_classCallCheck2.default)(this,r),h=t.call(this,e),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(h),"params",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(h),"contentRef",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(h),"waitFetchingTimeout",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(h),"onTouchStart",function(e){h.state.refreshing&&cancelEvent(e),h.setState({touchDown:!0})}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(h),"onWindowTouchMove",function(e){h.state.refreshing&&(e.preventDefault(),e.stopPropagation())}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(h),"onTouchMove",function(e){var t,r=e.isY,i=e.shiftY,n=h.params,a=n.start,n=n.max,s=null==(s=h.props.scroll)?void 0:s.getScroll().y,o=h.state,l=o.refreshing,u=o.watching,o=o.touchDown;u&&o?(cancelEvent(e),u=h.params.positionMultiplier,t=Math.max(0,i-h.state.touchY),u=-10<(t=Math.max(a,Math.min(h.params.maxY,a+t*u)))?80*Math.abs((t+10)/n):0,h.setState({spinnerY:t,spinnerProgress:Math.min(80,Math.max(0,u)),canRefresh:80<u,contentShift:2.3*(t+10)}),85<u&&!l&&h.props.platform===_platform.IOS&&h.runRefreshing()):r&&0===s&&0<i&&!l&&o&&(cancelEvent(e),h.setState({watching:!0,touchY:i,spinnerY:a,spinnerProgress:0}))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(h),"onTouchEnd",function(){h.setState({watching:!1,touchDown:!1})}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(h),"onRefreshingFinish",function(){h.state.touchDown||h.resetRefreshingState()}),h.params={start:e.platform===_platform.ANDROID||e.platform===_platform.VKCOM?-45:-10,max:e.platform===_platform.ANDROID||e.platform===_platform.VKCOM?80:50,maxY:e.platform===_platform.ANDROID||e.platform===_platform.VKCOM?80:400,refreshing:e.platform===_platform.ANDROID||e.platform===_platform.VKCOM?50:36,positionMultiplier:e.platform===_platform.ANDROID||e.platform===_platform.VKCOM?1:.21},h.state={watching:!1,refreshing:!1,canRefresh:!1,touchDown:!1,touchY:0,spinnerY:h.params.start,spinnerProgress:0,contentShift:0},h.contentRef=React.createRef(),h}return(0,_createClass2.default)(r,[{key:"document",get:function(){return this.props.document}},{key:"componentDidMount",value:function(){_dom.canUseDOM&&this.document.addEventListener("touchmove",this.onWindowTouchMove,{cancelable:!0,passive:!1})}},{key:"componentWillUnmount",value:function(){_dom.canUseDOM&&this.document.removeEventListener("touchmove",this.onWindowTouchMove,{cancelable:!0,passive:!1}),this.waitFetchingTimeout&&clearTimeout(this.waitFetchingTimeout)}},{key:"componentDidUpdate",value:function(e,t){e.isFetching&&!this.props.isFetching&&this.onRefreshingFinish(),!e.isFetching&&this.props.isFetching&&this.waitFetchingTimeout&&clearTimeout(this.waitFetchingTimeout),t.touchDown&&!this.state.touchDown&&(t=(e=this.state).refreshing,e=e.canRefresh,!t&&e?this.runRefreshing():t&&!this.props.isFetching?this.resetRefreshingState():this.setState({spinnerY:t?this.params.refreshing:this.params.start,spinnerProgress:0,contentShift:0}))}},{key:"runRefreshing",value:function(){!this.state.refreshing&&this.props.onRefresh&&(this.waitFetchingTimeout=setTimeout(this.onRefreshingFinish,1e3),this.setState({refreshing:!0,spinnerY:this.props.platform===_platform.ANDROID||this.props.platform===_platform.VKCOM?this.params.refreshing:this.state.spinnerY}),this.props.onRefresh(),(0,_taptic.runTapticImpactOccurred)("light"))}},{key:"resetRefreshingState",value:function(){this.setState({watching:!1,canRefresh:!1,refreshing:!1,spinnerY:this.params.start,spinnerProgress:0,contentShift:0})}},{key:"render",value:function(){var e=this.props,t=e.children,r=(e.onRefresh,e.isFetching,e.platform),e=(e.window,e.document,e.scroll,(0,_objectWithoutProperties2.default)(e,_excluded)),i=this.state,n=i.watching,a=i.refreshing,s=i.spinnerY,o=i.spinnerProgress,l=i.canRefresh,u=i.touchDown,i=i.contentShift,s="translate3d(0, ".concat(s,"px, 0)"),h="";return r===_platform.IOS&&a&&!u?h="translate3d(0, 100px, 0)":r===_platform.IOS&&(i||a)&&(h="translate3d(0, ".concat(i,"px, 0)")),(0,_jsxRuntime.createScopedElement)(_TouchContext.default.Provider,{value:!0},(0,_jsxRuntime.createScopedElement)(_Touch.Touch,(0,_extends2.default)({},e,{onStart:this.onTouchStart,onMove:this.onTouchMove,onEnd:this.onTouchEnd,vkuiClass:(0,_classNames.classNames)((0,_getClassName.getClassName)("PullToRefresh",r),{"PullToRefresh--watching":n,"PullToRefresh--refreshing":a})}),(0,_jsxRuntime.createScopedElement)(_FixedLayout.default,{vkuiClass:"PullToRefresh__controls"},(0,_jsxRuntime.createScopedElement)(_PullToRefreshSpinner.default,{style:{transform:s,WebkitTransform:s,opacity:n||a||l?1:0},on:a,progress:a?void 0:o})),(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"PullToRefresh__content",ref:this.contentRef,style:{transform:h,WebkitTransform:h}},t)))}}]),r}(React.PureComponent),_default=(0,_withContext.withContext)((0,_withPlatform.withPlatform)((0,_dom.withDOM)(PullToRefresh)),_ScrollContext.ScrollContext,"scroll");exports.default=_default;