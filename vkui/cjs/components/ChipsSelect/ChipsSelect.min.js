"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault").default,_interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard").default,_jsxRuntime=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChipsSelect=void 0,require("../../lib/jsxRuntime")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread2")),React=_interopRequireWildcard(require("react")),_DropdownIcon=require("../DropdownIcon/DropdownIcon"),_classNames=require("../../lib/classNames"),_ChipsInput=require("../ChipsInput/ChipsInput"),_CustomSelectOption=require("../CustomSelectOption/CustomSelectOption"),_useChipsSelect2=require("./useChipsSelect"),_withAdaptivity=require("../../hoc/withAdaptivity"),_utils=require("../../lib/utils"),_dom=require("../../lib/dom"),_Caption=require("../Typography/Caption/Caption"),_prefixClass=require("../../lib/prefixClass"),_useExternRef=require("../../hooks/useExternRef"),_useGlobalEventListener=require("../../hooks/useGlobalEventListener"),_select=require("../../lib/select"),_CustomSelectDropdown=require("../CustomSelectDropdown/CustomSelectDropdown"),_excluded=["option"],_excluded2=["style","onFocus","onKeyDown","className","fetching","renderOption","emptyText","getRef","getRootRef","disabled","placeholder","tabIndex","getOptionValue","getOptionLabel","showSelected","getNewOptionData","renderChip","popupDirection","creatable","filterFn","inputValue","creatableText","sizeY","closeAfterSelect","onChangeStart","after","options"],FOCUS_ACTION_NEXT="next",FOCUS_ACTION_PREV="prev",chipsSelectDefaultProps=(0,_objectSpread2.default)((0,_objectSpread2.default)({},_ChipsInput.chipsInputDefaultProps),{},{emptyText:"Ничего не найдено",creatableText:"Создать значение",onChangeStart:_utils.noop,creatable:!1,fetching:!1,showSelected:!0,closeAfterSelect:!0,options:[],filterFn:_select.defaultFilterFn,renderOption:function(e){e.option;e=(0,_objectWithoutProperties2.default)(e,_excluded);return(0,_jsxRuntime.createScopedElement)(_CustomSelectOption.CustomSelectOption,e)}}),ChipsSelectComponent=function(e){function n(e,t){e="number"!=typeof e?-1:e,t===FOCUS_ACTION_NEXT?e+=1:t===FOCUS_ACTION_PREV&&(e-=1),null!=j&&G(e,j)}var e=(0,_objectSpread2.default)((0,_objectSpread2.default)({},chipsSelectDefaultProps),e),t=e.style,o=e.onFocus,r=e.onKeyDown,l=e.className,i=e.fetching,u=e.renderOption,a=e.emptyText,s=e.getRef,p=(e.getRootRef,e.disabled),F=e.placeholder,k=e.tabIndex,c=e.getOptionValue,d=e.getOptionLabel,V=(e.showSelected,e.getNewOptionData),L=e.renderChip,M=e.popupDirection,f=e.creatable,_=(e.filterFn,e.inputValue,e.creatableText),U=e.sizeY,h=e.closeAfterSelect,C=e.onChangeStart,W=(e.after,e.options,(0,_objectWithoutProperties2.default)(e,_excluded2)),m=(0,_dom.useDOM)().document,S=React.useState(void 0),S=(0,_slicedToArray2.default)(S,2),b=S[0],R=S[1],v=React.useRef(null),x=(0,_useExternRef.useExternRef)(s),S=(0,_useChipsSelect2.useChipsSelect)(e),e=S.fieldValue,O=S.selectedOptions,g=void 0===O?[]:O,D=S.opened,q=S.setOpened,O=S.addOptionFromInput,y=S.filteredOptions,w=S.addOption,z=S.handleInputChange,E=S.clearInput,I=S.focusedOption,T=S.setFocusedOption,j=S.focusedOptionIndex,N=S.setFocusedOptionIndex,P=Boolean(f&&_&&!y.length&&e),A=React.useRef([]).current,G=function(e,t){var n=y.length;e<0?e=n-1:n<=e&&(e=0),e!==t&&(function(e){var t,n,o,r=v.current,e=A[e];e&&r&&(t=r.offsetHeight,n=r.scrollTop,o=e.offsetTop,e=e.offsetHeight,1<arguments.length&&void 0!==arguments[1]&&arguments[1]?r.scrollTop=o-t/2+e/2:t+n<o+e?r.scrollTop=o-t+e:o<n&&(r.scrollTop=o))}(e),N(e))},S=(React.useEffect(function(){null!=j&&y[j]?T(y[j]):null!==j&&0!==j||T(null)},[j,y,T]),React.useEffect(function(){-1===(I?y.findIndex(function(e){return e.value===I.value}):-1)&&y.length&&!P&&h&&T(y[0])},[y,I,P,h,T]),(0,_useGlobalEventListener.useGlobalEventListener)(m,"click",function(e){var t=x.current;t&&e.target!==t&&!t.contains(e.target)&&q(!1)}),null==b?void 0:b.includes("top")),m=React.useCallback(function(e){R(e)},[R]),b=React.useCallback(function(){N(null)},[N]);return(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:(0,_classNames.classNames)("ChipsSelect","ChipsSelect--sizeY-".concat(U)),ref:x,style:t,className:l},(0,_jsxRuntime.createScopedElement)(_ChipsInput.ChipsInput,(0,_extends2.default)({},W,{tabIndex:k,value:g,inputValue:e,getNewOptionData:V,getOptionLabel:d,getOptionValue:c,renderChip:function(o){if(void 0===o)return null;return L((0,_objectSpread2.default)((0,_objectSpread2.default)({},o),{},{onRemove:function(e,t){var n;null!=e&&e.preventDefault(),null!=e&&e.stopPropagation(),null!=(n=o.onRemove)&&n.call(o,e,t)}}))},onFocus:function(e){q(!0),N(0),o(e)},onKeyDown:function(e){var t;r(e),"ArrowUp"!==e.key||e.defaultPrevented||(e.preventDefault(),D?n(j,FOCUS_ACTION_PREV):(q(!0),N(0))),"ArrowDown"!==e.key||e.defaultPrevented||(e.preventDefault(),D?n(j,FOCUS_ACTION_NEXT):(q(!0),N(0))),"Enter"===e.key&&!e.defaultPrevented&&D&&null!=j&&((t=y[j])?(C(e,t),e.defaultPrevented||(w(t),N(null),E(),h&&q(!1),e.preventDefault())):f||e.preventDefault()),["Escape","Tab"].includes(e.key)&&!e.defaultPrevented&&D&&q(!1)},placeholder:F,vkuiClass:(0,_classNames.classNames)(D&&"ChipsSelect__open",S&&"ChipsSelect__open--popupDirectionTop"),getRef:s,disabled:p,onInputChange:z,after:(0,_jsxRuntime.createScopedElement)(_DropdownIcon.DropdownIcon,null)})),D&&(0,_jsxRuntime.createScopedElement)(_CustomSelectDropdown.CustomSelectDropdown,{targetRef:x,placement:M,scrollBoxRef:v,onPlacementChange:m,onMouseLeave:b,fetching:i,vkuiClass:"ChipsSelect__options"},P&&(0,_jsxRuntime.createScopedElement)(_CustomSelectOption.CustomSelectOption,{hovered:0===j,onMouseDown:O,onMouseEnter:function(){return N(0)}},_),null!=y&&y.length||P||!a?y.map(function(t,n){var e=d(t),o=I&&c(t)===c(I),r=g.find(function(e){return c(e)===c(t)}),l=c(t);return(0,_jsxRuntime.createScopedElement)(React.Fragment,{key:"".concat((0,_typeof2.default)(l),"-").concat(l)},u({className:(0,_prefixClass.prefixClass)("ChipsSelect__option"),option:t,hovered:Boolean(o),children:e,selected:!!r,getRootRef:function(e){if(e)return A[n]=e},onMouseDown:function(e){null!=C&&C(e,t),e.defaultPrevented||(h&&q(!1),w(t),E())},onMouseEnter:function(){return N(n)}}))}):(0,_jsxRuntime.createScopedElement)(_Caption.Caption,{vkuiClass:"ChipsSelect__empty"},a)))},ChipsSelect=(0,_withAdaptivity.withAdaptivity)(ChipsSelectComponent,{sizeY:!0});exports.ChipsSelect=ChipsSelect;