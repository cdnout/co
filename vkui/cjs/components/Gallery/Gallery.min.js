"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault").default,_interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard").default,_jsxRuntime=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("../../lib/jsxRuntime")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_createSuper2=_interopRequireDefault(require("@babel/runtime/helpers/createSuper")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),React=_interopRequireWildcard(require("react")),_getClassName=require("../../helpers/getClassName"),_Touch=require("../Touch/Touch"),_classNames=require("../../lib/classNames"),_withPlatform=require("../../hoc/withPlatform"),_dom=require("../../lib/dom"),_utils=require("../../lib/utils"),_withAdaptivity=require("../../hoc/withAdaptivity"),_HorizontalScrollArrow=_interopRequireDefault(require("../HorizontalScroll/HorizontalScrollArrow")),_math=require("../../helpers/math"),_useTimeout=require("../../hooks/useTimeout"),_excluded=["children","slideWidth","slideIndex","isDraggable","onDragStart","onDragEnd","onChange","onEnd","align","bullets","platform","hasMouse","showArrows","window","document","getRef","getRootRef"],_excluded2=["initialSlideIndex","children","timeout","onChange"],BaseGallery=function(e){(0,_inherits2.default)(i,e);var t=(0,_createSuper2.default)(i);function i(e){var r;return(0,_classCallCheck2.default)(this,i),r=t.call(this,e),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"container",null),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"slidesStore",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"viewport",null),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onStart",function(){r.setState({animation:!1})}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onMoveX",function(e){r.props.isDraggable&&!r.isFullyVisible&&(e.originalEvent.preventDefault(),e.isSlideX&&(r.props.onDragStart&&r.props.onDragStart(e),r.state.deltaX===e.shiftX&&r.state.dragging===e.isSlideX||r.setState({deltaX:e.shiftX,dragging:e.isSlideX})))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onEnd",function(e){var t,i=e.isSlide?r.getTarget(e):null!=(t=r.props.slideIndex)?t:0;r.props.onDragEnd&&r.props.onDragEnd(e),r.setState({deltaX:0,animation:!0},function(){var e,t;return null==(e=(t=r.props).onChange)?void 0:e.call(t,i)}),r.props.onEnd&&r.props.onEnd({targetIndex:i})}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"onResize",function(){return r.initializeSlides({animation:!1})}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"slideLeft",function(){var e=r.props,t=e.slideIndex,i=void 0===t?0:t,n=e.onChange,t=e.onPrevClick;r.canSlideLeft&&(r.setState({deltaX:0,animation:!0},function(){return null==n?void 0:n(i-1)}),null!=t&&t())}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"slideRight",function(){var e=r.props,t=e.slideIndex,i=void 0===t?0:t,n=e.onChange,t=e.onNextClick;r.canSlideRight&&(r.setState({deltaX:0,animation:!0},function(){return null==n?void 0:n(i+1)}),null!=t&&t())}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"getSlideRef",function(t){return function(e){r.slidesStore["slide-".concat(t)]=e}}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"getViewportRef",function(e){r.viewport=e,r.props.getRef&&(0,_utils.setRef)(e,r.props.getRef)}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(r),"getRootRef",function(e){r.container=e,r.props.getRootRef&&(0,_utils.setRef)(e,r.props.getRootRef)}),r.state={containerWidth:0,deltaX:0,shiftX:0,slides:[],animation:!0,duration:.24},r.slidesStore={},r}return(0,_createClass2.default)(i,[{key:"isCenterWithCustomWidth",get:function(){return"custom"===this.props.slideWidth&&"center"===this.props.align}},{key:"initializeSlides",value:function(){var n=this,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=null!=(e=React.Children.map(this.props.children,function(e,t){var i,t=n.slidesStore["slide-".concat(t)];return{coordX:null!=(i=null==t?void 0:t.offsetLeft)?i:0,width:null!=(i=null==t?void 0:t.offsetWidth)?i:0}}))?e:[],t=null!=(t=null==(t=this.container)?void 0:t.offsetWidth)?t:0,i=e.reduce(function(e,t){return t.width+e},0),l=this.calcMin({containerWidth:t,layerWidth:i,slides:e}),a=this.calcMax({slides:e});this.setState({min:l,max:a,layerWidth:i,containerWidth:t,slides:e},function(){var e,t,i;void 0!==n.props.slideIndex&&(e=n.calculateIndent(n.props.slideIndex),n.state.shiftX!==e&&(t=n.state.shiftX===n.validateIndent(n.state.shiftX),i=r.animation,n.setState({shiftX:e,animation:void 0===i?t:i},function(){var e;n.state.animation||null!=(e=n.props.window)&&e.requestAnimationFrame(function(){return n.setState({animation:!0})})})))})}},{key:"calcMin",value:function(e){var t,i=e.containerWidth,n=e.layerWidth,r=void 0===n?0:n,l=e.slides,a=null!=(e=null==(n=this.viewport)?void 0:n.offsetWidth)?e:0;switch(this.props.align){case"left":return i-r;case"right":return a-r;case"center":return this.isCenterWithCustomWidth&&l.length?a/2-(t=l[l.length-1]).coordX-t.width/2:a-(i-a)/2-r}}},{key:"calcMax",value:function(e){var t,e=e.slides,i=null!=(i=null==(i=this.viewport)?void 0:i.offsetWidth)?i:0;return this.isCenterWithCustomWidth&&e.length?(t=(e=e[0]).width,i/2-e.coordX-t/2):0}},{key:"calculateIndent",value:function(e){var t=this.state.slides;if(this.isFullyVisible)return 0;var i,t=t.length?t[e]:null;return t?(e=t.coordX,t=t.width,this.isCenterWithCustomWidth?(null!=(i=null==(i=this.viewport)?void 0:i.offsetWidth)?i:0)/2-e-t/2:this.validateIndent(-1*e)):0}},{key:"calculateDragIndent",value:function(){var e=this.state,t=e.shiftX,i=e.deltaX,n=e.min,n=void 0===n?0:n,e=e.max,e=void 0===e?0:e,t=t+i;return e<t?e+Number((t-e)/3):t<n?n+Number((t-n)/3):t}},{key:"validateIndent",value:function(e){var t=this.state,i=t.min,i=void 0===i?0:i,t=t.max,t=void 0===t?0:t;return e<i?i:t<e?t:e}},{key:"isFullyVisible",get:function(){var e;return(null!=(e=this.state.layerWidth)?e:0)<=this.state.containerWidth}},{key:"getTarget",value:function(e){var t=this.state,n=t.slides,i=t.deltaX,r=t.shiftX,t=t.max,l=this.props.slideIndex,l=void 0===l?0:l,a=r+i+i/e.duration*240*.6-(void 0===t?0:t),r=i<0?1:-1,e=n.reduce(function(e,t,i){return Math.abs(n[e].coordX+a)<Math.abs(t.coordX+a)?e:i},l);return e=e===l&&0<=(t=l+r)&&t<n.length&&Math.abs(i)>.05*n[t].width?t:e}},{key:"canSlideLeft",get:function(){return!this.isFullyVisible&&this.state.shiftX<0}},{key:"canSlideRight",get:function(){var e=this.state,t=e.containerWidth,i=e.layerWidth,n=e.shiftX,e=e.slides,r=this.props,l=r.align,r=r.slideIndex;return!this.isFullyVisible&&("left"===l&&t-n<(void 0===i?0:i)||"left"!==l&&(void 0===r?0:r)<e.length-1)}},{key:"componentDidMount",value:function(){this.initializeSlides({animation:!1}),this.props.window.addEventListener("resize",this.onResize)}},{key:"componentDidUpdate",value:function(e){var t=this.props.slideWidth!==e.slideWidth,i=this.props!==e,n=React.Children.count(this.props.children)!==React.Children.count(e.children),r="custom"===this.props.slideWidth;t||n||r&&i?this.initializeSlides():this.props.slideIndex!==e.slideIndex&&this.setState({animation:!0,deltaX:0,shiftX:this.calculateIndent(null!=(t=this.props.slideIndex)?t:0)})}},{key:"componentWillUnmount",value:function(){this.props.window.removeEventListener("resize",this.onResize)}},{key:"render",value:function(){var i=this,e=this.state,t=e.animation,n=e.duration,e=e.dragging,r=this.props,l=r.children,a=r.slideWidth,s=r.slideIndex,o=void 0===s?0:s,s=(r.isDraggable,r.onDragStart,r.onDragEnd,r.onChange,r.onEnd,r.align),d=r.bullets,u=r.platform,c=r.hasMouse,h=r.showArrows,r=(r.window,r.document,r.getRef,r.getRootRef,(0,_objectWithoutProperties2.default)(r,_excluded)),f=e?this.calculateDragIndent():this.calculateIndent(o),f={WebkitTransform:"translateX(".concat(f,"px)"),transform:"translateX(".concat(f,"px)"),WebkitTransition:t?"-webkit-transform ".concat(n,"s cubic-bezier(.1, 0, .25, 1)"):"none",transition:t?"transform ".concat(n,"s cubic-bezier(.1, 0, .25, 1)"):"none"};return(0,_jsxRuntime.createScopedElement)("div",(0,_extends2.default)({},r,{vkuiClass:(0,_classNames.classNames)((0,_getClassName.getClassName)("Gallery",u),"Gallery--".concat(s),{"Gallery--dragging":e,"Gallery--custom-width":"custom"===a}),ref:this.getRootRef}),(0,_jsxRuntime.createScopedElement)(_Touch.Touch,{vkuiClass:"Gallery__viewport",onStartX:this.onStart,onMoveX:this.onMoveX,onEnd:this.onEnd,noSlideClick:!0,style:{width:"custom"===a?"100%":a},getRootRef:this.getViewportRef},(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"Gallery__layer",style:f},React.Children.map(l,function(e,t){return(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"Gallery__slide",key:"slide-".concat(t),ref:i.getSlideRef(t)},e)}))),d&&(0,_jsxRuntime.createScopedElement)("div",{"aria-hidden":"true",vkuiClass:(0,_classNames.classNames)("Gallery__bullets","Gallery__bullets--".concat(d))},React.Children.map(l,function(e,t){return(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:(0,_classNames.classNames)("Gallery__bullet",{"Gallery__bullet--active":t===o}),key:t})})),h&&c&&this.canSlideLeft&&(0,_jsxRuntime.createScopedElement)(_HorizontalScrollArrow.default,{direction:"left",onClick:this.slideLeft}),h&&c&&this.canSlideRight&&(0,_jsxRuntime.createScopedElement)(_HorizontalScrollArrow.default,{direction:"right",onClick:this.slideRight}))}}]),i}(React.Component),BaseGalleryAdaptive=((0,_defineProperty2.default)(BaseGallery,"defaultProps",{slideWidth:"100%",children:"",align:"left",bullets:!1,isDraggable:!0}),(0,_withAdaptivity.withAdaptivity)((0,_dom.withDOM)(BaseGallery),{hasMouse:!0})),Gallery=function(e){var t=e.initialSlideIndex,t=void 0===t?0:t,i=e.children,n=e.timeout,r=void 0===n?0:n,l=e.onChange,n=(0,_objectWithoutProperties2.default)(e,_excluded2),e=React.useState(t),t=(0,_slicedToArray2.default)(e,2),e=t[0],a=t[1],s="number"==typeof n.slideIndex,o=s?null!=(t=n.slideIndex)?t:0:e,t=!s||Boolean(l),e=React.Children.toArray(i).filter(function(e){return Boolean(e)}),d=e.length,u=React.useCallback(function(e){e!==o&&(s||a(e),l&&l(e))},[s,l,o]),c=(0,_useTimeout.useTimeout)(function(){return u((o+1)%d)},r),h=(React.useEffect(function(){return r?c.set():c.clear()},[r,o,c]),0<d?(0,_math.clamp)(o,0,d-1):o);return React.useEffect(function(){l&&h!==o&&l(h)},[l,h,o]),(0,_jsxRuntime.createScopedElement)(BaseGalleryAdaptive,(0,_extends2.default)({isDraggable:t},n,{slideIndex:h,onChange:u}),e)},_default=(0,_withPlatform.withPlatform)(Gallery);exports.default=_default;