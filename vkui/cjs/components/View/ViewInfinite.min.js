"use strict";var SwipeBackResults,_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault").default,_interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard").default,_jsxRuntime=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.ViewInfinite=void 0,require("../../lib/jsxRuntime")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_objectSpread6=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread2")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_createSuper2=_interopRequireDefault(require("@babel/runtime/helpers/createSuper")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),React=_interopRequireWildcard(require("react")),_classNames=require("../../lib/classNames"),_supportEvents=require("../../lib/supportEvents"),_getClassName=require("../../helpers/getClassName"),_platform=require("../../lib/platform"),_Touch=require("../Touch/Touch"),_withPlatform=require("../../hoc/withPlatform"),_withContext=require("../../hoc/withContext"),_ConfigProviderContext=require("../ConfigProvider/ConfigProviderContext"),_SplitCol=require("../SplitCol/SplitCol"),_AppRootPortal=require("../AppRoot/AppRootPortal"),_dom=require("../../lib/dom"),_ScrollContext=require("../AppRoot/ScrollContext"),_NavTransitionContext=require("../NavTransitionContext/NavTransitionContext"),_getNavId=require("../../lib/getNavId"),_warnOnce=require("../../lib/warnOnce"),_utils=require("./utils"),_excluded=["popout","modal","platform","activePanel","splitCol","configProvider","history","id","nav","onTransition","onSwipeBack","onSwipeBackStart","onSwipeBackCancel","window","document","scroll","isBackCheck"],warn=(0,_warnOnce.warnOnce)("ViewInfinite"),scrollsCache=(!function(e){e[e.fail=1]="fail",e[e.success=2]="success"}(SwipeBackResults=SwipeBackResults||{}),{}),ViewInfiniteComponent=function(e){(0,_inherits2.default)(i,e);var t=(0,_createSuper2.default)(i);function i(e){var a;return(0,_classCallCheck2.default)(this,i),a=t.call(this,e),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"scrolls",scrollsCache[(0,_getNavId.getNavId)(a.props,warn)]||{}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"transitionFinishTimeout",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"animationFinishTimeout",void 0),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"panelNodes",{}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"transitionEndHandler",function(e){e&&!["vkui-animation-ios-next-forward","vkui-animation-ios-prev-back","vkui-animation-view-next-forward","vkui-animation-view-prev-back"].includes(e.animationName)||null===a.state.prevPanel||a.flushTransition(a.state.prevPanel,Boolean(a.state.isBack))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"swipingBackTransitionEndHandler",function(e){if(!e||e.propertyName.includes("transform")&&e.target===a.pickPanel(a.state.swipeBackNextPanel))switch(a.state.swipeBackResult){case SwipeBackResults.fail:a.onSwipeBackCancel();break;case SwipeBackResults.success:a.onSwipeBackSuccess()}}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"onMoveX",function(e){var t,i;!(0,_utils.swipeBackExcluded)(e)&&a.window&&(i=(t=a.props).platform,t=t.configProvider,i!==_platform.IOS||null!=t&&t.isWebView||!(e.startX<=70||e.startX>=a.window.innerWidth-70)||a.state.browserSwipe||a.setState({browserSwipe:!0}),i===_platform.IOS&&null!=t&&t.isWebView&&a.props.onSwipeBack&&(a.state.animated&&e.startX<=70||(e.startX<=70&&!a.state.swipingBack&&1<(null!=(t=null==(i=a.props.history)?void 0:i.length)?t:0)&&(null!==a.state.activePanel&&(i=a.scrolls[a.state.activePanel]||[],a.scrolls=(0,_objectSpread6.default)((0,_objectSpread6.default)({},a.scrolls),{},(0,_defineProperty2.default)({},a.state.activePanel,[].concat((0,_toConsumableArray2.default)(i),[null==(t=a.props.scroll)?void 0:t.getScroll().y])))),a.setState({swipingBack:!0,swipebackStartX:e.startX,swipeBackPrevPanel:a.state.activePanel,swipeBackNextPanel:a.props.history.slice(-2)[0]})),a.state.swipingBack&&(i=e.shiftX<0?0:e.shiftX>a.window.innerWidth-a.state.swipebackStartX?a.window.innerWidth:e.shiftX,a.setState({swipeBackShift:i})))))}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(a),"onEnd",function(e){a.state.swipingBack&&a.window&&(e=a.state.swipeBackShift/e.duration*1e3,0===a.state.swipeBackShift?a.onSwipeBackCancel():a.state.swipeBackShift>=a.window.innerWidth?a.onSwipeBackSuccess():250<e||a.state.swipebackStartX+a.state.swipeBackShift>a.window.innerWidth/2?a.setState({swipeBackResult:SwipeBackResults.success}):a.setState({swipeBackResult:SwipeBackResults.fail}))}),a.state={animated:!1,visiblePanels:[e.activePanel],activePanel:e.activePanel,isBack:void 0,prevPanel:null,nextPanel:null,swipingBack:!1,swipebackStartX:0,swipeBackShift:0,swipeBackNextPanel:null,swipeBackPrevPanel:null,swipeBackResult:null,browserSwipe:!1},a}return(0,_createClass2.default)(i,[{key:"document",get:function(){return this.props.document}},{key:"window",get:function(){return this.props.window}},{key:"panels",get:function(){return React.Children.toArray(this.props.children)}},{key:"componentWillUnmount",value:function(){var e=(0,_getNavId.getNavId)(this.props);e&&(scrollsCache[e]=this.scrolls),this.animationFinishTimeout&&clearTimeout(this.animationFinishTimeout)}},{key:"componentDidUpdate",value:function(t,e){var i,a,s,n,r,l=this;this.props.popout&&!t.popout&&this.blurActiveElement(),this.props.modal&&!t.modal&&this.blurActiveElement(),t.activePanel===this.props.activePanel||e.swipingBack||e.browserSwipe||(r=!1,r=this.props.isBackCheck?this.props.isBackCheck({from:t.activePanel,to:this.props.activePanel}):this.panels.map(function(e){return(0,_getNavId.getNavId)(e.props,warn)}).find(function(e){return e===t.activePanel||e===l.props.activePanel})===this.props.activePanel,this.blurActiveElement(),n=this.scrolls[t.activePanel]||[],n=(0,_objectSpread6.default)((0,_objectSpread6.default)({},this.scrolls),{},(0,_defineProperty2.default)({},t.activePanel,[].concat((0,_toConsumableArray2.default)(n),[null==(n=this.props.scroll)?void 0:n.getScroll().y]))),this.scrolls=n,this.shouldDisableTransitionMotion()?this.flushTransition(t.activePanel,r):(this.setState({visiblePanels:[t.activePanel,this.props.activePanel],prevPanel:t.activePanel,nextPanel:this.props.activePanel,activePanel:null,animated:!0,isBack:r}),_supportEvents.animationEvent.supported||(this.animationFinishTimeout&&clearTimeout(this.animationFinishTimeout),this.animationFinishTimeout=setTimeout(this.transitionEndHandler,this.props.platform===_platform.ANDROID||this.props.platform===_platform.VKCOM?300:600)))),t.activePanel!==this.props.activePanel&&e.swipingBack&&(i=this.state.swipeBackNextPanel,a=this.state.swipeBackPrevPanel,s=void 0,this.scrolls=(0,_objectSpread6.default)({},this.scrolls),null!==a&&(n=(0,_toConsumableArray2.default)(this.scrolls[a]||[]).slice(0,-1),this.scrolls[a]=n),null!==i&&(r=(0,_toConsumableArray2.default)(this.scrolls[i]||[]),s=r.pop(),this.scrolls[i]=r),this.setState({swipeBackPrevPanel:null,swipeBackNextPanel:null,swipingBack:!1,swipeBackResult:null,swipebackStartX:0,swipeBackShift:0,activePanel:i,visiblePanels:[i]},function(){var e;null!=(e=l.props.scroll)&&e.scrollTo(0,s),t.onTransition&&t.onTransition({isBack:!0,from:a,to:i})})),!e.swipingBack&&this.state.swipingBack&&this.props.onSwipeBackStart&&this.props.onSwipeBackStart(),!e.swipeBackResult&&this.state.swipeBackResult&&this.waitTransitionFinish(this.pickPanel(this.state.swipeBackNextPanel),this.swipingBackTransitionEndHandler),e.swipeBackResult!==SwipeBackResults.fail||this.state.swipeBackResult||null===this.state.activePanel||(r=(n=(0,_toConsumableArray2.default)(this.scrolls[this.state.activePanel]||[])).pop(),this.scrolls=(0,_objectSpread6.default)((0,_objectSpread6.default)({},this.scrolls),{},(0,_defineProperty2.default)({},this.state.activePanel,n)),null!=(e=this.props.scroll)&&e.scrollTo(0,r)),t.activePanel!==this.props.activePanel&&this.state.browserSwipe&&this.setState({browserSwipe:!1,nextPanel:null,prevPanel:null,animated:!1,visiblePanels:[this.props.activePanel],activePanel:this.props.activePanel})}},{key:"shouldDisableTransitionMotion",value:function(){var e;return!1===(null==(e=this.props.configProvider)?void 0:e.transitionMotionEnabled)||!(null!=(e=this.props.splitCol)&&e.animate)}},{key:"waitTransitionFinish",value:function(e,t){_supportEvents.transitionEvent.supported&&_supportEvents.transitionEvent.name&&e?(e.removeEventListener(_supportEvents.transitionEvent.name,t),e.addEventListener(_supportEvents.transitionEvent.name,t)):(this.transitionFinishTimeout&&clearTimeout(this.transitionFinishTimeout),this.transitionFinishTimeout=setTimeout(t,this.props.platform===_platform.ANDROID||this.props.platform===_platform.VKCOM?300:600))}},{key:"blurActiveElement",value:function(){var e;void 0!==this.window&&null!=(e=this.document)&&e.activeElement&&this.document.activeElement.blur()}},{key:"pickPanel",value:function(e){if(null!==e)return this.panelNodes[e]}},{key:"flushTransition",value:function(t,i){var e,a=this,s=this.props.activePanel,n=(0,_toConsumableArray2.default)(this.scrolls[t]||[]).slice(0,-1),r=(0,_toConsumableArray2.default)(this.scrolls[s]||[]),l=i?r.pop():0;i&&(this.scrolls=(0,_objectSpread6.default)((0,_objectSpread6.default)({},this.scrolls),{},((0,_defineProperty2.default)(e={},t,n),(0,_defineProperty2.default)(e,s,r),e))),this.setState({prevPanel:null,nextPanel:null,visiblePanels:[s],activePanel:s,animated:!1,isBack:void 0},function(){var e;null!=(e=a.props.scroll)&&e.scrollTo(0,i?l:0),a.props.onTransition&&a.props.onTransition({isBack:i,from:t,to:s})})}},{key:"onSwipeBackSuccess",value:function(){this.props.onSwipeBack&&this.props.onSwipeBack()}},{key:"onSwipeBackCancel",value:function(){this.props.onSwipeBackCancel&&this.props.onSwipeBackCancel(),this.setState({swipeBackPrevPanel:null,swipeBackNextPanel:null,swipingBack:!1,swipeBackResult:null,swipebackStartX:0,swipeBackShift:0})}},{key:"calcPanelSwipeStyles",value:function(e){if(!_dom.canUseDOM||!this.window)return{};var t=e===this.state.swipeBackPrevPanel,e=e===this.state.swipeBackNextPanel;if(!t&&!e||this.state.swipeBackResult)return{};var i="".concat(this.state.swipeBackShift,"px"),a="".concat(100*this.state.swipeBackShift/this.window.innerWidth/2-50,"%"),s=.3*(this.window.innerWidth-this.state.swipeBackShift)/this.window.innerWidth;return this.state.swipeBackResult?t?{boxShadow:"-2px 0 12px rgba(0, 0, 0, ".concat(s,")")}:{}:e?{transform:"translate3d(".concat(a,", 0, 0)"),WebkitTransform:"translate3d(".concat(a,", 0, 0)")}:t?{transform:"translate3d(".concat(i,", 0, 0)"),WebkitTransform:"translate3d(".concat(i,", 0, 0)"),boxShadow:"-2px 0 12px rgba(0, 0, 0, ".concat(s,")")}:{}}},{key:"render",value:function(){var n=this,e=this.props,t=e.popout,i=e.modal,a=e.platform,e=(e.activePanel,e.splitCol,e.configProvider,e.history,e.id,e.nav,e.onTransition,e.onSwipeBack,e.onSwipeBackStart,e.onSwipeBackCancel,e.window,e.document,e.scroll,e.isBackCheck,(0,_objectWithoutProperties2.default)(e,_excluded)),s=this.state,r=s.prevPanel,l=s.nextPanel,o=s.activePanel,p=s.isBack,c=s.animated,u=s.swipeBackPrevPanel,d=s.swipeBackNextPanel,h=s.swipeBackResult,w=s.swipingBack,s=!!t,f=!!i,v=this.panels.filter(function(e){e=(0,_getNavId.getNavId)(e.props,warn);return void 0!==e&&n.state.visiblePanels.includes(e)||e===u||e===d}).sort(function(e){e=(0,_getNavId.getNavId)(e.props,warn);return e===l||e===d?w||n.state.isBack?-1:1:e===r||e===u?w||n.state.isBack?1:-1:0}),_=this.shouldDisableTransitionMotion(),_={"View--animated":!_&&this.state.animated,"View--swiping-back":!_&&this.state.swipingBack,"View--no-motion":_};return(0,_jsxRuntime.createScopedElement)(_Touch.Touch,(0,_extends2.default)({Component:"section"},e,{vkuiClass:(0,_classNames.classNames)((0,_getClassName.getClassName)("View",a),_),onMoveX:this.onMoveX,onEnd:this.onEnd}),(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"View__panels"},v.map(function(e){var t=(0,_getNavId.getNavId)(e.props,warn),i=t===r||t===u||t===d||t===l&&p,a=c&&t===(p?r:l),s=t&&n.scrolls[t]||[],s=s[s.length-1]||0;return(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:(0,_classNames.classNames)("View__panel",{"View__panel--active":t===o,"View__panel--prev":t===r,"View__panel--next":t===l,"View__panel--swipe-back-prev":t===u,"View__panel--swipe-back-next":t===d,"View__panel--swipe-back-success":h===SwipeBackResults.success,"View__panel--swipe-back-failed":h===SwipeBackResults.fail}),onAnimationEnd:a?n.transitionEndHandler:void 0,ref:function(e){return void 0!==t&&(n.panelNodes[t]=e)},style:n.calcPanelSwipeStyles(t),key:t},(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"View__panel-in",style:{marginTop:i?-s:void 0}},(0,_jsxRuntime.createScopedElement)(_NavTransitionContext.NavTransitionProvider,{entering:t===l||t===d},e)))})),(0,_jsxRuntime.createScopedElement)(_AppRootPortal.AppRootPortal,null,s&&(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"View__popout"},t),f&&(0,_jsxRuntime.createScopedElement)("div",{vkuiClass:"View__modal"},i)))}}]),i}(React.Component),ViewInfinite=((0,_defineProperty2.default)(ViewInfiniteComponent,"defaultProps",{history:[]}),(0,_withContext.withContext)((0,_withContext.withContext)((0,_withContext.withContext)((0,_withPlatform.withPlatform)((0,_dom.withDOM)(ViewInfiniteComponent)),_SplitCol.SplitColContext,"splitCol"),_ConfigProviderContext.ConfigProviderContext,"configProvider"),_ScrollContext.ScrollContext,"scroll"));exports.ViewInfinite=ViewInfinite;