"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault").default,_interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard").default,_jsxRuntime=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.ACTIVE_EFFECT_DELAY=exports.ACTIVE_DELAY=void 0,require("../../lib/jsxRuntime")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),React=_interopRequireWildcard(require("react")),_mitt=_interopRequireDefault(require("mitt")),_vkjs=require("@vkontakte/vkjs"),_Touch=require("../Touch/Touch"),_TouchContext=_interopRequireDefault(require("../Touch/TouchContext")),_classNames2=require("../../lib/classNames"),_getClassName=require("../../helpers/getClassName"),_platform=require("../../lib/platform"),_offset=require("../../lib/offset"),_touch=require("../../lib/touch"),_withAdaptivity=require("../../hoc/withAdaptivity"),_accessibility=require("../../lib/accessibility"),_useIsomorphicLayoutEffect=require("../../lib/useIsomorphicLayoutEffect"),_FocusVisible=require("../FocusVisible/FocusVisible"),_useTimeout=require("../../hooks/useTimeout"),_useExternRef=require("../../hooks/useExternRef"),_usePlatform=require("../../hooks/usePlatform"),_useFocusVisible2=require("../../hooks/useFocusVisible"),_callMultiple=require("../../lib/callMultiple"),_useBooleanState2=require("../../hooks/useBooleanState"),_excluded=["children","Component","onClick","onKeyDown","activeEffectDelay","stopPropagation","getRootRef","sizeX","hasMouse","deviceHasHover","hasHover","hoverMode","hasActive","activeMode","focusVisibleMode","onEnter","onLeave"],ACTIVE_DELAY=70,ACTIVE_EFFECT_DELAY=(exports.ACTIVE_DELAY=ACTIVE_DELAY,600),activeBus=(exports.ACTIVE_EFFECT_DELAY=ACTIVE_EFFECT_DELAY,(0,_mitt.default)()),TapState={none:0,pending:1,active:2,exiting:3},TappableContext=React.createContext({onHoverChange:_vkjs.noop});function useActivity(e,t){function o(){return n(TapState.none)}function i(){return e&&n(TapState.active)}var a=React.useMemo(function(){return Math.round(1e8*Math.random()).toString(16)},[]),u=React.useState(TapState.none),u=(0,_slicedToArray2.default)(u,2),r=u[0],n=u[1],l=(0,_useTimeout.useTimeout)(i,ACTIVE_DELAY),s=(0,_useTimeout.useTimeout)(o,t);(0,_useIsomorphicLayoutEffect.useIsomorphicLayoutEffect)(function(){return r===TapState.pending?(l.set(),l.clear):r===TapState.exiting?s.clear:(r===TapState.active&&activeBus.emit("active",a),_vkjs.noop)},[r]),(0,_useIsomorphicLayoutEffect.useIsomorphicLayoutEffect)(function(){if(r===TapState.none)return _vkjs.noop;function e(e){e!==a&&o()}return activeBus.on("active",e),function(){return activeBus.off("active",e)}},[r===TapState.none]),(0,_useIsomorphicLayoutEffect.useIsomorphicLayoutEffect)(function(){e||o()},[e]);return[r,{delayStart:function(){e&&n(TapState.pending)},start:i,stop:function(e){if(e)return n(TapState.exiting),s.set(e);o()}}]}var Tappable=function(e){var t=e.children,o=e.Component,i=e.onClick,a=e.onKeyDown,u=e.activeEffectDelay,r=void 0===u?ACTIVE_EFFECT_DELAY:u,u=e.stopPropagation,u=void 0!==u&&u,n=e.getRootRef,l=e.sizeX,s=e.hasMouse,c=e.deviceHasHover,p=e.hasHover,p=void 0===p||p,d=e.hoverMode,d=void 0===d?"background":d,f=e.hasActive,f=void 0===f||f,_=e.activeMode,_=void 0===_?"background":_,v=e.focusVisibleMode,v=void 0===v?"inside":v,b=e.onEnter,h=e.onLeave,e=(0,_objectWithoutProperties2.default)(e,_excluded),o=o||(e.href?"a":"div"),T=React.useContext(TappableContext).onHoverChange,m=React.useContext(_TouchContext.default),E=(0,_usePlatform.usePlatform)(),y=(0,_useFocusVisible2.useFocusVisible)(),C=y.focusVisible,R=y.onBlur,y=y.onFocus,x=React.useState([]),x=(0,_slicedToArray2.default)(x,2),A=x[0],q=x[1],x=React.useState(!1),x=(0,_slicedToArray2.default)(x,2),S=x[0],x=x[1],g=(0,_useBooleanState2.useBooleanState)(!1),M=g.value,j=g.setTrue,g=g.setFalse,D=M&&!e.disabled,k=f&&!S&&!e.disabled,M=c&&p&&!S,I="a"!==o&&"button"!==o&&!e.contentEditable,f=["opacity","background"].includes(d),c=["opacity","background"].includes(_),p=["inside","outside"].includes(v),S=useActivity(k,r),S=(0,_slicedToArray2.default)(S,2),L=S[0],S=S[1],P=S.start,F=S.stop,H=S.delayStart,S=L===TapState.active||L===TapState.exiting,V=(0,_useExternRef.useExternRef)(n),n=React.useRef({onHoverChange:x}).current;(0,_useIsomorphicLayoutEffect.useIsomorphicLayoutEffect)(function(){return D?(T(!0),function(){return T(!1)}):_vkjs.noop},[D]);l=(0,_classNames2.classNames)((0,_getClassName.getClassName)("Tappable",E),"Tappable--sizeX-".concat(l),M&&"Tappable--hasHover",k&&"Tappable--hasActive",M&&D&&!f&&d,k&&S&&!c&&_,C&&!p&&v,((0,_defineProperty2.default)(x={"Tappable--active":k&&S,"Tappable--mouse":s},"Tappable--hover-".concat(d),M&&D&&f),(0,_defineProperty2.default)(x,"Tappable--active-".concat(_),k&&S&&c),(0,_defineProperty2.default)(x,"Tappable--focus-visible",C),x)),f={onStart:(0,_callMultiple.callMultiple)(function(e){var t,o,e=e.originalEvent;if(k){if(e.touches&&1<e.touches.length)return F();E===_platform.ANDROID&&(t=(o=(0,_offset.getOffsetRect)(V.current)).top,o=o.left,o=(0,_touch.coordX)(e)-(null!=o?o:0),e=(0,_touch.coordY)(e)-(null!=t?t:0),q([].concat((0,_toConsumableArray2.default)(A),[{x:o,y:e,id:Date.now().toString()}]))),H()}},e.onStart),onMove:(0,_callMultiple.callMultiple)(function(e){e.isSlide&&F()},e.onMove),onEnd:(0,_callMultiple.callMultiple)(function(e){var e=e.duration;L!==TapState.none&&(L===TapState.pending&&P(),F(100<=(e=e-ACTIVE_DELAY)?0:r-e))},e.onEnd),onClick:i,onKeyDown:(0,_callMultiple.callMultiple)(function(e){I&&(0,_accessibility.shouldTriggerClickOnEnterOrSpace)(e)&&(e.preventDefault(),null!=(e=V.current)&&e.click())},a)},S=e.href?"link":"button";return(0,_jsxRuntime.createScopedElement)(_Touch.Touch,(0,_extends2.default)({onEnter:(0,_callMultiple.callMultiple)(j,b),onLeave:(0,_callMultiple.callMultiple)(g,h),type:"button"===o?"button":void 0,tabIndex:I&&!e.disabled?0:void 0,role:I?S:void 0,"aria-disabled":I?e.disabled:void 0,stopPropagation:u&&!m&&!e.disabled},e,{slideThreshold:20,usePointerHover:!0,vkuiClass:l,Component:o,getRootRef:V,onBlur:(0,_callMultiple.callMultiple)(R,e.onBlur),onFocus:(0,_callMultiple.callMultiple)(y,e.onFocus)},e.disabled?{}:f),(0,_jsxRuntime.createScopedElement)(TappableContext.Provider,{value:n},t),E===_platform.ANDROID&&!s&&k&&"background"===_&&(0,_jsxRuntime.createScopedElement)("span",{"aria-hidden":"true",vkuiClass:"Tappable__waves"},A.map(function(t){return(0,_jsxRuntime.createScopedElement)(Wave,(0,_extends2.default)({},t,{key:t.id,onClear:function(){return q(A.filter(function(e){return e.id!==t.id}))}}))})),M&&"background"===d&&(0,_jsxRuntime.createScopedElement)("span",{"aria-hidden":"true",vkuiClass:"Tappable__hoverShadow"}),!e.disabled&&p&&(0,_jsxRuntime.createScopedElement)(_FocusVisible.FocusVisible,{mode:v}))},_default=(0,_withAdaptivity.withAdaptivity)(Tappable,{sizeX:!0,hasMouse:!0,deviceHasHover:!0});function Wave(e){var t=e.x,o=e.y,e=e.onClear,i=(0,_useTimeout.useTimeout)(e,225);return React.useEffect(function(){return i.set()},[i]),(0,_jsxRuntime.createScopedElement)("span",{vkuiClass:"Tappable__wave",style:{top:o,left:t}})}exports.default=_default;