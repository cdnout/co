"use strict";exports.__esModule=!0,exports.listenForOpenTunnel=listenForOpenTunnel,exports.hasBridge=hasBridge,exports.openBridge=openBridge,exports.linkWindow=linkWindow,exports.linkUrl=linkUrl,exports.listenForWindowOpen=listenForWindowOpen,exports.destroyBridges=destroyBridges;var _src=require("zalgo-promise/src"),_src2=require("cross-domain-utils/src"),_conf=require("../conf"),_lib=require("../lib"),_global=require("../global"),_common=require("./common");function listenForOpenTunnel({on:e,send:o,receiveMessage:n}){const r=(0,_global.globalStore)("popupWindowsByName");e(_conf.MESSAGE_NAME.OPEN_TUNNEL,({source:t,origin:i,data:s})=>{const d=(0,_global.globalStore)("bridges").get(i);if(!d)throw new Error(`Can not find bridge promise for domain ${i}`);return d.then(d=>{if(t!==d)throw new Error(`Message source does not matched registered bridge for domain ${i}`);if(!s.name)throw new Error("Register window expected to be passed window name");if(!s.sendMessage)throw new Error("Register window expected to be passed sendMessage method");if(!r.has(s.name))throw new Error(`Window with name ${s.name} does not exist, or was not opened by this window`);const a=()=>{return r.get(s.name)};if(!a().domain)throw new Error(`We do not have a registered domain for window ${s.name}`);if(a().domain!==i)throw new Error(`Message origin ${i} does not matched registered window origin ${a().domain||"unknown"}`);return(0,_common.registerRemoteSendMessage)(a().win,i,s.sendMessage),{sendMessage(r){if(!window||window.closed)return;if(!a())return;const t=a().domain;if(t)try{n({data:r,origin:t,source:a().win},{on:e,send:o})}catch(e){_src.ZalgoPromise.reject(e)}}}})})}function openBridgeFrame(e,o){const n=document.createElement("iframe");return n.setAttribute("name",e),n.setAttribute("id",e),n.setAttribute("style","display: none; margin: 0; padding: 0; border: 0px none; overflow: hidden;"),n.setAttribute("frameborder","0"),n.setAttribute("border","0"),n.setAttribute("scrolling","no"),n.setAttribute("allowTransparency","true"),n.setAttribute("tabindex","-1"),n.setAttribute("hidden","true"),n.setAttribute("title",""),n.setAttribute("role","presentation"),n.src=o,n}function hasBridge(e,o){return(0,_global.globalStore)("bridges").has(o||(0,_src2.getDomainFromUrl)(e))}function openBridge(e,o){const n=(0,_global.globalStore)("bridges"),r=(0,_global.globalStore)("bridgeFrames");return o=o||(0,_src2.getDomainFromUrl)(e),n.getOrSet(o,()=>_src.ZalgoPromise.try(()=>{if((0,_src2.getDomain)()===o)throw new Error(`Can not open bridge on the same domain as current domain: ${o}`);const n=(0,_common.getBridgeName)(o);if((0,_src2.getFrameByName)(window,n))throw new Error(`Frame with name ${n} already exists on page`);const t=openBridgeFrame(n,e);return r.set(o,t),_common.documentBodyReady.then(o=>{o.appendChild(t);const n=t.contentWindow;return new _src.ZalgoPromise((e,o)=>{t.addEventListener("load",e),t.addEventListener("error",o)}).then(()=>(0,_lib.awaitWindowHello)(n,_conf.BRIDGE_TIMEOUT,`Bridge ${e}`)).then(()=>n)})}))}function linkWindow({win:e,name:o,domain:n}){const r=(0,_global.globalStore)("popupWindowsByName"),t=(0,_global.windowStore)("popupWindowsByWin");for(const e of r.keys()){const o=r.get(e);o&&!(0,_src2.isWindowClosed)(o.win)||r.del(e)}if((0,_src2.isWindowClosed)(e))return{win:e,name:o,domain:n};const i=t.getOrSet(e,()=>o?r.getOrSet(o,()=>({win:e,name:o})):{win:e});if(i.win&&i.win!==e)throw new Error(`Different window already linked for window: ${o||"undefined"}`);return o&&(i.name=o,r.set(o,i)),n&&(i.domain=n,(0,_common.registerRemoteWindow)(e)),t.set(e,i),i}function linkUrl(e,o){linkWindow({win:e,domain:(0,_src2.getDomainFromUrl)(o)})}function listenForWindowOpen(){const e=window.open;window.open=function(o,n,r,t){const i=e.call(this,(0,_src2.normalizeMockUrl)(o),n,r,t);return i?(linkWindow({win:i,name:n,domain:o?(0,_src2.getDomainFromUrl)(o):null}),i):i}}function destroyBridges(){const e=(0,_global.globalStore)("bridges"),o=(0,_global.globalStore)("bridgeFrames");for(const e of o.keys()){const n=o.get(e);n&&n.parentNode&&n.parentNode.removeChild(n)}o.reset(),e.reset()}