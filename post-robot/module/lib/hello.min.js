"use strict";exports.__esModule=!0,exports.sayHello=sayHello,exports.getWindowInstanceID=getWindowInstanceID,exports.initHello=initHello,exports.awaitWindowHello=awaitWindowHello;var _src=require("cross-domain-utils/src"),_src2=require("zalgo-promise/src"),_src3=require("belter/src"),_conf=require("../conf"),_global=require("../global");function getInstanceID(){return(0,_global.globalStore)("instance").getOrSet("instanceID",_src3.uniqueID)}function getHelloPromise(e){return(0,_global.windowStore)("helloPromises").getOrSet(e,()=>new _src2.ZalgoPromise)}function resolveHelloPromise(e,{domain:o}){const n=(0,_global.windowStore)("helloPromises"),t=n.get(e);t&&t.resolve({domain:o});const r=_src2.ZalgoPromise.resolve({domain:o});return n.set(e,r),r}function listenForHello({on:e}){return e(_conf.MESSAGE_NAME.HELLO,{domain:_conf.WILDCARD},({source:e,origin:o})=>(resolveHelloPromise(e,{domain:o}),{instanceID:getInstanceID()}))}function sayHello(e,{send:o}){return o(e,_conf.MESSAGE_NAME.HELLO,{instanceID:getInstanceID()},{domain:_conf.WILDCARD,timeout:-1}).then(({origin:o,data:{instanceID:n}})=>(resolveHelloPromise(e,{domain:o}),{win:e,domain:o,instanceID:n}))}function getWindowInstanceID(e,{send:o}){return(0,_global.windowStore)("windowInstanceIDPromises").getOrSet(e,()=>sayHello(e,{send:o}).then(({instanceID:e})=>e))}function initHello({on:e,send:o}){return(0,_global.globalStore)("builtinListeners").getOrSet("helloListener",()=>{const n=listenForHello({on:e}),t=(0,_src.getAncestor)();return t&&sayHello(t,{send:o}).catch(e=>{if(__TEST__&&(0,_global.getGlobal)(t))throw e}),n})}function awaitWindowHello(e,o=5e3,n="Window"){let t=getHelloPromise(e);return-1!==o&&(t=t.timeout(o,new Error(`${n} did not load after ${o}ms`))),t}