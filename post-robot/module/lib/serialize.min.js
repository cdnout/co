import{WeakMap}from"cross-domain-safe-weakmap/src";import{matchDomain}from"cross-domain-utils/src";import{ZalgoPromise}from"zalgo-promise/src";import{once,uniqueID}from"belter/src";import{TYPE,serialize,serializeType,deserialize}from"universal-serialize/src";import{MESSAGE_NAME,WILDCARD}from"../conf";import{global}from"../global";global.methods=global.methods||new WeakMap;var listenForFunctionCalls=once(function(){global.on(MESSAGE_NAME.METHOD,{origin:WILDCARD},function(e){var i=e.source,r=e.origin,n=e.data,o=global.methods.get(i);if(!o)throw new Error("Could not find any methods this window has privileges to call");var a=o[n.id];if(!a)throw new Error("Could not find method with id: "+n.id);if(!matchDomain(a.domain,r))throw new Error("Method domain "+a.domain+" does not match origin "+r);return ZalgoPromise.try(function(){return a.val.apply({source:i,origin:r,data:n},n.args)}).then(function(e){return{result:e,id:n.id,name:n.name}})})}),CUSTOM_TYPE={CROSS_DOMAIN_ZALGO_PROMISE:"cross_domain_zalgo_promise",CROSS_DOMAIN_FUNCTION:"cross_domain_function"};function serializeFunction(e,i,r,n){var o=uniqueID(),a=global.methods.get(e);return a||(a={},global.methods.set(e,a)),a[o]={domain:i,val:r},listenForFunctionCalls(),serializeType(CUSTOM_TYPE.CROSS_DOMAIN_FUNCTION,{id:o,name:r.name||n})}function deserializeFunction(e,i,r){var n=r.id,o=r.name;function a(){var r=Array.prototype.slice.call(arguments);return global.send(e,MESSAGE_NAME.METHOD,{id:n,name:o,args:r},{domain:i}).then(function(e){return e.data.result})}return a.__name__=o,a.__xdomain__=!0,a.source=e,a.origin=i,a}function serializePromise(e,i,r,n){return serializeType(CUSTOM_TYPE.CROSS_DOMAIN_ZALGO_PROMISE,{then:serializeFunction(e,i,function(e,i){return r.then(e,i)},n)})}function deserializePromise(e,i,r){var n=r.then;return new ZalgoPromise(function(r,o){deserializeFunction(e,i,n)(r,o)})}export function serializeMessage(e,i,r){var n;return serialize(r,((n={})[TYPE.PROMISE]=function(r,n){return serializePromise(e,i,r,n)},n[TYPE.FUNCTION]=function(r,n){return serializeFunction(e,i,r,n)},n))};export function deserializeMessage(e,i,r){var n;return deserialize(r,((n={})[CUSTOM_TYPE.CROSS_DOMAIN_ZALGO_PROMISE]=function(r){var n=r.then;return deserializePromise(e,i,{then:n})},n[CUSTOM_TYPE.CROSS_DOMAIN_FUNCTION]=function(r){var n=r.id,o=r.name;return deserializeFunction(e,i,{id:n,name:o})},n))};