export{_send as send};import{ZalgoPromise}from"zalgo-promise/src";import{getAncestor,isAncestor,isWindowClosed,getDomain,matchDomain}from"cross-domain-utils/src";import{uniqueID,isRegex}from"belter/src";import{CONFIG,MESSAGE_TYPE,WILDCARD,MESSAGE_NAME}from"../conf";import{sendMessage,addResponseListener,deleteResponseListener,markResponseListenerErrored}from"../drivers";import{awaitWindowHello,sayHello,isWindowKnown}from"../lib";import{global,windowStore}from"../global";export var requestPromises=windowStore("requestPromises");export function request(e){return ZalgoPromise.try(function(){if(!e.name)throw new Error("Expected options.name");var o=e.name,n=void 0,r=void 0;if("string"==typeof e.window){var t=document.getElementById(e.window);if(!t)throw new Error("Expected options.window "+Object.prototype.toString.call(e.window)+" to be a valid element id");if("iframe"!==t.tagName.toLowerCase())throw new Error("Expected options.window "+Object.prototype.toString.call(e.window)+" to be an iframe");if(!t.contentWindow)throw new Error("Iframe must have contentWindow.  Make sure it has a src attribute and is in the DOM.");n=t.contentWindow}else if(e.window instanceof HTMLIFrameElement){if("iframe"!==e.window.tagName.toLowerCase())throw new Error("Expected options.window "+Object.prototype.toString.call(e.window)+" to be an iframe");if(e.window&&!e.window.contentWindow)throw new Error("Iframe must have contentWindow.  Make sure it has a src attribute and is in the DOM.");e.window&&e.window.contentWindow&&(n=e.window.contentWindow)}else n=e.window;if(!n)throw new Error("Expected options.window to be a window object, iframe, or iframe element id.");var i=n;r=e.domain||WILDCARD;var a=e.name+"_"+uniqueID();if(isWindowClosed(i))throw new Error("Target window is closed");var s=!1,d=requestPromises.getOrSet(i,function(){return[]}),w=ZalgoPromise.try(function(){if(isAncestor(window,i))return awaitWindowHello(i,e.timeout||CONFIG.CHILD_WINDOW_TIMEOUT)}).then(function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).domain;if(isRegex(r)&&!e)return sayHello(i)}).then(function(){var n=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).domain;if(isRegex(r)){if(!matchDomain(r,n))throw new Error("Remote window domain "+n+" does not match regex: "+r.toString());r=n}if("string"!=typeof r&&!Array.isArray(r))throw new TypeError("Expected domain to be a string or array");var t=r,m=o===MESSAGE_NAME.METHOD&&e.data&&"string"==typeof e.data.name?e.data.name+"()":o;return new ZalgoPromise(function(n,f){var c=void 0;if(e.fireAndForget||addResponseListener(a,c={name:o,window:i,domain:t,respond:function(e,o){e||(s=!0,d.splice(d.indexOf(w,1))),e?(__DEBUG__&&console.error("receive::err",m,r,"\n\n",e),f(e)):(__DEBUG__&&console.info("receive::res",m,r,"\n\n",o),n(o))}}),__DEBUG__&&console.info("send::req",m,r,"\n\n",e.data),sendMessage(i,t,{type:MESSAGE_TYPE.REQUEST,hash:a,name:o,data:e.data,fireAndForget:Boolean(e.fireAndForget)}).catch(f),e.fireAndForget)return n();var l=isWindowKnown(i)?CONFIG.ACK_TIMEOUT_KNOWN:CONFIG.ACK_TIMEOUT,u=e.timeout||CONFIG.RES_TIMEOUT,p=l,E=u,g=100;setTimeout(function e(){if(!s){if(isWindowClosed(i))return c.ack?f(new Error("Window closed for "+o+" before response")):f(new Error("Window closed for "+o+" before ack"));if(p=Math.max(p-g,0),-1!==E&&(E=Math.max(E-g,0)),c.ack){if(-1===E)return;g=Math.min(E,2e3)}else{if(0===p)return f(new Error("No ack for postMessage "+o+" in "+getDomain()+" in "+l+"ms"));if(0===E)return f(new Error("No response for postMessage "+o+" in "+getDomain()+" in "+u+"ms"))}setTimeout(e,g)}},g)})});return w.catch(function(){markResponseListenerErrored(a),deleteResponseListener(a)}),d.push(w),w})};function _send(e,o,n,r){return(r=r||{}).window=e,r.name=o,r.data=n,request(r)}export function sendToParent(e,o,n){var r=getAncestor();return r?_send(r,e,o,n):new ZalgoPromise(function(e,o){return o(new Error("Window does not have a parent"))})};export function client(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e.window)throw new Error("Expected options.window");var o=e.window;return{send:function(n,r){return _send(o,n,r,e)}}};global.send=_send;