"use strict";exports.__esModule=!0,exports.serializeFunction=serializeFunction,exports.deserializeFunction=deserializeFunction;var _src=require("cross-domain-utils/src"),_src2=require("zalgo-promise/src"),_src3=require("belter/src"),_src4=require("universal-serialize/src"),_conf=require("../conf"),_global=require("../global"),_window=require("./window");function addMethod(o,n,e,r,i){const t=(0,_global.windowStore)("methodStore"),a=(0,_global.globalStore)("proxyWindowMethods");if(_window.ProxyWindow.isProxyWindow(r))a.set(o,{val:n,name:e,domain:i,source:r});else{a.del(o),t.getOrSet(r,()=>({}))[o]={domain:i,name:e,val:n,source:r}}}function lookupMethod(o,n){const e=(0,_global.windowStore)("methodStore"),r=(0,_global.globalStore)("proxyWindowMethods");return e.getOrSet(o,()=>({}))[n]||r.get(n)}function stringifyArguments(o=[]){return(0,_src3.arrayFrom)(o).map(o=>"string"==typeof o?`'${o}'`:void 0===o?"undefined":null===o?"null":"boolean"==typeof o?o.toString():Array.isArray(o)?"[ ... ]":"object"==typeof o?"{ ... }":"function"==typeof o?"() => { ... }":`<${typeof o}>`).join(", ")}function listenForFunctionCalls({on:o,send:n}){return(0,_global.globalStore)("builtinListeners").getOrSet("functionCalls",()=>o(_conf.MESSAGE_NAME.METHOD,{domain:_conf.WILDCARD},({source:o,origin:e,data:r})=>{const{id:i,name:t}=r,a=lookupMethod(o,i);if(!a)throw new Error(`Could not find method '${t}' with id: ${r.id} in ${(0,_src.getDomain)(window)}`);const{source:s,domain:d,val:c}=a;return _src2.ZalgoPromise.try(()=>{if(!(0,_src.matchDomain)(d,e))throw new Error(`Method '${r.name}' domain ${JSON.stringify((0,_src3.isRegex)(a.domain)?a.domain.source:a.domain)} does not match origin ${e} in ${(0,_src.getDomain)(window)}`);if(_window.ProxyWindow.isProxyWindow(s))return s.matchWindow(o,{send:n}).then(o=>{if(!o)throw new Error(`Method call '${r.name}' failed - proxy window does not match source in ${(0,_src.getDomain)(window)}`)})}).then(()=>c.apply({source:o,origin:e},r.args),o=>_src2.ZalgoPromise.try(()=>{if(c.onError)return c.onError(o)}).then(()=>{throw o.stack&&(o.stack=`Remote call to ${t}(${stringifyArguments(r.args)}) failed\n\n${o.stack}`),o})).then(o=>({result:o,id:i,name:t}))}))}function serializeFunction(o,n,e,r,{on:i,send:t}){listenForFunctionCalls({on:i,send:t});const a=e.__id__||(0,_src3.uniqueID)();o=_window.ProxyWindow.unwrap(o);let s=e.__name__||e.name||r;return"string"==typeof s&&"function"==typeof s.indexOf&&0===s.indexOf("anonymous::")&&(s=s.replace("anonymous::",`${r}::`)),_window.ProxyWindow.isProxyWindow(o)?(addMethod(a,e,s,o,n),o.awaitWindow().then(o=>{addMethod(a,e,s,o,n)})):addMethod(a,e,s,o,n),(0,_src4.serializeType)(_conf.SERIALIZATION_TYPE.CROSS_DOMAIN_FUNCTION,{id:a,name:s})}function deserializeFunction(o,n,{id:e,name:r},{send:i}){const t=(t={})=>{function a(){let s;return __DEBUG__&&(s=new Error(`Original call to ${r}():`).stack),_window.ProxyWindow.toProxyWindow(o,{send:i}).awaitWindow().then(o=>{const s=lookupMethod(o,e);if(s&&s.val!==a)return s.val.apply({source:window,origin:(0,_src.getDomain)()},arguments);{const a=Array.prototype.slice.call(arguments);return t.fireAndForget?i(o,_conf.MESSAGE_NAME.METHOD,{id:e,name:r,args:a},{domain:n,fireAndForget:!0}):i(o,_conf.MESSAGE_NAME.METHOD,{id:e,name:r,args:a},{domain:n,fireAndForget:!1}).then(o=>o.data.result)}}).catch(o=>{throw __DEBUG__&&s&&o.stack&&(o.stack=`Remote call to ${r}(${stringifyArguments(arguments)}) failed\n\n${o.stack}\n\n${s}`),o})}return a.__name__=r,a.__origin__=n,a.__source__=o,a.__id__=e,a.origin=n,a},a=t();return a.fireAndForget=t({fireAndForget:!0}),a}