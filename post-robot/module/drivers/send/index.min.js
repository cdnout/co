"use strict";exports.__esModule=!0,exports.sendMessage=sendMessage;var _src=require("zalgo-promise/src"),_src2=require("cross-domain-utils/src"),_src3=require("belter/src"),_serialize=require("../../serialize"),_global=require("../../global"),_strategies=require("./strategies");function packMessages(e){return{[(0,_global.getGlobalKey)()]:e}}function sendMessage(e,s,r,{on:t,send:o}){return _src.ZalgoPromise.try(()=>{const i=(0,_global.windowStore)().getOrSet(e,()=>({}));return i.buffer=i.buffer||[],i.buffer.push(r),i.flush=i.flush||_src.ZalgoPromise.flush().then(()=>{if((0,_src2.isWindowClosed)(e))throw new Error("Window is closed");const r=(0,_serialize.serializeMessage)(e,s,packMessages(i.buffer||[]),{on:t,send:o});delete i.buffer;const n=Object.keys(_strategies.SEND_MESSAGE_STRATEGIES),l=[];for(const t of n)try{_strategies.SEND_MESSAGE_STRATEGIES[t](e,r,s)}catch(e){l.push(e)}if(l.length===n.length)throw new Error(`All post-robot messaging strategies failed:\n\n${l.map((e,s)=>`${s}. ${(0,_src3.stringifyError)(e)}`).join("\n\n")}`)}),i.flush.then(()=>{delete i.flush})}).then(_src3.noop)}