(function(n,l){if(!n.jQuery)throw"agility.js: jQuery not found";var d=jQuery,k,h={},p={},r=0;if(!Object.create||0>Object.create.toString().search(/native code/i))Object.create=function(a){var b=function(){};d.extend(b.prototype,a);return new b};if(!Object.getPrototypeOf||0>Object.getPrototypeOf.toString().search(/native code/i))Object.getPrototypeOf="object"===typeof"test".__proto__?function(a){return a.__proto__}:function(a){return a.constructor.prototype};h.isAgility=function(a){return!0===a._agility};
h.proxyAll=function(a,b){if(!a||!b)throw"agility.js: util.proxyAll needs two arguments";for(var c in a){var e=a[c];if("function"===typeof a[c])e=a[c]._noProxy?a[c]:d.proxy(a[c]._preProxy||a[c],b),e._preProxy=a[c]._noProxy?l:a[c]._preProxy||a[c],a[c]=e;else if("object"===typeof a[c]){for(var f in a[c]){var g=a[c][f];"function"===typeof a[c][f]&&(g=a[c][f]._noProxy?a[c][f]:d.proxy(a[c][f]._preProxy||a[c][f],b),g._preProxy=a[c][f]._noProxy?l:a[c][f]._preProxy||a[c][f],e[f]=g)}a[c]=e}}};h.reverseEvents=
function(a,b){var c=d(a).data("events");if(c!==l&&c[b]!==l){var e=[],f;for(f in c[b])c[b].hasOwnProperty(f)&&e.unshift(c[b][f]);c[b]=e}};h.size=function(a){var b=0,c;for(c in a)b++;return b};h.extendController=function(a){for(var b in a.controller)(function(){var c,e,f,g;"function"===typeof a.controller[b]&&(c=b.match(/^(\~)*(.+)/),e=c[1],c=c[2],e&&(f=a.controller[c]?a.controller[c]._preProxy||a.controller[c]:l,g=a.controller[b],a.controller[c]=function(){f&&f.apply(this,arguments);g&&g.apply(this,
arguments)},delete a.controller[b]))})()};p={_agility:!0,_container:{_insertObject:function(a,b,c){var e=this;if(!h.isAgility(a))throw"agility.js: append argument is not an agility object";this._container.children[a._id]=a;this.trigger(c,[a,b]);a._parent=this;a.bind("destroy",function(a,b){e._container.remove(b)});return this},append:function(a,b){return this._container._insertObject.call(this,a,b,"append")},prepend:function(a,b){return this._container._insertObject.call(this,a,b,"prepend")},after:function(a,
b){return this._container._insertObject.call(this,a,b,"after")},before:function(a,b){return this._container._insertObject.call(this,a,b,"before")},remove:function(a){delete this._container.children[a];this.trigger("remove",a);return this},each:function(a){d.each(this._container.children,a);return this},empty:function(){this.each(function(){this.destroy()});return this},size:function(){return h.size(this._container.children)}},_events:{parseEventStr:function(a){var b={type:a},c=a.search(/\s/);-1<c&&
(b.type=a.substr(0,c),b.selector=a.substr(c+1));return b},bind:function(a,b){var c=this._events.parseEventStr(a);c.selector?"&"===c.selector?this.view.$().bind(c.type,b):this.view.$().delegate(c.selector,c.type,b):d(this._events.data).bind(c.type,b);return this},trigger:function(a,b){var c=this._events.parseEventStr(a);c.selector?"&"===c.selector?this.view.$().trigger(c.type,b):this.view.$().find(c.selector).trigger(c.type,b):(d(this._events.data).trigger("_"+c.type,b),h.reverseEvents(this._events.data,
"pre:"+c.type),d(this._events.data).trigger("pre:"+c.type,b),h.reverseEvents(this._events.data,"pre:"+c.type),d(this._events.data).trigger(c.type,b),this.parent()&&this.parent().trigger((c.type.match(/^child:/)?"":"child:")+c.type,b),d(this._events.data).trigger("post:"+c.type,b));return this}},model:{set:function(a,b){var c=this,e=[];if("object"===typeof a){var f=!1;b&&b.reset?(f=this.model._data,this.model._data=d.extend({},a)):d.extend(this.model._data,a);for(var g in a)delete f[g],e.push(g);for(g in f)e.push(g)}else throw"agility.js: unknown argument type in model.set()";
if(b&&!0===b.silent)return this;this.trigger("change");d.each(e,function(a,b){c.trigger("change:"+b)});return this},get:function(a){if(a===l)return this.model._data;if("string"===typeof a)return this.model._data[a];throw"agility.js: unknown argument for getter";},reset:function(){this.model.set(this.model._initData,{reset:!0});return this},size:function(){return h.size(this.model._data)},each:function(a){d.each(this.model._data,a);return this}},view:{format:"<div/>",style:"",$:function(a){return a&&
"&"!==a?this.view.$root.find(a):this.view.$root},render:function(){if(0===this.view.format.length)throw"agility.js: empty format in view.render()";0===this.view.$root.size()?this.view.$root=d(this.view.format):this.view.$root.html(d(this.view.format).html());if(0===this.view.$root.size())throw"agility.js: could not generate html from format";return this},_parseBindStr:function(a){var b={key:null,attr:[]},c=a.split(","),e=/([a-zA-Z0-9_\-]+)(?:[\s=]+([a-zA-Z0-9_\-]+))?/,f=!1,g;if(0<c.length)for(var q=
0;q<c.length;q++)if(g=c[q].match(e))if("undefined"===typeof g[2]||""===g[2]){if(f)throw Error("You may specify only one key ("+f+" has already been specified in data-bind="+a+")");f=g[1];b.key=g[1]}else b.attr.push({attr:g[1],attrVar:g[2]});return b},bindings:function(){var a=this,b=this.view.$().filter("[data-bind]"),c=this.view.$("[data-bind]"),e=function(b,c,e){var d=b.attr[e];return function(){c.attr(d.attr,a.model.get(d.attrVar))}};b.add(c).each(function(){var b=d(this),c=a.view._parseBindStr(b.data("bind"));
b.is("input:checkbox")?(a.bind("_change:"+c.key,function(){b.prop("checked",a.model.get(c.key))}),b.change(function(){var b={};b[c.key]=d(this).prop("checked");a.model.set(b)})):b.is("select")?(a.bind("_change:"+c.key,function(){b.attr("name");var e=a.model.get(c.key);b.val(e)}),b.change(function(){var e={};e[c.key]=b.val();a.model.set(e)})):b.is("input:radio")?(a.bind("_change:"+c.key,function(){var e=b.attr("name"),d=a.model.get(c.key);b.siblings('input[name="'+e+'"]').filter('[value="'+d+'"]').prop("checked",
!0)}),b.change(function(){if(b.prop("checked")){var e={};e[c.key]=b.val();a.model.set(e)}})):b.is('input[type="search"]')?(a.bind("_change:"+c.key,function(){b.val(a.model.get(c.key))}),b.keypress(function(){setTimeout(function(){var e={};e[c.key]=b.val();a.model.set(e)},50)})):b.is("input:text, textarea")?(a.bind("_change:"+c.key,function(){b.val(a.model.get(c.key))}),b.change(function(){var b={};b[c.key]=d(this).val();a.model.set(b)})):c.key&&a.bind("_change:"+c.key,function(){a.model.get(c.key)?
b.text(a.model.get(c.key).toString()):b.text("")});(function(){if(c.attr)for(var d=0;d<c.attr.length;d++)a.bind("_change:"+c.attr[d].attrVar,e(c,b,d))})()});return this},sync:function(){var a=this;this.model.each(function(b,c){a.trigger("_change:"+b)});0<this.model.size()&&this.trigger("_change");return this},stylize:function(){var a,b=RegExp("&","g");if(0!==this.view.style.length&&0!==this.view.$().size()){if(this.view.hasOwnProperty("style"))a="agility_"+this._id,b=this.view.style.replace(b,"."+
a),d("head",n.document).append('<style type="text/css">'+b+"</style>");else{a:{for(a=this;null!==a;)if(a=Object.getPrototypeOf(a),a.view.hasOwnProperty("style")){a=a._id;break a}a=l}a="agility_"+a}this.view.$().addClass(a);return this}}},controller:{_create:function(a){this.view.stylize();this.view.bindings();this.view.sync()},_destroy:function(a){this._container.empty();this.view.$().remove()},_append:function(a,b,c){this.view.$(c).append(b.view.$())},_prepend:function(a,b,c){this.view.$(c).prepend(b.view.$())},
_before:function(a,b,c){if(!c)throw"agility.js: _before needs a selector";this.view.$(c).before(b.view.$())},_after:function(a,b,c){if(!c)throw"agility.js: _after needs a selector";this.view.$(c).after(b.view.$())},_remove:function(a,b){},_change:function(a){}},destroy:function(){this.trigger("destroy",this._id)},parent:function(){return this._parent},append:function(){this._container.append.apply(this,arguments);return this},prepend:function(){this._container.prepend.apply(this,arguments);return this},
after:function(){this._container.after.apply(this,arguments);return this},before:function(){this._container.before.apply(this,arguments);return this},remove:function(){this._container.remove.apply(this,arguments);return this},size:function(){return this._container.size.apply(this,arguments)},each:function(){return this._container.each.apply(this,arguments)},empty:function(){return this._container.empty.apply(this,arguments)},bind:function(){this._events.bind.apply(this,arguments);return this},trigger:function(){this._events.trigger.apply(this,
arguments);return this}};k=function(){var a=Array.prototype.slice.call(arguments,0),b={},c=p;"object"===typeof a[0]&&h.isAgility(a[0])&&(c=a[0],a.shift());b=Object.create(c);b.model=Object.create(c.model);b.view=Object.create(c.view);b.controller=Object.create(c.controller);b._container=Object.create(c._container);b._events=Object.create(c._events);b._id=r++;b._parent=null;b._events.data={};b._container.children={};b.view.$root=d();b.model._data=c.model._data?d.extend(!0,{},c.model._data):{};b._data=
c._data?d.extend(!0,{},c._data):{};if(0!==a.length)if(1===a.length&&"object"===typeof a[0]&&(a[0].model||a[0].view||a[0].controller))for(var e in a[0])"model"===e?d.extend(b.model._data,a[0].model):"view"===e?d.extend(b.view,a[0].view):"controller"===e?(d.extend(b.controller,a[0].controller),h.extendController(b)):b[e]=a[0][e];else{if("object"===typeof a[0])d.extend(b.model._data,a[0]);else if(a[0])throw"agility.js: unknown argument type (model)";if("string"===typeof a[1])b.view.format=a[1];else if("object"===
typeof a[1])d.extend(b.view,a[1]);else if(a[1])throw"agility.js: unknown argument type (view)";"string"===typeof a[2]&&(b.view.style=a[2],a.splice(2,1));if("object"===typeof a[2])d.extend(b.controller,a[2]),h.extendController(b);else if(a[2])throw"agility.js: unknown argument type (controller)";}b.model._initData=d.extend({},b.model._data);h.proxyAll(b,b);b.view.render();for(var f in b.controller){var a=f.split(";"),g=b.controller[f];d.each(a,function(a,c){c=c.trim();"function"===typeof g&&b.bind(c,
g)})}b.trigger("create");return b};k.document=k({view:{$:function(a){return a?d(a,"body"):d("body")}},controller:{_create:function(){}}});k.fn=p;k.isAgility=function(a){return"object"!==typeof a?!1:h.isAgility(a)};n.agility=n.$$=k;k.fn.persist=function(a,b){var c="id";this._data.persist=d.extend({adapter:a},b);this._data.persist.openRequests=0;b&&b.id&&(c=b.id);this.save=function(){var a=this;0===this._data.persist.openRequests&&this.trigger("persist:start");this._data.persist.openRequests++;this._data.persist.adapter.call(this,
{type:this.model.get(c)?"PUT":"POST",id:this.model.get(c),data:this.model.get(),complete:function(){a._data.persist.openRequests--;0===a._data.persist.openRequests&&a.trigger("persist:stop")},success:function(b,d,h){b[c]?a.model.set({id:b[c]},{silent:!0}):h.getResponseHeader("Location")&&a.model.set({id:h.getResponseHeader("Location").match(/\/([0-9]+)$/)[1]},{silent:!0});a.trigger("persist:save:success")},error:function(){a.trigger("persist:error");a.trigger("persist:save:error")}});return this};
this.load=function(){var a=this;if(this.model.get(c)===l)throw"agility.js: load() needs model id";0===this._data.persist.openRequests&&this.trigger("persist:start");this._data.persist.openRequests++;this._data.persist.adapter.call(this,{type:"GET",id:this.model.get(c),complete:function(){a._data.persist.openRequests--;0===a._data.persist.openRequests&&a.trigger("persist:stop")},success:function(b,c,d){a.model.set(b);a.trigger("persist:load:success")},error:function(){a.trigger("persist:error");a.trigger("persist:load:error")}});
return this};this.erase=function(){var a=this;if(this.model.get(c)===l)throw"agility.js: erase() needs model id";0===this._data.persist.openRequests&&this.trigger("persist:start");this._data.persist.openRequests++;this._data.persist.adapter.call(this,{type:"DELETE",id:this.model.get(c),complete:function(){a._data.persist.openRequests--;0===a._data.persist.openRequests&&a.trigger("persist:stop")},success:function(b,c,d){a.destroy();a.trigger("persist:erase:success")},error:function(){a.trigger("persist:error");
a.trigger("persist:erase:error")}});return this};this.gather=function(a,b,c,h){var k,m=this;if(!a)throw"agility.js plugin persist: gather() needs object prototype";if(!a._data.persist)throw"agility.js plugin persist: prototype doesn't seem to contain persist() data";h?k=c:"string"===typeof c?k=c:(k=l,h=c);0===this._data.persist.openRequests&&this.trigger("persist:start");this._data.persist.openRequests++;a._data.persist.adapter.call(a,{type:"GET",data:h,complete:function(){m._data.persist.openRequests--;
0===m._data.persist.openRequests&&m.trigger("persist:stop")},success:function(c){d.each(c,function(c,d){var g=$$(a,d);if("string"===typeof b)m[b](g,k)});m.trigger("persist:gather:success",{data:c})},error:function(){m.trigger("persist:error");m.trigger("persist:gather:error")}});return this};return this};k.adapter={};k.adapter.restful=function(a){a=d.extend({dataType:"json",url:(this._data.persist.baseUrl||"api/")+this._data.persist.collection+(a.id?"/"+a.id:"")},a);d.ajax(a)}})(window);
