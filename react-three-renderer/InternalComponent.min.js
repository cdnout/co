"use strict";var _class,_temp,_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),_invariant=require("fbjs/lib/invariant"),_invariant2=_interopRequireDefault(_invariant),_emptyFunction=require("fbjs/lib/emptyFunction"),_emptyFunction2=_interopRequireDefault(_emptyFunction),_flattenChildren=require("react/lib/flattenChildren"),_flattenChildren2=_interopRequireDefault(_flattenChildren),_ReactCurrentOwner=require("react/lib/ReactCurrentOwner"),_ReactCurrentOwner2=_interopRequireDefault(_ReactCurrentOwner),_ReactElement=require("react/lib/ReactElement"),_ReactElement2=_interopRequireDefault(_ReactElement),_ReactInstrumentation=require("react-dom/lib/ReactInstrumentation"),_ReactInstrumentation2=_interopRequireDefault(_ReactInstrumentation),_ReactReconciler=require("react-dom/lib/ReactReconciler"),_ReactReconciler2=_interopRequireDefault(_ReactReconciler),_ReactMultiChild=require("react-dom/lib/ReactMultiChild"),_ReactMultiChild2=_interopRequireDefault(_ReactMultiChild),_ReactRef=require("react-dom/lib/ReactRef"),_ReactRef2=_interopRequireDefault(_ReactRef),_React3ComponentFlags=require("./React3ComponentFlags"),_React3ComponentFlags2=_interopRequireDefault(_React3ComponentFlags),_idPropertyName=require("./utils/idPropertyName"),_idPropertyName2=_interopRequireDefault(_idPropertyName),_React3CompositeComponentWrapper=require("./React3CompositeComponentWrapper"),_React3CompositeComponentWrapper2=_interopRequireDefault(_React3CompositeComponentWrapper),_React3ComponentTree=require("./React3ComponentTree"),_React3ComponentTree2=_interopRequireDefault(_React3ComponentTree);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function processChildContext(e){return e}var RemountTrigger=function e(){var t=this;_classCallCheck(this,e),this.wantRemount=!1,this.onTrigger=function(){},this.trigger=function(){t.wantRemount=!0,t.onTrigger()}},registrationNameModules={};function deleteListener(e,t){console.log("deleteListener",e,t)}function enqueuePutListener(e,t,n,r){console.log("enqueuePutListener",e,t,n,r)}function _arrayMove(e,t,n){e.splice(n,0,e.splice(t,1)[0])}var ReactInstanceMap,setChildrenForInstrumentation=_emptyFunction2.default,setContentChildForInstrumentation=_emptyFunction2.default,getDebugID=void 0;"production"!==process.env.NODE_ENV&&(ReactInstanceMap=require("react-dom/lib/ReactInstanceMap"),getDebugID=function(e){if(!e._debugID){var t=ReactInstanceMap.get(e);if(t)return t._debugID}return e._debugID},setChildrenForInstrumentation=function(t){_ReactInstrumentation2.default.debugTool.onSetChildren(this._debugID,t?Object.keys(t).map(function(e){return t[e]._debugID}):[])},setContentChildForInstrumentation=function(e){var t=null!==this._contentDebugID&&void 0!==this._contentDebugID,n=this._debugID,r="CDID-"+n;if(null==e)return t&&_ReactInstrumentation2.default.debugTool.onUnmountComponent(this._contentDebugID),void(this._contentDebugID=null);this._contentDebugID=r,t?(_ReactInstrumentation2.default.debugTool.onBeforeUpdateComponent(r,e),_ReactInstrumentation2.default.debugTool.onUpdateComponent(r)):(_ReactInstrumentation2.default.debugTool.onBeforeMountComponent(r,e,n),_ReactInstrumentation2.default.debugTool.onMountComponent(r),_ReactInstrumentation2.default.debugTool.onSetChildren(n,[r]))});var getThreeObjectFromMountImage=function(e){return e.threeObject},ReactMultiChildMixin=_ReactMultiChild2.default.Mixin,InternalComponent=(_temp=_class=function(){function o(e,t){var n=this;_classCallCheck(this,o),this.updateChildren=ReactMultiChildMixin.updateChildren.bind(this),this._mountChildAtIndex=ReactMultiChildMixin._mountChildAtIndex.bind(this),this._unmountChild=ReactMultiChildMixin._unmountChild.bind(this),this.unmountChildren=ReactMultiChildMixin.unmountChildren.bind(this),this._currentElement=e,this._react3RendererInstance=t,this._elementType=e.type,this._renderedChildren=[],this._hostMarkup=null,this._hostParent=null,this._rootNodeID=0,this._hostID=0,this._hostContainerInfo=null,this._threeObject=null,this._topLevelWrapper=null,this._markup=null,this._nodeWithLegacyProperties=null,this._forceRemountOfComponent=!1,this._flags=0,"production"!==process.env.NODE_ENV&&(this._ancestorInfo=null,setContentChildForInstrumentation.call(this,null)),this.threeElementDescriptor=t.threeElementDescriptors[e.type],this.threeElementDescriptor||("production"!==process.env.NODE_ENV?(0,_invariant2.default)(!1,"No constructor for "+e.type):(0,_invariant2.default)(!1)),"production"===process.env.NODE_ENV&&"true"!==process.env.ENABLE_REACT_ADDON_HOOKS||(this.highlightComponent=function(){n.threeElementDescriptor.highlight(n._threeObject)},this.hideHighlight=function(){n.threeElementDescriptor.hideHighlight(n._threeObject)}),this.remountTrigger=new RemountTrigger,this.remountTrigger.onTrigger=function(){n._forceRemountOfComponent=!0}}return _createClass(o,[{key:"getHostMarkup",value:function(){return this._markup}},{key:"getHostNode",value:function(){return this._markup}},{key:"mountComponent",value:function(e,t,n,r){var i;this._rootNodeID=this._react3RendererInstance.globalIdCounter++,this._hostID=n._idCounter++,this._hostParent=t,this._hostContainerInfo=n;var o=this._currentElement;"production"!==process.env.NODE_ENV&&this.threeElementDescriptor.checkPropTypes(o,this._currentElement._owner,this._debugID,o.props),this._threeObject=this.threeElementDescriptor.construct(o.props),this.threeElementDescriptor.applyInitialProps(this._threeObject,o.props),this.threeElementDescriptor.placeRemountTrigger(this._threeObject,this.remountTrigger.trigger);var a=o.props.children,u=void 0,u=a?this.mountChildren(a,e,r):[],s=(_defineProperty(i={},_idPropertyName2.default,this._hostID),_defineProperty(i,"_rootInstance",null),_defineProperty(i,"elementType",o.type),_defineProperty(i,"threeObject",this._threeObject),_defineProperty(i,"parentMarkup",null),_defineProperty(i,"childrenMarkup",u),_defineProperty(i,"toJSON",function(){return"---MARKUP---"}),i);"production"!==process.env.NODE_ENV?(0,_invariant2.default)(!!this._threeObject.userData,"No userdata present in threeobject for %s",o.type):(0,_invariant2.default)(!!this._threeObject.userData),Object.assign(this._threeObject.userData,{object3D:this._threeObject,react3internalComponent:this,toJSON:function(){return"---USERDATA---"},markup:s});var l=this._react3RendererInstance.threeElementDescriptors;if(u&&0<u.length){this.threeElementDescriptor.addChildren(this._threeObject,u.map(getThreeObjectFromMountImage));for(var c=0;c<u.length;++c){var h=u[c],p=l[h.elementType];h.parentMarkup=s,p.setParent(h.threeObject,this._threeObject)}}return this._markup=s,_React3ComponentTree2.default.precacheMarkup(this,this._markup),this._flags|=_React3ComponentFlags2.default.hasCachedChildMarkups,s}},{key:"_reconcilerInstantiateChildren",value:function(e,t,n){if("production"!==process.env.NODE_ENV){var r=getDebugID(this);if(this._currentElement){var i=_ReactCurrentOwner2.default.current;try{return _ReactCurrentOwner2.default.current=this._currentElement._owner,this._react3RendererInstance.instantiateChildren(e,t,n,r)}finally{_ReactCurrentOwner2.default.current=i}}}return this._react3RendererInstance.instantiateChildren(e,t,n,0)}},{key:"_reconcilerUpdateChildren",value:function(e,t,n,r,i,o){var a=void 0,u=0;if("production"!==process.env.NODE_ENV&&(u=getDebugID(this),this._currentElement)){var s=_ReactCurrentOwner2.default.current;try{_ReactCurrentOwner2.default.current=this._currentElement._owner,a=(0,_flattenChildren2.default)(t,u)}finally{_ReactCurrentOwner2.default.current=s}return this._react3RendererInstance.updateChildren(e,a,n,r,i,this,this._hostContainerInfo,o,u),a}return a=(0,_flattenChildren2.default)(t,u),this._react3RendererInstance.updateChildren(e,a,n,r,i,this,this._hostContainerInfo,o,u),a}},{key:"mountChildren",value:function(e,t,n){var r=this._reconcilerInstantiateChildren(e,t,n),i=[],o=0;if(this._renderedChildren=r)for(var a=Object.keys(r),u=0;u<a.length;++u){var s=r[a[u]],l=0;"production"!==process.env.NODE_ENV&&(l=getDebugID(this));var c=_ReactReconciler2.default.mountComponent(s,t,this,this._hostContainerInfo,n,l);s._mountIndex=o,i.push(c),o++}return"production"!==process.env.NODE_ENV&&setChildrenForInstrumentation.call(this,r),i}},{key:"moveChild",value:function(e,t,n){e._mountIndex!==t&&(this.threeElementDescriptor.moveChild(this._threeObject,e._threeObject,t,e._mountIndex),_arrayMove(this._markup.childrenMarkup,n,t))}},{key:"receiveComponent",value:function(e,t,n){var r=this._currentElement;this._currentElement=e,this.updateComponent(t,r,e,n),this._forceRemountOfComponent&&(this._currentElement=null)}},{key:"updateComponent",value:function(e,t,n,r){var i=t.props,o=this._currentElement.props;t.type!==n.type&&("production"!==process.env.NODE_ENV?(0,_invariant2.default)(!1,"The component type changed unexpectedly"):(0,_invariant2.default)(!1)),this._updateObjectProperties(i,o,e,r),this._forceRemountOfComponent||this._updateChildrenObjects(o,e,processChildContext(r,this))}},{key:"_updateChildrenObjects",value:function(e,t,n){var r=e.children||null;"production"!==process.env.NODE_ENV&&setContentChildForInstrumentation.call(this,null),this.updateChildren(r,t,n)}},{key:"_updateObjectProperties",value:function(e,t,n){var r=this.remountTrigger;r.wantRemount=!1,this.threeElementDescriptor.beginPropertyUpdates(this._threeObject,t),"production"!==process.env.NODE_ENV&&this.threeElementDescriptor.checkPropTypes(this._currentElement,this._currentElement._owner,this._debugID,t);for(var i=Object.keys(e),o=0;o<i.length;++o){var a=i[o];if(!t.hasOwnProperty(a)&&"children"!==a){if(r.wantRemount)break;registrationNameModules.hasOwnProperty(a)?e[a]&&deleteListener(this._rootNodeID,a):this.threeElementDescriptor.deleteProperty(this._threeObject,a)}}for(var u=Object.keys(t),s=0;s<u.length;++s){var l=u[s];if("children"!==l){if(r.wantRemount)break;var c=t[l],h=e[l];c!==h&&(registrationNameModules.hasOwnProperty(l)?c?enqueuePutListener(this._rootNodeID,l,c,n):h&&deleteListener(this._rootNodeID,l):this.threeElementDescriptor.updateProperty(this._threeObject,l,c))}}this.threeElementDescriptor.completePropertyUpdates(this._threeObject)}},{key:"_removeAllChildRefs",value:function(){var e=this._renderedChildren;if(e)for(var t=Object.keys(e),n=0;n<t.length;++n){var r=e[t[n]];r&&r._currentElement&&r._currentElement.ref&&(_ReactRef2.default.detachRefs(r,r._currentElement),r._currentElement=_ReactElement2.default.cloneElement(r._currentElement,{ref:null})),r._removeAllChildRefs()}}},{key:"unmountComponent",value:function(e){null!==this._threeObject&&this.threeElementDescriptor.componentWillUnmount(this._threeObject),this._forceRemountOfComponent&&this._removeAllChildRefs(),this.unmountChildren(e),_React3ComponentTree2.default.uncacheMarkup(this),null!==this._threeObject&&this.threeElementDescriptor.unmount(this._threeObject),this._markup=null,this._rootNodeID=0,this._nodeWithLegacyProperties&&(this._nodeWithLegacyProperties._reactInternalComponent=null,this._nodeWithLegacyProperties=null),"production"!==process.env.NODE_ENV&&setContentChildForInstrumentation.call(this,null)}},{key:"emptyJson",value:function(){return"..."}},{key:"getPublicInstance",value:function(){return this._markup.threeObject}},{key:"_updateChildren",value:function(e,t,n){var r=this._renderedChildren,i={},o=[],a=this._reconcilerUpdateChildren(r,e,o,i,t,n);if(a||r){var u=this.remountTrigger;u.wantRemount=!1,this.threeElementDescriptor.beginChildUpdates(this._threeObject);var s=0,l=0,c=0;if(a)for(var h=Object.keys(a),p=0;p<h.length;++p){var _,d,m,f=h[p];u.wantRemount||((_=r&&r[f])===(d=a[f])?(this.moveChild(_,s,l),l=Math.max(_._mountIndex,l),_._mountIndex=s):(_&&(l=Math.max(_._mountIndex,l),m=i[f],(0,_invariant2.default)(!!m,"Removed markup map should contain this child"),delete i[f],this._unmountChild(_,m)),u.wantRemount||(this._mountChildAtIndex(d,o[c],null,s,t,n),c++)),s++)}for(var C=Object.keys(i),v=0;v<C.length;++v){var R=C[v];this._unmountChild(r[R],i[R])}this._renderedChildren=a,"production"!==process.env.NODE_ENV&&setChildrenForInstrumentation.call(this,a),this.threeElementDescriptor.completeChildUpdates(this._threeObject)}}},{key:"createChild",value:function(e,t,n){var r=e._mountIndex;this._markup.childrenMarkup.splice(r,0,n),n.parentMarkup=this._markup,this.threeElementDescriptor.addChild(this._threeObject,n.threeObject,r),this._react3RendererInstance.threeElementDescriptors[n.elementType].setParent(n.threeObject,this._threeObject)}},{key:"removeChild",value:function(e,t){"production"!==process.env.NODE_ENV&&(0,_invariant2.default)(!!t&&!!t.threeObject,"The child markup to replace has no threeObject"),this.threeElementDescriptor.removeChild(this._threeObject,t.threeObject),e instanceof o?e.threeElementDescriptor.removedFromParent(t.threeObject):e instanceof _React3CompositeComponentWrapper2.default?t.threeObject.userData.react3internalComponent.threeElementDescriptor.removedFromParent(t.threeObject):"production"!==process.env.NODE_ENV?(0,_invariant2.default)(!1,"Cannot remove child because it is not a known component type"):(0,_invariant2.default)(!1);for(var n=this._markup.childrenMarkup,r=0;r<n.length;r++){var i=n[r];if(i.threeObject===t.threeObject)return n.splice(r,1),void delete i.parentMarkup}"production"!==process.env.NODE_ENV?(0,_invariant2.default)(!1,"Trying to remove a child that is not mounted"):(0,_invariant2.default)(!1)}}]),o}(),_class.displayName="React3Component",_temp);module.exports=InternalComponent;