"use strict";var _createClass=function(){function a(e,r){for(var t=0;t<r.length;t++){var a=r[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,r,t){return r&&a(e.prototype,r),t&&a(e,t),e}}(),_get=function e(r,t,a){null===r&&(r=Function.prototype);var u=Object.getOwnPropertyDescriptor(r,t);if(void 0===u){var o=Object.getPrototypeOf(r);return null===o?void 0:e(o,t,a)}if("value"in u)return u.value;var n=u.get;return void 0!==n?n.call(a):void 0},_invariant=require("fbjs/lib/invariant"),_invariant2=_interopRequireDefault(_invariant),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_THREEElementDescriptor=require("../THREEElementDescriptor"),_THREEElementDescriptor2=_interopRequireDefault(_THREEElementDescriptor),_ResourceReference=require("../../Resources/ResourceReference"),_ResourceReference2=_interopRequireDefault(_ResourceReference),_React3Renderer=require("../../React3Renderer"),_React3Renderer2=_interopRequireDefault(_React3Renderer);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}var ResourceDescriptorBase=function(){function s(e){_classCallCheck(this,s);var n=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e));return n._addedIntoRoot=function(e){for(var r=e.userData.markup.parentMarkup,t=0;r;){var a,u,o=r.threeObject.userData._resources;o&&(a=e.resourceId,(u=o.resourceMap[a])&&n._addResource(e,{id:a,distance:t,resource:u})),t++,r=r.threeObject.userData.markup.parentMarkup}n._updateResource(e)},n.hasProp("resourceId",{type:_propTypes2.default.string.isRequired,update:n.triggerRemount,default:""}),n}return _inherits(s,_THREEElementDescriptor2.default),_createClass(s,[{key:"construct",value:function(e){return(0,_invariant2.default)(e.hasOwnProperty("resourceId"),'A resource type must have a property named "resourceId"!'),new _ResourceReference2.default(e.resourceId)}},{key:"applyInitialProps",value:function(e,r){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"applyInitialProps",this).call(this,e,r),e.userData.resourceMap=[],e.userData._eventCleanupQueue=[],e.userData._chosenResource=void 0,e.userData._debug=r.debug||!1,e.userData.events.once("addedIntoRoot",this._addedIntoRoot)}},{key:"unmount",value:function(e){e.userData._eventCleanupQueue.forEach(function(e){e()}),delete e.userData._eventCleanupQueue,delete e.userData.resourceMap,this.updateChosenResource(e,null),_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"unmount",this).call(this,e)}},{key:"updateChosenResource",value:function(e,r){var t=e.userData._chosenResource;t!==r&&(e.userData._chosenResource=r,this.resourceUpdated(e,r,t))}},{key:"setParent",value:function(e,r){var t=r[e.userData._propertySlot];(0,_invariant2.default)(null==t,"Parent already has a "+e.userData._propertySlot+" defined"),(0,_invariant2.default)(0===e.userData._eventCleanupQueue.length,"Changing parents?"),_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"setParent",this).call(this,e,r);var a=r.userData.markup,u=this._onResourceAdded.bind(this,e),o=this._onResourceRemoved.bind(this,e),n=a.threeObject.userData.events;n.on("resource.added",u),n.on("resource.removed",o),e.userData._eventCleanupQueue.push(function(){n.removeListener("resource.added",u),n.removeListener("resource.removed",o)})}},{key:"_onResourceAdded",value:function(e,r){e.resourceId===r.id&&(this._addResource(e,r),this._updateResource(e))}},{key:"_addResource",value:function(e,r){for(var t=e.userData.resourceMap,a=void 0,a=0;a<t.length;++a){if(t[a].distance===r.distance)return void(t[a].resource!==r.resource&&(t[a].resource=r.resource));if(t[a].distance>r.distance)break}t.splice(a,0,{distance:r.distance,resource:r.resource})}},{key:"_onResourceRemoved",value:function(e,r){if(e.resourceId===r.id){for(var t=e.userData.resourceMap,a=0;a<t.length;++a)if(t[a].distance===r.distance)return void(t[a].resource===r.resource&&(t.splice(a,1),this._updateResource(e)));(0,_invariant2.default)(!1,"This resource was not in this map?")}}},{key:"applyToSlot",value:function(e,r,t){r[e.userData._propertySlot]=t}},{key:"resourceUpdated",value:function(e,r,t){var a,u=e.userData.markup.parentMarkup&&e.userData.markup.parentMarkup.threeObject||void 0;u&&(this.applyToSlot(e,u,r),null===r||r.userData._references.push(u),t&&(a=t.userData._references.indexOf(u),(0,_invariant2.default)(-1!==a,"Bad reference count for resource"),t.userData._references.splice(a,1)))}},{key:"_updateResource",value:function(e){var r=e.userData.resourceMap,t=null;0<r.length&&(t=r[0].resource),this.updateChosenResource(e,t)}},{key:"highlight",value:function(e){var r=e.userData.markup.parentMarkup.threeObject;r.userData._descriptor.highlight(r)}},{key:"hideHighlight",value:function(e){var r=e.userData.markup.parentMarkup.threeObject;r.userData._descriptor.hideHighlight(r)}}]),s}();module.exports=ResourceDescriptorBase;