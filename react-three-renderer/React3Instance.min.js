"use strict";var _class,_temp,_initialiseProps,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},_createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}(),_three=require("three"),THREE=_interopRequireWildcard(_three),_invariant=require("fbjs/lib/invariant"),_invariant2=_interopRequireDefault(_invariant),_warning=require("fbjs/lib/warning"),_warning2=_interopRequireDefault(_warning),_ReactUpdates=require("react-dom/lib/ReactUpdates"),_ReactUpdates2=_interopRequireDefault(_ReactUpdates),_raf=require("raf"),_raf2=_interopRequireDefault(_raf),_Viewport=require("./Viewport"),_Viewport2=_interopRequireDefault(_Viewport),_Module=require("./Module"),_Module2=_interopRequireDefault(_Module),_React3Renderer=require("./React3Renderer"),_React3Renderer2=_interopRequireDefault(_React3Renderer),_ResourceContainer=require("./Resources/ResourceContainer"),_ResourceContainer2=_interopRequireDefault(_ResourceContainer),_CameraUtils=require("./utils/CameraUtils"),_CameraUtils2=_interopRequireDefault(_CameraUtils),_isWebglSupported=require("./utils/isWebglSupported"),_isWebglSupported2=_interopRequireDefault(_isWebglSupported);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var rendererProperties=["gammaInput","gammaOutput"],React3DInstance=(_temp=_class=function(){function h(e,t){var a=this;_classCallCheck(this,h),_initialiseProps.call(this);var r=e.mainCamera,i=e.onAnimate,n=e.onRecreateCanvas,s=e.onRendererUpdated,o=e.onManualRenderTriggerCreated,l=e.forceManualRender;this._parameters=_extends({},e),this._rendererInstance=t,this._mounted=!1,this._willUnmount=!1,this._scene=null,this._mainCameraName=r,this._viewports=[],this._modules=[],this._resourceContainers=[],this._recreateCanvasCallback=n,this._rendererUpdatedCallback=s,this._manualRenderTriggerCallback=o,this._forceManualRender=l,this._warnedAboutManualRendering=!1,this._canvas=null,this._onAnimate=i,this._objectsByUUID={},this._materials=[],this._geometries=[],this._textures=[],this._objectsByName={},this._lastRenderMode=null,this._renderTrigger=function(e){e?a._render():null===a._renderRequest&&(a._renderRequest=(0,_raf2.default)(a._render))},this.uuid=THREE.Math.generateUUID(),this.userData={},"production"===process.env.NODE_ENV&&"true"!==process.env.ENABLE_REACT_ADDON_HOOKS||(this._highlightScene=new THREE.Scene,this._highlightGeometry=new THREE.BoxGeometry(1,1,1),this._highlightMaterial=new THREE.MeshBasicMaterial({color:255,transparent:!0,opacity:.4}),this._highlightObjectId=null,this._getHighlightBoundingBox=null,this._hideHighlight=function(){a._highlightObjectId=null,a._getHighlightBoundingBox=null},this._objectHighlighted=function(e){var t=e.uuid,r=e.boundingBoxFunc;a._highlightObjectId&&a._objectsByUUID[a._highlightObjectId].userData.events.removeListener("hideHighlight",a._hideHighlight),a._highlightObjectId=t,a._getHighlightBoundingBox=r,a._objectsByUUID[t].userData.events.once("hideHighlight",a._hideHighlight)})}return _createClass(h,[{key:"_createRenderer",value:function(){var t,e,r,a,i,n;this._canvas&&(t=this._parameters,e={canvas:this._canvas,precision:t.precision,alpha:t.alpha,premultipliedAlpha:t.premultipliedAlpha,antialias:t.antialias,stencil:t.stencil,preserveDrawingBuffer:t.preserveDrawingBuffer,depth:t.depth,logarithmicDepthBuffer:t.logarithmicDepthBuffer},this._parameters.customRenderer?this._renderer=this._parameters.customRenderer(e):this._renderer=(0,_isWebglSupported2.default)()?new THREE.WebGLRenderer(e):new THREE.CanvasRenderer(e),this._rendererUpdatedCallback&&this._rendererUpdatedCallback(this._renderer),r=this._renderer,t.hasOwnProperty("pixelRatio")&&r.setPixelRatio(t.pixelRatio),t.hasOwnProperty("sortObjects")&&(r.sortObjects=t.sortObjects),a=t.hasOwnProperty("clearColor"),i=t.hasOwnProperty("clearAlpha"),(a||i)&&(n=void 0,n=a?t.clearColor:new THREE.Color(0),i?("production"!==process.env.NODE_ENV&&(0,_warning2.default)(!0===t.alpha,"The `clearAlpha` property requires the `alpha` property to be `true`."),r.setClearColor(n,t.clearAlpha)):r.setClearColor(n)),t.hasOwnProperty("shadowMapEnabled")&&(r.shadowMap.enabled=t.shadowMapEnabled),t.hasOwnProperty("shadowMapType")&&(r.shadowMap.type=t.shadowMapType),t.hasOwnProperty("shadowMapCullFace")&&(r.shadowMap.cullFace=t.shadowMapCullFace),t.hasOwnProperty("shadowMapDebug")&&(r.shadowMap.debug=t.shadowMapDebug),rendererProperties.forEach(function(e){t.hasOwnProperty(e)&&(r[e]=t[e])}),r.setSize(t.width,t.height))}},{key:"initialize",value:function(){this.userData.events.on("animate",this._callOnAnimate),this._forceManualRender?("production"!==process.env.NODE_ENV&&(this._manualRenderTriggerCallback||this._warnedAboutManualRendering||(this._warnedAboutManualRendering=!0,(0,_warning2.default)(!1,"The `forceManualRender` property requires the `onManualRenderTriggerCreated` property to be set."))),this._renderRequest=null):this._renderRequest=(0,_raf2.default)(this._render),this._manualRenderTriggerCallback&&this._manualRenderTriggerCallback(this._renderTrigger)}},{key:"getObjectsByName",value:function(e){var t,r=this._objectsByName[e];return r?(t=r.values,Object.keys(t).map(function(e){return t[e]})):[]}},{key:"addAnimateListener",value:function(e){this.userData.events.on("animate",e)}},{key:"removeAnimateListener",value:function(e){this.userData.events.removeListener("animate",e)}},{key:"addBeforeRenderListener",value:function(e){this.userData.events.on("preRender",e)}},{key:"removeBeforeRenderListener",value:function(e){this.userData.events.removeListener("preRender",e)}},{key:"addChildren",value:function(e){for(var t=0;t<e.length;++t){var r=e[t];r instanceof THREE.Scene?this.setScene(r):r instanceof _Viewport2.default?this.addViewport(r):r instanceof _Module2.default?this.addModule(r):r instanceof _ResourceContainer2.default?this.addResourceContainer(r):(0,_invariant2.default)(!1,"The react3 component should only contain <viewport/>s or <scene/>s or <resources/>.")}}},{key:"removeChild",value:function(e){e instanceof THREE.Scene?this._scene===e&&this.setScene(null):e instanceof _Viewport2.default?this.removeViewport(e):e instanceof _Module2.default?this.removeModule(e):e instanceof _ResourceContainer2.default?this.removeResourceContainer(e):(0,_invariant2.default)(!1,"The react3 component should only contain <viewport/>s or <scene/>s, <module/>s or <resources/>.")}},{key:"_renderScene",value:function(e){if(this._renderer.render(this._scene,e),("production"!==process.env.NODE_ENV||"true"===process.env.ENABLE_REACT_ADDON_HOOKS)&&null!==this._highlightObjectId){var t=this._getHighlightBoundingBox(),r=this._highlightScene,a=r.children.length-t.length;if(0<a)for(var i=0;i<a;i++)r.remove(r.children[0]);else if(a<0)for(var n=0;n<-a;n++)r.add(new THREE.Mesh(this._highlightGeometry,this._highlightMaterial));for(var s=0;s<t.length;++s){var o=t[s],l=o.min.clone().add(o.max).multiplyScalar(.5),h=o.max.clone().sub(o.min),u=r.children[s];u.position.copy(l),u.scale.copy(h)}var d=this._renderer.autoClear;this._renderer.autoClear=!1,this._renderer.render(r,e),this._renderer.autoClear=d}}},{key:"setScene",value:function(e){"production"!==process.env.NODE_ENV&&(0,_invariant2.default)(!(this._scene&&e),"There can only be one scene in <react3/>"),this._scene=e}},{key:"addViewport",value:function(e){this._viewports.push(e)}},{key:"removeViewport",value:function(e){var t=this._viewports.indexOf(e);"production"!==process.env.NODE_ENV&&(0,_invariant2.default)(-1!==t,"A viewport has been removed from <react3/> but it was not present in it..."),this._viewports.splice(t,1)}},{key:"addResourceContainer",value:function(e){this._resourceContainers.push(e)}},{key:"removeResourceContainer",value:function(e){var t=this._resourceContainers.indexOf(e);"production"!==process.env.NODE_ENV&&(0,_invariant2.default)(-1!==t,"A resource container has been removed from <react3/> but it was not present in it..."),this._resourceContainers.splice(t,1)}},{key:"addModule",value:function(e){this._modules.push(e)}},{key:"removeModule",value:function(e){var t=this._modules.indexOf(e);"production"!==process.env.NODE_ENV&&(0,_invariant2.default)(-1!==t,"A module has been removed from <react3/> but it was not present in it..."),this._modules.splice(t,1)}},{key:"updateWidth",value:function(e){this._parameters.width=e,this._renderer&&this._renderer.setSize(this._parameters.width,this._parameters.height)}},{key:"updateOnRecreateCanvas",value:function(e,t){this._recreateCanvasCallback=t}},{key:"updateOnRendererUpdated",value:function(e){this._rendererUpdatedCallback=e}},{key:"updateOnManualRenderTriggerCreated",value:function(e){(this._manualRenderTriggerCallback=e)&&this._manualRenderTriggerCallback(this._renderTrigger)}},{key:"updateForceManualRender",value:function(e){this._forceManualRender!==e&&((this._forceManualRender=e)?(_raf2.default.cancel(this._renderRequest),this._renderRequest=null):this._renderRequest=(0,_raf2.default)(this._render))}},{key:"updateHeight",value:function(e){this._parameters.height=e,this._renderer&&this._renderer.setSize(this._parameters.width,this._parameters.height)}},{key:"updatePixelRatio",value:function(e){this._parameters.pixelRatio=e,this._renderer&&(this._renderer.setPixelRatio(e),this._renderer.setSize(this._parameters.width,this._parameters.height))}},{key:"updateSortObjects",value:function(e){this._parameters.sortObjects=e,this._renderer&&(this._renderer.sortObjects=e)}},{key:"updateAntialias",value:function(e){this._parameters.antialias=e,this._renderer&&this.refreshRenderer()}},{key:"updatePrecision",value:function(e){this._parameters.precision=e,this._renderer&&this.refreshRenderer()}},{key:"updateAlpha",value:function(e){this._parameters.alpha=e,this._renderer&&this.refreshRenderer()}},{key:"updatePremultipliedAlpha",value:function(e){this._parameters.premultipliedAlpha=e,this._renderer&&this.refreshRenderer()}},{key:"updateStencil",value:function(e){this._parameters.stencil=e,this._renderer&&this.refreshRenderer()}},{key:"updatePreserveDrawingBuffer",value:function(e){this._parameters.preserveDrawingBuffer=e,this._renderer&&this.refreshRenderer()}},{key:"updateDepth",value:function(e){this._parameters.depth=e,this._renderer&&this.refreshRenderer()}},{key:"updateLogarithmicDepthBuffer",value:function(e){this._parameters.logarithmicDepthBuffer=e,this._renderer&&this.refreshRenderer()}},{key:"updateShadowMapEnabled",value:function(e){this._parameters.shadowMapEnabled=e,this._renderer&&(this._renderer.shadowMap.enabled=e,this.allMaterialsNeedUpdate(!0))}},{key:"updateShadowMapType",value:function(e){this._parameters.shadowMapType=e,this._renderer&&(this._renderer.shadowMap.type=e,this.allMaterialsNeedUpdate(!0))}},{key:"updateShadowMapCullFace",value:function(e){this._parameters.shadowMapCullFace=e,this._renderer&&(this._renderer.shadowMap.cullFace=e,this.allMaterialsNeedUpdate(!0))}},{key:"updateShadowMapDebug",value:function(e){this._parameters.shadowMapDebug=e,this._renderer&&(this._renderer.shadowMap.debug=e,this.allMaterialsNeedUpdate(!0))}},{key:"updateCanvas",value:function(e){var t;this._canvas=e,this._renderer&&(this.disposeResourcesAndRenderer(),(t=this._renderer.extensions.get("WEBGL_lose_context"))&&t.loseContext()),this._createRenderer()}},{key:"updateGammaInput",value:function(e){this._parameters.gammaInput=e,this._renderer&&(this._renderer.gammaInput=e,this.allMaterialsNeedUpdate(!0))}},{key:"updateGammaOutput",value:function(e){this._parameters.gammaOutput=e,this._renderer&&(this._renderer.gammaOutput=e,this.allMaterialsNeedUpdate(!0))}},{key:"updateContext",value:function(e){this._parameters.context=e}},{key:"updateMainCamera",value:function(e){this._parameters.mainCamera=e,this._mainCameraName=e}},{key:"updateCustomRenderer",value:function(e){this._parameters.customRenderer=e,this._renderer&&this.refreshRenderer()}},{key:"updateOnAnimate",value:function(e){this._parameters.onAnimate=e,this._onAnimate=e}},{key:"updateClearColor",value:function(e){this._parameters.clearColor=e,this._renderer&&(this._parameters.hasOwnProperty("clearAlpha")?this._renderer.setClearColor(e,this._parameters.clearAlpha):this._renderer.setClearColor(e))}},{key:"updateClearAlpha",value:function(e){var t,r=this._parameters;void 0===e?delete r.clearAlpha:r.clearAlpha=e,this._renderer&&(t=void 0,t=r.hasOwnProperty("clearColor")?r.clearColor:new THREE.Color(0),void 0!==e?this._renderer.setClearColor(t,e):this._renderer.setClearColor(t))}},{key:"refreshRenderer",value:function(){this.disposeResourcesAndRenderer();var e=this._renderer.extensions.get("WEBGL_lose_context");delete this._renderer,this._rendererUpdatedCallback&&this._rendererUpdatedCallback(null),this.userData.events.removeListener("animate",this._callOnAnimate),this.userData.events.removeAllListeners(),null!==this._renderRequest&&(_raf2.default.cancel(this._renderRequest),this._renderRequest=null),e&&this._canvas&&e.loseContext(),this._recreateCanvasCallback()}},{key:"disposeResourcesAndRenderer",value:function(){for(var e=0;e<this._materials.length;++e){this._materials[e].dispose()}for(var t=0;t<this._geometries.length;++t){this._geometries[t].dispose()}for(var r=0;r<this._textures.length;++r){this._textures[r].dispose()}this._renderer.dispose()}},{key:"willUnmount",value:function(){this._willUnmount=!0}},{key:"unmount",value:function(){var e;this._mounted=!1,null!==this._renderRequest&&(_raf2.default.cancel(this._renderRequest),this._renderRequest=null),this.userData.events.removeListener("animate",this._callOnAnimate),this.userData.events.removeAllListeners(),delete this._rendererInstance,this._renderer&&((e=this._renderer.extensions.get("WEBGL_lose_context"))&&e.loseContext(),this.disposeResourcesAndRenderer(),delete this._renderer,this._rendererUpdatedCallback&&this._rendererUpdatedCallback(null)),delete this._parameters,(0,_invariant2.default)(0===Object.keys(this._objectsByUUID).length,"Failed to cleanup some child objects for React3DInstance"),delete this._objectsByUUID,delete this._viewports,delete this._scene,"production"===process.env.NODE_ENV&&"true"!==process.env.ENABLE_REACT_ADDON_HOOKS||(delete this._highlightScene,delete this._highlightObjectId,delete this._getHighlightBoundingBox)}},{key:"objectMounted",value:function(e){(0,_invariant2.default)(!this._objectsByUUID[e.uuid],"There already is an object with this uuid in the react 3d instance."),((this._objectsByUUID[e.uuid]=e).userData.markup._rootInstance=this)._addObjectWithName(e.name,e),"production"===process.env.NODE_ENV&&"true"!==process.env.ENABLE_REACT_ADDON_HOOKS||e.userData.events.on("highlight",this._objectHighlighted),e.userData.events.emit("addedIntoRoot",e);var t=e.userData.markup.childrenMarkup;e instanceof THREE.Material&&this._materials.push(e),(e instanceof THREE.Geometry||e instanceof THREE.BufferGeometry)&&this._geometries.push(e),e instanceof THREE.Texture&&this._textures.push(e);for(var r=0;r<t.length;++r){var a=t[r];this.objectMounted(a.threeObject)}}},{key:"allMaterialsNeedUpdate",value:function(t){this._materials.forEach(function(e){t?e.dispose():e.needsUpdate=!0})}},{key:"objectRenamed",value:function(e,t,r){this._removeObjectWithName(t,e),this._addObjectWithName(r,e)}},{key:"_addObjectWithName",value:function(e,t){this._objectsByName[e]||(this._objectsByName[e]={count:0,values:{}}),this._objectsByName[e].values[t.uuid]=t,this._objectsByName[e].count++}},{key:"_removeObjectWithName",value:function(e,t){(0,_invariant2.default)(this._objectsByName[e]&&this._objectsByName[e].values[t.uuid]===t,"The object's name changed somehow?'"),delete this._objectsByName[e].values[t.uuid],this._objectsByName[e].count--,0===this._objectsByName[e].count&&delete this._objectsByName[e]}},{key:"objectRemoved",value:function(e){(0,_invariant2.default)(this._objectsByUUID[e.uuid]===e,"The removed object does not belong here!?"),"production"===process.env.NODE_ENV&&"true"!==process.env.ENABLE_REACT_ADDON_HOOKS||(this._highlightObjectId===e.uuid&&(this._highlightObjectId=null),e.userData.events.removeListener("highlight",this._objectHighlighted),e.userData.events.removeListener("hideHighlight",this._hideHighlight)),delete this._objectsByUUID[e.uuid],e instanceof THREE.Material&&this._materials.splice(this._materials.indexOf(e),1),(e instanceof THREE.Geometry||e instanceof THREE.BufferGeometry)&&this._geometries.splice(this._geometries.indexOf(e),1),e instanceof THREE.Texture&&this._textures.splice(this._textures.indexOf(e),1),this._removeObjectWithName(e.name,e),delete e.userData.markup._rootInstance}},{key:"mountedIntoRoot",value:function(){this._mounted=!0,this.objectMounted(this)}}]),h}(),_initialiseProps=function(){var i=this;this._callOnAnimate=function(){i._onAnimate&&_ReactUpdates2.default.batchedUpdates(i._onAnimate)},this._render=function(){for(var e,t,r,a=0;a<i._modules.length;++a)i._modules[a].update();i._forceManualRender?i._renderRequest=null:i._renderRequest=(0,_raf2.default)(i._render),i.userData.events.emit("animate"),i._scene&&i._mounted&&i._renderer&&(r=null,!i._mainCameraName||(e=i._objectsByName[i._mainCameraName])&&("production"!==process.env.NODE_ENV&&(0,_warning2.default)(e.count<2,"There are multiple objects with name "+i._mainCameraName),0<e.count&&(r=(t=e.values)[Object.keys(t)[0]])),r?("camera"!==i._lastRenderMode&&(i._renderer.autoClear=!0,i._renderer.setViewport(0,0,i._parameters.width,i._parameters.height),i._lastRenderMode="camera"),_CameraUtils2.default.current=r,i.userData.events.emit("preRender"),i._renderScene(r),_CameraUtils2.default.current=null):0<i._viewports.length&&("viewport"!==i._lastRenderMode&&(i._renderer.autoClear=!1,i._lastRenderMode="viewport"),i._renderer.clear(),i._viewports.forEach(function(e){var t,r,a=null;!e.cameraName||(t=i._objectsByName[e.cameraName])&&("production"!==process.env.NODE_ENV&&(0,_warning2.default)(t.count<2,"There are multiple objects with name "+e.cameraName),0<t.count&&(a=(r=t.values)[Object.keys(r)[0]])),a&&(e.onBeforeRender&&_ReactUpdates2.default.batchedUpdates(e.onBeforeRender),i._renderer.setViewport(e.x,e.y,e.width,e.height),_CameraUtils2.default.current=a,i.userData.events.emit("preRender"),i._renderScene(a),_CameraUtils2.default.current=null)})))}},_temp);module.exports=React3DInstance;