"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var vue=require("vue");const resolveOption=(o,r)=>(e,t)=>{let n=-1;if(t.reduce((e,t,r)=>{t=o(e,t);return t!==e?(n=r,t):e},r),-1<n)return e[n]},setup=t=>{let r=0;if(t.vm){let e=t["vm"];for(;e.parent&&(r++,e=e.parent),e&&e.parent&&e!==e.root;);}t.depth=r},resolve=resolveOption((e,t)=>{var t=t["depth"];return!e||e<t?t:e});var defaultResolver=Object.freeze({__proto__:null,setup:setup,resolve:resolve});const defaultConfig={body:{tag:"script",to:"body"},base:{valueAttribute:"href"},charset:{tag:"meta",nameless:!0,valueAttribute:"charset"},description:{tag:"meta"},og:{group:!0,namespacedAttribute:!0,tag:"meta",keyAttribute:"property"},twitter:{group:!0,namespacedAttribute:!0,tag:"meta"},htmlAttrs:{attributesFor:"html"},headAttrs:{attributesFor:"head"},bodyAttrs:{attributesFor:"body"}},tags={title:{attributes:!1},base:{contentAsAttribute:!0,attributes:["href","target"]},meta:{contentAsAttribute:!0,keyAttribute:"name",attributes:["content","name","http-equiv","charset"]},link:{contentAsAttribute:!0,attributes:["href","crossorigin","rel","media","integrity","hreflang","type","referrerpolicy","sizes","imagesrcset","imagesizes","as","color"]},style:{attributes:["media"]},script:{attributes:["src","type","nomodule","async","defer","crossorigin","integrity","referrerpolicy"]},noscript:{attributes:!1}};function getTagConfigItem(e,t){for(const n of e){var r=tags[n];if(n&&r)return r[t]}}const isArray=Array.isArray,isFunction=e=>"function"==typeof e,isString=e=>"string"==typeof e,isObject=e=>null!==e&&"object"==typeof e,objectToString=Object.prototype.toString,toTypeString=e=>objectToString.call(e),isPlainObject=e=>"[object Object]"===toTypeString(e),IS_PROXY=Symbol("kIsProxy"),PROXY_SOURCES=Symbol("kProxySources"),PROXY_TARGET=Symbol("kProxyTarget"),RESOLVE_CONTEXT=Symbol("kResolveContext");function clone(e){if(isArray(e))return e.map(clone);if(isObject(e)){const t={};for(const r in e)"context"===r?t[r]=e[r]:t[r]=clone(e[r]);return t}return e}const pluck=(e,t,r)=>{const n=[];for(const o of e)o&&t in o&&(n.push(o[t]),r&&r(o));return n},allKeys=(e,...t)=>{const r=e?Object.keys(e):[];if(t)for(const e of t)if(e&&isObject(e))for(const n in e)r.includes(n)||r.push(n);return r},recompute=(r,n=[],o,s)=>{var e=!o&&!s;if(e&&({active:o,sources:s}=r,n.length))for(let e=0;e<n.length;e++){const t=n[e];if(!o||!o[t])return;o=o[t],s=s.map(e=>e[t]).filter(Boolean)}if(o&&s){const c=allKeys(...s);for(const u of Object.keys(o))c.includes(u)||delete o[u];for(const l of c){let t=!1;for(let e=0;e<s.length;e++){var a=s[e];if(a&&l in a&&void 0!==a[l]){t=isPlainObject(a[l]);break}}if(t){o[l]||(o[l]={});const f=[];for(const d of s)l in d&&f.push(d[l]);recompute(r,[...n,l],o[l],f)}else{!o[l]&&isArray(s[0][l])&&(o[l]=[]);const p=[];var i=pluck(s,l,e=>p.push(e[RESOLVE_CONTEXT]));let e=r.resolve(i,p,o[l],l,n);isPlainObject(e)&&(e=clone(e)),o[l]=e}}}},createProxy=(e,t,r,n=[])=>{r=createHandler(e,r,n),r=vue.markRaw(new Proxy(t,r));return!n.length&&e.sources&&e.sources.push(r),r},createHandler=(m,o,g=[])=>({get:(e,t,r)=>{if(t===IS_PROXY)return!0;if(t===PROXY_SOURCES)return m.sources;if(t===PROXY_TARGET)return e;if(t===RESOLVE_CONTEXT)return o;let n=Reflect.get(e,t,r);return isObject(n)&&(n[IS_PROXY]||(r=[...g,t],n=createProxy(m,n,o,r),Reflect.set(e,t,n))),n},set:(c,u,l)=>{var f=Reflect.set(c,u,l);if(f){var d=isArray(c);let e=!1,{sources:t,active:r}=m,n,o=0;for(const p of g){if(t=pluck(t,p),d&&o===g.length-1){n=p;break}isArray(r)&&(e=!0),r=r[p],o++}if(e)return recompute(m),f;if(isPlainObject(l))return recompute(m,g),f;let s=[],a;d?(a=t,s=t.map(e=>e[RESOLVE_CONTEXT])):a=pluck(t,u,e=>s.push(e[RESOLVE_CONTEXT]));let i=m.resolve(a,s,r,u,g);isPlainObject(i)&&(i=clone(i)),d&&n?r[n]=i:r[u]=i}return f},deleteProperty:(t,a)=>{var e=Reflect.deleteProperty(t,a);if(e){var i=isArray(t);let n,o=m.sources,s=m.active,e=0;for(const r of g){if(o=o.map(e=>e&&e[r]),i&&e===g.length-1){n=r;break}s=s[r],e++}if(o.some(e=>e&&a in e)){let t=[],e;i?(e=o,t=o.map(e=>e[RESOLVE_CONTEXT])):e=pluck(o,a,e=>t.push(e[RESOLVE_CONTEXT]));let r=m.resolve(e,t,s,a,g);isPlainObject(r)&&(r=clone(r)),i&&n?s[n]=r:s[a]=r}else delete s[a]}return e}}),createMergedObject=(e,t)=>{const n=[],o={active:t,resolve:e,sources:n},s=()=>recompute(o);return{context:o,compute:s,addSource:(e,t,r=!1)=>{t=createProxy(o,e,t||{});return r&&s(),t},delSource:(t,e=!0)=>{var r=n.findIndex(e=>e===t||e[PROXY_TARGET]===t);return-1<r&&(n.splice(r,1),e&&s(),!0)}}},cachedElements={};function renderMeta(e,t,r,n){return("attributesFor"in n?renderAttributes:"group"in n?renderGroup:renderTag)(e,t,r,n)}function renderGroup(n,o,s,a){return isArray(s)?[]:Object.keys(s).map(e=>{const t={group:o,data:s};var r;return a.namespaced?t.tagNamespace=!0===a.namespaced?o:a.namespaced:a.namespacedAttribute&&(r=!0===a.namespacedAttribute?o:a.namespacedAttribute,t.fullName=`${r}:${e}`,t.slotName=`${r}(${e})`),renderTag(n,o,s[e],a,t)}).filter(Boolean).flat()}function renderTag(r,n,t,o={},s){var a=["content","json","rawContent"],i=e=>getTagConfigItem([c,o.tag],e);if(isArray(t))return t.map(e=>renderTag(r,n,e,o,s)).filter(Boolean).flat();const{tag:c=o.tag||n}=t;let u="",e=!1,l=!1;if(isString(t))u=t;else if(t.children&&isArray(t.children))e=!0,u=t.children.map(e=>{const t=renderTag(r,n,e,o,s);return isArray(t)?t.map(({vnode:e})=>e):t&&t.vnode});else{let e=0;for(const g of a){if(!u&&t[g]){u=1===e?JSON.stringify(t[g]):t[g],l=1<e;break}e++}}var f=s&&s.fullName||n,d=s&&s.slotName||n;let p=t["attrs"];if(p||"object"!=typeof t)p=p||{};else{p={...t},delete p.tag,delete p.children,delete p.to;for(const v of a)delete p[v]}if(e)u=getSlotContent(r,d,u,t);else{var m,a=!!i("contentAsAttribute");let e=o["valueAttribute"];!e&&a&&([m]=i("attributes"),e=isString(a)?a:m),u=e?(m=o["nameless"],m||(i=o.keyAttribute||i("keyAttribute"))&&(p[i]=f),p[e]=getSlotContent(r,d,p[e]||u,s),""):getSlotContent(r,d,u,t)}d=s&&s.tagNamespace?`${s.tagNamespace}:${c}`:c;if("title"!==d||r.isSSR){l&&u&&(p.innerHTML=u);d=vue.h(d,p,u||void 0);return{to:t.to,vnode:d}}document.title=u}function renderAttributes(t,r,n,e){var e=e["attributesFor"];if(e&&n){if(t.isSSR)return{to:"",vnode:vue.h(`ssr-${e}`,n)};if(!cachedElements[e]){const[o]=Array.from(document.querySelectorAll(e));cachedElements[e]={el:o,attrs:[]}}const{el:o,attrs:s}=cachedElements[e];for(const a in n){let e=getSlotContent(t,`${r}(${a})`,n[a],n);isArray(e)&&(e=e.join(",")),o.setAttribute(a,e||""),s.includes(a)||s.push(a)}for(const i of s.filter(e=>!n[e]))o.removeAttribute(i)}}function getSlotContent({metainfo:e,slots:t},r,n,o){const s=t&&t[r];if(!s||!isFunction(s))return n;const a={content:n,metainfo:e};o&&o.group&&({group:o,data:i}=o,a[o]=i);var i=s(a);if(i&&i.length){const c=i[0]["children"];return c?c.toString():""}return n}const hasSymbol="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,PolySymbol=e=>hasSymbol?Symbol(e):"_vm_"+e,metaActiveKey=PolySymbol("ma");function applyDifference(e,t,r){for(const n in t)n in r?isObject(e[n])?applyDifference(e[n],t[n],r[n]):t[n]!==r[n]&&(e[n]=t[n]):e[n]=t[n];for(const o in r)t&&o in t||delete e[o]}function getCurrentManager(e){if(e=e||(vue.getCurrentInstance()||void 0))return e.appContext.config.globalProperties.$metaManager}function useMeta(e,t){var r=vue.getCurrentInstance()||void 0;if(!(t=!t&&r?getCurrentManager(r):t))throw new Error("No manager or current instance");vue.isProxy(e)&&(vue.watch(e,(e,t)=>{applyDifference(n.meta,e,t)}),e=e.value);const n=t.addMeta(e,r);return n}function useActiveMeta(){return vue.inject(metaActiveKey)}const MetainfoImpl=vue.defineComponent({name:"Metainfo",inheritAttrs:!1,setup(e,{slots:t}){return()=>{const e=getCurrentManager();if(e)return e.render({slots:t})}}}),Metainfo=MetainfoImpl,ssrAttribute="data-vm-ssr";function addVnode(e,t,r,n){const o=isArray(n)?n:[n];e?r.endsWith("Attrs")||o.forEach(e=>{e.props||(e.props={}),e.props[ssrAttribute]=!0}):o.forEach((e,t)=>{e.type===vue.Comment&&o.splice(t,1)}),t[r]||(t[r]=[]),t[r].push(...o)}const createMetaManager=(e=!1,t,r)=>MetaManager.create(e,t||defaultConfig,r||defaultResolver);class MetaManager{isSSR=!1;config;target;resolver;ssrCleanedUp=!1;constructor(e,t,r,n){this.isSSR=e,this.config=t,this.target=r,n&&"setup"in n&&isFunction(n.setup)&&(this.resolver=n)}static create=(e,t,s)=>{var r=vue.reactive({}),r=createMergedObject((e,t,r,n,o)=>isFunction(s)?s(e,t,r,n,o):s.resolve(e,t,r,n,o),r);return new MetaManager(e,t,r,s)};install(e){e.component("Metainfo",Metainfo),e.config.globalProperties.$metaManager=this,e.provide(metaActiveKey,this.target.context.active)}addMeta(e,t){t=t||(vue.getCurrentInstance()||void 0);const r={removed:[]};var n={vm:t};const o=this["resolver"];o&&o.setup&&o.setup(n);const s=this.target.addSource(e,n,!0);n=e=>this.unmount(!!e,s,r,t);return t&&vue.onUnmounted(n),{meta:s,onRemoved:e=>r.removed.push(e),unmount:n}}unmount(n,o,s,e){if(e){const a=e.proxy["$el"];if(a&&a.offsetParent){let r=new MutationObserver(e=>{for(var{removedNodes:t}of e)t&&t.forEach(e=>{e===a&&r&&(r.disconnect(),r=void 0,this.reallyUnmount(n,o,s))})});return void r.observe(a.parentNode,{childList:!0})}}this.reallyUnmount(n,o,s)}async reallyUnmount(e,t,r){this.target.delSource(t),!e&&r&&await Promise.all(r.removed.map(e=>e()))}render({slots:e}={}){var t,r=this.target.context.active,n=this["isSSR"];n||this.ssrCleanedUp||(this.ssrCleanedUp=!0,t=()=>{const e=document.querySelectorAll(`[${ssrAttribute}]`);e&&e.length&&e.forEach(e=>e.parentNode&&e.parentNode.removeChild(e))},"loading"===document.readyState?window.addEventListener("DOMContentLoaded",t,{once:!0}):t());const o={};for(const u in r){var s=this.config[u]||{};let t=renderMeta({isSSR:n,metainfo:r,slots:e},u,r[u],s);if(t){isArray(t)||(t=[t]);let e="base"!==u&&r[u].to;!e&&"to"in s&&(e=s.to),!e&&"attributesFor"in s&&(e=u);for(var{to:a,vnode:i}of t)addVnode(this.isSSR,o,a||e||"head",i)}}if(e)for(const l in e){var c="default"===l?"head":l;if("head"===c||"body"===c){const f=e[l];isFunction(f)&&addVnode(this.isSSR,o,c,f({metainfo:r}))}}return Object.keys(o).map(e=>{var t=o[e];return vue.h(vue.Teleport,{to:e},t)})}}const defaultOptions={keyName:"metaInfo"},createMixin=r=>({created(){var e=vue.getCurrentInstance();if(e?.type&&r.keyName in e.type){const t=e.type[r.keyName];isFunction(t)?useMeta(vue.computed(t.bind(this))):useMeta(t)}}}),install=(e,t={})=>{t=Object.assign({},defaultOptions,t);e.mixin(createMixin(t))};exports.createMetaManager=createMetaManager,exports.deepestResolver=defaultResolver,exports.defaultConfig=defaultConfig,exports.getCurrentManager=getCurrentManager,exports.plugin=install,exports.resolveOption=resolveOption,exports.useActiveMeta=useActiveMeta,exports.useMeta=useMeta;