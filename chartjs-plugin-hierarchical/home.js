!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("chart.js"),require("chart.js/helpers")):"function"==typeof define&&define.amd?define(["exports","chart.js","chart.js/helpers"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ChartHierarchical={},e.Chart,e.Chart.helpers)}(this,(function(e,t,n){"use strict";function i(e){return null!=e&&Array.isArray(e.children)}function r(e,t){var n;const i={index:0,relIndex:0,label:"",children:[],expand:!1,parent:t?t.index:-1,level:t?t.level+1:0,center:Number.NaN,width:0,hidden:!1,major:!t,toString(){return this.label}};return"string"==typeof e?i.label=e:Object.assign(i,{...e,children:(null!==(n=e.children)&&void 0!==n?n:[]).map((e=>r(e,i)))}),i}function a(e,t,n,i){e.relIndex=t,e.index=n.length,e.parent=i?i.index:-1,e.hidden=Boolean(i&&!1===i.expand||e.expand),n.push(e),e.children.forEach(((t,i)=>a(t,i,n,e)))}function l(e){const t=e.map((e=>r(e))),n=[];return t.forEach(((e,t)=>a(e,t,n))),n}function o(e,t){const n=[e];for(;n[0].parent>=0;)n.unshift(t[n[0].parent]);return n}function s(e){return e.expand&&0!==e.children.length?s(e.children[e.children.length-1]):e}function c(e,t){var n;if(e.parent>-1){const n=t[e.parent];return s(n.children[n.children.length-1])}return s(null!==(n=t.slice().reverse().find((e=>-1===e.parent)))&&void 0!==n?n:t[0])}function d(e,t){!1!==t(e)&&e.children.forEach((e=>d(e,t)))}function h(e,t,n){const r=o(e,t);let a={children:n,value:Number.NaN};const l=r.map((e=>(a=a&&i(a)?a.children[e.relIndex]:Number.NaN,a))),s=l[l.length-1];return i(s)?s.value:s}function f(e){return e.expand?e.children.reduce(((e,t)=>e+f(t)),0):1}function u(e,t){if(0===e.children.length)return[];const n=e.children[0];if(e.parent>=0&&e.relIndex<t[e.parent].children.length-1){const i=t[e.parent].children[e.relIndex+1];return t.slice(n.index,i.index)}const i=t.slice(n.index+1).find((t=>t.level<e.level||t.parent===e.parent&&t.relIndex===e.relIndex+1));return i?t.slice(n.index,i.index):t.slice(n.index)}function p(e,t,n,i="between-first-and-second"){if(0===e.children.length||!e.expand)return!1;const r=e.children[0],a=e.children[e.children.length-1],l=u(e,t),s=l.find((e=>n.has(e))),c=l.slice().reverse().find((e=>n.has(e)));if(!s||!c)return!1;const d=o(s,t),h=o(c,t),f=d[e.level+1]===r,p=h[e.level+1]===a,x=f&&"focus"!==e.expand,b=f&&p&&e.children.length>1;let g=0;switch(i){case"between-first-and-second":{const e=t.slice(s.index+1,c.index+1).find((e=>n.has(e)));g=e?(s.center+e.center)/2:s.center}break;case"center":g=(s.center+c.center)/2;break;case"last":g=c.center;break;default:g=s.center}return{hasCollapseBox:x,hasFocusBox:b,leftVisible:s,rightVisible:c,groupLabelCenter:g,leftFirstVisible:f,rightLastVisible:p}}function x(e){let t="";const n=e=>{"string"!=typeof e?(t+=`(l=${e.label},e=${e.expand},c=[`,(e.children||[]).forEach(n),t+="])"):t+=e};return e.forEach(n),t}function b(e,t){var n;const i=null===(n=e.config.options)||void 0===n?void 0:n.scales;return!(!i||!Object.prototype.hasOwnProperty.call(i,t))&&Object.prototype.hasOwnProperty.call(i[t],"type")}function g(e){var t;const{options:n}=e.config;if(!n||!Object.prototype.hasOwnProperty.call(n,"scales"))return null;const i=null===(t=e.config.options)||void 0===t?void 0:t.scales;return i&&b(e,"x")&&"hierarchical"===i.x.type?"x":i&&b(e,"y")&&"hierarchical"===i.y.type?"y":null}function v(e){if(e.data.labels&&e.data._verify===x(e.data.labels))return;const t=l(e.data.labels);e.data.flatLabels=t,e.data.rootNodes=t.filter((e=>-1===e.parent));const n=function(e){const t=e.find((e=>"focus"===e.expand));return t?e.slice(t.index+1).filter((n=>!n.hidden&&o(n,e).includes(t))):e.filter((e=>!e.hidden))}(t);e.data.labels=n,y(e),e.data.datasets.forEach((e=>{null==e.tree&&(e.tree=e.data.slice()),e.data=n.map((n=>h(n,t,e.tree)))})),m(e)}function y(e){e.data._verify=x(e.data.labels)}function m(e){var t;const n=T(e);if(!n)return;const{attributes:i}=n.options,r=e.data.labels,a=null!==(t=e.data.flatLabels)&&void 0!==t?t:[];Object.keys(i).forEach((t=>{e.data.datasets.forEach((e=>{const n=r.map((e=>{for(;e;){if(void 0!==e[t])return e[t];e=e.parent>=0?a[e.parent]:null}return i[t]}));e[t]=n.length>=1&&n.every((e=>e===n[0]))?n[0]:n}))}))}function T(e){return Object.keys(e.scales).map((t=>e.scales[t])).find((e=>"hierarchical"===e.type))}function L(e){y(e),m(e),e.update()}function w(e,t,n,i){var r,a;const l=e.data.labels,o=null!==(r=e.data.flatLabels)&&void 0!==r?r:[],s=e.data.datasets;l.splice(t,n,...i).forEach((e=>{e.hidden=!0})),i.forEach((e=>{e.hidden=!1})),null===(a=T(e))||void 0===a||a.determineDataLimits(),s.forEach((e=>{var r;const a=i.map((t=>h(t,o,e.tree)));null===(r=e.data)||void 0===r||r.splice(t,n,...a)}))}function B(e,t,n){const i=f(n);n.children.forEach((e=>d(e,(e=>{e.expand=!1})))),w(e,t,i,[n]),n.expand=!1,L(e)}function _(e,t,n,i){var r;const a=f(n);i.forEach((e=>{"focus"===e.expand&&(e.expand=!0)})),n.expand="focus";const l=t-a+1,{labels:o}=e.data;o.splice(t+1,o.length),o.splice(0,l),null===(r=T(e))||void 0===r||r.determineDataLimits();e.data.datasets.forEach((e=>{e.data&&(e.data.splice(t+1,e.data.length),e.data.splice(0,l))})),L(e)}function k(e,t){var n,i;const r=e.data.labels,a=null!==(n=e.data.flatLabels)&&void 0!==n?n:[];t.expand=!0;const l=a.filter((e=>!e.hidden)),o=l.indexOf(r[0]),s=r.length;r.splice(r.length,0,...l.slice(o+s)),r.splice(0,0,...l.slice(0,o)),null===(i=T(e))||void 0===i||i.determineDataLimits();e.data.datasets.forEach((e=>{const t=l.slice(0,o).map((t=>h(t,a,e.tree))),n=l.slice(o+s).map((t=>h(t,a,e.tree)));e.data&&(e.data.splice(e.data.length,0,...n),e.data.splice(0,0,...t))})),L(e)}function E(e,t,n,i,r){var a,l;const s=e;let{offset:d}=n;const{index:h}=n,f=null!==(a=s.data.flatLabels)&&void 0!==a?a:[],p=null===(l=s.data.labels)||void 0===l?void 0:l[h];if(!p)return;const x=o(p,f);for(let e=1;e<x.length;e+=1,d+=i){if(!r(d))continue;const t=x[e],n=t.children[0]===x[e+1]||e===x.length-1,i=f[t.parent];if(n&&0===t.relIndex&&!0===i.expand)return void B(s,h,i);const a=c(t,f)===p;if(a&&"focus"===i.expand)return void k(s,i);if(a&&!0===i.expand&&u(i,f).every((e=>"focus"!==e.expand)))return void _(s,h,i,f)}p.children.length>0&&r(d)&&function(e,t,n){w(e,t,1,n.children),n.expand=!0,L(e)}(s,h,p)}const S={id:"hierarchical",beforeUpdate(e){g(e)&&v(e)},beforeDatasetsDraw(e){var i,r;if(!g(e))return;const a=e,l=T(e),{ctx:o}=e;if(!l||!o)return;const s=null!==(i=a.data.flatLabels)&&void 0!==i?i:[],c=e.data.labels,h=null!==(r=a.data.rootNodes)&&void 0!==r?r:[],f=new Set(c),u=l.isHorizontal(),x=l.options.hierarchyBoxSize,b=.5*x,v=.1*x,y=l.options.hierarchyBoxLineHeight,m=l.options.hierarchyBoxColor,L=l.options.hierarchyBoxWidth,w=l.options.hierarchySpanColor,B=l.options.hierarchySpanWidth,_=l.options.hierarchyLabelPosition,k=l.options.hierarchyGroupLabelPosition,E=l.options.static,S=l.options.title,P=n.valueOrDefault(S.color,t.defaults.color),C=n.toFont(S.font);function V(e,t,n,i){if(E){if("expand"===e)return;return o.save(),o.strokeStyle=w,o.lineWidth=B,o.beginPath(),t?(o.moveTo(n-v,i),o.lineTo(n-b,i)):(o.moveTo(n,i+v),o.lineTo(n,i+b),o.lineTo(n+("collapse"===e?b:-b),i+b)),o.stroke(),void o.restore()}const r=n-(t?x:b),a=i-(t?b:0);switch(o.strokeRect(r,a,x,x),e){case"expand":o.fillRect(r+2,a+b-1,x-4,2),o.fillRect(r+b-1,a+2,2,x-4);break;case"collapse":o.fillRect(r+2,a+b-1,x-4,2);break;case"focus":o.fillRect(r+b-2,a+b-2,4,4)}}o.save(),o.strokeStyle=m,o.lineWidth=L,o.fillStyle=P,o.font=C.string;const j=e=>{if(0===e.children.length)return!1;const t=e.level*y;if(!e.expand)return f.has(e)&&V("expand",!1,e.center,t),!1;const n=p(e,s,f,k);if(!n)return!1;const{hasFocusBox:i,hasCollapseBox:r,leftVisible:a,rightVisible:l,leftFirstVisible:c,rightLastVisible:d,groupLabelCenter:h}=n;return"below"===_?o.fillText(e.label,h,t+x):"above"===_&&o.fillText(e.label,h,t-x),r&&V("collapse",!1,a.center,t),i&&V("focus",!1,l.center,t),a!==l&&(o.strokeStyle=w,o.lineWidth=B,o.beginPath(),r?o.moveTo(a.center+b,t+b):c?(o.moveTo(a.center,t+v),o.lineTo(a.center,t+b)):o.moveTo(a.center,t+b),i?o.lineTo(l.center-b,t+b):d?(o.lineTo(l.center,t+b),o.lineTo(l.center,t+v)):o.lineTo(l.center,t+b),o.stroke(),o.strokeStyle=m,o.lineWidth=L),!0},O=e=>{if(0===e.children.length)return!1;const t=e.level*y*-1;if(!e.expand)return f.has(e)&&V("expand",!0,t,e.center),!1;const n=p(e,s,f,k);if(!n)return!1;const{hasFocusBox:i,hasCollapseBox:r,leftVisible:a,rightVisible:l,leftFirstVisible:c,rightLastVisible:d,groupLabelCenter:h}=n;return o.fillText(e.label,t-x,h),r&&V("collapse",!0,t,a.center),i&&V("focus",!0,t,l.center),a!==l&&(o.strokeStyle=w,o.lineWidth=B,o.beginPath(),r?o.moveTo(t-b,a.center+b):c?(o.moveTo(t-v,a.center),o.lineTo(t-b,a.center)):o.lineTo(t-b,a.center),i?o.lineTo(t-b,l.center-b):d?(o.lineTo(t-b,l.center-b),o.lineTo(t-v,l.center-b)):o.lineTo(t-b,l.center),o.stroke(),o.strokeStyle=m,o.lineWidth=L),!0};u?(o.textAlign="center",o.textBaseline="above"===_?"bottom":"top",o.translate(l.left,l.top+l.options.padding),h.forEach((e=>d(e,j)))):(o.textAlign="right",o.textBaseline="middle",o.translate(l.left-l.options.padding,l.top),h.forEach((e=>d(e,O)))),o.restore()},beforeEvent(e,{event:t}){if("click"!==t.type||!g(e))return;const n=t,i=T(e);if(!i||i.options.static)return;const r=i.isHorizontal(),a=function(e,t){const n=t.isHorizontal(),i=n?t.top+t.options.padding:t.left-t.options.padding;return n&&e.y<=i||!n&&e.x>i?null:{offset:i,index:t.getValueForPixel(n?e.x-t.left:e.y-t.top)}}(n,i);if(!a)return;const l=i.options.hierarchyBoxLineHeight;E(e,0,a,r?l:-l,r?e=>n.y>=e&&n.y<=e+l:e=>n.x<=e&&n.x>=e-l)}};class P extends t.CategoryScale{constructor(){super(...arguments),this._nodes=[]}determineDataLimits(){const e=this.getLabels();this._nodes=e.slice(),super.determineDataLimits()}buildTicks(){const e=this._nodes.slice(this.min,this.max+1);return this._valueRange=Math.max(e.length,1),this._startValue=this.min-.5,0===e.length?[]:e.map(((e,t)=>({label:e.label,value:t})))}configure(){var e;super.configure();const t=this._nodes.slice(this.min,this.max+1),n=null!==(e=this.chart.data.flatLabels)&&void 0!==e?e:[],i=this._length;if(0===t.length)return;const r=this.options.levelPercentage,a=[1,Math.pow(r,1),Math.pow(r,2),Math.pow(r,3),Math.pow(r,4)],l=[];let s=t[0],c=o(s,n);l.push(.5);for(let e=1;e<t.length;e+=1){const i=t[e],r=o(i,n);if(s.parent===i.parent)l.push(a[i.level]);else{let e=0;for(;r[e]===c[e];)e+=1;l.push(a[e])}s=i,c=r}l.push(.5);const d=i/l.reduce(((e,t)=>e+t),0);let h=l[0]*d;t.forEach(((e,t)=>{const n=l[t]*d,i=l[t+1]*d;e.center=h,h+=i,e.width=Math.min(i,n)/2}))}getPixelForDecimal(e){const t=Math.min(Math.floor(e*this._nodes.length),this._nodes.length-1);return 1===t&&1===this._nodes.length?this._nodes[0].width:this._centerBase(t)}_centerBase(e){const t=this.options.offset,n=this._startPixel,i=this._nodes[e];if(null==i)return n;const r=null!=i.center?i.center:0,a=null!=i.width?i.width:0;return n+r-(t?0:a/2)}getValueForPixel(e){return this._nodes.findIndex((t=>e>=t.center-t.width/2&&e<=t.center+t.width/2))}static afterRegister(){t.registry.addPlugins(S)}}P.id="hierarchical",P.defaults=n.merge({},[t.CategoryScale.defaults,{offset:!0,grid:{offset:!0},static:!1,levelPercentage:.75,padding:25,hierarchyLabelPosition:"below",hierarchyGroupLabelPosition:"between-first-and-second",hierarchyBoxSize:14,hierarchyBoxLineHeight:30,hierarchySpanColor:"gray",hierarchySpanWidth:2,hierarchyBoxColor:"gray",hierarchyBoxWidth:1,attributes:{}}]),t.registry.addScales(P),e.HierarchicalScale=P,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.min.js.map
