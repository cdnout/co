import{defaults,CategoryScale,registry}from"chart.js";import{valueOrDefault,toFont,merge}from"chart.js/helpers";function isValueNode(e){return null!=e&&Array.isArray(e.children)}function asNode(e,t){const n={index:0,relIndex:0,label:"",children:[],expand:!1,parent:t?t.index:-1,level:t?t.level+1:0,center:Number.NaN,width:0,hidden:!1,major:!t,toString(){return this.label}};return"string"==typeof e?n.label=e:Object.assign(n,{...e,children:(null!==(e=e.children)&&void 0!==e?e:[]).map(e=>asNode(e,n))}),n}function push(n,e,a,t){n.relIndex=e,n.index=a.length,n.parent=t?t.index:-1,n.hidden=Boolean(t&&!1===t.expand||n.expand),a.push(n),n.children.forEach((e,t)=>push(e,t,a,n))}function toNodes(e){const t=e.map(e=>asNode(e)),n=[];return t.forEach((e,t)=>push(e,t,n)),n}function parentsOf(e,t){const n=[e];for(;0<=n[0].parent;)n.unshift(t[n[0].parent]);return n}function rightMost(e){return e.expand&&0!==e.children.length?rightMost(e.children[e.children.length-1]):e}function lastOfLevel(e,t){if(-1<e.parent){var n=t[e.parent];return rightMost(n.children[n.children.length-1])}return rightMost(null!==(n=t.slice().reverse().find(e=>-1===e.parent))&&void 0!==n?n:t[0])}function preOrderTraversal(e,t){!1!==t(e)&&e.children.forEach(e=>preOrderTraversal(e,t))}function resolve(e,t,n){const a=parentsOf(e,t);let r={children:n,value:Number.NaN};n=a.map(e=>(r=r&&isValueNode(r)?r.children[e.relIndex]:Number.NaN,r)),n=n[n.length-1];return isValueNode(n)?n.value:n}function countExpanded(e){return e.expand?e.children.reduce((e,t)=>e+countExpanded(t),0):1}function flatChildren(t,e){if(0===t.children.length)return[];var n=t.children[0];if(0<=t.parent&&t.relIndex<e[t.parent].children.length-1){const a=e[t.parent].children[t.relIndex+1];return e.slice(n.index,a.index)}const a=e.slice(n.index+1).find(e=>e.level<t.level||e.parent===t.parent&&e.relIndex===t.relIndex+1);return a?e.slice(n.index,a.index):e.slice(n.index)}function determineVisible(t){const n=t.find(e=>"focus"===e.expand);return n?t.slice(n.index+1).filter(e=>!e.hidden&&parentsOf(e,t).includes(n)):t.filter(e=>!e.hidden)}function spanLogic(e,t,n,a="between-first-and-second"){if(0===e.children.length||!e.expand)return!1;var r=e.children[0],i=e.children[e.children.length-1];const l=flatChildren(e,t);var o=l.find(e=>n.has(e)),s=l.slice().reverse().find(e=>n.has(e));if(!o||!s)return!1;var c=parentsOf(o,t),d=parentsOf(s,t),r=c[e.level+1]===r,d=d[e.level+1]===i,i=r&&"focus"!==e.expand,e=r&&d&&1<e.children.length;let h=0;switch(a){case"between-first-and-second":var p=t.slice(o.index+1,s.index+1).find(e=>n.has(e));h=p?(o.center+p.center)/2:o.center;break;case"center":h=(o.center+s.center)/2;break;case"last":h=s.center;break;default:h=o.center}return{hasCollapseBox:i,hasFocusBox:e,leftVisible:o,rightVisible:s,groupLabelCenter:h,leftFirstVisible:r,rightLastVisible:d}}function generateCode(e){let t="";const n=e=>{"string"!=typeof e?(t+=`(l=${e.label},e=${e.expand},c=[`,(e.children||[]).forEach(n),t+="])"):t+=e};return e.forEach(n),t}function isValidScaleType(e,t){e=null===(e=e.config.options)||void 0===e?void 0:e.scales;return!(!e||!Object.prototype.hasOwnProperty.call(e,t))&&Object.prototype.hasOwnProperty.call(e[t],"type")}function enabled(e){var t=e.config["options"];if(!t||!Object.prototype.hasOwnProperty.call(t,"scales"))return null;t=null===(t=e.config.options)||void 0===t?void 0:t.scales;return t&&isValidScaleType(e,"x")&&"hierarchical"===t.x.type?"x":t&&isValidScaleType(e,"y")&&"hierarchical"===t.y.type?"y":null}function check(e){if(!e.data.labels||e.data._verify!==generateCode(e.data.labels)){const n=toNodes(e.data.labels);e.data.flatLabels=n,e.data.rootNodes=n.filter(e=>-1===e.parent);const a=determineVisible(n);e.data.labels=a,updateVerifyCode(e),e.data.datasets.forEach(t=>{null==t.tree&&(t.tree=t.data.slice()),t.data=a.map(e=>resolve(e,n,t.tree))}),updateAttributes(e)}}function updateVerifyCode(e){e.data._verify=generateCode(e.data.labels)}function updateAttributes(e){var t=findScale(e);if(t){const a=t.options["attributes"],r=e.data.labels,i=null!==(t=e.data.flatLabels)&&void 0!==t?t:[];Object.keys(a).forEach(n=>{e.data.datasets.forEach(e=>{const t=r.map(e=>{for(;e;){if(void 0!==e[n])return e[n];e=0<=e.parent?i[e.parent]:null}return a[n]});e[n]=1<=t.length&&t.every(e=>e===t[0])?t[0]:t})})}}function findScale(t){const e=Object.keys(t.scales).map(e=>t.scales[e]);return e.find(e=>"hierarchical"===e.type)}function postDataUpdate(e){updateVerifyCode(e),updateAttributes(e),e.update()}function expandCollapse(e,a,r,i){var t;const n=e.data.labels,l=null!==(t=e.data.flatLabels)&&void 0!==t?t:[],o=e.data.datasets,s=n.splice(a,r,...i);s.forEach(e=>{e.hidden=!0}),i.forEach(e=>{e.hidden=!1}),null!==(e=findScale(e))&&void 0!==e&&e.determineDataLimits(),o.forEach(t=>{var e,n=i.map(e=>resolve(e,l,t.tree));null!==(e=t.data)&&void 0!==e&&e.splice(a,r,...n)})}function collapse(e,t,n){var a=countExpanded(n);n.children.forEach(e=>preOrderTraversal(e,e=>{e.expand=!1})),expandCollapse(e,t,a,[n]),n.expand=!1,postDataUpdate(e)}function expand(e,t,n){expandCollapse(e,t,1,n.children),n.expand=!0,postDataUpdate(e)}function zoomIn(e,t,n,a){var r=countExpanded(n);a.forEach(e=>{"focus"===e.expand&&(e.expand=!0)}),n.expand="focus";const i=t-r+1,l=e.data["labels"];l.splice(t+1,l.length),l.splice(0,i),null!==(r=findScale(e))&&void 0!==r&&r.determineDataLimits();const o=e.data.datasets;o.forEach(e=>{e.data&&(e.data.splice(t+1,e.data.length),e.data.splice(0,i))}),postDataUpdate(e)}function zoomOut(e,t){var n;const a=e.data.labels,r=null!==(n=e.data.flatLabels)&&void 0!==n?n:[];t.expand=!0;const i=r.filter(e=>!e.hidden),l=i.indexOf(a[0]),o=a.length;a.splice(a.length,0,...i.slice(l+o)),a.splice(0,0,...i.slice(0,l)),null!==(t=findScale(e))&&void 0!==t&&t.determineDataLimits();const s=e.data.datasets;s.forEach(t=>{var e=i.slice(0,l).map(e=>resolve(e,r,t.tree)),n=i.slice(l+o).map(e=>resolve(e,r,t.tree));t.data&&(t.data.splice(t.data.length,0,...n),t.data.splice(0,0,...e))}),postDataUpdate(e)}function resolveElement(e,t){var n=t.isHorizontal(),a=n?t.top+t.options.padding:t.left-t.options.padding;return n&&e.y<=a||!n&&e.x>a?null:{offset:a,index:t.getValueForPixel(n?e.x-t.left:e.y-t.top)}}function handleClickEvents(e,t,n,a,r){var i=e;let l=n["offset"];var o=n["index"],s=null!==(n=i.data.flatLabels)&&void 0!==n?n:[],c=null===(n=i.data.labels)||void 0===n?void 0:n[o];if(c){var d=parentsOf(c,s);for(let e=1;e<d.length;e+=1,l+=a)if(r(l)){var h=d[e],p=h.children[0]===d[e+1]||e===d.length-1,f=s[h.parent];if(p&&0===h.relIndex&&!0===f.expand)return void collapse(i,o,f);h=lastOfLevel(h,s)===c;if(h&&"focus"===f.expand)return void zoomOut(i,f);if(h&&!0===f.expand&&flatChildren(f,s).every(e=>"focus"!==e.expand))return void zoomIn(i,o,f,s)}0<c.children.length&&r(l)&&expand(i,o,c)}}const hierarchicalPlugin={id:"hierarchical",beforeUpdate(e){enabled(e)&&check(e)},beforeDatasetsDraw(e){if(enabled(e)){var t=e;const a=findScale(e),d=e["ctx"];if(a&&d){const h=null!==(n=t.data.flatLabels)&&void 0!==n?n:[];var n=e.data.labels;const r=null!==(e=t.data.rootNodes)&&void 0!==e?e:[],p=new Set(n);t=a.isHorizontal();const f=a.options.hierarchyBoxSize,u=.5*f,v=.1*f,x=a.options.hierarchyBoxLineHeight,g=a.options.hierarchyBoxColor,b=a.options.hierarchyBoxWidth,y=a.options.hierarchySpanColor,m=a.options.hierarchySpanWidth,S=a.options.hierarchyLabelPosition,T=a.options.hierarchyGroupLabelPosition,l=a.options.static;e=a.options.title,n=valueOrDefault(e.color,defaults.color),e=toFont(e.font);d.save(),d.strokeStyle=g,d.lineWidth=b,d.fillStyle=n,d.font=e.string;const i=e=>{if(0===e.children.length)return!1;var t=e.level*x;if(!e.expand)return p.has(e)&&c("expand",!1,e.center,t),!1;var n=spanLogic(e,h,p,T);if(!n)return!1;var{hasFocusBox:a,hasCollapseBox:r,leftVisible:i,rightVisible:l,leftFirstVisible:o,rightLastVisible:s,groupLabelCenter:n}=n;return"below"===S?d.fillText(e.label,n,t+f):"above"===S&&d.fillText(e.label,n,t-f),r&&c("collapse",!1,i.center,t),a&&c("focus",!1,l.center,t),i!==l&&(d.strokeStyle=y,d.lineWidth=m,d.beginPath(),r?d.moveTo(i.center+u,t+u):o?(d.moveTo(i.center,t+v),d.lineTo(i.center,t+u)):d.moveTo(i.center,t+u),a?d.lineTo(l.center-u,t+u):s?(d.lineTo(l.center,t+u),d.lineTo(l.center,t+v)):d.lineTo(l.center,t+u),d.stroke(),d.strokeStyle=g,d.lineWidth=b),!0},o=e=>{if(0===e.children.length)return!1;var t=e.level*x*-1;if(!e.expand)return p.has(e)&&c("expand",!0,t,e.center),!1;var n=spanLogic(e,h,p,T);if(!n)return!1;var{hasFocusBox:a,hasCollapseBox:r,leftVisible:i,rightVisible:l,leftFirstVisible:o,rightLastVisible:s,groupLabelCenter:n}=n;return d.fillText(e.label,t-f,n),r&&c("collapse",!0,t,i.center),a&&c("focus",!0,t,l.center),i!==l&&(d.strokeStyle=y,d.lineWidth=m,d.beginPath(),r?d.moveTo(t-u,i.center+u):(o&&d.moveTo(t-v,i.center),d.lineTo(t-u,i.center)),a?d.lineTo(t-u,l.center-u):s?(d.lineTo(t-u,l.center-u),d.lineTo(t-v,l.center-u)):d.lineTo(t-u,l.center),d.stroke(),d.strokeStyle=g,d.lineWidth=b),!0};function c(e,t,n,a){if(l)return"expand"!==e&&(d.save(),d.strokeStyle=y,d.lineWidth=m,d.beginPath(),t?(d.moveTo(n-v,a),d.lineTo(n-u,a)):(d.moveTo(n,a+v),d.lineTo(n,a+u),d.lineTo(n+("collapse"===e?u:-u),a+u)),d.stroke(),void d.restore());var r=n-(t?f:u),i=a-(t?u:0);switch(d.strokeRect(r,i,f,f),e){case"expand":d.fillRect(2+r,i+u-1,f-4,2),d.fillRect(r+u-1,2+i,2,f-4);break;case"collapse":d.fillRect(2+r,i+u-1,f-4,2);break;case"focus":d.fillRect(r+u-2,i+u-2,4,4)}}t?(d.textAlign="center",d.textBaseline="above"===S?"bottom":"top",d.translate(a.left,a.top+a.options.padding),r.forEach(e=>preOrderTraversal(e,i))):(d.textAlign="right",d.textBaseline="middle",d.translate(a.left-a.options.padding,a.top),r.forEach(e=>preOrderTraversal(e,o))),d.restore()}}},beforeEvent(e,{event:t}){if("click"===t.type&&enabled(e)){const r=t,i=findScale(e);if(i&&!i.options.static){var n=i.isHorizontal(),a=resolveElement(r,i);if(a){const l=i.options.hierarchyBoxLineHeight;handleClickEvents(e,t,a,n?l:-l,n?e=>r.y>=e&&r.y<=e+l:e=>r.x<=e&&r.x>=e-l)}}}}},defaultConfig={offset:!0,grid:{offset:!0},static:!1,levelPercentage:.75,padding:25,hierarchyLabelPosition:"below",hierarchyGroupLabelPosition:"between-first-and-second",hierarchyBoxSize:14,hierarchyBoxLineHeight:30,hierarchySpanColor:"gray",hierarchySpanWidth:2,hierarchyBoxColor:"gray",hierarchyBoxWidth:1,attributes:{}};class HierarchicalScale extends CategoryScale{constructor(){super(...arguments),this._nodes=[]}determineDataLimits(){const e=this.getLabels();this._nodes=e.slice(),super.determineDataLimits()}buildTicks(){const e=this._nodes.slice(this.min,this.max+1);return this._valueRange=Math.max(e.length,1),this._startValue=this.min-.5,0===e.length?[]:e.map((e,t)=>({label:e.label,value:t}))}configure(){super.configure();const r=this._nodes.slice(this.min,this.max+1);var i=null!==(l=this.chart.data.flatLabels)&&void 0!==l?l:[],e=this._length;if(0!==r.length){var l=this.options.levelPercentage,o=[1,Math.pow(l,1),Math.pow(l,2),Math.pow(l,3),Math.pow(l,4)];const d=[];let t=r[0],n=parentsOf(t,i);d.push(.5);for(let e=1;e<r.length;e+=1){var s=r[e],c=parentsOf(s,i);if(t.parent===s.parent)d.push(o[s.level]);else{let e=0;for(;c[e]===n[e];)e+=1;d.push(o[e])}t=s,n=c}d.push(.5);const h=e/d.reduce((e,t)=>e+t,0);let a=d[0]*h;r.forEach((e,t)=>{var n=d[t]*h,t=d[t+1]*h;e.center=a,a+=t,e.width=Math.min(t,n)/2})}}getPixelForDecimal(e){e=Math.min(Math.floor(e*this._nodes.length),this._nodes.length-1);return 1===e&&1===this._nodes.length?this._nodes[0].width:this._centerBase(e)}_centerBase(e){var t=this.options.offset,n=this._startPixel,a=this._nodes[e];if(null==a)return n;e=null!=a.center?a.center:0,a=null!=a.width?a.width:0;return n+e-(t?0:a/2)}getValueForPixel(t){return this._nodes.findIndex(e=>t>=e.center-e.width/2&&t<=e.center+e.width/2)}static afterRegister(){registry.addPlugins(hierarchicalPlugin)}}HierarchicalScale.id="hierarchical",HierarchicalScale.defaults=merge({},[CategoryScale.defaults,defaultConfig]);export{HierarchicalScale};