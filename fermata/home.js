var fermata={plugins:{}};if(fermata._builtinProxy="function"==typeof Proxy,fermata.registerPlugin=function(r,e){fermata.plugins[r]=e,fermata[r]=function(){var e={base:"",path:[""],query:{}},t=[r].concat([].slice.call(arguments)),n=fermata._makeTransport.call(e,"_base").using.apply(null,t);return fermata._makeNativeURL(n,e)},fermata._useExports&&(exports[r]=fermata[r])},fermata._makeTransport=function(e,t){var n=this,r=fermata.plugins[e].apply(n,t);return r.using=function(){var e=arguments[0];return arguments[0]=r,fermata._makeTransport.call(n,e,arguments)},r},fermata._makeNativeURL=function(f,p){return fermata._wrapTheWrapper(function(){var e=[].slice.call(arguments),t=fermata._typeof2(e[e.length-1]);if("undefined"===t)return fermata._stringForURL(p);if("function"===t){var n=e.pop(),r=e.pop(),a=fermata._normalize(e.pop()||{}),o=e.pop()||{},i=p.path.pop().toUpperCase();return"DEL"===i&&(i="DELETE"),"string"==typeof o&&(console&&console.warn&&console.warn("Using deprecated API: use an options object to set `{responseType:'"+o+"'}` instead of passing raw string."),o={responseType:o}),f({base:p.base,method:i,path:p.path,query:p.query,options:o,headers:a,data:r},n)}var u="object"===t?fermata._extend({},p.query,e.pop()):p.query,s=e.length?p.path.concat(e):p.path;return fermata._makeNativeURL(f,{base:p.base,path:s,query:u})})},fermata._wrapTheWrapper=function(n){return fermata._nodeProxy?fermata._nodeProxy.createFunction({getOwnPropertyDescriptor:function(e){},enumerate:function(){return[]},delete:function(){return!1},fix:function(){},set:function(e,t,n){},get:function(e,t){return n(t)}},n):fermata._builtinProxy&&Proxy.createFunction?Proxy.createFunction({getOwnPropertyDescriptor:function(e){},getPropertyDescriptor:function(e){},getPropertyNames:function(){return[]},enumerate:function(){return[]},defineProperty:function(){return!1},delete:function(){return!1},fix:function(){},get:function(e,t){return n(t)}},n):fermata._builtinProxy?new Proxy(n,{get:function(e,t){return n(t)}}):fermata._extend(n,{get:function(){return n("get").apply(null,arguments)},put:function(){return n("put").apply(null,arguments)},post:function(){return n("post").apply(null,arguments)},delete:function(){return n("delete").apply(null,arguments)},del:function(){return n("del").apply(null,arguments)}})},fermata._nodeTransport=function(o,i){var e=fermata._stringForURL(o),t=require("url").parse(e),n={};o.options.responseType||(o.options.responseType="text"),t.auth&&("either/or"!==require("url").parse("http//either%2for@example").auth&&(t.auth=decodeURIComponent(t.auth)),n.Authorization="Basic "+new Buffer(t.auth).toString("base64")),fermata._extend(n,o.headers),o.data&&"GET"===o.method||"HEAD"===o.method?(console&&console.warn&&console.warn("Ignoring data passed to GET or HEAD request."),o.data=null):"string"==typeof o.data&&(o.data=new Buffer(o.data,"utf8"),n["Content-Type"]||(n["Content-Type"]="text/plain;charset=UTF-8"));var r="https:"===t.protocol?require("https"):require("http"),a=fermata._extend({},o.options.node,{host:t.hostname,port:t.port,method:o.method,path:t.pathname+(t.search||""),headers:n,agent:o.options.node&&o.options.node.agent||r.globalAgent}),u=r.request(a);return fermata._isStream(o.data)?o.data.pipe(u):o.data?(u.setHeader("Content-Length",o.data.length),u.end(o.data)):(u.setHeader("Content-Length",0),u.end()),u.on("error",function(e){i(e,null)}),"stream"===o.options.responseType?u.on("response",function(e){i(null,{status:e.statusCode,headers:fermata._normalize(e.headers),data:e})}):u.on("response",function(n){var r=[],a=0;n.on("data",function(e){r.push(e),a+=e.length}),n.on("end",function(e){var t=Buffer.concat(r,a);"text"===o.options.responseType&&(t=t.toString("utf8")),i(e||null,{status:n.statusCode,headers:fermata._normalize(n.headers),data:t})})}),u},fermata._xhrTransport=function(t,e){var n=new XMLHttpRequest,r=fermata._stringForURL(t),a=t.options.xhr||{};return n.open(t.method,r,!0),n.responseType=t.options.responseType||"text",Object.keys(a).forEach(function(e){n[e]=a[e]}),Object.keys(t.headers).forEach(function(e){n.setRequestHeader(e,t.headers[e])}),n.send(t.data),n.onreadystatechange=function(){if(this.readyState===(n.DONE||4))if(this.status){var t={};this.getAllResponseHeaders().split("\r\n").forEach(function(e){e&&(e=e.split(": "),t[e[0]]=e.slice(1).join(": "))}),e(null,{status:this.status,headers:fermata._normalize(t),data:this.response||this.responseText})}else e(Error("XHR request failed"),null)},n},fermata._stringForURL=function(e){var t=e.path.map(function(e){return e.join?e.join("/"):encodeURIComponent(e)}).join("/"),n=fermata._flatten(e.query).map(function(e){return encodeURIComponent(e[0])+(null!==e[1]?"="+encodeURIComponent(e[1]):"")}).join("&");return e.base+t+(n?"?"+n:"")},fermata._flatten=function(n){var r=[];return Object.keys(n).forEach(function(t){var e=n[t];"$"===t[0]&&"$"!==(t=t.slice(1))[0]&&(e=JSON.stringify(e)),[].concat(e).forEach(function(e){r.push([t,e])})}),r},fermata._unflatten=function(e){var r={};return e.forEach(function(e){var t=e[0],n=e[1];r[t]={}.hasOwnProperty.call(r,t)?[].concat(r[t],n):n}),r},fermata._normalize=function(n){var r={};return Object.keys(n).forEach(function(e){var t=e.split("-").map(function(e){return e&&e[0].toUpperCase()+e.slice(1).toLowerCase()}).join("-");r[t]=n[e]}),r},fermata._extend=Object.assign?Object.assign:function(n){return Array.prototype.slice.call(arguments,1).forEach(function(t){t&&Object.keys(t).forEach(function(e){n[e]=t[e]})}),n},fermata._typeof2=function(e){return Array.isArray(e)?"array":typeof e},"undefined"!=typeof exports&&(fermata._useExports=!0,exports.registerPlugin=fermata.registerPlugin,exports.plugins=fermata.plugins,!fermata._builtinProxy))try{fermata._nodeProxy=require("node-proxy")}catch(e){}"undefined"==typeof window&&fermata.registerPlugin("oauth",require("./plugins/oauth").init(fermata)),"undefined"==typeof XMLHttpRequest?fermata._transport=fermata._nodeTransport:fermata._transport=fermata._xhrTransport,fermata.registerPlugin("_base",function(){return function(e,t){return fermata._transport(e,t)}}),fermata.registerPlugin("raw",function(e,t){return fermata._extend(this,t),e}),fermata.registerPlugin("timeout",function(a,o){return function(e,n){var t,r=setTimeout(function(){r=null,t.abort()},o||6e4);return t=a(e,function(e,t){r?clearTimeout(r):e=Error("Request timed out."),n(e,t)})}}),fermata.registerPlugin("statusCheck",function(t){return function(e,n){return t(e,function(e,t){e||"2"===t.status.toFixed(0)[0]||((e=Error("Bad status code from server: "+t.status)).status=t.status),n(e,t)})}}),fermata._nodeMultipartEncode=function(e){var n=""+Math.round(1e16*Math.random())+Math.round(1e16*Math.random());this.headers["Content-Type"]&&(this.headers["Content-Type"]+="; boundary="+n);var r=new Buffer(0);function a(e){var t=r,n=e instanceof Buffer?e:new Buffer(""+e);r=new Buffer(t.length+n.length+2),t.copy(r),n.copy(r,t.length),r.write("\r\n",r.length-2)}function o(e){return'"'+e.replace(/"|"/g,"%22").replace(/\r\n|\r|\n/g," ")+'"'}return fermata._flatten(e).forEach(function(e){if(a("--"+n),{}.hasOwnProperty.call(e[1],"data")){var t=e[1];a("Content-Disposition: form-data; name="+o(e[0])+"; filename="+o(t.name||"blob")),a("Content-Type: "+(t.type||"application/octet-stream")),a(""),a(t.data)}else a("Content-Disposition: form-data; name="+o(e[0])),a(""),a(e[1])}),a("--"+n+"--"),r},fermata._xhrMultipartEncode=function(e){var t=new FormData;return fermata._flatten(e).forEach(function(e){t.append(e[0],e[1])}),t},fermata._isStream=function(e){return fermata._transport===fermata._nodeTransport&&e instanceof require("stream").Readable},fermata.registerPlugin("autoConvert",function(n,r){var f={"text/plain":[function(e){return""+e},function(e){return""+e}],"application/json":[JSON.stringify,JSON.parse],"application/x-www-form-urlencoded":[function(e){return fermata._flatten(e).map(function(e){return encodeURIComponent(e[0]).replace(/%20/g,"+")+"="+encodeURIComponent(e[1]).replace(/%20/g,"+")}).join("&")},function(e){return fermata._unflatten(e.toString().split("&").map(function(e){return e.split("=").map(function(e){return decodeURIComponent(e.replace(/\+/g," "))})}))}],"multipart/form-data":[fermata._transport===fermata._xhrTransport?fermata._xhrMultipartEncode:fermata._nodeMultipartEncode,null]};return function(u,s){r&&("GET"!==u.method&&"HEAD"!==u.method&&(u.headers["Content-Type"]||(u.headers["Content-Type"]=r)),u.headers.Accept||(u.headers.Accept=r));var e=u.headers["Content-Type"],t=(f[e]||[])[0];return t&&!fermata._isStream(u.data)&&(u.data=u.data&&t.call(u,u.data)),n(u,function(t,e){var n=u.headers.Accept,r=e&&e.headers["Content-Type"],a=(f[n]||f[r]||[])[1],o=e&&e.data,i=e&&fermata._extend({"X-Status-Code":e.status},e.headers);if(e&&204===e.status)o=null;else if("stream"!==u.options.responseType&&a)try{o=a.call(e,o)}catch(e){t=t||e}s(t,o,i)})}}),fermata.registerPlugin("json",function(e,t){return this.base=t,e.using("timeout").using("statusCheck").using("autoConvert","application/json")}),fermata.registerPlugin("api",function(e,t){var n=t.url.replace(/\/$/,"");return t.user&&(n=n.replace(/\/\/(\w)/,"//"+t.user+":PASSWORD@$1")),console&&console.warn&&console.warn('Using deprecated API: please initialize with `fermata.json("'+n+'")` instead. This plugin will be disabled soon!'),this.base=n,e.using("statusCheck").using("autoConvert","application/json")});