"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _messageformatFormatters=_interopRequireDefault(require("messageformat-formatters")),_compiler=_interopRequireDefault(require("./compiler")),_utils=require("./utils"),_plurals=require("./plurals"),_runtime=_interopRequireDefault(require("./runtime"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}class MessageFormat{static escape(t,e){const r=e?/[#{}]/g:/[{}]/g;return String(t).replace(r,"'$&'")}constructor(t,e){if(this.options=Object.assign({biDiSupport:!1,customFormatters:null,pluralKeyChecks:!0,strictNumberSign:!1},e),this.pluralFuncs={},"string"==typeof t)this.pluralFuncs[t]=(0,_plurals.getPlural)(t,this.options),this.defaultLocale=t;else if(Array.isArray(t))t.forEach(t=>{this.pluralFuncs[t]=(0,_plurals.getPlural)(t,this.options)}),this.defaultLocale=t[0];else{if(t){const e=Object.keys(t);for(let r=0;r<e.length;++r){const s=e[r];if("function"!=typeof t[s]){const t="Expected function value for locale "+String(s);throw new Error(t)}this.pluralFuncs[s]=t[s],this.defaultLocale||(this.defaultLocale=s)}}this.defaultLocale?this.hasCustomPluralFuncs=!0:(this.defaultLocale=MessageFormat.defaultLocale,this.hasCustomPluralFuncs=!1)}this.fmt=Object.assign({},this.options.customFormatters),this.runtime=new _runtime.default(this)}addFormatters(t){const e=Object.keys(t);for(let r=0;r<e.length;++r){const s=e[r];this.fmt[s]=t[s]}return this}disablePluralKeyChecks(){this.options.pluralKeyChecks=!1;for(const t in this.pluralFuncs){const e=this.pluralFuncs[t];e&&(e.cardinal=[],e.ordinal=[])}return this}setBiDiSupport(t){return this.options.biDiSupport=!!t||void 0===t,this}setStrictNumberSign(t){return this.options.strictNumberSign=!!t||void 0===t,this.runtime.setStrictNumber(this.options.strictNumberSign),this}compile(t,e){let r={};if(0===Object.keys(this.pluralFuncs).length)if(e){const t=(0,_plurals.getPlural)(e,this.options);if(!t){const t=JSON.stringify(e);throw new Error(`Locale ${t} not found!`)}r[e]=t}else e=this.defaultLocale,r=(0,_plurals.getAllPlurals)(this.options);else if(e){const t=this.pluralFuncs[e];if(!t){const t=JSON.stringify(e),r=JSON.stringify(this.pluralFuncs);throw new Error(`Locale ${t} not found in ${r}!`)}r[e]=t}else e=this.defaultLocale,r=this.pluralFuncs;const s=new _compiler.default(this),i=s.compile(t,e,r);if("object"!=typeof t){const t=new Function("number, plural, select, fmt",(0,_utils.funcname)(e),"return "+i),s=this.runtime;return t(s.number,s.plural,s.select,this.fmt,r[e])}const o=this.runtime.toString(r,s)+"\n",n=function t(e,r){if(r||(r=0),"object"!=typeof e)return e;let s="";for(let t=0;t<r;++t)s+="  ";const i=[];for(const o in e){const n=t(e[o],r+1);i.push(`\n${s}  ${(0,_utils.propname)(o)}: ${n}`)}return`{${i.join(",")}\n${s}}`}(i),l=new Function(o+"return "+n)();if(l.hasOwnProperty("toString"))throw new Error("The top-level message key `toString` is reserved");return l.toString=function(t){return t&&"export default"!==t?t.indexOf(".")>-1?o+t+" = "+n:o+["(function (root, G) {",'  if (typeof define === "function" && define.amd) { define(G); }','  else if (typeof exports === "object") { module.exports = G; }',"  else { "+(0,_utils.propname)(t,"root")+" = G; }","})(this, "+n+");"].join("\n"):o+"export default "+n},l}}exports.default=MessageFormat,MessageFormat.defaultLocale="en",MessageFormat.formatters=_messageformatFormatters.default;