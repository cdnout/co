!function(e){"function"==typeof define&&define.amd?define(["jquery","./core","./transition"],e):e(jQuery,Formstone)}(function(s,t){"use strict";function e(){($=P.scrollTop()+t.windowHeight)<0&&($=0),w.iterate.call(C,f)}function o(){Y=s(g.base),C=s(g.lazy),w.iterate.call(C,r)}function i(e){var o;e.visible&&(o=e.source,e.source=null,a(e,o,!0))}function a(e,o,i){if(o!==e.source&&e.visible){e.source=o,e.responsive=!1,e.isYouTube=!1,"object"!=typeof o||"string"!=typeof o.video||(t=o.video.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/i))&&1<=t.length&&(e.isYouTube=!0,e.videoId=t[1]);var t=!e.isYouTube&&"object"==typeof o&&(o.hasOwnProperty("mp4")||o.hasOwnProperty("ogg")||o.hasOwnProperty("webm"));if(e.video=e.isYouTube||t,e.playing=!1,e.isYouTube)e.playerReady=!1,e.posterLoaded=!1,l(e,o,i);else if("object"==typeof o&&o.hasOwnProperty("poster"))!function(o,e){o.source&&o.source.poster&&(u(o,o.source.poster,!0,!0),e=!1);e='<div class="'+[m.media,m.video,!0!==e?m.animated:""].join(" ")+'" aria-hidden="true">';e+="<video playsinline",o.loop&&(e+=" loop");o.mute&&(e+=" muted");o.autoPlay&&(e+=" autoplay");e+=">",o.source.webm&&(e+='<source src="'+o.source.webm+'" type="video/webm" />');o.source.mp4&&(e+='<source src="'+o.source.mp4+'" type="video/mp4" />');o.source.ogg&&(e+='<source src="'+o.source.ogg+'" type="video/ogg" />');e+="</video>";var i=s(e+="</div>");i.find("video").one(b.loadedMetaData,function(e){i.fsTransition({property:"opacity"},function(){c(o)}).css({opacity:1}),h(o),o.$el.trigger(b.loaded),o.autoPlay&&y(o)}),o.$container.append(i)}(e,i);else{t=o;if("object"==typeof o){var a,n=[],r=[];for(a in o)o.hasOwnProperty(a)&&r.push(a);for(a in r.sort(w.sortAsc),r)r.hasOwnProperty(a)&&n.push({width:parseInt(r[a]),url:o[r[a]],mq:T.matchMedia("(min-width: "+parseInt(r[a])+"px)")});e.responsive=!0,e.sources=n,t=d(e)}u(e,t,!1,i)}}else e.$el.trigger(b.loaded)}function d(e){var o=e.source;if(e.responsive)for(var i in o=e.sources[0].url,e.sources)e.sources.hasOwnProperty(i)&&(t.support.matchMedia?e.sources[i].mq.matches&&(o=e.sources[i].url):e.sources[i].width<t.fallbackWidth&&(o=e.sources[i].url));return o}function u(e,o,i,t){var a=[m.media,m.image,!0!==t?m.animated:""].join(" "),n=s('<div class="'+a+'" aria-hidden="true"><img alt="'+e.alt+'"></div>'),a=n.find("img"),r=o;a.one(b.load,function(){j&&n.addClass(m.native).css({backgroundImage:"url('"+r+"')"}),n.fsTransition({property:"opacity"},function(){i||c(e)}).css({opacity:1}),h(e),i&&!t||e.$el.trigger(b.loaded)}).one(b.error,e,p).attr("src",r),e.responsive&&n.addClass(m.responsive),e.$container.append(n),!a[0].complete&&4!==a[0].readyState||a.trigger(b.load),e.currentSource=r}function l(o,e,i){var t,a;o.videoId||(t=e.match(/^.*(?:youtu.be\/|v\/|e\/|u\/\w+\/|embed\/|v=)([^#\&\?]*).*/),o.videoId=t[1]),o.posterLoaded||(o.source.poster||(o.source.poster="//img.youtube.com/vi/"+o.videoId+"/0.jpg"),o.posterLoaded=!0,u(o,o.source.poster,!0,i),i=!1),s("script[src*='youtube.com/iframe_api']").length||s("head").append('<script src="//www.youtube.com/iframe_api"><\/script>'),I?(t=o.guid+"_"+o.youTubeGuid++,i='<div class="'+[m.media,m.embed,!0!==i?m.animated:""].join(" ")+'" aria-hidden="true">',i+='<div id="'+t+'"></div>',a=s(i+="</div>"),(i=s.extend(!0,{},{controls:0,rel:0,showinfo:0,wmode:"transparent",enablejsapi:1,version:3,playerapiid:t,loop:o.loop?1:0,autoplay:1,mute:1,origin:T.location.protocol+"//"+T.location.host},o.youtubeOptions)).autoplay=1,o.$container.append(a),o.player&&(o.oldPlayer=o.player,o.player=null),o.player=new T.YT.Player(t,{videoId:o.videoId,playerVars:i,events:{onReady:function(e){o.playerReady=!0,o.mute&&o.player.mute(),o.autoPlay?o.player.playVideo():o.player.pauseVideo()},onStateChange:function(e){o.playing||e.data!==T.YT.PlayerState.PLAYING?o.loop&&o.playing&&e.data===T.YT.PlayerState.ENDED&&o.player.playVideo():(o.playing=!0,a.fsTransition({property:"opacity"},function(){c(o)}).css({opacity:1}),h(o),o.$el.trigger(b.loaded)),o.$el.find(g.embed).addClass(m.ready)},onPlaybackQualityChange:function(e){},onPlaybackRateChange:function(e){},onError:function(e){p({data:o})},onApiChange:function(e){}}}),h(o)):R.push({data:o,source:e})}function c(e){var o=e.$container.find(g.media);1<=o.length&&(o.not(":last").remove(),e.oldPlayer=null)}function p(e){e.data.$el.trigger(b.error)}function y(e){var o;e.video&&!e.playing&&(e.isYouTube?e.playerReady?e.player.playVideo():e.autoPlay=!0:((o=e.$container.find("video")).length&&o[0].play(),e.playing=!0))}function n(e){var o;e.visible&&(e.responsive&&(o=d(e))!==e.currentSource?u(e,o,!1,!0):h(e))}function h(e){for(var o=e.$container.find(g.media),i=0,t=o.length;i<t;i++){var a,n=o.eq(i),r=e.isYouTube?"iframe":n.find("video").length?"video":"img",s=n.find(r);!s.length||"img"==r&&j||(a=e.$el.outerWidth(),r=e.$el.outerHeight(),s=function(e,o){{if(e.isYouTube)return{height:500,width:500/e.embedRatio};if(o.is("img")){var i=o[0];if(void 0!==i.naturalHeight)return{height:i.naturalHeight,width:i.naturalWidth};e=new Image;return e.src=i.src,{height:e.height,width:e.width}}return{height:o[0].videoHeight,width:o[0].videoWidth}}}(e,s),e.width=s.width,e.height=s.height,e.left=0,e.top=0,s=e.isYouTube?e.embedRatio:e.width/e.height,e.height=r,e.width=e.height*s,e.width<a&&(e.width=a,e.height=e.width/s),e.left=-(e.width-a)/2,e.top=-(e.height-r)/2,n.css({height:e.height,width:e.width,left:e.left,top:e.top}))}}function r(e){e.scrollTop=e.$el.offset().top}function f(e){!e.visible&&e.scrollTop<$+e.lazyEdge&&(e.visible=!0,i(e))}var v=t.Plugin("background",{widget:!0,defaults:{alt:"",autoPlay:!0,customClass:"",embedRatio:1.777777,lazy:!1,lazyEdge:100,loop:!0,mute:!0,source:null,youtubeOptions:{}},classes:["container","media","animated","responsive","native","fixed","ready","lazy"],events:{loaded:"loaded",ready:"ready",loadedMetaData:"loadedmetadata"},methods:{_construct:function(e){e.youTubeGuid=0,e.$container=s('<div class="'+m.container+'"></div>').appendTo(this),e.thisClasses=[m.base,e.customClass],e.visible=!0,e.lazy&&(e.visible=!1,e.thisClasses.push(m.lazy)),this.addClass(e.thisClasses.join(" ")),o(),e.lazy?(r(e),f(e)):i(e)},_destruct:function(e){e.$container.remove(),this.removeClass(e.thisClasses.join(" ")).off(b.namespace),o()},_resize:function(){w.iterate.call(Y,n),w.iterate.call(C,r),w.iterate.call(C,f)},play:y,pause:function(e){var o;e.video&&e.playing&&(e.isYouTube?e.playerReady?e.player.pauseVideo():e.autoPlay=!1:(o=e.$container.find("video")).length&&o[0].pause(),e.playing=!1)},mute:function(e){var o;e.video&&(e.isYouTube&&e.playerReady?e.player.mute():(o=e.$container.find("video")).length&&(o[0].muted=!0)),e.mute=!0},unmute:function(e){var o;e.video&&(e.isYouTube&&e.playerReady?e.player.unMute():(o=e.$container.find("video")).length&&(o[0].muted=!1),e.playing=!0),e.mute=!1},resize:h,load:a,unload:function(e){var o=e.$container.find(g.media);1<=o.length&&o.fsTransition({property:"opacity"},function(){o.remove(),delete e.source}).css({opacity:0})}}}),g=v.classes,m=g.raw,b=v.events,w=v.functions,T=t.window,P=t.$window,$=0,Y=[],C=[],j="backgroundSize"in t.document.documentElement.style,I=!1,R=[];t.Ready(function(){e(),P.on("scroll",e)}),T.onYouTubeIframeAPIReady=function(){for(var e in I=!0,R)R.hasOwnProperty(e)&&l(R[e].data,R[e].source);R=[]}});