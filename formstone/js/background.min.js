!function(e){"function"==typeof define&&define.amd?define(["jquery","./core","./transition"],e):e(jQuery,Formstone)}(function(d,t){"use strict";function e(){($=P.scrollTop()+t.windowHeight)<0&&($=0),w.iterate.call(C,f)}function i(){Y=d(g.base),C=d(g.lazy),w.iterate.call(C,r)}function o(e){var i;e.visible&&(i=e.source,e.source=null,a(e,i,!0))}function a(e,i,o){if(i!==e.source&&e.visible){e.source=i,e.responsive=!1,e.isYouTube=!1,"object"!==d.type(i)||"string"!==d.type(i.video)||(t=i.video.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/i))&&1<=t.length&&(e.isYouTube=!0,e.videoId=t[1]);var t=!e.isYouTube&&"object"===d.type(i)&&(i.hasOwnProperty("mp4")||i.hasOwnProperty("ogg")||i.hasOwnProperty("webm"));if(e.video=e.isYouTube||t,e.playing=!1,e.isYouTube)e.playerReady=!1,e.posterLoaded=!1,l(e,i,o);else if("object"===d.type(i)&&i.hasOwnProperty("poster"))!function(i,e){i.source&&i.source.poster&&(u(i,i.source.poster,!0,!0),e=!1);e='<div class="'+[m.media,m.video,!0!==e?m.animated:""].join(" ")+'" aria-hidden="true">';e+="<video playsinline",i.loop&&(e+=" loop");i.mute&&(e+=" muted");i.autoPlay&&(e+=" autoplay");e+=">",i.source.webm&&(e+='<source src="'+i.source.webm+'" type="video/webm" />');i.source.mp4&&(e+='<source src="'+i.source.mp4+'" type="video/mp4" />');i.source.ogg&&(e+='<source src="'+i.source.ogg+'" type="video/ogg" />');e+="</video>";var o=d(e+="</div>");o.find("video").one(b.loadedMetaData,function(e){o.fsTransition({property:"opacity"},function(){c(i)}).css({opacity:1}),h(i),i.$el.trigger(b.loaded),i.autoPlay&&y(i)}),i.$container.append(o)}(e,o);else{t=i;if("object"===d.type(i)){var a,n=[],r=[];for(a in i)i.hasOwnProperty(a)&&r.push(a);for(a in r.sort(w.sortAsc),r)r.hasOwnProperty(a)&&n.push({width:parseInt(r[a]),url:i[r[a]],mq:T.matchMedia("(min-width: "+parseInt(r[a])+"px)")});e.responsive=!0,e.sources=n,t=s(e)}u(e,t,!1,o)}}else e.$el.trigger(b.loaded)}function s(e){var i=e.source;if(e.responsive)for(var o in i=e.sources[0].url,e.sources)e.sources.hasOwnProperty(o)&&(t.support.matchMedia?e.sources[o].mq.matches&&(i=e.sources[o].url):e.sources[o].width<t.fallbackWidth&&(i=e.sources[o].url));return i}function u(e,i,o,t){var a=[m.media,m.image,!0!==t?m.animated:""].join(" "),n=d('<div class="'+a+'" aria-hidden="true"><img alt="'+e.alt+'"></div>'),a=n.find("img"),r=i;a.one(b.load,function(){j&&n.addClass(m.native).css({backgroundImage:"url('"+r+"')"}),n.fsTransition({property:"opacity"},function(){o||c(e)}).css({opacity:1}),h(e),o&&!t||e.$el.trigger(b.loaded)}).one(b.error,e,p).attr("src",r),e.responsive&&n.addClass(m.responsive),e.$container.append(n),!a[0].complete&&4!==a[0].readyState||a.trigger(b.load),e.currentSource=r}function l(i,e,o){var t,a;i.videoId||(t=e.match(/^.*(?:youtu.be\/|v\/|e\/|u\/\w+\/|embed\/|v=)([^#\&\?]*).*/),i.videoId=t[1]),i.posterLoaded||(i.source.poster||(i.source.poster="//img.youtube.com/vi/"+i.videoId+"/0.jpg"),i.posterLoaded=!0,u(i,i.source.poster,!0,o),o=!1),d("script[src*='youtube.com/iframe_api']").length||d("head").append('<script src="//www.youtube.com/iframe_api"><\/script>'),I?(t=i.guid+"_"+i.youTubeGuid++,o='<div class="'+[m.media,m.embed,!0!==o?m.animated:""].join(" ")+'" aria-hidden="true">',o+='<div id="'+t+'"></div>',a=d(o+="</div>"),(o=d.extend(!0,{},{controls:0,rel:0,showinfo:0,wmode:"transparent",enablejsapi:1,version:3,playerapiid:t,loop:i.loop?1:0,autoplay:1,mute:1,origin:T.location.protocol+"//"+T.location.host},i.youtubeOptions)).autoplay=1,i.$container.append(a),i.player&&(i.oldPlayer=i.player,i.player=null),i.player=new T.YT.Player(t,{videoId:i.videoId,playerVars:o,events:{onReady:function(e){i.playerReady=!0,i.mute&&i.player.mute(),i.autoPlay?i.player.playVideo():i.player.pauseVideo()},onStateChange:function(e){i.playing||e.data!==T.YT.PlayerState.PLAYING?i.loop&&i.playing&&e.data===T.YT.PlayerState.ENDED&&i.player.playVideo():(i.playing=!0,a.fsTransition({property:"opacity"},function(){c(i)}).css({opacity:1}),h(i),i.$el.trigger(b.loaded)),i.$el.find(g.embed).addClass(m.ready)},onPlaybackQualityChange:function(e){},onPlaybackRateChange:function(e){},onError:function(e){p({data:i})},onApiChange:function(e){}}}),h(i)):R.push({data:i,source:e})}function c(e){var i=e.$container.find(g.media);1<=i.length&&(i.not(":last").remove(),e.oldPlayer=null)}function p(e){e.data.$el.trigger(b.error)}function y(e){var i;e.video&&!e.playing&&(e.isYouTube?e.playerReady?e.player.playVideo():e.autoPlay=!0:((i=e.$container.find("video")).length&&i[0].play(),e.playing=!0))}function n(e){var i;e.visible&&(e.responsive&&(i=s(e))!==e.currentSource?u(e,i,!1,!0):h(e))}function h(e){for(var i=e.$container.find(g.media),o=0,t=i.length;o<t;o++){var a,n=i.eq(o),r=e.isYouTube?"iframe":n.find("video").length?"video":"img",s=n.find(r);!s.length||"img"==r&&j||(a=e.$el.outerWidth(),r=e.$el.outerHeight(),s=function(e,i){{if(e.isYouTube)return{height:500,width:500/e.embedRatio};if(i.is("img")){var o=i[0];if("undefined"!==d.type(o.naturalHeight))return{height:o.naturalHeight,width:o.naturalWidth};e=new Image;return e.src=o.src,{height:e.height,width:e.width}}return{height:i[0].videoHeight,width:i[0].videoWidth}}}(e,s),e.width=s.width,e.height=s.height,e.left=0,e.top=0,s=e.isYouTube?e.embedRatio:e.width/e.height,e.height=r,e.width=e.height*s,e.width<a&&(e.width=a,e.height=e.width/s),e.left=-(e.width-a)/2,e.top=-(e.height-r)/2,n.css({height:e.height,width:e.width,left:e.left,top:e.top}))}}function r(e){e.scrollTop=e.$el.offset().top}function f(e){!e.visible&&e.scrollTop<$+e.lazyEdge&&(e.visible=!0,o(e))}var v=t.Plugin("background",{widget:!0,defaults:{alt:"",autoPlay:!0,customClass:"",embedRatio:1.777777,lazy:!1,lazyEdge:100,loop:!0,mute:!0,source:null,youtubeOptions:{}},classes:["container","media","animated","responsive","native","fixed","ready","lazy"],events:{loaded:"loaded",ready:"ready",loadedMetaData:"loadedmetadata"},methods:{_construct:function(e){e.youTubeGuid=0,e.$container=d('<div class="'+m.container+'"></div>').appendTo(this),e.thisClasses=[m.base,e.customClass],e.visible=!0,e.lazy&&(e.visible=!1,e.thisClasses.push(m.lazy)),this.addClass(e.thisClasses.join(" ")),i(),e.lazy?(r(e),f(e)):o(e)},_destruct:function(e){e.$container.remove(),this.removeClass(e.thisClasses.join(" ")).off(b.namespace),i()},_resize:function(){w.iterate.call(Y,n),w.iterate.call(C,r),w.iterate.call(C,f)},play:y,pause:function(e){var i;e.video&&e.playing&&(e.isYouTube?e.playerReady?e.player.pauseVideo():e.autoPlay=!1:(i=e.$container.find("video")).length&&i[0].pause(),e.playing=!1)},mute:function(e){var i;e.video&&(e.isYouTube&&e.playerReady?e.player.mute():(i=e.$container.find("video")).length&&(i[0].muted=!0)),e.mute=!0},unmute:function(e){var i;e.video&&(e.isYouTube&&e.playerReady?e.player.unMute():(i=e.$container.find("video")).length&&(i[0].muted=!1),e.playing=!0),e.mute=!1},resize:h,load:a,unload:function(e){var i=e.$container.find(g.media);1<=i.length&&i.fsTransition({property:"opacity"},function(){i.remove(),delete e.source}).css({opacity:0})}}}),g=v.classes,m=g.raw,b=v.events,w=v.functions,T=t.window,P=t.$window,$=0,Y=[],C=[],j="backgroundSize"in t.document.documentElement.style,I=!1,R=[];t.Ready(function(){e(),P.on("scroll",e)}),T.onYouTubeIframeAPIReady=function(){for(var e in I=!0,R)R.hasOwnProperty(e)&&l(R[e].data,R[e].source);R=[]}});