!function(e){"function"==typeof define&&define.amd?define(["jquery","./core","./scrollbar","./touch"],e):e(jQuery,Formstone)}(function(r,p){"use strict";function c(e){for(var t="",l=0,i=e.$allOptions.length;l<i;l++){var s,o,d,a=e.$allOptions.eq(l),n=[];"OPTGROUP"===a[0].tagName?(n.push(g.group),a.prop("disabled")&&n.push(g.disabled),t+='<span class="'+n.join(" ")+'">'+a.attr("label")+"</span>"):(s=a.val(),o=a.data("label"),d=e.links?"a":'button type="button"',a.attr("value")||a.attr("value",s),n.push(g.item),a.hasClass(g.item_placeholder)&&(n.push(g.item_placeholder),d="span"),a.prop("selected")&&n.push(g.item_selected),a.prop("disabled")&&n.push(g.item_disabled),t+="<"+d+' class="'+n.join(" ")+'"',e.links?"span"===d?t+=' aria-hidden="true"':(t+=' href="'+s+'"',e.external&&(t+=' target="_blank"')):t+=' data-value="'+s+'"',t+=' role="option"',a.prop("selected")&&(t+=' "aria-selected"="true"'),t+=">",t+=o||I.decodeEntities(x(a.text(),e.trim)),t+="</"+d+">",0)}e.$items=e.$wrapper.html(r.parseHTML(t)).find(w.item)}function u(e){I.killEvent(e);e=e.data;e.disabled||e.useNative||(e.closed?l:o)(e),t(e)}function t(e){r(w.base).not(e.$dropdown).trigger(C.close,[e])}function l(e){var t,l;e.closed&&(t=k.height(),l=e.$wrapper.outerHeight(!0),e.$dropdown[0].getBoundingClientRect().bottom+l>t-e.bottomEdge&&e.$dropdown.addClass(g.bottom),_.on(C.click+e.dotGuid,":not("+w.options+")",e,i),e.$dropdown.trigger(C.focusIn),e.$dropdown.addClass(g.open),d(e),e.closed=!1)}function o(e){e&&!e.closed&&(_.off(C.click+e.dotGuid),e.$dropdown.removeClass([g.open,g.bottom].join(" ")),e.closed=!0)}function i(e){I.killEvent(e);var t=e.data;t&&0===r(e.currentTarget).parents(w.base).length&&(o(t),t.$dropdown.trigger(C.focusOut))}function f(e){e=e.data;e&&(o(e),e.$dropdown.trigger(C.focusOut))}function m(e){var t=r(this),l=e.data;I.killEvent(e),l.disabled||(t=l.$items.index(t),l.focusIndex=t,l.$wrapper.is(":visible")&&(v(t,l,e.shiftKey,e.metaKey||e.ctrlKey),a(l)),l.multiple||o(l),l.$dropdown.trigger(C.focus))}function b(e,t){r(this);e=e.data;t||e.multiple||(t=e.$options.index(e.$options.filter(":selected")),v(e.focusIndex=t,e),a(e,!0))}function $(e){I.killEvent(e);r(e.currentTarget);e=e.data;e.disabled||e.multiple||e.focused||(t(e),e.focused=!0,e.focusIndex=e.index,e.input="",e.$dropdown.addClass(g.focus).on(C.keyDown+e.dotGuid,e,s))}function h(e){I.killEvent(e);r(e.currentTarget);e=e.data;e.focused&&e.closed&&(e.focused=!1,e.$dropdown.removeClass(g.focus).off(C.keyDown+e.dotGuid),e.multiple||(o(e),e.index!==e.focusIndex&&(a(e),e.focusIndex=e.index)))}function s(e){var t=e.data;if(t.keyTimer=I.startTimer(t.keyTimer,1e3,function(){t.input=""}),13===e.keyCode)t.closed||(o(t),v(t.index,t)),a(t);else if(!(9===e.keyCode||e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)){I.killEvent(e);var l=t.$items.length-1,i=t.index<0?0:t.index;if(-1<r.inArray(e.keyCode,p.isFirefox?[38,40,37,39]:[38,40]))(i+=38===e.keyCode||p.isFirefox&&37===e.keyCode?-1:1)<0&&(i=0),l<i&&(i=l);else{var s,e=String.fromCharCode(e.keyCode).toUpperCase();for(t.input+=e,s=t.index+1;s<=l;s++)if(t.$options.eq(s).text().substr(0,t.input.length).toUpperCase()===t.input){i=s;break}if(i<0||i===t.index)for(s=0;s<=l;s++)if(t.$options.eq(s).text().substr(0,t.input.length).toUpperCase()===t.input){i=s;break}}0<=i&&(v(i,t),d(t))}}function v(e,t,l,i){var s,o=t.$items.eq(e),d=t.$options.eq(e),a=o.hasClass(g.item_selected);o.hasClass(g.item_disabled)||(t.multiple?t.useNative?a?(d.prop("selected",null).attr("aria-selected",null),o.removeClass(g.item_selected)):(d.prop("selected",!0).attr("aria-selected",!0),o.addClass(g.item_selected)):l&&!1!==t.lastIndex?(s=t.lastIndex>e?e:t.lastIndex,l=(t.lastIndex>e?t.lastIndex:e)+1,t.$options.prop("selected",null).attr("aria-selected",null),t.$items.filter(w.item_selected).removeClass(g.item_selected),t.$options.slice(s,l).not("[disabled]").prop("selected",!0),t.$items.slice(s,l).not(w.item_disabled).addClass(g.item_selected)):(i||t.selectMultiple?a?(d.prop("selected",null).attr("aria-selected",null),o.removeClass(g.item_selected)):(d.prop("selected",!0).attr("aria-selected",!0),o.addClass(g.item_selected)):(t.$options.prop("selected",null).attr("aria-selected",null),t.$items.filter(w.item_selected).removeClass(g.item_selected),d.prop("selected",!0).attr("aria-selected",!0),o.addClass(g.item_selected)),t.lastIndex=e):-1<e&&e<t.$items.length?e!==t.index&&(d=d.data("label")||o.html(),t.$selected.html(d).removeClass(w.item_placeholder),t.$items.filter(w.item_selected).removeClass(g.item_selected),t.$el[0].selectedIndex=e,o.addClass(g.item_selected),t.index=e):""!==t.label&&t.$selected.html(t.label))}function d(e){var t=e.$items.eq(e.index),l=0<=e.index&&!t.hasClass(g.item_placeholder)?t.position():{left:0,top:0},t=(e.$wrapper.outerHeight()-t.outerHeight())/2;void 0!==r.fn.fsScrollbar?e.$wrapper.fsScrollbar("resize").fsScrollbar("scroll",e.$wrapper.find(".fs-scrollbar-content").scrollTop()+l.top):e.$wrapper.scrollTop(e.$wrapper.scrollTop()+l.top-t)}function a(e,t){var l,i;e.links?(i=(l=e).$el.val(),l.external?n.open(i):n.location.href=i):t||e.$el.trigger(C.raw.change,[!0])}function x(e,t){return 0!==t&&e.length>t?e.substring(0,t)+"...":e}var e=p.Plugin("dropdown",{widget:!0,defaults:{bottomEdge:0,cover:!1,customClass:"",label:"",external:!1,links:!1,mobile:!1,native:!1,theme:"fs-light",trim:0,selectMultiple:!1},methods:{_construct:function(e){e.multiple=this.prop("multiple"),e.disabled=this.prop("disabled")||this.is("[readonly]"),e.lastIndex=!1,e.native=e.mobile||e.native,e.useNative=e.native||p.isMobile,e.multiple?e.links=!1:e.external&&(e.links=!0);var t=this.find("[selected]").not(":disabled"),l=this.find(":selected").not(":disabled"),i=l.text(),s=this.find("option").index(l);e.multiple||""===e.label||t.length?e.label="":(l=this.prepend('<option value="" class="'+g.item_placeholder+'" selected>'+e.label+"</option>"),i=e.label,s=0);var o=this.find("option, optgroup"),d=o.filter("option"),a=r('[for="'+this.attr("id")+'"]');e.tabIndex=this[0].tabIndex,this[0].tabIndex=-1,a.length&&(a[0].tabIndex=-1);var n=[g.base,e.theme,e.customClass];e.useNative?n.push(g.native):e.cover&&n.push(g.cover),e.multiple&&n.push(g.multiple),e.disabled&&n.push(g.disabled),e.id=this.attr("id"),e.id?e.ariaId=e.id:e.ariaId=e.rawGuid,e.ariaId+="-dropdown",e.selectedAriaId=e.ariaId+"-selected",l=t="",t+='<div class="'+n.join(" ")+'"id="'+e.ariaId+'" tabindex="'+e.tabIndex+'" role="listbox"',e.multiple?t+=' aria-label="multi select"':t+=' aria-haspopup="true" aria-live="polite" aria-labelledby="'+e.selectedAriaId+'"',t+="></div>",e.multiple||(l+='<button type="button" class="'+g.selected+'" id="'+e.selectedAriaId+'" tabindex="-1">',l+=r("<span></span>").text(x(i,e.trim)).html(),l+="</button>"),l+='<div class="'+g.options+'">',l+="</div>",this.wrap(t).after(l),e.$dropdown=this.parent(w.base),e.$label=a,e.$allOptions=o,e.$options=d,e.$selected=e.$dropdown.find(w.selected),e.$wrapper=e.$dropdown.find(w.options),e.$placeholder=e.$dropdown.find(w.placeholder),e.index=-1,e.closed=!0,e.focused=!1,c(e),e.multiple||v(s,e),void 0!==r.fn.fsScrollbar&&e.$wrapper.fsScrollbar({theme:e.theme}).find(".fs-scrollbar-content").attr("tabindex",null),e.$dropdown.on(C.click,e,u),e.$selected.on(C.click,e,u),e.$dropdown.on(C.click,w.item,e,m).on(C.close,e,f),this.on(C.change,e,b),e.useNative||(this.on(C.focusIn,e,function(e){e.data.$dropdown.trigger(C.raw.focus)}),e.$dropdown.on(C.focusIn,e,$).on(C.focusOut,e,h))},_destruct:function(e){e.$dropdown.hasClass(g.open)&&e.$selected.trigger(C.click),void 0!==r.fn.fsScrollbar&&e.$wrapper.fsScrollbar("destroy"),e.$el[0].tabIndex=e.tabIndex,e.$label.length&&(e.$label[0].tabIndex=e.tabIndex),e.$dropdown.off(C.namespace),e.$options.off(C.namespace),e.$placeholder.remove(),e.$selected.remove(),e.$wrapper.remove(),e.$el.off(C.namespace).show().unwrap()},disable:function(e,t){void 0!==t?(t=e.$items.index(e.$items.filter("[data-value="+t+"]")),e.$items.eq(t).addClass(g.item_disabled),e.$options.eq(t).prop("disabled",!0)):(e.$dropdown.hasClass(g.open)&&e.$selected.trigger(C.click),e.$dropdown.addClass(g.disabled),e.$el.prop("disabled",!0),e.disabled=!0)},enable:function(e,t){void 0!==t?(t=e.$items.index(e.$items.filter("[data-value="+t+"]")),e.$items.eq(t).removeClass(g.item_disabled),e.$options.eq(t).prop("disabled",!1)):(e.$dropdown.removeClass(g.disabled),e.$el.prop("disabled",!1),e.disabled=!1)},update:function(e){void 0!==r.fn.fsScrollbar&&e.$wrapper.fsScrollbar("destroy");var t=e.index;e.$allOptions=e.$el.find("option, optgroup"),e.$options=e.$allOptions.filter("option"),e.index=-1,t=e.$options.index(e.$options.filter(":selected")),c(e),e.multiple||v(t,e),void 0!==r.fn.fsScrollbar&&e.$wrapper.fsScrollbar({theme:e.theme}).find(".fs-scrollbar-content").attr("tabindex",null)},open:l,close:o},classes:["cover","bottom","multiple","mobile","native","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{close:"close"}}),w=e.classes,g=w.raw,C=e.events,I=e.functions,n=p.window,k=p.$window,_=(p.document,null);p.Ready(function(){_=p.$body})});