!function(e){"function"==typeof define&&define.amd?define(["jquery","./core"],e):e(jQuery,Formstone)}(function(f,s){"use strict";function i(e){e.preventManipulation&&e.preventManipulation();var t=e.data,n=e.originalEvent;if(n.type.match(/(up|end|cancel)$/i))u(e);else{if(n.pointerId){var a,s=!1;for(a in t.touches)t.touches[a].id===n.pointerId&&(s=!0,t.touches[a].pageX=n.pageX,t.touches[a].pageY=n.pageY);s||t.touches.push({id:n.pointerId,pageX:n.pageX,pageY:n.pageY})}else t.touches=n.touches;n.type.match(/(down|start)$/i)?X(e):n.type.match(/move$/i)&&o(e)}}function X(e){var t=e.data,n="undefined"!==f.type(t.touches)&&t.touches.length?t.touches[0]:null;n&&t.$el.off(x.mouseDown),t.touching||(t.startE=e.originalEvent,t.startX=(n||e).pageX,t.startY=(n||e).pageY,t.startT=(new Date).getTime(),t.scaleD=1,t.passedAxis=!1),t.$links&&t.$links.off(x.click);var a=v(t.scale?x.scaleStart:x.panStart,e,t.startX,t.startY,t.scaleD,0,0,"","");t.scale&&t.touches&&2<=t.touches.length&&(e=t.touches,t.pinch={startX:h(e[0].pageX,e[1].pageX),startY:h(e[0].pageY,e[1].pageY),startD:l(e[1].pageX-e[0].pageX,e[1].pageY-e[0].pageY)},a.pageX=t.startX=t.pinch.startX,a.pageY=t.startY=t.pinch.startY),t.touching||(t.touching=!0,t.pan&&!n&&w.on(x.mouseMove,t,o).on(x.mouseUp,t,u),s.support.pointer?w.on([x.pointerMove,x.pointerUp,x.pointerCancel].join(" "),t,i):w.on([x.touchMove,x.touchEnd,x.touchCancel].join(" "),t,i),t.$el.trigger(a))}function o(e){var t=e.data,n="undefined"!==f.type(t.touches)&&t.touches.length?t.touches[0]:null,a=(n||e).pageX,s=(n||e).pageY,i=a-t.startX,o=s-t.startY,c=0<i?"right":"left",p=0<o?"down":"up",r=Math.abs(i)>t.threshold,n=Math.abs(o)>t.threshold;!t.passedAxis&&t.axis&&(t.axisX&&n||t.axisY&&r)?u(e):(!t.passedAxis&&(!t.axis||t.axis&&t.axisX&&r||t.axisY&&n)&&(t.passedAxis=!0),t.passedAxis&&(m.killEvent(e),m.killEvent(t.startE)),n=!0,c=v(t.scale?x.scale:x.pan,e,a,s,t.scaleD,i,o,c,p),t.scale&&(t.touches&&2<=t.touches.length?(p=t.touches,t.pinch.endX=h(p[0].pageX,p[1].pageX),t.pinch.endY=h(p[0].pageY,p[1].pageY),t.pinch.endD=l(p[1].pageX-p[0].pageX,p[1].pageY-p[0].pageY),t.scaleD=t.pinch.endD/t.pinch.startD,c.pageX=t.pinch.endX,c.pageY=t.pinch.endY,c.scale=t.scaleD,c.deltaX=t.pinch.endX-t.pinch.startX,c.deltaY=t.pinch.endY-t.pinch.startY):t.pan||(n=!1)),n&&t.$el.trigger(c))}function u(e){var t=e.data,n="undefined"!==f.type(t.touches)&&t.touches.length?t.touches[0]:null,a=(n||e).pageX,s=(n||e).pageY,i=a-t.startX,o=s-t.startY,c=(new Date).getTime(),p=t.scale?x.scaleEnd:x.panEnd,r=0<i?"right":"left",u=0<o?"down":"up",h=1<Math.abs(i),l=1<Math.abs(o);if(t.swipe&&c-t.startT<t.time&&Math.abs(i)>t.threshold&&(p=x.swipe),t.axis&&(t.axisX&&l||t.axisY&&h)||h||l){t.$links=t.$el.find("a");for(var d=0,g=t.$links.length;d<g;d++)!function(e,t){e.on(x.click,t,Y);e=f._data(e[0],"events").click;e.unshift(e.pop())}(t.$links.eq(d),t)}u=v(p,e,a,s,t.scaleD,i,o,r,u);w.off([x.touchMove,x.touchEnd,x.touchCancel,x.mouseMove,x.mouseUp,x.pointerMove,x.pointerUp,x.pointerCancel].join(" ")),t.$el.trigger(u),t.touches=[],t.scale,n&&(t.touchTimer=m.startTimer(t.touchTimer,5,function(){t.$el.on(x.mouseDown,t,X)})),t.touching=!1}function Y(e){m.killEvent(e,!0),e.data.$links.off(x.click)}function v(e,t,n,a,s,i,o,c,p){return f.Event(e,{originalEvent:t,bubbles:!0,pageX:n,pageY:a,scale:s,deltaX:i,deltaY:o,directionX:c,directionY:p})}function h(e,t){return(e+t)/2}function l(e,t){return Math.sqrt(e*e+t*t)}function n(e,t){e.css({"-ms-touch-action":t,"touch-action":t})}var e=!s.window.PointerEvent,e=s.Plugin("touch",{widget:!0,defaults:{axis:!1,pan:!1,scale:!1,swipe:!1,threshold:10,time:50},methods:{_construct:function(e){var t;e.touches=[],e.touching=!1,this.on(x.dragStart,m.killEvent),e.swipe&&(e.pan=!0),e.scale&&(e.axis=!1),e.axisX="x"===e.axis,e.axisY="y"===e.axis,s.support.pointer?(t="",!e.axis||e.axisX&&e.axisY?t="none":(e.axisX&&(t+=" pan-y"),e.axisY&&(t+=" pan-x")),n(this,t),this.on(x.pointerDown,e,i)):this.on(x.touchStart,e,i).on(x.mouseDown,e,X)},_destruct:function(e){this.off(x.namespace),n(this,"")}},events:{pointerDown:e?"MSPointerDown":"pointerdown",pointerUp:e?"MSPointerUp":"pointerup",pointerMove:e?"MSPointerMove":"pointermove",pointerCancel:e?"MSPointerCancel":"pointercancel"}}),x=e.events,m=e.functions,w=s.$window;x.pan="pan",x.panStart="panstart",x.panEnd="panend",x.scale="scale",x.scaleStart="scalestart",x.scaleEnd="scaleend",x.swipe="swipe"});