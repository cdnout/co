!function(e){"function"==typeof define&&define.amd?define(["jquery","./core","./analytics"],e):e(jQuery,Formstone)}(function(l,t){"use strict";function r(e){var t=e.currentTarget;1<e.which||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||window.location.protocol!==t.protocol||window.location.host!==t.host||"_blank"===t.target||t.hash&&(t.href.replace(t.hash,"")===window.location.href.replace(location.hash,"")||t.href===window.location.href+"#")||t.href.match(u.ignoreTypes)||(g.killEvent(e),e.stopImmediatePropagation(),t.href!==m&&o(t.href,!0))}function n(e){d&&d.abort();e=e.originalEvent.state;e&&(O=e.id,e.url!==m&&o(e.url,!1))}function o(n,e){d&&d.abort(),p.trigger(y.requested,[e]),u.transitionOutDeferred=u.transitionOut.apply(h,[!1]);var o=c(n),t=o.params,r=(o.hash,o.clean),i="User error",a=null,s=l.Deferred();t[u.requestKey]=!0,d=l.ajax({url:r,data:t,dataType:"json",cache:u.cache,xhr:function(){var e=new h.XMLHttpRequest;return e.addEventListener("progress",function(e){e.lengthComputable&&(e=e.loaded/e.total,p.trigger(y.progress,[e]))},!1),e},success:function(e,t,r){a="string"===l.type(e)?l.parseJSON(e):e,e.location&&(n=e.location,o=c(n),o.hash),s.resolve()},error:function(e,t,r){i=r,s.reject()}}),l.when(s,u.transitionOutDeferred).done(function(){!function(e,t,r){p.trigger(y.loaded,[t]),void 0!==l.fsAnalytics&&l.fsAnalytics("pageview");u.render.call(this,t,e.hash),m=e.url,r&&function(e,t){history.pushState({id:e,url:t},v+e,t)}(++O,m);p.trigger(y.rendered,[t]);t=!1;""===e.hash||(e=l(e.hash)).length&&(t=e.offset().top);!1!==t&&p.scrollTop(t)}(o,a,e)}).fail(function(){p.trigger(y.failed,[i])})}function i(e,t){var r,n;if("undefined"!==l.type(e))for(n in e)e.hasOwnProperty(n)&&(r=l(n)).length&&r.html(e[n])}function a(e,t){history.replaceState({id:e,url:t},v+e,t)}function c(e){var t=e.indexOf("?"),r=e.indexOf("#"),n={},o="",i=e;return-1<r&&(o=e.slice(r),i=e.slice(0,r)),-1<t&&(n=g.parseQueryString(e.slice(t+1,-1<r?r:e.length)),i=e.slice(0,t)),{hash:o,params:n,url:e,clean:i}}var s,d,u,e=t.Plugin("asap",{utilities:{_initialize:function(e){!u&&t.support.history&&(s=t.$body,(u=l.extend(f,e)).render===l.noop&&(u.render=i),u.transitionOut===l.noop&&(u.transitionOut=function(){return l.Deferred().resolve()}),history.state?(O=history.state.id,m=history.state.url):(m=window.location.href,a(O,m)),p.on(y.popState,n),s&&!s.hasClass(w.base)&&s.on(y.click,u.selector,r).addClass(w.base))},load:function(e){u&&t.support.history?e&&o(e,!0):window.location.href=e},replace:function(e){var t=history.state;m=e,a(t.id,e)}},events:{failed:"failed",loaded:"loaded",popState:"popstate",progress:"progress",requested:"requested",rendered:"rendered"}}),f={cache:!0,ignoreTypes:/\.(jpg|sjpg|jpeg|png|gif|zip|exe|dmg|pdf|doc.*|xls.*|ppt.*|mp3|txt|rar|wma|mov|avi|wmv|flv|wav)$/i,render:l.noop,requestKey:"fs-asap",selector:"a",transitionOut:l.noop},p=t.$window,h=p[0],g=e.functions,y=e.events,w=e.classes.raw,v="asap-",m="",O=1});