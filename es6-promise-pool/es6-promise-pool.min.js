!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():(t.PromisePool=e(),t.promisePool=t.PromisePool)}(this,function(){"use strict";function o(){this._listeners={}}o.prototype.addEventListener=function(t,e){this._listeners[t]=this._listeners[t]||[],this._listeners[t].indexOf(e)<0&&this._listeners[t].push(e)},o.prototype.removeEventListener=function(t,e){!this._listeners[t]||0<=(e=this._listeners[t].indexOf(e))&&this._listeners[t].splice(e,1)},o.prototype.dispatchEvent=function(t){if(this._listeners[t.type]&&this._listeners[t.type].length)for(var e=this._listeners[t.type].slice(),i=0,o=e.length;i<o;++i)e[i].call(this,t)};function n(t){var e=!1;return{next:function(){return e?{done:!0}:(e=!0,{value:t})}}}function i(t,e,i){this.target=t,this.type=e,this.data=i}function t(t,e,i){if(o.call(this),"number"!=typeof e||Math.floor(e)!==e||e<1)throw new Error("Invalid concurrency");this._concurrency=e,this._options=i||{},this._options.promise=this._options.promise||Promise,this._iterator=function(t,e){var i,o=typeof t;if("object"==o){if("function"==typeof t.next)return t;if("function"==typeof t.then)return n(t)}return"function"==o?"function"==typeof(o=t).constructor&&"GeneratorFunction"===o.constructor.name?t():(i=t,{next:function(){var t=i();return t?{value:t}:{done:!0}}}):n(e.resolve(t))}(t,this._options.promise),this._done=!1,this._size=0,this._promise=null,this._callbacks=null}return((t.prototype=new o).constructor=t).prototype.concurrency=function(t){return void 0!==t&&(this._concurrency=t,this.active()&&this._proceed()),this._concurrency},t.prototype.size=function(){return this._size},t.prototype.active=function(){return!!this._promise},t.prototype.promise=function(){return this._promise},t.prototype.start=function(){var i=this,t=this._options.promise;return this._promise=new t(function(t,e){i._callbacks={reject:e,resolve:t},i._proceed()}),this._promise},t.prototype._fireEvent=function(t,e){this.dispatchEvent(new i(this,t,e))},t.prototype._settle=function(t){t?this._callbacks.reject(t):this._callbacks.resolve(),this._promise=null,this._callbacks=null},t.prototype._onPooledPromiseFulfilled=function(t,e){this._size--,this.active()&&(this._fireEvent("fulfilled",{promise:t,result:e}),this._proceed())},t.prototype._onPooledPromiseRejected=function(t,e){this._size--,this.active()&&(this._fireEvent("rejected",{promise:t,error:e}),this._settle(e||new Error("Unknown error")))},t.prototype._trackPromise=function(e){var i=this;e.then(function(t){i._onPooledPromiseFulfilled(e,t)},function(t){i._onPooledPromiseRejected(e,t)}).catch(function(t){i._settle(new Error("Promise processing failed: "+t))})},t.prototype._proceed=function(){if(!this._done){for(var t={done:!1};this._size<this._concurrency&&!(t=this._iterator.next()).done;)this._size++,this._trackPromise(t.value);this._done=null===t||!!t.done}this._done&&0===this._size&&this._settle()},t.PromisePoolEvent=i,t.PromisePool=t});