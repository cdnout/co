!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.pc=t()}(this,function(){function e(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"))}function t(e){this._gl=e.graphicsDevice.gl,this._ext=e.graphicsDevice.extDisjointTimerQuery,this._freeQueries=[],this._frameQueries=[],this._frames=[],this._timings=[],this._prevTimings=[],e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.end.bind(this))}return Object.assign(pc,(Object.assign(e.prototype,{begin:function(e){this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);var t=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e)},mark:function(e){var t,i=pc.now();0<this._frameIndex?(t=this._frameTimings[this._frameIndex-1])[1]=i-t[1]:0<this._timings.length&&((t=this._timings[this._timings.length-1])[1]=i-t[1]),this._frameIndex>=this._frameTimings.length?this._frameTimings.push([e,i]):((t=this._frameTimings[this._frameIndex])[0]=e,t[1]=i),this._frameIndex++}}),Object.defineProperty(e.prototype,"timings",{get:function(){return this._timings.slice(0,-1).map(function(e){return e[1]})}}),{CpuTimer:e})),Object.assign(pc,(Object.assign(t.prototype,{begin:function(e){var t;0<this._frameQueries.length&&this.end(),this._checkDisjoint(),0<this._frames.length&&this._resolveFrameTimings(this._frames[0],this._prevTimings)&&(t=this._prevTimings,this._prevTimings=this._timings,this._timings=t,this._freeQueries=this._freeQueries.concat(this._frames.splice(0,1)[0])),this.mark(e)},mark:function(e){0<this._frameQueries.length&&this._gl.endQuery(this._ext.TIME_ELAPSED_EXT);var t=this._allocateQuery();t[0]=e,this._gl.beginQuery(this._ext.TIME_ELAPSED_EXT,t[1]),this._frameQueries.push(t)},end:function(){this._gl.endQuery(this._ext.TIME_ELAPSED_EXT),this._frames.push(this._frameQueries),this._frameQueries=[]},_checkDisjoint:function(){this._gl.getParameter(this._ext.GPU_DISJOINT_EXT)&&(this._freeQueries=[this._frames,[this._frameQueries],[this._freeQueries]].flat(2),this._frameQueries=[],this._frames=[])},_allocateQuery:function(){return 0<this._freeQueries.length?this._freeQueries.splice(-1,1)[0]:["",this._gl.createQuery()]},_resolveFrameTimings:function(e,t){if(!this._gl.getQueryParameter(e[e.length-1][1],this._gl.QUERY_RESULT_AVAILABLE))return!1;for(var i=0;i<e.length;++i)t[i]=[e[i][0],1e-6*this._gl.getQueryParameter(e[i][1],this._gl.QUERY_RESULT)];return!0}}),Object.defineProperty(t.prototype,"timings",{get:function(){return this._timings.map(function(e){return e[1]})}}),{GpuTimer:t})),Object.assign(pc,function(){function c(e,t){t=t||128;for(var i=new pc.VertexFormat(e,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD0,components:4,type:pc.TYPE_FLOAT32}]),s=new Uint32Array(6*t),r=0;r<t;++r)s[6*r]=4*r,s[6*r+1]=4*r+1,s[6*r+2]=4*r+2,s[6*r+3]=4*r,s[6*r+4]=4*r+2,s[6*r+5]=4*r+3;this.device=e,this.shader=pc.shaderChunks.createShaderFromCode(e,"attribute vec2 vertex_position;\nattribute vec4 vertex_texCoord0;\nuniform vec4 screenAndTextureSize;\nvarying vec4 uv0;\nvoid main(void) {\n    vec2 pos = vertex_position.xy / screenAndTextureSize.xy;\n    gl_Position = vec4(pos * 2.0 - 1.0, 0.5, 1.0);\n    uv0 = vec4(vertex_texCoord0.xy / screenAndTextureSize.zw, vertex_texCoord0.zw);\n}\n","varying vec4 uv0;\nuniform vec4 clr;\nuniform sampler2D source;\nvoid main (void) {\n    vec4 tex = texture2D(source, uv0.xy);\n    if (tex.rgb != vec3(1, 1, 1)) {\n       if (uv0.w < tex.r)\n           tex = vec4(1.0, 0.3, 0.3, 1.0);\n       else if (uv0.w < tex.g)\n           tex = vec4(0.3, 1.0, 0.3, 1.0);\n       else\n           tex = vec4(0.0, 0.0, 0.0, 1.0);\n    }\n    gl_FragColor = tex * clr;\n}\n","mini-stats"),this.buffer=new pc.VertexBuffer(e,i,4*t,pc.BUFFER_STREAM),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new pc.IndexBuffer(e,pc.INDEXFORMAT_UINT32,6*t,pc.BUFFER_STATIC,s),this.prims=[],this.prim=null,this.primIndex=-1,this.quads=0,this.clrId=e.scope.resolve("clr"),this.clr=new Float32Array(4),this.screenTextureSizeId=e.scope.resolve("screenAndTextureSize"),this.screenTextureSize=new Float32Array(4)}Object.assign(c.prototype,{quad:function(e,t,i,s,r,n,h,a,o){var c=this.quads++,u=this.prim;u&&u.texture===e?u.count+=6:(this.primIndex++,this.primIndex===this.prims.length?(u={type:pc.PRIMITIVE_TRIANGLES,indexed:!0,base:6*c,count:6,texture:e},this.prims.push(u)):((u=this.prims[this.primIndex]).base=6*c,u.count=6,u.texture=e),this.prim=u),e=t+s,u=i+r,s=n+(void 0===a?s:a),r=h+(void 0===o?r:o),this.data.set([t,i,n,h,0,0,e,i,s,h,1,0,e,u,s,r,1,1,t,u,n,r,0,1],24*c)},render:function(e){var t=this.device,i=this.buffer;for(i.setData(this.data.buffer),t.updateBegin(),t.setDepthTest(!1),t.setDepthWrite(!1),t.setCullMode(pc.CULLFACE_NONE),t.setBlending(!0),t.setBlendFunctionSeparate(pc.BLENDMODE_SRC_ALPHA,pc.BLENDMODE_ONE_MINUS_SRC_ALPHA,pc.BLENDMODE_ONE,pc.BLENDMODE_ONE),t.setBlendEquationSeparate(pc.BLENDEQUATION_ADD,pc.BLENDEQUATION_ADD),t.setVertexBuffer(i,0),t.setIndexBuffer(this.indexBuffer),t.setShader(this.shader),i=Math.min(t.maxPixelRatio,window.devicePixelRatio),this.clr.set(e,0),this.clrId.setValue(this.clr),this.screenTextureSize[0]=t.width/i,this.screenTextureSize[1]=t.height/i,e=0;e<=this.primIndex;++e)i=this.prims[e],this.screenTextureSize[2]=i.texture.width,this.screenTextureSize[3]=i.texture.height,this.screenTextureSizeId.setValue(this.screenTextureSize),t.constantTexSource.setValue(i.texture),t.draw(i);t.updateEnd(),this.prim=null,this.primIndex=-1,this.quads=0}});function u(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var s=i.getContext("2d",{alpha:!0});s.font='10px "Lucida Console", Monaco, monospace',s.textAlign="left",s.textBaseline="alphabetic",s.fillStyle="rgb(255, 255, 255)";for(var r=5,n=5,h=[],a=0;a<t.length;++a){var o=s.measureText(t[a]),c=Math.ceil(-o.actualBoundingBoxLeft),u=Math.ceil(o.actualBoundingBoxRight),d=Math.ceil(o.actualBoundingBoxAscent),m=c+u,p=d+(o=Math.ceil(o.actualBoundingBoxDescent));r+m>=i.width&&(r=5,n+=16),s.fillText(t[a],r-c,n+d),h.push({l:c,r:u,a:d,d:o,x:r,y:n,w:m,h:p}),r+=m+5}var g={};for(t.forEach(function(e,t){g[e]=t}),this.words=t,this.wordMap=g,this.placements=h,this.texture=e,t=s.getImageData(0,0,i.width,i.height),i=e.lock(),n=0;n<t.height;++n)for(r=0;r<t.width;++r)i[s=4*(r+n*e.width)]=255,i[s+1]=255,i[s+2]=255,i[s+3]=t.data[4*(r+(t.height-1-n)*t.width)+3]}Object.assign(u.prototype,{render:function(e,t,i,s){return(t=this.placements[this.wordMap[t]])?(e.quad(this.texture,i+t.l-1,s-t.d+1,t.w+2,t.h+2,t.x-1,64-t.y-t.h-1),t.w):0}});function d(e,t,i,s,r){this.name=e,this.device=t.graphicsDevice,this.timer=i,this.enabled=!1,this.avgCount=this.avgTimer=this.avgTotal=0,this.timingText="",this.texture=s,this.yOffset=r,this.cursor=0,this.sample=new Uint8Array(4),this.sample.set([0,0,0,255]),t.on("frameupdate",this.update.bind(this)),this.counter=0}Object.assign(d.prototype,{update:function(e){var t=this.timer.timings,i=t.reduce(function(e,t){return e+t},0);if(this.avgTotal+=i,this.avgTimer+=e,this.avgCount++,1e3<this.avgTimer&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(1),this.avgCount=this.avgTotal=this.avgTimer=0),this.enabled){for(i=e=0;i<t.length;++i)e=Math.min(255,e+Math.floor(5.3125*t[i])),this.sample[i]=e;t=this.device.gl,this.device.bindTexture(this.texture),t.texSubImage2D(t.TEXTURE_2D,0,this.cursor,this.yOffset,1,1,t.RGBA,t.UNSIGNED_BYTE,this.sample),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}},render:function(e,t,i,s,r){e.quad(this.texture,t+s,i,-s,r,this.cursor,.5+(this.enabled?this.yOffset:0),-s,0)}});function m(e){this.ms=0;var t=this;e.on("frameupdate",function(e){t.ms=e})}Object.defineProperty(m.prototype,"timings",{get:function(){return[this.ms]}});function e(e){for(var t=e.graphicsDevice,i=new pc.Texture(t,{name:"mini-stats",width:256,height:32,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),s=new u(i,"Frame CPU GPU ms 0 1 2 3 4 5 6 7 8 9 .".split(" ")),r=i.lock(),n=0;n<4*i.width;++n)r.set([0,0,0,255],4*n);i.unlock(),r=[new d("Frame",e,new m(e),i,1),new d("CPU",e,new pc.CpuTimer(e),i,2)],t.extDisjointTimerQuery&&r.push(new d("GPU",e,new pc.GpuTimer(e),i,3));var h=[{width:100,height:16,graphs:!1},{width:128,height:32,graphs:!0},{width:256,height:64,graphs:!0}],a=0,o=this;(n=document.createElement("div")).style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(n),n.addEventListener("mouseenter",function(e){o.opacity=1}),n.addEventListener("mouseleave",function(e){o.opacity=.5}),n.addEventListener("click",function(e){e.preventDefault(),o.enabled&&(a=(a+1)%h.length,o.resize(h[a].width,h[a].height,h[a].graphs))}),t.on("resizecanvas",function(){o.updateDiv()}),e.on("postrender",function(){o.enabled&&o.render()}),this.device=t,this.texture=i,this.wordAtlas=s,this.render2d=new c(t),this.graphs=r,this.div=n,this.height=this.width=0,this.gspacing=2,this.clr=[1,1,1,.5],this.enabled=!0,this.resize(h[a].width,h[a].height,h[a].graphs)}return Object.defineProperties(e.prototype,{opacity:{get:function(){return this.clr[3]},set:function(e){this.clr[3]=e}},overallHeight:{get:function(){var e=this.graphs;return this.height*e.length+this.gspacing*(e.length-1)}}}),Object.assign(e.prototype,{render:function(){for(var e=this.graphs,t=this.wordAtlas,i=this.render2d,s=this.width,r=this.height,n=this.gspacing,h=0;h<e.length;++h){var a=h*(r+n);(u=e[h]).render(i,0,a,s,r);var o=1;a+=r-13,o+=t.render(i,u.name,o,a)+10;for(var c=u.timingText,u=0;u<c.length;++u)o+=t.render(i,c[u],o,a);t.render(i,"ms",o,a)}i.render(this.clr)},resize:function(e,t,i){for(var s=this.graphs,r=0;r<s.length;++r)s[r].enabled=i;this.width=e,this.height=t,this.updateDiv()},updateDiv:function(){var e=this.device.canvas.getBoundingClientRect();this.div.style.left=e.left+"px",this.div.style.bottom=window.innerHeight-e.bottom+"px",this.div.style.width=this.width+"px",this.div.style.height=this.overallHeight+"px"}}),{MiniStats:e}}()),pc});