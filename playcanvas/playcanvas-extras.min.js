!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).pcx={})}(this,function(e){"use strict";function s(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function t(e,t,i){return t&&s(e.prototype,t),i&&s(e,i),e}var r=((g=i.prototype).begin=function(e){var t;this.enabled&&(this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex),t=this._prevTimings,this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e))},g.mark=function(e){var t,i;this.enabled&&(t=pc.now(),0<this._frameIndex?(i=this._frameTimings[this._frameIndex-1])[1]=t-i[1]:0<this._timings.length&&((i=this._timings[this._timings.length-1])[1]=t-i[1]),this._frameIndex>=this._frameTimings.length?this._frameTimings.push([e,t]):((i=this._frameTimings[this._frameIndex])[0]=e,i[1]=t),this._frameIndex++)},t(i,[{key:"timings",get:function(){return this._timings.slice(0,-1).map(function(e){return e[1]})}}]),i);function i(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"))}var n=((g=a.prototype).loseContext=function(){this._freeQueries=[],this._frameQueries=[],this._frames=[]},g.begin=function(e){var t;this.enabled&&(0<this._frameQueries.length&&this.end(),this._checkDisjoint(),0<this._frames.length&&this._resolveFrameTimings(this._frames[0],this._prevTimings)&&(t=this._prevTimings,this._prevTimings=this._timings,this._timings=t,this._freeQueries=this._freeQueries.concat(this._frames.splice(0,1)[0])),this.mark(e))},g.mark=function(e){var t;this.enabled&&(0<this._frameQueries.length&&this._gl.endQuery(this._ext.TIME_ELAPSED_EXT),(t=this._allocateQuery())[0]=e,this._gl.beginQuery(this._ext.TIME_ELAPSED_EXT,t[1]),this._frameQueries.push(t))},g.end=function(){this.enabled&&(this._gl.endQuery(this._ext.TIME_ELAPSED_EXT),this._frames.push(this._frameQueries),this._frameQueries=[])},g._checkDisjoint=function(){this._gl.getParameter(this._ext.GPU_DISJOINT_EXT)&&(this._freeQueries=[this._frames,[this._frameQueries],[this._freeQueries]].flat(2),this._frameQueries=[],this._frames=[])},g._allocateQuery=function(){return 0<this._freeQueries.length?this._freeQueries.splice(-1,1)[0]:["",this._gl.createQuery()]},g._resolveFrameTimings=function(e,t){if(!this._gl.getQueryParameter(e[e.length-1][1],this._gl.QUERY_RESULT_AVAILABLE))return!1;for(var i=0;i<e.length;++i)t[i]=[e[i][0],1e-6*this._gl.getQueryParameter(e[i][1],this._gl.QUERY_RESULT)];return!0},t(a,[{key:"timings",get:function(){return this._timings.map(function(e){return e[1]})}}]),a);function a(e){this._gl=e.graphicsDevice.gl,this._ext=e.graphicsDevice.extDisjointTimerQuery,this._freeQueries=[],this._frameQueries=[],this._frames=[],this._timings=[],this._prevTimings=[],this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.end.bind(this))}var h=(t(o,[{key:"timings",get:function(){return this.values}}]),o);function o(e,t,i,s,r){this.app=e,this.values=[],this.statNames=t,3<this.statNames.length&&(this.statNames.length=3),this.unitsName=s,this.decimalPlaces=i,this.multiplier=r||1;var n=this;e.on("frameupdate",function(e){for(var t,i,s=0;s<n.statNames.length;s++)n.values[s]=(t=n.statNames[s],i=n.app.stats,t.split(".").reduce(function(e,t){return e?e[t]:null},i||n)*n.multiplier)})}var c=((g=u.prototype).loseContext=function(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext()},g.update=function(e){var t=this.timer.timings,i=t.reduce(function(e,t){return e+t},0);if(this.avgTotal+=i,this.avgTimer+=e,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){for(var s=0,r=1.5*this.watermark,n=0;n<t.length;++n)s+=Math.floor(t[n]/r*255),this.sample[n]=s;this.sample[3]=this.watermark/r*255;e=this.device.gl;this.device.bindTexture(this.texture),e.texSubImage2D(e.TEXTURE_2D,0,this.cursor,this.yOffset,1,1,e.RGBA,e.UNSIGNED_BYTE,this.sample),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}},g.render=function(e,t,i,s,r){e.quad(this.texture,t+s,i,-s,r,this.cursor,.5+this.yOffset,-s,0,this.enabled)},u);function u(e,t,i,s,r){this.name=e,this.device=t.graphicsDevice,this.timer=r,this.watermark=i,this.enabled=!1,this.textRefreshRate=s,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),t.on("frameupdate",this.update.bind(this)),this.counter=0}var l=(d.prototype.render=function(e,t,i,s){t=this.placements[this.wordMap[t]];if(t)return e.quad(this.texture,i+t.l-1,s-t.d+1,t.w+2,t.h+2,t.x-1,64-t.y-t.h-1,void 0,void 0,!0),t.w;return 0},d);function d(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var s=i.getContext("2d",{alpha:!0});s.font='10px "Lucida Console", Monaco, monospace',s.textAlign="left",s.textBaseline="alphabetic",s.fillStyle="rgb(255, 255, 255)";for(var r=5,n=5,a=[],h=0;h<t.length;++h){var o=s.measureText(t[h]),u=Math.ceil(-o.actualBoundingBoxLeft),c=Math.ceil(o.actualBoundingBoxRight),l=Math.ceil(o.actualBoundingBoxAscent),d=Math.ceil(o.actualBoundingBoxDescent),m=u+c,o=l+d;r+m>=i.width&&(r=5,n+=16),s.fillStyle=1===t[h].length?"rgb(255, 255, 255)":"rgb(150, 150, 150)",s.fillText(t[h],r-u,n+l),a.push({l:u,r:c,a:l,d:d,x:r,y:n,w:m,h:o}),r+=m+5}var f={};t.forEach(function(e,t){f[e]=t}),this.words=t,this.wordMap=f,this.placements=a,this.texture=e;for(var g,p,v=s.getImageData(0,0,i.width,i.height),x=e.lock(),n=0;n<v.height;++n)for(r=0;r<v.width;++r){var _=4*(r+n*e.width);x[_]=255,x[1+_]=255,x[2+_]=255,g=v.data[4*(r+(v.height-1-n)*v.width)],p=v.data[4*(r+(v.height-1-n)*v.width)+3],x[3+_]=p*(150<g?1:.7)}}var m=((g=f.prototype).quad=function(e,t,i,s,r,n,a,h,o,u){var c=this.quads++,l=this.prim;l&&l.texture===e?l.count+=6:(this.primIndex++,this.primIndex===this.prims.length?(l={type:pc.PRIMITIVE_TRIANGLES,indexed:!0,base:6*c,count:6,texture:e},this.prims.push(l)):((l=this.prims[this.primIndex]).base=6*c,l.count=6,l.texture=e),this.prim=l);e=t+s,l=i+r,h=n+(void 0===h?s:h),o=a+(void 0===o?r:o),u=u?1:0;this.data.set([t,i,u,n,a,0,0,e,i,u,h,a,1,0,e,l,u,h,o,1,1,t,l,u,n,o,0,1],28*c)},g.render=function(e,t){var i=this.device,s=this.buffer;s.setData(this.data.buffer),i.updateBegin(),i.setDepthTest(!1),i.setDepthWrite(!1),i.setCullMode(pc.CULLFACE_NONE),i.setBlending(!0),i.setBlendFunctionSeparate(pc.BLENDMODE_SRC_ALPHA,pc.BLENDMODE_ONE_MINUS_SRC_ALPHA,pc.BLENDMODE_ONE,pc.BLENDMODE_ONE),i.setBlendEquationSeparate(pc.BLENDEQUATION_ADD,pc.BLENDEQUATION_ADD),i.setVertexBuffer(s,0),i.setIndexBuffer(this.indexBuffer),i.setShader(this.shader);s=Math.min(i.maxPixelRatio,window.devicePixelRatio);this.clr.set(e,0),this.clrId.setValue(this.clr),this.screenTextureSize[0]=i.width/s,this.screenTextureSize[1]=i.height/s,this.col0Id.setValue(this.col0),this.col1Id.setValue(this.col1),this.col2Id.setValue(this.col2),this.watermarkId.setValue(this.watermark),this.backgroundId.setValue(this.background);for(var r=0;r<=this.primIndex;++r){var n=this.prims[r];this.screenTextureSize[2]=n.texture.width,this.screenTextureSize[3]=n.texture.height,this.screenTextureSizeId.setValue(this.screenTextureSize),i.constantTexSource.setValue(n.texture),this.watermarkSizeId.setValue(.5/t),i.draw(n)}i.updateEnd(),this.prim=null,this.primIndex=-1,this.quads=0},f);function f(i,e,t){void 0===t&&(t=512);for(var s=new pc.VertexFormat(i,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD0,components:4,type:pc.TYPE_FLOAT32}]),r=new Uint16Array(6*t),n=0;n<t;++n)r[6*n+0]=4*n,r[6*n+1]=4*n+1,r[6*n+2]=4*n+2,r[6*n+3]=4*n,r[6*n+4]=4*n+2,r[6*n+5]=4*n+3;this.device=i,this.shader=pc.shaderChunks.createShaderFromCode(i,"attribute vec3 vertex_position;\nattribute vec4 vertex_texCoord0;\nuniform vec4 screenAndTextureSize;\nvarying vec4 uv0;\nvarying float enabled;\nvoid main(void) {\n\t\tvec2 pos = vertex_position.xy / screenAndTextureSize.xy;\n\t\tgl_Position = vec4(pos * 2.0 - 1.0, 0.5, 1.0);\n\t\tuv0 = vec4(vertex_texCoord0.xy / screenAndTextureSize.zw, vertex_texCoord0.zw);\n\t\tenabled = vertex_position.z;\n}\n","varying vec4 uv0;\nvarying float enabled;\nuniform vec4 clr;\nuniform vec4 col0;\nuniform vec4 col1;\nuniform vec4 col2;\nuniform vec4 watermark;\nuniform float watermarkSize;\nuniform vec4 background;\nuniform sampler2D source;\nvoid main (void) {\n\t\tvec4 tex = texture2D(source, uv0.xy);\n\t\tif (!(tex.rgb == vec3(1.0, 1.0, 1.0))) {\n\t\t\t if (enabled < 0.5)\n\t\t\t\t\t tex = background;\n\t\t\t else if (abs(uv0.w - tex.a) < watermarkSize)\n\t\t\t\t\t tex = watermark;\n\t\t\t else if (uv0.w < tex.r)\n\t\t\t\t\t tex = col0;\n\t\t\t else if (uv0.w < tex.g)\n\t\t\t\t\t tex = col1;\n\t\t\t else if (uv0.w < tex.b)\n\t\t\t\t\t tex = col2;\n\t\t\t else\n\t\t\t\t\t tex = background;\n\t\t}\n\t\tgl_FragColor = tex * clr;\n}\n","mini-stats"),this.buffer=new pc.VertexBuffer(i,s,4*t,pc.BUFFER_STREAM),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new pc.IndexBuffer(i,pc.INDEXFORMAT_UINT16,6*t,pc.BUFFER_STATIC,r),this.prims=[],this.prim=null,this.primIndex=-1,this.quads=0;s=function(e,t){this[e]=new Float32Array([t.r,t.g,t.b,t.a]),this[e+"Id"]=i.scope.resolve(e)}.bind(this);s("col0",e.graph0),s("col1",e.graph1),s("col2",e.graph2),s("watermark",e.watermark),s("background",e.background),this.watermarkSizeId=i.scope.resolve("watermarkSize"),this.clrId=i.scope.resolve("clr"),this.clr=new Float32Array(4),this.screenTextureSizeId=i.scope.resolve("screenAndTextureSize"),this.screenTextureSize=new Float32Array(4)}var g=function(){function u(e,t){var i=e.graphicsDevice;this._contextLostHandler=function(e){if(e.preventDefault(),this.graphs)for(var t=0;t<this.graphs.length;t++)this.graphs[t].loseContext()}.bind(this),i.canvas.addEventListener("webglcontextlost",this._contextLostHandler,!1),t=t||u.getDefaultOptions();var s=this.initGraphs(e,i,t),r=["","ms","0","1","2","3","4","5","6","7","8","9","."];s.forEach(function(e){r.push(e.name)}),t.stats&&t.stats.forEach(function(e){e.unitsName&&r.push(e.unitsName)}),r=r.filter(function(e,t){return r.indexOf(e)>=t});var n=t.sizes.reduce(function(e,t){return t.width>e?t.width:e},0),a=this.initWordAtlas(i,r,n,s.length),h=a.texture;s.forEach(function(e,t){e.texture=h,e.yOffset=t}),this.sizes=t.sizes,this._activeSizeIndex=t.startSizeIndex;var o=this,n=document.createElement("div");n.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(n),n.addEventListener("mouseenter",function(e){o.opacity=1}),n.addEventListener("mouseleave",function(e){o.opacity=.5}),n.addEventListener("click",function(e){e.preventDefault(),o._enabled&&(o.activeSizeIndex=(o.activeSizeIndex+1)%o.sizes.length,o.resize(o.sizes[o.activeSizeIndex].width,o.sizes[o.activeSizeIndex].height,o.sizes[o.activeSizeIndex].graphs))}),i.on("resizecanvas",function(){o.updateDiv()}),e.on("postrender",function(){o._enabled&&o.render()}),this.device=i,this.texture=h,this.wordAtlas=a.atlas,this.render2d=new m(i,t.colors),this.graphs=s,this.div=n,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}u.getDefaultOptions=function(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,colors:{graph0:new pc.Color(.7,.2,.2,1),graph1:new pc.Color(.2,.7,.2,1),graph2:new pc.Color(.2,.2,.7,1),watermark:new pc.Color(.4,.4,.2,1),background:new pc.Color(0,0,0,1)},cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}};var e=u.prototype;return e.initWordAtlas=function(e,t,i,s){for(var r=new pc.Texture(e,{name:"mini-stats",width:pc.math.nextPowerOfTwo(i),height:64,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),t=new l(r,t),n=r.lock(),a=0;a<r.width*s;++a)n.set([0,0,0,255],4*a);return r.unlock(),e.setTexture(r,0),{atlas:t,texture:r}},e.initGraphs=function(t,e,i){var s=[];return i.cpu.enabled&&s.push(new c("CPU",t,i.cpu.watermark,i.textRefreshRate,new r(t))),i.gpu.enabled&&e.extDisjointTimerQuery&&s.push(new c("GPU",t,i.gpu.watermark,i.textRefreshRate,new n(t))),i.stats&&i.stats.forEach(function(e){s.push(new c(e.name,t,e.watermark,i.textRefreshRate,new h(t,e.stats,e.decimalPlaces,e.unitsName,e.multiplier)))}),s},e.render=function(){for(var e,t,i,s=this.graphs,r=this.wordAtlas,n=this.render2d,a=this.width,h=this.height,o=this.gspacing,u=0;u<s.length;++u){t=u*(h+o),(i=s[u]).render(n,0,t,a,h),e=1,t+=h-13,e+=r.render(n,i.name,e,t)+10;for(var c=i.timingText,l=0;l<c.length;++l)e+=r.render(n,c[l],e,t);i.timer.unitsName&&(e+=3,r.render(n,i.timer.unitsName,e,t))}n.render(this.clr,h)},e.resize=function(e,t,i){for(var s=this.graphs,r=0;r<s.length;++r)s[r].enabled=i;this.width=e,this.height=t,this.updateDiv()},e.updateDiv=function(){var e=this.device.canvas.getBoundingClientRect();this.div.style.left=e.left+"px",this.div.style.bottom=window.innerHeight-e.bottom+"px",this.div.style.width=this.width+"px",this.div.style.height=this.overallHeight+"px"},t(u,[{key:"activeSizeIndex",get:function(){return this._activeSizeIndex},set:function(e){this._activeSizeIndex=e,this.gspacing=this.sizes[e].spacing,this.resize(this.sizes[e].width,this.sizes[e].height,this.sizes[e].graphs)}},{key:"opacity",get:function(){return this.clr[3]},set:function(e){this.clr[3]=e}},{key:"overallHeight",get:function(){var e=this.graphs,t=this.gspacing;return this.height*e.length+t*(e.length-1)}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(e!==this._enabled){this._enabled=e;for(var t=0;t<this.graphs.length;++t)this.graphs[t].enabled=e,this.graphs[t].timer.enabled=e}}}]),u}();e.MiniStats=g,Object.defineProperty(e,"__esModule",{value:!0})});