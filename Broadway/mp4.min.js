"use strict";function assert(e,t){e||error(t)}var Size=function(){function e(e,t){this.w=e,this.h=t}return e.prototype={toString:function(){return"("+this.w+", "+this.h+")"},getHalfSize:function(){return new Size(this.w>>>1,this.h>>>1)},length:function(){return this.w*this.h}},e}(),Bytestream=function(){function e(e,t,r){this.bytes=new Uint8Array(e),this.start=t||0,this.pos=this.start,this.end=t+r||this.bytes.length}return e.prototype={get length(){return this.end-this.start},get position(){return this.pos},get remaining(){return this.end-this.pos},readU8Array:function(e){if(this.pos>this.end-e)return null;var t=this.bytes.subarray(this.pos,this.pos+e);return this.pos+=e,t},readU32Array:function(e,t,r){if(t=t||1,this.pos>this.end-e*t*4)return null;if(1==t){for(var a=new Uint32Array(e),i=0;i<e;i++)a[i]=this.readU32();return a}for(var a=new Array(e),i=0;i<e;i++){var s=null;if(r){s={};for(var n=0;n<t;n++)s[r[n]]=this.readU32()}else{s=new Uint32Array(t);for(var n=0;n<t;n++)s[n]=this.readU32()}a[i]=s}return a},read8:function(){return this.readU8()<<24>>24},readU8:function(){return this.pos>=this.end?null:this.bytes[this.pos++]},read16:function(){return this.readU16()<<16>>16},readU16:function(){if(this.pos>=this.end-1)return null;var e=this.bytes[this.pos+0]<<8|this.bytes[this.pos+1];return this.pos+=2,e},read24:function(){return this.readU24()<<8>>8},readU24:function(){var e=this.pos,t=this.bytes;if(e>this.end-3)return null;var r=t[e+0]<<16|t[e+1]<<8|t[e+2];return this.pos+=3,r},peek32:function(e){var t=this.pos,r=this.bytes;if(t>this.end-4)return null;var a=r[t+0]<<24|r[t+1]<<16|r[t+2]<<8|r[t+3];return e&&(this.pos+=4),a},read32:function(){return this.peek32(!0)},readU32:function(){return this.peek32(!0)>>>0},read4CC:function(){var e=this.pos;if(e>this.end-4)return null;for(var t="",r=0;r<4;r++)t+=String.fromCharCode(this.bytes[e+r]);return this.pos+=4,t},readFP16:function(){return this.read32()/65536},readFP8:function(){return this.read16()/256},readISO639:function(){for(var e=this.readU16(),t="",r=0;r<3;r++){var a=e>>>5*(2-r)&31;t+=String.fromCharCode(a+96)}return t},readUTF8:function(e){for(var t="",r=0;r<e;r++)t+=String.fromCharCode(this.readU8());return t},readPString:function(e){var t=this.readU8();assert(t<=e);var r=this.readUTF8(t);return this.reserved(e-t-1,0),r},skip:function(e){this.seek(this.pos+e)},reserved:function(e,t){for(var r=0;r<e;r++)assert(this.readU8()==t)},seek:function(e){(e<0||e>this.end)&&error("Index out of bounds (bounds: [0, "+this.end+"], index: "+e+")."),this.pos=e},subStream:function(e,t){return new Bytestream(this.bytes.buffer,e,t)}},e}(),PARANOID=!0,MP4Reader=function(){function e(e){this.stream=e,this.tracks={}}return e.prototype={readBoxes:function(e,t){for(;e.peek32();){var r=this.readBox(e);if(r.type in t){var a=t[r.type];a instanceof Array||(t[r.type]=[a]),t[r.type].push(r)}else t[r.type]=r}},readBox:function(e){function t(){s.size=e.readU32(),s.type=e.read4CC()}function r(){s.version=e.readU8(),s.flags=e.readU24()}function a(){return s.size-(e.position-s.offset)}function i(){e.skip(a())}var s={offset:e.position},n=function(){var t=e.subStream(e.position,a());this.readBoxes(t,s),e.skip(t.length)}.bind(this);switch(t(),s.type){case"ftyp":s.name="File Type Box",s.majorBrand=e.read4CC(),s.minorVersion=e.readU32(),s.compatibleBrands=new Array((s.size-16)/4);for(var o=0;o<s.compatibleBrands.length;o++)s.compatibleBrands[o]=e.read4CC();break;case"moov":s.name="Movie Box",n();break;case"mvhd":s.name="Movie Header Box",r(),assert(0==s.version),s.creationTime=e.readU32(),s.modificationTime=e.readU32(),s.timeScale=e.readU32(),s.duration=e.readU32(),s.rate=e.readFP16(),s.volume=e.readFP8(),e.skip(10),s.matrix=e.readU32Array(9),e.skip(24),s.nextTrackId=e.readU32();break;case"trak":s.name="Track Box",n(),this.tracks[s.tkhd.trackId]=new Track(this,s);break;case"tkhd":s.name="Track Header Box",r(),assert(0==s.version),s.creationTime=e.readU32(),s.modificationTime=e.readU32(),s.trackId=e.readU32(),e.skip(4),s.duration=e.readU32(),e.skip(8),s.layer=e.readU16(),s.alternateGroup=e.readU16(),s.volume=e.readFP8(),e.skip(2),s.matrix=e.readU32Array(9),s.width=e.readFP16(),s.height=e.readFP16();break;case"mdia":s.name="Media Box",n();break;case"mdhd":s.name="Media Header Box",r(),assert(0==s.version),s.creationTime=e.readU32(),s.modificationTime=e.readU32(),s.timeScale=e.readU32(),s.duration=e.readU32(),s.language=e.readISO639(),e.skip(2);break;case"hdlr":s.name="Handler Reference Box",r(),e.skip(4),s.handlerType=e.read4CC(),e.skip(12);var d=s.size-32;d>0&&(s.name=e.readUTF8(d));break;case"minf":s.name="Media Information Box",n();break;case"stbl":s.name="Sample Table Box",n();break;case"stsd":s.name="Sample Description Box",r(),s.sd=[];e.readU32();n();break;case"avc1":e.reserved(6,0),s.dataReferenceIndex=e.readU16(),assert(0==e.readU16()),assert(0==e.readU16()),e.readU32(),e.readU32(),e.readU32(),s.width=e.readU16(),s.height=e.readU16(),s.horizontalResolution=e.readFP16(),s.verticalResolution=e.readFP16(),assert(0==e.readU32()),s.frameCount=e.readU16(),s.compressorName=e.readPString(32),s.depth=e.readU16(),assert(65535==e.readU16()),n();break;case"mp4a":e.reserved(6,0),s.dataReferenceIndex=e.readU16(),s.version=e.readU16(),e.skip(2),e.skip(4),s.channelCount=e.readU16(),s.sampleSize=e.readU16(),s.compressionId=e.readU16(),s.packetSize=e.readU16(),s.sampleRate=e.readU32()>>>16,assert(0==s.version),n();break;case"esds":s.name="Elementary Stream Descriptor",r(),i();break;case"avcC":s.name="AVC Configuration Box",s.configurationVersion=e.readU8(),s.avcProfileIndicaation=e.readU8(),s.profileCompatibility=e.readU8(),s.avcLevelIndication=e.readU8(),s.lengthSizeMinusOne=3&e.readU8(),assert(3==s.lengthSizeMinusOne,"TODO");var u=31&e.readU8();s.sps=[];for(var o=0;o<u;o++)s.sps.push(e.readU8Array(e.readU16()));var u=31&e.readU8();s.pps=[];for(var o=0;o<u;o++)s.pps.push(e.readU8Array(e.readU16()));i();break;case"btrt":s.name="Bit Rate Box",s.bufferSizeDb=e.readU32(),s.maxBitrate=e.readU32(),s.avgBitrate=e.readU32();break;case"stts":s.name="Decoding Time to Sample Box",r(),s.table=e.readU32Array(e.readU32(),2,["count","delta"]);break;case"stss":s.name="Sync Sample Box",r(),s.samples=e.readU32Array(e.readU32());break;case"stsc":s.name="Sample to Chunk Box",r(),s.table=e.readU32Array(e.readU32(),3,["firstChunk","samplesPerChunk","sampleDescriptionId"]);break;case"stsz":s.name="Sample Size Box",r(),s.sampleSize=e.readU32();var u=e.readU32();0==s.sampleSize&&(s.table=e.readU32Array(u));break;case"stco":s.name="Chunk Offset Box",r(),s.table=e.readU32Array(e.readU32());break;case"smhd":s.name="Sound Media Header Box",r(),s.balance=e.readFP8(),e.reserved(2,0);break;case"mdat":s.name="Media Data Box",assert(s.size>=8,"Cannot parse large media data yet."),s.data=e.readU8Array(a());break;default:i()}return s},read:function(){var e=(new Date).getTime();this.file={},this.readBoxes(this.stream,this.file),console.info("Parsed stream in "+((new Date).getTime()-e)+" ms")},traceSamples:function(){var e=this.tracks[1],t=this.tracks[2];console.info("Video Samples: "+e.getSampleCount()),console.info("Audio Samples: "+t.getSampleCount());for(var r=0,a=0,i=0;i<100;i++){var s=e.sampleToOffset(r),n=t.sampleToOffset(a),o=e.sampleToSize(r,1),d=t.sampleToSize(a,1);s<n?(console.info("V Sample "+r+" Offset : "+s+", Size : "+o),r++):(console.info("A Sample "+a+" Offset : "+n+", Size : "+d),a++)}}},e}(),Track=function(){function e(e,t){this.file=e,this.trak=t}return e.prototype={getSampleSizeTable:function(){return this.trak.mdia.minf.stbl.stsz.table},getSampleCount:function(){return this.getSampleSizeTable().length},sampleToSize:function(e,t){for(var r=this.getSampleSizeTable(),a=0,i=e;i<e+t;i++)a+=r[i];return a},sampleToChunk:function(e){var t=this.trak.mdia.minf.stbl.stsc.table;if(1===t.length){var r=t[0];return assert(1===r.firstChunk),{index:e/r.samplesPerChunk,offset:e%r.samplesPerChunk}}for(var a=0,i=0;i<t.length;i++){var r=t[i];if(i>0){var s=t[i-1],n=r.firstChunk-s.firstChunk,o=s.samplesPerChunk*n;if(!(e>=o))return{index:a+Math.floor(e/s.samplesPerChunk),offset:e%s.samplesPerChunk};if(e-=o,i==t.length-1)return{index:a+n+Math.floor(e/r.samplesPerChunk),offset:e%r.samplesPerChunk};a+=n}}assert(!1)},chunkToOffset:function(e){var t=this.trak.mdia.minf.stbl.stco.table;return t[e]},sampleToOffset:function(e){var t=this.sampleToChunk(e),r=this.chunkToOffset(t.index);return r+this.sampleToSize(e-t.offset,t.offset)},timeToSample:function(e){for(var t=this.trak.mdia.minf.stbl.stts.table,r=0,a=0;a<t.length;a++){var i=t[a].count*t[a].delta;if(!(e>=i))return r+Math.floor(e/t[a].delta);e-=i,r+=t[a].count}},getTotalTime:function(){if(PARANOID){for(var e=this.trak.mdia.minf.stbl.stts.table,t=0,r=0;r<e.length;r++)t+=e[r].count*e[r].delta;assert(this.trak.mdia.mdhd.duration==t)}return this.trak.mdia.mdhd.duration},getTotalTimeInSeconds:function(){return this.timeToSeconds(this.getTotalTime())},getTimeScale:function(){return this.trak.mdia.mdhd.timeScale},timeToSeconds:function(e){return e/this.getTimeScale()},secondsToTime:function(e){return e*this.getTimeScale()},foo:function(){},getSampleNALUnits:function(e){for(var t=this.file.stream.bytes,r=this.sampleToOffset(e),a=r+this.sampleToSize(e,1),i=[];a-r>0;){var s=new Bytestream(t.buffer,r).readU32();i.push(t.subarray(r+4,r+s+4)),r=r+s+4}return i}},e}();!function(){function e(e){r.push(e),window.postMessage(a,"*")}function t(e){if(e.source==window&&e.data==a&&(e.stopPropagation(),r.length>0)){var t=r.shift();t()}}var r=[],a="zero-timeout-message";window.addEventListener("message",t,!0),window.setZeroTimeout=e}();var MP4Player=function(){function e(e,r,a,i){this.stream=e,this.useWorkers=r,this.webgl=a,this.render=i,this.statistics={videoStartTime:0,videoPictureCounter:0,windowStartTime:0,windowPictureCounter:0,fps:0,fpsMin:1e3,fpsMax:-1e3,webGLTextureUploadTime:0},this.onStatisticsUpdated=function(){},this.avc=new Player({useWorker:r,reuseMemory:!0,webgl:a,size:{width:640,height:368}}),this.webgl=this.avc.webgl;var s=this;this.avc.onPictureDecoded=function(){t.call(s)},this.canvas=this.avc.canvas}function t(){var e=this.statistics;e.videoPictureCounter+=1,e.windowPictureCounter+=1;var t=Date.now();e.videoStartTime||(e.videoStartTime=t);var r=t-e.videoStartTime;if(e.elapsed=r/1e3,!(r<1e3)){if(!e.windowStartTime)return void(e.windowStartTime=t);if(t-e.windowStartTime>1e3){var a=t-e.windowStartTime,i=e.windowPictureCounter/a*1e3;e.windowStartTime=t,e.windowPictureCounter=0,i<e.fpsMin&&(e.fpsMin=i),i>e.fpsMax&&(e.fpsMax=i),e.fps=i}var i=e.videoPictureCounter/r*1e3;e.fpsSinceStart=i,this.onStatisticsUpdated(this.statistics)}}return e.prototype={readAll:function(e){console.info("MP4Player::readAll()"),this.stream.readAll(null,function(t){this.reader=new MP4Reader(new Bytestream(t)),this.reader.read();var r=this.reader.tracks[1];this.size=new Size(r.trak.tkhd.width,r.trak.tkhd.height),console.info("MP4Player::readAll(), length: "+this.reader.stream.length),e&&e()}.bind(this))},play:function(){var e=this.reader;if(!e)return void this.readAll(this.play.bind(this));var t=e.tracks[1],r=(e.tracks[2],e.tracks[1].trak.mdia.minf.stbl.stsd.avc1.avcC),a=r.sps[0],i=r.pps[0];this.avc.decode(a),this.avc.decode(i);var s=0;setTimeout(function e(){var r=this.avc;t.getSampleNALUnits(s).forEach(function(e){r.decode(e)}),s++,s<3e3&&setTimeout(e.bind(this),1)}.bind(this),1)}},e}(),Broadway=function(){function e(e){var t=e.attributes.src?e.attributes.src.value:void 0,r=(e.attributes.width?e.attributes.width.value:640,e.attributes.height?e.attributes.height.value:480,document.createElement("div"));r.setAttribute("style","z-index: 100; position: absolute; bottom: 0px; background-color: rgba(0,0,0,0.8); height: 30px; width: 100%; text-align: left;"),this.info=document.createElement("div"),this.info.setAttribute("style","font-size: 14px; font-weight: bold; padding: 6px; color: lime;"),r.appendChild(this.info),e.appendChild(r);var a=!!e.attributes.workers&&"true"==e.attributes.workers.value,i=!!e.attributes.render&&"true"==e.attributes.render.value,s="auto";e.attributes.webgl&&("true"==e.attributes.webgl.value&&(s=!0),"false"==e.attributes.webgl.value&&(s=!1));var n="Click canvas to load and play - ",o="";o+=a?"worker thread ":"main thread ",this.player=new MP4Player(new Stream(t),a,s,i),this.canvas=this.player.canvas,this.canvas.onclick=function(){this.play()}.bind(this),e.appendChild(this.canvas),o+=" - webgl: "+this.player.webgl,this.info.innerHTML=n+o,this.score=null,this.player.onStatisticsUpdated=function(e){if(e.videoPictureCounter%10==0){var t="";e.fps&&(t+=" fps: "+e.fps.toFixed(2)),e.fpsSinceStart&&(t+=" avg: "+e.fpsSinceStart.toFixed(2));var r=1200;e.videoPictureCounter<r?this.score=r-e.videoPictureCounter:e.videoPictureCounter==r&&(this.score=e.fpsSinceStart.toFixed(2)),this.info.innerHTML=o+t}}.bind(this)}return e.prototype={play:function(){this.player.play()}},e}();
//# sourceMappingURL=mp4.min.js.map