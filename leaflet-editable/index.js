"use strict";!function(t,e){"function"==typeof define&&define.amd?define(["leaflet"],t):"object"==typeof exports&&(module.exports=t(require("leaflet"))),void 0!==e&&e.L&&t(e.L)}(function(d){d.Editable=d.Evented.extend({statics:{FORWARD:1,BACKWARD:-1},options:{zIndex:1e3,polygonClass:d.Polygon,polylineClass:d.Polyline,markerClass:d.Marker,rectangleClass:d.Rectangle,circleClass:d.Circle,drawingCSSClass:"leaflet-editable-drawing",drawingCursor:"crosshair",editLayer:void 0,featuresLayer:void 0,polylineEditorClass:void 0,polygonEditorClass:void 0,markerEditorClass:void 0,rectangleEditorClass:void 0,circleEditorClass:void 0,lineGuideOptions:{},skipMiddleMarkers:!1},initialize:function(t,e){d.setOptions(this,e),this._lastZIndex=this.options.zIndex,this.map=t,this.editLayer=this.createEditLayer(),this.featuresLayer=this.createFeaturesLayer(),this.forwardLineGuide=this.createLineGuide(),this.backwardLineGuide=this.createLineGuide()},fireAndForward:function(t,e){((e=e||{}).editTools=this).fire(t,e),this.map.fire(t,e)},createLineGuide:function(){var t=d.extend({dashArray:"5,10",weight:1,interactive:!1},this.options.lineGuideOptions);return d.polyline([],t)},createVertexIcon:function(t){return d.Browser.mobile&&d.Browser.touch?new d.Editable.TouchVertexIcon(t):new d.Editable.VertexIcon(t)},createEditLayer:function(){return this.options.editLayer||(new d.LayerGroup).addTo(this.map)},createFeaturesLayer:function(){return this.options.featuresLayer||(new d.LayerGroup).addTo(this.map)},moveForwardLineGuide:function(t){this.forwardLineGuide._latlngs.length&&(this.forwardLineGuide._latlngs[1]=t,this.forwardLineGuide._bounds.extend(t),this.forwardLineGuide.redraw())},moveBackwardLineGuide:function(t){this.backwardLineGuide._latlngs.length&&(this.backwardLineGuide._latlngs[1]=t,this.backwardLineGuide._bounds.extend(t),this.backwardLineGuide.redraw())},anchorForwardLineGuide:function(t){this.forwardLineGuide._latlngs[0]=t,this.forwardLineGuide._bounds.extend(t),this.forwardLineGuide.redraw()},anchorBackwardLineGuide:function(t){this.backwardLineGuide._latlngs[0]=t,this.backwardLineGuide._bounds.extend(t),this.backwardLineGuide.redraw()},attachForwardLineGuide:function(){this.editLayer.addLayer(this.forwardLineGuide)},attachBackwardLineGuide:function(){this.editLayer.addLayer(this.backwardLineGuide)},detachForwardLineGuide:function(){this.forwardLineGuide.setLatLngs([]),this.editLayer.removeLayer(this.forwardLineGuide)},detachBackwardLineGuide:function(){this.backwardLineGuide.setLatLngs([]),this.editLayer.removeLayer(this.backwardLineGuide)},blockEvents:function(){this._oldTargets||(this._oldTargets=this.map._targets,this.map._targets={})},unblockEvents:function(){this._oldTargets&&(this.map._targets=d.extend(this.map._targets,this._oldTargets),delete this._oldTargets)},registerForDrawing:function(t){this._drawingEditor&&this.unregisterForDrawing(this._drawingEditor),this.blockEvents(),t.reset(),this._drawingEditor=t,this.map.on("mousemove touchmove",t.onDrawingMouseMove,t),this.map.on("mousedown",this.onMousedown,this),this.map.on("mouseup",this.onMouseup,this),d.DomUtil.addClass(this.map._container,this.options.drawingCSSClass),this.defaultMapCursor=this.map._container.style.cursor,this.map._container.style.cursor=this.options.drawingCursor},unregisterForDrawing:function(t){this.unblockEvents(),d.DomUtil.removeClass(this.map._container,this.options.drawingCSSClass),this.map._container.style.cursor=this.defaultMapCursor,(t=t||this._drawingEditor)&&(this.map.off("mousemove touchmove",t.onDrawingMouseMove,t),this.map.off("mousedown",this.onMousedown,this),this.map.off("mouseup",this.onMouseup,this),t===this._drawingEditor&&(delete this._drawingEditor,t._drawing&&t.cancelDrawing()))},onMousedown:function(t){1==t.originalEvent.which&&(this._mouseDown=t,this._drawingEditor.onDrawingMouseDown(t))},onMouseup:function(t){if(this._mouseDown){var e=this._drawingEditor,i=this._mouseDown;if(this._mouseDown=null,e.onDrawingMouseUp(t),this._drawingEditor!==e)return;var n=d.point(i.originalEvent.clientX,i.originalEvent.clientY),r=d.point(t.originalEvent.clientX,t.originalEvent.clientY).distanceTo(n);Math.abs(r)<9*(window.devicePixelRatio||1)&&this._drawingEditor.onDrawingClick(t)}},drawing:function(){return this._drawingEditor&&this._drawingEditor.drawing()},stopDrawing:function(){this.unregisterForDrawing()},commitDrawing:function(t){this._drawingEditor&&this._drawingEditor.commitDrawing(t)},connectCreatedToMap:function(t){return this.featuresLayer.addLayer(t)},startPolyline:function(t,e){var i=this.createPolyline([],e);return i.enableEdit(this.map).newShape(t),i},startPolygon:function(t,e){var i=this.createPolygon([],e);return i.enableEdit(this.map).newShape(t),i},startMarker:function(t,e){t=t||this.map.getCenter().clone();var i=this.createMarker(t,e);return i.enableEdit(this.map).startDrawing(),i},startRectangle:function(t,e){var i=t||d.latLng([0,0]),n=new d.LatLngBounds(i,i),r=this.createRectangle(n,e);return r.enableEdit(this.map).startDrawing(),r},startCircle:function(t,e){t=t||this.map.getCenter().clone();var i=this.createCircle(t,e);return i.enableEdit(this.map).startDrawing(),i},startHole:function(t,e){t.newHole(e)},createLayer:function(t,e,i){var n=new t(e,i=d.Util.extend({editOptions:{editTools:this}},i));return this.fireAndForward("editable:created",{layer:n}),n},createPolyline:function(t,e){return this.createLayer(e&&e.polylineClass||this.options.polylineClass,t,e)},createPolygon:function(t,e){return this.createLayer(e&&e.polygonClass||this.options.polygonClass,t,e)},createMarker:function(t,e){return this.createLayer(e&&e.markerClass||this.options.markerClass,t,e)},createRectangle:function(t,e){return this.createLayer(e&&e.rectangleClass||this.options.rectangleClass,t,e)},createCircle:function(t,e){return this.createLayer(e&&e.circleClass||this.options.circleClass,t,e)}}),d.extend(d.Editable,{makeCancellable:function(t){t.cancel=function(){t._cancelled=!0}}}),d.Map.mergeOptions({editToolsClass:d.Editable,editable:!1,editOptions:{}}),d.Map.addInitHook(function(){this.whenReady(function(){this.options.editable&&(this.editTools=new this.options.editToolsClass(this,this.options.editOptions))})}),d.Editable.VertexIcon=d.DivIcon.extend({options:{iconSize:new d.Point(8,8)}}),d.Editable.TouchVertexIcon=d.Editable.VertexIcon.extend({options:{iconSize:new d.Point(20,20)}}),d.Editable.VertexMarker=d.Marker.extend({options:{draggable:!0,className:"leaflet-div-icon leaflet-vertex-icon"},initialize:function(t,e,i,n){this.latlng=t,this.latlngs=e,this.editor=i,d.Marker.prototype.initialize.call(this,t,n),this.options.icon=this.editor.tools.createVertexIcon({className:this.options.className}),(this.latlng.__vertex=this).editor.editLayer.addLayer(this),this.setZIndexOffset(i.tools._lastZIndex+1)},onAdd:function(t){d.Marker.prototype.onAdd.call(this,t),this.on("drag",this.onDrag),this.on("dragstart",this.onDragStart),this.on("dragend",this.onDragEnd),this.on("mouseup",this.onMouseup),this.on("click",this.onClick),this.on("contextmenu",this.onContextMenu),this.on("mousedown touchstart",this.onMouseDown),this.on("mouseover",this.onMouseOver),this.on("mouseout",this.onMouseOut),this.addMiddleMarkers()},onRemove:function(t){this.middleMarker&&this.middleMarker.delete(),delete this.latlng.__vertex,this.off("drag",this.onDrag),this.off("dragstart",this.onDragStart),this.off("dragend",this.onDragEnd),this.off("mouseup",this.onMouseup),this.off("click",this.onClick),this.off("contextmenu",this.onContextMenu),this.off("mousedown touchstart",this.onMouseDown),this.off("mouseover",this.onMouseOver),this.off("mouseout",this.onMouseOut),d.Marker.prototype.onRemove.call(this,t)},onDrag:function(t){(t.vertex=this).editor.onVertexMarkerDrag(t);var e=d.DomUtil.getPosition(this._icon),i=this._map.layerPointToLatLng(e);this.latlng.update(i),this._latlng=this.latlng,this.editor.refresh(),this.middleMarker&&this.middleMarker.updateLatLng();var n=this.getNext();n&&n.middleMarker&&n.middleMarker.updateLatLng()},onDragStart:function(t){(t.vertex=this).editor.onVertexMarkerDragStart(t)},onDragEnd:function(t){(t.vertex=this).editor.onVertexMarkerDragEnd(t)},onClick:function(t){(t.vertex=this).editor.onVertexMarkerClick(t)},onMouseup:function(t){d.DomEvent.stop(t),(t.vertex=this).editor.map.fire("mouseup",t)},onContextMenu:function(t){(t.vertex=this).editor.onVertexMarkerContextMenu(t)},onMouseDown:function(t){(t.vertex=this).editor.onVertexMarkerMouseDown(t)},onMouseOver:function(t){(t.vertex=this).editor.onVertexMarkerMouseOver(t)},onMouseOut:function(t){(t.vertex=this).editor.onVertexMarkerMouseOut(t)},delete:function(){var t=this.getNext();this.latlngs.splice(this.getIndex(),1),this.editor.editLayer.removeLayer(this),this.editor.onVertexDeleted({latlng:this.latlng,vertex:this}),this.latlngs.length||this.editor.deleteShape(this.latlngs),t&&t.resetMiddleMarker(),this.editor.refresh()},getIndex:function(){return this.latlngs.indexOf(this.latlng)},getLastIndex:function(){return this.latlngs.length-1},getPrevious:function(){if(!(this.latlngs.length<2)){var t=this.getIndex(),e=t-1;0===t&&this.editor.CLOSED&&(e=this.getLastIndex());var i=this.latlngs[e];return i?i.__vertex:void 0}},getNext:function(){if(!(this.latlngs.length<2)){var t=this.getIndex(),e=t+1;t===this.getLastIndex()&&this.editor.CLOSED&&(e=0);var i=this.latlngs[e];return i?i.__vertex:void 0}},addMiddleMarker:function(t){this.editor.hasMiddleMarkers()&&(t=t||this.getPrevious())&&!this.middleMarker&&(this.middleMarker=this.editor.addMiddleMarker(t,this,this.latlngs,this.editor))},addMiddleMarkers:function(){if(this.editor.hasMiddleMarkers()){var t=this.getPrevious();t&&this.addMiddleMarker(t);var e=this.getNext();e&&e.resetMiddleMarker()}},resetMiddleMarker:function(){this.middleMarker&&this.middleMarker.delete(),this.addMiddleMarker()},split:function(){this.editor.splitShape&&this.editor.splitShape(this.latlngs,this.getIndex())},continue:function(){if(this.editor.continueBackward){var t=this.getIndex();0===t?this.editor.continueBackward(this.latlngs):t===this.getLastIndex()&&this.editor.continueForward(this.latlngs)}}}),d.Editable.mergeOptions({vertexMarkerClass:d.Editable.VertexMarker}),d.Editable.MiddleMarker=d.Marker.extend({options:{opacity:.5,className:"leaflet-div-icon leaflet-middle-icon",draggable:!0},initialize:function(t,e,i,n,r){this.left=t,this.right=e,this.editor=n,this.latlngs=i,d.Marker.prototype.initialize.call(this,this.computeLatLng(),r),this._opacity=this.options.opacity,this.options.icon=this.editor.tools.createVertexIcon({className:this.options.className}),this.editor.editLayer.addLayer(this),this.setVisibility()},setVisibility:function(){var t=this._map.latLngToContainerPoint(this.left.latlng),e=this._map.latLngToContainerPoint(this.right.latlng),i=d.point(this.options.icon.options.iconSize);t.distanceTo(e)<3*i.x?this.hide():this.show()},show:function(){this.setOpacity(this._opacity)},hide:function(){this.setOpacity(0)},updateLatLng:function(){this.setLatLng(this.computeLatLng()),this.setVisibility()},computeLatLng:function(){var t=this.editor.map.latLngToContainerPoint(this.left.latlng),e=this.editor.map.latLngToContainerPoint(this.right.latlng),i=(t.y+e.y)/2,n=(t.x+e.x)/2;return this.editor.map.containerPointToLatLng([n,i])},onAdd:function(t){d.Marker.prototype.onAdd.call(this,t),d.DomEvent.on(this._icon,"mousedown touchstart",this.onMouseDown,this),t.on("zoomend",this.setVisibility,this)},onRemove:function(t){delete this.right.middleMarker,d.DomEvent.off(this._icon,"mousedown touchstart",this.onMouseDown,this),t.off("zoomend",this.setVisibility,this),d.Marker.prototype.onRemove.call(this,t)},onMouseDown:function(t){var e=d.DomUtil.getPosition(this._icon);if(t={originalEvent:t,latlng:this.editor.map.layerPointToLatLng(e)},0!==this.options.opacity&&(d.Editable.makeCancellable(t),this.editor.onMiddleMarkerMouseDown(t),!t._cancelled)){this.latlngs.splice(this.index(),0,t.latlng),this.editor.refresh();var i=this._icon,n=this.editor.addVertexMarker(t.latlng,this.latlngs);this.editor.onNewVertex(n);var r=n._icon.parentNode;r.removeChild(n._icon),n._icon=i,r.appendChild(n._icon),n._initIcon(),n._initInteraction(),n.setOpacity(1),d.Draggable._dragging=!1,n.dragging._draggable._onDown(t.originalEvent),this.delete()}},delete:function(){this.editor.editLayer.removeLayer(this)},index:function(){return this.latlngs.indexOf(this.right.latlng)}}),d.Editable.mergeOptions({middleMarkerClass:d.Editable.MiddleMarker}),d.Editable.BaseEditor=d.Handler.extend({initialize:function(t,e,i){d.setOptions(this,i),this.map=t,this.feature=e,(this.feature.editor=this).editLayer=new d.LayerGroup,this.tools=this.options.editTools||t.editTools},addHooks:function(){this.isConnected()?this.onFeatureAdd():this.feature.once("add",this.onFeatureAdd,this),this.onEnable(),this.feature.on(this._getEvents(),this)},removeHooks:function(){this.feature.off(this._getEvents(),this),this.feature.dragging&&this.feature.dragging.disable(),this.editLayer.clearLayers(),this.tools.editLayer.removeLayer(this.editLayer),this.onDisable(),this._drawing&&this.cancelDrawing()},drawing:function(){return!!this._drawing},reset:function(){},onFeatureAdd:function(){this.tools.editLayer.addLayer(this.editLayer),this.feature.dragging&&this.feature.dragging.enable()},hasMiddleMarkers:function(){return!this.options.skipMiddleMarkers&&!this.tools.options.skipMiddleMarkers},fireAndForward:function(t,e){(e=e||{}).layer=this.feature,this.feature.fire(t,e),this.tools.fireAndForward(t,e)},onEnable:function(){this.fireAndForward("editable:enable")},onDisable:function(){this.fireAndForward("editable:disable")},onEditing:function(){this.fireAndForward("editable:editing")},onStartDrawing:function(){this.fireAndForward("editable:drawing:start")},onEndDrawing:function(){this.fireAndForward("editable:drawing:end")},onCancelDrawing:function(){this.fireAndForward("editable:drawing:cancel")},onCommitDrawing:function(t){this.fireAndForward("editable:drawing:commit",t)},onDrawingMouseDown:function(t){this.fireAndForward("editable:drawing:mousedown",t)},onDrawingMouseUp:function(t){this.fireAndForward("editable:drawing:mouseup",t)},startDrawing:function(){this._drawing||(this._drawing=d.Editable.FORWARD),this.tools.registerForDrawing(this),this.onStartDrawing()},commitDrawing:function(t){this.onCommitDrawing(t),this.endDrawing()},cancelDrawing:function(){d.Draggable._dragging=!1,this.onCancelDrawing(),this.endDrawing()},endDrawing:function(){this._drawing=!1,this.tools.unregisterForDrawing(this),this.onEndDrawing()},onDrawingClick:function(t){this.drawing()&&(d.Editable.makeCancellable(t),this.fireAndForward("editable:drawing:click",t),t._cancelled||(this.isConnected()||this.connect(t),this.processDrawingClick(t)))},isConnected:function(){return this.map.hasLayer(this.feature)},connect:function(){this.tools.connectCreatedToMap(this.feature),this.tools.editLayer.addLayer(this.editLayer)},onMove:function(t){this.fireAndForward("editable:drawing:move",t)},onDrawingMouseMove:function(t){this.onMove(t)},_getEvents:function(){return{dragstart:this.onDragStart,drag:this.onDrag,dragend:this.onDragEnd,remove:this.disable}},onDragStart:function(t){this.onEditing(),this.fireAndForward("editable:dragstart",t)},onDrag:function(t){this.onMove(t),this.fireAndForward("editable:drag",t)},onDragEnd:function(t){this.fireAndForward("editable:dragend",t)}}),d.Editable.MarkerEditor=d.Editable.BaseEditor.extend({onDrawingMouseMove:function(t){d.Editable.BaseEditor.prototype.onDrawingMouseMove.call(this,t),this._drawing&&this.feature.setLatLng(t.latlng)},processDrawingClick:function(t){this.fireAndForward("editable:drawing:clicked",t),this.commitDrawing(t)},connect:function(t){t&&(this.feature._latlng=t.latlng),d.Editable.BaseEditor.prototype.connect.call(this,t)}}),d.Editable.PathEditor=d.Editable.BaseEditor.extend({CLOSED:!1,MIN_VERTEX:2,addHooks:function(){return d.Editable.BaseEditor.prototype.addHooks.call(this),this.feature&&this.initVertexMarkers(),this},initVertexMarkers:function(t){if(this.enabled())if(t=t||this.getLatLngs(),o(t))this.addVertexMarkers(t);else for(var e=0;e<t.length;e++)this.initVertexMarkers(t[e])},getLatLngs:function(){return this.feature.getLatLngs()},reset:function(){this.editLayer.clearLayers(),this.initVertexMarkers()},addVertexMarker:function(t,e){return new this.tools.options.vertexMarkerClass(t,e,this)},onNewVertex:function(t){this.fireAndForward("editable:vertex:new",{latlng:t.latlng,vertex:t})},addVertexMarkers:function(t){for(var e=0;e<t.length;e++)this.addVertexMarker(t[e],t)},refreshVertexMarkers:function(t){t=t||this.getDefaultLatLngs();for(var e=0;e<t.length;e++)t[e].__vertex.update()},addMiddleMarker:function(t,e,i){return new this.tools.options.middleMarkerClass(t,e,i,this)},onVertexMarkerClick:function(t){if(d.Editable.makeCancellable(t),this.fireAndForward("editable:vertex:click",t),!(t._cancelled||this.tools.drawing()&&this.tools._drawingEditor!==this)){var e,i=t.vertex.getIndex();t.originalEvent.ctrlKey?this.onVertexMarkerCtrlClick(t):t.originalEvent.altKey?this.onVertexMarkerAltClick(t):t.originalEvent.shiftKey?this.onVertexMarkerShiftClick(t):t.originalEvent.metaKey?this.onVertexMarkerMetaKeyClick(t):i===t.vertex.getLastIndex()&&this._drawing===d.Editable.FORWARD?i>=this.MIN_VERTEX-1&&(e=!0):0===i&&this._drawing===d.Editable.BACKWARD&&this._drawnLatLngs.length>=this.MIN_VERTEX?e=!0:0===i&&this._drawing===d.Editable.FORWARD&&this._drawnLatLngs.length>=this.MIN_VERTEX&&this.CLOSED?e=!0:this.onVertexRawMarkerClick(t),this.fireAndForward("editable:vertex:clicked",t),e&&this.commitDrawing(t)}},onVertexRawMarkerClick:function(t){this.fireAndForward("editable:vertex:rawclick",t),t._cancelled||this.vertexCanBeDeleted(t.vertex)&&t.vertex.delete()},vertexCanBeDeleted:function(t){return t.latlngs.length>this.MIN_VERTEX},onVertexDeleted:function(t){this.fireAndForward("editable:vertex:deleted",t)},onVertexMarkerCtrlClick:function(t){this.fireAndForward("editable:vertex:ctrlclick",t)},onVertexMarkerShiftClick:function(t){this.fireAndForward("editable:vertex:shiftclick",t)},onVertexMarkerMetaKeyClick:function(t){this.fireAndForward("editable:vertex:metakeyclick",t)},onVertexMarkerAltClick:function(t){this.fireAndForward("editable:vertex:altclick",t)},onVertexMarkerContextMenu:function(t){this.fireAndForward("editable:vertex:contextmenu",t)},onVertexMarkerMouseDown:function(t){this.fireAndForward("editable:vertex:mousedown",t)},onVertexMarkerMouseOver:function(t){this.fireAndForward("editable:vertex:mouseover",t)},onVertexMarkerMouseOut:function(t){this.fireAndForward("editable:vertex:mouseout",t)},onMiddleMarkerMouseDown:function(t){this.fireAndForward("editable:middlemarker:mousedown",t)},onVertexMarkerDrag:function(t){this.onMove(t),this.feature._bounds&&this.extendBounds(t),this.fireAndForward("editable:vertex:drag",t)},onVertexMarkerDragStart:function(t){this.fireAndForward("editable:vertex:dragstart",t)},onVertexMarkerDragEnd:function(t){this.fireAndForward("editable:vertex:dragend",t)},setDrawnLatLngs:function(t){this._drawnLatLngs=t||this.getDefaultLatLngs()},startDrawing:function(){this._drawnLatLngs||this.setDrawnLatLngs(),d.Editable.BaseEditor.prototype.startDrawing.call(this)},startDrawingForward:function(){this.startDrawing()},endDrawing:function(){this.tools.detachForwardLineGuide(),this.tools.detachBackwardLineGuide(),this._drawnLatLngs&&this._drawnLatLngs.length<this.MIN_VERTEX&&this.deleteShape(this._drawnLatLngs),d.Editable.BaseEditor.prototype.endDrawing.call(this),delete this._drawnLatLngs},addLatLng:function(t){this._drawing===d.Editable.FORWARD?this._drawnLatLngs.push(t):this._drawnLatLngs.unshift(t),this.feature._bounds.extend(t);var e=this.addVertexMarker(t,this._drawnLatLngs);this.onNewVertex(e),this.refresh()},newPointForward:function(t){this.addLatLng(t),this.tools.attachForwardLineGuide(),this.tools.anchorForwardLineGuide(t)},newPointBackward:function(t){this.addLatLng(t),this.tools.anchorBackwardLineGuide(t)},push:function(t){if(!t)return console.error("L.Editable.PathEditor.push expect a valid latlng as parameter");this._drawing===d.Editable.FORWARD?this.newPointForward(t):this.newPointBackward(t)},removeLatLng:function(t){t.__vertex.delete(),this.refresh()},pop:function(){var t;if(!(this._drawnLatLngs.length<=1))return t=this._drawing===d.Editable.FORWARD?this._drawnLatLngs[this._drawnLatLngs.length-1]:this._drawnLatLngs[0],this.removeLatLng(t),this._drawing===d.Editable.FORWARD?this.tools.anchorForwardLineGuide(this._drawnLatLngs[this._drawnLatLngs.length-1]):this.tools.anchorForwardLineGuide(this._drawnLatLngs[0]),t},processDrawingClick:function(t){t.vertex&&t.vertex.editor===this||(this._drawing===d.Editable.FORWARD?this.newPointForward(t.latlng):this.newPointBackward(t.latlng),this.fireAndForward("editable:drawing:clicked",t))},onDrawingMouseMove:function(t){d.Editable.BaseEditor.prototype.onDrawingMouseMove.call(this,t),this._drawing&&(this.tools.moveForwardLineGuide(t.latlng),this.tools.moveBackwardLineGuide(t.latlng))},refresh:function(){this.feature.redraw(),this.onEditing()},newShape:function(t){var e=this.addNewEmptyShape();e&&(this.setDrawnLatLngs(e[0]||e),this.startDrawingForward(),this.fireAndForward("editable:shape:new",{shape:e}),t&&this.newPointForward(t))},deleteShape:function(t,e){var i={shape:t};if(d.Editable.makeCancellable(i),this.fireAndForward("editable:shape:delete",i),!i._cancelled)return t=this._deleteShape(t,e),this.ensureNotFlat&&this.ensureNotFlat(),this.feature.setLatLngs(this.getLatLngs()),this.refresh(),this.reset(),this.fireAndForward("editable:shape:deleted",{shape:t}),t},_deleteShape:function(t,e){if((e=e||this.getLatLngs()).length){var i=this,n=function(t,e){return t.splice(t.indexOf(e),1),t.length||i._deleteShape(t),e};if(e===t)return e.splice(0,Number.MAX_VALUE);for(var r=0;r<e.length;r++){if(e[r]===t)return n(e,t);if(-1!==e[r].indexOf(t))return n(e[r],t)}}},deleteShapeAt:function(t){var e=this.feature.shapeAt(t);if(e)return this.deleteShape(e)},appendShape:function(t){this.insertShape(t)},prependShape:function(t){this.insertShape(t,0)},insertShape:function(t,e){this.ensureMulti(),t=this.formatShape(t),void 0===e&&(e=this.feature._latlngs.length),this.feature._latlngs.splice(e,0,t),this.feature.redraw(),this._enabled&&this.reset()},extendBounds:function(t){this.feature._bounds.extend(t.vertex.latlng)},onDragStart:function(t){this.editLayer.clearLayers(),d.Editable.BaseEditor.prototype.onDragStart.call(this,t)},onDragEnd:function(t){this.initVertexMarkers(),d.Editable.BaseEditor.prototype.onDragEnd.call(this,t)}}),d.Editable.PolylineEditor=d.Editable.PathEditor.extend({startDrawingBackward:function(){this._drawing=d.Editable.BACKWARD,this.startDrawing()},continueBackward:function(t){this.drawing()||(t=t||this.getDefaultLatLngs(),this.setDrawnLatLngs(t),0<t.length&&(this.tools.attachBackwardLineGuide(),this.tools.anchorBackwardLineGuide(t[0])),this.startDrawingBackward())},continueForward:function(t){this.drawing()||(t=t||this.getDefaultLatLngs(),this.setDrawnLatLngs(t),0<t.length&&(this.tools.attachForwardLineGuide(),this.tools.anchorForwardLineGuide(t[t.length-1])),this.startDrawingForward())},getDefaultLatLngs:function(t){return!(t=t||this.feature._latlngs).length||t[0]instanceof d.LatLng?t:this.getDefaultLatLngs(t[0])},ensureMulti:function(){this.feature._latlngs.length&&o(this.feature._latlngs)&&(this.feature._latlngs=[this.feature._latlngs])},addNewEmptyShape:function(){if(this.feature._latlngs.length){var t=[];return this.appendShape(t),t}return this.feature._latlngs},formatShape:function(t){return o(t)?t:t[0]?this.formatShape(t[0]):void 0},splitShape:function(t,e){if(e&&!(e>=t.length-1)){this.ensureMulti();var i=this.feature._latlngs.indexOf(t);if(-1!==i){var n=t.slice(0,e+1),r=t.slice(e);r[0]=d.latLng(r[0].lat,r[0].lng,r[0].alt),this.feature._latlngs.splice(i,1,n,r),this.refresh(),this.reset()}}}}),d.Editable.PolygonEditor=d.Editable.PathEditor.extend({CLOSED:!0,MIN_VERTEX:3,newPointForward:function(t){d.Editable.PathEditor.prototype.newPointForward.call(this,t),this.tools.backwardLineGuide._latlngs.length||this.tools.anchorBackwardLineGuide(t),2===this._drawnLatLngs.length&&this.tools.attachBackwardLineGuide()},addNewEmptyHole:function(t){this.ensureNotFlat();var e=this.feature.shapeAt(t);if(e){var i=[];return e.push(i),i}},newHole:function(t){var e=this.addNewEmptyHole(t);e&&(this.setDrawnLatLngs(e),this.startDrawingForward(),t&&this.newPointForward(t))},addNewEmptyShape:function(){if(this.feature._latlngs.length&&this.feature._latlngs[0].length){var t=[];return this.appendShape(t),t}return this.feature._latlngs},ensureMulti:function(){this.feature._latlngs.length&&o(this.feature._latlngs[0])&&(this.feature._latlngs=[this.feature._latlngs])},ensureNotFlat:function(){this.feature._latlngs.length&&!o(this.feature._latlngs)||(this.feature._latlngs=[this.feature._latlngs])},vertexCanBeDeleted:function(t){var e=this.feature.parentShape(t.latlngs);return 0<d.Util.indexOf(e,t.latlngs)||d.Editable.PathEditor.prototype.vertexCanBeDeleted.call(this,t)},getDefaultLatLngs:function(){return this.feature._latlngs.length||this.feature._latlngs.push([]),this.feature._latlngs[0]},formatShape:function(t){return!o(t)||t[0]&&0===t[0].length?t:[t]}}),d.Editable.RectangleEditor=d.Editable.PathEditor.extend({CLOSED:!0,MIN_VERTEX:4,options:{skipMiddleMarkers:!0},extendBounds:function(t){var e=t.vertex.getIndex(),i=t.vertex.getNext(),n=t.vertex.getPrevious(),r=(e+2)%4,a=t.vertex.latlngs[r],s=new d.LatLngBounds(t.latlng,a);n.latlng.update([t.latlng.lat,a.lng]),i.latlng.update([a.lat,t.latlng.lng]),this.updateBounds(s),this.refreshVertexMarkers()},onDrawingMouseDown:function(t){d.Editable.PathEditor.prototype.onDrawingMouseDown.call(this,t),this.connect();var e=this.getDefaultLatLngs();3===e.length&&e.push(t.latlng);var i=new d.LatLngBounds(t.latlng,t.latlng);this.updateBounds(i),this.updateLatLngs(i),this.refresh(),this.reset(),t.originalEvent._simulated=!1,this.map.dragging._draggable._onUp(t.originalEvent),e[3].__vertex.dragging._draggable._onDown(t.originalEvent)},onDrawingMouseUp:function(t){this.commitDrawing(t),t.originalEvent._simulated=!1,d.Editable.PathEditor.prototype.onDrawingMouseUp.call(this,t)},onDrawingMouseMove:function(t){t.originalEvent._simulated=!1,d.Editable.PathEditor.prototype.onDrawingMouseMove.call(this,t)},getDefaultLatLngs:function(t){return t||this.feature._latlngs[0]},updateBounds:function(t){this.feature._bounds=t},updateLatLngs:function(t){for(var e=this.getDefaultLatLngs(),i=this.feature._boundsToLatLngs(t),n=0;n<e.length;n++)e[n].update(i[n])}}),d.Editable.CircleEditor=d.Editable.PathEditor.extend({MIN_VERTEX:2,options:{skipMiddleMarkers:!0},initialize:function(t,e,i){d.Editable.PathEditor.prototype.initialize.call(this,t,e,i),this._resizeLatLng=this.computeResizeLatLng()},computeResizeLatLng:function(){var t=(this.feature._radius||this.feature._mRadius)*Math.cos(Math.PI/4),e=this.map.project(this.feature._latlng);return this.map.unproject([e.x+t,e.y-t])},updateResizeLatLng:function(){this._resizeLatLng.update(this.computeResizeLatLng()),this._resizeLatLng.__vertex.update()},getLatLngs:function(){return[this.feature._latlng,this._resizeLatLng]},getDefaultLatLngs:function(){return this.getLatLngs()},onVertexMarkerDrag:function(t){1===t.vertex.getIndex()?this.resize(t):this.updateResizeLatLng(t),d.Editable.PathEditor.prototype.onVertexMarkerDrag.call(this,t)},resize:function(t){var e=this.feature._latlng.distanceTo(t.latlng);this.feature.setRadius(e)},onDrawingMouseDown:function(t){d.Editable.PathEditor.prototype.onDrawingMouseDown.call(this,t),this._resizeLatLng.update(t.latlng),this.feature._latlng.update(t.latlng),this.connect(),t.originalEvent._simulated=!1,this.map.dragging._draggable._onUp(t.originalEvent),this._resizeLatLng.__vertex.dragging._draggable._onDown(t.originalEvent)},onDrawingMouseUp:function(t){this.commitDrawing(t),t.originalEvent._simulated=!1,d.Editable.PathEditor.prototype.onDrawingMouseUp.call(this,t)},onDrawingMouseMove:function(t){t.originalEvent._simulated=!1,d.Editable.PathEditor.prototype.onDrawingMouseMove.call(this,t)},onDrag:function(t){d.Editable.PathEditor.prototype.onDrag.call(this,t),this.feature.dragging.updateLatLng(this._resizeLatLng)}});var t={createEditor:function(t){t=t||this._map;var e=(this.options.editOptions||{}).editTools||t.editTools;if(!e)throw Error("Unable to detect Editable instance.");return new(this.options.editorClass||this.getEditorClass(e))(t,this,this.options.editOptions)},enableEdit:function(t){return this.editor||this.createEditor(t),this.editor.enable(),this.editor},editEnabled:function(){return this.editor&&this.editor.enabled()},disableEdit:function(){this.editor&&(this.editor.disable(),delete this.editor)},toggleEdit:function(){this.editEnabled()?this.disableEdit():this.enableEdit()},_onEditableAdd:function(){this.editor&&this.enableEdit()}},e={getEditorClass:function(t){return t&&t.options.polylineEditorClass?t.options.polylineEditorClass:d.Editable.PolylineEditor},shapeAt:function(t,e){var i=null;if(!(e=e||this._latlngs).length)return i;if(o(e)&&this.isInLatLngs(t,e))i=e;else for(var n=0;n<e.length;n++)if(this.isInLatLngs(t,e[n]))return e[n];return i},isInLatLngs:function(t,e){if(!e)return!1;var i,n,r,a,s=[],o=this._clickTolerance();if(this._projectLatlngs(e,s,this._pxBounds),s=s[0],a=this._map.latLngToLayerPoint(t),!this._pxBounds.contains(a))return!1;for(i=1,r=s.length,n=0;i<r;n=i++)if(d.LineUtil.pointToSegmentDistance(a,s[n],s[i])<=o)return!0;return!1}},i={getEditorClass:function(t){return t&&t.options.polygonEditorClass?t.options.polygonEditorClass:d.Editable.PolygonEditor},shapeAt:function(t,e){var i=null;if(!(e=e||this._latlngs).length)return i;if(o(e)&&this.isInLatLngs(t,e))i=e;else if(o(e[0])&&this.isInLatLngs(t,e[0]))i=e;else for(var n=0;n<e.length;n++)if(this.isInLatLngs(t,e[n][0]))return e[n];return i},isInLatLngs:function(t,e){var i,n,r,a,s,o=!1;for(r=0,a=(s=e.length)-1;r<s;a=r++)i=e[r],n=e[a],i.lat>t.lat!=n.lat>t.lat&&t.lng<(n.lng-i.lng)*(t.lat-i.lat)/(n.lat-i.lat)+i.lng&&(o=!o);return o},parentShape:function(t,e){if(e=e||this._latlngs){var i=d.Util.indexOf(e,t);if(-1!==i)return e;for(var n=0;n<e.length;n++)if(-1!==(i=d.Util.indexOf(e[n],t)))return e[n]}}},n={getEditorClass:function(t){return t&&t.options.markerEditorClass?t.options.markerEditorClass:d.Editable.MarkerEditor}},r={getEditorClass:function(t){return t&&t.options.rectangleEditorClass?t.options.rectangleEditorClass:d.Editable.RectangleEditor}},a={getEditorClass:function(t){return t&&t.options.circleEditorClass?t.options.circleEditorClass:d.Editable.CircleEditor}},s=function(){this.on("add",this._onEditableAdd)},o=d.LineUtil.isFlat||d.LineUtil._flat||d.Polyline._flat;d.Polyline&&(d.Polyline.include(t),d.Polyline.include(e),d.Polyline.addInitHook(s)),d.Polygon&&(d.Polygon.include(t),d.Polygon.include(i)),d.Marker&&(d.Marker.include(t),d.Marker.include(n),d.Marker.addInitHook(s)),d.Rectangle&&(d.Rectangle.include(t),d.Rectangle.include(r)),d.Circle&&(d.Circle.include(t),d.Circle.include(a)),d.LatLng.prototype.update=function(t){t=d.latLng(t),this.lat=t.lat,this.lng=t.lng}},window);