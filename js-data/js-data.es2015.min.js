function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var DOMAIN="utils",INFINITY=1/0,MAX_INTEGER=1.7976931348623157e308,BOOL_TAG="[object Boolean]",DATE_TAG="[object Date]",FUNC_TAG="[object Function]",NUMBER_TAG="[object Number]",OBJECT_TAG="[object Object]",REGEXP_TAG="[object RegExp]",STRING_TAG="[object String]",objToString=Object.prototype.toString,PATH=/^(.+)\.(.+)$/,ERRORS={400:function(){return"expected: ".concat(arguments[0],", found: ").concat(arguments[2]?arguments[1]:_typeof(arguments[1]))},404:function(){return"".concat(arguments[0]," not found")}},toInteger=function(t){if(!t)return 0;if((t=+t)===INFINITY||t===-INFINITY)return(t<0?-1:1)*MAX_INTEGER;var e=t%1;return t==t?e?t-e:t:0},toStr=function(t){return objToString.call(t)},isPlainObject=function(t){return!!t&&"object"===_typeof(t)&&t.constructor===Object},mkdirP=function(t,e){return e?(e.split(".").forEach(function(e){t[e]||(t[e]={}),t=t[e]}),t):t},utils={Promise:Promise,_:function(t,e){utils.forOwn(e,function(e,i){i&&void 0===t[i]&&!utils.isFunction(e)&&0!==i.indexOf("_")&&(t[i]=e)})},_forRelation:function(t,e,i,n){var r,o=e.relation,s=null;if(t||(t={}),t.with||(t.with=[]),(r=utils._getIndex(t.with,o))>=0?s=o:(r=utils._getIndex(t.with,e.localField))>=0&&(s=e.localField),t.withAll)i.call(n,e,{});else if(s){var a={};utils.fillIn(a,e.getRelation()),utils.fillIn(a,t),a.with=t.with.slice(),a._activeWith=a.with.splice(r,1)[0],a.with.forEach(function(t,e){t&&0===t.indexOf(s)&&t.length>=s.length&&"."===t[s.length]?a.with[e]=t.substr(s.length+1):a.with[e]=""}),i.call(n,e,a)}},_getIndex:function(t,e){var i=-1;return t.forEach(function(t,n){return t===e?(i=n,!1):utils.isObject(t)&&t.relation===e?(i=n,!1):void 0}),i},addHiddenPropsToTarget:function(t,e){var i={};Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t);n.enumerable=!1,i[t]=n}),Object.defineProperties(t,i)},areDifferent:function(t,e,i){i||(i={});var n=utils.diffObjects(t,e,i);return Object.keys(n.added).length+Object.keys(n.removed).length+Object.keys(n.changed).length>0},classCallCheck:function(t,e){if(!(t instanceof e))throw utils.err("".concat(e.name))(500,"Cannot call a class as a function")},copy:function(t,e,i,n,r,o){if(e){if(t===e)throw utils.err("".concat(DOMAIN,".copy"))(500,"Cannot copy! Source and destination are identical.");if(i=i||[],n=n||[],utils.isObject(t)){var s=i.indexOf(t);if(-1!==s)return n[s];i.push(t),n.push(e)}var a,l;if(utils.isArray(t))for(e.length=0,l=0;l<t.length;l++)a=utils.copy(t[l],null,i,n,r,o),utils.isObject(t[l])&&(i.push(t[l]),n.push(a)),e.push(a);else for(var u in utils.isArray(e)?e.length=0:utils.forOwn(e,function(t,i){delete e[i]}),t)if(Object.hasOwnProperty.call(t,u)){if(utils.isBlacklisted(u,r))continue;a=utils.copy(t[u],null,i,n,r,o),utils.isObject(t[u])&&(i.push(t[u]),n.push(a)),e[u]=a}}else e=t,t&&(utils.isArray(t)?e=utils.copy(t,[],i,n,r,o):utils.isDate(t)?e=new Date(t.getTime()):utils.isRegExp(t)?(e=new RegExp(t.source,t.toString().match(/[^/]*$/)[0])).lastIndex=t.lastIndex:utils.isObject(t)&&(e=o?utils.copy(t,{},i,n,r,o):utils.copy(t,Object.create(Object.getPrototypeOf(t)),i,n,r,o)));return e},deepFillIn:function(t,e){return e&&utils.forOwn(e,function(e,i){var n=t[i];isPlainObject(e)&&isPlainObject(n)?utils.deepFillIn(n,e):Object.hasOwnProperty.call(t,i)&&void 0!==t[i]||(t[i]=e)}),t},deepMixIn:function(t,e){if(e)for(var i in e){var n=e[i],r=t[i];isPlainObject(n)&&isPlainObject(r)?utils.deepMixIn(r,n):t[i]=n}return t},diffObjects:function(t,e,i){i||(i={});var n=i.equalsFn,r=i.ignore,o={added:{},changed:{},removed:{}};utils.isFunction(n)||(n=utils.deepEqual);var s=Object.keys(t).filter(function(t){return!utils.isBlacklisted(t,r)}),a=Object.keys(e).filter(function(t){return!utils.isBlacklisted(t,r)});return s.forEach(function(i){var r=e[i],s=t[i];n(r,s)||(void 0===r?o.added[i]=s:o.changed[i]=s)}),a.forEach(function(i){var n=e[i];void 0===t[i]&&void 0!==n&&(o.removed[i]=void 0)}),o},equal:function(t,e){return t==e},err:function(t,e){return function(i){var n="[".concat(t,":").concat(e,"] "),r=ERRORS[i].apply(null,Array.prototype.slice.call(arguments,1));return r="".concat(n).concat(r,"\nhttp://www.js-data.io/v3.0/docs/errors#").concat(i),new Error(r)}},eventify:function(t,e,i){t=t||this;var n={};e||i||(e=function(){return n},i=function(t){n=t}),Object.defineProperties(t,{emit:{value:function(){for(var t=e.call(this)||{},i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];var o,s=n.shift(),a=t[s]||[];for(o=0;o<a.length;o++)a[o].f.apply(a[o].c,n);for(a=t.all||[],n.unshift(s),o=0;o<a.length;o++)a[o].f.apply(a[o].c,n)}},off:{value:function(t,n){var r=e.call(this)[t];if(r)if(n){for(var o=0;o<r.length;o++)if(r[o].f===n){r.splice(o,1);break}}else r.splice(0,r.length);else i.call(this,{})}},on:{value:function(t,n,r){e.call(this)||i.call(this,{});var o=e.call(this);o[t]=o[t]||[],o[t].push({c:r,f:n})}}})},extend:function(t,e){var i,n=this;t||(t={}),e||(e={}),Object.hasOwnProperty.call(t,"constructor")?(i=t.constructor,delete t.constructor):i=function(){utils.classCallCheck(this,i);for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];n.apply(this,e)},i.prototype=Object.create(n&&n.prototype,{constructor:{configurable:!0,enumerable:!1,value:i,writable:!0}});var r=Object;return r.setPrototypeOf?r.setPrototypeOf(i,n):e.strictEs6Class?i.__proto__=n:utils.forOwn(n,function(t,e){i[e]=t}),Object.hasOwnProperty.call(i,"__super__")||Object.defineProperty(i,"__super__",{configurable:!0,value:n}),utils.addHiddenPropsToTarget(i.prototype,t),utils.fillIn(i,e),i},fillIn:function(t,e){utils.forOwn(e,function(e,i){Object.hasOwnProperty.call(t,i)&&void 0!==t[i]||(t[i]=e)})},findIndex:function(t,e){var i=-1;return t?(t.forEach(function(t,n){if(e(t))return i=n,!1}),i):i},forEachRelation:function(t,e,i,n){var r=t.relationList||[];r.length&&r.forEach(function(t){utils._forRelation(e,t,i,n)})},forOwn:function(t,e,i){var n,r=Object.keys(t),o=r.length;for(n=0;n<o&&!1!==e.call(i,t[r[n]],r[n],t);n++);},fromJson:function(t){return utils.isString(t)?JSON.parse(t):t},get:function(t,e){if(e){for(var i=e.split("."),n=i.pop();e=i.shift();)if(null==(t=t[e]))return;return t[n]}},getSuper:function(t,e){var i=e?t:t.constructor;return Object.hasOwnProperty.call(i,"__super__")?i.__super__:Object.getPrototypeOf(i)||i.__proto__},intersection:function(t,e){if(!t||!e)return[];t=Array.isArray(t)?t:[t],e=Array.isArray(e)?e:[e];var i,n,r=[],o=t.length;for(n=0;n<o;n++)i=t[n],-1===r.indexOf(i)&&-1!==e.indexOf(i)&&r.push(i);return r},isArray:Array.isArray,isBlacklisted:function(t,e){if(!e||!e.length)return!1;for(var i,n=0;n<e.length;n++)if(toStr(e[n])===REGEXP_TAG&&e[n].test(t)||e[n]===t)return!!(i=t);return!!i},isBoolean:function(t){return toStr(t)===BOOL_TAG},isDate:function(t){return t&&"object"===_typeof(t)&&toStr(t)===DATE_TAG},isFunction:function(t){return"function"==typeof t||t&&toStr(t)===FUNC_TAG},isInteger:function(t){return toStr(t)===NUMBER_TAG&&t==toInteger(t)},isNull:function(t){return null===t},isNumber:function(t){var e=_typeof(t);return"number"===e||t&&"object"===e&&toStr(t)===NUMBER_TAG},isObject:function(t){return toStr(t)===OBJECT_TAG},isRegExp:function(t){return toStr(t)===REGEXP_TAG},isSorN:function(t){return utils.isString(t)||utils.isNumber(t)},isString:function(t){return"string"==typeof t||t&&"object"===_typeof(t)&&toStr(t)===STRING_TAG},isUndefined:function(t){return void 0===t},logify:function(t){utils.addHiddenPropsToTarget(t,{dbg:function(){if(utils.isFunction(this.log)){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.log.apply(this,["debug"].concat(e))}},log:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];if(t&&!i.length&&(i.push(t),t="debug"),"debug"!==t||this.debug){var r,o,s="".concat(t.toUpperCase(),": (").concat(this.name||this.constructor.name,")");if(utils.isFunction(console[t]))(r=console)[t].apply(r,[s].concat(i));else(o=console).log.apply(o,[s].concat(i))}}})},noDupeAdd:function(t,e,i){t&&(this.findIndex(t,i)<0&&t.push(e))},omit:function(t,e){var i={};return utils.forOwn(t,function(t,n){-1===e.indexOf(n)&&(i[n]=t)}),i},pick:function(t,e){return e.reduce(function(e,i){return e[i]=t[i],e},{})},plainCopy:function(t){return utils.copy(t,void 0,void 0,void 0,void 0,!0)},reject:function(t){return utils.Promise.reject(t)},remove:function(t,e){if(t&&t.length){var i=this.findIndex(t,e);i>=0&&t.splice(i,1)}},resolve:function(t){return utils.Promise.resolve(t)},set:function(t,e,i){if(utils.isObject(e))utils.forOwn(e,function(e,i){utils.set(t,i,e)});else{var n=PATH.exec(e);n?mkdirP(t,n[1])[n[2]]=i:t[e]=i}},deepEqual:function(t,e){if(t===e)return!0;var i=!0;if(utils.isArray(t)&&utils.isArray(e)){if(t.length!==e.length)return!1;for(var n=t.length;n--;)if(!utils.deepEqual(t[n],e[n]))return!1}else{if(!utils.isObject(t)||!utils.isObject(e))return!1;utils.forOwn(t,function(t,n){if(!(i=utils.deepEqual(t,e[n])))return!1}),i&&utils.forOwn(e,function(e,n){if(!(i=utils.deepEqual(e,t[n])))return!1})}return i},toJson:JSON.stringify,unset:function(t,e){for(var i=e.split("."),n=i.pop();e=i.shift();)if(null==(t=t[e]))return;t[n]=void 0}},safeSetProp=function(t,e,i){t&&t._set?t._set("props.".concat(e),i):utils.set(t,e,i)},safeSetLink=function(t,e,i){t&&t._set?t._set("links.".concat(e),i):utils.set(t,e,i)};function Settable(){var t={};Object.defineProperties(this,{_get:{value:function(e){return utils.get(t,e)}},_set:{value:function(e,i){return utils.set(t,e,i)}},_unset:{value:function(e){return utils.unset(t,e)}}})}function Component(t){Settable.call(this),t||(t={}),this.debug=!!Object.hasOwnProperty.call(t,"debug")&&!!t.debug,Object.defineProperty(this,"_listeners",{value:{},writable:!0})}Settable.extend=utils.extend;var Component$1=Settable.extend({constructor:Component});Component.extend=utils.extend,utils.logify(Component.prototype),utils.eventify(Component.prototype,function(){return this._listeners},function(t){this._listeners=t});var DOMAIN$1="Query",INDEX_ERR="Index inaccessible after first operation",reserved={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:""},escapeRegExp=/([.*+?^=!:${}()|[\]/\\])/g,percentRegExp=/%/g,underscoreRegExp=/_/g,escape=function(t){return t.replace(escapeRegExp,"\\$1")};function Query(t){utils.classCallCheck(this,Query),this.collection=t,this.data=null}var Query$1=Component$1.extend({constructor:Query,_applyWhereFromObject:function(t){var e=[],i=[],n=[];return utils.forOwn(t,function(t,r){utils.isObject(t)||(t={"==":t}),utils.forOwn(t,function(t,o){e.push(r),i.push(o),n.push(t)})}),{fields:e,ops:i,predicates:n}},_applyWhereFromArray:function(t){var e=this,i=[];return t.forEach(function(n,r){if(!utils.isString(n)){var o=t[r-1],s=(utils.isArray(n)?e._applyWhereFromArray:e._applyWhereFromObject).call(e,n);"or"===o&&(s.isOr=!0),i.push(s)}}),i.isArray=!0,i},_testObjectGroup:function(t,e,i,n){var r,o=i.fields,s=i.ops,a=i.predicates,l=s.length;for(r=0;r<l;r++){var u=s[r],c="|"===u.charAt(0);u=c?u.substr(1):u;var f=this.evaluate(utils.get(n,o[r]),u,a[r]);void 0!==f&&(t=e?f:c?t||f:t&&f),e=!1}return{keep:t,first:e}},_testArrayGroup:function(t,e,i,n){var r,o=i.length;for(r=0;r<o;r++){var s=i[r],a=(s.isArray?this._testArrayGroup:this._testObjectGroup).call(this,!0,!0,s,n);t=i[r-1]?s.isOr?t||a.keep:t&&a.keep:a.keep,e=a.first}return{keep:t,first:e}},between:function(t,e,i){if(i||(i={}),this.data)throw utils.err("".concat(DOMAIN$1,"#between"))(500,"Cannot access index");return this.data=this.collection.getIndex(i.index).between(t,e,i),this},compare:function(t,e,i,n){var r=t[e],o=utils.get(i,r[0]),s=utils.get(n,r[0]);if(o&&utils.isString(o)&&(o=o.toUpperCase()),s&&utils.isString(s)&&(s=s.toUpperCase()),void 0===i&&(i=null),void 0===n&&(n=null),"DESC"===r[1].toUpperCase()){var a=s;s=o,o=a}return o<s?-1:o>s?1:e<t.length-1?this.compare(t,e+1,i,n):0},evaluate:function(t,e,i){var n=this.constructor.ops;return n[e]?n[e](t,i):0===e.indexOf("like")?null!==this.like(i,e.substr(4)).exec(t):0===e.indexOf("notLike")?null===this.like(i,e.substr(7)).exec(t):void 0},filter:function(t,e){var i=this;if(t||(t={}),this.getData(),utils.isObject(t)){var n,r={};(utils.isObject(t.where)||utils.isArray(t.where))&&(r=t.where),utils.forOwn(t,function(t,e){e in reserved||e in r||(r[e]={"==":t})}),utils.isObject(r)&&0!==Object.keys(r).length?n=this._applyWhereFromArray([r]):utils.isArray(r)&&(n=this._applyWhereFromArray(r)),n&&(this.data=this.data.filter(function(t,e){return i._testArrayGroup(!0,!0,n,t).keep}));var o=t.orderBy||t.sort;if(utils.isString(o)&&(o=[[o,"ASC"]]),utils.isArray(o)||(o=null),o){o.forEach(function(t,e){utils.isString(t)&&(o[e]=[t,"ASC"])}),this.data.sort(function(t,e){return i.compare(o,0,t,e)})}utils.isNumber(t.skip)?this.skip(t.skip):utils.isNumber(t.offset)&&this.skip(t.offset),utils.isNumber(t.limit)&&this.limit(t.limit)}else utils.isFunction(t)&&(this.data=this.data.filter(t,e));return this},forEach:function(t,e){return this.getData().forEach(t,e),this},get:function(t,e){if(t||(t=[]),e||(e={}),this.data)throw utils.err("".concat(DOMAIN$1,"#get"))(500,INDEX_ERR);return t&&!utils.isArray(t)&&(t=[t]),t.length?(this.data=this.collection.getIndex(e.index).get(t),this):(this.getData(),this)},getAll:function(){var t=this,e={};if(this.data)throw utils.err("".concat(DOMAIN$1,"#getAll"))(500,INDEX_ERR);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];if(!n.length||1===n.length&&utils.isObject(n[0]))return this.getData(),this;n.length&&utils.isObject(n[n.length-1])&&(e=n[n.length-1],n.pop());var o=this.collection.getIndex(e.index);return this.data=[],n.forEach(function(e){t.data=t.data.concat(o.get(e))}),this},getData:function(){return this.data||(this.data=this.collection.index.getAll()),this.data},like:function(t,e){return new RegExp("^".concat(escape(t).replace(percentRegExp,".*").replace(underscoreRegExp,"."),"$"),e)},limit:function(t){if(!utils.isNumber(t))throw utils.err("".concat(DOMAIN$1,"#limit"),"num")(400,"number",t);var e=this.getData();return this.data=e.slice(0,Math.min(e.length,t)),this},map:function(t,e){return this.data=this.getData().map(t,e),this},mapCall:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return this.data=this.getData().map(function(e){return e[t].apply(e,i)}),this},run:function(){var t=this.data;return this.data=null,t},skip:function(t){if(!utils.isNumber(t))throw utils.err("".concat(DOMAIN$1,"#skip"),"num")(400,"number",t);var e=this.getData();return t<e.length?this.data=e.slice(t):this.data=[],this}},{ops:{"=":function(t,e){return t==e},"==":function(t,e){return t==e},"===":function(t,e){return t===e},"!=":function(t,e){return t!=e},"!==":function(t,e){return t!==e},">":function(t,e){return t>e},">=":function(t,e){return t>=e},"<":function(t,e){return t<e},"<=":function(t,e){return t<=e},isectEmpty:function(t,e){return!utils.intersection(t||[],e||[]).length},isectNotEmpty:function(t,e){return utils.intersection(t||[],e||[]).length},in:function(t,e){return-1!==e.indexOf(t)},notIn:function(t,e){return-1===e.indexOf(t)},contains:function(t,e){return-1!==(t||[]).indexOf(e)},notContains:function(t,e){return-1===(t||[]).indexOf(e)}}}),belongsToType="belongsTo",hasManyType="hasMany",hasOneType="hasOne",DOMAIN$2="Relation";function Relation(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};utils.classCallCheck(this,Relation),e.type=this.constructor.TYPE_NAME,this.validateOptions(t,e),"object"===_typeof(t)&&Object.defineProperty(this,"relatedMapper",{value:t}),Object.defineProperty(this,"inverse",{writable:!0}),utils.fillIn(this,e)}Relation.extend=utils.extend,utils.addHiddenPropsToTarget(Relation.prototype,{get canAutoAddLinks(){return void 0===this.add||!!this.add},get relatedCollection(){return this.mapper.datastore.getCollection(this.relation)},validateOptions:function(t,e){var i="new ".concat(DOMAIN$2),n=e.localField;if(!n)throw utils.err(i,"opts.localField")(400,"string",n);var r=e.foreignKey=e.foreignKey||e.localKey;if(!r&&(e.type===belongsToType||e.type===hasOneType))throw utils.err(i,"opts.foreignKey")(400,"string",r);if(utils.isString(t)){if(e.relation=t,!utils.isFunction(e.getRelation))throw utils.err(i,"opts.getRelation")(400,"function",e.getRelation)}else{if(!t)throw utils.err(i,"related")(400,"Mapper or string",t);e.relation=t.name}},assignTo:function(t){this.name=t.name,Object.defineProperty(this,"mapper",{value:t}),t.relationList||Object.defineProperty(t,"relationList",{value:[]}),t.relationFields||Object.defineProperty(t,"relationFields",{value:[]}),t.relationList.push(this),t.relationFields.push(this.localField)},canFindLinkFor:function(){return!(!this.foreignKey&&!this.localKey)},getRelation:function(){return this.relatedMapper},getForeignKey:function(t){return utils.get(t,this.mapper.idAttribute)},setForeignKey:function(t,e){t&&e&&this._setForeignKey(t,e)},_setForeignKey:function(t,e){var i=this,n=this.mapper.idAttribute;utils.isArray(e)||(e=[e]),e.forEach(function(e){utils.set(e,i.foreignKey,utils.get(t,n))})},getLocalField:function(t){return utils.get(t,this.localField)},setLocalField:function(t,e){return utils.set(t,this.localField,e)},getInverse:function(t){return this.inverse||this.findInverseRelation(t),this.inverse},findInverseRelation:function(t){var e=this;this.getRelation().relationList.forEach(function(i){if(i.getRelation()===t&&e.isInversedTo(i)&&e!==i)return e.inverse=i,!0})},isInversedTo:function(t){return!t.foreignKey||t.foreignKey===this.foreignKey},addLinkedRecords:function(t){var e=this,i=this.mapper.datastore;t.forEach(function(t){var n=e.getLocalField(t);utils.isFunction(e.add)?n=e.add(i,e,t):n&&(n=e.linkRecord(t,n)),(!n||utils.isArray(n)&&!n.length)&&e.canFindLinkFor(t)&&(n=e.findExistingLinksFor(t)),n&&e.setLocalField(t,n)})},removeLinkedRecords:function(t,e){var i=this.localField;e.forEach(function(t){utils.set(t,i,void 0)})},linkRecord:function(t,e){var i=utils.get(e,this.mapper.idAttribute);void 0===i?-1===this.relatedCollection.unsaved().indexOf(e)&&this.canAutoAddLinks&&(e=this.relatedCollection.add(e)):e!==this.relatedCollection.get(i)&&(this.setForeignKey(t,e),this.canAutoAddLinks&&(e=this.relatedCollection.add(e)));return e},findExistingLinksByForeignKey:function(t){if(null!=t)return this.relatedCollection.filter(_defineProperty({},this.foreignKey,t))},ensureLinkedDataHasProperType:function(t,e){var i=this.getRelation(),n=this.getLocalField(t);(!utils.isArray(n)||n.length&&!i.is(n[0]))&&n&&!i.is(n)&&utils.set(t,this.localField,i.createRecord(n,e))},isRequiresParentId:function(){return!1},isRequiresChildId:function(){return!1},createChildRecord:function(t,e,i){var n=this;return this.setForeignKey(t,e),this.createLinked(e,i).then(function(e){n.setLocalField(t,e)})},createLinked:function(t,e){var i=utils.isArray(t)?"createMany":"create";return this.getRelation()[i](t,e)}});var BelongsToRelation=Relation.extend({getForeignKey:function(t){return utils.get(t,this.foreignKey)},_setForeignKey:function(t,e){utils.set(t,this.foreignKey,utils.get(e,this.getRelation().idAttribute))},findExistingLinksFor:function(t){if(t){var e=utils.get(t,this.foreignKey);return null!=e?this.relatedCollection.get(e):void 0}},isRequiresParentId:function(){return!0},createParentRecord:function(t,e){var i=this,n=this.getLocalField(t);return this.createLinked(n,e).then(function(e){i.setForeignKey(t,e)})},createChildRecord:function(){throw new Error('"BelongsTo" relation does not support child creation as it cannot have children.')}},{TYPE_NAME:"belongsTo"}),HasManyRelation=Relation.extend({validateOptions:function(t,e){Relation.prototype.validateOptions.call(this,t,e);var i=e.localKeys,n=e.foreignKeys,r=e.foreignKey;if(!r&&!i&&!n)throw utils.err("new Relation","opts.<foreignKey|localKeys|foreignKeys>")(400,"string",r)},canFindLinkFor:function(t){return!!(this.foreignKey||this.foreignKeys||this.localKeys&&utils.get(t,this.localKeys))},linkRecord:function(t,e){var i=this,n=this.relatedCollection,r=this.canAutoAddLinks,o=this.foreignKey,s=this.relatedCollection.unsaved();return e.map(function(e){var a=n.recordId(e);return(void 0===a&&-1===s.indexOf(e)||e!==n.get(a))&&(o&&i.setForeignKey(t,e),r&&(e=n.add(e))),e})},findExistingLinksFor:function(t){var e,i=utils.get(t,this.mapper.idAttribute),n=this.localKeys?utils.get(t,this.localKeys):null;if(void 0!==i&&this.foreignKey?e=this.findExistingLinksByForeignKey(i):this.localKeys&&n?e=this.findExistingLinksByLocalKeys(n):void 0!==i&&this.foreignKeys&&(e=this.findExistingLinksByForeignKeys(i)),e&&e.length)return e},findExistingLinksByLocalKeys:function(t){return this.relatedCollection.filter({where:_defineProperty({},this.relatedCollection.mapper.idAttribute,{in:t})})},findExistingLinksByForeignKeys:function(t){return this.relatedCollection.filter({where:_defineProperty({},this.foreignKeys,{contains:t})})},isRequiresParentId:function(){return!!this.localKeys&&this.localKeys.length>0},isRequiresChildId:function(){return!!this.foreignKey},createParentRecord:function(t,e){var i=this,n=this.getLocalField(t),r=this.getRelation().idAttribute;return this.createLinked(n,e).then(function(e){utils.set(t,i.localKeys,e.map(function(t){return utils.get(t,r)}))})},createLinked:function(t,e){return this.getRelation().createMany(t,e)}},{TYPE_NAME:"hasMany"}),HasOneRelation=Relation.extend({findExistingLinksFor:function(t,e){var i=utils.get(e,t.idAttribute),n=this.findExistingLinksByForeignKey(i);if(n&&n.length)return n[0]},isRequiresChildId:function(){return!0}},{TYPE_NAME:"hasOne"});[BelongsToRelation,HasManyRelation,HasOneRelation].forEach(function(t){Relation[t.TYPE_NAME]=function(e,i){return new t(e,i)}});var belongsTo=function(t,e){return function(i){Relation.belongsTo(t,e).assignTo(i)}},hasMany=function(t,e){return function(i){Relation.hasMany(t,e).assignTo(i)}},hasOne=function(t,e){return function(i){Relation.hasOne(t,e).assignTo(i)}},DOMAIN$3="Record",superMethod=function(t,e){var i=t.datastore;return i&&i[e]?function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return i[e].apply(i,[t.name].concat(r))}:t[e].bind(t)},creatingPath="creating",noValidatePath="noValidate",keepChangeHistoryPath="keepChangeHistory",previousPath="previous";function Record(t,e){utils.classCallCheck(this,Record),Settable.call(this),t||(t={}),e||(e={});var i=this._set,n=this.constructor.mapper;i(creatingPath,!0),i(noValidatePath,!!e.noValidate),i(keepChangeHistoryPath,void 0===e.keepChangeHistory?!n||n.keepChangeHistory:e.keepChangeHistory);var r=n?utils.get(t,n.idAttribute):void 0;void 0!==r&&utils.set(this,n.idAttribute,r),utils.fillIn(this,t),i(creatingPath,!1),void 0!==e.validateOnSet?i(noValidatePath,!e.validateOnSet):n&&void 0!==n.validateOnSet?i(noValidatePath,!n.validateOnSet):i(noValidatePath,!1),i(previousPath,n?n.toJSON(t):utils.plainCopy(t))}var Record$1=Component$1.extend({constructor:Record,_mapper:function(){var t=this.constructor.mapper;if(!t)throw utils.err("".concat(DOMAIN$3,"#_mapper"),"")(404,"mapper");return t},afterLoadRelations:function(){},beforeLoadRelations:function(){},changeHistory:function(){return(this._get("history")||[]).slice()},changes:function(t){return t||(t={}),utils.diffObjects("function"==typeof this.toJSON?this.toJSON(t):this,this._get("previous"),t)},commit:function(t){this._set("changed"),this._set("changing",!1),this._set("history",[]),this._set("previous",this.toJSON(t))},destroy:function(t){t||(t={});var e=this._mapper();return superMethod(e,"destroy")(utils.get(this,e.idAttribute),t)},get:function(t){return utils.get(this,t)},hasChanges:function(t){return!!(this._get("changed")||[]).length||utils.areDifferent("function"==typeof this.toJSON?this.toJSON(t):this,this._get("previous"),t)},isNew:function(t){return void 0===utils.get(this,this._mapper().idAttribute)},isValid:function(t){return!this._mapper().validate(this,t)},removeInverseRelation:function(t,e,i,n){var r=this;if(i.type===hasOneType)safeSetLink(t,i.localField,void 0);else if(i.type===hasManyType){var o=utils.get(t,i.localField);void 0===e?utils.remove(o,function(t){return t===r}):utils.remove(o,function(t){return t===r||e===utils.get(t,n)})}},setupInverseRelation:function(t,e,i,n){var r=this;if(i.type===hasOneType)safeSetLink(t,i.localField,this);else if(i.type===hasManyType){var o=utils.get(t,i.localField);void 0===e?utils.noDupeAdd(o,this,function(t){return t===r}):utils.noDupeAdd(o,this,function(t){return t===r||e===utils.get(t,n)})}},loadRelations:function(t,e){var i,n=this,r=this._mapper();return t||(t=[]),utils.isString(t)&&(t=[t]),e||(e={}),e.with=t,utils._(e,r),e.adapter=r.getAdapterName(e),i=e.op="beforeLoadRelations",utils.resolve(this[i](t,e)).then(function(){i=e.op="loadRelations",r.dbg(i,n,t,e);var o,s=[];return utils.forEachRelation(r,e,function(t,i){var a=t.getRelation();if(i.raw=!1,utils.isFunction(t.load))o=t.load(r,t,n,e);else if("hasMany"===t.type||"hasOne"===t.type)t.foreignKey?o=superMethod(a,"findAll")(_defineProperty({},t.foreignKey,utils.get(n,r.idAttribute)),i).then(function(e){return"hasOne"===t.type?e.length?e[0]:void 0:e}):t.localKeys?o=superMethod(a,"findAll")({where:_defineProperty({},a.idAttribute,{in:utils.get(n,t.localKeys)})}):t.foreignKeys&&(o=superMethod(a,"findAll")({where:_defineProperty({},t.foreignKeys,{contains:utils.get(n,r.idAttribute)})},e));else if("belongsTo"===t.type){var l=utils.get(n,t.foreignKey);utils.isSorN(l)&&(o=superMethod(a,"find")(l,i))}o&&(o=o.then(function(e){t.setLocalField(n,e)}),s.push(o))}),Promise.all(s)}).then(function(){return i=e.op="afterLoadRelations",utils.resolve(n[i](t,e)).then(function(){return n})})},previous:function(t){return t?this._get("previous.".concat(t)):this._get("previous")},revert:function(t){var e=this,i=this._get("previous");t||(t={}),t.preserve||(t.preserve=[]),utils.forOwn(this,function(n,r){r!==e._mapper().idAttribute&&!Object.hasOwnProperty.call(i,r)&&Object.hasOwnProperty.call(e,r)&&-1===t.preserve.indexOf(r)&&delete e[r]}),utils.forOwn(i,function(i,n){-1===t.preserve.indexOf(n)&&(e[n]=i)}),this.commit()},save:function(t){var e=this;t||(t={});var i=this._mapper(),n=utils.get(this,i.idAttribute),r=this,o=function(i){var n=t.raw?i.data:i;return n&&(utils.deepMixIn(e,n),e.commit()),i};if(void 0===n)return superMethod(i,"create")(r,t).then(o);if(t.changesOnly){var s=this.changes(t);r={},utils.fillIn(r,s.added),utils.fillIn(r,s.changed)}return superMethod(i,"update")(n,r,t).then(o)},set:function(t,e,i){utils.isObject(t)&&(i=e),i||(i={}),i.silent&&this._set("silent",!0),utils.set(this,t,e),this._get("eventId")||this._set("silent")},toJSON:function(t){var e=this.constructor.mapper;if(e)return e.toJSON(this,t);var i={};return utils.forOwn(this,function(t,e){i[e]=utils.plainCopy(t)}),i},unset:function(t,e){this.set(t,void 0,e)},validate:function(t){return this._mapper().validate(this,t)}},{creatingPath:creatingPath,noValidatePath:noValidatePath,keepChangeHistoryPath:keepChangeHistoryPath,previousPath:previousPath});function sort(t,e,i){return t===e?0:(i&&(t=i(t),e=i(e)),null===t&&null===e||void 0===t&&void 0===e?-1:null==t?-1:null==e?1:t<e?-1:t>e?1:0)}function insertAt(t,e,i){return t.splice(e,0,i),t}function removeAt(t,e){return t.splice(e,1),t}function binarySearch(t,e,i){for(var n,r,o=0,s=t.length;o<s;){if(0===(n=sort(e,t[r=(o+s)/2|0],i)))return{found:!0,index:r};n<0?s=r:o=r+1}return{found:!1,index:s}}function Index(t,e){if(utils.classCallCheck(this,Index),t||(t=[]),!utils.isArray(t))throw new Error("fieldList must be an array.");e||(e={}),this.fieldList=t,this.fieldGetter=e.fieldGetter,this.hashCode=e.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}utils.eventify(Record.prototype,function(){return this._get("events")},function(t){this._set("events",t)}),utils.addHiddenPropsToTarget(Index.prototype,{set:function(t,e){utils.isArray(t)||(t=[t]);var i=t.shift()||void 0,n=binarySearch(this.keys,i);if(0===t.length)if(n.found){var r=binarySearch(this.values[n.index],e,this.hashCode);r.found||insertAt(this.values[n.index],r.index,e)}else insertAt(this.keys,n.index,i),insertAt(this.values,n.index,[e]);else if(n.found)this.values[n.index].set(t,e);else{insertAt(this.keys,n.index,i);var o=new Index([],{hashCode:this.hashCode});o.set(t,e),insertAt(this.values,n.index,o)}},get:function(t){utils.isArray(t)||(t=[t]);var e=t.shift()||void 0,i=binarySearch(this.keys,e);return 0===t.length?i.found?this.values[i.index].isIndex?this.values[i.index].getAll():this.values[i.index].slice():[]:i.found?this.values[i.index].get(t):[]},getAll:function(t){t||(t={});var e=[],i=this.values;if("desc"===t.order)for(var n=i.length-1;n>=0;n--){var r=i[n];e=r.isIndex?e.concat(r.getAll(t)):e.concat(r)}else for(var o=0;o<i.length;o++){var s=i[o];e=s.isIndex?e.concat(s.getAll(t)):e.concat(s)}return e},visitAll:function(t,e){this.values.forEach(function(i){i.isIndex?i.visitAll(t,e):i.forEach(t,e)})},between:function(t,e,i){i||(i={}),utils.isArray(t)||(t=[t]),utils.isArray(e)||(e=[e]),utils.fillIn(i,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var n=this._between(t,e,i);return i.limit?n.slice(i.offset,i.limit+i.offset):n.slice(i.offset)},_between:function(t,e,i){var n,r=[],o=t.shift(),s=e.shift();if(n=void 0!==o?binarySearch(this.keys,o):{found:!1,index:0},0===t.length){n.found&&!1===i.leftInclusive&&(n.index+=1);for(var a=n.index;a<this.keys.length;a+=1){if(void 0!==s)if(i.rightInclusive){if(this.keys[a]>s)break}else if(this.keys[a]>=s)break;if(r=this.values[a].isIndex?r.concat(this.values[a].getAll()):r.concat(this.values[a]),i.limit&&r.length>=i.limit+i.offset)break}}else for(var l=n.index;l<this.keys.length;l+=1){var u=this.keys[l];if(u>s)break;if(r=this.values[l].isIndex?u===o?r.concat(this.values[l]._between(utils.copy(t),e.map(function(){}),i)):u===s?r.concat(this.values[l]._between(t.map(function(){}),utils.copy(e),i)):r.concat(this.values[l].getAll()):r.concat(this.values[l]),i.limit&&r.length>=i.limit+i.offset)break}return i.limit?r.slice(0,i.limit+i.offset):r},peek:function(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]},clear:function(){this.keys=[],this.values=[]},insertRecord:function(t){var e=this.fieldList.map(function(e){return utils.isFunction(e)?e(t)||void 0:t[e]||void 0});this.set(e,t)},removeRecord:function(t){var e,i=this,n=void 0!==this.hashCode(t);return this.values.forEach(function(r,o){if(r.isIndex){if(r.removeRecord(t))return 0===r.keys.length&&(removeAt(i.keys,o),removeAt(i.values,o)),e=!0,!1}else{var s={};if(void 0!==i.keys[o]&&n)n&&(s=binarySearch(r,t,i.hashCode));else for(var a=r.length-1;a>=0;a--)if(r[a]===t){s={found:!0,index:a};break}if(s.found)return removeAt(r,s.index),0===r.length&&(removeAt(i.keys,o),removeAt(i.values,o)),e=!0,!1}}),e?t:void 0},updateRecord:function(t){void 0!==this.removeRecord(t)&&this.insertRecord(t)}});var noValidatePath$1=Record$1.noValidatePath,DOMAIN$4="Collection",COLLECTION_DEFAULTS={commitOnMerge:!0,emitRecordEvents:!0,idAttribute:"id",onConflict:"merge"};function Collection(t,e){utils.classCallCheck(this,Collection),Component$1.call(this,e),t&&!utils.isArray(t)&&(e=t,t=[]),utils.isString(e)&&(e={idAttribute:e}),t||(t=[]),e||(e={}),Object.defineProperties(this,{mapper:{value:void 0,writable:!0},queryClass:{value:void 0,writable:!0}}),utils.fillIn(this,e),utils.fillIn(this,utils.copy(COLLECTION_DEFAULTS)),this.queryClass||(this.queryClass=Query$1);var i=this.recordId();Object.defineProperties(this,{index:{value:new Index([i],{hashCode:function(t){return utils.get(t,i)}})},indexes:{value:{}}}),(utils.isObject(t)||utils.isArray(t)&&t.length)&&this.add(t)}var Collection$1=Component$1.extend({constructor:Collection,_onRecordEvent:function(){this.emitRecordEvents&&this.emit.apply(this,arguments)},add:function(t,e){var i=this;e||(e={}),utils._(e,this),t=this.beforeAdd(t,e)||t;var n=!1,r=this.recordId();if(!utils.isArray(t)){if(!utils.isObject(t))throw utils.err("".concat(DOMAIN$4,"#add"),"records")(400,"object or array",t);t=[t],n=!0}t=t.map(function(t){var n=i.recordId(t),o=void 0===n?n:i.get(n);if(t===o)return o;if(o){var s=e.onConflict||i.onConflict;if("merge"!==s&&"replace"!==s&&"skip"!==s)throw utils.err("".concat(DOMAIN$4,"#add"),"opts.onConflict")(400,"one of (merge, replace, skip)",s,!0);var a=o._get(noValidatePath$1);e.noValidate&&o._set(noValidatePath$1,!0),"merge"===s?utils.deepMixIn(o,t):"replace"===s&&(utils.forOwn(o,function(e,i){i!==r&&void 0===t[i]&&(o[i]=void 0)}),o.set(t)),e.noValidate&&o._set(noValidatePath$1,a),t=o,e.commitOnMerge&&utils.isFunction(t.commit)&&t.commit(),i.updateIndexes(t)}else t=i.mapper?i.mapper.createRecord(t,e):t,i.index.insertRecord(t),utils.forOwn(i.indexes,function(e,i){e.insertRecord(t)}),t&&utils.isFunction(t.on)&&t.on("all",i._onRecordEvent,i);return t});var o=n?t[0]:t;return e.silent||this.emit("add",o),this.afterAdd(t,e,o)||o},afterAdd:function(){},afterRemove:function(){},afterRemoveAll:function(){},beforeAdd:function(){},beforeRemove:function(){},beforeRemoveAll:function(){},between:function(t,e,i){return this.query().between(t,e,i).run()},createIndex:function(t,e,i){var n=this;utils.isString(t)&&void 0===e&&(e=[t]),i||(i={}),i.hashCode||(i.hashCode=function(t){return n.recordId(t)});var r=this.indexes[t]=new Index(e,i);this.index.visitAll(r.insertRecord,r)},filter:function(t,e){return this.query().filter(t,e).run()},forEach:function(t,e){this.index.visitAll(t,e)},get:function(t){var e=void 0===t?[]:this.query().get(t).run();return e.length?e[0]:void 0},getAll:function(){var t;return(t=this.query()).getAll.apply(t,arguments).run()},getIndex:function(t){var e=t?this.indexes[t]:this.index;if(!e)throw utils.err("".concat(DOMAIN$4,"#getIndex"),t)(404,"index");return e},limit:function(t){return this.query().limit(t).run()},map:function(t,e){var i=[];return this.index.visitAll(function(n){i.push(t.call(e,n))}),i},mapCall:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];var r=[];return this.index.visitAll(function(e){r.push(e[t].apply(e,i))}),r},prune:function(t){return this.removeAll(this.unsaved(),t)},query:function(){return new(0,this.queryClass)(this)},recordId:function(t){return t?utils.get(t,this.recordId()):this.mapper?this.mapper.idAttribute:this.idAttribute},reduce:function(t,e){return this.getAll().reduce(t,e)},remove:function(t,e){e||(e={}),this.beforeRemove(t,e);var i=utils.isSorN(t)?this.get(t):t;return utils.isObject(i)&&(i=this.index.removeRecord(i))&&(utils.forOwn(this.indexes,function(t,e){t.removeRecord(i)}),utils.isFunction(i.off)&&i.off("all",this._onRecordEvent,this),e.silent||this.emit("remove",i)),this.afterRemove(t,e,i)||i},removeAll:function(t,e){var i=this;e||(e={}),this.beforeRemoveAll(t,e);var n=utils.isArray(t)?t.slice():this.filter(t),r=utils.plainCopy(e);return r.silent=!0,n=n.map(function(t){return i.remove(t,r)}).filter(function(t){return t}),e.silent||this.emit("remove",n),this.afterRemoveAll(t,e,n)||n},skip:function(t){return this.query().skip(t).run()},toJSON:function(t){return this.mapCall("toJSON",t)},unsaved:function(t){return this.index.get()},updateIndex:function(t,e){e||(e={}),this.getIndex(e.index).updateRecord(t)},updateIndexes:function(t){this.index.updateRecord(t),utils.forOwn(this.indexes,function(e,i){e.updateRecord(t)})}}),DOMAIN$5="Schema",types={array:utils.isArray,boolean:utils.isBoolean,integer:utils.isInteger,null:utils.isNull,number:utils.isNumber,object:utils.isObject,string:utils.isString},segmentToString=function(t,e){var i="";return t&&(utils.isNumber(t)?i+="[".concat(t,"]"):i+=e?".".concat(t):"".concat(t)),i},makePath=function(t){t||(t={});var e="";return(t.path||[]).forEach(function(t){e+=segmentToString(t,e)}),e+=segmentToString(t.prop,e)},makeError=function(t,e,i){return{expected:e,actual:""+t,path:makePath(i)}},addError=function(t,e,i,n){n.push(makeError(t,e,i))},maxLengthCommon=function(t,e,i,n){var r=i[t];if(e.length>r)return makeError(e.length,"length no more than ".concat(r),n)},minLengthCommon=function(t,e,i,n){var r=i[t];if(e.length<r)return makeError(e.length,"length no less than ".concat(r),n)},validationKeywords={allOf:function(t,e,i){var n=[];return e.allOf.forEach(function(e){n=n.concat(_validate(t,e,i)||[])}),n.length?n:void 0},anyOf:function(t,e,i){var n=!1,r=[];return e.anyOf.forEach(function(e){var o=_validate(t,e,i);o?r=r.concat(o):n=!0}),n?void 0:r},dependencies:function(t,e,i){},enum:function(t,e,i){var n=e.enum;if(-1===utils.findIndex(n,function(e){return utils.deepEqual(e,t)}))return makeError(t,"one of (".concat(n.join(", "),")"),i)},items:function(t,e,i){i||(i={});for(var n=e.items,r=[],o=utils.isArray(n),s=t.length,a=0;a<s;a++)o&&(n=e.items[a]),i.prop=a,r=r.concat(_validate(t[a],n,i)||[]);return r.length?r:void 0},maximum:function(t,e,i){var n=e.maximum,r=e.exclusiveMaximum;if(_typeof(t)===_typeof(n)&&!(r?n>t:n>=t))return makeError(t,r?"no more than nor equal to ".concat(n):"no more than ".concat(n),i)},maxItems:function(t,e,i){if(utils.isArray(t))return maxLengthCommon("maxItems",t,e,i)},maxLength:function(t,e,i){return maxLengthCommon("maxLength",t,e,i)},maxProperties:function(t,e,i){if(utils.isObject(t)){var n=e.maxProperties,r=Object.keys(t).length;return r>n?makeError(r,"no more than ".concat(n," properties"),i):void 0}},minimum:function(t,e,i){var n=e.minimum,r=e.exclusiveMinimum;if(_typeof(t)===_typeof(n)&&!(r?t>n:t>=n))return makeError(t,r?"no less than nor equal to ".concat(n):"no less than ".concat(n),i)},minItems:function(t,e,i){if(utils.isArray(t))return minLengthCommon("minItems",t,e,i)},minLength:function(t,e,i){return minLengthCommon("minLength",t,e,i)},minProperties:function(t,e,i){if(utils.isObject(t)){var n=e.minProperties,r=Object.keys(t).length;return r<n?makeError(r,"no more than ".concat(n," properties"),i):void 0}},multipleOf:function(t,e,i){var n=e.multipleOf;if(utils.isNumber(t)&&t/n%1!=0)return makeError(t,"multipleOf ".concat(n),i)},not:function(t,e,i){if(!_validate(t,e.not,i))return makeError("succeeded","should have failed",i)},oneOf:function(t,e,i){var n=!1,r=[];return e.oneOf.forEach(function(e){var o=_validate(t,e,i);if(o)r=r.concat(o);else{if(n)return r=[makeError("valid against more than one","valid against only one",i)],n=!1,!1;n=!0}}),n?void 0:r},pattern:function(t,e,i){var n=e.pattern;if(utils.isString(t)&&!t.match(n))return makeError(t,n,i)},properties:function(t,e,i){if(i||(i={}),!utils.isArray(t)){var n=void 0===e.additionalProperties||e.additionalProperties,r=[],o=e.properties||{},s=e.patternProperties||{},a=[];utils.forOwn(o,function(e,n){i.prop=n,a=a.concat(_validate(t[n],e,i)||[]),r.push(n)});var l=utils.omit(t,r);utils.forOwn(s,function(e,n){utils.forOwn(l,function(o,s){s.match(n)&&(i.prop=s,a=a.concat(_validate(t[s],e,i)||[]),r.push(s))})});var u=Object.keys(utils.omit(t,r));if(!1===n){if(u.length){var c=i.prop;i.prop="",addError("extra fields: ".concat(u.join(", ")),"no extra fields",i,a),i.prop=c}}else utils.isObject(n)&&u.forEach(function(e){i.prop=e,a=a.concat(_validate(t[e],n,i)||[])});return a.length?a:void 0}},required:function(t,e,i){i||(i={});var n=e.required,r=[];return i.existingOnly||n.forEach(function(e){if(void 0===utils.get(t,e)){var n=i.prop;i.prop=e,addError(void 0,"a value",i,r),i.prop=n}}),r.length?r:void 0},type:function(t,e,i){var n,r=e.type;if(utils.isString(r)&&(r=[r]),r.forEach(function(r){if(types[r](t,e,i))return n=r,!1}),!n)return makeError(null!=t?_typeof(t):""+t,"one of (".concat(r.join(", "),")"),i);var o=typeGroupValidators[n];return o?o(t,e,i):void 0},uniqueItems:function(t,e,i){var n,r,o;if(t&&t.length&&e.uniqueItems)for(r=t.length-1;r>0;r--)for(n=t[r],o=r-1;o>=0;o--)if(utils.deepEqual(n,t[o]))return makeError(n,"no duplicates",i)}},runOps=function(t,e,i,n){var r=[];return t.forEach(function(t){void 0!==i[t]&&(r=r.concat(validationKeywords[t](e,i,n)||[]))}),r.length?r:void 0},ANY_OPS=["enum","type","allOf","anyOf","oneOf","not"],ARRAY_OPS=["items","maxItems","minItems","uniqueItems"],NUMERIC_OPS=["multipleOf","maximum","minimum"],OBJECT_OPS=["maxProperties","minProperties","required","properties","dependencies"],STRING_OPS=["maxLength","minLength","pattern"],validateAny=function(t,e,i){return runOps(ANY_OPS,t,e,i)},_validate=function(t,e,i){var n,r=[];i||(i={}),i.ctx||(i.ctx={value:t,schema:e});var o=i.prop;if(void 0!==e){if(!utils.isObject(e))throw utils.err("".concat(DOMAIN$5,"#validate"))(500,'Invalid schema at path: "'.concat(i.path,'"'));return void 0===i.path&&(i.path=[]),void 0!==i.prop&&(n=!0,i.path.push(i.prop),i.prop=void 0),e.extends&&(r=utils.isFunction(e.extends.validate)?r.concat(e.extends.validate(t,i)||[]):r.concat(_validate(t,e.extends,i)||[])),void 0===t?(!0!==e.required||i.existingOnly||addError(t,"a value",i,r),n&&(i.path.pop(),i.prop=o),r.length?r:void 0):(r=r.concat(validateAny(t,e,i)||[]),n&&(i.path.pop(),i.prop=o),r.length?r:void 0)}},changingPath="changing",changedPath="changed",changeHistoryPath="history",creatingPath$1="creating",eventIdPath="eventId",noValidatePath$2="noValidate",keepChangeHistoryPath$1="keepChangeHistory",silentPath="silent",validationFailureMsg="validation failed",typeGroupValidators={array:function(t,e,i){return runOps(ARRAY_OPS,t,e,i)},integer:function(t,e,i){return typeGroupValidators.numeric(t,e,i)},number:function(t,e,i){return typeGroupValidators.numeric(t,e,i)},numeric:function(t,e,i){return runOps(NUMERIC_OPS,t,e,i)},object:function(t,e,i){return runOps(OBJECT_OPS,t,e,i)},string:function(t,e,i){return runOps(STRING_OPS,t,e,i)}};function Schema(t){var e=this;t||(t={}),utils.fillIn(this,t),"object"===this.type?(this.properties=this.properties||{},utils.forOwn(this.properties,function(t,i){t instanceof Schema||(e.properties[i]=new Schema(t))})):"array"!==this.type||!this.items||this.items instanceof Schema||(this.items=new Schema(this.items)),!this.extends||this.extends instanceof Schema||(this.extends=new Schema(this.extends)),["allOf","anyOf","oneOf"].forEach(function(t){e[t]&&e[t].forEach(function(i,n){i instanceof Schema||(e[t][n]=new Schema(i))})})}var Schema$1=Component$1.extend({constructor:Schema,apply:function(t,e){var i=this;e||(e={}),e.getter||(e.getter="_get"),e.setter||(e.setter="_set"),e.unsetter||(e.unsetter="_unset"),e.track||(e.track=this.track);var n=this.properties||{};utils.forOwn(n,function(n,r){Object.defineProperty(t,r,i.makeDescriptor(r,n,e))})},applyDefaults:function(t){if(t){var e=this.properties||{},i=utils.isFunction(t.set)||utils.isFunction(t._set);utils.forOwn(e,function(e,n){if(Object.hasOwnProperty.call(e,"default")&&void 0===utils.get(t,n)&&(i?t.set(n,utils.plainCopy(e.default),{silent:!0}):utils.set(t,n,utils.plainCopy(e.default))),"object"===e.type&&e.properties){if(i){var r=t._get("noValidate");t._set("noValidate",!0),utils.set(t,n,utils.get(t,n)||{},{silent:!0}),t._set("noValidate",r)}else utils.set(t,n,utils.get(t,n)||{});e.applyDefaults(utils.get(t,n))}})}},makeDescriptor:function(t,e,i){var n={configurable:!0,enumerable:void 0===e.enumerable||!!e.enumerable},r="props.".concat(t),o="previous.".concat(t),s=i.getter,a=i.setter,l=i.unsetter,u=utils.isBoolean(i.track)?i.track:e.track;if(n.get=function(){return this._get(r)},utils.isFunction(e.get)){var c=n.get;n.get=function(){return e.get.call(this,c)}}if(n.set=function(i){var n=this,c=this[s],f=this[a],h=this[l];if(!c(noValidatePath$2)){var d=e.validate(i,{path:[t]});if(d){var p=new Error(validationFailureMsg);throw p.errors=d,p}}if(u&&!c(creatingPath$1)){var v=c(o),g=c(r),y=c(changingPath),m=c(changedPath);y||(m=[]);var A=m.indexOf(t);g!==i&&-1===A&&m.push(t),v===i&&A>=0&&m.splice(A,1),m.length||(y=!1,h(changingPath),h(changedPath),c(eventIdPath)&&(clearTimeout(c(eventIdPath)),h(eventIdPath))),!y&&m.length&&(f(changedPath,m),f(changingPath,!0),f(eventIdPath,setTimeout(function(){if(h(changedPath),h(eventIdPath),h(changingPath),!c(silentPath)){var e;for(e=0;e<m.length;e++)n.emit("change:"+m[e],n,utils.get(n,m[e]));var r=utils.diffObjects(_defineProperty({},t,i),_defineProperty({},t,g));if(c(keepChangeHistoryPath$1)){var o=utils.plainCopy(r);o.timestamp=(new Date).getTime();var s=c(changeHistoryPath);!s&&f(changeHistoryPath,s=[]),s.push(o)}n.emit("change",n,r)}h(silentPath)},0)))}return f(r,i),i},utils.isFunction(e.set)){var f=n.set;n.set=function(t){return e.set.call(this,t,f)}}return n},pick:function(t){var e=this;if(void 0!==t){if("object"===this.type){var i={},n=this.properties;if(n&&utils.forOwn(n,function(e,n){i[n]=e.pick(t[n])}),this.extends&&utils.fillIn(i,this.extends.pick(t)),this.additionalProperties)for(var r in t)n[r]||(i[r]=utils.plainCopy(t[r]));return i}return"array"===this.type?t.map(function(t){var i=e.items?e.items.pick(t):{};return e.extends&&utils.fillIn(i,e.extends.pick(t)),i}):utils.plainCopy(t)}},validate:function(t,e){return _validate(t,this,e)}},{ANY_OPS:ANY_OPS,ARRAY_OPS:ARRAY_OPS,NUMERIC_OPS:NUMERIC_OPS,OBJECT_OPS:OBJECT_OPS,STRING_OPS:STRING_OPS,typeGroupValidators:typeGroupValidators,types:types,validate:_validate,validationKeywords:validationKeywords}),DOMAIN$6="Mapper",applyDefaultsHooks=["beforeCreate","beforeCreateMany"],validatingHooks=["beforeCreate","beforeCreateMany","beforeUpdate","beforeUpdateAll","beforeUpdateMany"],makeNotify=function(t){return function(){for(var e=this,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];var o=n[n.length-t],s=o.op;if(this.dbg.apply(this,[s].concat(n)),-1!==applyDefaultsHooks.indexOf(s)&&!1!==o.applyDefaults){var a=this.getSchema();if(a&&a.applyDefaults){var l=n[0];utils.isArray(l)||(l=[l]),l.forEach(function(t){a.applyDefaults(t)})}}if(-1!==validatingHooks.indexOf(s)&&!o.noValidate){var u=o.existingOnly;0===s.indexOf("beforeUpdate")&&void 0===o.existingOnly&&(o.existingOnly=!0);var c=this.validate(n["beforeUpdate"===s?1:0],utils.pick(o,["existingOnly"]));if(o.existingOnly=u,c){var f=new Error("validation failed");return f.errors=c,utils.reject(f)}}(o.notify||void 0===o.notify&&this.notify)&&setTimeout(function(){e.emit.apply(e,[s].concat(n))})}},notify=makeNotify(1),notify2=makeNotify(2),LIFECYCLE_METHODS={count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function(t,e,i,n){return[e,t.toJSON(i,n),n]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function(t,e,i,n){return[t.toJSON(e,n),i,n]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function(t,e,i){return[e.map(function(e){return t.toJSON(e,i)}),i]},beforeAssign:0,defaults:[[],{}],types:[]}},MAPPER_DEFAULTS={_adapters:{},applyDefaults:!0,applySchema:!0,defaultAdapter:"http",idAttribute:"id",keepChangeHistory:!0,notify:!0,noValidate:!1,raw:!1,validateOnSet:!0};function Mapper(t){if(utils.classCallCheck(this,Mapper),Component$1.call(this),t||(t={}),Object.defineProperties(this,{_adapters:{value:void 0,writable:!0},datastore:{value:void 0,writable:!0},lifecycleMethods:{value:LIFECYCLE_METHODS},recordClass:{value:void 0,writable:!0},schema:{value:void 0,writable:!0}}),utils.fillIn(this,t),utils.fillIn(this,utils.copy(MAPPER_DEFAULTS)),!this.name)throw utils.err("new ".concat(DOMAIN$6),"opts.name")(400,"string",this.name);if(this.schema&&(this.schema.type||(this.schema.type="object"),this.schema instanceof Schema$1||(this.schema=new Schema$1(this.schema||{type:"object"}))),void 0===this.recordClass){var e=Record$1;this.recordClass=e.extend({constructor:(i=function(t,n){utils.classCallCheck(this,i),e.call(this,t,n)},i)})}var i;this.recordClass&&(this.recordClass.mapper=this,utils.isObject(this.methods)&&utils.addHiddenPropsToTarget(this.recordClass.prototype,this.methods),Object.isPrototypeOf.call(Record$1,this.recordClass)&&this.schema&&this.schema.apply&&this.applySchema&&this.schema.apply(this.recordClass.prototype))}var Mapper$1=Component$1.extend({constructor:Mapper,afterCount:notify2,afterCreate:notify2,afterCreateMany:notify2,afterDestroy:notify2,afterDestroyAll:notify2,afterFind:notify2,afterFindAll:notify2,afterSum:notify2,afterUpdate:notify2,afterUpdateAll:notify2,afterUpdateMany:notify2,beforeCreate:notify,beforeCreateMany:notify,beforeCount:notify,beforeDestroy:notify,beforeDestroyAll:notify,beforeFind:notify,beforeFindAll:notify,beforeSum:notify,beforeUpdate:notify,beforeUpdateAll:notify,beforeUpdateMany:notify,_end:function(t,e,i){if(e.raw&&utils._(t,e),i)return t;var n=e.raw?t.data:t;return n&&utils.isFunction(this.wrap)&&(n=this.wrap(n,e),e.raw?t.data=n:t=n),t},belongsTo:function(t,e){return belongsTo(t,e)(this)},count:function(t,e){return this.crud("count",t,e)},create:function(t,e){var i=this;t||(t={}),e||(e={});var n=t,r={},o={};return utils._(e,this),e.adapter=this.getAdapterName(e),e.op="beforeCreate",this._runHook(e.op,t,e).then(function(n){return t=void 0!==n?n:t,e.with||(e.with=[]),i._createParentRecordIfRequired(t,e)}).then(function(t){r=t}).then(function(){return e.op="create",i._invokeAdapterMethod(e.op,t,e)}).then(function(t){o=t}).then(function(){var n=e.raw?o.data:o;return i._createOrAssignChildRecordIfRequired(n,{opts:e,parentRelationMap:r,originalProps:t})}).then(function(t){return i._commitChanges(n,t)}).then(function(n){e.raw?o.data=n:o=n;var r=i._end(o,e);return e.op="afterCreate",i._runHook(e.op,t,e,r)})},_commitChanges:function(t,e){var i=this;return utils.isArray(t)?t.map(function(t,n){return i._commitChanges(t,e[n])}):(utils.set(t,e,{silent:!0}),utils.isFunction(t.commit)&&t.commit(),t)},createInstance:function(t,e){return this.createRecord(t,e)},_createParentRecordIfRequired:function(t,e){var i=[],n=[];return utils.forEachRelation(this,e,function(e,r){e.isRequiresParentId()&&e.getLocalField(t)&&(r.raw=!1,n.push(e),i.push(e.createParentRecord(t,r)))}),utils.Promise.all(i).then(function(t){return n.reduce(function(e,i,n){return i.setLocalField(e,t[n]),e},{})})},_createOrAssignChildRecordIfRequired:function(t,e){var i=[];return utils.forEachRelation(this,e.opts,function(n,r){var o=n.getLocalField(e.originalProps);if(o)if(r.raw=!1,n.isRequiresChildId())i.push(n.createChildRecord(t,o,r));else if(n.isRequiresParentId()){var s=n.getLocalField(e.parentRelationMap);s&&n.setLocalField(t,s)}}),utils.Promise.all(i).then(function(){return t})},createMany:function(t,e){var i=this;t||(t=[]),e||(e={});var n,r=t;return utils._(e,this),e.adapter=this.getAdapterName(e),e.op="beforeCreateMany",this._runHook(e.op,t,e).then(function(o){t=void 0!==o?o:t;var s={};e.with||(e.with=[]);var a=[];return utils.forEachRelation(i,e,function(e,i){var n=t.map(function(t){return e.getLocalField(t)}).filter(Boolean);e.type===belongsToType&&n.length===t.length&&(i.raw=!1,a.push(e.createLinked(n,i).then(function(i){t.forEach(function(t,n){return e.setForeignKey(t,i[n])})}).then(function(t){e.setLocalField(s,t)})))}),utils.Promise.all(a).then(function(){return e.op="createMany",i._invokeAdapterMethod(e.op,t,e)}).then(function(t){n=t}).then(function(){var o=e.raw?n.data:n;return a=[],utils.forEachRelation(i,e,function(e,n){var r=t.map(function(t){return e.getLocalField(t)}).filter(Boolean);if(r.length===t.length){n.raw=!1;var l,u=e.getLocalField(s);e.type===hasManyType?i.log("warn","deep createMany of hasMany type not supported!"):e.type===hasOneType?(o.forEach(function(t,i){e.setForeignKey(t,r[i])}),l=e.getRelation().createMany(r,n).then(function(t){o.forEach(function(i,n){e.setLocalField(i,t[n])})})):e.type===belongsToType&&u&&u.length===o.length&&o.forEach(function(t,i){e.setLocalField(t,u[i])}),l&&a.push(l)}}),utils.Promise.all(a).then(function(){return i._commitChanges(r,o)})})}).then(function(t){e.raw?n.data=t:n=t;var r=i._end(n,e);return e.op="afterCreateMany",i._runHook(e.op,t,e,r)})},createRecord:function(t,e){var i=this;if(t||(t={}),utils.isArray(t))return t.map(function(t){return i.createRecord(t,e)});if(!utils.isObject(t))throw utils.err("".concat(DOMAIN$6,"#createRecord"),"props")(400,"array or object",t);this.relationList&&this.relationList.forEach(function(i){i.ensureLinkedDataHasProperType(t,e)});var n=this.recordClass;return!n||t instanceof n?t:new n(t,e)},crud:function(t){for(var e=this,i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];var o=this.lifecycleMethods[t];if(!o)throw utils.err("".concat(DOMAIN$6,"#crud"),t)(404,"method");var s,a="".concat(t.charAt(0).toUpperCase()).concat(t.substr(1)),l="before".concat(a),u="after".concat(a);o.defaults.forEach(function(t,e){void 0===n[e]&&(n[e]=utils.copy(t))});var c=n[n.length-1];utils._(c,this);var f=c.adapter=this.getAdapterName(c);return s=c.op=l,utils.resolve(this[s].apply(this,_toConsumableArray(n))).then(function(i){var r;return void 0!==n[o.beforeAssign]&&(n[o.beforeAssign]=void 0===i?n[o.beforeAssign]:i),s=c.op=t,n=o.adapterArgs?o.adapterArgs.apply(o,[e].concat(_toConsumableArray(n))):n,e.dbg.apply(e,[s].concat(_toConsumableArray(n))),utils.resolve((r=e.getAdapter(f))[s].apply(r,[e].concat(_toConsumableArray(n))))}).then(function(t){var i=/find/.test(s)||c.noValidate,r=Object.assign({},c,{noValidate:i});return t=e._end(t,r,!!o.skip),n.push(t),s=c.op=u,utils.resolve(e[s].apply(e,_toConsumableArray(n))).then(function(e){return void 0===e?t:e})})},destroy:function(t,e){return this.crud("destroy",t,e)},destroyAll:function(t,e){return this.crud("destroyAll",t,e)},find:function(t,e){return this.crud("find",t,e)},findAll:function(t,e){return this.crud("findAll",t,e)},getAdapter:function(t){this.dbg("getAdapter","name:",t);var e=this.getAdapterName(t);if(!e)throw utils.err("".concat(DOMAIN$6,"#getAdapter"),"name")(400,"string",t);return this.getAdapters()[e]},getAdapterName:function(t){return t||(t={}),utils.isString(t)&&(t={adapter:t}),t.adapter||t.defaultAdapter},getAdapters:function(){return this._adapters},getSchema:function(){return this.schema},hasMany:function(t,e){return hasMany(t,e)(this)},hasOne:function(t,e){return hasOne(t,e)(this)},is:function(t){var e=this.recordClass;return!!e&&t instanceof e},registerAdapter:function(t,e,i){i||(i={}),this.getAdapters()[t]=e,(!0===i||i.default)&&(this.defaultAdapter=t)},_runHook:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];var r=0===t.indexOf("after")?i.length-1:0;return utils.resolve(this[t].apply(this,i)).then(function(t){return void 0===t?i[r]:t})},_invokeAdapterMethod:function(t,e,i){var n,r=this,o={with:i.pass||[]};return this.dbg(i.op,e,i),n=utils.isArray(e)?e.map(function(t){return r.toJSON(t,o)}):this.toJSON(e,o),this.getAdapter(i.adapter)[t](this,n,i)},sum:function(t,e,i){return this.crud("sum",t,e,i)},toJSON:function(t,e){var i,n=this;if(e||(e={}),utils.isArray(t))return t.map(function(t){return n.toJSON(t,e)});i=t;var r=(this?this.relationFields:[])||[],o={};if(this&&this.schema)o=this.schema.pick(i);else for(var s in i)-1===r.indexOf(s)&&(o[s]=utils.plainCopy(i[s]));return this&&e.withAll&&(e.with=r.slice()),this&&e.with&&(utils.isString(e.with)&&(e.with=[e.with]),utils.forEachRelation(this,e,function(t,e){var n=t.getLocalField(i);n&&(utils.isArray(n)?t.setLocalField(o,n.map(function(i){return t.getRelation().toJSON(i,e)})):t.setLocalField(o,t.getRelation().toJSON(n,e)))})),o},update:function(t,e,i){return this.crud("update",t,e,i)},updateAll:function(t,e,i){return this.crud("updateAll",t,e,i)},updateMany:function(t,e){return this.crud("updateMany",t,e)},validate:function(t,e){e||(e={});var i=this.getSchema();if(i){var n=utils.pick(e,["existingOnly"]);if(utils.isArray(t)){var r=t.map(function(t){return i.validate(t,utils.pick(n,["existingOnly"]))});return r.some(Boolean)?r:void 0}return i.validate(t,n)}},wrap:function(t,e){return this.createRecord(t,e)},defineRelations:function(){var t=this;utils.forOwn(this.relations,function(e,i){utils.forOwn(e,function(e,n){utils.isObject(e)&&(e=[e]),e.forEach(function(e){var r=t.datastore.getMapperByName(n)||n;if(e.getRelation=function(){return t.datastore.getMapper(n)},"function"!=typeof Relation[i])throw utils.err(DOMAIN$6,"defineRelations")(400,"relation type (hasOne, hasMany, etc)",i,!0);t[i](r,e)})})})}}),DOMAIN$7="Container",proxiedMapperMethods=["count","create","createMany","createRecord","destroy","destroyAll","find","findAll","getSchema","is","sum","toJSON","update","updateAll","updateMany","validate"];function Container(t){utils.classCallCheck(this,Container),Component$1.call(this),t||(t={}),Object.defineProperties(this,{_adapters:{value:{}},_mappers:{value:{}},mapperClass:{value:void 0,writable:!0}}),utils.fillIn(this,t),this.mapperDefaults=this.mapperDefaults||{},this.mapperClass||(this.mapperClass=Mapper$1)}var props={constructor:Container,_onMapperEvent:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];var r=i.shift();this.emit.apply(this,[r,t].concat(i))},as:function(t){var e={},i=this;return proxiedMapperMethods.forEach(function(n){e[n]={writable:!0,value:function(){for(var e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return i[n].apply(i,[t].concat(r))}}}),e.getMapper={writable:!0,value:function(){return i.getMapper(t)}},Object.create(this,e)},defineMapper:function(t,e){var i=this;if(utils.isObject(t)&&(t=(e=t).name),!utils.isString(t))throw utils.err("".concat(DOMAIN$7,"#defineMapper"),"name")(400,"string",t);e||(e={}),e.name=t,e.relations||(e.relations={});var n=e.mapperClass||this.mapperClass;delete e.mapperClass,utils.fillIn(e,this.mapperDefaults);var r=this._mappers[t]=new n(e);return r.relations||(r.relations={}),r.name=t,r._adapters=this.getAdapters(),r.datastore=this,r.on("all",function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return i._onMapperEvent.apply(i,[t].concat(n))}),r.defineRelations(),r},defineResource:function(t,e){return console.warn("DEPRECATED: defineResource is deprecated, use defineMapper instead"),this.defineMapper(t,e)},getAdapter:function(t){var e=this.getAdapterName(t);if(!e)throw utils.err("".concat(DOMAIN$7,"#getAdapter"),"name")(400,"string",t);return this.getAdapters()[e]},getAdapterName:function(t){return t||(t={}),utils.isString(t)&&(t={adapter:t}),t.adapter||this.mapperDefaults.defaultAdapter},getAdapters:function(){return this._adapters},getMapper:function(t){var e=this.getMapperByName(t);if(!e)throw utils.err("".concat(DOMAIN$7,"#getMapper"),t)(404,"mapper");return e},getMapperByName:function(t){return this._mappers[t]},registerAdapter:function(t,e,i){i||(i={}),this.getAdapters()[t]=e,(!0===i||i.default)&&(this.mapperDefaults.defaultAdapter=t,utils.forOwn(this._mappers,function(e){e.defaultAdapter=t}))}};proxiedMapperMethods.forEach(function(t){props[t]=function(e){for(var i,n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return(i=this.getMapper(e))[t].apply(i,r)}}),Component$1.extend(props);var DOMAIN$8="SimpleStore",proxiedCollectionMethods=["add","between","createIndex","filter","get","getAll","prune","query","toJSON","unsaved"],ownMethodsForScoping=["addToCache","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hashQuery"],cachedFn=function(t,e,i){var n=this._completedQueries[t][e];return utils.isFunction(n)?n(t,e,i):n},SIMPLESTORE_DEFAULTS={usePendingFind:!0,usePendingFindAll:!0};function SimpleStore(t){utils.classCallCheck(this,SimpleStore),t||(t={}),utils.fillIn(t,SIMPLESTORE_DEFAULTS),Container.call(this,t),this.collectionClass=this.collectionClass||Collection$1,this._collections={},this._pendingQueries={},this._completedQueries={}}var props$1={constructor:SimpleStore,_end:function(t,e,i){var n=i.raw?e.data:e;return n&&utils.isFunction(this.addToCache)&&(n=this.addToCache(t,n,i),i.raw?e.data=n:e=n),e},_onCollectionEvent:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];var r=i.shift();this.emit.apply(this,[r,t].concat(i))},addToCache:function(t,e,i){return this.getCollection(t).add(e,i)},as:function(t){var e={},i=this;return ownMethodsForScoping.concat(proxiedMapperMethods).concat(proxiedCollectionMethods).forEach(function(n){e[n]={writable:!0,value:function(){for(var e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return i[n].apply(i,[t].concat(r))}}}),e.getMapper={writable:!0,value:function(){return i.getMapper(t)}},e.getCollection={writable:!0,value:function(){return i.getCollection(t)}},Object.create(this,e)},cachedFind:cachedFn,cachedFindAll:cachedFn,cacheFind:function(t,e,i,n){var r=this;this._completedQueries[t][i]=function(t,e,i){return r.get(t,e)}},cacheFindAll:function(t,e,i,n){var r=this;this._completedQueries[t][i]=function(t,e,i){return r.filter(t,utils.fromJson(e))}},clear:function(){var t=this,e={};return utils.forOwn(this._collections,function(i,n){e[n]=i.removeAll(),t._completedQueries[n]={}}),e},create:function(t,e,i){var n=this;return i||(i={}),Container.prototype.create.call(this,t,e,i).then(function(e){return n._end(t,e,i)})},createMany:function(t,e,i){var n=this;return i||(i={}),Container.prototype.createMany.call(this,t,e,i).then(function(e){return n._end(t,e,i)})},defineMapper:function(t,e){var i=this,n=Container.prototype.defineMapper.call(i,t,e);i._pendingQueries[t]={},i._completedQueries[t]={},n.relationList||Object.defineProperty(n,"relationList",{value:[]});var r={_added:{},datastore:i,mapper:n};e&&"onConflict"in e&&(r.onConflict=e.onConflict);var o=i._collections[t]=new i.collectionClass(null,r),s=(n.schema||{}).properties||{};return utils.forOwn(s,function(t,e){t.indexed&&o.createIndex(e)}),o.createIndex("addedTimestamps",["$"],{fieldGetter:function(t){return o._added[o.recordId(t)]}}),o.on("all",function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];i._onCollectionEvent.apply(i,[t].concat(n))}),n},destroy:function(t,e,i){var n=this;return i||(i={}),Container.prototype.destroy.call(this,t,e,i).then(function(r){var o=n.getCollection(t).remove(e,i);return i.raw?r.data=o:r=o,delete n._pendingQueries[t][e],delete n._completedQueries[t][e],r})},destroyAll:function(t,e,i){var n=this;return i||(i={}),Container.prototype.destroyAll.call(this,t,e,i).then(function(r){var o=n.getCollection(t).removeAll(e,i);i.raw?r.data=o:r=o;var s=n.hashQuery(t,e,i);return delete n._pendingQueries[t][s],delete n._completedQueries[t][s],r})},eject:function(t,e,i){return console.warn('DEPRECATED: "eject" is deprecated, use "remove" instead'),this.remove(t,e,i)},ejectAll:function(t,e,i){return console.warn('DEPRECATED: "ejectAll" is deprecated, use "removeAll" instead'),this.removeAll(t,e,i)},find:function(t,e,i){var n=this;i||(i={});var r=this.getMapper(t),o=this._pendingQueries[t][e],s=void 0===i.usePendingFind?this.usePendingFind:i.usePendingFind;if(utils._(i,r),o&&(utils.isFunction(s)?s.call(this,t,e,i):s))return o;var a=this.cachedFind(t,e,i);return i.force||!a?(this._pendingQueries[t][e]=Container.prototype.find.call(this,t,e,i)).then(function(r){return delete n._pendingQueries[t][e],r=n._end(t,r,i),n.cacheFind(t,r,e,i),r},function(i){return delete n._pendingQueries[t][e],utils.reject(i)}):utils.resolve(a)},findAll:function(t,e,i){var n=this;i||(i={});var r=this.getMapper(t),o=this.hashQuery(t,e,i),s=this._pendingQueries[t][o],a=void 0===i.usePendingFindAll?this.usePendingFindAll:i.usePendingFindAll;if(utils._(i,r),s&&(utils.isFunction(a)?a.call(this,t,e,i):a))return s;var l=this.cachedFindAll(t,o,i);return i.force||!l?(this._pendingQueries[t][o]=Container.prototype.findAll.call(this,t,e,i)).then(function(e){return delete n._pendingQueries[t][o],e=n._end(t,e,i),n.cacheFindAll(t,e,o,i),e},function(e){return delete n._pendingQueries[t][o],utils.reject(e)}):utils.resolve(l)},getCollection:function(t){var e=this._collections[t];if(!e)throw utils.err("".concat(DOMAIN$8,"#getCollection"),t)(404,"collection");return e},hashQuery:function(t,e,i){return utils.toJson(e||{})},inject:function(t,e,i){return console.warn('DEPRECATED: "inject" is deprecated, use "add" instead'),this.add(t,e,i)},remove:function(t,e,i){var n=this.getCollection(t).remove(e,i);return n&&this.removeRelated(t,[n],i),n},removeAll:function(t,e,i){e&&Object.keys(e).length?this._completedQueries[t][this.hashQuery(t,e,i)]=void 0:this._completedQueries[t]={};var n=this.getCollection(t).removeAll(e,i);return n.length&&this.removeRelated(t,n,i),n},removeRelated:function(t,e,i){var n=this;utils.isArray(e)||(e=[e]),utils.forEachRelation(this.getMapper(t),i,function(t,i){e.forEach(function(e){var r,o;if(!t.foreignKey||t.type!==hasOneType&&t.type!==hasManyType?t.type===hasManyType&&t.localKeys?o={where:_defineProperty({},t.getRelation().idAttribute,{in:utils.get(e,t.localKeys)})}:t.type===hasManyType&&t.foreignKeys?o={where:_defineProperty({},t.foreignKeys,{contains:t.getForeignKey(e)})}:t.type===belongsToType&&(r=n.remove(t.relation,t.getForeignKey(e),i)):o=_defineProperty({},t.foreignKey,t.getForeignKey(e)),o&&(r=n.removeAll(t.relation,o,i)),r){if(utils.isArray(r)&&!r.length)return;t.type===hasOneType&&(r=r[0]),t.setLocalField(e,r)}})})},update:function(t,e,i,n){var r=this;return n||(n={}),Container.prototype.update.call(this,t,e,i,n).then(function(e){return r._end(t,e,n)})},updateAll:function(t,e,i,n){var r=this;return n||(n={}),Container.prototype.updateAll.call(this,t,e,i,n).then(function(e){return r._end(t,e,n)})},updateMany:function(t,e,i){var n=this;return i||(i={}),Container.prototype.updateMany.call(this,t,e,i).then(function(e){return n._end(t,e,i)})}};proxiedCollectionMethods.forEach(function(t){props$1[t]=function(e){for(var i,n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return(i=this.getCollection(e))[t].apply(i,r)}});var SimpleStore$1=Container.extend(props$1),DOMAIN$9="LinkedCollection";function LinkedCollection(t,e){if(utils.classCallCheck(this,LinkedCollection),Object.defineProperties(this,{_added:{value:{}},datastore:{writable:!0,value:void 0}}),Collection$1.call(this,t,e),!this.datastore)throw utils.err("new ".concat(DOMAIN$9),"opts.datastore")(400,"DataStore",this.datastore)}var LinkedCollection$1=Collection$1.extend({constructor:LinkedCollection,_addMeta:function(t,e){this._added[this.recordId(t)]=e,utils.isFunction(t._set)&&t._set("$",e)},_clearMeta:function(t){delete this._added[this.recordId(t)],utils.isFunction(t._set)&&t._set("$")},_onRecordEvent:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];Collection$1.prototype._onRecordEvent.apply(this,e);var n=e[0];utils.isString(n)&&0===n.indexOf("change")&&this.updateIndexes(e[1])},add:function(t,e){var i=this,n=this.mapper,r=(new Date).getTime(),o=utils.isObject(t)&&!utils.isArray(t);return o&&(t=[t]),t=Collection$1.prototype.add.call(this,t,e),n.relationList.length&&t.length&&n.relationList.forEach(function(e){e.addLinkedRecords(t)}),t.forEach(function(t){return i._addMeta(t,r)}),o?t[0]:t},remove:function(t,e){var i=this.mapper,n=Collection$1.prototype.remove.call(this,t,e);return n&&this._clearMeta(n),i.relationList.length&&n&&i.relationList.forEach(function(t){t.removeLinkedRecords(i,[n])}),n},removeAll:function(t,e){var i=this.mapper,n=Collection$1.prototype.removeAll.call(this,t,e);return n.forEach(this._clearMeta,this),i.relationList.length&&n.length&&i.relationList.forEach(function(t){t.removeLinkedRecords(i,n)}),n}}),DATASTORE_DEFAULTS={unlinkOnDestroy:!0};function DataStore(t){utils.classCallCheck(this,DataStore),t||(t={}),utils.fillIn(t,DATASTORE_DEFAULTS),t.collectionClass||(t.collectionClass=LinkedCollection$1),SimpleStore$1.call(this,t)}var props$2={constructor:DataStore,defineMapper:function(t,e){var i=this,n=SimpleStore$1.prototype.defineMapper.call(i,t,e),r=n.idAttribute,o=this.getCollection(t);return n.relationList.forEach(function(t){var e,s=t.relation,a=t.localField,l="links.".concat(a),u=t.foreignKey,c=t.type,f={index:u},h=function(){return this._get(l)};if(c===belongsToType){o.indexes[u]||o.createIndex(u),e={get:h,set:function(e){var c=this._get(l);if(e===c)return c;var h=utils.get(this,r),d=t.getInverse(n);if(c&&d&&this.removeInverseRelation(c,h,d,r),e){var p=t.getRelation().idAttribute,v=utils.get(e,p);void 0!==v&&this._get("$")&&(e=i.get(s,v)||e),safeSetLink(this,a,e),safeSetProp(this,u,v),o.updateIndex(this,f),d&&this.setupInverseRelation(e,h,d,r)}else safeSetLink(this,a,void 0);return e}};var d=Object.getOwnPropertyDescriptor(n.recordClass.prototype,u);d||(d={enumerable:!0});var p=d.get;d.get=function(){return p?p.call(this):this._get("props.".concat(u))};var v=d.set;d.set=function(e){var l=this;v&&v.call(this,e);var c=utils.get(this,a),h=utils.get(this,r),d=t.getInverse(n),p=c?utils.get(c,t.getRelation().idAttribute):void 0;if(d&&c&&void 0!==p&&p!==e)if(d.type===hasOneType)safeSetLink(c,d.localField,void 0);else if(d.type===hasManyType){var g=utils.get(c,d.localField);void 0===h?utils.remove(g,function(t){return t===l}):utils.remove(g,function(t){return t===l||h===utils.get(t,r)})}if(safeSetProp(this,u,e),o.updateIndex(this,f),null==e)void 0!==p&&utils.set(this,a,void 0);else if(this._get("$")){var y=i.get(s,e);y&&utils.set(this,a,y)}},Object.defineProperty(n.recordClass.prototype,u,d)}else if(c===hasManyType){var g=t.localKeys,y=t.foreignKeys;i._collections[s]&&u&&!i.getCollection(s).indexes[u]&&i.getCollection(s).createIndex(u),e={get:function(){return h.call(this)||this._set(l,[]),h.call(this)},set:function(e){var o=this;e&&!utils.isArray(e)&&(e=[e]);var c=utils.get(this,r),h=t.getRelation().idAttribute,d=t.getInverse(n),p=d.localField,v=this._get(l)||[],m=[],A={};if(e&&e.forEach(function(t){var e=utils.get(t,h),n=utils.get(t,p);if(n&&n!==o){var r=utils.get(n,a);void 0===e?utils.remove(r,function(e){return e===t}):utils.remove(r,function(i){return i===t||e===utils.get(i,h)})}void 0!==e&&(o._get("$")&&(t=i.get(s,e)||t),A[e]=t),m.push(t)}),u)v.forEach(function(t){var n=utils.get(t,h);(void 0===n&&-1===m.indexOf(t)||void 0!==n&&!(n in A))&&(e&&(safeSetProp(t,u,void 0),i.getCollection(s).updateIndex(t,f)),safeSetLink(t,p,void 0))}),m.forEach(function(t){safeSetProp(t,u,c),i.getCollection(s).updateIndex(t,f),safeSetLink(t,p,o)});else if(g){var O=m.map(function(t){return utils.get(t,h)}).filter(function(t){return void 0!==t});utils.set(this,g,O),d.foreignKeys&&(v.forEach(function(t){var e=utils.get(t,h);if(void 0===e&&-1===m.indexOf(t)||void 0!==e&&!(e in A)){var i=utils.get(t,p)||[];void 0===c?utils.remove(i,function(t){return t===o}):utils.remove(i,function(t){return t===o||c===utils.get(t,r)})}}),m.forEach(function(t){var e=utils.get(t,p);void 0===c?utils.noDupeAdd(e,o,function(t){return t===o}):utils.noDupeAdd(e,o,function(t){return t===o||c===utils.get(t,r)})}))}else y&&(v.forEach(function(t){var e=utils.get(t,y)||[];utils.remove(e,function(t){return c===t});var i=utils.get(t,p);void 0===c?utils.remove(i,function(t){return t===o}):utils.remove(i,function(t){return t===o||c===utils.get(t,r)})}),m.forEach(function(t){var e=utils.get(t,y)||[];utils.noDupeAdd(e,c,function(t){return c===t});var i=utils.get(t,p);void 0===c?utils.noDupeAdd(i,o,function(t){return t===o}):utils.noDupeAdd(i,o,function(t){return t===o||c===utils.get(t,r)})}));return this._set(l,m),m}}}else c===hasOneType&&(i._collections[s]&&u&&!i.getCollection(s).indexes[u]&&i.getCollection(s).createIndex(u),e={get:h,set:function(e){var o=this._get(l);if(e===o)return o;var c=t.getInverse(n).localField;if(o&&(safeSetProp(o,u,void 0),i.getCollection(s).updateIndex(o,f),safeSetLink(o,c,void 0)),e){var h=utils.get(e,t.getRelation().idAttribute);void 0!==h&&(e=i.get(s,h)||e),safeSetLink(this,a,e),safeSetProp(e,u,utils.get(this,r)),i.getCollection(s).updateIndex(e,f),safeSetLink(e,c,this)}else safeSetLink(this,a,void 0);return e}});if(e){if(e.enumerable=void 0!==t.enumerable&&t.enumerable,t.get){var m=e.get;e.get=function(){var e=this;return t.get(t,this,function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return m.apply(e,i)})}}if(t.set){var A=e.set;e.set=function(e){var i=this;return t.set(t,this,e,function(t){return A.call(i,void 0===t?e:t)})}}Object.defineProperty(n.recordClass.prototype,a,e)}}),n},destroy:function(t,e,i){var n=this;return i||(i={}),SimpleStore$1.prototype.destroy.call(this,t,e,i).then(function(e){var r;if((r=i.raw?e.data:e)&&n.unlinkOnDestroy){var o=utils.plainCopy(i);o.withAll=!0,utils.forEachRelation(n.getMapper(t),o,function(t){utils.set(r,t.localField,void 0)})}return e})},destroyAll:function(t,e,i){var n=this;return i||(i={}),SimpleStore$1.prototype.destroyAll.call(this,t,e,i).then(function(e){var r;if((r=i.raw?e.data:e)&&r.length&&n.unlinkOnDestroy){var o=utils.plainCopy(i);o.withAll=!0,utils.forEachRelation(n.getMapper(t),o,function(t){r.forEach(function(e){utils.set(e,t.localField,void 0)})})}return e})}},DataStore$1=SimpleStore$1.extend(props$2),version={full:"3.0.6",major:3,minor:0,patch:6};export{Collection$1 as Collection,Component$1 as Component,Container,DataStore$1 as DataStore,Index,LinkedCollection$1 as LinkedCollection,Mapper$1 as Mapper,Query$1 as Query,Record$1 as Record,Schema$1 as Schema,Settable,SimpleStore$1 as SimpleStore,belongsTo,belongsToType,hasMany,hasManyType,hasOne,hasOneType,utils,version};