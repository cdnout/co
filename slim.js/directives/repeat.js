import{Slim}from"../Slim.js";!function(){const e=Symbol.Slim,{isReadOnly:t}=Slim;Slim.customDirective(e=>"s:repeat"===e.nodeName,(l,n,r)=>{let i=r.value,o="data";i.indexOf(" as ")>0&&([i,o]=i.split(" as "));let c=[];const a=document.createComment(`${n.localName} s:repeat="${r.value}"`),m=n.parentElement||Slim.root(l);m.insertBefore(a,n),n.removeAttribute("s:repeat"),Slim.qSelectAll(n,"*").forEach(e=>{Slim._$(e).excluded=!0}),Slim._$(n).excluded=!0;const s=n.outerHTML;n.remove();let S=[];const u=(e,t)=>{let l=t,n="";if(e<1)return n;for(;e>1;)1&e&&(n+=l),e>>=1,l+=l;return n+l};Slim.bind(l,a,i,()=>{const n=Slim.lookup(l,i)||[];let r;if(n.length<c.length&&(c.slice(n.length).forEach(t=>{Slim.unbind(l,t),t[e].subTree&&t[e].subTree.forEach(e=>Slim.unbind(l,e)),t.remove()}),c.length=n.length),n.length>c.length){const t=c.length,i=n.length-c.length,m=u(i,s),S=document.createRange();S.setStartBefore(a),r=S.createContextualFragment(m);for(let l=0;l<i;l++){const i=n[l+t],a=r.children[l];Slim._$(a).repeater[o]=i;const m=Slim.qSelectAll(a,"*");m.forEach(function(e){Slim._$(e).repeater[o]=i}),a[e].subTree=m,c.push(a)}const f=Slim.qSelectAll(r,"*");l._bindChildren(f)}const f=(e,l)=>{t(e,o)||(e[o]=l),Slim.commit(e,o)};n.forEach(function(t,l){if(S[l]!==t){const n=c[l];[n,...n[e].subTree||Slim.qSelectAll(n,"*")].forEach(l=>{l[e].repeater[o]=t,l[e].repeater.__node=n,l.__isSlim?(l.createdCallback(),Slim.asap(()=>f(l,t))):f(l,t)})}}),S=n.concat(),r&&Slim.asap(()=>{m.insertBefore(r,a)})})},!0)}();