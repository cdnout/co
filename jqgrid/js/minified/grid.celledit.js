!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base"],e):e(jQuery)}(function(R){"use strict";R.jgrid.extend({editCell:function(c,f,u,g){return this.each(function(){var e,i,l,t,r,o=this,d=R(this).jqGrid("getStyleUI",o.p.styleUI+".common","highlight",!0),s=R(this).jqGrid("getStyleUI",o.p.styleUI+".common","hover",!0),a=R(this).jqGrid("getStyleUI",o.p.styleUI+".celledit","inputClass",!0);if(o.grid&&!0===o.p.cellEdit){if(f=parseInt(f,10),o.p.selrow=o.rows[c].id,o.p.knv||R(o).jqGrid("GridNav"),0<o.p.savedRow.length){if(!0===u&&c==o.p.iRow&&f==o.p.iCol)return;R(o).jqGrid("saveCell",o.p.savedRow[0].id,o.p.savedRow[0].ic)}else window.setTimeout(function(){R("#"+R.jgrid.jqID(o.p.knv)).attr("tabindex","-1").focus()},1);if("subgrid"!==(e=(t=o.p.colModel[f]).name)&&"cb"!==e&&"rn"!==e){try{l=R(o.rows[c].cells[f])}catch(e){l=R("td",o.rows[c]).eq(f)}if(0<=parseInt(o.p.iCol,10)&&0<=parseInt(o.p.iRow,10)&&void 0!==o.p.iRowId&&(r=R(o).jqGrid("getGridRowById",o.p.iRowId),R(r).removeClass("selected-row "+s).find("td").eq(o.p.iCol).removeClass("edit-cell "+d)),l.addClass("edit-cell "+d),R(o.rows[c]).addClass("selected-row "+s),!0!==t.editable||!0!==u||l.hasClass("not-editable-cell")||R.jgrid.isFunction(o.p.isCellEditable)&&!o.p.isCellEditable.call(o,e,c,f))i=l.html().replace(/\&#160\;/gi,""),R(o).triggerHandler("jqGridCellSelect",[o.rows[c].id,f,i,g]),R.jgrid.isFunction(o.p.onCellSelect)&&o.p.onCellSelect.call(o,o.rows[c].id,f,i,g);else{try{i=R.unformat.call(o,l,{rowId:o.rows[c].id,colModel:t},f)}catch(e){i=t.edittype&&"textarea"===t.edittype?l.text():l.html()}o.p.autoencode&&(i=R.jgrid.htmlDecode(i)),t.edittype||(t.edittype="text"),o.p.savedRow.push({id:c,ic:f,name:e,v:i,rowId:o.rows[c].id}),("&nbsp;"===i||"&#160;"===i||1===i.length&&160===i.charCodeAt(0))&&(i=""),!R.jgrid.isFunction(o.p.formatCell)||void 0!==(n=o.p.formatCell.call(o,o.rows[c].id,e,i,c,f))&&(i=n),R(o).triggerHandler("jqGridBeforeEditCell",[o.rows[c].id,e,i,c,f]),R.jgrid.isFunction(o.p.beforeEditCell)&&o.p.beforeEditCell.call(o,o.rows[c].id,e,i,c,f);var n=R.extend({},t.editoptions||{},{id:c+"_"+e,name:e,rowId:o.rows[c].id,oper:"edit",module:"cell"}),p=R.jgrid.createEl.call(o,t.edittype,n,i,!0,R.extend({},R.jgrid.ajaxOptions,o.p.ajaxSelectOptions||{}));-1<R.inArray(t.edittype,["text","textarea","password","select"])&&R(p).addClass(a),l.html("").append(p).attr("tabindex","0"),R.jgrid.bindEv.call(o,p,n),window.setTimeout(function(){R(p).focus()},1),R("input, select, textarea",l).on("keydown",function(e){if(27===e.keyCode&&(!(0<R("input.hasDatepicker",l).length)||R(".ui-datepicker").is(":hidden")?R(o).jqGrid("restoreCell",c,f):R("input.hasDatepicker",l).datepicker("hide")),13===e.keyCode&&e.altKey&&"TEXTAREA"===this.nodeName)return this.value=this.value+"\r",!0;if(13===e.keyCode&&!e.shiftKey)return R(o).jqGrid("saveCell",c,f),!1;if(9===e.keyCode){if(o.grid.hDiv.loading)return!1;e.shiftKey?!R(o).jqGrid("prevCell",c,f,e)&&o.p.editNextRowCell&&0<c-1&&o.rows[c-1]&&(c--,R(o).jqGrid("prevCell",c,o.p.colModel.length,e)):!R(o).jqGrid("nextCell",c,f,e)&&o.p.editNextRowCell&&o.rows[c+1]&&(c++,R(o).jqGrid("nextCell",c,0,e))}e.stopPropagation()}),R(o).triggerHandler("jqGridAfterEditCell",[o.rows[c].id,e,i,c,f]),R.jgrid.isFunction(o.p.afterEditCell)&&o.p.afterEditCell.call(o,o.rows[c].id,e,i,c,f)}o.p.iCol=f,o.p.iRow=c,o.p.iRowId=o.rows[c].id}}})},saveCell:function(m,y){return this.each(function(){var t=this,r=1<=t.p.savedRow.length?0:null,o=R.jgrid.getRegional(this,"errors"),d=R.jgrid.getRegional(this,"edit");if(t.grid&&!0===t.p.cellEdit){if(null!==r){var s=R(t).jqGrid("getGridRowById",t.p.savedRow[0].rowId),a=R("td",s).eq(y),e=t.p.colModel[y],n=e.name,p=R.jgrid.jqID(n),c=R(a).offset();switch(e.edittype){case"select":var l,f,u=e.editoptions.multiple?(i=R("#"+m+"_"+p,s),l=[],(f=R(i).val())?f.join(","):f="",R("option:selected",i).each(function(e,i){l[e]=R(i).text()}),l.join(",")):(f=R("#"+m+"_"+p+" option:selected",s).val(),R("#"+m+"_"+p+" option:selected",s).text());e.formatter&&(u=f);break;case"checkbox":var i=["Yes","No"];e.editoptions&&e.editoptions.value&&(i=e.editoptions.value.split(":")),f=R("#"+m+"_"+p,s).is(":checked")?i[0]:i[1],u=f;break;case"password":case"text":case"textarea":case"button":f=R("#"+m+"_"+p,s).val(),u=f;break;case"custom":try{if(!e.editoptions||!R.jgrid.isFunction(e.editoptions.custom_value))throw"e1";if(void 0===(f=e.editoptions.custom_value.call(t,R(".customelement",a),"get")))throw"e2";u=f}catch(e){"e1"===e?R.jgrid.info_dialog(o.errcap,"function 'custom_value' "+d.msg.nodefined,d.bClose,{styleUI:t.p.styleUI}):"e2"===e?R.jgrid.info_dialog(o.errcap,"function 'custom_value' "+d.msg.novalue,d.bClose,{styleUI:t.p.styleUI}):R.jgrid.info_dialog(o.errcap,e.message,d.bClose,{styleUI:t.p.styleUI})}}if(u!==t.p.savedRow[r].v){var g=R(t).triggerHandler("jqGridBeforeSaveCell",[t.p.savedRow[r].rowId,n,f,m,y]);g&&(u=f=g),!R.jgrid.isFunction(t.p.beforeSaveCell)||(j=t.p.beforeSaveCell.call(t,t.p.savedRow[r].rowId,n,f,m,y))&&(u=f=j);var v=R.jgrid.checkValues.call(t,f,y),w=!1;if(!0===v[0]){var C=R(t).triggerHandler("jqGridBeforeSubmitCell",[t.p.savedRow[r].rowId,n,f,m,y])||{};R.jgrid.isFunction(t.p.beforeSubmitCell)&&(C=(C=t.p.beforeSubmitCell.call(t,t.p.savedRow[r].rowId,n,f,m,y))||{});g=R(t).triggerHandler("jqGridOnSubmitCell",[t.p.savedRow[r].rowId,n,f,m,y]);if(void 0===g&&(g=!0),R.jgrid.isFunction(t.p.onSubmitCell)&&void 0===(g=t.p.onSubmitCell(t.p.savedRow[r].rowId,n,f,m,y))&&(g=!0),!1===g)return;if(0<R("input.hasDatepicker",a).length&&R("input.hasDatepicker",a).datepicker("hide"),"remote"===t.p.cellsubmit)if(t.p.cellurl){var h={};t.p.autoencode&&(f=R.jgrid.htmlEncode(f)),e.editoptions&&e.editoptions.NullIfEmpty&&""===f&&(f="null",w=!0),h[n]=f;var j=t.p.prmNames,b=j.id,g=j.oper;h[b]=R.jgrid.stripPref(t.p.idPrefix,t.p.savedRow[r].rowId),h[g]=j.editoper,h=R.extend(C,h),R(t).jqGrid("progressBar",{method:"show",loadtype:t.p.loadui,htmlcontent:R.jgrid.getRegional(t,"defaults.savetext")}),t.grid.hDiv.loading=!0,R.ajax(R.extend({url:t.p.cellurl,data:R.jgrid.isFunction(t.p.serializeCellData)?t.p.serializeCellData.call(t,h,n):h,type:"POST",complete:function(e,i){var l;R(t).jqGrid("progressBar",{method:"hide",loadtype:t.p.loadui}),t.grid.hDiv.loading=!1,"success"===i&&(!0===(l=R(t).triggerHandler("jqGridAfterSubmitCell",[t,e,h[b],n,f,m,y])||[!0,""])[0]&&R.jgrid.isFunction(t.p.afterSubmitCell)&&(l=t.p.afterSubmitCell.call(t,e,h[b],n,f,m,y)),!0===l[0]?(w&&(f=""),R(a).empty(),R(t).jqGrid("setCell",t.p.savedRow[r].rowId,y,u,!1,!1,!0),a=R("td",s).eq(y),R(a).addClass("dirty-cell"),R(s).addClass("edited"),R(t).triggerHandler("jqGridAfterSaveCell",[t.p.savedRow[r].rowId,n,f,m,y]),R.jgrid.isFunction(t.p.afterSaveCell)&&t.p.afterSaveCell.call(t,t.p.savedRow[r].rowId,n,f,m,y),t.p.savedRow.splice(0,1)):(R(t).triggerHandler("jqGridErrorCell",[e,i]),R.jgrid.isFunction(t.p.errorCell)?t.p.errorCell.call(t,e,i):R.jgrid.info_dialog(o.errcap,l[1],d.bClose,{styleUI:t.p.styleUI,top:c.top+30,left:c.left,onClose:function(){t.p.restoreCellonFail||R("#"+m+"_"+p,s).focus()}}),t.p.restoreCellonFail&&R(t).jqGrid("restoreCell",m,y)))},error:function(e,i,l){R("#lui_"+R.jgrid.jqID(t.p.id)).hide(),t.grid.hDiv.loading=!1,R(t).triggerHandler("jqGridErrorCell",[e,i,l]),R.jgrid.isFunction(t.p.errorCell)?t.p.errorCell.call(t,e,i,l):R.jgrid.info_dialog(o.errcap,e.status+" : "+e.statusText+"<br/>"+i,d.bClose,{styleUI:t.p.styleUI,top:c.top+30,left:c.left,onClose:function(){t.p.restoreCellonFail||R("#"+m+"_"+p,s).focus()}}),t.p.restoreCellonFail&&R(t).jqGrid("restoreCell",m,y)}},R.jgrid.ajaxOptions,t.p.ajaxCellOptions||{}))}else try{R.jgrid.info_dialog(o.errcap,o.nourl,d.bClose,{styleUI:t.p.styleUI}),t.p.restoreCellonFail&&R(t).jqGrid("restoreCell",m,y)}catch(e){}"clientArray"===t.p.cellsubmit&&(R(a).empty(),R(t).jqGrid("setCell",t.p.savedRow[r].rowId,y,u,!1,!1,!0),a=R("td",s).eq(y),R(a).addClass("dirty-cell"),R(s).addClass("edited"),R(t).triggerHandler("jqGridAfterSaveCell",[t.p.savedRow[r].rowId,n,f,m,y]),R.jgrid.isFunction(t.p.afterSaveCell)&&t.p.afterSaveCell.call(t,t.p.savedRow[r].rowId,n,f,m,y),t.p.savedRow.splice(0,1))}else try{R.jgrid.isFunction(t.p.validationCell)?t.p.validationCell.call(t,R("#"+m+"_"+p,s),v[1],m,y):(window.setTimeout(function(){R.jgrid.info_dialog(o.errcap,f+" "+v[1],d.bClose,{styleUI:t.p.styleUI,top:c.top+30,left:c.left,onClose:function(){t.p.restoreCellonFail||R("#"+m+"_"+p,s).focus()}})},50),t.p.restoreCellonFail&&R(t).jqGrid("restoreCell",m,y))}catch(e){alert(v[1])}}else R(t).jqGrid("restoreCell",m,y)}window.setTimeout(function(){R("#"+R.jgrid.jqID(t.p.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(r,o){return this.each(function(){var e=this,i=1<=e.p.savedRow.length?0:null;if(e.grid&&!0===e.p.cellEdit){if(null!==i){var l=R(e).jqGrid("getGridRowById",e.p.savedRow[i].rowId),t=R("td",l).eq(o);if(R.jgrid.isFunction(R.fn.datepicker))try{R("input.hasDatepicker",t).datepicker("hide")}catch(e){}R(t).empty().attr("tabindex","-1"),R(e).jqGrid("setCell",e.p.savedRow[0].rowId,o,e.p.savedRow[i].v,!1,!1,!0),R(e).triggerHandler("jqGridAfterRestoreCell",[e.p.savedRow[i].rowId,e.p.savedRow[i].v,r,o]),R.jgrid.isFunction(e.p.afterRestoreCell)&&e.p.afterRestoreCell.call(e,e.p.savedRow[i].rowId,e.p.savedRow[i].v,r,o),e.p.savedRow.splice(0,1)}window.setTimeout(function(){R("#"+e.p.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(t,r,o){var d;return this.each(function(){var e,i=this,l=!1;if(i.grid&&!0===i.p.cellEdit){for(e=r+1;e<i.p.colModel.length;e++)if(!0===i.p.colModel[e].editable&&(!R.jgrid.isFunction(i.p.isCellEditable)||i.p.isCellEditable.call(i,i.p.colModel[e].name,t,e))){l=e;break}!1!==l?(d=!0,R(i).jqGrid("editCell",t,l,!0,o)):(d=!1,0<i.p.savedRow.length&&R(i).jqGrid("saveCell",t,r))}}),d},prevCell:function(t,r,o){var d;return this.each(function(){var e,i=this,l=!1;if(!i.grid||!0!==i.p.cellEdit)return!1;for(e=r-1;0<=e;e--)if(!0===i.p.colModel[e].editable&&(!R.jgrid.isFunction(i.p.isCellEditable)||i.p.isCellEditable.call(i,i.p.colModel[e].name,t,e))){l=e;break}!1!==l?(d=!0,R(i).jqGrid("editCell",t,l,!0,o)):(d=!1,0<i.p.savedRow.length&&R(i).jqGrid("saveCell",t,r))}),d},GridNav:function(){return this.each(function(){var e,i,l,s=this;function t(e,i,l){var t,r,o,d;"v"===l.substr(0,1)&&(t=R(s.grid.bDiv)[0].clientHeight,d=R(s.grid.bDiv)[0].scrollTop,r=s.rows[e].offsetTop+s.rows[e].clientHeight,o=s.rows[e].offsetTop,"vd"===l&&t<=r&&(R(s.grid.bDiv)[0].scrollTop=R(s.grid.bDiv)[0].scrollTop+s.rows[e].clientHeight),"vu"===l&&o<d&&(R(s.grid.bDiv)[0].scrollTop=R(s.grid.bDiv)[0].scrollTop-s.rows[e].clientHeight)),"h"===l&&(r=R(s.grid.bDiv)[0].clientWidth,o=R(s.grid.bDiv)[0].scrollLeft,d=s.rows[e].cells[i].offsetLeft+s.rows[e].cells[i].clientWidth,l=s.rows[e].cells[i].offsetLeft,d>=r+parseInt(o,10)?R(s.grid.bDiv)[0].scrollLeft=R(s.grid.bDiv)[0].scrollLeft+s.rows[e].cells[i].clientWidth:l<o&&(R(s.grid.bDiv)[0].scrollLeft=R(s.grid.bDiv)[0].scrollLeft-s.rows[e].cells[i].clientWidth))}function r(e,i){var l,t;if("lft"===i)for(l=e+1,t=e;0<=t;t--)if(!0!==s.p.colModel[t].hidden){l=t;break}if("rgt"===i)for(l=e-1,t=e;t<s.p.colModel.length;t++)if(!0!==s.p.colModel[t].hidden){l=t;break}return l}s.grid&&!0===s.p.cellEdit&&(s.p.knv=s.p.id+"_kn",e=R("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+s.p.knv+"'></div></div>"),R(e).insertBefore(s.grid.cDiv),R("#"+s.p.knv).focus().keydown(function(e){switch(l=e.keyCode,"rtl"===s.p.direction&&(37===l?l=39:39===l&&(l=37)),l){case 38:0<s.p.iRow-1&&(t(s.p.iRow-1,s.p.iCol,"vu"),R(s).jqGrid("editCell",s.p.iRow-1,s.p.iCol,!1,e));break;case 40:s.p.iRow+1<=s.rows.length-1&&(t(s.p.iRow+1,s.p.iCol,"vd"),R(s).jqGrid("editCell",s.p.iRow+1,s.p.iCol,!1,e));break;case 37:0<=s.p.iCol-1&&(i=r(s.p.iCol-1,"lft"),t(s.p.iRow,i,"h"),R(s).jqGrid("editCell",s.p.iRow,i,!1,e));break;case 39:s.p.iCol+1<=s.p.colModel.length-1&&(i=r(s.p.iCol+1,"rgt"),t(s.p.iRow,i,"h"),R(s).jqGrid("editCell",s.p.iRow,i,!1,e));break;case 13:0<=parseInt(s.p.iCol,10)&&0<=parseInt(s.p.iRow,10)&&R(s).jqGrid("editCell",s.p.iRow,s.p.iCol,!0,e);break;default:return!0}return!1}))})},getChangedCells:function(o){var e=[];return o=o||"all",this.each(function(){var t,r=this;r.grid&&!0===r.p.cellEdit&&R(r.rows).each(function(i){var l={};R(this).hasClass("edited")&&(R("td",this).each(function(e){if("cb"!==(t=r.p.colModel[e].name)&&"subgrid"!==t)if("dirty"===o){if(R(this).hasClass("dirty-cell"))try{l[t]=R.unformat.call(r,this,{rowId:r.rows[i].id,colModel:r.p.colModel[e]},e)}catch(e){l[t]=R.jgrid.htmlDecode(R(this).html())}}else try{l[t]=R.unformat.call(r,this,{rowId:r.rows[i].id,colModel:r.p.colModel[e]},e)}catch(e){l[t]=R.jgrid.htmlDecode(R(this).html())}}),l.id=this.id,e.push(l))})}),e}})});