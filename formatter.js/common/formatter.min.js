function Formatter(t,e){var s=this;if(s.el=t,!s.el)throw new TypeError("Must provide an existing element");if(s.opts=utils.extend({},defaults,e),"undefined"!=typeof s.opts.pattern&&(s.opts.patterns=s._specFromSinglePattern(s.opts.pattern),delete s.opts.pattern),"undefined"==typeof s.opts.patterns)throw new TypeError("Must provide a pattern or array of patterns");s.patternMatcher=patternMatcher(s.opts.patterns),s._updatePattern(),s.hldrs={},s.focus=0,utils.addListener(s.el,"keydown",function(t){s._keyDown(t)}),utils.addListener(s.el,"keypress",function(t){s._keyPress(t)}),utils.addListener(s.el,"paste",function(t){s._paste(t)}),s.opts.persistent&&(s._processKey("",!1),s.el.blur(),utils.addListener(s.el,"focus",function(t){s._focus(t)}),utils.addListener(s.el,"click",function(t){s._focus(t)}),utils.addListener(s.el,"touchstart",function(t){s._focus(t)}))}var patternMatcher=require("pattern-matcher"),inptSel=require("inpt-sel"),utils=require("utils"),defaults={persistent:!1,repeat:!1,placeholder:" "},inptRegs={9:/[0-9]/,a:/[A-Za-z]/,"*":/[A-Za-z0-9]/};Formatter.addInptType=function(t,e){inptRegs[t]=e},Formatter.prototype.resetPattern=function(t){this.opts.patterns=t?this._specFromSinglePattern(t):this.opts.patterns,this.sel=inptSel.get(this.el),this.val=this.el.value,this.delta=0,this._removeChars(),this.patternMatcher=patternMatcher(this.opts.patterns);var e=this.patternMatcher.getPattern(this.val);this.mLength=e.mLength,this.chars=e.chars,this.inpts=e.inpts,this._processKey("",!1,!0)},Formatter.prototype._updatePattern=function(){var t=this.patternMatcher.getPattern(this.val);t&&(this.mLength=t.mLength,this.chars=t.chars,this.inpts=t.inpts)},Formatter.prototype._keyDown=function(t){var e=t.which||t.keyCode;return e&&utils.isDelKeyDown(t.which,t.keyCode)?(this._processKey(null,e),utils.preventDefault(t)):void 0},Formatter.prototype._keyPress=function(t){var e,s;return e=t.which||t.keyCode,s=utils.isSpecialKeyPress(t.which,t.keyCode),utils.isDelKeyPress(t.which,t.keyCode)||s||utils.isModifier(t)?void 0:(this._processKey(String.fromCharCode(e),!1),utils.preventDefault(t))},Formatter.prototype._paste=function(t){return this._processKey(utils.getClip(t),!1),utils.preventDefault(t)},Formatter.prototype._focus=function(){var t=this;setTimeout(function(){var e=inptSel.get(t.el),s=e.end>t.focus,i=0===e.end;(s||i)&&inptSel.set(t.el,t.focus)},0)},Formatter.prototype._processKey=function(t,e,s){if(this.sel=inptSel.get(this.el),this.val=this.el.value,this.delta=0,this.sel.begin!==this.sel.end)this.delta=-1*Math.abs(this.sel.begin-this.sel.end),this.val=utils.removeChars(this.val,this.sel.begin,this.sel.end);else if(e&&46===e)this._delete();else if(e&&this.sel.begin-1>=0)this.val=utils.removeChars(this.val,this.sel.end-1,this.sel.end),this.delta-=1;else if(e)return!0;e||(this.val=utils.addChars(this.val,t,this.sel.begin),this.delta+=t.length),this._formatValue(s)},Formatter.prototype._delete=function(){for(;this.chars[this.sel.begin];)this._nextPos();this.sel.begin<this.val.length&&(this._nextPos(),this.val=utils.removeChars(this.val,this.sel.end-1,this.sel.end),this.delta=-1)},Formatter.prototype._nextPos=function(){this.sel.end++,this.sel.begin++},Formatter.prototype._formatValue=function(t){this.newPos=this.sel.end+this.delta,this._removeChars(),this._updatePattern(),this._validateInpts(),this._addChars(),this.el.value=this.val.substr(0,this.mLength),("undefined"==typeof t||t===!1)&&inptSel.set(this.el,this.newPos)},Formatter.prototype._removeChars=function(){this.sel.end>this.focus&&(this.delta+=this.sel.end-this.focus);for(var t=0,e=0;e<=this.mLength;e++){var s,i=this.chars[e],r=this.hldrs[e],h=e+t;h=e>=this.sel.begin?h+this.delta:h,s=this.val.charAt(h),(i&&i===s||r&&r===s)&&(this.val=utils.removeChars(this.val,h,h+1),t--)}this.hldrs={},this.focus=this.val.length},Formatter.prototype._validateInpts=function(){for(var t=0;t<this.val.length;t++){var e=this.inpts[t],s=!inptRegs[e],i=!s&&!inptRegs[e].test(this.val.charAt(t)),r=this.inpts[t];(s||i)&&r&&(this.val=utils.removeChars(this.val,t,t+1),this.focusStart--,this.newPos--,this.delta--,t--)}},Formatter.prototype._addChars=function(){if(this.opts.persistent){for(var t=0;t<=this.mLength;t++)this.val.charAt(t)||(this.val=utils.addChars(this.val,this.opts.placeholder,t),this.hldrs[t]=this.opts.placeholder),this._addChar(t);for(;this.chars[this.focus];)this.focus++}else for(var e=0;e<=this.val.length;e++){if(this.delta<=0&&e===this.focus)return!0;this._addChar(e)}},Formatter.prototype._addChar=function(t){var e=this.chars[t];return e?(utils.isBetween(t,[this.sel.begin-1,this.newPos+1])&&(this.newPos++,this.delta++),t<=this.focus&&this.focus++,this.hldrs[t]&&(delete this.hldrs[t],this.hldrs[t+1]=this.opts.placeholder),void(this.val=utils.addChars(this.val,e,t))):!0},Formatter.prototype._specFromSinglePattern=function(t){return[{"*":t}]},module.exports=Formatter;