define(["pattern-matcher","inpt-sel","utils"],function(t,e,s){function i(e,i){var r=this;if(r.el=e,!r.el)throw new TypeError("Must provide an existing element");if(r.opts=s.extend({},h,i),"undefined"!=typeof r.opts.pattern&&(r.opts.patterns=r._specFromSinglePattern(r.opts.pattern),delete r.opts.pattern),"undefined"==typeof r.opts.patterns)throw new TypeError("Must provide a pattern or array of patterns");r.patternMatcher=t(r.opts.patterns),r._updatePattern(),r.hldrs={},r.focus=0,s.addListener(r.el,"keydown",function(t){r._keyDown(t)}),s.addListener(r.el,"keypress",function(t){r._keyPress(t)}),s.addListener(r.el,"paste",function(t){r._paste(t)}),r.opts.persistent&&(r._processKey("",!1),r.el.blur(),s.addListener(r.el,"focus",function(t){r._focus(t)}),s.addListener(r.el,"click",function(t){r._focus(t)}),s.addListener(r.el,"touchstart",function(t){r._focus(t)}))}var h={persistent:!1,repeat:!1,placeholder:" "},r={9:/[0-9]/,a:/[A-Za-z]/,"*":/[A-Za-z0-9]/};return i.addInptType=function(t,e){r[t]=e},i.prototype.resetPattern=function(s){this.opts.patterns=s?this._specFromSinglePattern(s):this.opts.patterns,this.sel=e.get(this.el),this.val=this.el.value,this.delta=0,this._removeChars(),this.patternMatcher=t(this.opts.patterns);var i=this.patternMatcher.getPattern(this.val);this.mLength=i.mLength,this.chars=i.chars,this.inpts=i.inpts,this._processKey("",!1,!0)},i.prototype._updatePattern=function(){var t=this.patternMatcher.getPattern(this.val);t&&(this.mLength=t.mLength,this.chars=t.chars,this.inpts=t.inpts)},i.prototype._keyDown=function(t){var e=t.which||t.keyCode;return e&&s.isDelKeyDown(t.which,t.keyCode)?(this._processKey(null,e),s.preventDefault(t)):void 0},i.prototype._keyPress=function(t){var e,i;return e=t.which||t.keyCode,i=s.isSpecialKeyPress(t.which,t.keyCode),s.isDelKeyPress(t.which,t.keyCode)||i||s.isModifier(t)?void 0:(this._processKey(String.fromCharCode(e),!1),s.preventDefault(t))},i.prototype._paste=function(t){return this._processKey(s.getClip(t),!1),s.preventDefault(t)},i.prototype._focus=function(){var t=this;setTimeout(function(){var s=e.get(t.el),i=s.end>t.focus,h=0===s.end;(i||h)&&e.set(t.el,t.focus)},0)},i.prototype._processKey=function(t,i,h){if(this.sel=e.get(this.el),this.val=this.el.value,this.delta=0,this.sel.begin!==this.sel.end)this.delta=-1*Math.abs(this.sel.begin-this.sel.end),this.val=s.removeChars(this.val,this.sel.begin,this.sel.end);else if(i&&46===i)this._delete();else if(i&&this.sel.begin-1>=0)this.val=s.removeChars(this.val,this.sel.end-1,this.sel.end),this.delta-=1;else if(i)return!0;i||(this.val=s.addChars(this.val,t,this.sel.begin),this.delta+=t.length),this._formatValue(h)},i.prototype._delete=function(){for(;this.chars[this.sel.begin];)this._nextPos();this.sel.begin<this.val.length&&(this._nextPos(),this.val=s.removeChars(this.val,this.sel.end-1,this.sel.end),this.delta=-1)},i.prototype._nextPos=function(){this.sel.end++,this.sel.begin++},i.prototype._formatValue=function(t){this.newPos=this.sel.end+this.delta,this._removeChars(),this._updatePattern(),this._validateInpts(),this._addChars(),this.el.value=this.val.substr(0,this.mLength),("undefined"==typeof t||t===!1)&&e.set(this.el,this.newPos)},i.prototype._removeChars=function(){this.sel.end>this.focus&&(this.delta+=this.sel.end-this.focus);for(var t=0,e=0;e<=this.mLength;e++){var i,h=this.chars[e],r=this.hldrs[e],n=e+t;n=e>=this.sel.begin?n+this.delta:n,i=this.val.charAt(n),(h&&h===i||r&&r===i)&&(this.val=s.removeChars(this.val,n,n+1),t--)}this.hldrs={},this.focus=this.val.length},i.prototype._validateInpts=function(){for(var t=0;t<this.val.length;t++){var e=this.inpts[t],i=!r[e],h=!i&&!r[e].test(this.val.charAt(t)),n=this.inpts[t];(i||h)&&n&&(this.val=s.removeChars(this.val,t,t+1),this.focusStart--,this.newPos--,this.delta--,t--)}},i.prototype._addChars=function(){if(this.opts.persistent){for(var t=0;t<=this.mLength;t++)this.val.charAt(t)||(this.val=s.addChars(this.val,this.opts.placeholder,t),this.hldrs[t]=this.opts.placeholder),this._addChar(t);for(;this.chars[this.focus];)this.focus++}else for(var e=0;e<=this.val.length;e++){if(this.delta<=0&&e===this.focus)return!0;this._addChar(e)}},i.prototype._addChar=function(t){var e=this.chars[t];return e?(s.isBetween(t,[this.sel.begin-1,this.newPos+1])&&(this.newPos++,this.delta++),t<=this.focus&&this.focus++,this.hldrs[t]&&(delete this.hldrs[t],this.hldrs[t+1]=this.opts.placeholder),void(this.val=s.addChars(this.val,e,t))):!0},i.prototype._specFromSinglePattern=function(t){return[{"*":t}]},i});