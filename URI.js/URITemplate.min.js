!function(e,t){"use strict";"object"==typeof module&&module.exports?module.exports=t(require("./URI")):"function"==typeof define&&define.amd?define(["./URI"],t):e.URITemplate=t(e.URI,e)}(this,function(f,e){"use strict";var t=e&&e.URITemplate,i=Object.prototype.hasOwnProperty;function u(e){return u._cache[e]||(this instanceof u?(this.expression=e,u._cache[e]=this):new u(e))}function o(e){this.data=e,this.cache={}}var r=u.prototype,m={"":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encode"},"+":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},"#":{prefix:"#",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},".":{prefix:".",separator:".",named:!1,empty_name_separator:!1,encode:"encode"},"/":{prefix:"/",separator:"/",named:!1,empty_name_separator:!1,encode:"encode"},";":{prefix:";",separator:";",named:!0,empty_name_separator:!1,encode:"encode"},"?":{prefix:"?",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"},"&":{prefix:"&",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"}};return u._cache={},u.EXPRESSION_PATTERN=/\{([^a-zA-Z0-9%_]?)([^\}]+)(\}|$)/g,u.VARIABLE_PATTERN=/^([^*:.](?:\.?[^*:.])*)((\*)|:(\d+))?$/,u.VARIABLE_NAME_PATTERN=/[^a-zA-Z0-9%_.]/,u.LITERAL_PATTERN=/[<>{}"`^| \\]/,u.expand=function(e,t,r){for(var n,a,o=m[e.operator],i=o.named?"Named":"Unnamed",p=e.variables,s=[],l=0;a=p[l];l++){if(0===(n=t.get(a.name)).type&&r&&r.strict)throw new Error('Missing expansion value for variable "'+a.name+'"');if(n.val.length){if(1<n.type&&a.maxlength)throw new Error('Invalid expression: Prefix modifier not applicable to variable "'+a.name+'"');s.push(u["expand"+i](n,o,a.explode,a.explode&&o.separator||",",a.maxlength,a.name))}else n.type&&s.push("")}return s.length?o.prefix+s.join(o.separator):""},u.expandNamed=function(e,t,r,n,a,o){for(var i,p="",s=t.encode,l=t.empty_name_separator,c=!e[s].length,d=2===e.type?"":f[s](o),h=0,u=e.val.length;h<u;h++)a?(i=f[s](e.val[h][1].substring(0,a)),2===e.type&&(d=f[s](e.val[h][0].substring(0,a)))):c?(i=f[s](e.val[h][1]),2===e.type?(d=f[s](e.val[h][0]),e[s].push([d,i])):e[s].push([void 0,i])):(i=e[s][h][1],2===e.type&&(d=e[s][h][0])),p&&(p+=n),r?p+=d+(l||i?"=":"")+i:(h||(p+=f[s](o)+(l||i?"=":"")),2===e.type&&(p+=d+","),p+=i);return p},u.expandUnnamed=function(e,t,r,n,a){for(var o,i="",p=t.encode,s=t.empty_name_separator,l=!e[p].length,c=0,d=e.val.length;c<d;c++)a?o=f[p](e.val[c][1].substring(0,a)):l?(o=f[p](e.val[c][1]),e[p].push([2===e.type?f[p](e.val[c][0]):void 0,o])):o=e[p][c][1],i&&(i+=n),2===e.type&&(i+=a?f[p](e.val[c][0].substring(0,a)):e[p][c][0],i+=r?s||o?"=":"":","),i+=o;return i},u.noConflict=function(){return e.URITemplate===u&&(e.URITemplate=t),u},r.expand=function(e,t){var r="";this.parts&&this.parts.length||this.parse(),e instanceof o||(e=new o(e));for(var n=0,a=this.parts.length;n<a;n++)r+="string"==typeof this.parts[n]?this.parts[n]:u.expand(this.parts[n],e,t);return r},r.parse=function(){function e(e){if(e.match(s))throw new Error('Invalid Literal "'+e+'"');return e}var t,r,n,a=this.expression,o=u.EXPRESSION_PATTERN,i=u.VARIABLE_PATTERN,p=u.VARIABLE_NAME_PATTERN,s=u.LITERAL_PATTERN,l=[],c=0;for(o.lastIndex=0;;){if(null===(r=o.exec(a))){l.push(e(a.substring(c)));break}if(l.push(e(a.substring(c,r.index))),c=r.index+r[0].length,!m[r[1]])throw new Error('Unknown Operator "'+r[1]+'" in "'+r[0]+'"');if(!r[3])throw new Error('Unclosed Expression "'+r[0]+'"');for(var d=0,h=(t=r[2].split(",")).length;d<h;d++){if(null===(n=t[d].match(i)))throw new Error('Invalid Variable "'+t[d]+'" in "'+r[0]+'"');if(n[1].match(p))throw new Error('Invalid Variable Name "'+n[1]+'" in "'+r[0]+'"');t[d]={name:n[1],explode:!!n[3],maxlength:n[4]&&parseInt(n[4],10)}}if(!t.length)throw new Error('Expression Missing Variable(s) "'+r[0]+'"');l.push({expression:r[0],operator:r[1],variables:t})}return l.length||l.push(e(a)),this.parts=l,this},o.prototype.get=function(e){var t,r,n,a=this.data,o={type:0,val:[],encode:[],encodeReserved:[]};if(void 0!==this.cache[e])return this.cache[e];if(this.cache[e]=o,null==(n="[object Function]"===String(Object.prototype.toString.call(a))?a(e):"[object Function]"===String(Object.prototype.toString.call(a[e]))?a[e](e):a[e]))return o;if("[object Array]"===String(Object.prototype.toString.call(n))){for(t=0,r=n.length;t<r;t++)void 0!==n[t]&&null!==n[t]&&o.val.push([void 0,String(n[t])]);o.val.length&&(o.type=3)}else if("[object Object]"===String(Object.prototype.toString.call(n))){for(t in n)i.call(n,t)&&void 0!==n[t]&&null!==n[t]&&o.val.push([t,String(n[t])]);o.val.length&&(o.type=2)}else o.type=1,o.val.push([void 0,String(n)]);return o},f.expand=function(e,t){t=new u(e).expand(t);return new f(t)},u});