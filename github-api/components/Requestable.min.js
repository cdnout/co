"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_axios=require("axios"),_axios2=_interopRequireDefault(_axios),_debug=require("debug"),_debug2=_interopRequireDefault(_debug),_jsBase=require("js-base64");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var log=(0,_debug2.default)("github:request"),ResponseError=function(){function o(e,t,r){_classCallCheck(this,o);e=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return e.path=t,e.request=r.config,e.response=(r||{}).response||r,e.status=r.status,e}return _inherits(o,Error),o}(),Requestable=function(){function o(e,t,r){_classCallCheck(this,o),this.__apiBase=t||"https://api.github.com",this.__auth={token:e.token,username:e.username,password:e.password},this.__AcceptHeader=r||"v3",e.token?this.__authorizationHeader="token "+e.token:e.username&&e.password&&(this.__authorizationHeader="Basic "+_jsBase.Base64.encode(e.username+":"+e.password))}return _createClass(o,[{key:"__getURL",value:function(e){var t=e;-1===e.indexOf("//")&&(t=this.__apiBase+e);e="timestamp="+(new Date).getTime();return t.replace(/(timestamp=\d+)/,e)}},{key:"__getRequestHeaders",value:function(e,t){t={"Content-Type":"application/json;charset=UTF-8",Accept:"application/vnd.github."+(t||this.__AcceptHeader)};return e&&(t.Accept+=".raw"),t.Accept+="+json",this.__authorizationHeader&&(t.Authorization=this.__authorizationHeader),t}},{key:"_getOptionsWithDefaults",value:function(e){e=0<arguments.length&&void 0!==e?e:{};return e.visibility||e.affiliation||(e.type=e.type||"all"),e.sort=e.sort||"updated",e.per_page=e.per_page||"100",e}},{key:"_dateToISO",value:function(e){return e&&e instanceof Date&&(e=e.toISOString()),e}},{key:"_request",value:function(e,t,r,o,n){var a=this.__getURL(t),s=(r||{}).AcceptHeader;s&&delete r.AcceptHeader;var i=this.__getRequestHeaders(n,s),s={};r&&"object"===(void 0===r?"undefined":_typeof(r))&&methodHasNoBody(e)&&(s=r,r=void 0);var u={url:a,method:e,headers:i,params:s,data:r,responseType:n?"text":"json"};log(u.method+" to "+u.url);t=(0,_axios2.default)(u).catch(callbackErrorOrThrow(o,t));return o&&t.then(function(e){!(e.data&&0<Object.keys(e.data).length)&&"GET"!==u.method&&Object.keys(e.data).length<1?o(null,e.status<300,e):o(null,e.data,e)}),t}},{key:"_request204or404",value:function(e,t,r,o){o=3<arguments.length&&void 0!==o?o:"GET";return this._request(o,e,t).then(function(e){return r&&r(null,!0,e),!0},function(e){if(404===e.response.status)return r&&r(null,!1,e),!1;throw r&&r(e),e})}},{key:"_requestAllPages",value:function(o,n,a,s){var i=this;return s=s||[],this._request("GET",o,n).then(function(e){var t=void 0;if(e.data instanceof Array)t=e.data;else{if(!(e.data.items instanceof Array)){var r="cannot figure out how to append "+e.data+" to the result set";throw new ResponseError(r,o,e)}t=e.data.items}s.push.apply(s,_toConsumableArray(t));t=getNextPage(e.headers.link);return t&&((n=n||{}).page=parseInt(t.match(/([&\?]page=[0-9]*)/g).shift().split("=").pop()),!n||"number"==typeof n.page)?(log("getting next page: "+t),i._requestAllPages(t,n,a,s)):(a&&a(null,s,e),e.data=s,e)}).catch(callbackErrorOrThrow(a,o))}}]),o}();module.exports=Requestable;var METHODS_WITH_NO_BODY=["GET","HEAD","DELETE"];function methodHasNoBody(e){return-1!==METHODS_WITH_NO_BODY.indexOf(e)}function getNextPage(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"").split(/\s*,\s*/).reduce(function(e,t){return-1!==t.search(/rel="next"/)?(t.match(/<(.*)>/)||[])[1]:e},void 0)}function callbackErrorOrThrow(n,a){return function(e){var t,r,o=void 0;if(e.hasOwnProperty("config")?(t=(r=e.response).status,r=r.statusText,r=t+" error making request "+(t=e.config).method+" "+t.url+': "'+r+'"',o=new ResponseError(r,a,e),log(r+" "+JSON.stringify(e.data))):o=e,!n)throw log("throwing error"),o;log("going to error callback"),n(o)}}