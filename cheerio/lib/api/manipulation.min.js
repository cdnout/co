var parse=require("../parse"),$=require("../static"),updateDOM=parse.update,evaluate=parse.evaluate,utils=require("../utils"),domEach=utils.domEach,cloneDom=utils.cloneDom,isHtml=utils.isHtml,slice=Array.prototype.slice,_={flatten:require("lodash.flatten"),bind:require("lodash.bind"),forEach:require("lodash.foreach")};exports._makeDomArray=function(t,e){return null==t?[]:t.cheerio?e?cloneDom(t.get(),t.options):t.get():Array.isArray(t)?_.flatten(t.map(function(t){return this._makeDomArray(t,e)},this)):"string"==typeof t?evaluate(t,this.options):e?cloneDom([t]):[t]};var _insert=function(l){return function(){var i=slice.call(arguments),o=this.length-1;return domEach(this,function(t,e){var r,n;n="function"==typeof i[0]?i[0].call(e,t,$.html(e.children)):i,r=this._makeDomArray(n,t<o),l(r,e.children,e)})}},uniqueSplice=function(t,e,r,n,i){var o,l,c,a,s,u=[e,r].concat(n),h=t[e-1]||null,p=t[e]||null;for(o=0,l=n.length;o<l;++o)c=(s=(a=n[o]).parent||a.root)&&s.children.indexOf(n[o]),s&&-1<c&&(s.children.splice(c,1),i===s&&c<e&&u[0]--),a.root=null,a.parent=i,a.prev&&(a.prev.next=a.next||null),a.next&&(a.next.prev=a.prev||null),a.prev=n[o-1]||h,a.next=n[o+1]||p;return h&&(h.next=n[0]),p&&(p.prev=n[n.length-1]),t.splice.apply(t,u)};exports.appendTo=function(t){return t.cheerio||(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t.append(this),this},exports.prependTo=function(t){return t.cheerio||(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t.prepend(this),this},exports.append=_insert(function(t,e,r){uniqueSplice(e,e.length,0,t,r)}),exports.prepend=_insert(function(t,e,r){uniqueSplice(e,0,0,t,r)}),exports.wrap=function(l){var c="function"==typeof l&&l,a=this.length-1;return _.forEach(this,_.bind(function(t,e){var r,n,i=t.parent||t.root,o=i.children;i&&(c&&(l=c.call(t,e)),"string"!=typeof l||isHtml(l)||(l=this.parents().last().find(l).clone()),r=this._makeDomArray(l,e<a).slice(0,1),n=o.indexOf(t),updateDOM([t],r[0]),uniqueSplice(o,n,0,r,i))},this)),this},exports.after=function(){var c=slice.call(arguments),a=this.length-1;return domEach(this,function(t,e){var r=e.parent||e.root;if(r){var n,i,o=r.children,l=o.indexOf(e);l<0||(n="function"==typeof c[0]?c[0].call(e,t,$.html(e.children)):c,i=this._makeDomArray(n,t<a),uniqueSplice(o,l+1,0,i,r))}}),this},exports.insertAfter=function(t){var l=[],c=this;return"string"==typeof t&&(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t=this._makeDomArray(t),c.remove(),domEach(t,function(t,e){var r=c._makeDomArray(c.clone()),n=e.parent||e.root;if(n){var i=n.children,o=i.indexOf(e);o<0||(uniqueSplice(i,o+1,0,r,n),l.push(r))}}),this.constructor.call(this.constructor,this._makeDomArray(l))},exports.before=function(){var c=slice.call(arguments),a=this.length-1;return domEach(this,function(t,e){var r=e.parent||e.root;if(r){var n,i,o=r.children,l=o.indexOf(e);l<0||(n="function"==typeof c[0]?c[0].call(e,t,$.html(e.children)):c,i=this._makeDomArray(n,t<a),uniqueSplice(o,l,0,i,r))}}),this},exports.insertBefore=function(t){var l=[],c=this;return"string"==typeof t&&(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t=this._makeDomArray(t),c.remove(),domEach(t,function(t,e){var r=c._makeDomArray(c.clone()),n=e.parent||e.root;if(n){var i=n.children,o=i.indexOf(e);o<0||(uniqueSplice(i,o,0,r,n),l.push(r))}}),this.constructor.call(this.constructor,this._makeDomArray(l))},exports.remove=function(t){var e=this;return t&&(e=e.filter(t)),domEach(e,function(t,e){var r=e.parent||e.root;if(r){var n=r.children,i=n.indexOf(e);i<0||(n.splice(i,1),e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),e.prev=e.next=e.parent=e.root=null)}}),this},exports.replaceWith=function(l){var c=this;return domEach(this,function(t,e){var r=e.parent||e.root;if(r){var n,i=r.children,o=c._makeDomArray("function"==typeof l?l.call(e,t,e):l);updateDOM(o,null),n=i.indexOf(e),uniqueSplice(i,n,1,o,r),e.parent=e.prev=e.next=e.root=null}}),this},exports.empty=function(){return domEach(this,function(t,e){_.forEach(e.children,function(t){t.next=t.prev=t.parent=null}),e.children.length=0}),this},exports.html=function(n){if(void 0===n)return this[0]&&this[0].children?$.html(this[0].children,this.options):null;var i=this.options;return domEach(this,function(t,e){_.forEach(e.children,function(t){t.next=t.prev=t.parent=null});var r=n.cheerio?n.clone().get():evaluate(""+n,i);updateDOM(r,e)}),this},exports.toString=function(){return $.html(this,this.options)},exports.text=function(n){return void 0===n?$.text(this):"function"==typeof n?domEach(this,function(t,e){var r=[e];return exports.text.call(r,n.call(e,t,$.text(r)))}):(domEach(this,function(t,e){_.forEach(e.children,function(t){t.next=t.prev=t.parent=null}),updateDOM({data:""+n,type:"text",parent:e,prev:null,next:null,children:[]},e)}),this)},exports.clone=function(){return this._make(cloneDom(this.get(),this.options))};