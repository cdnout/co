var $=require("../static"),utils=require("../utils"),isTag=utils.isTag,domEach=utils.domEach,hasOwn=Object.prototype.hasOwnProperty,camelCase=utils.camelCase,cssCase=utils.cssCase,rspace=/\s+/,dataAttrPrefix="data-",_={forEach:require("lodash.foreach"),extend:require("lodash.assignin"),some:require("lodash.some")},primitives={null:null,true:!0,false:!1},rboolean=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,getAttr=function(t,e){if(t&&isTag(t))return t.attribs||(t.attribs={}),e?hasOwn.call(t.attribs,e)?rboolean.test(e)?e:t.attribs[e]:"option"===t.name&&"value"===e?$.text(t.children):"input"!==t.name||"radio"!==t.attribs.type&&"checkbox"!==t.attribs.type||"value"!==e?void 0:"on":t.attribs},setAttr=function(t,e,s){null===s?removeAttribute(t,e):t.attribs[e]=s+""};exports.attr=function(a,r){return"object"==typeof a||void 0!==r?domEach(this,"function"==typeof r?function(t,e){setAttr(e,a,r.call(e,t,e.attribs[a]))}:function(t,s){isTag(s)&&("object"==typeof a?_.forEach(a,function(t,e){setAttr(s,e,t)}):setAttr(s,a,r))}):getAttr(this[0],a)};var getProp=function(t,e){if(t&&isTag(t))return t.hasOwnProperty(e)?t[e]:rboolean.test(e)?void 0!==getAttr(t,e):getAttr(t,e)},setProp=function(t,e,s){t[e]=rboolean.test(e)?!!s:s};exports.prop=function(a,r){var s,i=0;if("string"==typeof a&&void 0===r){switch(a){case"style":s=this.css(),_.forEach(s,function(t,e){s[i++]=e}),s.length=i;break;case"tagName":case"nodeName":s=this[0].name.toUpperCase();break;default:s=getProp(this[0],a)}return s}if("object"==typeof a||void 0!==r)return domEach(this,"function"==typeof r?function(t,e){setProp(e,a,r.call(e,t,getProp(e,a)))}:function(t,s){isTag(s)&&("object"==typeof a?_.forEach(a,function(t,e){setProp(s,e,t)}):setProp(s,a,r))})};var setData=function(t,e,s){if(t.data||(t.data={}),"object"==typeof e)return _.extend(t.data,e);"string"==typeof e&&void 0!==s?t.data[e]=s:"object"==typeof e&&_.extend(t.data,e)},readData=function(t,e){var s,a,r,i,n,o,l,c=1===arguments.length;for(r=c?(s=Object.keys(t.attribs).filter(function(t){return t.slice(0,dataAttrPrefix.length)===dataAttrPrefix})).map(function(t){return camelCase(t.slice(dataAttrPrefix.length))}):(s=[dataAttrPrefix+cssCase(e)],[e]),o=0,l=s.length;o<l;++o)if(a=s[o],i=r[o],hasOwn.call(t.attribs,a)){if(n=t.attribs[a],hasOwn.call(primitives,n))n=primitives[n];else if(n===String(Number(n)))n=Number(n);else if(rbrace.test(n))try{n=JSON.parse(n)}catch(t){}t.data[i]=n}return c?t.data:n};exports.data=function(s,a){var t=this[0];if(t&&isTag(t))return t.data||(t.data={}),s?"object"==typeof s||void 0!==a?(domEach(this,function(t,e){setData(e,s,a)}),this):hasOwn.call(t.data,s)?t.data[s]:readData(t,s):readData(t)},exports.val=function(t){var e=0===arguments.length,s=this[0];if(s)switch(s.name){case"textarea":return this.text(t);case"input":switch(this.attr("type")){case"radio":return e?this.attr("value"):(this.attr("value",t),this);default:return this.attr("value",t)}return;case"select":var a,r=this.find("option:selected");if(void 0===r)return;if(e)return a=r.attr("value"),this.attr().hasOwnProperty("multiple")&&(a=[],domEach(r,function(t,e){a.push(getAttr(e,"value"))})),a;if(!this.attr().hasOwnProperty("multiple")&&"object"==typeof t)return this;"object"!=typeof t&&(t=[t]),this.find("option").removeAttr("selected");for(var i=0;i<t.length;i++)this.find('option[value="'+t[i]+'"]').attr("selected","");return this;case"option":return e?this.attr("value"):(this.attr("value",t),this)}};var removeAttribute=function(t,e){t.attribs&&hasOwn.call(t.attribs,e)&&delete t.attribs[e]};exports.removeAttr=function(s){return domEach(this,function(t,e){removeAttribute(e,s)}),this},exports.hasClass=function(i){return _.some(this,function(t){var e,s=t.attribs,a=s&&s.class,r=-1;if(a)for(;-1<(r=a.indexOf(i,r+1));)if(e=r+i.length,(0===r||rspace.test(a[r-1]))&&(e===a.length||rspace.test(a[e])))return!0})},exports.addClass=function(a){if("function"==typeof a)return domEach(this,function(t,e){var s=e.attribs.class||"";exports.addClass.call([e],a.call(e,t,s))});if(!a||"string"!=typeof a)return this;for(var t=a.split(rspace),e=this.length,s=0;s<e;s++)if(isTag(this[s])){var r,i,n=getAttr(this[s],"class");if(n){i=" "+n+" ",r=t.length;for(var o=0;o<r;o++){var l=t[o]+" ";i.indexOf(" "+l)<0&&(i+=l)}setAttr(this[s],"class",i.trim())}else setAttr(this[s],"class",t.join(" ").trim())}return this};var splitClass=function(t){return t?t.trim().split(rspace):[]};exports.removeClass=function(s){var n,o,l;return"function"==typeof s?domEach(this,function(t,e){exports.removeClass.call([e],s.call(e,t,e.attribs.class||""))}):(n=splitClass(s),o=n.length,l=0===arguments.length,domEach(this,function(t,e){if(isTag(e))if(l)e.attribs.class="";else{for(var s,a,r=splitClass(e.attribs.class),i=0;i<o;i++)0<=(s=r.indexOf(n[i]))&&(r.splice(s,1),a=!0,i--);a&&(e.attribs.class=r.join(" "))}}))},exports.toggleClass=function(s,a){if("function"==typeof s)return domEach(this,function(t,e){exports.toggleClass.call([e],s.call(e,t,e.attribs.class||"",a),a)});if(!s||"string"!=typeof s)return this;for(var t,e,r=s.split(rspace),i=r.length,n="boolean"==typeof a?a?1:-1:0,o=this.length,l=0;l<o;l++)if(isTag(this[l])){t=splitClass(this[l].attribs.class);for(var c=0;c<i;c++)e=t.indexOf(r[c]),0<=n&&e<0?t.push(r[c]):n<=0&&0<=e&&t.splice(e,1);this[l].attribs.class=t.join(" ")}return this},exports.is=function(t){return!!t&&0<this.filter(t).length};