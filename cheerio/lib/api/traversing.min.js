var select=require("css-select"),utils=require("../utils"),domEach=utils.domEach,uniqueSort=require("htmlparser2").DomUtils.uniqueSort,isTag=utils.isTag,_={bind:require("lodash.bind"),forEach:require("lodash.foreach"),reject:require("lodash.reject"),filter:require("lodash.filter"),reduce:require("lodash.reduce")};exports.find=function(t){var e,r=_.reduce(this,function(t,e){return t.concat(_.filter(e.children,isTag))},[]),i=this.constructor.contains;if(t&&"string"!=typeof t)return e=t.cheerio?t.get():[t],this._make(e.filter(function(t){var e,r;for(e=0,r=this.length;e<r;++e)if(i(this[e],t))return!0},this));var n={__proto__:this.options,context:this.toArray()};return this._make(select(t,r,n))},exports.parent=function(t){var i=[];return domEach(this,function(t,e){var r=e.parent;r&&i.indexOf(r)<0&&i.push(r)}),arguments.length&&(i=exports.filter.call(i,t,this)),this._make(i)},exports.parents=function(e){var r=[];return this.get().reverse().forEach(function(t){traverseParents(this,t.parent,e,1/0).forEach(function(t){-1===r.indexOf(t)&&r.push(t)})},this),this._make(r)},exports.parentsUntil=function(t,e){var r,i,n=[];return"string"==typeof t?r=select(t,this.parents().toArray(),this.options)[0]:t&&t.cheerio?i=t.toArray():t&&(r=t),this.toArray().reverse().forEach(function(t){for(;(t=t.parent)&&(r&&t!==r||i&&-1===i.indexOf(t)||!r&&!i);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)},this),this._make(e?select(e,n,this.options):n)},exports.closest=function(i){var n=[];return i&&domEach(this,function(t,e){var r=traverseParents(this,e,i,1)[0];r&&n.indexOf(r)<0&&n.push(r)}.bind(this)),this._make(n)},exports.next=function(t){if(!this[0])return this;var e=[];return _.forEach(this,function(t){for(;t=t.next;)if(isTag(t))return void e.push(t)}),t?exports.filter.call(e,t,this):this._make(e)},exports.nextAll=function(t){if(!this[0])return this;var e=[];return _.forEach(this,function(t){for(;t=t.next;)isTag(t)&&-1===e.indexOf(t)&&e.push(t)}),t?exports.filter.call(e,t,this):this._make(e)},exports.nextUntil=function(t,e){if(!this[0])return this;var r,i,n=[];return"string"==typeof t?r=select(t,this.nextAll().get(),this.options)[0]:t&&t.cheerio?i=t.get():t&&(r=t),_.forEach(this,function(t){for(;(t=t.next)&&(r&&t!==r||i&&-1===i.indexOf(t)||!r&&!i);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)}),e?exports.filter.call(n,e,this):this._make(n)},exports.prev=function(t){if(!this[0])return this;var e=[];return _.forEach(this,function(t){for(;t=t.prev;)if(isTag(t))return void e.push(t)}),t?exports.filter.call(e,t,this):this._make(e)},exports.prevAll=function(t){if(!this[0])return this;var e=[];return _.forEach(this,function(t){for(;t=t.prev;)isTag(t)&&-1===e.indexOf(t)&&e.push(t)}),t?exports.filter.call(e,t,this):this._make(e)},exports.prevUntil=function(t,e){if(!this[0])return this;var r,i,n=[];return"string"==typeof t?r=select(t,this.prevAll().get(),this.options)[0]:t&&t.cheerio?i=t.get():t&&(r=t),_.forEach(this,function(t){for(;(t=t.prev)&&(r&&t!==r||i&&-1===i.indexOf(t)||!r&&!i);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)}),e?exports.filter.call(n,e,this):this._make(n)},exports.siblings=function(t){var e=this.parent(),r=_.filter(e?e.children():this.siblingsAndMe(),_.bind(function(t){return isTag(t)&&!this.is(t)},this));return void 0!==t?exports.filter.call(r,t,this):this._make(r)},exports.children=function(t){var e=_.reduce(this,function(t,e){return t.concat(_.filter(e.children,isTag))},[]);return void 0===t?this._make(e):exports.filter.call(e,t,this)},exports.contents=function(){return this._make(_.reduce(this,function(t,e){return t.push.apply(t,e.children),t},[]))},exports.each=function(t){for(var e=0,r=this.length;e<r&&!1!==t.call(this[e],e,this[e]);)++e;return this},exports.map=function(n){return this._make(_.reduce(this,function(t,e,r){var i=n.call(e,r,e);return null==i?t:t.concat(i)},[]))};var makeFilterMethod=function(i){return function(r,t){var e;return t=t||this,e="string"==typeof r?select.compile(r,t.options):"function"==typeof r?function(t,e){return r.call(t,e,t)}:r.cheerio?r.is.bind(r):function(t){return r===t},t._make(i(this,e))}};function traverseParents(t,e,r,i){for(var n=[];e&&n.length<i;)r&&!exports.filter.call([e],r,t).length||n.push(e),e=e.parent;return n}exports.filter=makeFilterMethod(_.filter),exports.not=makeFilterMethod(_.reject),exports.has=function(t){var e=this;return exports.filter.call(this,function(){return 0<e._make(this).find(t).length})},exports.first=function(){return 1<this.length?this._make(this[0]):this},exports.last=function(){return 1<this.length?this._make(this[this.length-1]):this},exports.eq=function(t){return 0===(t=+t)&&this.length<=1?this:(t<0&&(t=this.length+t),this[t]?this._make(this[t]):this._make([]))},exports.get=function(t){return null==t?Array.prototype.slice.call(this):this[t<0?this.length+t:t]},exports.index=function(t){var e,r;return r=0===arguments.length?(e=this.parent().children(),this[0]):"string"==typeof t?(e=this._make(t),this[0]):(e=this,t.cheerio?t[0]:t),e.get().indexOf(r)},exports.slice=function(){return this._make([].slice.apply(this,arguments))},exports.end=function(){return this.prevObject||this._make([])},exports.add=function(t,e){for(var r=this._make(t,e),i=uniqueSort(r.get().concat(this.get())),n=0;n<i.length;++n)r[n]=i[n];return r.length=i.length,r},exports.addBack=function(t){return this.add(arguments.length?this.prevObject.filter(t):this.prevObject)};