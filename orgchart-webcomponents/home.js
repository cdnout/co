export default class OrgChart extends HTMLElement{constructor(e){super(),Promise.prototype.finally=function(e){let t=this.constructor;return this.then(s=>t.resolve(e()).then(()=>s),s=>t.resolve(e()).then(()=>{throw s}))};let t={nodeTitle:"name",nodeId:"id",toggleSiblingsResp:!1,depth:999,chartClass:"",parentNodeSymbol:"fa-users",draggable:!1,direction:"t2b",pan:!1,zoom:!1},s=Object.assign(t,e);if(this.options=s,this.addEventListener("click",this._clickChart.bind(this)),s.pan&&s.chartContainer&&(document.querySelector(s.chartContainer).style.overflow="hidden",this.addEventListener("mousedown",this._onPanStart.bind(this)),this.addEventListener("touchstart",this._onPanStart.bind(this)),document.body.addEventListener("mouseup",this._onPanEnd.bind(this)),document.body.addEventListener("touchend",this._onPanEnd.bind(this))),s.zoom&&s.chartContainer){let e=document.querySelector(s.chartContainer);e.addEventListener("wheel",this._onWheeling.bind(this)),e.addEventListener("touchstart",this._onTouchStart.bind(this)),document.body.addEventListener("touchmove",this._onTouchMove.bind(this)),document.body.addEventListener("touchend",this._onTouchEnd.bind(this))}}connectedCallback(){let e=this,t=this.options,s=t.data;if(this.setAttribute("class","orgchart"+(""!==t.chartClass?" "+t.chartClass:"")+("t2b"!==t.direction?" "+t.direction:"")),"object"==typeof s)this.buildHierarchy(this,t.ajaxURL?s:this._attachRel(s,"00"),0);else if("string"==typeof s&&s.startsWith("#"))this.buildHierarchy(this,this._buildJsonDS(document.querySelector(s).children[0]),0);else{let i=document.createElement("i");i.setAttribute("class","fa fa-circle-o-notch fa-spin spinner"),this.appendChild(i),this._getJSON(s).then(function(s){e.buildHierarchy(e,t.ajaxURL?s:e._attachRel(s,"00"),0)}).catch(function(e){console.error("failed to fetch datasource for orgchart",e)}).finally(function(){let t=e.querySelector(".spinner");t.parentNode.removeChild(t)})}}disconnectedCallback(){}attributeChangedCallback(e,t,s){}_closest(e,t){return e&&(t(e)&&e!==this?e:this._closest(e.parentNode,t))}_siblings(e,t){return Array.from(e.parentNode.children).filter(s=>s!==e&&(!t||e.matches(t)))}_prevAll(e,t){let s=[],i=e.previousElementSibling;for(;i;)t&&!i.matches(t)||s.push(i),i=i.previousElementSibling;return s}_nextAll(e,t){let s=[],i=e.nextElementSibling;for(;i;)t&&!i.matches(t)||s.push(i),i=i.nextElementSibling;return s}_isVisible(e){return null!==e.offsetParent}_addClass(e,t){e.forEach(e=>{t.indexOf(" ")>0?t.split(" ").forEach(t=>e.classList.add(t)):e.classList.add(t)})}_removeClass(e,t){e.forEach(e=>{t.indexOf(" ")>0?t.split(" ").forEach(t=>e.classList.remove(t)):e.classList.remove(t)})}_css(e,t,s){e.forEach(e=>{e.style[t]=s})}_removeAttr(e,t){e.forEach(e=>{e.removeAttribute(t)})}_one(e,t,s,i){let n=function(r){try{s.call(i,r)}finally{e.removeEventListener(t,n)}};e.addEventListener(t,n)}_getDescElements(e,t){let s=[];return e.forEach(e=>s.push(...e.querySelectorAll(t))),s}_getJSON(e){return new Promise(function(t,s){let i=new XMLHttpRequest;i.open("GET",e),i.onreadystatechange=function(){4===this.readyState&&(200===this.status?t(JSON.parse(this.response)):s(new Error(this.statusText)))},i.responseType="json",i.setRequestHeader("Content-Type","application/json"),i.send()})}_buildJsonDS(e){let t={name:e.firstChild.textContent.trim(),relationship:("LI"===e.parentNode.parentNode.nodeName?"1":"0")+(e.parentNode.children.length>1?1:0)+(e.children.length?1:0)};return e.id&&(t.id=e.id),e.querySelector("ul")&&Array.from(e.querySelector("ul").children).forEach(e=>{t.children||(t.children=[]),t.children.push(this._buildJsonDS(e))}),t}_attachRel(e,t){if(e.relationship=t+(e.children&&e.children.length>0?1:0),e.children)for(let t of e.children)this._attachRel(t,"1"+(e.children.length>1?1:0));return e}_repaint(e){e&&(e.style.offsetWidth=e.offsetWidth)}_isInAction(e){return e.querySelector(":scope > .edge").className.indexOf("fa-")>-1}_getNodeState(e,t){let s,i={exist:!1,visible:!1};return"parent"===t?((s=this._closest(e,e=>e.classList&&e.classList.contains("nodes")))&&(i.exist=!0),i.exist&&this._isVisible(s.parentNode.children[0])&&(i.visible=!0)):"children"===t?((s=this._closest(e,e=>"TR"===e.nodeName).nextElementSibling)&&(i.exist=!0),i.exist&&this._isVisible(s)&&(i.visible=!0)):"siblings"===t&&((s=this._siblings(this._closest(e,e=>"TABLE"===e.nodeName).parentNode)).length&&(i.exist=!0),i.exist&&s.some(e=>this._isVisible(e))&&(i.visible=!0)),i}getRelatedNodes(e,t){return"parent"===t?this._closest(e,e=>e.classList.contains("nodes")).parentNode.children[0].querySelector(".node"):"children"===t?Array.from(this._closest(e,e=>"TABLE"===e.nodeName).lastChild.children).map(e=>e.querySelector(".node")):"siblings"===t?this._siblings(this._closest(e,e=>"TABLE"===e.nodeName).parentNode).map(e=>e.querySelector(".node")):[]}_switchHorizontalArrow(e){let t=this.options,s=e.querySelector(".leftEdge"),i=e.querySelector(".rightEdge"),n=this._closest(e,e=>"TABLE"===e.nodeName).parentNode;if(t.toggleSiblingsResp&&(void 0===t.ajaxURL||this._closest(e,e=>e.classList.contains(".nodes")).dataset.siblingsLoaded)){let e=n.previousElementSibling,t=n.nextElementSibling;e&&(e.classList.contains("hidden")?(s.classList.add("fa-chevron-left"),s.classList.remove("fa-chevron-right")):(s.classList.add("fa-chevron-right"),s.classList.remove("fa-chevron-left"))),t&&(t.classList.contains("hidden")?(i.classList.add("fa-chevron-right"),i.classList.remove("fa-chevron-left")):(i.classList.add("fa-chevron-left"),i.classList.remove("fa-chevron-right")))}else{let e=this._siblings(n),t=!!e.length&&!e.some(e=>e.classList.contains("hidden"));s.classList.toggle("fa-chevron-right",t),s.classList.toggle("fa-chevron-left",!t),i.classList.toggle("fa-chevron-left",t),i.classList.toggle("fa-chevron-right",!t)}}_hoverNode(e){let t=e.target,s=!1,i=t.querySelector(":scope > .topEdge"),n=t.querySelector(":scope > .bottomEdge"),r=t.querySelector(":scope > .leftEdge");"mouseenter"===e.type?(i&&(s=this._getNodeState(t,"parent").visible,i.classList.toggle("fa-chevron-up",!s),i.classList.toggle("fa-chevron-down",s)),n&&(s=this._getNodeState(t,"children").visible,n.classList.toggle("fa-chevron-down",!s),n.classList.toggle("fa-chevron-up",s)),r&&this._switchHorizontalArrow(t)):Array.from(t.querySelectorAll(":scope > .edge")).forEach(e=>{e.classList.remove("fa-chevron-up","fa-chevron-down","fa-chevron-right","fa-chevron-left")})}_clickNode(e){let t=e.currentTarget,s=this.querySelector(".focused");s&&s.classList.remove("focused"),t.classList.add("focused")}_buildParentNode(e,t,s){let i=this,n=document.createElement("table");t.relationship="001",this._createNode(t,0).then(function(e){e.classList.remove("slide-up"),e.classList.add("slide-down");let t=document.createElement("tr"),r=document.createElement("tr"),l=document.createElement("tr"),o=document.createElement("tr");t.setAttribute("class","hidden"),t.innerHTML=`<td colspan="2"></td>`,n.appendChild(t),r.setAttribute("class","lines hidden"),r.innerHTML=`<td colspan="2"><div class="downLine"></div></td>`,n.appendChild(r),l.setAttribute("class","lines hidden"),l.innerHTML=`<td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td>`,n.appendChild(l),o.setAttribute("class","nodes"),o.innerHTML=`<td colspan="2"></td>`,n.appendChild(o),n.querySelector("td").appendChild(e),i.insertBefore(n,i.children[0]),n.children[3].children[0].appendChild(i.lastChild),s()}).catch(function(e){console.error("Failed to create parent node",e)})}_switchVerticalArrow(e){e.classList.toggle("fa-chevron-up"),e.classList.toggle("fa-chevron-down")}showParent(e){let t=this._prevAll(this._closest(e,e=>e.classList.contains("nodes")));this._removeClass(t,"hidden"),this._addClass(Array(t[0].children).slice(1,-1),"hidden");let s=t[2].querySelector(".node");this._one(s,"transitionend",function(){s.classList.remove("slide"),this._isInAction(e)&&this._switchVerticalArrow(e.querySelector(":scope > .topEdge"))},this),this._repaint(s),s.classList.add("slide"),s.classList.remove("slide-down")}showSiblings(e,t){let s=[],i=this._closest(e,e=>"TABLE"===e.nodeName).parentNode;s=t?"left"===t?this._prevAll(i):this._nextAll(i):this._siblings(i),this._removeClass(s,"hidden");let n=this._prevAll(this._closest(e,e=>e.classList.contains("nodes")));if(i=Array.from(n[0].querySelectorAll(":scope > .hidden")),t?this._removeClass(i.slice(0,2*s.length),"hidden"):this._removeClass(i,"hidden"),!this._getNodeState(e,"parent").visible){this._removeClass(n,"hidden");let e=n[2].querySelector(".node");this._one(e,"transitionend",function(e){e.target.classList.remove("slide")},this),this._repaint(e),e.classList.add("slide"),e.classList.remove("slide-down")}s.forEach(e=>{Array.from(e.querySelectorAll(".node")).forEach(e=>{this._isVisible(e)&&(e.classList.add("slide"),e.classList.remove("slide-left","slide-right"))})}),this._one(s[0].querySelector(".slide"),"transitionend",function(){s.forEach(e=>{this._removeClass(Array.from(e.querySelectorAll(".slide")),"slide")}),this._isInAction(e)&&(this._switchHorizontalArrow(e),e.querySelector(".topEdge").classList.remove("fa-chevron-up"),e.querySelector(".topEdge").classList.add("fa-chevron-down"))},this)}hideSiblings(e,t){let s=this._closest(e,e=>"TABLE"===e.nodeName).parentNode;this._siblings(s).forEach(e=>{e.querySelector(".spinner")&&(this.dataset.inAjax=!1)}),(!t||t&&"left"===t)&&this._prevAll(s).forEach(e=>{Array.from(e.querySelectorAll(".node")).forEach(e=>{this._isVisible(e)&&e.classList.add("slide","slide-right")})}),(!t||t&&"left"!==t)&&this._nextAll(s).forEach(e=>{Array.from(e.querySelectorAll(".node")).forEach(e=>{this._isVisible(e)&&e.classList.add("slide","slide-left")})});let i=[];this._siblings(s).forEach(e=>{Array.prototype.push.apply(i,Array.from(e.querySelectorAll(".slide")))});let n=[];for(let e of i){let t=this._closest(e,function(e){return e.classList.contains("nodes")}).previousElementSibling;n.push(t),n.push(t.previousElementSibling)}(n=[...new Set(n)]).forEach(function(e){e.style.visibility="hidden"}),this._one(i[0],"transitionend",function(r){n.forEach(function(e){e.removeAttribute("style")});let l=[];l=t?"left"===t?this._prevAll(s,":not(.hidden)"):this._nextAll(s,":not(.hidden)"):this._siblings(s);let o=Array.from(this._closest(s,function(e){return e.classList.contains("nodes")}).previousElementSibling.querySelectorAll(":scope > :not(.hidden)")).slice(1,t?2*l.length+1:-1);this._addClass(o,"hidden"),this._removeClass(i,"slide"),l.forEach(e=>{Array.from(e.querySelectorAll(".node")).slice(1).forEach(e=>{this._isVisible(e)&&(e.classList.remove("slide-left","slide-right"),e.classList.add("slide-up"))})}),l.forEach(e=>{this._addClass(Array.from(e.querySelectorAll(".lines")),"hidden"),this._addClass(Array.from(e.querySelectorAll(".nodes")),"hidden"),this._addClass(Array.from(e.querySelectorAll(".verticalNodes")),"hidden")}),this._addClass(l,"hidden"),this._isInAction(e)&&this._switchHorizontalArrow(e)},this)}hideParent(e){let t=Array.from(this._closest(e,function(e){return e.classList.contains("nodes")}).parentNode.children).slice(0,3);t[0].querySelector(".spinner")&&(this.dataset.inAjax=!1),this._getNodeState(e,"siblings").visible&&this.hideSiblings(e);let s=t.slice(1);this._css(s,"visibility","hidden");let i=t[0].querySelector(".node"),n=this._getNodeState(i,"parent").visible;i&&this._isVisible(i)&&(i.classList.add("slide","slide-down"),this._one(i,"transitionend",function(){i.classList.remove("slide"),this._removeAttr(s,"style"),this._addClass(t,"hidden")},this)),i&&n&&this.hideParent(i)}addParent(e,t){let s=this;this._buildParentNode(e,t,function(){if(!e.querySelector(":scope > .topEdge")){let t=document.createElement("i");t.setAttribute("class","edge verticalEdge topEdge fa"),e.appendChild(t)}s.showParent(e)})}_startLoading(e,t){this.options;if(void 0!==this.dataset.inAjax&&"true"===this.dataset.inAjax)return!1;e.classList.add("hidden");let s=document.createElement("i");return s.setAttribute("class","fa fa-circle-o-notch fa-spin spinner"),t.appendChild(s),this._addClass(Array.from(t.querySelectorAll(":scope > *:not(.spinner)")),"hazy"),this.dataset.inAjax=!0,!0}_endLoading(e,t){this.options;e.classList.remove("hidden"),t.querySelector(":scope > .spinner").remove(),this._removeClass(Array.from(t.querySelectorAll(":scope > .hazy")),"hazy"),this.dataset.inAjax=!1}_clickTopEdge(e){e.stopPropagation();let t=this,s=e.target,i=s.parentNode,n=this._getNodeState(i,"parent"),r=this.options;if(n.exist){let e=this._closest(i,function(e){return e.classList.contains("nodes")}).parentNode.firstChild.querySelector(".node");if(e.classList.contains("slide"))return;n.visible?(this.hideParent(i),this._one(e,"transitionend",function(){this._isInAction(i)&&(this._switchVerticalArrow(s),this._switchHorizontalArrow(i))},this)):this.showParent(i)}else{let e=s.parentNode.id;this._startLoading(s,i)&&this._getJSON("function"==typeof r.ajaxURL.parent?r.ajaxURL.parent(i.dataset.source):r.ajaxURL.parent+e).then(function(e){"true"===t.dataset.inAjax&&Object.keys(e).length&&t.addParent(i,e)}).catch(function(e){console.error("Failed to get parent node data.",e)}).finally(function(){t._endLoading(s,i)})}}hideChildren(e){let t=this,s=this._nextAll(e.parentNode.parentNode),i=s[s.length-1],n=[];i.querySelector(".spinner")&&(this.dataset.inAjax=!1);let r=Array.from(i.querySelectorAll(".node")).filter(e=>t._isVisible(e)),l=i.classList.contains("verticalNodes");l||(r.forEach(e=>{Array.prototype.push.apply(n,t._prevAll(t._closest(e,e=>e.classList.contains("nodes")),".lines"))}),n=[...new Set(n)],this._css(n,"visibility","hidden")),this._one(r[0],"transitionend",function(o){this._removeClass(r,"slide"),l?t._addClass(s,"hidden"):(n.forEach(e=>{e.removeAttribute("style"),e.classList.add("hidden"),e.parentNode.lastChild.classList.add("hidden")}),this._addClass(Array.from(i.querySelectorAll(".verticalNodes")),"hidden")),this._isInAction(e)&&this._switchVerticalArrow(e.querySelector(".bottomEdge"))},this),this._addClass(r,"slide slide-up")}showChildren(e){let t=this,s=this._nextAll(e.parentNode.parentNode),i=[];this._removeClass(s,"hidden"),s.some(e=>e.classList.contains("verticalNodes"))?s.forEach(e=>{Array.prototype.push.apply(i,Array.from(e.querySelectorAll(".node")).filter(e=>t._isVisible(e)))}):Array.from(s[2].children).forEach(e=>{Array.prototype.push.apply(i,Array.from(e.querySelector("tr").querySelectorAll(".node")).filter(e=>t._isVisible(e)))}),this._repaint(i[0]),this._one(i[0],"transitionend",t=>{this._removeClass(i,"slide"),this._isInAction(e)&&this._switchVerticalArrow(e.querySelector(".bottomEdge"))},this),this._addClass(i,"slide"),this._removeClass(i,"slide-up")}_buildChildNode(e,t,s){let i=t.children||t.siblings;e.querySelector("td").setAttribute("colSpan",2*i.length),this.buildHierarchy(e,{children:i},0,s)}addChildren(e,t){let s=this,i=this.options,n=0;this.dataset.inEdit="addChildren",this._buildChildNode.call(this,this._closest(e,e=>"TABLE"===e.nodeName),t,function(){if(++n===t.children.length){if(!e.querySelector(".bottomEdge")){let t=document.createElement("i");t.setAttribute("class","edge verticalEdge bottomEdge fa"),e.appendChild(t)}if(!e.querySelector(".symbol")){let t=document.createElement("i");t.setAttribute("class","fa "+i.parentNodeSymbol+" symbol"),e.querySelector(":scope > .title").appendChild(t)}s.showChildren(e),s.dataset.inEdit=""}})}_clickBottomEdge(e){e.stopPropagation();let t=this,s=this.options,i=e.target,n=i.parentNode,r=this._getNodeState(n,"children");if(r.exist){let e=this._closest(n,function(e){return"TR"===e.nodeName}).parentNode.lastChild;if(Array.from(e.querySelectorAll(".node")).some(e=>this._isVisible(e)&&e.classList.contains("slide")))return;r.visible?this.hideChildren(n):this.showChildren(n)}else{let e=i.parentNode.id;this._startLoading(i,n)&&this._getJSON("function"==typeof s.ajaxURL.children?s.ajaxURL.children(n.dataset.source):s.ajaxURL.children+e).then(function(e){"true"===t.dataset.inAjax&&e.children.length&&t.addChildren(n,e)}).catch(function(e){console.error("Failed to get children nodes data",e)}).finally(function(){t._endLoading(i,n)})}}_complementLine(e,t,s){let i=e.parentNode.parentNode.children;i[0].children[0].setAttribute("colspan",2*t),i[1].children[0].setAttribute("colspan",2*t);for(let e=0;e<s;e++){let e=document.createElement("td"),t=document.createElement("td");e.setAttribute("class","rightLine topLine"),e.innerHTML="&nbsp;",i[2].insertBefore(e,i[2].children[1]),t.setAttribute("class","leftLine topLine"),t.innerHTML="&nbsp;",i[2].insertBefore(t,i[2].children[1])}}_buildSiblingNode(e,t,s){let i=this,n=t.siblings?t.siblings.length:t.children.length,r="TD"===e.parentNode.nodeName?this._closest(e,e=>"TR"===e.nodeName).children.length:1,l=r+n,o=l>1?Math.floor(l/2-1):0;if("TD"===e.parentNode.nodeName){let a=this._prevAll(e.parentNode.parentNode);a[0].remove(),a[1].remove();let d=0;i._buildChildNode.call(i,i._closest(e.parentNode,e=>"TABLE"===e.nodeName),t,()=>{if(++d===n){let t=Array.from(i._closest(e.parentNode,e=>"TABLE"===e.nodeName).lastChild.children);if(r>1){let s=e.parentNode.parentNode;Array.from(s.children).forEach(e=>{t[0].parentNode.insertBefore(e,t[0])}),s.remove(),i._complementLine(t[0],l,r),i._addClass(t,"hidden"),t.forEach(e=>{i._addClass(e.querySelectorAll(".node"),"slide-left")})}else{let s=e.parentNode.parentNode;t[o].parentNode.insertBefore(e.parentNode,t[o+1]),s.remove(),i._complementLine(t[o],l,1),i._addClass(t,"hidden"),i._addClass(i._getDescElements(t.slice(0,o+1),".node"),"slide-right"),i._addClass(i._getDescElements(t.slice(o+1),".node"),"slide-left")}s()}})}else{let n=0;i.buildHierarchy.call(i,i,t,0,()=>{if(++n===l){let t=e.nextElementSibling.children[3].children[o],n=document.createElement("td");n.setAttribute("colspan",2),n.appendChild(e),t.parentNode.insertBefore(n,t.nextElementSibling),i._complementLine(t,l,1);let r=i._closest(e,e=>e.classList&&e.classList.contains("nodes")).parentNode.children[0];r.classList.add("hidden"),i._addClass(Array.from(r.querySelectorAll(".node")),"slide-down");let a=this._siblings(e.parentNode);i._addClass(a,"hidden"),i._addClass(i._getDescElements(a.slice(0,o),".node"),"slide-right"),i._addClass(i._getDescElements(a.slice(o),".node"),"slide-left"),s()}})}}addSiblings(e,t){let s=this;this.dataset.inEdit="addSiblings",this._buildSiblingNode.call(this,this._closest(e,e=>"TABLE"===e.nodeName),t,()=>{if(s._closest(e,e=>e.classList&&e.classList.contains("nodes")).dataset.siblingsLoaded=!0,!e.querySelector(".leftEdge")){let t=document.createElement("i"),s=document.createElement("i");t.setAttribute("class","edge horizontalEdge rightEdge fa"),e.appendChild(t),s.setAttribute("class","edge horizontalEdge leftEdge fa"),e.appendChild(s)}s.showSiblings(e),s.dataset.inEdit=""})}removeNodes(e){let t=this._closest(e,e=>"TABLE"===e.nodeName).parentNode,s=this._siblings(t.parentNode);"TD"===t.nodeName?this._getNodeState(e,"siblings").exist?(s[2].querySelector(".topLine").nextElementSibling.remove(),s[2].querySelector(".topLine").remove(),s[0].children[0].setAttribute("colspan",s[2].children.length),s[1].children[0].setAttribute("colspan",s[2].children.length),t.remove()):(s[0].children[0].removeAttribute("colspan"),s[0].querySelector(".bottomEdge").remove(),this._siblings(s[0]).forEach(e=>e.remove())):Array.from(t.parentNode.children).forEach(e=>e.remove())}_clickHorizontalEdge(e){e.stopPropagation();let t=this,s=this.options,i=e.target,n=i.parentNode,r=this._getNodeState(n,"siblings");if(r.exist){let e=this._closest(n,function(e){return"TABLE"===e.nodeName}).parentNode;if(this._siblings(e).some(e=>{let t=e.querySelector(".node");return this._isVisible(t)&&t.classList.contains("slide")}))return;if(s.toggleSiblingsResp){let e=this._closest(n,e=>"TABLE"===e.nodeName).parentNode.previousElementSibling,t=this._closest(n,e=>"TABLE"===e.nodeName).parentNode.nextElementSibling;i.classList.contains("leftEdge")?e.classList.contains("hidden")?this.showSiblings(n,"left"):this.hideSiblings(n,"left"):t.classList.contains("hidden")?this.showSiblings(n,"right"):this.hideSiblings(n,"right")}else r.visible?this.hideSiblings(n):this.showSiblings(n)}else{let e=i.parentNode.id,r=this._getNodeState(n,"parent").exist?"function"==typeof s.ajaxURL.siblings?s.ajaxURL.siblings(JSON.parse(n.dataset.source)):s.ajaxURL.siblings+e:"function"==typeof s.ajaxURL.families?s.ajaxURL.families(JSON.parse(n.dataset.source)):s.ajaxURL.families+e;this._startLoading(i,n)&&this._getJSON(r).then(function(e){"true"===t.dataset.inAjax&&(e.siblings||e.children)&&t.addSiblings(n,e)}).catch(function(e){console.error("Failed to get sibling nodes data",e)}).finally(function(){t._endLoading(i,n)})}}_clickToggleButton(e){let t=this,s=e.target,i=s.parentNode.nextElementSibling,n=Array.from(i.querySelectorAll(".node")),r=Array.from(i.children).map(e=>e.querySelector(".node"));r.some(e=>e.classList.contains("slide"))||(s.classList.toggle("fa-plus-square"),s.classList.toggle("fa-minus-square"),n[0].classList.contains("slide-up")?(i.classList.remove("hidden"),this._repaint(r[0]),this._addClass(r,"slide"),this._removeClass(r,"slide-up"),this._one(r[0],"transitionend",()=>{t._removeClass(r,"slide")})):(this._addClass(n,"slide slide-up"),this._one(n[0],"transitionend",()=>{t._removeClass(n,"slide"),n.forEach(e=>{t._closest(e,function(e){return"UL"===e.nodeName}).classList.add("hidden")})}),n.forEach(e=>{let s=Array.from(e.querySelectorAll(".toggleBtn"));t._removeClass(s,"fa-minus-square"),t._addClass(s,"fa-plus-square")})))}_dispatchClickEvent(e){let t=e.target.classList;t.contains("topEdge")?this._clickTopEdge(e):t.contains("rightEdge")||t.contains("leftEdge")?this._clickHorizontalEdge(e):t.contains("bottomEdge")?this._clickBottomEdge(e):t.contains("toggleBtn")?this._clickToggleButton(e):this._clickNode(e)}_onDragStart(e){let t=e.target,s=this.options,i=/firefox/.test(window.navigator.userAgent.toLowerCase());if(i&&e.dataTransfer.setData("text/html","hack for firefox"),this.style.transform){let n,r;document.querySelector(".ghost-node")?r=(n=this.querySelector(":scope > .ghost-node")).children[0]:((n=document.createElementNS("http://www.w3.org/2000/svg","svg")).classList.add("ghost-node"),r=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.appendChild(r),this.appendChild(n));let l=this.style.transform.split(","),o=Math.abs(window.parseFloat("t2b"===s.direction||"b2t"===s.direction?l[0].slice(l[0].indexOf("(")+1):l[1]));n.setAttribute("width",t.offsetWidth),n.setAttribute("height",t.offsetHeight),r.setAttribute("x",5*o),r.setAttribute("y",5*o),r.setAttribute("width",120*o),r.setAttribute("height",40*o),r.setAttribute("rx",4*o),r.setAttribute("ry",4*o),r.setAttribute("stroke-width",1*o);let a=e.offsetX*o,d=e.offsetY*o;if("l2r"===s.direction?(a=e.offsetY*o,d=e.offsetX*o):"r2l"===s.direction?(a=t.offsetWidth-e.offsetY*o,d=e.offsetX*o):"b2t"===s.direction&&(a=t.offsetWidth-e.offsetX*o,d=t.offsetHeight-e.offsetY*o),i){let t=document.createElement("img");t.src="data:image/svg+xml;utf8,"+(new XMLSerializer).serializeToString(n),e.dataTransfer.setDragImage(t,a,d),r.setAttribute("fill","rgb(255, 255, 255)"),r.setAttribute("stroke","rgb(191, 0, 0)")}else e.dataTransfer.setDragImage(n,a,d)}let n=e.target,r=this._closest(n,e=>e.classList&&e.classList.contains("nodes")).parentNode.children[0].querySelector(".node"),l=Array.from(this._closest(n,e=>"TABLE"===e.nodeName).querySelectorAll(".node"));this.dragged=n,Array.from(this.querySelectorAll(".node")).forEach(function(e){l.includes(e)||(s.dropCriteria?s.dropCriteria(n,r,e)&&e.classList.add("allowedDrop"):e.classList.add("allowedDrop"))})}_onDragOver(e){e.preventDefault(),e.currentTarget.classList.contains("allowedDrop")||(e.dataTransfer.dropEffect="none")}_onDragEnd(e){Array.from(this.querySelectorAll(".allowedDrop")).forEach(function(e){e.classList.remove("allowedDrop")})}_onDrop(e){let t=e.currentTarget,s=this.dragged,i=this._closest(s,function(e){return e.classList&&e.classList.contains("nodes")}).parentNode.children[0].children[0];if(this._removeClass(Array.from(this.querySelectorAll(".allowedDrop")),"allowedDrop"),t.parentNode.parentNode.nextElementSibling){let e=window.parseInt(t.parentNode.colSpan)+2;if(t.parentNode.setAttribute("colspan",e),t.parentNode.parentNode.nextElementSibling.children[0].setAttribute("colspan",e),!s.querySelector(".horizontalEdge")){let e=document.createElement("i"),t=document.createElement("i");e.setAttribute("class","edge horizontalEdge rightEdge fa"),s.appendChild(e),t.setAttribute("class","edge horizontalEdge leftEdge fa"),s.appendChild(t)}let i=t.parentNode.parentNode.nextElementSibling.nextElementSibling,n=document.createElement("td"),r=document.createElement("td");n.setAttribute("class","leftLine topLine"),n.innerHTML=`&nbsp;`,i.insertBefore(n,i.children[1]),r.setAttribute("class","rightLine topLine"),r.innerHTML=`&nbsp;`,i.insertBefore(r,i.children[2]),i.nextElementSibling.appendChild(this._closest(s,function(e){return"TABLE"===e.nodeName}).parentNode);let l=this._siblings(this._closest(s,function(e){return"TABLE"===e.nodeName}).parentNode).map(e=>e.querySelector(".node"));if(1===l.length){let e=document.createElement("i"),t=document.createElement("i");e.setAttribute("class","edge horizontalEdge rightEdge fa"),l[0].appendChild(e),t.setAttribute("class","edge horizontalEdge leftEdge fa"),l[0].appendChild(t)}}else{let e=document.createElement("i");e.setAttribute("class","edge verticalEdge bottomEdge fa"),t.appendChild(e),t.parentNode.setAttribute("colspan",2);let i=this._closest(t,function(e){return"TABLE"===e.nodeName}),n=document.createElement("tr"),r=document.createElement("tr"),l=document.createElement("tr");n.setAttribute("class","lines"),n.innerHTML=`<td colspan="2"><div class="downLine"></div></td>`,i.appendChild(n),r.setAttribute("class","lines"),r.innerHTML=`<td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td>`,i.appendChild(r),l.setAttribute("class","nodes"),i.appendChild(l),Array.from(s.querySelectorAll(".horizontalEdge")).forEach(e=>{s.removeChild(e)});let o=this._closest(s,e=>"TABLE"===e.nodeName).parentNode;l.appendChild(o)}let n=window.parseInt(i.colSpan);if(n>2){i.setAttribute("colspan",n-2),i.parentNode.nextElementSibling.children[0].setAttribute("colspan",n-2);let e=i.parentNode.nextElementSibling.nextElementSibling;e.children[1].remove(),e.children[1].remove();let t=Array.from(i.parentNode.parentNode.children[3].children).map(function(e){return e.querySelector(".node")});1===t.length&&(t[0].querySelector(".leftEdge").remove(),t[0].querySelector(".rightEdge").remove())}else i.removeAttribute("colspan"),i.querySelector(".node").removeChild(i.querySelector(".bottomEdge")),Array.from(i.parentNode.parentNode.children).slice(1).forEach(e=>e.remove());let r=new CustomEvent("nodedropped.orgchart",{detail:{draggedNode:s,dragZone:i.children[0],dropZone:t}});this.dispatchEvent(r)}_createNode(e,t){let s=this,i=this.options;return new Promise(function(n,r){if(e.children)for(let t of e.children)t.parentId=e.id;let l=document.createElement("div");delete e.children,l.dataset.source=JSON.stringify(e),e[i.nodeId]&&(l.id=e[i.nodeId]);let o,a=s.dataset.inEdit;o=a?"addChildren"===a?" slide-up":"":t>=i.depth?" slide-up":"",l.setAttribute("class","node "+(e.className||"")+o),i.draggable&&l.setAttribute("draggable",!0),e.parentId&&l.setAttribute("data-parent",e.parentId),l.innerHTML=`\n        <div class="title">${e[i.nodeTitle]}</div>\n        ${i.nodeContent?`<div class="content">${e[i.nodeContent]}</div>`:""}\n      `;let d=e.relationship||"";if(i.verticalDepth&&t+2>i.verticalDepth){if(t+1>=i.verticalDepth&&Number(d.substr(2,1))){let e=document.createElement("i"),s=t+1>=i.depth?"plus":"minus";e.setAttribute("class","toggleBtn fa fa-"+s+"-square"),l.appendChild(e)}}else{if(Number(d.substr(0,1))){let e=document.createElement("i");e.setAttribute("class","edge verticalEdge topEdge fa"),l.appendChild(e)}if(Number(d.substr(1,1))){let e=document.createElement("i"),t=document.createElement("i");e.setAttribute("class","edge horizontalEdge rightEdge fa"),l.appendChild(e),t.setAttribute("class","edge horizontalEdge leftEdge fa"),l.appendChild(t)}if(Number(d.substr(2,1))){let e=document.createElement("i"),t=document.createElement("i"),s=l.querySelector(":scope > .title");e.setAttribute("class","edge verticalEdge bottomEdge fa"),l.appendChild(e),t.setAttribute("class","fa "+i.parentNodeSymbol+" symbol"),s.insertBefore(t,s.children[0])}}l.addEventListener("mouseenter",s._hoverNode.bind(s)),l.addEventListener("mouseleave",s._hoverNode.bind(s)),l.addEventListener("click",s._dispatchClickEvent.bind(s)),i.draggable&&(l.addEventListener("dragstart",s._onDragStart.bind(s)),l.addEventListener("dragover",s._onDragOver.bind(s)),l.addEventListener("dragend",s._onDragEnd.bind(s)),l.addEventListener("drop",s._onDrop.bind(s))),i.createNode&&i.createNode(l,e),n(l)})}buildHierarchy(e,t,s,i){let n,r=this,l=this.options,o=t.children,a=l.verticalDepth&&s+1>=l.verticalDepth;if(Object.keys(t).length>1&&(n=a?e:document.createElement("table"),a||e.appendChild(n),this._createNode(t,s).then(function(e){if(a)n.insertBefore(e,n.firstChild);else{let t=document.createElement("tr");t.innerHTML=`\n            <td ${o?`colspan="${2*o.length}"`:""}>\n            </td>\n          `,t.children[0].appendChild(e),n.insertBefore(t,n.children[0]?n.children[0]:null)}i&&i()}).catch(function(e){console.error("Failed to creat node",e)})),o){1===Object.keys(t).length&&(n=e);let a,d=l.verticalDepth&&s+2>=l.verticalDepth,c=r.dataset.inEdit;if(a=c?"addSiblings"===c?"":" hidden":s+1>=l.depth?" hidden":"",!d){let e=document.createElement("tr");e.setAttribute("class","lines"+a),e.innerHTML=`\n          <td colspan="${2*o.length}">\n            <div class="downLine"></div>\n          </td>\n        `,n.appendChild(e)}let h=document.createElement("tr");h.setAttribute("class","lines"+a),h.innerHTML=`\n        <td class="rightLine">&nbsp;</td>\n        ${o.slice(1).map(()=>`\n          <td class="leftLine topLine">&nbsp;</td>\n          <td class="rightLine topLine">&nbsp;</td>\n          `).join("")}\n        <td class="leftLine">&nbsp;</td>\n      `;let u;if(d)if(u=document.createElement("ul"),a&&u.classList.add(a.trim()),s+2===l.verticalDepth){let e=document.createElement("tr");e.setAttribute("class","verticalNodes"+a),e.innerHTML=`<td></td>`,e.firstChild.appendChild(u),n.appendChild(e)}else n.appendChild(u);else(u=document.createElement("tr")).setAttribute("class","nodes"+a),n.appendChild(h),n.appendChild(u);o.forEach(e=>{let t;d?t=document.createElement("li"):(t=document.createElement("td")).setAttribute("colspan",2),u.appendChild(t),r.buildHierarchy(t,e,s+1,i)})}}_clickChart(e){!this._closest(e.target,function(e){return e.classList&&e.classList.contains("node")})&&this.querySelector(".node.focused")&&this.querySelector(".node.focused").classList.remove("focused")}_loopChart(e){let t={id:e.querySelector(".node").id};return e.children[3]&&Array.from(e.children[3].children).forEach(e=>{t.children||(t.children=[]),t.children.push(this._loopChart(e.firstChild))}),t}getHierarchy(){return this.querySelector(".node").id?this._loopChart(this.querySelector("table")):"Error: Nodes of orghcart to be exported must have id attribute!"}_onPanStart(e){let t=e.currentTarget;if(this._closest(e.target,e=>e.classList&&e.classList.contains("node"))||e.touches&&e.touches.length>1)return void(t.dataset.panning=!1);t.style.cursor="move",t.dataset.panning=!0;let s=0,i=0,n=window.getComputedStyle(t).transform;if("none"!==n){let e=n.split(",");n.includes("3d")?(s=Number.parseInt(e[12],10),i=Number.parseInt(e[13],10)):(s=Number.parseInt(e[4],10),i=Number.parseInt(e[5],10))}let r=0,l=0;if(e.targetTouches){if(1===e.targetTouches.length)r=e.targetTouches[0].pageX-s,l=e.targetTouches[0].pageY-i;else if(e.targetTouches.length>1)return}else r=e.pageX-s,l=e.pageY-i;t.dataset.panStart=JSON.stringify({startX:r,startY:l}),t.addEventListener("mousemove",this._onPanning.bind(this)),t.addEventListener("touchmove",this._onPanning.bind(this))}_onPanning(e){let t=e.currentTarget;if("false"===t.dataset.panning)return;let s=0,i=0,n=JSON.parse(t.dataset.panStart),r=n.startX,l=n.startY;if(e.targetTouches){if(1===e.targetTouches.length)s=e.targetTouches[0].pageX-r,i=e.targetTouches[0].pageY-l;else if(e.targetTouches.length>1)return}else s=e.pageX-r,i=e.pageY-l;let o=window.getComputedStyle(t).transform;if("none"===o)o.includes("3d")?t.style.transform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+s+", "+i+", 0, 1)":t.style.transform="matrix(1, 0, 0, 1, "+s+", "+i+")";else{let e=o.split(",");o.includes("3d")?(e[12]=s,e[13]=i):(e[4]=s,e[5]=i+")"),t.style.transform=e.join(",")}}_onPanEnd(e){"true"===this.dataset.panning&&(this.dataset.panning=!1,this.style.cursor="default",document.body.removeEventListener("mousemove",this._onPanning),document.body.removeEventListener("touchmove",this._onPanning))}_setChartScale(e,t){let s=window.getComputedStyle(e).transform;if("none"===s)e.style.transform="scale("+t+","+t+")";else{let i=s.split(",");s.includes("3d")?e.style.transform=s+" scale3d("+t+","+t+", 1)":(i[0]="matrix("+t,i[3]=t,e.style.transform=s+" scale("+t+","+t+")")}e.dataset.scale=t}_onWheeling(e){e.preventDefault();let t=e.deltaY>0?.8:1.2;this._setChartScale(this,t)}_getPinchDist(e){return Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)*(e.touches[0].clientX-e.touches[1].clientX)+(e.touches[0].clientY-e.touches[1].clientY)*(e.touches[0].clientY-e.touches[1].clientY))}_onTouchStart(e){if(e.touches&&2===e.touches.length){let t=this._getPinchDist(e);this.dataset.pinching=!0,this.dataset.pinchDistStart=t}}_onTouchMove(e){if(this.dataset.pinching){let t=this._getPinchDist(e);this.dataset.pinchDistEnd=t}}_onTouchEnd(e){if(this.dataset.pinching){this.dataset.pinching=!1;let e=this.dataset.pinchDistEnd-this.dataset.pinchDistStart;e>0?this._setChartScale(this,1):e<0&&this._setChartScale(this,-1)}}};window.customElements.define("org-chart",OrgChart);