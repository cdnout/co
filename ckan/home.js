var CKAN={},isNodeModule="undefined"!=typeof module&&null!=module&&"undefined"!=typeof require;if(isNodeModule){var _=require("underscore"),request=require("request");module.exports=CKAN}!function(e){e.Client=function(e,r){this.endpoint=t(e),this.apiKey=r},e.Client.prototype.action=function(e,t,r){e.indexOf(!1)&&(e=e.replace("dataset_","package_"));var n={url:this.endpoint+"/3/action/"+e,data:t,type:"POST"};return this._ajax(n,r)},e.Client.prototype._ajax=function(e,t){e.headers=e.headers||{},this.apiKey&&(e.headers["X-CKAN-API-KEY"]=this.apiKey);var a=isNodeModule?r:n;return a(e,t)},e.Client.prototype.datastoreQuery=function(t,r){var n=e._normalizeQuery(t);this.action("datastore_search",n,function(t,n){if(t)return void r(t);var a=_.map(n.result.fields,function(t){return t.type=t.type in e.ckan2JsonTableSchemaTypes?e.ckan2JsonTableSchemaTypes[t.type]:t.type,t}),i={total:n.result.total,fields:a,hits:n.result.records};r(null,i)})},e.Client.prototype.datastoreSqlQuery=function(t,r){this.action("datastore_search_sql",{sql:t},function(t,n){if(t){var a=JSON.parse(t.message),i={original:t,code:t.code,message:a.error.info.orig[0]};return void r(i)}var o=_.map(n.result.fields,function(t){return t.type=t.type in e.ckan2JsonTableSchemaTypes?e.ckan2JsonTableSchemaTypes[t.type]:t.type,t}),s={total:n.result.length,fields:o,hits:n.result.records};r(null,s)})},e.ckan2JsonTableSchemaTypes={text:"string",int:"integer",int4:"integer",int8:"integer",float8:"float",timestamp:"datetime",bool:"boolean"},e.jsonTableSchema2CkanTypes={string:"text",number:"float",integer:"int",datetime:"timestamp",boolean:"bool",binary:"bytea",object:"json",array:"text[]",any:"text"},e.Client.prototype.datastoreResources=function(e){var t={resource_id:"_table_metadata"};return this.action("datastore_search",t,e)};var t=function(e){return e=e||"/",e=e.replace(/\/$/,""),e.match(/\/api$/)||(e+="/api"),e},r=function(e,t){var r={url:e.url,headers:e.headers||{},method:e.type||"GET",json:e.data};request(r,function(e,r,n){!e&&r&&200!==r.statusCode&&302!==r.statusCode&&(e="CKANJS API Error. HTTP code "+r.statusCode+". Message: "+JSON.stringify(n,null,2)),t(e,n)})},n=function(e,t){return e.data=encodeURIComponent(JSON.stringify(e.data)),e.success=function(e){t(null,e)},e.error=function(e,r,n){var a={code:e.status,message:e.responseText};t(a)},e.headers&&(e.beforeSend=function(t){for(key in e.headers)t.setRequestHeader(key,e.headers[key])}),jQuery.ajax(e)};e._normalizeQuery=function(e){var t={resource_id:e.resource_id,q:e.q,filters:{},limit:e.size||10,offset:e.from||0};if(e.sort&&e.sort.length>0){var r=_.map(e.sort,function(e){return e.field+" "+(e.order||"")});t.sort=r.join(",")}return e.filters&&e.filters.length>0&&_.each(e.filters,function(e){"term"===e.type&&(t.filters[e.field]=e.term)}),t},e.parseCkanResourceUrl=function(e){parts=e.split("/");var t=parts.length;return{resource_id:parts[t-1],endpoint:parts.slice(0,[t-4]).join("/")+"/api"}}}(CKAN);var recline=recline||{};recline.Backend=recline.Backend||{},recline.Backend.Ckan=recline.Backend.Ckan||{},function(e){e.__type__="ckan";var t=_.isUndefined(this.jQuery)?_.Deferred:jQuery.Deferred;e.fetch=function(r){var n=new t;return e.query({},r).done(function(e){n.resolve({fields:e.fields,records:e.hits})}).fail(function(e){n.reject(e)}),n.promise()},e.query=function(e,r){var n,a=new t;if(r.endpoint)n=new CKAN.Client(r.endpoint);else{var i=CKAN.parseCkanResourceUrl(r.url);r.id=i.resource_id,n=new CKAN.Client(i.endpoint)}return e.resource_id=r.id,n.datastoreQuery(e,function(e,t){e?a.reject(e):a.resolve(t)}),a.promise()}}(recline.Backend.Ckan);
//# sourceMappingURL=ckan.min.js.map