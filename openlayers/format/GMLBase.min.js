var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{extend}from"../array.js";import Feature from"../Feature.js";import{transformGeometryWithOptions,transformExtentWithOptions}from"./Feature.js";import XMLFeature from"./XMLFeature.js";import GeometryLayout from"../geom/GeometryLayout.js";import LineString from"../geom/LineString.js";import LinearRing from"../geom/LinearRing.js";import MultiLineString from"../geom/MultiLineString.js";import MultiPoint from"../geom/MultiPoint.js";import MultiPolygon from"../geom/MultiPolygon.js";import Point from"../geom/Point.js";import Polygon from"../geom/Polygon.js";import{assign}from"../obj.js";import{get as getProjection}from"../proj.js";import{getAllTextContent,getAttributeNS,makeArrayPusher,makeReplacer,parseNode,pushParseAndPop}from"../xml.js";var GMLNS="http://www.opengis.net/gml",ONLY_WHITESPACE_RE=/^[\s\xa0]*$/,GMLBase=function(r){function e(e){var t=r.call(this)||this,e=e||{};return t.featureType=e.featureType,t.featureNS=e.featureNS,t.srsName=e.srsName,t.schemaLocation="",t.FEATURE_COLLECTION_PARSERS={},t.FEATURE_COLLECTION_PARSERS[t.namespace]={featureMember:makeArrayPusher(t.readFeaturesInternal),featureMembers:makeReplacer(t.readFeaturesInternal)},t}return __extends(e,r),e.prototype.readFeaturesInternal=function(e,t){var r=e.localName,o=null;if("FeatureCollection"==r)o=pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if("featureMembers"==r||"featureMember"==r){var n=t[0],i=n.featureType,a=n.featureNS;if(!i&&e.childNodes){for(var i=[],a={},s=0,p=e.childNodes.length;s<p;++s){var u=e.childNodes[s];if(1===u.nodeType){var m=u.nodeName.split(":").pop();if(-1===i.indexOf(m)){var l,y="",h=0,f=u.namespaceURI;for(l in a){if(a[l]===f){y=l;break}++h}y||(a[y="p"+h]=f),i.push(y+":"+m)}}}"featureMember"!=r&&(n.featureType=i,n.featureNS=a)}"string"==typeof a&&(n=a,(a={}).p0=n);var P,d={},g=Array.isArray(i)?i:[i];for(P in a){for(var R={},s=0,p=g.length;s<p;++s)(-1===g[s].indexOf(":")?"p0":g[s].split(":")[0])===P&&(R[g[s].split(":").pop()]=("featureMembers"==r?makeArrayPusher:makeReplacer)(this.readFeatureElement,this));d[a[P]]=R}o=pushParseAndPop("featureMember"==r?void 0:[],d,e,t)}return o=null===o?[]:o},e.prototype.readGeometryElement=function(e,t){var r=t[0],e=(r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),pushParseAndPop(null,this.GEOMETRY_PARSERS,e,t,this));if(e)return Array.isArray(e)?transformExtentWithOptions(e,r):transformGeometryWithOptions(e,!1,r)},e.prototype.readFeatureElementInternal=function(e,t,r){for(var o,n,i={},a=e.firstElementChild;a;a=a.nextElementSibling){var s=void 0,p=a.localName,u=(0===a.childNodes.length||1===a.childNodes.length&&(3===a.firstChild.nodeType||4===a.firstChild.nodeType)?(s=getAllTextContent(a,!1),ONLY_WHITESPACE_RE.test(s)&&(s=void 0)):(s=r?this.readGeometryElement(a,t):s)?"boundedBy"!==p&&(o=p):s=this.readFeatureElementInternal(a,t,!1),i[p]?(i[p]instanceof Array||(i[p]=[i[p]]),i[p].push(s)):i[p]=s,a.attributes.length);if(0<u){i[p]={_content_:i[p]};for(var m=0;m<u;m++){var l=a.attributes[m].name;i[p][l]=a.attributes[m].value}}}return r?(n=new Feature(i),o&&n.setGeometryName(o),(e=e.getAttribute("fid")||getAttributeNS(e,this.namespace,"id"))&&n.setId(e),n):i},e.prototype.readFeatureElement=function(e,t){return this.readFeatureElementInternal(e,t,!0)},e.prototype.readPoint=function(e,t){e=this.readFlatCoordinatesFromNode_(e,t);if(e)return new Point(e,GeometryLayout.XYZ)},e.prototype.readMultiPoint=function(e,t){e=pushParseAndPop([],this.MULTIPOINT_PARSERS_,e,t,this);if(e)return new MultiPoint(e)},e.prototype.readMultiLineString=function(e,t){e=pushParseAndPop([],this.MULTILINESTRING_PARSERS_,e,t,this);if(e)return new MultiLineString(e)},e.prototype.readMultiPolygon=function(e,t){e=pushParseAndPop([],this.MULTIPOLYGON_PARSERS_,e,t,this);if(e)return new MultiPolygon(e)},e.prototype.pointMemberParser_=function(e,t){parseNode(this.POINTMEMBER_PARSERS_,e,t,this)},e.prototype.lineStringMemberParser_=function(e,t){parseNode(this.LINESTRINGMEMBER_PARSERS_,e,t,this)},e.prototype.polygonMemberParser_=function(e,t){parseNode(this.POLYGONMEMBER_PARSERS_,e,t,this)},e.prototype.readLineString=function(e,t){e=this.readFlatCoordinatesFromNode_(e,t);if(e)return new LineString(e,GeometryLayout.XYZ)},e.prototype.readFlatLinearRing_=function(e,t){e=pushParseAndPop(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(e)return e},e.prototype.readLinearRing=function(e,t){e=this.readFlatCoordinatesFromNode_(e,t);if(e)return new LinearRing(e,GeometryLayout.XYZ)},e.prototype.readPolygon=function(e,t){var r=pushParseAndPop([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){for(var o=r[0],n=[o.length],i=void 0,i=1,a=r.length;i<a;++i)extend(o,r[i]),n.push(o.length);return new Polygon(o,GeometryLayout.XYZ,n)}},e.prototype.readFlatCoordinatesFromNode_=function(e,t){return pushParseAndPop(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)},e.prototype.readGeometryFromNode=function(e,t){e=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return e||null},e.prototype.readFeaturesFromNode=function(e,t){var r={featureType:this.featureType,featureNS:this.featureNS};return t&&assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]},e.prototype.readProjectionFromNode=function(e){return getProjection(this.srsName||e.firstElementChild.getAttribute("srsName"))},e}(XMLFeature);GMLBase.prototype.namespace=GMLNS,GMLBase.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}},GMLBase.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}},GMLBase.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}},GMLBase.prototype.MULTIPOINT_PARSERS_={"http://www.opengis.net/gml":{pointMember:makeArrayPusher(GMLBase.prototype.pointMemberParser_),pointMembers:makeArrayPusher(GMLBase.prototype.pointMemberParser_)}},GMLBase.prototype.MULTILINESTRING_PARSERS_={"http://www.opengis.net/gml":{lineStringMember:makeArrayPusher(GMLBase.prototype.lineStringMemberParser_),lineStringMembers:makeArrayPusher(GMLBase.prototype.lineStringMemberParser_)}},GMLBase.prototype.MULTIPOLYGON_PARSERS_={"http://www.opengis.net/gml":{polygonMember:makeArrayPusher(GMLBase.prototype.polygonMemberParser_),polygonMembers:makeArrayPusher(GMLBase.prototype.polygonMemberParser_)}},GMLBase.prototype.POINTMEMBER_PARSERS_={"http://www.opengis.net/gml":{Point:makeArrayPusher(GMLBase.prototype.readFlatCoordinatesFromNode_)}},GMLBase.prototype.LINESTRINGMEMBER_PARSERS_={"http://www.opengis.net/gml":{LineString:makeArrayPusher(GMLBase.prototype.readLineString)}},GMLBase.prototype.POLYGONMEMBER_PARSERS_={"http://www.opengis.net/gml":{Polygon:makeArrayPusher(GMLBase.prototype.readPolygon)}},GMLBase.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:makeReplacer(GMLBase.prototype.readFlatLinearRing_)}};export default GMLBase;export{GMLNS};