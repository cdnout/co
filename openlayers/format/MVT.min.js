var __extends=this&&this.__extends||function(){var o=function(e,r){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};return function(e,r){function t(){this.constructor=e}o(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}}();import{assert}from"../asserts.js";import PBF from"pbf";import FeatureFormat,{transformGeometryWithOptions}from"./Feature.js";import FormatType from"./FormatType.js";import GeometryLayout from"../geom/GeometryLayout.js";import GeometryType from"../geom/GeometryType.js";import LineString from"../geom/LineString.js";import MultiLineString from"../geom/MultiLineString.js";import MultiPoint from"../geom/MultiPoint.js";import MultiPolygon from"../geom/MultiPolygon.js";import Point from"../geom/Point.js";import Polygon from"../geom/Polygon.js";import{linearRingIsClockwise}from"../geom/flat/orient.js";import Projection from"../proj/Projection.js";import Units from"../proj/Units.js";import RenderFeature from"../render/Feature.js";import{get}from"../proj.js";var MVT=function(t){function e(e){var r=t.call(this)||this,e=e||{};return r.dataProjection=new Projection({code:"",units:Units.TILE_PIXELS}),r.featureClass_=e.featureClass||RenderFeature,r.geometryName_=e.geometryName,r.layerName_=e.layerName||"layer",r.layers_=e.layers||null,r.idProperty_=e.idProperty,r}return __extends(e,t),e.prototype.readRawGeometry_=function(e,r,t,o){e.pos=r.geometry;for(var a,n=e.readVarint()+e.pos,i=1,s=0,y=0,p=0,m=0,u=0;e.pos<n;)s||(i=7&(a=e.readVarint()),s=a>>3),s--,1===i||2===i?(y+=e.readSVarint(),p+=e.readSVarint(),1===i&&u<m&&(o.push(m),u=m),t.push(y,p),m+=2):7===i?u<m&&(t.push(t[u],t[u+1]),m+=2):assert(!1,59);u<m&&o.push(m)},e.prototype.createFeature_=function(e,r,t){var o=r.type;if(0===o)return null;var a,n=r.properties,i=(this.idProperty_?(a=n[this.idProperty_],delete n[this.idProperty_]):a=r.id,n[this.layerName_]=r.layer.name,[]),s=[],e=(this.readRawGeometry_(e,r,i,s),getGeometryType(o,s.length));if(this.featureClass_===RenderFeature)(d=new this.featureClass_(e,i,s,n,a)).transform(t.dataProjection,t.featureProjection);else{r=void 0;if(e==GeometryType.POLYGON){for(var y=[],p=0,m=0,u=0,l=s.length;u<l;++u){var f=s[u];linearRingIsClockwise(i,p,f,2)||(y.push(s.slice(m,u)),m=u),p=f}r=1<y.length?new MultiPolygon(i,GeometryLayout.XY,y):new Polygon(i,GeometryLayout.XY,s)}else r=e===GeometryType.POINT?new Point(i,GeometryLayout.XY):e===GeometryType.LINE_STRING?new LineString(i,GeometryLayout.XY):e===GeometryType.POLYGON?new Polygon(i,GeometryLayout.XY,s):e===GeometryType.MULTI_POINT?new MultiPoint(i,GeometryLayout.XY):e===GeometryType.MULTI_LINE_STRING?new MultiLineString(i,GeometryLayout.XY,s):null;var d=new this.featureClass_,o=(this.geometryName_&&d.setGeometryName(this.geometryName_),transformGeometryWithOptions(r,!1,t));d.setGeometry(o),d.setId(a),d.setProperties(n,!0)}return d},e.prototype.getType=function(){return FormatType.ARRAY_BUFFER},e.prototype.readFeatures=function(e,r){var t,o=this.layers_,a=this.adaptOptions(r),n=get(a.dataProjection),i=(n.setWorldExtent(a.extent),a.dataProjection=n,new PBF(e)),s=i.readFields(layersPBFReader,{}),y=[];for(t in s)if(!o||-1!=o.indexOf(t)){var p=s[t],m=p?[0,0,p.extent,p.extent]:null;n.setExtent(m);for(var u=0,l=p.length;u<l;++u){var f=readRawFeature(i,p,u);y.push(this.createFeature_(i,f,a))}}return y},e.prototype.readProjection=function(e){return this.dataProjection},e.prototype.setLayers=function(e){this.layers_=e},e}(FeatureFormat);function layersPBFReader(e,r,t){var o;3===e&&(e={keys:[],values:[],features:[]},o=t.readVarint()+t.pos,t.readFields(layerPBFReader,e,o),e.length=e.features.length,e.length&&(r[e.name]=e))}function layerPBFReader(e,r,t){if(15===e)r.version=t.readVarint();else if(1===e)r.name=t.readString();else if(5===e)r.extent=t.readVarint();else if(2===e)r.features.push(t.pos);else if(3===e)r.keys.push(t.readString());else if(4===e){for(var o=null,a=t.readVarint()+t.pos;t.pos<a;)o=1===(e=t.readVarint()>>3)?t.readString():2===e?t.readFloat():3===e?t.readDouble():4===e?t.readVarint64():5===e?t.readVarint():6===e?t.readSVarint():7===e?t.readBoolean():null;r.values.push(o)}}function featurePBFReader(e,r,t){if(1==e)r.id=t.readVarint();else if(2==e)for(var o=t.readVarint()+t.pos;t.pos<o;){var a=r.layer.keys[t.readVarint()],n=r.layer.values[t.readVarint()];r.properties[a]=n}else 3==e?r.type=t.readVarint():4==e&&(r.geometry=t.pos)}function readRawFeature(e,r,t){e.pos=r.features[t];t=e.readVarint()+e.pos,r={layer:r,type:0,properties:{}};return e.readFields(featurePBFReader,r,t),r}function getGeometryType(e,r){var t;return 1===e?t=1===r?GeometryType.POINT:GeometryType.MULTI_POINT:2===e?t=1===r?GeometryType.LINE_STRING:GeometryType.MULTI_LINE_STRING:3===e&&(t=GeometryType.POLYGON),t}export default MVT;