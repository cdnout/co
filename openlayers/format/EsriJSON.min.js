var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import Feature from"../Feature.js";import{assert}from"../asserts.js";import{containsExtent}from"../extent.js";import{transformGeometryWithOptions}from"./Feature.js";import JSONFeature from"./JSONFeature.js";import GeometryLayout from"../geom/GeometryLayout.js";import GeometryType from"../geom/GeometryType.js";import LineString from"../geom/LineString.js";import LinearRing from"../geom/LinearRing.js";import MultiLineString from"../geom/MultiLineString.js";import MultiPoint from"../geom/MultiPoint.js";import MultiPolygon from"../geom/MultiPolygon.js";import Point from"../geom/Point.js";import Polygon from"../geom/Polygon.js";import{deflateCoordinates}from"../geom/flat/deflate.js";import{linearRingIsClockwise}from"../geom/flat/orient.js";import{isEmpty}from"../obj.js";import{get as getProjection}from"../proj.js";var GEOMETRY_READERS={},GEOMETRY_WRITERS=(GEOMETRY_READERS[GeometryType.POINT]=readPointGeometry,GEOMETRY_READERS[GeometryType.LINE_STRING]=readLineStringGeometry,GEOMETRY_READERS[GeometryType.POLYGON]=readPolygonGeometry,GEOMETRY_READERS[GeometryType.MULTI_POINT]=readMultiPointGeometry,GEOMETRY_READERS[GeometryType.MULTI_LINE_STRING]=readMultiLineStringGeometry,GEOMETRY_READERS[GeometryType.MULTI_POLYGON]=readMultiPolygonGeometry,{}),EsriJSON=(GEOMETRY_WRITERS[GeometryType.POINT]=writePointGeometry,GEOMETRY_WRITERS[GeometryType.LINE_STRING]=writeLineStringGeometry,GEOMETRY_WRITERS[GeometryType.POLYGON]=writePolygonGeometry,GEOMETRY_WRITERS[GeometryType.MULTI_POINT]=writeMultiPointGeometry,GEOMETRY_WRITERS[GeometryType.MULTI_LINE_STRING]=writeMultiLineStringGeometry,GEOMETRY_WRITERS[GeometryType.MULTI_POLYGON]=writeMultiPolygonGeometry,function(r){function e(e){var t=this,e=e||{};return(t=r.call(this)||this).geometryName_=e.geometryName,t}return __extends(e,r),e.prototype.readFeatureFromObject=function(e,t){var r=readGeometry(e.geometry,t),o=new Feature;return this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(r),t&&t.idField&&e.attributes[t.idField]&&o.setId(e.attributes[t.idField]),e.attributes&&o.setProperties(e.attributes,!0),o},e.prototype.readFeaturesFromObject=function(e,t){var r=t||{};if(e.features){var o=[],n=e.features;r.idField=e.objectIdFieldName;for(var i=0,a=n.length;i<a;++i)o.push(this.readFeatureFromObject(n[i],r));return o}return[this.readFeatureFromObject(e,r)]},e.prototype.readGeometryFromObject=function(e,t){return readGeometry(e,t)},e.prototype.readProjectionFromObject=function(e){return e.spatialReference&&void 0!==e.spatialReference.wkid?(e=e.spatialReference.wkid,getProjection("EPSG:"+e)):null},e.prototype.writeGeometryObject=function(e,t){return writeGeometry(e,this.adaptOptions(t))},e.prototype.writeFeatureObject=function(e,t){t=this.adaptOptions(t);var r={},o=e.getGeometry(),o=(o&&(r.geometry=writeGeometry(o,t),t&&t.featureProjection&&(r.geometry.spatialReference={wkid:Number(getProjection(t.featureProjection).getCode().split(":").pop())})),e.getProperties());return delete o[e.getGeometryName()],isEmpty(o)?r.attributes={}:r.attributes=o,r},e.prototype.writeFeaturesObject=function(e,t){t=this.adaptOptions(t);for(var r=[],o=0,n=e.length;o<n;++o)r.push(this.writeFeatureObject(e[o],t));return{features:r}},e}(JSONFeature));function readGeometry(e,t){var r,o;if(!e)return null;"number"==typeof e.x&&"number"==typeof e.y?r=GeometryType.POINT:e.points?r=GeometryType.MULTI_POINT:e.paths?r=1===e.paths.length?GeometryType.LINE_STRING:GeometryType.MULTI_LINE_STRING:e.rings&&(o=getGeometryLayout(n=e),e=1===(n=convertRings(n.rings,o)).length?(r=GeometryType.POLYGON,Object.assign({},e,((o={}).rings=n[0],o))):(r=GeometryType.MULTI_POLYGON,Object.assign({},e,((o={}).rings=n,o))));var n=GEOMETRY_READERS[r];return transformGeometryWithOptions(n(e),!1,t)}function convertRings(e,t){var r,o=[],n=[],i=[];for(m=0,r=e.length;m<r;++m)o.length=0,deflateCoordinates(o,0,e[m],t.length),linearRingIsClockwise(o,0,o.length,t.length)?n.push([e[m]]):i.push(e[m]);for(;i.length;){for(var a=i.shift(),y=!1,m=n.length-1;0<=m;m--){var s=n[m][0];if(containsExtent(new LinearRing(s).getExtent(),new LinearRing(a).getExtent())){n[m].push(a),y=!0;break}}y||n.push([a.reverse()])}return n}function readPointGeometry(e){e=void 0!==e.m&&void 0!==e.z?new Point([e.x,e.y,e.z,e.m],GeometryLayout.XYZM):void 0!==e.z?new Point([e.x,e.y,e.z],GeometryLayout.XYZ):void 0!==e.m?new Point([e.x,e.y,e.m],GeometryLayout.XYM):new Point([e.x,e.y]);return e}function readLineStringGeometry(e){var t=getGeometryLayout(e);return new LineString(e.paths[0],t)}function readMultiLineStringGeometry(e){var t=getGeometryLayout(e);return new MultiLineString(e.paths,t)}function getGeometryLayout(e){var t=GeometryLayout.XY;return!0===e.hasZ&&!0===e.hasM?t=GeometryLayout.XYZM:!0===e.hasZ?t=GeometryLayout.XYZ:!0===e.hasM&&(t=GeometryLayout.XYM),t}function readMultiPointGeometry(e){var t=getGeometryLayout(e);return new MultiPoint(e.points,t)}function readMultiPolygonGeometry(e){var t=getGeometryLayout(e);return new MultiPolygon(e.rings,t)}function readPolygonGeometry(e){var t=getGeometryLayout(e);return new Polygon(e.rings,t)}function writePointGeometry(e,t){var r,o=e.getCoordinates(),e=e.getLayout();return e===GeometryLayout.XYZ?r={x:o[0],y:o[1],z:o[2]}:e===GeometryLayout.XYM?r={x:o[0],y:o[1],m:o[2]}:e===GeometryLayout.XYZM?r={x:o[0],y:o[1],z:o[2],m:o[3]}:e===GeometryLayout.XY?r={x:o[0],y:o[1]}:assert(!1,34),r}function getHasZM(e){e=e.getLayout();return{hasZ:e===GeometryLayout.XYZ||e===GeometryLayout.XYZM,hasM:e===GeometryLayout.XYM||e===GeometryLayout.XYZM}}function writeLineStringGeometry(e,t){var r=getHasZM(e);return{hasZ:r.hasZ,hasM:r.hasM,paths:[e.getCoordinates()]}}function writePolygonGeometry(e,t){var r=getHasZM(e);return{hasZ:r.hasZ,hasM:r.hasM,rings:e.getCoordinates(!1)}}function writeMultiLineStringGeometry(e,t){var r=getHasZM(e);return{hasZ:r.hasZ,hasM:r.hasM,paths:e.getCoordinates()}}function writeMultiPointGeometry(e,t){var r=getHasZM(e);return{hasZ:r.hasZ,hasM:r.hasM,points:e.getCoordinates()}}function writeMultiPolygonGeometry(e,t){for(var r=getHasZM(e),o=e.getCoordinates(!1),n=[],i=0;i<o.length;i++)for(var a=o[i].length-1;0<=a;a--)n.push(o[i][a]);return{hasZ:r.hasZ,hasM:r.hasM,rings:n}}function writeGeometry(e,t){return(0,GEOMETRY_WRITERS[e.getType()])(transformGeometryWithOptions(e,!0,t),t)}export default EsriJSON;