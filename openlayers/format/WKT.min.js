var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import Feature from"../Feature.js";import{transformGeometryWithOptions}from"./Feature.js";import TextFeature from"./TextFeature.js";import GeometryCollection from"../geom/GeometryCollection.js";import GeometryType from"../geom/GeometryType.js";import GeometryLayout from"../geom/GeometryLayout.js";import LineString from"../geom/LineString.js";import MultiLineString from"../geom/MultiLineString.js";import MultiPoint from"../geom/MultiPoint.js";import MultiPolygon from"../geom/MultiPolygon.js";import Point from"../geom/Point.js";import Polygon from"../geom/Polygon.js";var type,GeometryConstructor={POINT:Point,LINESTRING:LineString,POLYGON:Polygon,MULTIPOINT:MultiPoint,MULTILINESTRING:MultiLineString,MULTIPOLYGON:MultiPolygon},EMPTY="EMPTY",Z="Z",M="M",ZM="ZM",TokenType={TEXT:1,LEFT_PAREN:2,RIGHT_PAREN:3,NUMBER:4,COMMA:5,EOF:6},WKTGeometryType={};for(type in GeometryType)WKTGeometryType[type]=GeometryType[type].toUpperCase();var Lexer=function(){function e(e){this.wkt=e,this.index_=-1}return e.prototype.isAlpha_=function(e){return"a"<=e&&e<="z"||"A"<=e&&e<="Z"},e.prototype.isNumeric_=function(e,t){return"0"<=e&&e<="9"||"."==e&&!(void 0!==t&&t)},e.prototype.isWhiteSpace_=function(e){return" "==e||"\t"==e||"\r"==e||"\n"==e},e.prototype.nextChar_=function(){return this.wkt.charAt(++this.index_)},e.prototype.nextToken=function(){var e,t=this.nextChar_(),r=this.index_,o=t;if("("==t)e=TokenType.LEFT_PAREN;else if(","==t)e=TokenType.COMMA;else if(")"==t)e=TokenType.RIGHT_PAREN;else if(this.isNumeric_(t)||"-"==t)e=TokenType.NUMBER,o=this.readNumber_();else if(this.isAlpha_(t))e=TokenType.TEXT,o=this.readText_();else{if(this.isWhiteSpace_(t))return this.nextToken();if(""!==t)throw new Error("Unexpected character: "+t);e=TokenType.EOF}return{position:r,value:o,type:e}},e.prototype.readNumber_=function(){for(var e,t=this.index_,r=!1,o=!1;"."==e?r=!0:"e"!=e&&"E"!=e||(o=!0),e=this.nextChar_(),this.isNumeric_(e,r)||!o&&("e"==e||"E"==e)||o&&("-"==e||"+"==e););return parseFloat(this.wkt.substring(t,this.index_--))},e.prototype.readText_=function(){for(var e,t=this.index_;e=this.nextChar_(),this.isAlpha_(e););return this.wkt.substring(t,this.index_--).toUpperCase()},e}(),Parser=function(){function e(e){this.lexer_=e,this.token_,this.layout_=GeometryLayout.XY}return e.prototype.consume_=function(){this.token_=this.lexer_.nextToken()},e.prototype.isTokenType=function(e){return this.token_.type==e},e.prototype.match=function(e){e=this.isTokenType(e);return e&&this.consume_(),e},e.prototype.parse=function(){return this.consume_(),this.parseGeometry_()},e.prototype.parseGeometryLayout_=function(){var e=GeometryLayout.XY,t=this.token_;return this.isTokenType(TokenType.TEXT)&&((t=t.value)===Z?e=GeometryLayout.XYZ:t===M?e=GeometryLayout.XYM:t===ZM&&(e=GeometryLayout.XYZM),e!==GeometryLayout.XY&&this.consume_()),e},e.prototype.parseGeometryCollectionText_=function(){if(this.match(TokenType.LEFT_PAREN)){for(var e=[];e.push(this.parseGeometry_()),this.match(TokenType.COMMA););if(this.match(TokenType.RIGHT_PAREN))return e}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())},e.prototype.parsePointText_=function(){if(this.match(TokenType.LEFT_PAREN)){var e=this.parsePoint_();if(this.match(TokenType.RIGHT_PAREN))return e}else if(this.isEmptyGeometry_())return null;throw new Error(this.formatErrorMessage_())},e.prototype.parseLineStringText_=function(){if(this.match(TokenType.LEFT_PAREN)){var e=this.parsePointList_();if(this.match(TokenType.RIGHT_PAREN))return e}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())},e.prototype.parsePolygonText_=function(){if(this.match(TokenType.LEFT_PAREN)){var e=this.parseLineStringTextList_();if(this.match(TokenType.RIGHT_PAREN))return e}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())},e.prototype.parseMultiPointText_=function(){if(this.match(TokenType.LEFT_PAREN)){var e=void 0,e=this.token_.type==TokenType.LEFT_PAREN?this.parsePointTextList_():this.parsePointList_();if(this.match(TokenType.RIGHT_PAREN))return e}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())},e.prototype.parseMultiLineStringText_=function(){if(this.match(TokenType.LEFT_PAREN)){var e=this.parseLineStringTextList_();if(this.match(TokenType.RIGHT_PAREN))return e}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())},e.prototype.parseMultiPolygonText_=function(){if(this.match(TokenType.LEFT_PAREN)){var e=this.parsePolygonTextList_();if(this.match(TokenType.RIGHT_PAREN))return e}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())},e.prototype.parsePoint_=function(){for(var e=[],t=this.layout_.length,r=0;r<t;++r){var o=this.token_;if(!this.match(TokenType.NUMBER))break;e.push(o.value)}if(e.length==t)return e;throw new Error(this.formatErrorMessage_())},e.prototype.parsePointList_=function(){for(var e=[this.parsePoint_()];this.match(TokenType.COMMA);)e.push(this.parsePoint_());return e},e.prototype.parsePointTextList_=function(){for(var e=[this.parsePointText_()];this.match(TokenType.COMMA);)e.push(this.parsePointText_());return e},e.prototype.parseLineStringTextList_=function(){for(var e=[this.parseLineStringText_()];this.match(TokenType.COMMA);)e.push(this.parseLineStringText_());return e},e.prototype.parsePolygonTextList_=function(){for(var e=[this.parsePolygonText_()];this.match(TokenType.COMMA);)e.push(this.parsePolygonText_());return e},e.prototype.isEmptyGeometry_=function(){var e=this.isTokenType(TokenType.TEXT)&&this.token_.value==EMPTY;return e&&this.consume_(),e},e.prototype.formatErrorMessage_=function(){return"Unexpected `"+this.token_.value+"` at position "+this.token_.position+" in `"+this.lexer_.wkt+"`"},e.prototype.parseGeometry_=function(){var e=this.token_;if(this.match(TokenType.TEXT)){var t=e.value;if(this.layout_=this.parseGeometryLayout_(),"GEOMETRYCOLLECTION"==t)return e=this.parseGeometryCollectionText_(),new GeometryCollection(e);e=GeometryConstructor[t];if(!e)throw new Error("Invalid geometry type: "+t);var r=void 0;switch(t){case"POINT":r=this.parsePointText_();break;case"LINESTRING":r=this.parseLineStringText_();break;case"POLYGON":r=this.parsePolygonText_();break;case"MULTIPOINT":r=this.parseMultiPointText_();break;case"MULTILINESTRING":r=this.parseMultiLineStringText_();break;case"MULTIPOLYGON":r=this.parseMultiPolygonText_();break;default:throw new Error("Invalid geometry type: "+t)}return new e(r=r||(e===GeometryConstructor.POINT?[NaN,NaN]:[]),this.layout_)}throw new Error(this.formatErrorMessage_())},e}(),WKT=function(r){function e(e){var t=r.call(this)||this,e=e||{};return t.splitCollection_=void 0!==e.splitCollection&&e.splitCollection,t}return __extends(e,r),e.prototype.parse_=function(e){e=new Lexer(e);return new Parser(e).parse()},e.prototype.readFeatureFromText=function(e,t){e=this.readGeometryFromText(e,t);return e?((t=new Feature).setGeometry(e),t):null},e.prototype.readFeaturesFromText=function(e,t){for(var r=[],e=this.readGeometryFromText(e,t),o=[],n=0,i=(r=this.splitCollection_&&e.getType()==GeometryType.GEOMETRY_COLLECTION?e.getGeometriesArray():[e]).length;n<i;++n){var s=new Feature;s.setGeometry(r[n]),o.push(s)}return o},e.prototype.readGeometryFromText=function(e,t){e=this.parse_(e);return e?transformGeometryWithOptions(e,!1,t):null},e.prototype.writeFeatureText=function(e,t){e=e.getGeometry();return e?this.writeGeometryText(e,t):""},e.prototype.writeFeaturesText=function(e,t){if(1==e.length)return this.writeFeatureText(e[0],t);for(var r=[],o=0,n=e.length;o<n;++o)r.push(e[o].getGeometry());var i=new GeometryCollection(r);return this.writeGeometryText(i,t)},e.prototype.writeGeometryText=function(e,t){return encode(transformGeometryWithOptions(e,!0,t))},e}(TextFeature);function encodePointGeometry(e){e=e.getCoordinates();return 0===e.length?"":e.join(" ")}function encodeMultiPointGeometry(e){for(var t=[],r=e.getPoints(),o=0,n=r.length;o<n;++o)t.push("("+encodePointGeometry(r[o])+")");return t.join(",")}function encodeGeometryCollectionGeometry(e){for(var t=[],r=e.getGeometries(),o=0,n=r.length;o<n;++o)t.push(encode(r[o]));return t.join(",")}function encodeLineStringGeometry(e){for(var t=e.getCoordinates(),r=[],o=0,n=t.length;o<n;++o)r.push(t[o].join(" "));return r.join(",")}function encodeMultiLineStringGeometry(e){for(var t=[],r=e.getLineStrings(),o=0,n=r.length;o<n;++o)t.push("("+encodeLineStringGeometry(r[o])+")");return t.join(",")}function encodePolygonGeometry(e){for(var t=[],r=e.getLinearRings(),o=0,n=r.length;o<n;++o)t.push("("+encodeLineStringGeometry(r[o])+")");return t.join(",")}function encodeMultiPolygonGeometry(e){for(var t=[],r=e.getPolygons(),o=0,n=r.length;o<n;++o)t.push("("+encodePolygonGeometry(r[o])+")");return t.join(",")}function encodeGeometryLayout(e){var e=e.getLayout(),t="";return e!==GeometryLayout.XYZ&&e!==GeometryLayout.XYZM||(t+=Z),e!==GeometryLayout.XYM&&e!==GeometryLayout.XYZM||(t+=M),t}var GeometryEncoder={Point:encodePointGeometry,LineString:encodeLineStringGeometry,Polygon:encodePolygonGeometry,MultiPoint:encodeMultiPointGeometry,MultiLineString:encodeMultiLineStringGeometry,MultiPolygon:encodeMultiPolygonGeometry,GeometryCollection:encodeGeometryCollectionGeometry};function encode(e){var t=e.getType(),r=(0,GeometryEncoder[t])(e),t=t.toUpperCase();return"function"==typeof e.getFlatCoordinates&&0<(e=encodeGeometryLayout(e)).length&&(t+=" "+e),0===r.length?t+" "+EMPTY:t+"("+r+")"}export default WKT;