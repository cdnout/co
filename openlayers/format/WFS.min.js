var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{assert}from"../asserts.js";import GML2 from"./GML2.js";import GML3 from"./GML3.js";import GMLBase,{GMLNS}from"./GMLBase.js";import{and as andFilter,bbox as bboxFilter}from"./filter.js";import XMLFeature from"./XMLFeature.js";import{readNonNegativeIntegerString,readNonNegativeInteger,writeStringTextNode}from"./xsd.js";import{assign}from"../obj.js";import{get as getProjection}from"../proj.js";import{createElementNS,isDocument,makeArrayPusher,makeChildAppender,makeObjectPropertySetter,makeSimpleNodeFactory,parse,parseNode,pushParseAndPop,pushSerializeAndPop,XML_SCHEMA_INSTANCE_URI}from"../xml.js";var FEATURE_COLLECTION_PARSERS={"http://www.opengis.net/gml":{boundedBy:makeObjectPropertySetter(GMLBase.prototype.readGeometryElement,"bounds")}},TRANSACTION_SUMMARY_PARSERS={"http://www.opengis.net/wfs":{totalInserted:makeObjectPropertySetter(readNonNegativeInteger),totalUpdated:makeObjectPropertySetter(readNonNegativeInteger),totalDeleted:makeObjectPropertySetter(readNonNegativeInteger)}},TRANSACTION_RESPONSE_PARSERS={"http://www.opengis.net/wfs":{TransactionSummary:makeObjectPropertySetter(readTransactionSummary,"transactionSummary"),InsertResults:makeObjectPropertySetter(readInsertResults,"insertIds")}},QUERY_SERIALIZERS={"http://www.opengis.net/wfs":{PropertyName:makeChildAppender(writeStringTextNode)}},TRANSACTION_SERIALIZERS={"http://www.opengis.net/wfs":{Insert:makeChildAppender(writeFeature),Update:makeChildAppender(writeUpdate),Delete:makeChildAppender(writeDelete),Property:makeChildAppender(writeProperty),Native:makeChildAppender(writeNative)}},FEATURE_PREFIX="feature",XMLNS="http://www.w3.org/2000/xmlns/",OGCNS="http://www.opengis.net/ogc",WFSNS="http://www.opengis.net/wfs",FESNS="http://www.opengis.net/fes",SCHEMA_LOCATIONS={"1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},DEFAULT_VERSION="1.1.0",WFS=function(r){function e(e){var t=r.call(this)||this,e=e||{};return t.featureType_=e.featureType,t.featureNS_=e.featureNS,t.gmlFormat_=e.gmlFormat||new GML3,t.schemaLocation_=e.schemaLocation||SCHEMA_LOCATIONS[DEFAULT_VERSION],t}return __extends(e,r),e.prototype.getFeatureType=function(){return this.featureType_},e.prototype.setFeatureType=function(e){this.featureType_=e},e.prototype.readFeaturesFromNode=function(e,t){var r={node:e},t=(assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),assign(r,this.getReadOptions(e,t||{})),[r]);return this.gmlFormat_.FEATURE_COLLECTION_PARSERS[GMLNS].featureMember=makeArrayPusher(GMLBase.prototype.readFeaturesInternal),pushParseAndPop([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,t,this.gmlFormat_)||[]},e.prototype.readTransactionResponse=function(e){var t;if(e)return"string"==typeof e?(t=parse(e),this.readTransactionResponseFromDocument(t)):isDocument(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)},e.prototype.readFeatureCollectionMetadata=function(e){var t;if(e)return"string"==typeof e?(t=parse(e),this.readFeatureCollectionMetadataFromDocument(t)):isDocument(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)},e.prototype.readFeatureCollectionMetadataFromDocument=function(e){for(var t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)},e.prototype.readFeatureCollectionMetadataFromNode=function(e){var t={},r=readNonNegativeIntegerString(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,pushParseAndPop(t,FEATURE_COLLECTION_PARSERS,e,[],this.gmlFormat_)},e.prototype.readTransactionResponseFromDocument=function(e){for(var t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)},e.prototype.readTransactionResponseFromNode=function(e){return pushParseAndPop({},TRANSACTION_RESPONSE_PARSERS,e,[])},e.prototype.writeGetFeature=function(e){var t,r=createElementNS(WFSNS,"GetFeature"),i=(r.setAttribute("service","WFS"),r.setAttribute("version","1.1.0"),e&&(e.handle&&r.setAttribute("handle",e.handle),e.outputFormat&&r.setAttribute("outputFormat",e.outputFormat),void 0!==e.maxFeatures&&r.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&r.setAttribute("resultType",e.resultType),void 0!==e.startIndex&&r.setAttribute("startIndex",String(e.startIndex)),void 0!==e.count&&r.setAttribute("count",String(e.count)),void 0!==e.viewParams&&r.setAttribute("viewParams",e.viewParams),t=e.filter,e.bbox&&(assert(e.geometryName,12),i=bboxFilter(e.geometryName,e.bbox,e.srsName),t=t?andFilter(t,i):i)),r.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",this.schemaLocation_),{node:r});return assign(i,{srsName:e.srsName,featureNS:e.featureNS||this.featureNS_,featurePrefix:e.featurePrefix,geometryName:e.geometryName,filter:t,propertyNames:e.propertyNames||[]}),assert(Array.isArray(e.featureTypes),11),writeGetFeature(r,e.featureTypes,[i]),r},e.prototype.writeTransaction=function(e,t,r,i){var a,n,o=[],s=createElementNS(WFSNS,"Transaction"),p=i.version||DEFAULT_VERSION,m="1.0.0"===p?2:3,p=(s.setAttribute("service","WFS"),s.setAttribute("version",p),i&&(a=i.gmlOptions||{},i.handle&&s.setAttribute("handle",i.handle)),SCHEMA_LOCATIONS[p]),p=(s.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",p),i.featurePrefix||FEATURE_PREFIX);return e&&(n=assign({node:s},{featureNS:i.featureNS,featureType:i.featureType,featurePrefix:p,gmlVersion:m,hasZ:i.hasZ,srsName:i.srsName}),assign(n,a),pushSerializeAndPop(n,TRANSACTION_SERIALIZERS,makeSimpleNodeFactory("Insert"),e,o)),t&&(n=assign({node:s},{featureNS:i.featureNS,featureType:i.featureType,featurePrefix:p,gmlVersion:m,hasZ:i.hasZ,srsName:i.srsName}),assign(n,a),pushSerializeAndPop(n,TRANSACTION_SERIALIZERS,makeSimpleNodeFactory("Update"),t,o)),r&&pushSerializeAndPop({node:s,featureNS:i.featureNS,featureType:i.featureType,featurePrefix:p,gmlVersion:m,srsName:i.srsName},TRANSACTION_SERIALIZERS,makeSimpleNodeFactory("Delete"),r,o),i.nativeElements&&pushSerializeAndPop({node:s,featureNS:i.featureNS,featureType:i.featureType,featurePrefix:p,gmlVersion:m,srsName:i.srsName},TRANSACTION_SERIALIZERS,makeSimpleNodeFactory("Native"),i.nativeElements,o),s},e.prototype.readProjectionFromDocument=function(e){for(var t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null},e.prototype.readProjectionFromNode=function(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild)for(var t,r=(e=e.firstElementChild.firstElementChild).firstElementChild;r;r=r.nextElementSibling)if(0!==r.childNodes.length&&(1!==r.childNodes.length||3!==r.firstChild.nodeType))return this.gmlFormat_.readGeometryElement(r,t=[{}]),getProjection(t.pop().srsName);return null},e}(XMLFeature);function readTransactionSummary(e,t){return pushParseAndPop({},TRANSACTION_SUMMARY_PARSERS,e,t)}var OGC_FID_PARSERS={"http://www.opengis.net/ogc":{FeatureId:makeArrayPusher(function(e,t){return e.getAttribute("fid")})}};function fidParser(e,t){parseNode(OGC_FID_PARSERS,e,t)}var INSERT_RESULTS_PARSERS={"http://www.opengis.net/wfs":{Feature:fidParser}};function readInsertResults(e,t){return pushParseAndPop([],INSERT_RESULTS_PARSERS,e,t)}function writeFeature(e,t,r){var i=r[r.length-1],a=i.featureType,n=i.featureNS,i=i.gmlVersion,n=createElementNS(n,a);e.appendChild(n),(2===i?GML2:GML3).prototype.writeFeatureElement(n,t,r)}function writeOgcFidFilter(e,t,r){var i=createElementNS(OGCNS,"Filter"),a=createElementNS(OGCNS,"FeatureId");i.appendChild(a),a.setAttribute("fid",t),e.appendChild(i)}function getTypeName(e,t){e=(e=e||FEATURE_PREFIX)+":";return 0===t.indexOf(e)?t:e+t}function writeDelete(e,t,r){var i=r[r.length-1],a=(assert(void 0!==t.getId(),26),i.featureType),n=i.featurePrefix,i=i.featureNS,a=getTypeName(n,a),a=(e.setAttribute("typeName",a),e.setAttributeNS(XMLNS,"xmlns:"+n,i),t.getId());void 0!==a&&writeOgcFidFilter(e,a,r)}function writeUpdate(e,t,r){var i=r[r.length-1],a=(assert(void 0!==t.getId(),27),i.featureType),n=i.featurePrefix,o=i.featureNS,a=getTypeName(n,a),s=t.getGeometryName(),a=(e.setAttribute("typeName",a),e.setAttributeNS(XMLNS,"xmlns:"+n,o),t.getId());if(void 0!==a){for(var p=t.getKeys(),m=[],d=0,l=p.length;d<l;d++){var u,N=t.get(p[d]);void 0!==N&&(u=p[d],N&&"function"==typeof N.getSimplifiedGeometry&&(u=s),m.push({name:u,value:N}))}pushSerializeAndPop({gmlVersion:i.gmlVersion,node:e,hasZ:i.hasZ,srsName:i.srsName},TRANSACTION_SERIALIZERS,makeSimpleNodeFactory("Property"),m,r),writeOgcFidFilter(e,a,r)}}function writeProperty(e,t,r){var i=createElementNS(WFSNS,"Name"),a=r[r.length-1].gmlVersion;e.appendChild(i),writeStringTextNode(i,t.name),void 0!==t.value&&null!==t.value&&(i=createElementNS(WFSNS,"Value"),e.appendChild(i),t.value&&"function"==typeof t.value.getSimplifiedGeometry?(2===a?GML2:GML3).prototype.writeGeometryElement(i,t.value,r):writeStringTextNode(i,t.value))}function writeNative(e,t,r){t.vendorId&&e.setAttribute("vendorId",t.vendorId),void 0!==t.safeToIgnore&&e.setAttribute("safeToIgnore",String(t.safeToIgnore)),void 0!==t.value&&writeStringTextNode(e,t.value)}var GETFEATURE_SERIALIZERS={"http://www.opengis.net/wfs":{Query:makeChildAppender(writeQuery)},"http://www.opengis.net/ogc":{During:makeChildAppender(writeDuringFilter),And:makeChildAppender(writeLogicalFilter),Or:makeChildAppender(writeLogicalFilter),Not:makeChildAppender(writeNotFilter),BBOX:makeChildAppender(writeBboxFilter),Contains:makeChildAppender(writeContainsFilter),Intersects:makeChildAppender(writeIntersectsFilter),Within:makeChildAppender(writeWithinFilter),PropertyIsEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNotEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsLessThan:makeChildAppender(writeComparisonFilter),PropertyIsLessThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThan:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNull:makeChildAppender(writeIsNullFilter),PropertyIsBetween:makeChildAppender(writeIsBetweenFilter),PropertyIsLike:makeChildAppender(writeIsLikeFilter)}};function writeQuery(e,t,r){var i=r[r.length-1],a=i.featurePrefix,n=i.featureNS,o=i.propertyNames,s=i.srsName,t=a?getTypeName(a,t):t,t=(e.setAttribute("typeName",t),s&&e.setAttribute("srsName",s),n&&e.setAttributeNS(XMLNS,"xmlns:"+a,n),assign({},i)),s=(t.node=e,pushSerializeAndPop(t,QUERY_SERIALIZERS,makeSimpleNodeFactory("PropertyName"),o,r),i.filter);s&&(a=createElementNS(OGCNS,"Filter"),e.appendChild(a),writeFilterCondition(a,s,r))}function writeFilterCondition(e,t,r){pushSerializeAndPop({node:e},GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(t.getTagName()),[t],r)}function writeBboxFilter(e,t,r){r[r.length-1].srsName=t.srsName,writeOgcPropertyName(e,t.geometryName),GML3.prototype.writeGeometryElement(e,t.extent,r)}function writeContainsFilter(e,t,r){r[r.length-1].srsName=t.srsName,writeOgcPropertyName(e,t.geometryName),GML3.prototype.writeGeometryElement(e,t.geometry,r)}function writeIntersectsFilter(e,t,r){r[r.length-1].srsName=t.srsName,writeOgcPropertyName(e,t.geometryName),GML3.prototype.writeGeometryElement(e,t.geometry,r)}function writeWithinFilter(e,t,r){r[r.length-1].srsName=t.srsName,writeOgcPropertyName(e,t.geometryName),GML3.prototype.writeGeometryElement(e,t.geometry,r)}function writeDuringFilter(e,t,r){var i=createElementNS(FESNS,"ValueReference"),i=(writeStringTextNode(i,t.propertyName),e.appendChild(i),createElementNS(GMLNS,"TimePeriod")),e=(e.appendChild(i),createElementNS(GMLNS,"begin")),e=(i.appendChild(e),writeTimeInstant(e,t.begin),createElementNS(GMLNS,"end"));i.appendChild(e),writeTimeInstant(e,t.end)}function writeLogicalFilter(e,t,r){for(var i={node:e},a=t.conditions,n=0,o=a.length;n<o;++n){var s=a[n];pushSerializeAndPop(i,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(s.getTagName()),[s],r)}}function writeNotFilter(e,t,r){t=t.condition;pushSerializeAndPop({node:e},GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(t.getTagName()),[t],r)}function writeComparisonFilter(e,t,r){void 0!==t.matchCase&&e.setAttribute("matchCase",t.matchCase.toString()),writeOgcPropertyName(e,t.propertyName),writeOgcLiteral(e,""+t.expression)}function writeIsNullFilter(e,t,r){writeOgcPropertyName(e,t.propertyName)}function writeIsBetweenFilter(e,t,r){writeOgcPropertyName(e,t.propertyName);var i=createElementNS(OGCNS,"LowerBoundary"),i=(e.appendChild(i),writeOgcLiteral(i,""+t.lowerBoundary),createElementNS(OGCNS,"UpperBoundary"));e.appendChild(i),writeOgcLiteral(i,""+t.upperBoundary)}function writeIsLikeFilter(e,t,r){e.setAttribute("wildCard",t.wildCard),e.setAttribute("singleChar",t.singleChar),e.setAttribute("escapeChar",t.escapeChar),void 0!==t.matchCase&&e.setAttribute("matchCase",t.matchCase.toString()),writeOgcPropertyName(e,t.propertyName),writeOgcLiteral(e,""+t.pattern)}function writeOgcExpression(e,t,r){e=createElementNS(OGCNS,e);writeStringTextNode(e,r),t.appendChild(e)}function writeOgcPropertyName(e,t){writeOgcExpression("PropertyName",e,t)}function writeOgcLiteral(e,t){writeOgcExpression("Literal",e,t)}function writeTimeInstant(e,t){var r=createElementNS(GMLNS,"TimeInstant"),e=(e.appendChild(r),createElementNS(GMLNS,"timePosition"));r.appendChild(e),writeStringTextNode(e,t)}function writeFilter(e){var t=createElementNS(OGCNS,"Filter");return writeFilterCondition(t,e,[]),t}function writeGetFeature(e,t,r){var i=r[r.length-1],i=assign({},i);i.node=e,pushSerializeAndPop(i,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory("Query"),t,r)}export default WFS;export{writeFilter};