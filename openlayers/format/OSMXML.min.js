var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();import{extend}from"../array.js";import Feature from"../Feature.js";import{transformGeometryWithOptions}from"./Feature.js";import XMLFeature from"./XMLFeature.js";import GeometryLayout from"../geom/GeometryLayout.js";import LineString from"../geom/LineString.js";import Point from"../geom/Point.js";import Polygon from"../geom/Polygon.js";import{isEmpty}from"../obj.js";import{get as getProjection}from"../proj.js";import{pushParseAndPop,makeStructureNS}from"../xml.js";var NAMESPACE_URIS=[null],WAY_PARSERS=makeStructureNS(NAMESPACE_URIS,{nd:readNd,tag:readTag}),PARSERS=makeStructureNS(NAMESPACE_URIS,{node:readNode,way:readWay}),OSMXML=function(e){function t(){var t=e.call(this)||this;return t.dataProjection=getProjection("EPSG:4326"),t}return __extends(t,e),t.prototype.readFeaturesFromNode=function(t,e){var r=this.getReadOptions(t,e);if("osm"==t.localName){for(var o=pushParseAndPop({nodes:{},ways:[],features:[]},PARSERS,t,[r]),n=0;n<o.ways.length;n++){for(var a=o.ways[n],s=[],i=0,u=a.ndrefs.length;i<u;i++){var f=o.nodes[a.ndrefs[i]];extend(s,f)}var p=void 0,p=a.ndrefs[0]==a.ndrefs[a.ndrefs.length-1]?new Polygon(s,GeometryLayout.XY,[s.length]):new LineString(s,GeometryLayout.XY),p=(transformGeometryWithOptions(p,!1,r),new Feature(p));p.setId(a.id),p.setProperties(a.tags,!0),o.features.push(p)}if(o.features)return o.features}return[]},t}(XMLFeature),NODE_PARSERS=makeStructureNS(NAMESPACE_URIS,{tag:readTag});function readNode(t,e){var r=e[0],o=e[e.length-1],n=t.getAttribute("id"),a=[parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))],t=(o.nodes[n]=a,pushParseAndPop({tags:{}},NODE_PARSERS,t,e));isEmpty(t.tags)||(e=new Point(a),transformGeometryWithOptions(e,!1,r),(a=new Feature(e)).setId(n),a.setProperties(t.tags,!0),o.features.push(a))}function readWay(t,e){var r=t.getAttribute("id"),r=pushParseAndPop({id:r,ndrefs:[],tags:{}},WAY_PARSERS,t,e);e[e.length-1].ways.push(r)}function readNd(t,e){e[e.length-1].ndrefs.push(t.getAttribute("ref"))}function readTag(t,e){e[e.length-1].tags[t.getAttribute("k")]=t.getAttribute("v")}export default OSMXML;