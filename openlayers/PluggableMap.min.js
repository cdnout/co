var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{getUid}from"./util.js";import Collection from"./Collection.js";import CollectionEventType from"./CollectionEventType.js";import MapBrowserEvent from"./MapBrowserEvent.js";import MapBrowserEventHandler from"./MapBrowserEventHandler.js";import MapBrowserEventType from"./MapBrowserEventType.js";import MapEvent from"./MapEvent.js";import MapEventType from"./MapEventType.js";import MapProperty from"./MapProperty.js";import RenderEventType from"./render/EventType.js";import BaseObject,{getChangeEventType}from"./Object.js";import ObjectEventType from"./ObjectEventType.js";import TileQueue from"./TileQueue.js";import View from"./View.js";import ViewHint from"./ViewHint.js";import{assert}from"./asserts.js";import{removeNode}from"./dom.js";import{listen,unlistenByKey}from"./events.js";import EventType from"./events/EventType.js";import{clone,createOrUpdateEmpty,equals,getForViewAndSize,isEmpty}from"./extent.js";import{TRUE}from"./functions.js";import{DEVICE_PIXEL_RATIO,IMAGE_DECODE}from"./has.js";import LayerGroup from"./layer/Group.js";import{hasArea}from"./size.js";import{DROP}from"./structs/PriorityQueue.js";import{create as createTransform,apply as applyTransform}from"./transform.js";var PluggableMap=function(o){function e(e){var t,r=o.call(this)||this,n=createOptionsInternal(e),i=(r.boundHandleBrowserEvent_=r.handleBrowserEvent.bind(r),r.maxTilesLoading_=void 0!==e.maxTilesLoading?e.maxTilesLoading:16,r.pixelRatio_=void 0!==e.pixelRatio?e.pixelRatio:DEVICE_PIXEL_RATIO,r.postRenderTimeoutHandle_,r.animationDelayKey_,r.animationDelay_=function(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}.bind(r),r.coordinateToPixelTransform_=createTransform(),r.pixelToCoordinateTransform_=createTransform(),r.frameIndex_=0,r.frameState_=null,r.previousExtent_=null,r.viewPropertyListenerKey_=null,r.viewChangeListenerKey_=null,r.layerGroupPropertyListenerKeys_=null,r.viewport_=document.createElement("div"),r.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),r.viewport_.style.position="relative",r.viewport_.style.overflow="hidden",r.viewport_.style.width="100%",r.viewport_.style.height="100%",r.viewport_.style.msTouchAction="none",r.viewport_.style.touchAction="none",r.overlayContainer_=document.createElement("div"),r.overlayContainer_.style.position="absolute",r.overlayContainer_.style.zIndex="0",r.overlayContainer_.style.width="100%",r.overlayContainer_.style.height="100%",r.overlayContainer_.className="ol-overlaycontainer",r.viewport_.appendChild(r.overlayContainer_),r.overlayContainerStopEvent_=document.createElement("div"),r.overlayContainerStopEvent_.style.position="absolute",r.overlayContainerStopEvent_.style.zIndex="0",r.overlayContainerStopEvent_.style.width="100%",r.overlayContainerStopEvent_.style.height="100%",r.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",r.viewport_.appendChild(r.overlayContainerStopEvent_),r.mapBrowserEventHandler_=new MapBrowserEventHandler(r,e.moveTolerance),r.handleMapBrowserEvent.bind(r));for(t in MapBrowserEventType)r.mapBrowserEventHandler_.addEventListener(MapBrowserEventType[t],i);r.keyboardEventTarget_=n.keyboardEventTarget,r.keyHandlerKeys_=null;e=r.handleBrowserEvent.bind(r);return r.viewport_.addEventListener(EventType.CONTEXTMENU,e,!1),r.viewport_.addEventListener(EventType.WHEEL,e,!1),r.controls=n.controls||new Collection,r.interactions=n.interactions||new Collection,r.labelCache_=null,r.labelCacheListenerKey_,r.overlays_=n.overlays,r.overlayIdIndex_={},r.renderer_=null,r.handleResize_,r.postRenderFunctions_=[],r.tileQueue_=new TileQueue(r.getTilePriority.bind(r),r.handleTileChange_.bind(r)),r.addEventListener(getChangeEventType(MapProperty.LAYERGROUP),r.handleLayerGroupChanged_),r.addEventListener(getChangeEventType(MapProperty.VIEW),r.handleViewChanged_),r.addEventListener(getChangeEventType(MapProperty.SIZE),r.handleSizeChanged_),r.addEventListener(getChangeEventType(MapProperty.TARGET),r.handleTargetChanged_),r.setProperties(n.values),r.controls.forEach(function(e){e.setMap(this)}.bind(r)),r.controls.addEventListener(CollectionEventType.ADD,function(e){e.element.setMap(this)}.bind(r)),r.controls.addEventListener(CollectionEventType.REMOVE,function(e){e.element.setMap(null)}.bind(r)),r.interactions.forEach(function(e){e.setMap(this)}.bind(r)),r.interactions.addEventListener(CollectionEventType.ADD,function(e){e.element.setMap(this)}.bind(r)),r.interactions.addEventListener(CollectionEventType.REMOVE,function(e){e.element.setMap(null)}.bind(r)),r.overlays_.forEach(r.addOverlayInternal_.bind(r)),r.overlays_.addEventListener(CollectionEventType.ADD,function(e){this.addOverlayInternal_(e.element)}.bind(r)),r.overlays_.addEventListener(CollectionEventType.REMOVE,function(e){var t=e.element.getId();void 0!==t&&delete this.overlayIdIndex_[t.toString()],e.element.setMap(null)}.bind(r)),r}return __extends(e,o),e.prototype.createRenderer=function(){throw new Error("Use a map type that has a createRenderer method")},e.prototype.addControl=function(e){this.getControls().push(e)},e.prototype.addInteraction=function(e){this.getInteractions().push(e)},e.prototype.addLayer=function(e){this.getLayerGroup().getLayers().push(e)},e.prototype.addOverlay=function(e){this.getOverlays().push(e)},e.prototype.addOverlayInternal_=function(e){var t=e.getId();void 0!==t&&(this.overlayIdIndex_[t.toString()]=e),e.setMap(this)},e.prototype.disposeInternal=function(){this.mapBrowserEventHandler_.dispose(),this.viewport_.removeEventListener(EventType.CONTEXTMENU,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener(EventType.WHEEL,this.boundHandleBrowserEvent_),void 0!==this.handleResize_&&(removeEventListener(EventType.RESIZE,this.handleResize_,!1),this.handleResize_=void 0),this.setTarget(null),o.prototype.disposeInternal.call(this)},e.prototype.forEachFeatureAtPixel=function(e,t,r){var n;if(this.frameState_)return e=this.getCoordinateFromPixel(e),n=void 0!==(r=void 0!==r?r:{}).hitTolerance?r.hitTolerance*this.frameState_.pixelRatio:0,r=void 0!==r.layerFilter?r.layerFilter:TRUE,this.renderer_.forEachFeatureAtCoordinate(e,this.frameState_,n,t,null,r,null)},e.prototype.getFeaturesAtPixel=function(e,t){var r=[];return this.forEachFeatureAtPixel(e,function(e){r.push(e)},t),r},e.prototype.forEachLayerAtPixel=function(e,t,r){var n;if(this.frameState_)return n=r||{},r=void 0!==n.hitTolerance?r.hitTolerance*this.frameState_.pixelRatio:0,n=n.layerFilter||TRUE,this.renderer_.forEachLayerAtPixel(e,this.frameState_,r,t,n)},e.prototype.hasFeatureAtPixel=function(e,t){if(!this.frameState_)return!1;var e=this.getCoordinateFromPixel(e),r=void 0!==(t=void 0!==t?t:{}).layerFilter?t.layerFilter:TRUE,t=void 0!==t.hitTolerance?t.hitTolerance*this.frameState_.pixelRatio:0;return this.renderer_.hasFeatureAtCoordinate(e,this.frameState_,t,r,null)},e.prototype.getEventCoordinate=function(e){return this.getCoordinateFromPixel(this.getEventPixel(e))},e.prototype.getEventPixel=function(e){var t=this.viewport_.getBoundingClientRect(),e="changedTouches"in e?e.changedTouches[0]:e;return[e.clientX-t.left,e.clientY-t.top]},e.prototype.getTarget=function(){return this.get(MapProperty.TARGET)},e.prototype.getTargetElement=function(){var e=this.getTarget();return void 0!==e?"string"==typeof e?document.getElementById(e):e:null},e.prototype.getCoordinateFromPixel=function(e){var t=this.frameState_;return t?applyTransform(t.pixelToCoordinateTransform,e.slice()):null},e.prototype.getControls=function(){return this.controls},e.prototype.getOverlays=function(){return this.overlays_},e.prototype.getOverlayById=function(e){e=this.overlayIdIndex_[e.toString()];return void 0!==e?e:null},e.prototype.getInteractions=function(){return this.interactions},e.prototype.getLayerGroup=function(){return this.get(MapProperty.LAYERGROUP)},e.prototype.getLayers=function(){return this.getLayerGroup().getLayers()},e.prototype.getLoading=function(){for(var e=this.getLayerGroup().getLayerStatesArray(),t=0,r=e.length;t<r;++t){var n=e[t].layer.getSource();if(n&&n.loading)return!0}return!1},e.prototype.getPixelFromCoordinate=function(e){var t=this.frameState_;return t?applyTransform(t.coordinateToPixelTransform,e.slice(0,2)):null},e.prototype.getRenderer=function(){return this.renderer_},e.prototype.getSize=function(){return this.get(MapProperty.SIZE)},e.prototype.getView=function(){return this.get(MapProperty.VIEW)},e.prototype.getViewport=function(){return this.viewport_},e.prototype.getOverlayContainer=function(){return this.overlayContainer_},e.prototype.getOverlayContainerStopEvent=function(){return this.overlayContainerStopEvent_},e.prototype.getTilePriority=function(e,t,r,n){var i=this.frameState_;if(!(i&&t in i.wantedTiles))return DROP;if(!i.wantedTiles[t][e.getKey()])return DROP;t=i.viewState.center,e=r[0]-t[0],i=r[1]-t[1];return 65536*Math.log(n)+Math.sqrt(e*e+i*i)/n},e.prototype.handleBrowserEvent=function(e,t){t=t||e.type,t=new MapBrowserEvent(t,this,e);this.handleMapBrowserEvent(t)},e.prototype.handleMapBrowserEvent=function(e){if(this.frameState_){for(var t=e.originalEvent.target;t instanceof HTMLElement;){if(t.parentElement===this.overlayContainerStopEvent_)return;t=t.parentElement}e.frameState=this.frameState_;var r=this.getInteractions().getArray();if(!1!==this.dispatchEvent(e))for(var n=r.length-1;0<=n;n--){var i=r[n];if(i.getActive())if(!i.handleEvent(e))break}}},e.prototype.handlePostRender=function(){for(var e,t,r,n=this.frameState_,i=this.tileQueue_,o=(i.isEmpty()||(r=t=this.maxTilesLoading_,n&&((e=n.viewHints)[ViewHint.ANIMATING]||e[ViewHint.INTERACTING])&&(t=(e=!IMAGE_DECODE&&8<Date.now()-n.time)?0:8,r=e?0:2),i.getTilesLoading()<t&&(i.reprioritize(),i.loadMoreTiles(t,r))),!n||!this.hasListener(RenderEventType.RENDERCOMPLETE)||n.animate||this.tileQueue_.getTilesLoading()||this.getLoading()||this.renderer_.dispatchRenderEvent(RenderEventType.RENDERCOMPLETE,n),this.postRenderFunctions_),a=0,s=o.length;a<s;++a)o[a](this,n);o.length=0},e.prototype.handleSizeChanged_=function(){this.getView()&&this.getView().resolveConstraints(0),this.render()},e.prototype.handleTargetChanged_=function(){var e;if(this.getTarget()&&(e=this.getTargetElement()),this.keyHandlerKeys_){for(var t=0,r=this.keyHandlerKeys_.length;t<r;++t)unlistenByKey(this.keyHandlerKeys_[t]);this.keyHandlerKeys_=null}e?(e.appendChild(this.viewport_),this.renderer_||(this.renderer_=this.createRenderer()),e=this.keyboardEventTarget_||e,this.keyHandlerKeys_=[listen(e,EventType.KEYDOWN,this.handleBrowserEvent,this),listen(e,EventType.KEYPRESS,this.handleBrowserEvent,this)],this.handleResize_||(this.handleResize_=this.updateSize.bind(this),window.addEventListener(EventType.RESIZE,this.handleResize_,!1))):(this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0),removeNode(this.viewport_),void 0!==this.handleResize_&&(removeEventListener(EventType.RESIZE,this.handleResize_,!1),this.handleResize_=void 0)),this.updateSize()},e.prototype.handleTileChange_=function(){this.render()},e.prototype.handleViewPropertyChanged_=function(){this.render()},e.prototype.handleViewChanged_=function(){this.viewPropertyListenerKey_&&(unlistenByKey(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(unlistenByKey(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);var e=this.getView();e&&(this.viewport_.setAttribute("data-view",getUid(e)),this.viewPropertyListenerKey_=listen(e,ObjectEventType.PROPERTYCHANGE,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=listen(e,EventType.CHANGE,this.handleViewPropertyChanged_,this),e.resolveConstraints(0)),this.render()},e.prototype.handleLayerGroupChanged_=function(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(unlistenByKey),this.layerGroupPropertyListenerKeys_=null);var e=this.getLayerGroup();e&&(this.layerGroupPropertyListenerKeys_=[listen(e,ObjectEventType.PROPERTYCHANGE,this.render,this),listen(e,EventType.CHANGE,this.render,this)]),this.render()},e.prototype.isRendered=function(){return!!this.frameState_},e.prototype.renderSync=function(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()},e.prototype.redrawText=function(){for(var e=this.getLayerGroup().getLayerStatesArray(),t=0,r=e.length;t<r;++t){var n=e[t].layer;n.hasRenderer()&&n.getRenderer().handleFontsChanged()}},e.prototype.render=function(){this.renderer_&&void 0===this.animationDelayKey_&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))},e.prototype.removeControl=function(e){return this.getControls().remove(e)},e.prototype.removeInteraction=function(e){return this.getInteractions().remove(e)},e.prototype.removeLayer=function(e){return this.getLayerGroup().getLayers().remove(e)},e.prototype.removeOverlay=function(e){return this.getOverlays().remove(e)},e.prototype.renderFrame_=function(e){var t,r=this.getSize(),n=this.getView(),i=this.frameState_,o=null;void 0!==r&&hasArea(r)&&n&&n.isDef()&&(t=n.getHints(this.frameState_?this.frameState_.viewHints:void 0),n=n.getState(),o={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutterItems:i?i.declutterItems:[],extent:getForViewAndSize(n.center,n.resolution,n.rotation,r),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:r,tileQueue:this.tileQueue_,time:e,usedTiles:{},viewState:n,viewHints:t,wantedTiles:{}}),this.frameState_=o,this.renderer_.renderFrame(o),o&&(o.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,o.postRenderFunctions),!i||this.previousExtent_&&(isEmpty(this.previousExtent_)||equals(o.extent,this.previousExtent_))||(this.dispatchEvent(new MapEvent(MapEventType.MOVESTART,this,i)),this.previousExtent_=createOrUpdateEmpty(this.previousExtent_)),!this.previousExtent_||o.viewHints[ViewHint.ANIMATING]||o.viewHints[ViewHint.INTERACTING]||equals(o.extent,this.previousExtent_)||(this.dispatchEvent(new MapEvent(MapEventType.MOVEEND,this,o)),clone(o.extent,this.previousExtent_))),this.dispatchEvent(new MapEvent(MapEventType.POSTRENDER,this,o)),this.postRenderTimeoutHandle_=setTimeout(this.handlePostRender.bind(this),0)},e.prototype.setLayerGroup=function(e){this.set(MapProperty.LAYERGROUP,e)},e.prototype.setSize=function(e){this.set(MapProperty.SIZE,e)},e.prototype.setTarget=function(e){this.set(MapProperty.TARGET,e)},e.prototype.setView=function(e){this.set(MapProperty.VIEW,e)},e.prototype.updateSize=function(){var e,t=this.getTargetElement();t?(e=getComputedStyle(t),this.setSize([t.offsetWidth-parseFloat(e.borderLeftWidth)-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight)-parseFloat(e.borderRightWidth),t.offsetHeight-parseFloat(e.borderTopWidth)-parseFloat(e.paddingTop)-parseFloat(e.paddingBottom)-parseFloat(e.borderBottomWidth)])):this.setSize(void 0)},e}(BaseObject);function createOptionsInternal(e){var t,r,n=null,i=(void 0!==e.keyboardEventTarget&&(n="string"==typeof e.keyboardEventTarget?document.getElementById(e.keyboardEventTarget):e.keyboardEventTarget),{}),o=e.layers&&"function"==typeof e.layers.getLayers?e.layers:new LayerGroup({layers:e.layers});return i[MapProperty.LAYERGROUP]=o,i[MapProperty.TARGET]=e.target,i[MapProperty.VIEW]=void 0!==e.view?e.view:new View,{controls:t=void 0!==e.controls?Array.isArray(e.controls)?new Collection(e.controls.slice()):(assert("function"==typeof e.controls.getArray,47),e.controls):t,interactions:r=void 0!==e.interactions?Array.isArray(e.interactions)?new Collection(e.interactions.slice()):(assert("function"==typeof e.interactions.getArray,48),e.interactions):r,keyboardEventTarget:n,overlays:void 0!==e.overlays?Array.isArray(e.overlays)?new Collection(e.overlays.slice()):(assert("function"==typeof e.overlays.getArray,49),e.overlays):new Collection,values:i}}export default PluggableMap;