var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();import ImageBase from"./ImageBase.js";import ImageState from"./ImageState.js";import{listenOnce,unlistenByKey}from"./events.js";import EventType from"./events/EventType.js";import{getHeight}from"./extent.js";import{IMAGE_DECODE}from"./has.js";var ImageWrapper=function(o){function t(t,e,n,i,a,s){t=o.call(this,t,e,n,ImageState.IDLE)||this;return t.src_=i,t.image_=new Image,null!==a&&(t.image_.crossOrigin=a),t.unlisten_=null,t.state=ImageState.IDLE,t.imageLoadFunction_=s,t}return __extends(t,o),t.prototype.getImage=function(){return this.image_},t.prototype.handleImageError_=function(){this.state=ImageState.ERROR,this.unlistenImage_(),this.changed()},t.prototype.handleImageLoad_=function(){void 0===this.resolution&&(this.resolution=getHeight(this.extent)/this.image_.height),this.state=ImageState.LOADED,this.unlistenImage_(),this.changed()},t.prototype.load=function(){this.state!=ImageState.IDLE&&this.state!=ImageState.ERROR||(this.state=ImageState.LOADING,this.changed(),this.imageLoadFunction_(this,this.src_),this.unlisten_=listenImage(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))},t.prototype.setImage=function(t){this.image_=t},t.prototype.unlistenImage_=function(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)},t}(ImageBase);function listenImage(t,e,n){var i,a;if(t.src&&IMAGE_DECODE)return i=t.decode(),a=!0,i.then(function(){a&&e()}).catch(function(t){a&&("EncodingError"===t.name&&"Invalid image type."===t.message?e:n)()}),function(){a=!1};var s=[listenOnce(t,EventType.LOAD,e),listenOnce(t,EventType.ERROR,n)];return function(){s.forEach(unlistenByKey)}}export default ImageWrapper;export{listenImage};