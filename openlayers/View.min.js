var __extends=this&&this.__extends||function(){var n=function(t,o){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var e in o)o.hasOwnProperty(e)&&(t[e]=o[e])})(t,o)};return function(t,o){function e(){this.constructor=t}n(t,o),t.prototype=null===o?Object.create(o):(e.prototype=o.prototype,new e)}}();import{DEFAULT_TILE_SIZE}from"./tilegrid/common.js";import{getUid}from"./util.js";import{VOID}from"./functions.js";import{createExtent,none as centerNone}from"./centerconstraint.js";import BaseObject from"./Object.js";import{createSnapToResolutions,createSnapToPower}from"./resolutionconstraint.js";import{createSnapToZero,createSnapToN,none as rotationNone,disable}from"./rotationconstraint.js";import ViewHint from"./ViewHint.js";import ViewProperty from"./ViewProperty.js";import{linearFindNearest}from"./array.js";import{assert}from"./asserts.js";import{add as addCoordinate,rotate as rotateCoordinate,equals as coordinatesEqual}from"./coordinate.js";import{inAndOut}from"./easing.js";import{getForViewAndSize,getCenter,getHeight,getWidth,isEmpty}from"./extent.js";import GeometryType from"./geom/GeometryType.js";import{fromExtent as polygonFromExtent}from"./geom/Polygon.js";import{clamp,modulo}from"./math.js";import{assign}from"./obj.js";import{createProjection,METERS_PER_UNIT,toUserCoordinate,toUserExtent,fromUserCoordinate,fromUserExtent,getUserProjection}from"./proj.js";import Units from"./proj/Units.js";import{equals}from"./coordinate.js";import{easeOut}from"./easing.js";import{createMinMaxResolution}from"./resolutionconstraint.js";var DEFAULT_MIN_ZOOM=0,View=function(e){function t(t){var o=e.call(this)||this,t=assign({},t);return o.hints_=[0,0],o.animations_=[],o.updateAnimationKey_,o.projection_=createProjection(t.projection,"EPSG:3857"),o.targetCenter_=null,o.targetResolution_,o.targetRotation_,t.center&&(t.center=fromUserCoordinate(t.center,o.projection_)),t.extent&&(t.extent=fromUserExtent(t.extent,o.projection_)),o.applyOptions_(t),o}return __extends(t,e),t.prototype.applyOptions_=function(t){var o=createResolutionConstraint(t),e=(this.maxResolution_=o.maxResolution,this.minResolution_=o.minResolution,this.zoomFactor_=o.zoomFactor,this.resolutions_=t.resolutions,this.minZoom_=o.minZoom,createCenterConstraint(t)),o=o.constraint,n=createRotationConstraint(t);this.constraints_={center:e,resolution:o,rotation:n},this.setRotation(void 0!==t.rotation?t.rotation:0),this.setCenterInternal(void 0!==t.center?t.center:null),void 0!==t.resolution?this.setResolution(t.resolution):void 0!==t.zoom&&this.setZoom(t.zoom),this.resolveConstraints(0),this.setProperties({}),this.options_=t},t.prototype.getUpdatedOptions_=function(t){var o=assign({},this.options_);return void 0!==o.resolution?o.resolution=this.getResolution():o.zoom=this.getZoom(),o.center=this.getCenterInternal(),o.rotation=this.getRotation(),assign({},o,t)},t.prototype.animate=function(t){this.isDef()&&!this.getAnimating()&&this.resolveConstraints(0);for(var o=new Array(arguments.length),e=0;e<o.length;++e){var n=arguments[e];n.center&&((n=assign({},n)).center=fromUserCoordinate(n.center,this.getProjection())),n.anchor&&((n=assign({},n)).anchor=fromUserCoordinate(n.anchor,this.getProjection())),o[e]=n}this.animateInternal.apply(this,o)},t.prototype.animateInternal=function(t){var o,e,n=arguments.length;if(1<n&&"function"==typeof arguments[n-1]&&(o=arguments[n-1],--n),!this.isDef())return(e=arguments[n-1]).center&&this.setCenterInternal(e.center),void 0!==e.zoom&&this.setZoom(e.zoom),void 0!==e.rotation&&this.setRotation(e.rotation),void(o&&animationCallback(o,!0));for(var i=Date.now(),r=this.targetCenter_.slice(),s=this.targetResolution_,a=this.targetRotation_,h=[],u=0;u<n;++u){var l=arguments[u],c={start:i,complete:!1,anchor:l.anchor,duration:void 0!==l.duration?l.duration:1e3,easing:l.easing||inAndOut,callback:o};l.center&&(c.sourceCenter=r,c.targetCenter=l.center.slice(),r=c.targetCenter),void 0!==l.zoom?(c.sourceResolution=s,c.targetResolution=this.getResolutionForZoom(l.zoom),s=c.targetResolution):l.resolution&&(c.sourceResolution=s,c.targetResolution=l.resolution,s=c.targetResolution),void 0!==l.rotation&&(c.sourceRotation=a,l=modulo(l.rotation-a+Math.PI,2*Math.PI)-Math.PI,c.targetRotation=a+l,a=c.targetRotation),isNoopAnimation(c)?c.complete=!0:i+=c.duration,h.push(c)}this.animations_.push(h),this.setHint(ViewHint.ANIMATING,1),this.updateAnimations_()},t.prototype.getAnimating=function(){return 0<this.hints_[ViewHint.ANIMATING]},t.prototype.getInteracting=function(){return 0<this.hints_[ViewHint.INTERACTING]},t.prototype.cancelAnimations=function(){this.setHint(ViewHint.ANIMATING,-this.hints_[ViewHint.ANIMATING]);for(var t=0,o=this.animations_.length;t<o;++t){var e=this.animations_[t];e[0].callback&&animationCallback(e[0].callback,!1)}this.animations_.length=0},t.prototype.updateAnimations_=function(){if(void 0!==this.updateAnimationKey_&&(cancelAnimationFrame(this.updateAnimationKey_),this.updateAnimationKey_=void 0),this.getAnimating()){for(var t=Date.now(),o=!1,e=this.animations_.length-1;0<=e;--e){for(var n,i=this.animations_[e],r=!0,s=0,a=i.length;s<a;++s){var h=i[s];if(!h.complete){var u,l,c,p,g=t-h.start,g=0<h.duration?g/h.duration:1,g=(1<=g?(h.complete=!0,g=1):r=!1,h.easing(g));if(h.sourceCenter&&(l=h.sourceCenter[0],p=h.sourceCenter[1],u=h.targetCenter[0],c=h.targetCenter[1],this.targetCenter_=[l+g*(u-l),p+g*(c-p)]),h.sourceResolution&&h.targetResolution&&(u=1===g?h.targetResolution:h.sourceResolution+g*(h.targetResolution-h.sourceResolution),h.anchor&&(l=this.getSizeFromViewport_(this.getRotation()),c=this.constraints_.resolution(u,0,l,!0),this.targetCenter_=this.calculateCenterZoom(c,h.anchor)),this.targetResolution_=u,this.applyTargetState_(!0)),void 0!==h.sourceRotation&&void 0!==h.targetRotation&&(p=1===g?modulo(h.targetRotation+Math.PI,2*Math.PI)-Math.PI:h.sourceRotation+g*(h.targetRotation-h.sourceRotation),h.anchor&&(g=this.constraints_.rotation(p,!0),this.targetCenter_=this.calculateCenterRotate(g,h.anchor)),this.targetRotation_=p),this.applyTargetState_(!0),o=!0,!h.complete)break}}r&&(this.animations_[e]=null,this.setHint(ViewHint.ANIMATING,-1),(n=i[0].callback)&&animationCallback(n,!0))}this.animations_=this.animations_.filter(Boolean),o&&void 0===this.updateAnimationKey_&&(this.updateAnimationKey_=requestAnimationFrame(this.updateAnimations_.bind(this)))}},t.prototype.calculateCenterRotate=function(t,o){var e,n=this.getCenterInternal();return void 0!==n&&(e=[n[0]-o[0],n[1]-o[1]],rotateCoordinate(e,t-this.getRotation()),addCoordinate(e,o)),e},t.prototype.calculateCenterZoom=function(t,o){var e,n=this.getCenterInternal(),i=this.getResolution();return e=void 0!==n&&void 0!==i?[o[0]-t*(o[0]-n[0])/i,o[1]-t*(o[1]-n[1])/i]:e},t.prototype.getSizeFromViewport_=function(t){var o,e=[100,100],n='.ol-viewport[data-view="'+getUid(this)+'"]',n=document.querySelector(n);return n&&(n=getComputedStyle(n),e[0]=parseInt(n.width,10),e[1]=parseInt(n.height,10)),t&&(n=e[0],o=e[1],e[0]=Math.abs(n*Math.cos(t))+Math.abs(o*Math.sin(t)),e[1]=Math.abs(n*Math.sin(t))+Math.abs(o*Math.cos(t))),e},t.prototype.getCenter=function(){var t=this.getCenterInternal();return t&&toUserCoordinate(t,this.getProjection())},t.prototype.getCenterInternal=function(){return this.get(ViewProperty.CENTER)},t.prototype.getConstraints=function(){return this.constraints_},t.prototype.getHints=function(t){return void 0!==t?(t[0]=this.hints_[0],t[1]=this.hints_[1],t):this.hints_.slice()},t.prototype.calculateExtent=function(t){t=this.calculateExtentInternal(t);return toUserExtent(t,this.getProjection())},t.prototype.calculateExtentInternal=function(t){var t=t||this.getSizeFromViewport_(),o=this.getCenterInternal(),e=(assert(o,1),this.getResolution()),n=(assert(void 0!==e,2),this.getRotation());return assert(void 0!==n,3),getForViewAndSize(o,e,n,t)},t.prototype.getMaxResolution=function(){return this.maxResolution_},t.prototype.getMinResolution=function(){return this.minResolution_},t.prototype.getMaxZoom=function(){return this.getZoomForResolution(this.minResolution_)},t.prototype.setMaxZoom=function(t){this.applyOptions_(this.getUpdatedOptions_({maxZoom:t}))},t.prototype.getMinZoom=function(){return this.getZoomForResolution(this.maxResolution_)},t.prototype.setMinZoom=function(t){this.applyOptions_(this.getUpdatedOptions_({minZoom:t}))},t.prototype.setConstrainResolution=function(t){this.applyOptions_(this.getUpdatedOptions_({constrainResolution:t}))},t.prototype.getProjection=function(){return this.projection_},t.prototype.getResolution=function(){return this.get(ViewProperty.RESOLUTION)},t.prototype.getResolutions=function(){return this.resolutions_},t.prototype.getResolutionForExtent=function(t,o){return this.getResolutionForExtentInternal(fromUserExtent(t,this.getProjection()),o)},t.prototype.getResolutionForExtentInternal=function(t,o){var o=o||this.getSizeFromViewport_(),e=getWidth(t)/o[0],t=getHeight(t)/o[1];return Math.max(e,t)},t.prototype.getResolutionForValueFunction=function(t){var o=t||2,e=this.maxResolution_,t=this.minResolution_,n=Math.log(e/t)/Math.log(o);return function(t){return e/Math.pow(o,t*n)}},t.prototype.getRotation=function(){return this.get(ViewProperty.ROTATION)},t.prototype.getValueForResolutionFunction=function(t){var o=t||2,e=this.maxResolution_,t=this.minResolution_,n=Math.log(e/t)/Math.log(o);return function(t){return Math.log(e/t)/Math.log(o)/n}},t.prototype.getState=function(){var t=this.getCenterInternal(),o=this.getProjection(),e=this.getResolution(),n=this.getRotation();return{center:t.slice(0),projection:void 0!==o?o:null,resolution:e,rotation:n,zoom:this.getZoom()}},t.prototype.getZoom=function(){var t,o=this.getResolution();return t=void 0!==o?this.getZoomForResolution(o):t},t.prototype.getZoomForResolution=function(t){var o,e,n=this.minZoom_||0;return e=this.resolutions_?(e=linearFindNearest(this.resolutions_,t,1),o=this.resolutions_[n=e],e==this.resolutions_.length-1?2:o/this.resolutions_[e+1]):(o=this.maxResolution_,this.zoomFactor_),n+Math.log(o/t)/Math.log(e)},t.prototype.getResolutionForZoom=function(t){if(this.resolutions_){if(this.resolutions_.length<=1)return 0;var o=clamp(Math.floor(t),0,this.resolutions_.length-2),e=this.resolutions_[o]/this.resolutions_[o+1];return this.resolutions_[o]/Math.pow(e,clamp(t-o,0,1))}return this.maxResolution_/Math.pow(this.zoomFactor_,t-this.minZoom_)},t.prototype.fit=function(t,o){var e,n,o=assign({size:this.getSizeFromViewport_()},o||{});assert(Array.isArray(t)||"function"==typeof t.getSimplifiedGeometry,24),Array.isArray(t)?(assert(!isEmpty(t),25),n=fromUserExtent(t,this.getProjection()),e=polygonFromExtent(n)):t.getType()===GeometryType.CIRCLE?(n=fromUserExtent(t.getExtent(),this.getProjection()),(e=polygonFromExtent(n)).rotate(this.getRotation(),getCenter(n))):e=(n=getUserProjection())?e.clone().transform(n,this.getProjection()):t,this.fitInternal(e,o)},t.prototype.fitInternal=function(t,o){for(var o=o||{},e=(e=o.size)||this.getSizeFromViewport_(),n=void 0!==o.padding?o.padding:[0,0,0,0],i=void 0!==o.nearest&&o.nearest,r=void 0!==o.minResolution?o.minResolution:void 0!==o.maxZoom?this.getResolutionForZoom(o.maxZoom):0,s=t.getFlatCoordinates(),a=this.getRotation(),h=Math.cos(-a),u=Math.sin(-a),l=1/0,c=1/0,p=-1/0,g=-1/0,m=t.getStride(),_=0,R=s.length;_<R;_+=m)var d=s[_]*h-s[_+1]*u,f=s[_]*u+s[_+1]*h,l=Math.min(l,d),c=Math.min(c,f),p=Math.max(p,d),g=Math.max(g,f);a=this.getResolutionForExtentInternal([l,c,p,g],[e[0]-n[1]-n[3],e[1]-n[0]-n[2]]),a=isNaN(a)?r:Math.max(a,r),a=this.getConstrainedResolution(a,i?0:1),u=-u,t=(l+p)/2,e=(c+g)/2,r=[(t+=(n[1]-n[3])/2*a)*h-(e+=(n[0]-n[2])/2*a)*u,e*h+t*u],i=o.callback||VOID;void 0!==o.duration?this.animateInternal({resolution:a,center:this.getConstrainedCenter(r,a),duration:o.duration,easing:o.easing},i):(this.targetResolution_=a,this.targetCenter_=r,this.applyTargetState_(!1,!0),animationCallback(i,!0))},t.prototype.centerOn=function(t,o,e){this.centerOnInternal(fromUserCoordinate(t,this.getProjection()),o,e)},t.prototype.centerOnInternal=function(t,o,e){var n=this.getRotation(),i=Math.cos(-n),n=Math.sin(-n),r=t[0]*i-t[1]*n,t=t[1]*i+t[0]*n,s=this.getResolution(),e=(r+=(o[0]/2-e[0])*s)*i-(t+=(e[1]-o[1]/2)*s)*(n=-n);this.setCenterInternal([e,t*i+r*n])},t.prototype.isDef=function(){return!!this.getCenterInternal()&&void 0!==this.getResolution()},t.prototype.adjustCenter=function(t){var o=toUserCoordinate(this.targetCenter_,this.getProjection());this.setCenter([o[0]+t[0],o[1]+t[1]])},t.prototype.adjustCenterInternal=function(t){var o=this.targetCenter_;this.setCenterInternal([o[0]+t[0],o[1]+t[1]])},t.prototype.adjustResolution=function(t,o){var e=this.getAnimating()||this.getInteracting(),n=this.getSizeFromViewport_(this.getRotation()),n=this.constraints_.resolution(this.targetResolution_*t,0,n,e);void 0!==o&&(this.targetCenter_=this.calculateCenterZoom(n,o)),this.targetResolution_*=t,this.applyTargetState_()},t.prototype.adjustZoom=function(t,o){this.adjustResolution(Math.pow(this.zoomFactor_,-t),o)},t.prototype.adjustRotation=function(t,o){o=o&&fromUserCoordinate(o,this.getProjection()),this.adjustRotationInternal(t,o)},t.prototype.adjustRotationInternal=function(t,o){var e=this.getAnimating()||this.getInteracting(),e=this.constraints_.rotation(this.targetRotation_+t,e);void 0!==o&&(this.targetCenter_=this.calculateCenterRotate(e,o)),this.targetRotation_+=t,this.applyTargetState_()},t.prototype.setCenter=function(t){this.setCenterInternal(fromUserCoordinate(t,this.getProjection()))},t.prototype.setCenterInternal=function(t){this.targetCenter_=t,this.applyTargetState_()},t.prototype.setHint=function(t,o){return this.hints_[t]+=o,this.changed(),this.hints_[t]},t.prototype.setResolution=function(t){this.targetResolution_=t,this.applyTargetState_()},t.prototype.setRotation=function(t){this.targetRotation_=t,this.applyTargetState_()},t.prototype.setZoom=function(t){this.setResolution(this.getResolutionForZoom(t))},t.prototype.applyTargetState_=function(t,o){var o=this.getAnimating()||this.getInteracting()||o,e=this.constraints_.rotation(this.targetRotation_,o),n=this.getSizeFromViewport_(e),i=this.constraints_.resolution(this.targetResolution_,0,n,o),n=this.constraints_.center(this.targetCenter_,i,n,o);this.get(ViewProperty.ROTATION)!==e&&this.set(ViewProperty.ROTATION,e),this.get(ViewProperty.RESOLUTION)!==i&&this.set(ViewProperty.RESOLUTION,i),this.get(ViewProperty.CENTER)&&equals(this.get(ViewProperty.CENTER),n)||this.set(ViewProperty.CENTER,n),this.getAnimating()&&!t&&this.cancelAnimations()},t.prototype.resolveConstraints=function(t,o,e){var t=void 0!==t?t:200,o=o||0,n=this.constraints_.rotation(this.targetRotation_),i=this.getSizeFromViewport_(n),o=this.constraints_.resolution(this.targetResolution_,o,i),i=this.constraints_.center(this.targetCenter_,o,i);if(0===t)return this.targetResolution_=o,this.targetRotation_=n,this.targetCenter_=i,void this.applyTargetState_();this.getResolution()===o&&this.getRotation()===n&&this.getCenterInternal()&&equals(this.getCenterInternal(),i)||(this.getAnimating()&&this.cancelAnimations(),this.animateInternal({rotation:n,center:i,resolution:o,duration:t,easing:easeOut,anchor:e}))},t.prototype.beginInteraction=function(){this.resolveConstraints(0),this.setHint(ViewHint.INTERACTING,1)},t.prototype.endInteraction=function(t,o,e){this.setHint(ViewHint.INTERACTING,-1),this.resolveConstraints(t,o,e)},t.prototype.getConstrainedCenter=function(t,o){var e=this.getSizeFromViewport_(this.getRotation());return this.constraints_.center(t,o||this.getResolution(),e)},t.prototype.getConstrainedZoom=function(t,o){t=this.getResolutionForZoom(t);return this.getZoomForResolution(this.getConstrainedResolution(t,o))},t.prototype.getConstrainedResolution=function(t,o){var o=o||0,e=this.getSizeFromViewport_(this.getRotation());return this.constraints_.resolution(t,o,e)},t}(BaseObject);function animationCallback(t,o){setTimeout(function(){t(o)},0)}function createCenterConstraint(t){if(void 0!==t.extent)return o=void 0===t.smoothExtentConstraint||t.smoothExtentConstraint,createExtent(t.extent,t.constrainOnlyCenter,o);var o=createProjection(t.projection,"EPSG:3857");return!0!==t.multiWorld&&o.isGlobal()?((t=o.getExtent().slice())[0]=-1/0,t[2]=1/0,createExtent(t,!1,!1)):centerNone}function createResolutionConstraint(t){var o,e,n=void 0!==t.minZoom?t.minZoom:DEFAULT_MIN_ZOOM,i=void 0!==t.maxZoom?t.maxZoom:28,r=void 0!==t.zoomFactor?t.zoomFactor:2,s=void 0!==t.multiWorld&&t.multiWorld,a=void 0===t.smoothResolutionConstraint||t.smoothResolutionConstraint,h=createProjection(t.projection,"EPSG:3857"),u=h.getExtent(),l=t.constrainOnlyCenter,c=t.extent;return s||c||!h.isGlobal()||(l=!1,c=u),{constraint:void 0!==t.resolutions?(o=(s=t.resolutions)[n],e=void 0!==s[i]?s[i]:s[s.length-1],t.constrainResolution?createSnapToResolutions(s,a,!l&&c):createMinMaxResolution(o,e,a,!l&&c)):(u=(s=(u?Math.max(getWidth(u),getHeight(u)):360*METERS_PER_UNIT[Units.DEGREES]/h.getMetersPerUnit())/DEFAULT_TILE_SIZE/Math.pow(2,DEFAULT_MIN_ZOOM))/Math.pow(2,28-DEFAULT_MIN_ZOOM),void 0!==(o=t.maxResolution)?n=0:o=s/Math.pow(r,n),void 0===(e=t.minResolution)&&(e=void 0!==t.maxZoom?void 0!==t.maxResolution?o/Math.pow(r,i):s/Math.pow(r,i):u),i=n+Math.floor(Math.log(o/e)/Math.log(r)),e=o/Math.pow(r,i-n),t.constrainResolution?createSnapToPower(r,o,e,a,!l&&c):createMinMaxResolution(o,e,a,!l&&c)),maxResolution:o,minResolution:e,minZoom:n,zoomFactor:r}}function createRotationConstraint(t){return void 0===t.enableRotation||t.enableRotation?void 0===(t=t.constrainRotation)||!0===t?createSnapToZero():!1!==t&&"number"==typeof t?createSnapToN(t):rotationNone:disable}function isNoopAnimation(t){return!(t.sourceCenter&&t.targetCenter&&!coordinatesEqual(t.sourceCenter,t.targetCenter))&&(t.sourceResolution===t.targetResolution&&t.sourceRotation===t.targetRotation)}export default View;export{createCenterConstraint,createResolutionConstraint,createRotationConstraint,isNoopAnimation};