import{createCanvasContext2D}from"./dom.js";import{containsCoordinate,createEmpty,extend,getHeight,getTopLeft,getWidth}from"./extent.js";import{solveLinearSystem}from"./math.js";import{getPointResolution,transform}from"./proj.js";function calculateSourceResolution(e,t,n,o){var r=transform(n,t,e),o=getPointResolution(t,o,n),n=t.getMetersPerUnit(),t=(void 0!==n&&(o*=n),e.getMetersPerUnit()),n=(void 0!==t&&(o/=t),e.getExtent());return n&&!containsCoordinate(n,r)||(t=getPointResolution(e,o,r)/o,isFinite(t)&&0<t&&(o/=t)),o}function enlargeClipPoint(e,t,n,o){var e=n-e,t=o-t,r=Math.sqrt(e*e+t*t);return[Math.round(n+e/r),Math.round(o+t/r)]}function render(e,t,d,f,n,v,o,r,a,s,i){var p=createCanvasContext2D(Math.round(d*e),Math.round(d*t));if(0===a.length)return p.canvas;p.scale(d,d);var x=createEmpty(),e=(a.forEach(function(e,t,n){extend(x,e.extent)}),getWidth(x)),t=getHeight(x),C=createCanvasContext2D(Math.round(d*e/f),Math.round(d*t/f)),g=d/f,P=(a.forEach(function(e,t,n){var o=e.extent[0]-x[0],r=-(e.extent[3]-x[3]),a=getWidth(e.extent),i=getHeight(e.extent);C.drawImage(e.image,s,s,e.image.width-2*s,e.image.height-2*s,o*g,r*g,a*g,i*g)}),getTopLeft(o));return r.getTriangles().forEach(function(e,t,n){var o=e.source,e=e.target,r=o[0][0],a=o[0][1],i=o[1][0],s=o[1][1],g=o[2][0],o=o[2][1],l=(e[0][0]-P[0])/v,c=-(e[0][1]-P[1])/v,u=(e[1][0]-P[0])/v,h=-(e[1][1]-P[1])/v,m=(e[2][0]-P[0])/v,e=-(e[2][1]-P[1])/v,i=[[i-=r,s-=a,0,0,u-l],[g-=r,o-=a,0,0,m-l],[0,0,i,s,h-c],[0,0,g,o,e-c]],s=solveLinearSystem(i);s&&(p.save(),p.beginPath(),i=enlargeClipPoint(g=(l+u+m)/3,o=(c+h+e)/3,l,c),u=enlargeClipPoint(g,o,u,h),h=enlargeClipPoint(g,o,m,e),p.moveTo(u[0],u[1]),p.lineTo(i[0],i[1]),p.lineTo(h[0],h[1]),p.clip(),p.transform(s[0],s[2],s[1],s[3],l,c),p.translate(x[0]-r,x[3]-a),p.scale(f/d,-f/d),p.drawImage(C.canvas,0,0),p.restore())}),i&&(p.save(),p.strokeStyle="black",p.lineWidth=1,r.getTriangles().forEach(function(e,t,n){var e=e.target,o=(e[0][0]-P[0])/v,r=-(e[0][1]-P[1])/v,a=(e[1][0]-P[0])/v,i=-(e[1][1]-P[1])/v,s=(e[2][0]-P[0])/v,e=-(e[2][1]-P[1])/v;p.beginPath(),p.moveTo(a,i),p.lineTo(o,r),p.lineTo(s,e),p.closePath(),p.stroke()}),p.restore()),p.canvas}export{calculateSourceResolution,render};