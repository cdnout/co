var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(t,e)};return function(t,e){function a(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}}();import VectorLayer from"./Vector.js";import{assign}from"../obj.js";import{degreesToStringHDMS}from"../coordinate.js";import Text from"../style/Text.js";import Fill from"../style/Fill.js";import Stroke from"../style/Stroke.js";import LineString from"../geom/LineString.js";import VectorSource from"../source/Vector.js";import{equivalent as equivalentProjection,get as getProjection,getTransform,transformExtent}from"../proj.js";import{getCenter,intersects,equals,getIntersection,isEmpty}from"../extent.js";import{clamp}from"../math.js";import Style from"../style/Style.js";import Feature from"../Feature.js";import{bbox}from"../loadingstrategy.js";import{meridian,parallel}from"../geom/flat/geodesic.js";import GeometryLayout from"../geom/GeometryLayout.js";import Point from"../geom/Point.js";import Collection from"../Collection.js";var DEFAULT_STROKE_STYLE=new Stroke({color:"rgba(0,0,0,0.2)"}),INTERVALS=[90,45,30,20,10,5,2,1,.5,.2,.1,.05,.01,.005,.002,.001],Graticule=function(i){function t(t){var e=this,a=t||{},t=assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},a);return delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,(e=i.call(this,t)||this).projection_=null,e.maxLat_=1/0,e.maxLon_=1/0,e.minLat_=-1/0,e.minLon_=-1/0,e.maxLatP_=1/0,e.maxLonP_=1/0,e.minLatP_=-1/0,e.minLonP_=-1/0,e.targetSize_=void 0!==a.targetSize?a.targetSize:100,e.maxLines_=void 0!==a.maxLines?a.maxLines:100,e.meridians_=[],e.parallels_=[],e.strokeStyle_=void 0!==a.strokeStyle?a.strokeStyle:DEFAULT_STROKE_STYLE,e.fromLonLatTransform_=void 0,e.toLonLatTransform_=void 0,e.projectionCenterLonLat_=null,e.meridiansLabels_=null,e.parallelsLabels_=null,a.showLabels&&(e.lonLabelFormatter_=null==a.lonLabelFormatter?degreesToStringHDMS.bind(e,"EW"):a.lonLabelFormatter,e.latLabelFormatter_=null==a.latLabelFormatter?degreesToStringHDMS.bind(e,"NS"):a.latLabelFormatter,e.lonLabelPosition_=null==a.lonLabelPosition?0:a.lonLabelPosition,e.latLabelPosition_=null==a.latLabelPosition?1:a.latLabelPosition,e.lonLabelStyleCache_={},e.lonLabelStyle_=function(t){t=t.get("graticule_label");return this.lonLabelStyleCache_[t]||(this.lonLabelStyleCache_[t]=new Style({text:void 0!==a.lonLabelStyle?a.lonLabelStyle:new Text({text:t,font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Fill({color:"rgba(0,0,0,1)"}),stroke:new Stroke({color:"rgba(255,255,255,1)",width:3})})})),this.lonLabelStyleCache_[t]}.bind(e),e.latLabelStyleCache_={},e.latLabelStyle_=function(t){t=t.get("graticule_label");return this.latLabelStyleCache_[t]||(this.latLabelStyleCache_[t]=new Style({text:void 0!==a.latLabelStyle?a.latLabelStyle:new Text({text:t,font:"12px Calibri,sans-serif",textAlign:"right",fill:new Fill({color:"rgba(0,0,0,1)"}),stroke:new Stroke({color:"rgba(255,255,255,1)",width:3})})})),this.latLabelStyleCache_[t]}.bind(e),e.meridiansLabels_=[],e.parallelsLabels_=[]),e.intervals_=void 0!==a.intervals?a.intervals:INTERVALS,e.setSource(new VectorSource({loader:e.loaderFunction.bind(e),strategy:bbox,features:new Collection,overlaps:!1,useSpatialIndex:!1,wrapX:a.wrapX})),e.featurePool_=[],e.lineStyle_=new Style({stroke:e.strokeStyle_}),e.renderedExtent_=null,e.setRenderOrder(null),e.tmpExtent_=null,e}return __extends(t,i),t.prototype.loaderFunction=function(t,e,a){var i=this.getSource(),r=this.getExtent()||[-1/0,-1/0,1/0,1/0],r=getIntersection(r,t,this.tmpExtent_);if(setTimeout(function(){i.removeLoadedExtent(t)},0),!(this.renderedExtent_&&equals(this.renderedExtent_,r)||(this.renderedExtent_=r,isEmpty(r)))){var l,o=getCenter(r),n=e*e/4,s=((!this.projection_||!equivalentProjection(this.projection_,a))&&this.updateProjectionInfo_(a),this.createGraticule_(r,o,e,n),this.meridians_.length+this.parallels_.length);for(this.meridiansLabels_&&(s+=this.meridiansLabels_.length),this.parallelsLabels_&&(s+=this.parallelsLabels_.length);s>this.featurePool_.length;)l=new Feature,this.featurePool_.push(l);for(var h,_=i.getFeaturesCollection(),m=(_.clear(),0),L=0,p=this.meridians_.length;L<p;++L)(l=this.featurePool_[m++]).setGeometry(this.meridians_[L]),l.setStyle(this.lineStyle_),_.push(l);for(L=0,p=this.parallels_.length;L<p;++L)(l=this.featurePool_[m++]).setGeometry(this.parallels_[L]),l.setStyle(this.lineStyle_),_.push(l);if(this.meridiansLabels_)for(L=0,p=this.meridiansLabels_.length;L<p;++L)h=this.meridiansLabels_[L],(l=this.featurePool_[m++]).setGeometry(h.geom),l.setStyle(this.lonLabelStyle_),l.set("graticule_label",h.text),_.push(l);if(this.parallelsLabels_)for(L=0,p=this.parallelsLabels_.length;L<p;++L)h=this.parallelsLabels_[L],(l=this.featurePool_[m++]).setGeometry(h.geom),l.setStyle(this.latLabelStyle_),l.set("graticule_label",h.text),_.push(l)}},t.prototype.addMeridian_=function(t,e,a,i,r,l){e=this.getMeridian_(t,e,a,i,l);return intersects(e.getExtent(),r)&&(this.meridiansLabels_&&(a=this.getMeridianPoint_(e,r,l),this.meridiansLabels_[l]={geom:a,text:this.lonLabelFormatter_(t)}),this.meridians_[l++]=e),l},t.prototype.addParallel_=function(t,e,a,i,r,l){e=this.getParallel_(t,e,a,i,l);return intersects(e.getExtent(),r)&&(this.parallelsLabels_&&(a=this.getParallelPoint_(e,r,l),this.parallelsLabels_[l]={geom:a,text:this.latLabelFormatter_(t)}),this.parallels_[l++]=e),l},t.prototype.createGraticule_=function(t,e,a,i){var r=this.getInterval_(a);if(-1==r)return this.meridians_.length=this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),void(this.parallelsLabels_&&(this.parallelsLabels_.length=0));for(var l,a=this.toLonLatTransform_(e),e=a[0],a=a[1],o=this.maxLines_,n=[Math.max(t[0],this.minLonP_),Math.max(t[1],this.minLatP_),Math.min(t[2],this.maxLonP_),Math.min(t[3],this.maxLatP_)],s=(n=transformExtent(n,this.projection_,"EPSG:4326"))[3],h=n[2],_=n[1],m=n[0],e=Math.floor(e/r)*r,L=clamp(e,this.minLon_,this.maxLon_),p=this.addMeridian_(L,_,s,i,t,0),d=0;L!=this.minLon_&&d++<o;)L=Math.max(L-r,this.minLon_),p=this.addMeridian_(L,_,s,i,t,p);for(L=clamp(e,this.minLon_,this.maxLon_),d=0;L!=this.maxLon_&&d++<o;)L=Math.min(L+r,this.maxLon_),p=this.addMeridian_(L,_,s,i,t,p);for(this.meridians_.length=p,this.meridiansLabels_&&(this.meridiansLabels_.length=p),a=Math.floor(a/r)*r,l=clamp(a,this.minLat_,this.maxLat_),p=this.addParallel_(l,m,h,i,t,0),d=0;l!=this.minLat_&&d++<o;)l=Math.max(l-r,this.minLat_),p=this.addParallel_(l,m,h,i,t,p);for(l=clamp(a,this.minLat_,this.maxLat_),d=0;l!=this.maxLat_&&d++<o;)l=Math.min(l+r,this.maxLat_),p=this.addParallel_(l,m,h,i,t,p);this.parallels_.length=p,this.parallelsLabels_&&(this.parallelsLabels_.length=p)},t.prototype.getInterval_=function(t){for(var e=this.projectionCenterLonLat_[0],a=this.projectionCenterLonLat_[1],i=-1,r=Math.pow(this.targetSize_*t,2),l=[],o=[],n=0,s=this.intervals_.length;n<s;++n){var h=this.intervals_[n]/2;if(l[0]=e-h,l[1]=a-h,o[0]=e+h,o[1]=a+h,this.fromLonLatTransform_(l,l),this.fromLonLatTransform_(o,o),Math.pow(o[0]-l[0],2)+Math.pow(o[1]-l[1],2)<=r)break;i=this.intervals_[n]}return i},t.prototype.getMeridian_=function(t,e,a,i,r){t=meridian(t,e,a,this.projection_,i),e=this.meridians_[r];return e?(e.setFlatCoordinates(GeometryLayout.XY,t),e.changed()):e=this.meridians_[r]=new LineString(t,GeometryLayout.XY),e},t.prototype.getMeridianPoint_=function(t,e,a){var i,t=t.getFlatCoordinates(),r=Math.max(e[1],t[1]),l=Math.min(e[3],t[t.length-1]),e=clamp(e[1]+Math.abs(e[1]-e[3])*this.lonLabelPosition_,r,l),r=[t[0],e];return a in this.meridiansLabels_?(i=this.meridiansLabels_[a].geom).setCoordinates(r):i=new Point(r),i},t.prototype.getMeridians=function(){return this.meridians_},t.prototype.getParallel_=function(t,e,a,i,r){t=parallel(t,e,a,this.projection_,i),e=this.parallels_[r];return e?(e.setFlatCoordinates(GeometryLayout.XY,t),e.changed()):e=new LineString(t,GeometryLayout.XY),e},t.prototype.getParallelPoint_=function(t,e,a){var i,t=t.getFlatCoordinates(),r=Math.max(e[0],t[0]),l=Math.min(e[2],t[t.length-2]),e=[clamp(e[0]+Math.abs(e[0]-e[2])*this.latLabelPosition_,r,l),t[1]];return a in this.parallelsLabels_?(i=this.parallelsLabels_[a].geom).setCoordinates(e):i=new Point(e),i},t.prototype.getParallels=function(){return this.parallels_},t.prototype.updateProjectionInfo_=function(t){var e=getProjection("EPSG:4326"),a=t.getWorldExtent(),i=transformExtent(a,e,t);this.maxLat_=a[3],this.maxLon_=a[2],this.minLat_=a[1],this.minLon_=a[0],this.maxLatP_=i[3],this.maxLonP_=i[2],this.minLatP_=i[1],this.minLonP_=i[0],this.fromLonLatTransform_=getTransform(e,t),this.toLonLatTransform_=getTransform(t,e),this.projectionCenterLonLat_=this.toLonLatTransform_(getCenter(t.getExtent())),this.projection_=t},t}(VectorLayer);export default Graticule;