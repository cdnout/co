var __extends=this&&this.__extends||function(){var o=function(e,r){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};return function(e,r){function t(){this.constructor=e}o(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}}();import{numberSafeCompareFunction}from"../../array.js";import{createCanvasContext2D}from"../../dom.js";import{buffer,createEmpty,extendCoordinate}from"../../extent.js";import{transform2D}from"../../geom/flat/transform.js";import{isEmpty}from"../../obj.js";import BuilderType from"./BuilderType.js";import{create as createTransform,compose as composeTransform}from"../../transform.js";import Executor from"./Executor.js";import Disposable from"../../Disposable.js";var ORDER=[BuilderType.POLYGON,BuilderType.CIRCLE,BuilderType.LINE_STRING,BuilderType.IMAGE,BuilderType.TEXT,BuilderType.DEFAULT],ExecutorGroup=function(c){function e(e,r,t,o,i,n){var a=c.call(this)||this;return a.maxExtent_=e,a.overlaps_=o,a.pixelRatio_=t,a.resolution_=r,a.renderBuffer_=n,a.executorsByZIndex_={},a.hitDetectionContext_=null,a.hitDetectionTransform_=createTransform(),a.createExecutors_(i),a}return __extends(e,c),e.prototype.clip=function(e,r){r=this.getClipCoords(r);e.beginPath(),e.moveTo(r[0],r[1]),e.lineTo(r[2],r[3]),e.lineTo(r[4],r[5]),e.lineTo(r[6],r[7]),e.clip()},e.prototype.createExecutors_=function(e){for(var r in e){var t,o=this.executorsByZIndex_[r],i=(void 0===o&&(this.executorsByZIndex_[r]=o={}),e[r]);for(t in i){var n=i[t];o[t]=new Executor(this.resolution_,this.pixelRatio_,this.overlaps_,n)}}},e.prototype.disposeInternal=function(){for(var e in this.executorsByZIndex_){var r,t=this.executorsByZIndex_[e];for(r in t)t[r].disposeInternal()}var o;this.hitDetectionContext_&&((o=this.hitDetectionContext_.canvas).width=o.height=0),c.prototype.disposeInternal.call(this)},e.prototype.hasExecutors=function(e){for(var r in this.executorsByZIndex_)for(var t=this.executorsByZIndex_[r],o=0,i=e.length;o<i;++o)if(e[o]in t)return!0;return!1},e.prototype.forEachFeatureAtCoordinate=function(e,r,t,o,n,a){var i,c,s=2*(o=Math.round(o))+1,l=composeTransform(this.hitDetectionTransform_,o+.5,o+.5,1/r,-1/r,-t,-e[0],-e[1]),u=(this.hitDetectionContext_||(this.hitDetectionContext_=createCanvasContext2D(s,s)),this.hitDetectionContext_),f=(u.canvas.width!==s||u.canvas.height!==s?(u.canvas.width=s,u.canvas.height=s):u.clearRect(0,0,s,s),void 0!==this.renderBuffer_&&(i=createEmpty(),extendCoordinate(i,e),buffer(i,r*(this.renderBuffer_+o),i)),getCircleArray(o));function p(e){for(var r=u.getImageData(0,0,s,s).data,t=0;t<s;t++)for(var o,i=0;i<s;i++)if(f[t][i])if(0<r[4*(i*s+t)+3])return o=void 0,(o=a&&(c==BuilderType.IMAGE||c==BuilderType.TEXT)&&-1===a.indexOf(e)?o:n(e))||void u.clearRect(0,0,s,s)}var d,h,y=Object.keys(this.executorsByZIndex_).map(Number);for(y.sort(numberSafeCompareFunction),d=y.length-1;0<=d;--d)for(var x=y[d].toString(),m=this.executorsByZIndex_[x],_=ORDER.length-1;0<=_;--_)if(void 0!==(h=m[c=ORDER[_]])&&(h=h.executeHitDetection(u,l,t,p,i)))return h},e.prototype.getClipCoords=function(e){var r=this.maxExtent_;if(!r)return null;var t=r[0],o=r[1],i=r[2],r=r[3],t=[t,o,t,r,i,r,i,o];return transform2D(t,0,8,2,e,t),t},e.prototype.isEmpty=function(){return isEmpty(this.executorsByZIndex_)},e.prototype.execute=function(e,r,t,o,i,n){for(var a=Object.keys(this.executorsByZIndex_).map(Number),c=(a.sort(numberSafeCompareFunction),this.maxExtent_&&(e.save(),this.clip(e,r)),i||ORDER),s=0,l=a.length;s<l;++s)for(var u=a[s].toString(),f=this.executorsByZIndex_[u],p=0,d=c.length;p<d;++p){var h,y=c[p];void 0!==(h=f[y])&&(!n||y!=BuilderType.IMAGE&&y!=BuilderType.TEXT?h.execute(e,r,t,o):(y=n[u])?y.push(h,r.slice(0)):n[u]=[h,r.slice(0)])}this.maxExtent_&&e.restore()},e}(Disposable),circleArrayCache={0:[[!0]]};function fillCircleArrayRowToMiddle(e,r,t){var o,i=Math.floor(e.length/2);if(i<=r)for(o=i;o<r;o++)e[o][t]=!0;else if(r<i)for(o=r+1;o<i;o++)e[o][t]=!0}function getCircleArray(e){if(void 0!==circleArrayCache[e])return circleArrayCache[e];for(var r=2*e+1,t=new Array(r),o=0;o<r;o++)t[o]=new Array(r);for(var i=e,n=0,a=0;n<=i;)fillCircleArrayRowToMiddle(t,e+i,e+n),fillCircleArrayRowToMiddle(t,e+n,e+i),fillCircleArrayRowToMiddle(t,e-n,e+i),fillCircleArrayRowToMiddle(t,e-i,e+n),fillCircleArrayRowToMiddle(t,e-i,e-n),fillCircleArrayRowToMiddle(t,e-n,e-i),fillCircleArrayRowToMiddle(t,e+n,e-i),fillCircleArrayRowToMiddle(t,e+i,e-n),0<2*((a+=1+2*++n)-i)+1&&(a+=1-2*--i);return circleArrayCache[e]=t}function replayDeclutter(e,r,t,o,i,n){for(var a=Object.keys(e).map(Number).sort(numberSafeCompareFunction),c=0,s=a.length;c<s;++c)for(var l=e[a[c].toString()],u=void 0,f=0,p=l.length;f<p;){var d=l[f++],h=(d!==u&&n.push({items:(u=d).declutterItems,opacity:o}),l[f++]);d.execute(r,h,t,i)}}export default ExecutorGroup;export{getCircleArray,replayDeclutter};