var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import{equals,reverseSubArray}from"../../array.js";import{asColorLike}from"../../colorlike.js";import{buffer,clone,coordinateRelationship}from"../../extent.js";import Relationship from"../../extent/Relationship.js";import GeometryType from"../../geom/GeometryType.js";import{inflateCoordinates,inflateCoordinatesArray,inflateMultiCoordinatesArray}from"../../geom/flat/inflate.js";import VectorContext from"../VectorContext.js";import{defaultFillStyle,defaultStrokeStyle,defaultMiterLimit,defaultLineWidth,defaultLineJoin,defaultLineDashOffset,defaultLineDash,defaultLineCap}from"../canvas.js";import CanvasInstruction from"./Instruction.js";var CanvasBuilder=function(r){function t(t,e,i,n){var o=r.call(this)||this;return o.tolerance=t,o.maxExtent=e,o.pixelRatio=n,o.maxLineWidth=0,o.resolution=i,o.beginGeometryInstruction1_=null,o.beginGeometryInstruction2_=null,o.bufferedMaxExtent_=null,o.instructions=[],o.coordinates=[],o.tmpCoordinate_=[],o.hitDetectionInstructions=[],o.state={},o}return __extends(t,r),t.prototype.applyPixelRatio=function(t){var e=this.pixelRatio;return 1==e?t:t.map(function(t){return t*e})},t.prototype.appendFlatCoordinates=function(t,e,i,n,o,r){for(var s,a,u=this.coordinates.length,l=this.getBufferedMaxExtent(),h=(r&&(e+=n),t[e]),c=t[e+1],f=this.tmpCoordinate_,d=!0,p=e+n;p<i;p+=n)f[0]=t[p],f[1]=t[p+1],d=(a=coordinateRelationship(l,f))!==s?(d&&(this.coordinates[u++]=h,this.coordinates[u++]=c),this.coordinates[u++]=f[0],this.coordinates[u++]=f[1],!1):a!==Relationship.INTERSECTING||(this.coordinates[u++]=f[0],this.coordinates[u++]=f[1],!1),h=f[0],c=f[1],s=a;return(o&&d||p===e+n)&&(this.coordinates[u++]=h,this.coordinates[u++]=c),u},t.prototype.drawCustomCoordinates_=function(t,e,i,n,o){for(var r=0,s=i.length;r<s;++r){var a=i[r],u=this.appendFlatCoordinates(t,e,a,n,!1,!1);o.push(u),e=a}return e},t.prototype.drawCustom=function(t,e,i){this.beginGeometry(e);var n,o,r=t.getType(),s=t.getStride(),a=this.coordinates.length;if(r==GeometryType.MULTI_POLYGON){for(var u=t.getOrientedFlatCoordinates(),l=[],h=t.getEndss(),c=p=0,f=h.length;c<f;++c){var d=[],p=this.drawCustomCoordinates_(u,p,h[c],s,d);l.push(d)}this.instructions.push([CanvasInstruction.CUSTOM,a,l,t,i,inflateMultiCoordinatesArray])}else r==GeometryType.POLYGON||r==GeometryType.MULTI_LINE_STRING?(o=[],u=r==GeometryType.POLYGON?t.getOrientedFlatCoordinates():t.getFlatCoordinates(),p=this.drawCustomCoordinates_(u,0,t.getEnds(),s,o),this.instructions.push([CanvasInstruction.CUSTOM,a,o,t,i,inflateCoordinatesArray])):r==GeometryType.LINE_STRING||r==GeometryType.MULTI_POINT?(u=t.getFlatCoordinates(),n=this.appendFlatCoordinates(u,0,u.length,s,!1,!1),this.instructions.push([CanvasInstruction.CUSTOM,a,n,t,i,inflateCoordinates])):r==GeometryType.POINT&&(u=t.getFlatCoordinates(),this.coordinates.push(u[0],u[1]),n=this.coordinates.length,this.instructions.push([CanvasInstruction.CUSTOM,a,n,t,i]));this.endGeometry(e)},t.prototype.beginGeometry=function(t){this.beginGeometryInstruction1_=[CanvasInstruction.BEGIN_GEOMETRY,t,0],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[CanvasInstruction.BEGIN_GEOMETRY,t,0],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)},t.prototype.finish=function(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}},t.prototype.reverseHitDetectionInstructions=function(){for(var t,e,i=this.hitDetectionInstructions,n=(i.reverse(),i.length),o=-1,r=0;r<n;++r)(e=(t=i[r])[0])==CanvasInstruction.END_GEOMETRY?o=r:e==CanvasInstruction.BEGIN_GEOMETRY&&(t[2]=r,reverseSubArray(this.hitDetectionInstructions,o,r),o=-1)},t.prototype.setFillStrokeStyle=function(t,e){var i=this.state;t?(t=t.getColor(),i.fillStyle=asColorLike(t||defaultFillStyle)):i.fillStyle=void 0,e?(t=e.getColor(),i.strokeStyle=asColorLike(t||defaultStrokeStyle),t=e.getLineCap(),i.lineCap=void 0!==t?t:defaultLineCap,t=e.getLineDash(),i.lineDash=t?t.slice():defaultLineDash,t=e.getLineDashOffset(),i.lineDashOffset=t||defaultLineDashOffset,t=e.getLineJoin(),i.lineJoin=void 0!==t?t:defaultLineJoin,t=e.getWidth(),i.lineWidth=void 0!==t?t:defaultLineWidth,t=e.getMiterLimit(),i.miterLimit=void 0!==t?t:defaultMiterLimit,i.lineWidth>this.maxLineWidth&&(this.maxLineWidth=i.lineWidth,this.bufferedMaxExtent_=null)):(i.strokeStyle=void 0,i.lineCap=void 0,i.lineDash=null,i.lineDashOffset=void 0,i.lineJoin=void 0,i.lineWidth=void 0,i.miterLimit=void 0)},t.prototype.createFill=function(t){var t=t.fillStyle,e=[CanvasInstruction.SET_FILL_STYLE,t];return"string"!=typeof t&&e.push(!0),e},t.prototype.applyStroke=function(t){this.instructions.push(this.createStroke(t))},t.prototype.createStroke=function(t){return[CanvasInstruction.SET_STROKE_STYLE,t.strokeStyle,t.lineWidth*this.pixelRatio,t.lineCap,t.lineJoin,t.miterLimit,this.applyPixelRatio(t.lineDash),t.lineDashOffset*this.pixelRatio]},t.prototype.updateFillStyle=function(t,e){var i=t.fillStyle;"string"==typeof i&&t.currentFillStyle==i||(void 0!==i&&this.instructions.push(e.call(this,t)),t.currentFillStyle=i)},t.prototype.updateStrokeStyle=function(t,e){var i=t.strokeStyle,n=t.lineCap,o=t.lineDash,r=t.lineDashOffset,s=t.lineJoin,a=t.lineWidth,u=t.miterLimit;t.currentStrokeStyle==i&&t.currentLineCap==n&&(o==t.currentLineDash||equals(t.currentLineDash,o))&&t.currentLineDashOffset==r&&t.currentLineJoin==s&&t.currentLineWidth==a&&t.currentMiterLimit==u||(void 0!==i&&e.call(this,t),t.currentStrokeStyle=i,t.currentLineCap=n,t.currentLineDash=o,t.currentLineDashOffset=r,t.currentLineJoin=s,t.currentLineWidth=a,t.currentMiterLimit=u)},t.prototype.endGeometry=function(t){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;t=[CanvasInstruction.END_GEOMETRY,t];this.instructions.push(t),this.hitDetectionInstructions.push(t)},t.prototype.getBufferedMaxExtent=function(){var t;return this.bufferedMaxExtent_||(this.bufferedMaxExtent_=clone(this.maxExtent),0<this.maxLineWidth&&(t=this.resolution*(this.maxLineWidth+1)/2,buffer(this.bufferedMaxExtent_,t,this.bufferedMaxExtent_))),this.bufferedMaxExtent_},t}(VectorContext);export default CanvasBuilder;