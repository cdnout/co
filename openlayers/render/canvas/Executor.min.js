var __extends=this&&this.__extends||function(){var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import{equals}from"../../array.js";import{createEmpty,createOrUpdate,createOrUpdateEmpty,extend,intersects}from"../../extent.js";import{lineStringLength}from"../../geom/flat/length.js";import{drawTextOnPath}from"../../geom/flat/textpath.js";import{transform2D}from"../../geom/flat/transform.js";import{drawImage,defaultPadding,defaultTextBaseline}from"../canvas.js";import CanvasInstruction from"./Instruction.js";import{TEXT_ALIGN}from"./TextBuilder.js";import{create as createTransform,compose as composeTransform,apply as applyTransform,setFromArray as transformSetFromArray}from"../../transform.js";import{createCanvasContext2D}from"../../dom.js";import{labelCache,defaultTextAlign,measureTextHeight,measureAndCacheTextWidth,measureTextWidths}from"../canvas.js";import Disposable from"../../Disposable.js";import RBush from"rbush";var tmpExtent=createEmpty(),tmpTransform=createTransform(),p1=[],p2=[],p3=[],p4=[],Executor=function(r){function t(t,e,i,a){var n=r.call(this)||this;return n.overlaps=i,n.pixelRatio=e,n.resolution=t,n.alignFill_,n.declutterItems=[],n.instructions=a.instructions,n.coordinates=a.coordinates,n.coordinateCache_={},n.renderedTransform_=createTransform(),n.hitDetectionInstructions=a.hitDetectionInstructions,n.pixelCoordinates_=null,n.viewRotation_=0,n.fillStates=a.fillStates||{},n.strokeStates=a.strokeStates||{},n.textStates=a.textStates||{},n.widths_={},n}return __extends(t,r),t.prototype.disposeInternal=function(){labelCache.release(this),r.prototype.disposeInternal.call(this)},t.prototype.getTextImage=function(t,e,i,a){var n=a+e+t+i+this.pixelRatio;if(!labelCache.containsKey(n)){var r=a?this.strokeStates[a]:null,s=i?this.fillStates[i]:null,e=this.textStates[e],o=this.pixelRatio,o=e.scale*o,l=TEXT_ALIGN[e.textAlign||defaultTextAlign],h=a&&r.lineWidth?r.lineWidth:0,p=t.split("\n"),c=p.length,m=[],t=measureTextWidths(e.font,p,m),f=measureTextHeight(e.font),u=f*c,t=t+h,d=createCanvasContext2D(Math.ceil((t+2)*o),Math.ceil((u+h)*o)),u=d.canvas,x=(labelCache.set(n,u),1!=o&&d.scale(o,o),d.font=e.font,a&&(d.strokeStyle=r.strokeStyle,d.lineWidth=h,d.lineCap=r.lineCap,d.lineJoin=r.lineJoin,d.miterLimit=r.miterLimit,d.setLineDash&&r.lineDash.length&&(d.setLineDash(r.lineDash),d.lineDashOffset=r.lineDashOffset)),i&&(d.fillStyle=s.fillStyle),d.textBaseline="middle",d.textAlign="center",.5-l),g=l*t+x*h,_=void 0;if(a)for(_=0;_<c;++_)d.strokeText(p[_],g+x*m[_],.5*(h+f)+_*f);if(i)for(_=0;_<c;++_)d.fillText(p[_],g+x*m[_],.5*(h+f)+_*f)}return labelCache.get(n,this)},t.prototype.replayTextBackground_=function(t,e,i,a,n,r,s){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,i),t.lineTo.apply(t,a),t.lineTo.apply(t,n),t.lineTo.apply(t,e),r&&(this.alignFill_=r[2],this.fill_(t)),s&&(this.setStrokeStyle_(t,s),t.stroke())},t.prototype.replayImage_=function(t,e,i,a,n,r,s,o,l,h,p,c,m,f,u,d,x,g){var _=x||g,u=u+h>a.width?a.width-h:u,o=o+p>a.height?a.height-p:o,T=d[3]+u*m+d[1],v=d[0]+o*m+d[2],y=(e-=n*=m)-d[3],d=(i-=r*=m)-d[0],I=(!_&&0===c||(p1[0]=p4[0]=y,p1[1]=p2[1]=d,p2[0]=p3[0]=y+T,p3[1]=p4[1]=d+v),null),c=(0!==c?(I=composeTransform(tmpTransform,n=e+n,r=i+r,1,1,c,-n,-r),applyTransform(tmpTransform,p1),applyTransform(tmpTransform,p2),applyTransform(tmpTransform,p3),applyTransform(tmpTransform,p4),createOrUpdate(Math.min(p1[0],p2[0],p3[0],p4[0]),Math.min(p1[1],p2[1],p3[1],p4[1]),Math.max(p1[0],p2[0],p3[0],p4[0]),Math.max(p1[1],p2[1],p3[1],p4[1]),tmpExtent)):createOrUpdate(y,d,y+T,d+v,tmpExtent),t.canvas),n=g?g[2]*m/2:0,r=tmpExtent[0]-n<=c.width&&0<=tmpExtent[2]+n&&tmpExtent[1]-n<=c.height&&0<=tmpExtent[3]+n;f&&(e=Math.round(e),i=Math.round(i)),s?!r&&1==s[4]||(extend(s,tmpExtent),(y=r?[t,I?I.slice(0):null,l,a,h,p,u,o,e,i,m]:null)&&(_&&y.push(x,g,p1,p2,p3,p4),s.push(y))):r&&(_&&this.replayTextBackground_(t,p1,p2,p3,p4,x,g),drawImage(t,I,l,a,h,p,u,o,e,i,m))},t.prototype.fill_=function(t){var e,i;this.alignFill_&&(e=applyTransform(this.renderedTransform_,[0,0]),i=512*this.pixelRatio,t.save(),t.translate(e[0]%i,e[1]%i),t.rotate(this.viewRotation_)),t.fill(),this.alignFill_&&t.restore()},t.prototype.setStrokeStyle_=function(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.setLineDash&&(t.lineDashOffset=e[7],t.setLineDash(e[6]))},t.prototype.renderDeclutter=function(t,e,i,a){if(t&&5<t.length){var n=t[4];if(1==n||n==t.length-5){n={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3],value:e};if(!(a=a||new RBush(9)).collides(n)){a.insert(n);for(var r=5,s=t.length;r<s;++r){var o=t[r],l=o[0],h=l.globalAlpha;h!==i&&(l.globalAlpha=i),11<o.length&&this.replayTextBackground_(o[0],o[13],o[14],o[15],o[16],o[11],o[12]),drawImage.apply(void 0,o),h!==i&&(l.globalAlpha=h)}}t.length=5,createOrUpdateEmpty(t)}}return a},t.prototype.drawTextImageWithPointPlacement_=function(t,e,i,a){var n=this.textStates[e],t=this.getTextImage(t,e,a,i),e=this.strokeStates[i],a=this.pixelRatio,i=TEXT_ALIGN[n.textAlign||defaultTextAlign],r=TEXT_ALIGN[n.textBaseline||defaultTextBaseline],e=e&&e.lineWidth?e.lineWidth:0;return{label:t,anchorX:i*(t.width/a-2*n.scale)+2*(.5-i)*e,anchorY:r*t.height/a+2*(.5-r)*e}},t.prototype.execute_=function(t,W,j,B,e,G){this.declutterItems.length=0,this.pixelCoordinates_&&equals(W,this.renderedTransform_)?i=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),i=transform2D(this.coordinates,0,this.coordinates.length,2,W,this.pixelCoordinates_),transformSetFromArray(this.renderedTransform_,W));for(var i,a,n,r,s,o,l,h=0,N=j.length,p=0,c=0,m=0,F=null,X=null,Y=this.coordinateCache_,H=this.viewRotation_,U={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:H},f=this.instructions!=j||this.overlaps?0:200;h<N;){var u=j[h];switch(u[0]){case CanvasInstruction.BEGIN_GEOMETRY:M=u[1],void 0===G||intersects(G,M.getGeometry().getExtent())?++h:h=u[2]+1;break;case CanvasInstruction.BEGIN_PATH:f<c&&(this.fill_(t),c=0),f<m&&(t.stroke(),m=0),c||m||(t.beginPath(),a=n=NaN),++h;break;case CanvasInstruction.CIRCLE:var d=i[p=u[1]],x=i[p+1],g=i[p+2]-d,q=i[p+3]-x,g=Math.sqrt(g*g+q*q);t.moveTo(d+g,x),t.arc(d,x,g,0,2*Math.PI,!0),++h;break;case CanvasInstruction.CLOSE_PATH:t.closePath(),++h;break;case CanvasInstruction.CUSTOM:p=u[1];var _=u[2],q=u[3],d=u[4],x=6==u.length?u[5]:void 0,g=(U.geometry=q,U.feature=M,h in Y||(Y[h]=[]),Y[h]);x?x(i,p,_,2,g):(g[0]=i[p],g[1]=i[p+1],g.length=2),d(g,U),++h;break;case CanvasInstruction.DRAW_IMAGE:p=u[1],_=u[2],C=u[3],E=u[4],S=u[5];for(var T,v,y,I,C,E,S,J,k=e?null:u[6],K=u[7],V=u[8],z=u[9],Q=u[10],Z=u[11],$=u[12],tt=u[13],et=u[14],it=(!C&&19<=u.length&&(T=u[18],v=u[19],y=u[20],I=u[21],b=this.drawTextImageWithPointPlacement_(T,v,y,I),C=u[3]=b.label,A=u[22],E=u[4]=(b.anchorX-A)*this.pixelRatio,A=u[23],S=u[5]=(b.anchorY-A)*this.pixelRatio,K=u[7]=C.height,et=u[14]=C.width),void 0),at=(24<u.length&&(it=u[24]),void 0),nt=void 0,rt=void 0,st=(16<u.length?(at=u[15],nt=u[16],rt=u[17]):(at=defaultPadding,nt=rt=!1),Z&&($+=H),0),ot=0;p<_;p+=2)it&&it[st++]<et/this.pixelRatio||(k&&(J=Math.floor(ot),k.length<J+1&&((w=createEmpty()).push(k[0][4]),k.push(w)),w=k[J]),this.replayImage_(t,i[p],i[p+1],C,E,S,w,K,V,z,Q,$,tt,B,et,at,nt?F:null,rt?X:null),w&&(ot===Math.floor(ot)&&this.declutterItems.push(this,w,M),ot+=1/w[4]));++h;break;case CanvasInstruction.DRAW_CHARS:var b=u[1],A=u[2],lt=u[3],w=e?null:u[4],Z=u[5],ht=(I=u[6],u[7]),pt=u[8],ct=u[9],mt=(y=u[10],u[11]),ft=(T=u[12],v=u[13],u[14]),ut=this.textStates[v],R=ut.font,ut=ut.scale*pt,pt=void 0,pt=R in this.widths_?this.widths_[R]:this.widths_[R]={},dt=lineStringLength(i,b,A,2),xt=ut*measureAndCacheTextWidth(R,T,pt);if(Z||xt<=dt){var gt=this.textStates[v].textAlign,dt=(dt-xt)*TEXT_ALIGN[gt],D=drawTextOnPath(i,b,A,2,T,dt,ht,ut,measureAndCacheTextWidth,R,pt);if(D){var L=void 0,_t=void 0,Tt=void 0,O=void 0,P=void 0;if(y)for(L=0,_t=D.length;L<_t;++L)Tt=(P=D[L])[4],O=this.getTextImage(Tt,v,"",y),E=P[2]+mt,S=lt*O.height+2*(.5-lt)*mt-ct,this.replayImage_(t,P[0],P[1],O,E,S,w,O.height,1,0,0,P[3],ft,!1,O.width,defaultPadding,null,null);if(I)for(L=0,_t=D.length;L<_t;++L)Tt=(P=D[L])[4],O=this.getTextImage(Tt,v,I,""),E=P[2],S=lt*O.height-ct,this.replayImage_(t,P[0],P[1],O,E,S,w,O.height,1,0,0,P[3],ft,!1,O.width,defaultPadding,null,null)}}this.declutterItems.push(this,w,M),++h;break;case CanvasInstruction.END_GEOMETRY:if(void 0!==e){var M,xt=e(M=u[1]);if(xt)return xt}++h;break;case CanvasInstruction.FILL:f?c++:this.fill_(t),++h;break;case CanvasInstruction.MOVE_TO_LINE_TO:for(p=u[1],_=u[2],o=i[p],s=(l=i[p+1])+.5|0,(r=o+.5|0)===a&&s===n||(t.moveTo(o,l),a=r,n=s),p+=2;p<_;p+=2)r=(o=i[p])+.5|0,s=(l=i[p+1])+.5|0,p!=_-2&&r===a&&s===n||(t.lineTo(o,l),a=r,n=s);++h;break;case CanvasInstruction.SET_FILL_STYLE:this.alignFill_=(F=u)[2],c&&(this.fill_(t),c=0,m&&(t.stroke(),m=0)),t.fillStyle=u[1],++h;break;case CanvasInstruction.SET_STROKE_STYLE:X=u,m&&(t.stroke(),m=0),this.setStrokeStyle_(t,u),++h;break;case CanvasInstruction.STROKE:f?m++:t.stroke(),++h;break;default:++h}}c&&this.fill_(t),m&&t.stroke()},t.prototype.execute=function(t,e,i,a){this.viewRotation_=i,this.execute_(t,e,this.instructions,a,void 0,void 0)},t.prototype.executeHitDetection=function(t,e,i,a,n){return this.viewRotation_=i,this.execute_(t,e,this.hitDetectionInstructions,!0,a,n)},t}(Disposable);export default Executor;