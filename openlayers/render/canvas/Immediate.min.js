var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import{equals}from"../../array.js";import{asColorLike}from"../../colorlike.js";import{intersects}from"../../extent.js";import GeometryType from"../../geom/GeometryType.js";import{transformGeom2D}from"../../geom/SimpleGeometry.js";import{transform2D}from"../../geom/flat/transform.js";import VectorContext from"../VectorContext.js";import{defaultTextAlign,defaultFillStyle,defaultLineCap,defaultLineDash,defaultLineDashOffset,defaultLineJoin,defaultLineWidth,defaultMiterLimit,defaultStrokeStyle,defaultTextBaseline,defaultFont}from"../canvas.js";import{create as createTransform,compose as composeTransform}from"../../transform.js";var CanvasImmediateRenderer=function(n){function t(t,e,i,o,a){var s=n.call(this)||this;return s.context_=t,s.pixelRatio_=e,s.extent_=i,s.transform_=o,s.viewRotation_=a,s.contextFillState_=null,s.contextStrokeState_=null,s.contextTextState_=null,s.fillState_=null,s.strokeState_=null,s.image_=null,s.imageAnchorX_=0,s.imageAnchorY_=0,s.imageHeight_=0,s.imageOpacity_=0,s.imageOriginX_=0,s.imageOriginY_=0,s.imageRotateWithView_=!1,s.imageRotation_=0,s.imageScale_=0,s.imageWidth_=0,s.text_="",s.textOffsetX_=0,s.textOffsetY_=0,s.textRotateWithView_=!1,s.textRotation_=0,s.textScale_=0,s.textFillState_=null,s.textStrokeState_=null,s.textState_=null,s.pixelCoordinates_=[],s.tmpLocalTransform_=createTransform(),s}return __extends(t,n),t.prototype.drawImages_=function(t,e,i,o){if(this.image_){var a=transform2D(t,e,i,2,this.transform_,this.pixelCoordinates_),s=this.context_,n=this.tmpLocalTransform_,t=s.globalAlpha,l=(1!=this.imageOpacity_&&(s.globalAlpha=t*this.imageOpacity_),this.imageRotation_);this.imageRotateWithView_&&(l+=this.viewRotation_);for(var r=0,h=a.length;r<h;r+=2){var _,f,g=a[r]-this.imageAnchorX_,m=a[r+1]-this.imageAnchorY_;0===l&&1==this.imageScale_||(_=g+this.imageAnchorX_,f=m+this.imageAnchorY_,composeTransform(n,_,f,this.imageScale_,this.imageScale_,l,-_,-f),s.setTransform.apply(s,n)),s.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,g,m,this.imageWidth_,this.imageHeight_)}0===l&&1==this.imageScale_||s.setTransform(1,0,0,1,0,0),1!=this.imageOpacity_&&(s.globalAlpha=t)}},t.prototype.drawText_=function(t,e,i,o){if(this.textState_&&""!==this.text_){this.textFillState_&&this.setContextFillState_(this.textFillState_),this.textStrokeState_&&this.setContextStrokeState_(this.textStrokeState_),this.setContextTextState_(this.textState_);var a=transform2D(t,e,i,o,this.transform_,this.pixelCoordinates_),s=this.context_,n=this.textRotation_;for(this.textRotateWithView_&&(n+=this.viewRotation_);e<i;e+=o){var l,r=a[e]+this.textOffsetX_,h=a[e+1]+this.textOffsetY_;0===n&&1==this.textScale_||(l=composeTransform(this.tmpLocalTransform_,r,h,this.textScale_,this.textScale_,n,-r,-h),s.setTransform.apply(s,l)),this.textStrokeState_&&s.strokeText(this.text_,r,h),this.textFillState_&&s.fillText(this.text_,r,h)}0===n&&1==this.textScale_||s.setTransform(1,0,0,1,0,0)}},t.prototype.moveToLineTo_=function(t,e,i,o,a){var s=this.context_,n=transform2D(t,e,i,o,this.transform_,this.pixelCoordinates_),l=(s.moveTo(n[0],n[1]),n.length);a&&(l-=2);for(var r=2;r<l;r+=2)s.lineTo(n[r],n[r+1]);return a&&s.closePath(),i},t.prototype.drawRings_=function(t,e,i,o){for(var a=0,s=i.length;a<s;++a)e=this.moveToLineTo_(t,e,i[a],o,!0);return e},t.prototype.drawCircle=function(t){var e,i,o;intersects(this.extent_,t.getExtent())&&((this.fillState_||this.strokeState_)&&(this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_),i=(e=transformGeom2D(t,this.transform_,this.pixelCoordinates_))[2]-e[0],o=e[3]-e[1],i=Math.sqrt(i*i+o*o),(o=this.context_).beginPath(),o.arc(e[0],e[1],i,0,2*Math.PI),this.fillState_&&o.fill(),this.strokeState_&&o.stroke()),""!==this.text_&&this.drawText_(t.getCenter(),0,2,2))},t.prototype.setStyle=function(t){this.setFillStrokeStyle(t.getFill(),t.getStroke()),this.setImageStyle(t.getImage()),this.setTextStyle(t.getText())},t.prototype.drawGeometry=function(t){switch(t.getType()){case GeometryType.POINT:this.drawPoint(t);break;case GeometryType.LINE_STRING:this.drawLineString(t);break;case GeometryType.POLYGON:this.drawPolygon(t);break;case GeometryType.MULTI_POINT:this.drawMultiPoint(t);break;case GeometryType.MULTI_LINE_STRING:this.drawMultiLineString(t);break;case GeometryType.MULTI_POLYGON:this.drawMultiPolygon(t);break;case GeometryType.GEOMETRY_COLLECTION:this.drawGeometryCollection(t);break;case GeometryType.CIRCLE:this.drawCircle(t)}},t.prototype.drawFeature=function(t,e){t=e.getGeometryFunction()(t);t&&intersects(this.extent_,t.getExtent())&&(this.setStyle(e),this.drawGeometry(t))},t.prototype.drawGeometryCollection=function(t){for(var e=t.getGeometriesArray(),i=0,o=e.length;i<o;++i)this.drawGeometry(e[i])},t.prototype.drawPoint=function(t){var e=t.getFlatCoordinates(),t=t.getStride();this.image_&&this.drawImages_(e,0,e.length,t),""!==this.text_&&this.drawText_(e,0,e.length,t)},t.prototype.drawMultiPoint=function(t){var e=t.getFlatCoordinates(),t=t.getStride();this.image_&&this.drawImages_(e,0,e.length,t),""!==this.text_&&this.drawText_(e,0,e.length,t)},t.prototype.drawLineString=function(t){var e,i;intersects(this.extent_,t.getExtent())&&(this.strokeState_&&(this.setContextStrokeState_(this.strokeState_),e=this.context_,i=t.getFlatCoordinates(),e.beginPath(),this.moveToLineTo_(i,0,i.length,t.getStride(),!1),e.stroke()),""!==this.text_&&(i=t.getFlatMidpoint(),this.drawText_(i,0,2,2)))},t.prototype.drawMultiLineString=function(t){var e=t.getExtent();if(intersects(this.extent_,e)){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);var e=this.context_,i=t.getFlatCoordinates(),o=0,a=t.getEnds(),s=t.getStride();e.beginPath();for(var n=0,l=a.length;n<l;++n)o=this.moveToLineTo_(i,o,a[n],s,!1);e.stroke()}""!==this.text_&&(e=t.getFlatMidpoints(),this.drawText_(e,0,e.length,2))}},t.prototype.drawPolygon=function(t){var e;intersects(this.extent_,t.getExtent())&&((this.strokeState_||this.fillState_)&&(this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_),(e=this.context_).beginPath(),this.drawRings_(t.getOrientedFlatCoordinates(),0,t.getEnds(),t.getStride()),this.fillState_&&e.fill(),this.strokeState_&&e.stroke()),""!==this.text_&&(e=t.getFlatInteriorPoint(),this.drawText_(e,0,2,2)))},t.prototype.drawMultiPolygon=function(t){if(intersects(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);var e=this.context_,i=t.getOrientedFlatCoordinates(),o=0,a=t.getEndss(),s=t.getStride();e.beginPath();for(var n=0,l=a.length;n<l;++n)var r=a[n],o=this.drawRings_(i,o,r,s);this.fillState_&&e.fill(),this.strokeState_&&e.stroke()}""!==this.text_&&(e=t.getFlatInteriorPoints(),this.drawText_(e,0,e.length,2))}},t.prototype.setContextFillState_=function(t){var e=this.context_,i=this.contextFillState_;i?i.fillStyle!=t.fillStyle&&(i.fillStyle=e.fillStyle=t.fillStyle):(e.fillStyle=t.fillStyle,this.contextFillState_={fillStyle:t.fillStyle})},t.prototype.setContextStrokeState_=function(t){var e=this.context_,i=this.contextStrokeState_;i?(i.lineCap!=t.lineCap&&(i.lineCap=e.lineCap=t.lineCap),e.setLineDash&&(equals(i.lineDash,t.lineDash)||e.setLineDash(i.lineDash=t.lineDash),i.lineDashOffset!=t.lineDashOffset&&(i.lineDashOffset=e.lineDashOffset=t.lineDashOffset)),i.lineJoin!=t.lineJoin&&(i.lineJoin=e.lineJoin=t.lineJoin),i.lineWidth!=t.lineWidth&&(i.lineWidth=e.lineWidth=t.lineWidth),i.miterLimit!=t.miterLimit&&(i.miterLimit=e.miterLimit=t.miterLimit),i.strokeStyle!=t.strokeStyle&&(i.strokeStyle=e.strokeStyle=t.strokeStyle)):(e.lineCap=t.lineCap,e.setLineDash&&(e.setLineDash(t.lineDash),e.lineDashOffset=t.lineDashOffset),e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth,e.miterLimit=t.miterLimit,e.strokeStyle=t.strokeStyle,this.contextStrokeState_={lineCap:t.lineCap,lineDash:t.lineDash,lineDashOffset:t.lineDashOffset,lineJoin:t.lineJoin,lineWidth:t.lineWidth,miterLimit:t.miterLimit,strokeStyle:t.strokeStyle})},t.prototype.setContextTextState_=function(t){var e=this.context_,i=this.contextTextState_,o=t.textAlign||defaultTextAlign;i?(i.font!=t.font&&(i.font=e.font=t.font),i.textAlign!=o&&(i.textAlign=e.textAlign=o),i.textBaseline!=t.textBaseline&&(i.textBaseline=e.textBaseline=t.textBaseline)):(e.font=t.font,e.textAlign=o,e.textBaseline=t.textBaseline,this.contextTextState_={font:t.font,textAlign:o,textBaseline:t.textBaseline})},t.prototype.setFillStrokeStyle=function(t,e){var i,o,a,s,n;t?(t=t.getColor(),this.fillState_={fillStyle:asColorLike(t||defaultFillStyle)}):this.fillState_=null,e?(t=e.getColor(),i=e.getLineCap(),o=e.getLineDash(),a=e.getLineDashOffset(),s=e.getLineJoin(),n=e.getWidth(),e=e.getMiterLimit(),this.strokeState_={lineCap:void 0!==i?i:defaultLineCap,lineDash:o||defaultLineDash,lineDashOffset:a||defaultLineDashOffset,lineJoin:void 0!==s?s:defaultLineJoin,lineWidth:this.pixelRatio_*(void 0!==n?n:defaultLineWidth),miterLimit:void 0!==e?e:defaultMiterLimit,strokeStyle:asColorLike(t||defaultStrokeStyle)}):this.strokeState_=null},t.prototype.setImageStyle=function(t){var e,i,o,a;t?(e=t.getAnchor(),i=t.getImage(1),o=t.getOrigin(),a=t.getSize(),this.imageAnchorX_=e[0],this.imageAnchorY_=e[1],this.imageHeight_=a[1],this.image_=i,this.imageOpacity_=t.getOpacity(),this.imageOriginX_=o[0],this.imageOriginY_=o[1],this.imageRotateWithView_=t.getRotateWithView(),this.imageRotation_=t.getRotation(),this.imageScale_=t.getScale()*this.pixelRatio_,this.imageWidth_=a[0]):this.image_=null},t.prototype.setTextStyle=function(t){var e,i,o,a,s,n,l,r;t?((n=t.getFill())?(n=n.getColor(),this.textFillState_={fillStyle:asColorLike(n||defaultFillStyle)}):this.textFillState_=null,(n=t.getStroke())?(l=n.getColor(),e=n.getLineCap(),i=n.getLineDash(),o=n.getLineDashOffset(),a=n.getLineJoin(),s=n.getWidth(),n=n.getMiterLimit(),this.textStrokeState_={lineCap:void 0!==e?e:defaultLineCap,lineDash:i||defaultLineDash,lineDashOffset:o||defaultLineDashOffset,lineJoin:void 0!==a?a:defaultLineJoin,lineWidth:void 0!==s?s:defaultLineWidth,miterLimit:void 0!==n?n:defaultMiterLimit,strokeStyle:asColorLike(l||defaultStrokeStyle)}):this.textStrokeState_=null,e=t.getFont(),i=t.getOffsetX(),o=t.getOffsetY(),a=t.getRotateWithView(),s=t.getRotation(),n=t.getScale(),l=t.getText(),r=t.getTextAlign(),t=t.getTextBaseline(),this.textState_={font:void 0!==e?e:defaultFont,textAlign:void 0!==r?r:defaultTextAlign,textBaseline:void 0!==t?t:defaultTextBaseline},this.text_=void 0!==l?l:"",this.textOffsetX_=void 0!==i?this.pixelRatio_*i:0,this.textOffsetY_=void 0!==o?this.pixelRatio_*o:0,this.textRotateWithView_=void 0!==a&&a,this.textRotation_=void 0!==s?s:0,this.textScale_=this.pixelRatio_*(void 0!==n?n:1)):this.text_=""},t}(VectorContext);export default CanvasImmediateRenderer;