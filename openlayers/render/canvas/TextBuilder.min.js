var __extends=this&&this.__extends||function(){var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import{getUid}from"../../util.js";import{asColorLike}from"../../colorlike.js";import{intersects}from"../../extent.js";import{matchingChunk}from"../../geom/flat/straightchunk.js";import GeometryType from"../../geom/GeometryType.js";import{labelCache,defaultTextAlign,defaultPadding,defaultLineCap,defaultLineDashOffset,defaultLineDash,defaultLineJoin,defaultFillStyle,checkFont,defaultFont,defaultLineWidth,defaultMiterLimit,defaultStrokeStyle,defaultTextBaseline}from"../canvas.js";import CanvasInstruction from"./Instruction.js";import CanvasBuilder from"./Builder.js";import TextPlacement from"../../style/TextPlacement.js";var TEXT_ALIGN={left:0,end:0,center:.5,right:1,start:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1},CanvasTextBuilder=function(l){function t(t,e,i,s){t=l.call(this,t,e,i,s)||this;return t.declutterGroups_,t.labels_=null,t.text_="",t.textOffsetX_=0,t.textOffsetY_=0,t.textRotateWithView_=void 0,t.textRotation_=0,t.textFillState_=null,t.fillStates={},t.textStrokeState_=null,t.strokeStates={},t.textState_={},t.textStates={},t.textKey_="",t.fillKey_="",t.strokeKey_="",labelCache.prune(),t}return __extends(t,l),t.prototype.finish=function(){var t=l.prototype.finish.call(this);return t.textStates=this.textStates,t.fillStates=this.fillStates,t.strokeStates=this.strokeStates,t},t.prototype.drawText=function(t,e){var i=this.textFillState_,s=this.textStrokeState_,l=this.textState_;if(""!==this.text_&&l&&(i||s)){var a=this.coordinates.length,i=t.getType(),o=null,n=2,r=2;if(l.placement===TextPlacement.LINE){if(intersects(this.getBufferedMaxExtent(),t.getExtent())){var h=void 0,o=t.getFlatCoordinates(),r=t.getStride();if(i==GeometryType.LINE_STRING)h=[o.length];else if(i==GeometryType.MULTI_LINE_STRING)h=t.getEnds();else if(i==GeometryType.POLYGON)h=t.getEnds().slice(0,1);else if(i==GeometryType.MULTI_POLYGON)for(var f=t.getEndss(),h=[],u=0,d=f.length;u<d;++u)h.push(f[u][0]);this.beginGeometry(e);for(var c=l.textAlign,_=0,g=void 0,x=0,p=h.length;x<p;++x){for(g=null==c?(_=(y=matchingChunk(l.maxAngle,o,_,h[x],r))[0],y[1]):h[x],u=_;u<g;u+=r)this.coordinates.push(o[u],o[u+1]);n=this.coordinates.length,_=h[x];var y=this.declutterGroups_?0===x?this.declutterGroups_[0]:[].concat(this.declutterGroups_[0]):null;this.drawChars_(a,n,y),a=n}this.endGeometry(e)}}else{var S=null;switch(l.overflow||(S=[]),i){case GeometryType.POINT:case GeometryType.MULTI_POINT:n=(o=t.getFlatCoordinates()).length;break;case GeometryType.LINE_STRING:o=t.getFlatMidpoint();break;case GeometryType.CIRCLE:o=t.getCenter();break;case GeometryType.MULTI_LINE_STRING:n=(o=t.getFlatMidpoints()).length;break;case GeometryType.POLYGON:o=t.getFlatInteriorPoint(),l.overflow||S.push(o[2]/this.resolution),r=3;break;case GeometryType.MULTI_POLYGON:var k=t.getFlatInteriorPoints();for(o=[],u=0,d=k.length;u<d;u+=3)l.overflow||S.push(k[u+2]/this.resolution),o.push(k[u],k[u+1]);if(0==(n=o.length))return}n=this.appendFlatCoordinates(o,0,n,r,!1,!1),this.saveTextStates_(),(l.backgroundFill||l.backgroundStroke)&&(this.setFillStrokeStyle(l.backgroundFill,l.backgroundStroke),l.backgroundFill&&(this.updateFillStyle(this.state,this.createFill),this.hitDetectionInstructions.push(this.createFill(this.state))),l.backgroundStroke&&(this.updateStrokeStyle(this.state,this.applyStroke),this.hitDetectionInstructions.push(this.createStroke(this.state)))),this.beginGeometry(e);var m=this.pixelRatio;this.instructions.push([CanvasInstruction.DRAW_IMAGE,a,n,null,NaN,NaN,this.declutterGroups_,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,1,NaN,l.padding==defaultPadding?defaultPadding:l.padding.map(function(t){return t*m}),!!l.backgroundFill,!!l.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,S]),this.hitDetectionInstructions.push([CanvasInstruction.DRAW_IMAGE,a,n,null,NaN,NaN,this.declutterGroups_,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,1/this.pixelRatio,NaN,l.padding,!!l.backgroundFill,!!l.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,S]),this.endGeometry(e)}}},t.prototype.saveTextStates_=function(){var t=this.textStrokeState_,e=this.textState_,i=this.textFillState_,s=this.strokeKey_,s=(!t||s in this.strokeStates||(this.strokeStates[s]={strokeStyle:t.strokeStyle,lineCap:t.lineCap,lineDashOffset:t.lineDashOffset,lineWidth:t.lineWidth,lineJoin:t.lineJoin,miterLimit:t.miterLimit,lineDash:t.lineDash}),this.textKey_),t=(s in this.textStates||(this.textStates[s]={font:e.font,textAlign:e.textAlign||defaultTextAlign,textBaseline:e.textBaseline||defaultTextBaseline,scale:e.scale}),this.fillKey_);!i||t in this.fillStates||(this.fillStates[t]={fillStyle:i.fillStyle})},t.prototype.drawChars_=function(t,e,i){var s=this.textStrokeState_,l=this.textState_,a=this.strokeKey_,o=this.textKey_,n=this.fillKey_,r=(this.saveTextStates_(),this.pixelRatio),h=TEXT_ALIGN[l.textBaseline],f=this.textOffsetY_*r,u=this.text_,d=l.scale,s=s?s.lineWidth*d/2:0;this.instructions.push([CanvasInstruction.DRAW_CHARS,t,e,h,i,l.overflow,n,l.maxAngle,r,f,a,s*r,u,o,1]),this.hitDetectionInstructions.push([CanvasInstruction.DRAW_CHARS,t,e,h,i,l.overflow,n,l.maxAngle,1,f,a,s,u,o,1/r])},t.prototype.setTextStyle=function(t,e){var i,s,l,a,o,n;t?(this.declutterGroups_=e,(e=t.getFill())?(i=(i=this.textFillState_)||(this.textFillState_={})).fillStyle=asColorLike(e.getColor()||defaultFillStyle):i=this.textFillState_=null,(e=t.getStroke())?(s=(s=this.textStrokeState_)||(this.textStrokeState_={}),l=e.getLineDash(),o=e.getLineDashOffset(),n=e.getWidth(),a=e.getMiterLimit(),s.lineCap=e.getLineCap()||defaultLineCap,s.lineDash=l?l.slice():defaultLineDash,s.lineDashOffset=void 0===o?defaultLineDashOffset:o,s.lineJoin=e.getLineJoin()||defaultLineJoin,s.lineWidth=void 0===n?defaultLineWidth:n,s.miterLimit=void 0===a?defaultMiterLimit:a,s.strokeStyle=asColorLike(e.getColor()||defaultStrokeStyle)):s=this.textStrokeState_=null,l=this.textState_,o=t.getFont()||defaultFont,checkFont(o),n=t.getScale(),l.overflow=t.getOverflow(),l.font=o,l.maxAngle=t.getMaxAngle(),l.placement=t.getPlacement(),l.textAlign=t.getTextAlign(),l.textBaseline=t.getTextBaseline()||defaultTextBaseline,l.backgroundFill=t.getBackgroundFill(),l.backgroundStroke=t.getBackgroundStroke(),l.padding=t.getPadding()||defaultPadding,l.scale=void 0===n?1:n,a=t.getOffsetX(),e=t.getOffsetY(),o=t.getRotateWithView(),n=t.getRotation(),this.text_=t.getText()||"",this.textOffsetX_=void 0===a?0:a,this.textOffsetY_=void 0===e?0:e,this.textRotateWithView_=void 0!==o&&o,this.textRotation_=void 0===n?0:n,this.strokeKey_=s?("string"==typeof s.strokeStyle?s.strokeStyle:getUid(s.strokeStyle))+s.lineCap+s.lineDashOffset+"|"+s.lineWidth+s.lineJoin+s.miterLimit+"["+s.lineDash.join()+"]":"",this.textKey_=l.font+l.scale+(l.textAlign||"?"),this.fillKey_=i?"string"==typeof i.fillStyle?i.fillStyle:"|"+getUid(i.fillStyle):""):this.text_=""},t}(CanvasBuilder);export default CanvasTextBuilder;export{TEXT_ALIGN};