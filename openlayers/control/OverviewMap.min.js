var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};return function(e,t){function o(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}();import PluggableMap from"../PluggableMap.js";import CompositeMapRenderer from"../renderer/Composite.js";import MapEventType from"../MapEventType.js";import MapProperty from"../MapProperty.js";import{getChangeEventType}from"../Object.js";import ObjectEventType from"../ObjectEventType.js";import Overlay from"../Overlay.js";import OverlayPositioning from"../OverlayPositioning.js";import ViewProperty from"../ViewProperty.js";import Control from"./Control.js";import{fromExtent as polygonFromExtent}from"../geom/Polygon.js";import{CLASS_CONTROL,CLASS_UNSELECTABLE,CLASS_COLLAPSED}from"../css.js";import{replaceNode}from"../dom.js";import{listen,listenOnce}from"../events.js";import EventType from"../events/EventType.js";import{containsExtent,equals as equalsExtent,getBottomRight,getTopLeft,scaleFromCenter}from"../extent.js";var MAX_RATIO=.75,MIN_RATIO=.1,ControlledMap=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.createRenderer=function(){return new CompositeMapRenderer(this)},t}(PluggableMap),OverviewMap=function(c){function e(e){var t=this,e=e||{},o=((t=c.call(this,{element:document.createElement("div"),render:e.render||render,target:e.target})||this).boundHandleRotationChanged_=t.handleRotationChanged_.bind(t),t.collapsed_=void 0===e.collapsed||e.collapsed,t.collapsible_=void 0===e.collapsible||e.collapsible,t.collapsible_||(t.collapsed_=!1),t.rotateWithView_=void 0!==e.rotateWithView&&e.rotateWithView,(t.viewExtent_=void 0)!==e.className?e.className:"ol-overviewmap"),i=void 0!==e.tipLabel?e.tipLabel:"Overview map",n=void 0!==e.collapseLabel?e.collapseLabel:"«",n=("string"==typeof n?(t.collapseLabel_=document.createElement("span"),t.collapseLabel_.textContent=n):t.collapseLabel_=n,void 0!==e.label?e.label:"»"),n=("string"==typeof n?(t.label_=document.createElement("span"),t.label_.textContent=n):t.label_=n,t.collapsible_&&!t.collapsed_?t.collapseLabel_:t.label_),a=document.createElement("button"),r=(a.setAttribute("type","button"),a.title=i,a.appendChild(n),a.addEventListener(EventType.CLICK,t.handleClick_.bind(t),!1),t.ovmapDiv_=document.createElement("div"),t.ovmapDiv_.className="ol-overviewmap-map",t.ovmap_=new ControlledMap({view:e.view}),t.ovmap_),i=(e.layers&&e.layers.forEach(function(e){r.addLayer(e)}),document.createElement("div")),n=(i.className="ol-overviewmap-box",i.style.boxSizing="border-box",t.boxOverlay_=new Overlay({position:[0,0],positioning:OverlayPositioning.CENTER_CENTER,element:i}),t.ovmap_.addOverlay(t.boxOverlay_),o+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(t.collapsed_&&t.collapsible_?" "+CLASS_COLLAPSED:"")+(t.collapsible_?"":" ol-uncollapsible")),e=t.element,l=(e.className=n,e.appendChild(t.ovmapDiv_),e.appendChild(a),t),s=t.boxOverlay_,p=t.boxOverlay_.getElement(),d=function(e){return{clientX:e.clientX-p.offsetWidth/2,clientY:e.clientY+p.offsetHeight/2}},_=function(e){e=d(e),e=r.getEventCoordinate(e);s.setPosition(e)},h=function(e){e=r.getEventCoordinate(e);l.getMap().getView().setCenterInternal(e),window.removeEventListener("mousemove",_),window.removeEventListener("mouseup",h)};return p.addEventListener("mousedown",function(){window.addEventListener("mousemove",_),window.addEventListener("mouseup",h)}),t}return __extends(e,c),e.prototype.setMap=function(e){var t=this.getMap();e!==t&&(t&&((t=t.getView())&&this.unbindView_(t),this.ovmap_.setTarget(null)),c.prototype.setMap.call(this,e),e&&(this.ovmap_.setTarget(this.ovmapDiv_),this.listenerKeys.push(listen(e,ObjectEventType.PROPERTYCHANGE,this.handleMapPropertyChange_,this)),(t=e.getView())&&(this.bindView_(t),t.isDef()&&(this.ovmap_.updateSize(),this.resetExtent_()))))},e.prototype.handleMapPropertyChange_=function(e){e.key===MapProperty.VIEW&&((e=e.oldValue)&&this.unbindView_(e),e=this.getMap().getView(),this.bindView_(e))},e.prototype.bindView_=function(e){e.addEventListener(getChangeEventType(ViewProperty.ROTATION),this.boundHandleRotationChanged_)},e.prototype.unbindView_=function(e){e.removeEventListener(getChangeEventType(ViewProperty.ROTATION),this.boundHandleRotationChanged_)},e.prototype.handleRotationChanged_=function(){this.rotateWithView_&&this.ovmap_.getView().setRotation(this.getMap().getView().getRotation())},e.prototype.validateExtent_=function(){var e,t,o,i,n=this.getMap(),a=this.ovmap_;n.isRendered()&&a.isRendered()&&(i=n.getSize(),n=n.getView().calculateExtentInternal(i),this.viewExtent_&&equalsExtent(n,this.viewExtent_)||(this.viewExtent_=n,i=a.getSize(),e=a.getView().calculateExtentInternal(i),o=a.getPixelFromCoordinate(getTopLeft(n)),a=a.getPixelFromCoordinate(getBottomRight(n)),t=Math.abs(o[0]-a[0]),o=Math.abs(o[1]-a[1]),a=i[0],i=i[1],t<a*MIN_RATIO||o<i*MIN_RATIO||a*MAX_RATIO<t||i*MAX_RATIO<o?this.resetExtent_():containsExtent(e,n)||this.recenter_()))},e.prototype.resetExtent_=function(){var e,t,o;0!==MAX_RATIO&&0!==MIN_RATIO&&(e=this.getMap(),o=this.ovmap_,t=e.getSize(),e=e.getView().calculateExtentInternal(t),t=o.getView(),o=Math.log(MAX_RATIO/MIN_RATIO)/Math.LN2,o=1/(Math.pow(2,o/2)*MIN_RATIO),scaleFromCenter(e,o),t.fitInternal(polygonFromExtent(e)))},e.prototype.recenter_=function(){var e=this.getMap(),t=this.ovmap_,e=e.getView();t.getView().setCenterInternal(e.getCenterInternal())},e.prototype.updateBox_=function(){var e,t,o,i,n,a,r=this.getMap(),l=this.ovmap_;r.isRendered()&&l.isRendered()&&(a=r.getSize(),r=r.getView(),l=l.getView(),e=this.rotateWithView_?0:-r.getRotation(),t=this.boxOverlay_,o=this.boxOverlay_.getElement(),i=r.getCenterInternal(),r=r.getResolution(),l=l.getResolution(),n=a[0]*r/l,a=a[1]*r/l,t.setPosition(i),o&&(o.style.width=n+"px",o.style.height=a+"px",o.style.msTransform=r="rotate("+e+"rad)",o.style.webkitTransform=r,o.style.transform=r))},e.prototype.handleClick_=function(e){e.preventDefault(),this.handleToggle_()},e.prototype.handleToggle_=function(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_;var e=this.ovmap_;if(!this.collapsed_){if(e.isRendered())return this.viewExtent_=void 0,void e.render();e.updateSize(),this.resetExtent_(),listenOnce(e,MapEventType.POSTRENDER,function(e){this.updateBox_()},this)}},e.prototype.getCollapsible=function(){return this.collapsible_},e.prototype.setCollapsible=function(e){this.collapsible_!==e&&(this.collapsible_=e,this.element.classList.toggle("ol-uncollapsible"),!e&&this.collapsed_&&this.handleToggle_())},e.prototype.setCollapsed=function(e){this.collapsible_&&this.collapsed_!==e&&this.handleToggle_()},e.prototype.getCollapsed=function(){return this.collapsed_},e.prototype.getRotateWithView=function(){return this.rotateWithView_},e.prototype.setRotateWithView=function(e){this.rotateWithView_!==e&&(this.rotateWithView_=e,0!==this.getMap().getView().getRotation()&&(this.rotateWithView_?this.handleRotationChanged_():this.ovmap_.getView().setRotation(0),this.viewExtent_=void 0,this.validateExtent_(),this.updateBox_()))},e.prototype.getOverviewMap=function(){return this.ovmap_},e}(Control);function render(e){this.validateExtent_(),this.updateBox_()}export default OverviewMap;export{render};