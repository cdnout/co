var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};return function(t,e){function o(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}();import{ERROR_THRESHOLD}from"./common.js";import ImageBase from"../ImageBase.js";import ImageState from"../ImageState.js";import{listen,unlistenByKey}from"../events.js";import EventType from"../events/EventType.js";import{getCenter,getIntersection,getHeight,getWidth}from"../extent.js";import{calculateSourceResolution,render as renderReprojected}from"../reproj.js";import Triangulation from"./Triangulation.js";var ReprojImage=function(c){function t(t,e,o,r,n,a){var i=this,s=t.getExtent(),u=e.getExtent(),u=u?getIntersection(o,u):o,g=getCenter(u),g=calculateSourceResolution(t,e,g,r),t=new Triangulation(t,e,u,s,g*ERROR_THRESHOLD),u=a(t.calculateSourceExtent(),g,n),a=u?ImageState.IDLE:ImageState.EMPTY,g=u?u.getPixelRatio():1;return(i=c.call(this,o,r,g,a)||this).targetProj_=e,i.maxSourceExtent_=s,i.triangulation_=t,i.targetResolution_=r,i.targetExtent_=o,i.sourceImage_=u,i.sourcePixelRatio_=g,i.canvas_=null,i.sourceListenerKey_=null,i}return __extends(t,c),t.prototype.disposeInternal=function(){this.state==ImageState.LOADING&&this.unlistenSource_(),c.prototype.disposeInternal.call(this)},t.prototype.getImage=function(){return this.canvas_},t.prototype.getProjection=function(){return this.targetProj_},t.prototype.reproject_=function(){var t,e,o=this.sourceImage_.getState();o==ImageState.LOADED&&(t=getWidth(this.targetExtent_)/this.targetResolution_,e=getHeight(this.targetExtent_)/this.targetResolution_,this.canvas_=renderReprojected(t,e,this.sourcePixelRatio_,this.sourceImage_.getResolution(),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0)),this.state=o,this.changed()},t.prototype.load=function(){var t;this.state==ImageState.IDLE&&(this.state=ImageState.LOADING,this.changed(),(t=this.sourceImage_.getState())==ImageState.LOADED||t==ImageState.ERROR?this.reproject_():(this.sourceListenerKey_=listen(this.sourceImage_,EventType.CHANGE,function(t){var e=this.sourceImage_.getState();e!=ImageState.LOADED&&e!=ImageState.ERROR||(this.unlistenSource_(),this.reproject_())},this),this.sourceImage_.load()))},t.prototype.unlistenSource_=function(){unlistenByKey(this.sourceListenerKey_),this.sourceListenerKey_=null},t}(ImageBase);export default ReprojImage;