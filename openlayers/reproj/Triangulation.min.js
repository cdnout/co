import{boundingExtent,createEmpty,extendCoordinate,getBottomLeft,getBottomRight,getTopLeft,getTopRight,getWidth,intersects}from"../extent.js";import{modulo}from"../math.js";import{getTransform}from"../proj.js";var MAX_SUBDIVISION=10,MAX_TRIANGLE_WIDTH=.25,Triangulation=function(){function t(t,r,i,o,e){this.sourceProj_=t,this.targetProj_=r;var s,n={},h=getTransform(this.targetProj_,this.sourceProj_),t=(this.transformInv_=function(t){var r=t[0]+"/"+t[1];return n[r]||(n[r]=h(t)),n[r]},this.maxSourceExtent_=o,this.errorThresholdSquared_=e*e,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!o&&!!this.sourceProj_.getExtent()&&getWidth(o)==getWidth(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?getWidth(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?getWidth(this.targetProj_.getExtent()):null,getTopLeft(i)),r=getTopRight(i),e=getBottomRight(i),o=getBottomLeft(i),i=this.transformInv_(t),a=this.transformInv_(r),u=this.transformInv_(e),d=this.transformInv_(o);this.addQuad_(t,r,e,o,i,a,u,d,MAX_SUBDIVISION),this.wrapsXInSource_&&(s=1/0,this.triangles_.forEach(function(t,r,i){s=Math.min(s,t.source[0][0],t.source[1][0],t.source[2][0])}),this.triangles_.forEach(function(t){var r,i;Math.max(t.source[0][0],t.source[1][0],t.source[2][0])-s>this.sourceWorldWidth_/2&&((r=[[t.source[0][0],t.source[0][1]],[t.source[1][0],t.source[1][1]],[t.source[2][0],t.source[2][1]]])[0][0]-s>this.sourceWorldWidth_/2&&(r[0][0]-=this.sourceWorldWidth_),r[1][0]-s>this.sourceWorldWidth_/2&&(r[1][0]-=this.sourceWorldWidth_),r[2][0]-s>this.sourceWorldWidth_/2&&(r[2][0]-=this.sourceWorldWidth_),i=Math.min(r[0][0],r[1][0],r[2][0]),Math.max(r[0][0],r[1][0],r[2][0])-i<this.sourceWorldWidth_/2&&(t.source=r))}.bind(this))),n={}}return t.prototype.addTriangle_=function(t,r,i,o,e,s){this.triangles_.push({source:[o,e,s],target:[t,r,i]})},t.prototype.addQuad_=function(t,r,i,o,e,s,n,h,a){var u,d=boundingExtent([e,s,n,h]),_=this.sourceWorldWidth_?getWidth(d)/this.sourceWorldWidth_:null,c=this.sourceWorldWidth_,g=this.sourceProj_.canWrapX()&&.5<_&&_<1,l=!1;if(0<a&&(this.targetProj_.isGlobal()&&this.targetWorldWidth_&&(u=boundingExtent([t,r,i,o]),u=getWidth(u)/this.targetWorldWidth_,l=MAX_TRIANGLE_WIDTH<u||l),!g&&this.sourceProj_.isGlobal()&&_&&(l=MAX_TRIANGLE_WIDTH<_||l)),l||!this.maxSourceExtent_||intersects(d,this.maxSourceExtent_)){if(!(l||isFinite(e[0])&&isFinite(e[1])&&isFinite(s[0])&&isFinite(s[1])&&isFinite(n[0])&&isFinite(n[1])&&isFinite(h[0])&&isFinite(h[1]))){if(!(0<a))return;l=!0}if(0<a)if(l||(u=[(t[0]+i[0])/2,(t[1]+i[1])/2],_=this.transformInv_(u),d=void 0,l=(d=g?(modulo(e[0],c)+modulo(n[0],c))/2-modulo(_[0],c):(e[0]+n[0])/2-_[0])*d+(u=(e[1]+n[1])/2-_[1])*u>this.errorThresholdSquared_),l)return void(Math.abs(t[0]-i[0])<=Math.abs(t[1]-i[1])?(c=[(r[0]+i[0])/2,(r[1]+i[1])/2],d=this.transformInv_(c),_=[(o[0]+t[0])/2,(o[1]+t[1])/2],u=this.transformInv_(_),this.addQuad_(t,r,c,_,e,s,d,u,a-1),this.addQuad_(_,c,i,o,u,d,n,h,a-1)):(l=[(t[0]+r[0])/2,(t[1]+r[1])/2],_=this.transformInv_(l),c=[(i[0]+o[0])/2,(i[1]+o[1])/2],u=this.transformInv_(c),this.addQuad_(t,l,c,o,e,_,u,h,a-1),this.addQuad_(l,r,i,c,_,s,n,u,a-1)));if(g){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}this.addTriangle_(t,i,o,e,n,h),this.addTriangle_(t,r,i,e,s,n)}},t.prototype.calculateSourceExtent=function(){var o=createEmpty();return this.triangles_.forEach(function(t,r,i){t=t.source;extendCoordinate(o,t[0]),extendCoordinate(o,t[1]),extendCoordinate(o,t[2])}),o},t.prototype.getTriangles=function(){return this.triangles_},t}();export default Triangulation;