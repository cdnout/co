var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}();import{ERROR_THRESHOLD}from"./common.js";import Tile from"../Tile.js";import TileState from"../TileState.js";import{listen,unlistenByKey}from"../events.js";import EventType from"../events/EventType.js";import{getArea,getCenter,getIntersection}from"../extent.js";import{clamp}from"../math.js";import{calculateSourceResolution,render as renderReprojected}from"../reproj.js";import Triangulation from"./Triangulation.js";var ReprojTile=function(d){function e(e,t,i,r,o,s,n,a,l,u,c){var T=d.call(this,o,TileState.IDLE)||this,c=(T.renderEdges_=void 0!==c&&c,T.pixelRatio_=n,T.gutter_=a,T.canvas_=null,T.sourceTileGrid_=t,T.targetTileGrid_=r,T.wrappedTileCoord_=s||o,T.sourceTiles_=[],T.sourcesListenerKeys_=null,T.sourceZ_=0,r.getTileCoordExtent(T.wrappedTileCoord_)),a=T.targetTileGrid_.getExtent(),s=T.sourceTileGrid_.getExtent(),o=a?getIntersection(c,a):c;if(0===getArea(o))return T.state=TileState.EMPTY,T;a=e.getExtent(),a&&(s=s?getIntersection(s,a):a),c=r.getResolution(T.wrappedTileCoord_[0]),a=getCenter(o),r=calculateSourceResolution(e,i,a,c);if(!isFinite(r)||r<=0)return T.state=TileState.EMPTY,T;if(T.triangulation_=new Triangulation(e,i,o,s,r*(void 0!==u?u:ERROR_THRESHOLD)),0===T.triangulation_.getTriangles().length)return T.state=TileState.EMPTY,T;T.sourceZ_=t.getZForResolution(r);a=T.triangulation_.calculateSourceExtent();if(s&&(e.canWrapX()?(a[1]=clamp(a[1],s[1],s[3]),a[3]=clamp(a[3],s[1],s[3])):a=getIntersection(a,s)),getArea(a)){for(var _=t.getTileRangeForExtentAndZ(a,T.sourceZ_),p=_.minX;p<=_.maxX;p++)for(var h=_.minY;h<=_.maxY;h++){var g=l(T.sourceZ_,p,h,n);g&&T.sourceTiles_.push(g)}0===T.sourceTiles_.length&&(T.state=TileState.EMPTY)}else T.state=TileState.EMPTY;return T}return __extends(e,d),e.prototype.disposeInternal=function(){this.state==TileState.LOADING&&this.unlistenSources_(),d.prototype.disposeInternal.call(this)},e.prototype.getImage=function(){return this.canvas_},e.prototype.reproject_=function(){var e,t,i,r,o,s=[];this.sourceTiles_.forEach(function(e,t,i){e&&e.getState()==TileState.LOADED&&s.push({extent:this.sourceTileGrid_.getTileCoordExtent(e.tileCoord),image:e.getImage()})}.bind(this)),(this.sourceTiles_.length=0)===s.length?this.state=TileState.ERROR:(i=this.wrappedTileCoord_[0],e="number"==typeof(t=this.targetTileGrid_.getTileSize(i))?t:t[0],t="number"==typeof t?t:t[1],i=this.targetTileGrid_.getResolution(i),r=this.sourceTileGrid_.getResolution(this.sourceZ_),o=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),this.canvas_=renderReprojected(e,t,this.pixelRatio_,r,this.sourceTileGrid_.getExtent(),i,o,this.triangulation_,s,this.gutter_,this.renderEdges_),this.state=TileState.LOADED),this.changed()},e.prototype.load=function(){var s;this.state==TileState.IDLE&&(this.state=TileState.LOADING,this.changed(),s=0,this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(function(i,e,t){var r,o=i.getState();o!=TileState.IDLE&&o!=TileState.LOADING||(s++,r=listen(i,EventType.CHANGE,function(e){var t=i.getState();t!=TileState.LOADED&&t!=TileState.ERROR&&t!=TileState.EMPTY||(unlistenByKey(r),0===--s&&(this.unlistenSources_(),this.reproject_()))},this),this.sourcesListenerKeys_.push(r))}.bind(this)),this.sourceTiles_.forEach(function(e,t,i){e.getState()==TileState.IDLE&&e.load()}),0===s&&setTimeout(this.reproject_.bind(this),0))},e.prototype.unlistenSources_=function(){this.sourcesListenerKeys_.forEach(unlistenByKey),this.sourcesListenerKeys_=null},e}(Tile);export default ReprojTile;