import{equals}from"../../array.js";import{createEmpty,createOrUpdate,createOrUpdateEmpty,extend,intersects}from"../../extent.js";import{lineStringLength}from"../../geom/flat/length.js";import{drawTextOnPath}from"../../geom/flat/textpath.js";import{transform2D}from"../../geom/flat/transform.js";import{drawImage,defaultPadding,defaultTextBaseline}from"../canvas.js";import CanvasInstruction from"./Instruction.js";import{TEXT_ALIGN}from"./TextBuilder.js";import{create as createTransform,compose as composeTransform,apply as applyTransform,setFromArray as transformSetFromArray}from"../../transform.js";import{createCanvasContext2D}from"../../dom.js";import{labelCache,defaultTextAlign,measureTextHeight,measureAndCacheTextWidth,measureTextWidths}from"../canvas.js";import Disposable from"../../Disposable.js";import RBush from"rbush";const tmpExtent=createEmpty(),tmpTransform=createTransform(),p1=[],p2=[],p3=[],p4=[];class Executor extends Disposable{constructor(t,e,i,a){super(),this.overlaps=i,this.pixelRatio=e,this.resolution=t,this.alignFill_,this.declutterItems=[],this.instructions=a.instructions,this.coordinates=a.coordinates,this.coordinateCache_={},this.renderedTransform_=createTransform(),this.hitDetectionInstructions=a.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=a.fillStates||{},this.strokeStates=a.strokeStates||{},this.textStates=a.textStates||{},this.widths_={}}disposeInternal(){labelCache.release(this),super.disposeInternal()}getTextImage(e,i,a,s){var r=s+i+e+a+this.pixelRatio;if(!labelCache.containsKey(r)){var n=s?this.strokeStates[s]:null,l=a?this.fillStates[a]:null,i=this.textStates[i],o=this.pixelRatio,o=i.scale*o,h=TEXT_ALIGN[i.textAlign||defaultTextAlign],p=s&&n.lineWidth?n.lineWidth:0,m=e.split("\n"),c=m.length,f=[],e=measureTextWidths(i.font,m,f),d=measureTextHeight(i.font),u=d*c,e=e+p;const T=createCanvasContext2D(Math.ceil((e+2)*o),Math.ceil((u+p)*o));u=T.canvas,labelCache.set(r,u),1!=o&&T.scale(o,o),T.font=i.font,s&&(T.strokeStyle=n.strokeStyle,T.lineWidth=p,T.lineCap=n.lineCap,T.lineJoin=n.lineJoin,T.miterLimit=n.miterLimit,T.setLineDash&&n.lineDash.length&&(T.setLineDash(n.lineDash),T.lineDashOffset=n.lineDashOffset)),a&&(T.fillStyle=l.fillStyle),T.textBaseline="middle",T.textAlign="center";var x=.5-h,g=h*e+x*p;let t;if(s)for(t=0;t<c;++t)T.strokeText(m[t],g+x*f[t],.5*(p+d)+t*d);if(a)for(t=0;t<c;++t)T.fillText(m[t],g+x*f[t],.5*(p+d)+t*d)}return labelCache.get(r,this)}replayTextBackground_(t,e,i,a,s,r,n){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,i),t.lineTo.apply(t,a),t.lineTo.apply(t,s),t.lineTo.apply(t,e),r&&(this.alignFill_=r[2],this.fill_(t)),n&&(this.setStrokeStyle_(t,n),t.stroke())}replayImage_(t,e,i,a,s,r,n,l,o,h,p,m,c,f,d,u,x,g){var T=x||g,d=d+h>a.width?a.width-h:d,l=l+p>a.height?a.height-p:l,_=u[3]+d*c+u[1],v=u[0]+l*c+u[2],I=(e-=s*=c)-u[3],u=(i-=r*=c)-u[0];!T&&0===m||(p1[0]=p4[0]=I,p1[1]=p2[1]=u,p2[0]=p3[0]=I+_,p3[1]=p4[1]=u+v);let C=null;0!==m?(s=e+s,r=i+r,C=composeTransform(tmpTransform,s,r,1,1,m,-s,-r),applyTransform(tmpTransform,p1),applyTransform(tmpTransform,p2),applyTransform(tmpTransform,p3),applyTransform(tmpTransform,p4),createOrUpdate(Math.min(p1[0],p2[0],p3[0],p4[0]),Math.min(p1[1],p2[1],p3[1],p4[1]),Math.max(p1[0],p2[0],p3[0],p4[0]),Math.max(p1[1],p2[1],p3[1],p4[1]),tmpExtent)):createOrUpdate(I,u,I+_,u+v,tmpExtent);m=t.canvas,s=g?g[2]*c/2:0,r=tmpExtent[0]-s<=m.width&&0<=tmpExtent[2]+s&&tmpExtent[1]-s<=m.height&&0<=tmpExtent[3]+s;if(f&&(e=Math.round(e),i=Math.round(i)),n){if(r||1!=n[4]){extend(n,tmpExtent);const y=r?[t,C?C.slice(0):null,o,a,h,p,d,l,e,i,c]:null;y&&(T&&y.push(x,g,p1,p2,p3,p4),n.push(y))}}else r&&(T&&this.replayTextBackground_(t,p1,p2,p3,p4,x,g),drawImage(t,C,o,a,h,p,d,l,e,i,c))}fill_(t){var e,i;this.alignFill_&&(e=applyTransform(this.renderedTransform_,[0,0]),i=512*this.pixelRatio,t.save(),t.translate(e[0]%i,e[1]%i),t.rotate(this.viewRotation_)),t.fill(),this.alignFill_&&t.restore()}setStrokeStyle_(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.setLineDash&&(t.lineDashOffset=e[7],t.setLineDash(e[6]))}renderDeclutter(i,t,a,e){if(i&&5<i.length){var s=i[4];if(1==s||s==i.length-5){s={minX:i[0],minY:i[1],maxX:i[2],maxY:i[3],value:t};if(!(e=e||new RBush(9)).collides(s)){e.insert(s);for(let t=5,e=i.length;t<e;++t){var r=i[t];const l=r[0];var n=l.globalAlpha;n!==a&&(l.globalAlpha=a),11<r.length&&this.replayTextBackground_(r[0],r[13],r[14],r[15],r[16],r[11],r[12]),drawImage.apply(void 0,r),n!==a&&(l.globalAlpha=n)}}i.length=5,createOrUpdateEmpty(i)}}return e}drawTextImageWithPointPlacement_(t,e,i,a){var s=this.textStates[e],t=this.getTextImage(t,e,a,i),e=this.strokeStates[i],a=this.pixelRatio,i=TEXT_ALIGN[s.textAlign||defaultTextAlign],r=TEXT_ALIGN[s.textBaseline||defaultTextBaseline],e=e&&e.lineWidth?e.lineWidth:0;return{label:t,anchorX:i*(t.width/a-2*s.scale)+2*(.5-i)*e,anchorY:r*t.height/a+2*(.5-r)*e}}execute_(p,t,e,q,m,J){this.declutterItems.length=0;let c,f=(this.pixelCoordinates_&&equals(t,this.renderedTransform_)?c=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),c=transform2D(this.coordinates,0,this.coordinates.length,2,t,this.pixelCoordinates_),transformSetFromArray(this.renderedTransform_,t)),0);var i=e.length;let d=0,u,x,g,T,_,v,I,C,y,E,S,k,b,A,w=0,R=0,K=null,V=null;const z=this.coordinateCache_;var Q=this.viewRotation_;const Z={context:p,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:Q};var D=this.instructions!=e||this.overlaps?0:200;let L,O,M;for(;f<i;){const H=e[f];switch(H[0]){case CanvasInstruction.BEGIN_GEOMETRY:L=H[1],void 0===J||intersects(J,L.getGeometry().getExtent())?++f:f=H[2]+1;break;case CanvasInstruction.BEGIN_PATH:w>D&&(this.fill_(p),w=0),R>D&&(p.stroke(),R=0),w||R||(p.beginPath(),T=_=NaN),++f;break;case CanvasInstruction.CIRCLE:d=H[1];var P=c[d],W=c[d+1],j=c[d+2]-P,B=c[d+3]-W,j=Math.sqrt(j*j+B*B);p.moveTo(P+j,W),p.arc(P,W,j,0,2*Math.PI,!0),++f;break;case CanvasInstruction.CLOSE_PATH:p.closePath(),++f;break;case CanvasInstruction.CUSTOM:d=H[1],u=H[2];B=H[3];const ct=H[4],ft=6==H.length?H[5]:void 0,U=(Z.geometry=B,Z.feature=L,f in z||(z[f]=[]),z[f]);ft?ft(c,d,u,2,U):(U[0]=c[d],U[1]=c[d+1],U.length=2),ct(U,Z),++f;break;case CanvasInstruction.DRAW_IMAGE:d=H[1],u=H[2],E=H[3],x=H[4],g=H[5],y=m?null:H[6];let t=H[7];var $=H[8],tt=H[9],et=H[10],P=H[11];let e=H[12];var it,at=H[13];let i=H[14];!E&&19<=H.length&&(S=H[18],k=H[19],b=H[20],A=H[21],W=this.drawTextImageWithPointPlacement_(S,k,b,A),E=H[3]=W.label,j=H[22],x=H[4]=(W.anchorX-j)*this.pixelRatio,G=H[23],g=H[5]=(W.anchorY-G)*this.pixelRatio,t=H[7]=E.height,i=H[14]=E.width);let a;24<H.length&&(a=H[24]);let s,r,n,l=(16<H.length?(s=H[15],r=H[16],n=H[17]):(s=defaultPadding,r=n=!1),P&&(e+=Q),0),o=0;for(;d<u;d+=2)a&&a[l++]<i/this.pixelRatio||(y&&(it=Math.floor(o),y.length<it+1&&((C=createEmpty()).push(y[0][4]),y.push(C)),C=y[it]),this.replayImage_(p,c[d],c[d+1],E,x,g,C,t,$,tt,et,e,at,q,i,s,r?K:null,n?V:null),C&&(o===Math.floor(o)&&this.declutterItems.push(this,C,L),o+=1/C[4]));++f;break;case CanvasInstruction.DRAW_CHARS:var G=H[1],st=H[2],rt=H[3],nt=(C=m?null:H[4],H[5]),lt=(A=H[6],H[7]),N=H[8],ot=H[9],ht=(b=H[10],H[11]),pt=(S=H[12],k=H[13],H[14]),mt=this.textStates[k],F=mt.font,mt=mt.scale*N;let h;h=F in this.widths_?this.widths_[F]:this.widths_[F]={};var N=lineStringLength(c,G,st,2),X=mt*measureAndCacheTextWidth(F,S,h);if(nt||X<=N){var nt=this.textStates[k].textAlign,N=(N-X)*TEXT_ALIGN[nt],Y=drawTextOnPath(c,G,st,2,S,N,lt,mt,measureAndCacheTextWidth,F,h);if(Y){let t,e,i,a,s;if(b)for(t=0,e=Y.length;t<e;++t)s=Y[t],i=s[4],a=this.getTextImage(i,k,"",b),x=s[2]+ht,g=rt*a.height+2*(.5-rt)*ht-ot,this.replayImage_(p,s[0],s[1],a,x,g,C,a.height,1,0,0,s[3],pt,!1,a.width,defaultPadding,null,null);if(A)for(t=0,e=Y.length;t<e;++t)s=Y[t],i=s[4],a=this.getTextImage(i,k,A,""),x=s[2],g=rt*a.height-ot,this.replayImage_(p,s[0],s[1],a,x,g,C,a.height,1,0,0,s[3],pt,!1,a.width,defaultPadding,null,null)}}this.declutterItems.push(this,C,L),++f;break;case CanvasInstruction.END_GEOMETRY:if(void 0!==m){X=m(L=H[1]);if(X)return X}++f;break;case CanvasInstruction.FILL:D?w++:this.fill_(p),++f;break;case CanvasInstruction.MOVE_TO_LINE_TO:for(d=H[1],u=H[2],O=c[d],M=c[d+1],v=O+.5|0,I=M+.5|0,v===T&&I===_||(p.moveTo(O,M),T=v,_=I),d+=2;d<u;d+=2)O=c[d],M=c[d+1],v=O+.5|0,I=M+.5|0,d!=u-2&&v===T&&I===_||(p.lineTo(O,M),T=v,_=I);++f;break;case CanvasInstruction.SET_FILL_STYLE:K=H,this.alignFill_=H[2],w&&(this.fill_(p),w=0,R&&(p.stroke(),R=0)),p.fillStyle=H[1],++f;break;case CanvasInstruction.SET_STROKE_STYLE:V=H,R&&(p.stroke(),R=0),this.setStrokeStyle_(p,H),++f;break;case CanvasInstruction.STROKE:D?R++:p.stroke(),++f;break;default:++f}}w&&this.fill_(p),R&&p.stroke()}execute(t,e,i,a){this.viewRotation_=i,this.execute_(t,e,this.instructions,a,void 0,void 0)}executeHitDetection(t,e,i,a,s){return this.viewRotation_=i,this.execute_(t,e,this.hitDetectionInstructions,!0,a,s)}}export default Executor;