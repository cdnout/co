import{ERROR_THRESHOLD}from"./common.js";import ImageBase from"../ImageBase.js";import ImageState from"../ImageState.js";import{listen,unlistenByKey}from"../events.js";import EventType from"../events/EventType.js";import{getCenter,getIntersection,getHeight,getWidth}from"../extent.js";import{calculateSourceResolution,render as renderReprojected}from"../reproj.js";import Triangulation from"./Triangulation.js";class ReprojImage extends ImageBase{constructor(t,e,s,a,r,i){var o=t.getExtent(),n=e.getExtent(),n=n?getIntersection(s,n):s,g=getCenter(n),g=calculateSourceResolution(t,e,g,a);const u=new Triangulation(t,e,n,o,g*ERROR_THRESHOLD),h=i(u.calculateSourceExtent(),g,r);t=h?ImageState.IDLE:ImageState.EMPTY,n=h?h.getPixelRatio():1;super(s,a,n,t),this.targetProj_=e,this.maxSourceExtent_=o,this.triangulation_=u,this.targetResolution_=a,this.targetExtent_=s,this.sourceImage_=h,this.sourcePixelRatio_=n,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==ImageState.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){var t,e,s=this.sourceImage_.getState();s==ImageState.LOADED&&(t=getWidth(this.targetExtent_)/this.targetResolution_,e=getHeight(this.targetExtent_)/this.targetResolution_,this.canvas_=renderReprojected(t,e,this.sourcePixelRatio_,this.sourceImage_.getResolution(),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0)),this.state=s,this.changed()}load(){var t;this.state==ImageState.IDLE&&(this.state=ImageState.LOADING,this.changed(),(t=this.sourceImage_.getState())==ImageState.LOADED||t==ImageState.ERROR?this.reproject_():(this.sourceListenerKey_=listen(this.sourceImage_,EventType.CHANGE,function(t){var e=this.sourceImage_.getState();e!=ImageState.LOADED&&e!=ImageState.ERROR||(this.unlistenSource_(),this.reproject_())},this),this.sourceImage_.load()))}unlistenSource_(){unlistenByKey(this.sourceListenerKey_),this.sourceListenerKey_=null}}export default ReprojImage;