import{ERROR_THRESHOLD}from"./common.js";import Tile from"../Tile.js";import TileState from"../TileState.js";import{listen,unlistenByKey}from"../events.js";import EventType from"../events/EventType.js";import{getArea,getCenter,getIntersection}from"../extent.js";import{clamp}from"../math.js";import{calculateSourceResolution,render as renderReprojected}from"../reproj.js";import Triangulation from"./Triangulation.js";class ReprojTile extends Tile{constructor(t,i,e,s,r,o,n,l,a,h,u){super(r,TileState.IDLE),this.renderEdges_=void 0!==u&&u,this.pixelRatio_=n,this.gutter_=l,this.canvas_=null,this.sourceTileGrid_=i,this.targetTileGrid_=s,this.wrappedTileCoord_=o||r,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;u=s.getTileCoordExtent(this.wrappedTileCoord_),l=this.targetTileGrid_.getExtent();let T=this.sourceTileGrid_.getExtent();o=l?getIntersection(u,l):u;if(0===getArea(o))this.state=TileState.EMPTY;else{r=t.getExtent(),l=(r&&(T=T?getIntersection(T,r):r),s.getResolution(this.wrappedTileCoord_[0])),u=getCenter(o),r=calculateSourceResolution(t,e,u,l);if(!isFinite(r)||r<=0)this.state=TileState.EMPTY;else if(this.triangulation_=new Triangulation(t,e,o,T,r*(void 0!==h?h:ERROR_THRESHOLD)),0===this.triangulation_.getTriangles().length)this.state=TileState.EMPTY;else{this.sourceZ_=i.getZForResolution(r);let e=this.triangulation_.calculateSourceExtent();if(T&&(t.canWrapX()?(e[1]=clamp(e[1],T[1],T[3]),e[3]=clamp(e[3],T[1],T[3])):e=getIntersection(e,T)),getArea(e)){var c=i.getTileRangeForExtentAndZ(e,this.sourceZ_);for(let t=c.minX;t<=c.maxX;t++)for(let e=c.minY;e<=c.maxY;e++){var g=a(this.sourceZ_,t,e,n);g&&this.sourceTiles_.push(g)}0===this.sourceTiles_.length&&(this.state=TileState.EMPTY)}else this.state=TileState.EMPTY}}}disposeInternal(){this.state==TileState.LOADING&&this.unlistenSources_(),super.disposeInternal()}getImage(){return this.canvas_}reproject_(){const s=[];var e,t,i,r,o;this.sourceTiles_.forEach(function(e,t,i){e&&e.getState()==TileState.LOADED&&s.push({extent:this.sourceTileGrid_.getTileCoordExtent(e.tileCoord),image:e.getImage()})}.bind(this)),(this.sourceTiles_.length=0)===s.length?this.state=TileState.ERROR:(i=this.wrappedTileCoord_[0],e="number"==typeof(t=this.targetTileGrid_.getTileSize(i))?t:t[0],t="number"==typeof t?t:t[1],i=this.targetTileGrid_.getResolution(i),r=this.sourceTileGrid_.getResolution(this.sourceZ_),o=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),this.canvas_=renderReprojected(e,t,this.pixelRatio_,r,this.sourceTileGrid_.getExtent(),i,o,this.triangulation_,s,this.gutter_,this.renderEdges_),this.state=TileState.LOADED),this.changed()}load(){if(this.state==TileState.IDLE){this.state=TileState.LOADING,this.changed();let o=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(function(i,e,t){var s=i.getState();if(s==TileState.IDLE||s==TileState.LOADING){o++;const r=listen(i,EventType.CHANGE,function(e){var t=i.getState();t!=TileState.LOADED&&t!=TileState.ERROR&&t!=TileState.EMPTY||(unlistenByKey(r),0===--o&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(r)}}.bind(this)),this.sourceTiles_.forEach(function(e,t,i){e.getState()==TileState.IDLE&&e.load()}),0===o&&setTimeout(this.reproject_.bind(this),0)}}unlistenSources_(){this.sourcesListenerKeys_.forEach(unlistenByKey),this.sourcesListenerKeys_=null}}export default ReprojTile;