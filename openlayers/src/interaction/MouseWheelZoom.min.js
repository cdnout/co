import{always}from"../events/condition.js";import EventType from"../events/EventType.js";import{DEVICE_PIXEL_RATIO,FIREFOX}from"../has.js";import Interaction,{zoomByDelta}from"./Interaction.js";import{clamp}from"../math.js";const Mode={TRACKPAD:"trackpad",WHEEL:"wheel"};class MouseWheelZoom extends Interaction{constructor(t){t=t||{};super(t),this.totalDelta_=0,this.lastDelta_=0,this.maxDelta_=void 0!==t.maxDelta?t.maxDelta:1,this.duration_=void 0!==t.duration?t.duration:250,this.timeout_=void 0!==t.timeout?t.timeout:80,this.useAnchor_=void 0===t.useAnchor||t.useAnchor,this.condition_=t.condition||always,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_,this.mode_=void 0,this.trackpadEventGap_=400,this.trackpadTimeoutId_,this.trackpadDeltaPerZoom_=300}endInteraction_(){this.trackpadTimeoutId_=void 0;const t=this.getMap().getView();t.endInteraction(void 0,Math.sign(this.lastDelta_),this.lastAnchor_)}handleEvent(t){if(!this.condition_(t))return!0;if(t.type!==EventType.WHEEL)return!0;t.preventDefault();const e=t.map;var i=t.originalEvent;this.useAnchor_&&(this.lastAnchor_=t.coordinate);let o;if(t.type==EventType.WHEEL&&(o=i.deltaY,FIREFOX&&i.deltaMode===WheelEvent.DOM_DELTA_PIXEL&&(o/=DEVICE_PIXEL_RATIO),i.deltaMode===WheelEvent.DOM_DELTA_LINE&&(o*=40)),0===o)return!1;this.lastDelta_=o;t=Date.now();if(void 0===this.startTime_&&(this.startTime_=t),(!this.mode_||t-this.startTime_>this.trackpadEventGap_)&&(this.mode_=Math.abs(o)<4?Mode.TRACKPAD:Mode.WHEEL),this.mode_===Mode.TRACKPAD){const a=e.getView();return this.trackpadTimeoutId_?clearTimeout(this.trackpadTimeoutId_):a.beginInteraction(),this.trackpadTimeoutId_=setTimeout(this.endInteraction_.bind(this),this.trackpadEventGap_),a.adjustZoom(-o/this.trackpadDeltaPerZoom_,this.lastAnchor_),this.startTime_=t,!1}this.totalDelta_+=o;i=Math.max(this.timeout_-(t-this.startTime_),0);return clearTimeout(this.timeoutId_),this.timeoutId_=setTimeout(this.handleWheelZoom_.bind(this,e),i),!1}handleWheelZoom_(t){const e=t.getView();e.getAnimating()&&e.cancelAnimations();t=clamp(this.totalDelta_,-this.maxDelta_,this.maxDelta_);zoomByDelta(e,-t,this.lastAnchor_,this.duration_),this.mode_=void 0,this.totalDelta_=0,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_=void 0}setMouseAnchor(t){(this.useAnchor_=t)||(this.lastAnchor_=null)}}export default MouseWheelZoom;export{Mode};