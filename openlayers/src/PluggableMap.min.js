import{getUid}from"./util.js";import Collection from"./Collection.js";import CollectionEventType from"./CollectionEventType.js";import MapBrowserEvent from"./MapBrowserEvent.js";import MapBrowserEventHandler from"./MapBrowserEventHandler.js";import MapBrowserEventType from"./MapBrowserEventType.js";import MapEvent from"./MapEvent.js";import MapEventType from"./MapEventType.js";import MapProperty from"./MapProperty.js";import RenderEventType from"./render/EventType.js";import BaseObject,{getChangeEventType}from"./Object.js";import ObjectEventType from"./ObjectEventType.js";import TileQueue from"./TileQueue.js";import View from"./View.js";import ViewHint from"./ViewHint.js";import{assert}from"./asserts.js";import{removeNode}from"./dom.js";import{listen,unlistenByKey}from"./events.js";import EventType from"./events/EventType.js";import{clone,createOrUpdateEmpty,equals,getForViewAndSize,isEmpty}from"./extent.js";import{TRUE}from"./functions.js";import{DEVICE_PIXEL_RATIO,IMAGE_DECODE}from"./has.js";import LayerGroup from"./layer/Group.js";import{hasArea}from"./size.js";import{DROP}from"./structs/PriorityQueue.js";import{create as createTransform,apply as applyTransform}from"./transform.js";class PluggableMap extends BaseObject{constructor(e){super();var t=createOptionsInternal(e),r=(this.boundHandleBrowserEvent_=this.handleBrowserEvent.bind(this),this.maxTilesLoading_=void 0!==e.maxTilesLoading?e.maxTilesLoading:16,this.pixelRatio_=void 0!==e.pixelRatio?e.pixelRatio:DEVICE_PIXEL_RATIO,this.postRenderTimeoutHandle_,this.animationDelayKey_,this.animationDelay_=function(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}.bind(this),this.coordinateToPixelTransform_=createTransform(),this.pixelToCoordinateTransform_=createTransform(),this.frameIndex_=0,this.frameState_=null,this.previousExtent_=null,this.viewPropertyListenerKey_=null,this.viewChangeListenerKey_=null,this.layerGroupPropertyListenerKeys_=null,this.viewport_=document.createElement("div"),this.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),this.viewport_.style.position="relative",this.viewport_.style.overflow="hidden",this.viewport_.style.width="100%",this.viewport_.style.height="100%",this.viewport_.style.msTouchAction="none",this.viewport_.style.touchAction="none",this.overlayContainer_=document.createElement("div"),this.overlayContainer_.style.position="absolute",this.overlayContainer_.style.zIndex="0",this.overlayContainer_.style.width="100%",this.overlayContainer_.style.height="100%",this.overlayContainer_.className="ol-overlaycontainer",this.viewport_.appendChild(this.overlayContainer_),this.overlayContainerStopEvent_=document.createElement("div"),this.overlayContainerStopEvent_.style.position="absolute",this.overlayContainerStopEvent_.style.zIndex="0",this.overlayContainerStopEvent_.style.width="100%",this.overlayContainerStopEvent_.style.height="100%",this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",this.viewport_.appendChild(this.overlayContainerStopEvent_),this.mapBrowserEventHandler_=new MapBrowserEventHandler(this,e.moveTolerance),this.handleMapBrowserEvent.bind(this));for(const i in MapBrowserEventType)this.mapBrowserEventHandler_.addEventListener(MapBrowserEventType[i],r);this.keyboardEventTarget_=t.keyboardEventTarget,this.keyHandlerKeys_=null;e=this.handleBrowserEvent.bind(this);this.viewport_.addEventListener(EventType.CONTEXTMENU,e,!1),this.viewport_.addEventListener(EventType.WHEEL,e,!1),this.controls=t.controls||new Collection,this.interactions=t.interactions||new Collection,this.labelCache_=null,this.labelCacheListenerKey_,this.overlays_=t.overlays,this.overlayIdIndex_={},this.renderer_=null,this.handleResize_,this.postRenderFunctions_=[],this.tileQueue_=new TileQueue(this.getTilePriority.bind(this),this.handleTileChange_.bind(this)),this.addEventListener(getChangeEventType(MapProperty.LAYERGROUP),this.handleLayerGroupChanged_),this.addEventListener(getChangeEventType(MapProperty.VIEW),this.handleViewChanged_),this.addEventListener(getChangeEventType(MapProperty.SIZE),this.handleSizeChanged_),this.addEventListener(getChangeEventType(MapProperty.TARGET),this.handleTargetChanged_),this.setProperties(t.values),this.controls.forEach(function(e){e.setMap(this)}.bind(this)),this.controls.addEventListener(CollectionEventType.ADD,function(e){e.element.setMap(this)}.bind(this)),this.controls.addEventListener(CollectionEventType.REMOVE,function(e){e.element.setMap(null)}.bind(this)),this.interactions.forEach(function(e){e.setMap(this)}.bind(this)),this.interactions.addEventListener(CollectionEventType.ADD,function(e){e.element.setMap(this)}.bind(this)),this.interactions.addEventListener(CollectionEventType.REMOVE,function(e){e.element.setMap(null)}.bind(this)),this.overlays_.forEach(this.addOverlayInternal_.bind(this)),this.overlays_.addEventListener(CollectionEventType.ADD,function(e){this.addOverlayInternal_(e.element)}.bind(this)),this.overlays_.addEventListener(CollectionEventType.REMOVE,function(e){const t=e.element,r=t.getId();void 0!==r&&delete this.overlayIdIndex_[r.toString()],e.element.setMap(null)}.bind(this))}createRenderer(){throw new Error("Use a map type that has a createRenderer method")}addControl(e){this.getControls().push(e)}addInteraction(e){this.getInteractions().push(e)}addLayer(e){const t=this.getLayerGroup().getLayers();t.push(e)}addOverlay(e){this.getOverlays().push(e)}addOverlayInternal_(e){const t=e.getId();void 0!==t&&(this.overlayIdIndex_[t.toString()]=e),e.setMap(this)}disposeInternal(){this.mapBrowserEventHandler_.dispose(),this.viewport_.removeEventListener(EventType.CONTEXTMENU,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener(EventType.WHEEL,this.boundHandleBrowserEvent_),void 0!==this.handleResize_&&(removeEventListener(EventType.RESIZE,this.handleResize_,!1),this.handleResize_=void 0),this.setTarget(null),super.disposeInternal()}forEachFeatureAtPixel(e,t,r){var i;if(this.frameState_)return e=this.getCoordinateFromPixel(e),i=void 0!==(r=void 0!==r?r:{}).hitTolerance?r.hitTolerance*this.frameState_.pixelRatio:0,r=void 0!==r.layerFilter?r.layerFilter:TRUE,this.renderer_.forEachFeatureAtCoordinate(e,this.frameState_,i,t,null,r,null)}getFeaturesAtPixel(e,t){const r=[];return this.forEachFeatureAtPixel(e,function(e){r.push(e)},t),r}forEachLayerAtPixel(e,t,r){var i;if(this.frameState_)return i=r||{},r=void 0!==i.hitTolerance?r.hitTolerance*this.frameState_.pixelRatio:0,i=i.layerFilter||TRUE,this.renderer_.forEachLayerAtPixel(e,this.frameState_,r,t,i)}hasFeatureAtPixel(e,t){if(!this.frameState_)return!1;var e=this.getCoordinateFromPixel(e),r=void 0!==(t=void 0!==t?t:{}).layerFilter?t.layerFilter:TRUE,t=void 0!==t.hitTolerance?t.hitTolerance*this.frameState_.pixelRatio:0;return this.renderer_.hasFeatureAtCoordinate(e,this.frameState_,t,r,null)}getEventCoordinate(e){return this.getCoordinateFromPixel(this.getEventPixel(e))}getEventPixel(e){var t=this.viewport_.getBoundingClientRect(),e="changedTouches"in e?e.changedTouches[0]:e;return[e.clientX-t.left,e.clientY-t.top]}getTarget(){return this.get(MapProperty.TARGET)}getTargetElement(){var e=this.getTarget();return void 0!==e?"string"==typeof e?document.getElementById(e):e:null}getCoordinateFromPixel(e){var t=this.frameState_;return t?applyTransform(t.pixelToCoordinateTransform,e.slice()):null}getControls(){return this.controls}getOverlays(){return this.overlays_}getOverlayById(e){e=this.overlayIdIndex_[e.toString()];return void 0!==e?e:null}getInteractions(){return this.interactions}getLayerGroup(){return this.get(MapProperty.LAYERGROUP)}getLayers(){return this.getLayerGroup().getLayers()}getLoading(){var r=this.getLayerGroup().getLayerStatesArray();for(let e=0,t=r.length;e<t;++e){const n=r[e].layer;var i=n.getSource();if(i&&i.loading)return!0}return!1}getPixelFromCoordinate(e){var t=this.frameState_;return t?applyTransform(t.coordinateToPixelTransform,e.slice(0,2)):null}getRenderer(){return this.renderer_}getSize(){return this.get(MapProperty.SIZE)}getView(){return this.get(MapProperty.VIEW)}getViewport(){return this.viewport_}getOverlayContainer(){return this.overlayContainer_}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getTilePriority(e,t,r,i){var n=this.frameState_;if(!(n&&t in n.wantedTiles))return DROP;if(!n.wantedTiles[t][e.getKey()])return DROP;t=n.viewState.center,e=r[0]-t[0],n=r[1]-t[1];return 65536*Math.log(i)+Math.sqrt(e*e+n*n)/i}handleBrowserEvent(e,t){t=t||e.type,t=new MapBrowserEvent(t,this,e);this.handleMapBrowserEvent(t)}handleMapBrowserEvent(t){if(this.frameState_){let e=t.originalEvent.target;for(;e instanceof HTMLElement;){if(e.parentElement===this.overlayContainerStopEvent_)return;e=e.parentElement}t.frameState=this.frameState_;var r=this.getInteractions().getArray();if(!1!==this.dispatchEvent(t))for(let e=r.length-1;0<=e;e--){const i=r[e];if(i.getActive())if(!i.handleEvent(t))break}}}handlePostRender(){var r,i=this.frameState_;const n=this.tileQueue_;if(!n.isEmpty()){let e=this.maxTilesLoading_,t=e;!i||((r=i.viewHints)[ViewHint.ANIMATING]||r[ViewHint.INTERACTING])&&(r=!IMAGE_DECODE&&8<Date.now()-i.time,e=r?0:8,t=r?0:2),n.getTilesLoading()<e&&(n.reprioritize(),n.loadMoreTiles(e,t))}!i||!this.hasListener(RenderEventType.RENDERCOMPLETE)||i.animate||this.tileQueue_.getTilesLoading()||this.getLoading()||this.renderer_.dispatchRenderEvent(RenderEventType.RENDERCOMPLETE,i);const s=this.postRenderFunctions_;for(let e=0,t=s.length;e<t;++e)s[e](this,i);s.length=0}handleSizeChanged_(){this.getView()&&this.getView().resolveConstraints(0),this.render()}handleTargetChanged_(){let e;if(this.getTarget()&&(e=this.getTargetElement()),this.keyHandlerKeys_){for(let e=0,t=this.keyHandlerKeys_.length;e<t;++e)unlistenByKey(this.keyHandlerKeys_[e]);this.keyHandlerKeys_=null}var t;e?(e.appendChild(this.viewport_),this.renderer_||(this.renderer_=this.createRenderer()),t=this.keyboardEventTarget_||e,this.keyHandlerKeys_=[listen(t,EventType.KEYDOWN,this.handleBrowserEvent,this),listen(t,EventType.KEYPRESS,this.handleBrowserEvent,this)],this.handleResize_||(this.handleResize_=this.updateSize.bind(this),window.addEventListener(EventType.RESIZE,this.handleResize_,!1))):(this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0),removeNode(this.viewport_),void 0!==this.handleResize_&&(removeEventListener(EventType.RESIZE,this.handleResize_,!1),this.handleResize_=void 0)),this.updateSize()}handleTileChange_(){this.render()}handleViewPropertyChanged_(){this.render()}handleViewChanged_(){this.viewPropertyListenerKey_&&(unlistenByKey(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(unlistenByKey(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);const e=this.getView();e&&(this.viewport_.setAttribute("data-view",getUid(e)),this.viewPropertyListenerKey_=listen(e,ObjectEventType.PROPERTYCHANGE,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=listen(e,EventType.CHANGE,this.handleViewPropertyChanged_,this),e.resolveConstraints(0)),this.render()}handleLayerGroupChanged_(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(unlistenByKey),this.layerGroupPropertyListenerKeys_=null);var e=this.getLayerGroup();e&&(this.layerGroupPropertyListenerKeys_=[listen(e,ObjectEventType.PROPERTYCHANGE,this.render,this),listen(e,EventType.CHANGE,this.render,this)]),this.render()}isRendered(){return!!this.frameState_}renderSync(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()}redrawText(){var r=this.getLayerGroup().getLayerStatesArray();for(let e=0,t=r.length;e<t;++e){const i=r[e].layer;i.hasRenderer()&&i.getRenderer().handleFontsChanged()}}render(){this.renderer_&&void 0===this.animationDelayKey_&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))}removeControl(e){return this.getControls().remove(e)}removeInteraction(e){return this.getInteractions().remove(e)}removeLayer(e){const t=this.getLayerGroup().getLayers();return t.remove(e)}removeOverlay(e){return this.getOverlays().remove(e)}renderFrame_(e){var t=this.getSize();const r=this.getView();var i,n,s=this.frameState_;let a=null;void 0!==t&&hasArea(t)&&r&&r.isDef()&&(i=r.getHints(this.frameState_?this.frameState_.viewHints:void 0),n=r.getState(),a={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutterItems:s?s.declutterItems:[],extent:getForViewAndSize(n.center,n.resolution,n.rotation,t),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:t,tileQueue:this.tileQueue_,time:e,usedTiles:{},viewState:n,viewHints:i,wantedTiles:{}}),this.frameState_=a,this.renderer_.renderFrame(a),a&&(a.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,a.postRenderFunctions),!s||this.previousExtent_&&(isEmpty(this.previousExtent_)||equals(a.extent,this.previousExtent_))||(this.dispatchEvent(new MapEvent(MapEventType.MOVESTART,this,s)),this.previousExtent_=createOrUpdateEmpty(this.previousExtent_)),!this.previousExtent_||a.viewHints[ViewHint.ANIMATING]||a.viewHints[ViewHint.INTERACTING]||equals(a.extent,this.previousExtent_)||(this.dispatchEvent(new MapEvent(MapEventType.MOVEEND,this,a)),clone(a.extent,this.previousExtent_))),this.dispatchEvent(new MapEvent(MapEventType.POSTRENDER,this,a)),this.postRenderTimeoutHandle_=setTimeout(this.handlePostRender.bind(this),0)}setLayerGroup(e){this.set(MapProperty.LAYERGROUP,e)}setSize(e){this.set(MapProperty.SIZE,e)}setTarget(e){this.set(MapProperty.TARGET,e)}setView(e){this.set(MapProperty.VIEW,e)}updateSize(){var e,t=this.getTargetElement();t?(e=getComputedStyle(t),this.setSize([t.offsetWidth-parseFloat(e.borderLeftWidth)-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight)-parseFloat(e.borderRightWidth),t.offsetHeight-parseFloat(e.borderTopWidth)-parseFloat(e.paddingTop)-parseFloat(e.paddingBottom)-parseFloat(e.borderBottomWidth)])):this.setSize(void 0)}}function createOptionsInternal(e){let t=null;void 0!==e.keyboardEventTarget&&(t="string"==typeof e.keyboardEventTarget?document.getElementById(e.keyboardEventTarget):e.keyboardEventTarget);const r={};var i=e.layers&&"function"==typeof e.layers.getLayers?e.layers:new LayerGroup({layers:e.layers});r[MapProperty.LAYERGROUP]=i,r[MapProperty.TARGET]=e.target,r[MapProperty.VIEW]=void 0!==e.view?e.view:new View;let n;void 0!==e.controls&&(n=Array.isArray(e.controls)?new Collection(e.controls.slice()):(assert("function"==typeof e.controls.getArray,47),e.controls));let s;void 0!==e.interactions&&(s=Array.isArray(e.interactions)?new Collection(e.interactions.slice()):(assert("function"==typeof e.interactions.getArray,48),e.interactions));let a;return a=void 0!==e.overlays?Array.isArray(e.overlays)?new Collection(e.overlays.slice()):(assert("function"==typeof e.overlays.getArray,49),e.overlays):new Collection,{controls:n,interactions:s,keyboardEventTarget:t,overlays:a,values:r}}export default PluggableMap;