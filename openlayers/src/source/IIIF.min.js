import{DEFAULT_TILE_SIZE}from"../tilegrid/common.js";import{getTopLeft}from"../extent.js";import{CustomTile}from"./Zoomify.js";import{Versions}from"../format/IIIFInfo.js";import{assert}from"../asserts.js";import TileGrid from"../tilegrid/TileGrid.js";import TileImage from"./TileImage.js";function formatPercentage(e){return e.toLocaleString("en",{maximumFractionDigits:10})}class IIIF extends TileImage{constructor(e){e=e||{};let r=e.url||"";r+=r.lastIndexOf("/")===r.length-1||""===r?"":"/";const g=e.version||Versions.VERSION2,m=e.sizes||[];var t=e.size;assert(null!=t&&Array.isArray(t)&&2==t.length&&!isNaN(t[0])&&0<t[0]&&!isNaN(t[1])&&0<t[1],60);const f=t[0],h=t[1];var t=e.tileSize,i=e.tilePixelRatio||1;const d=e.format||"jpg",p=e.quality||(e.version==Versions.VERSION1?"native":"default");let I=e.resolutions||[];const y=e.supports||[];var s=e.extent||[0,-h,f,0];const N=null!=m&&Array.isArray(m)&&0<m.length,T=null!=t&&("number"==typeof t&&Number.isInteger(t)&&0<t||Array.isArray(t)&&0<t.length),z=null!=y&&Array.isArray(y)&&(y.includes("regionByPx")||y.includes("regionByPct"))&&(y.includes("sizeByWh")||y.includes("sizeByH")||y.includes("sizeByW")||y.includes("sizeByPct"));let x,E,M;if(I.sort(function(e,t){return t-e}),T||z)if(null!=t&&("number"==typeof t&&Number.isInteger(t)&&0<t?(x=t,E=t):Array.isArray(t)&&0<t.length&&((1==t.length||null==t[1]&&Number.isInteger(t[0]))&&(x=t[0],E=t[0]),2==t.length&&(Number.isInteger(t[0])&&Number.isInteger(t[1])?(x=t[0],E=t[1]):null==t[0]&&Number.isInteger(t[1])&&(x=t[1],E=t[1])))),void 0!==x&&void 0!==E||(x=DEFAULT_TILE_SIZE,E=DEFAULT_TILE_SIZE),0==I.length)for(let e=M=Math.max(Math.ceil(Math.log(f/x)/Math.LN2),Math.ceil(Math.log(h/E)/Math.LN2));0<=e;e--)I.push(Math.pow(2,e));else{t=Math.max(...I);M=Math.round(Math.log(t)/Math.LN2)}else if(x=f,E=h,I=[],N){m.sort(function(e,t){return e[0]-t[0]}),M=-1;const o=[];for(let e=0;e<m.length;e++){var n=f/m[e][0];0<I.length&&I[I.length-1]==n?o.push(e):(I.push(n),M++)}if(0<o.length)for(let e=0;e<o.length;e++)m.splice(o[e]-e,1)}else I.push(1),m.push([f,h]),M=0;t=new TileGrid({tileSize:[x,E],extent:s,origin:getTopLeft(s),resolutions:I}),s=CustomTile.bind(null,i,t);super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:e.state,tileClass:s,tileGrid:t,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:function(s,e,t){let n,o;var i=s[0];if(!(i>M)){var l=s[1],s=s[2],a=I[i];if(!(void 0===l||void 0===s||void 0===a||l<0||Math.ceil(f/a/x)<=l||s<0||Math.ceil(h/a/E)<=s)){if(z||T){var u,c,l=l*x*a,s=s*E*a;let e=x*a,t=E*a,i=x,r=E;l+e>f&&(e=f-l),s+t>h&&(t=h-s),l+x*a>f&&(i=Math.floor((f-l+a-1)/a)),s+E*a>h&&(r=Math.floor((h-s+a-1)/a)),0==l&&e==f&&0==s&&t==h?n="full":!z||y.includes("regionByPx")?n=l+","+s+","+e+","+t:y.includes("regionByPct")&&(l=formatPercentage(l/f*100),s=formatPercentage(s/h*100),u=formatPercentage(e/f*100),c=formatPercentage(t/h*100),n="pct:"+l+","+s+","+u+","+c),g!=Versions.VERSION3||z&&!y.includes("sizeByWh")?!z||y.includes("sizeByW")?o=i+",":y.includes("sizeByH")?o=","+r:y.includes("sizeByWh")?o=i+","+r:y.includes("sizeByPct")&&(o="pct:"+formatPercentage(100/a)):o=i+","+r}else n="full",o=N?(l=m[i][0],s=m[i][1],g==Versions.VERSION3?l==f&&s==h?"max":l+","+s:l==f?"full":l+","):g==Versions.VERSION3?"max":"full";return r+n+"/"+o+"/0/"+p+"."+d}}},transition:e.transition}),this.zDirection=e.zDirection}}export default IIIF;