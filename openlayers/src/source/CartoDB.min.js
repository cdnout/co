import{assign}from"../obj.js";import SourceState from"./State.js";import XYZ from"./XYZ.js";class CartoDB extends XYZ{constructor(t){super({attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,maxZoom:void 0!==t.maxZoom?t.maxZoom:18,minZoom:t.minZoom,projection:t.projection,wrapX:t.wrapX}),this.account_=t.account,this.mapId_=t.map||"",this.config_=t.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(t){assign(this.config_,t),this.initializeMap_()}setConfig(t){this.config_=t||{},this.initializeMap_()}initializeMap_(){var e=JSON.stringify(this.config_);if(this.templateCache_[e])this.applyTemplate_(this.templateCache_[e]);else{let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const i=new XMLHttpRequest;i.addEventListener("load",this.handleInitResponse_.bind(this,e)),i.addEventListener("error",this.handleInitError_.bind(this)),i.open("POST",t),i.setRequestHeader("Content-type","application/json"),i.send(JSON.stringify(this.config_))}}handleInitResponse_(e,i){i=i.target;if(!i.status||200<=i.status&&i.status<300){let t;try{t=JSON.parse(i.responseText)}catch(t){return void this.setState(SourceState.ERROR)}this.applyTemplate_(t),this.templateCache_[e]=t,this.setState(SourceState.READY)}else this.setState(SourceState.ERROR)}handleInitError_(t){this.setState(SourceState.ERROR)}applyTemplate_(t){t="https://"+t.cdn_url.https+"/"+this.account_+"/api/v1/map/"+t.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}export default CartoDB;