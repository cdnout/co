import TileState from"../TileState.js";import VectorRenderTile from"../VectorRenderTile.js";import Tile from"../VectorTile.js";import{toSize}from"../size.js";import UrlTile from"./UrlTile.js";import{getKeyZXY,getKey}from"../tilecoord.js";import{createXYZ,extentFromProjection,createForProjection}from"../tilegrid.js";import{buffer as bufferExtent,getIntersection,intersects}from"../extent.js";import{listen,unlistenByKey}from"../events.js";import EventType from"../events/EventType.js";import{loadFeaturesXhr}from"../featureloader.js";import{isEmpty}from"../obj.js";import{equals}from"../array.js";class VectorTile extends UrlTile{constructor(e){var t=e.projection||"EPSG:3857",i=e.extent||extentFromProjection(t),i=e.tileGrid||createXYZ({extent:i,maxZoom:e.maxZoom||22,minZoom:e.minZoom,tileSize:e.tileSize||512});super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,opaque:!1,projection:t,state:e.state,tileGrid:i,tileLoadFunction:e.tileLoadFunction||defaultLoadFunction,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:void 0===e.wrapX||e.wrapX,transition:e.transition,zDirection:void 0===e.zDirection?1:e.zDirection}),this.format_=e.format||null,this.loadingTiles_={},this.sourceTileByCoordKey_={},this.sourceTilesByTileKey_={},this.overlaps_=null==e.overlaps||e.overlaps,this.tileClass=e.tileClass||Tile,this.tileGrids_={}}getOverlaps(){return this.overlaps_}clear(){this.tileCache.clear(),this.sourceTileByCoordKey_={},this.sourceTilesByTileKey_={}}getSourceTiles(l,s,n){var e=n.wrappedTileCoord;const t=this.getTileGridForProjection(s);var i=t.getTileCoordExtent(e),e=e[0],e=t.getResolution(e);bufferExtent(i,-e,i);const a=this.tileGrid;var o=a.getExtent();o&&getIntersection(i,o,i);const c=a.getZForResolution(e,1);var r=a.getMinZoom(),o=this.sourceTilesByTileKey_[n.getKey()];let T,u,d,h;if(o&&0<o.length&&o[0].tileCoord[0]===c)T=o,u=!0,d=!1,h=c;else for(T=[],h=c+1;--h,u=!0,d=!0,a.forEachTileCoord(i,h,function(e){var t=getKey(e);let i;if(t in this.sourceTileByCoordKey_){var o=(i=this.sourceTileByCoordKey_[t]).getState();if(o===TileState.LOADED||o===TileState.ERROR||o===TileState.EMPTY)return d=d&&o===TileState.EMPTY,void T.push(i)}else h===c?void 0!==(o=this.tileUrlFunction(e,l,s))?((i=new this.tileClass(e,TileState.IDLE,o,this.format_,this.tileLoadFunction)).extent=a.getTileCoordExtent(e),i.projection=s,i.resolution=a.getResolution(e[0]),this.sourceTileByCoordKey_[t]=i,d=!1,i.addEventListener(EventType.CHANGE,this.handleTileChange.bind(this)),i.load()):i=null:d=!1;if(u=!1,void 0!==i&&null!==i&&n.getState()===TileState.IDLE){n.loadingSourceTiles++;const r=listen(i,EventType.CHANGE,function(){var e=i.getState(),t=i.getKey();e!==TileState.LOADED&&e!==TileState.ERROR||(e===TileState.LOADED?(unlistenByKey(r),n.loadingSourceTiles--,delete n.errorSourceTileKeys[t]):e===TileState.ERROR&&(n.errorSourceTileKeys[t]=!0),n.loadingSourceTiles-Object.keys(n.errorSourceTileKeys).length==0&&(n.hifi=!0,n.sourceZ=c,n.setState(isEmpty(n.errorSourceTileKeys)?TileState.LOADED:TileState.ERROR)))})}}.bind(this)),u||(T.length=0),!u&&h>r;);return d||n.getState()!==TileState.IDLE||n.setState(TileState.LOADING),(u||d)&&(n.hifi=c===h,n.sourceZ=h,n.getState()<TileState.LOADED?n.setState(d?TileState.EMPTY:TileState.LOADED):o&&equals(T,o)||(this.removeSourceTiles(n),this.addSourceTiles(n,T))),T}addSourceTiles(i,o){for(let e=0,t=(this.sourceTilesByTileKey_[i.getKey()]=o).length;e<t;++e)o[e].consumers++}removeSourceTiles(e){e=e.getKey();if(e in this.sourceTilesByTileKey_){var i=this.sourceTilesByTileKey_[e];for(let e=0,t=i.length;e<t;++e){const o=i[e];o.consumers--,0===o.consumers&&(o.dispose(),delete this.sourceTileByCoordKey_[getKey(o.tileCoord)])}}delete this.sourceTilesByTileKey_[e]}getTile(e,t,i,o,r){var l=getKeyZXY(e,t,i),s=this.getKey();let n;if(this.tileCache.containsKey(l)&&(n=this.tileCache.get(l)).key===s)return n;t=[e,t,i];let a=this.getTileCoordForTileUrlFunction(t,r);i=this.getTileGrid().getExtent();if(a&&i){const u=this.getTileGridForProjection(r);var c=u.getTileCoordExtent(a);bufferExtent(c,-u.getResolution(e),c),intersects(i,c)||(a=null)}const T=new VectorRenderTile(t,null!==a?TileState.IDLE:TileState.EMPTY,a,this.tileGrid,this.getSourceTiles.bind(this,o,r),this.removeSourceTiles.bind(this));return T.key=s,n?(T.interimTile=n,T.refreshInterimChain(),this.tileCache.replace(l,T)):this.tileCache.set(l,T),T}getTileGridForProjection(e){var t=e.getCode();let i=this.tileGrids_[t];if(!i){const o=this.tileGrid;i=this.tileGrids_[t]=createForProjection(e,void 0,o?o.getTileSize(o.getMinZoom()):void 0)}return i}getTilePixelRatio(e){return e}getTilePixelSize(e,t,i){const o=this.getTileGridForProjection(i);i=toSize(o.getTileSize(e),this.tmpSize);return[Math.round(i[0]*t),Math.round(i[1]*t)]}}export default VectorTile;function defaultLoadFunction(e,t){t=loadFeaturesXhr(t,e.getFormat(),e.onLoad.bind(e),e.onError.bind(e));e.setLoader(t)}export{defaultLoadFunction};