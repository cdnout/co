import ImageWrapper from"../Image.js";import{assert}from"../asserts.js";import EventType from"../events/EventType.js";import{containsExtent,getHeight,getWidth}from"../extent.js";import{assign}from"../obj.js";import ImageSource,{defaultImageLoadFunction}from"./Image.js";import{appendParams}from"../uri.js";class ImageArcGISRest extends ImageSource{constructor(e){e=e||{};super({attributions:e.attributions,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=void 0!==e.crossOrigin?e.crossOrigin:null,this.hidpi_=void 0===e.hidpi||e.hidpi,this.url_=e.url,this.imageLoadFunction_=void 0!==e.imageLoadFunction?e.imageLoadFunction:defaultImageLoadFunction,this.params_=e.params||{},this.image_=null,this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=void 0!==e.ratio?e.ratio:1.5}getParams(){return this.params_}getImageInternal(e,i,t,s){if(void 0===this.url_)return null;i=this.findNearestResolution(i),t=this.hidpi_?t:1;const r=this.image_;if(r&&this.renderedRevision_==this.getRevision()&&r.getResolution()==i&&r.getPixelRatio()==t&&containsExtent(r.getExtent(),e))return r;var a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0},n=(assign(a,this.params_),((e=e.slice())[0]+e[2])/2),o=(e[1]+e[3])/2,g=(1!=this.ratio_&&(g=this.ratio_*getWidth(e)/2,h=this.ratio_*getHeight(e)/2,e[0]=n-g,e[1]=o-h,e[2]=n+g,e[3]=o+h),i/t),h=Math.ceil(getWidth(e)/g),m=Math.ceil(getHeight(e)/g),n=(e[0]=n-g*h/2,e[2]=n+g*h/2,e[1]=o-g*m/2,e[3]=o+g*m/2,this.imageSize_[0]=h,this.imageSize_[1]=m,this.getRequestUrl_(e,this.imageSize_,t,s,a));return this.image_=new ImageWrapper(e,i,t,n,this.crossOrigin_,this.imageLoadFunction_),this.renderedRevision_=this.getRevision(),this.image_.addEventListener(EventType.CHANGE,this.handleImageChange.bind(this)),this.image_}getImageLoadFunction(){return this.imageLoadFunction_}getRequestUrl_(e,i,t,s,r){s=s.getCode().split(":").pop();r.SIZE=i[0]+","+i[1],r.BBOX=e.join(","),r.BBOXSR=s,r.IMAGESR=s,r.DPI=Math.round(90*t);const a=this.url_;i=a.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return i==a&&assert(!1,50),appendParams(i,r)}getUrl(){return this.url_}setImageLoadFunction(e){this.image_=null,this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.image_=null,this.changed())}updateParams(e){assign(this.params_,e),this.image_=null,this.changed()}}export default ImageArcGISRest;