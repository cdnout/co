import{createFromTileUrlFunctions}from"../tileurlfunction.js";import{applyTransform,intersects}from"../extent.js";import{jsonp as requestJSONP}from"../net.js";import{get as getProjection,getTransformFromProjections}from"../proj.js";import SourceState from"./State.js";import TileImage from"./TileImage.js";import{createOrUpdate}from"../tilecoord.js";import{createXYZ,extentFromProjection}from"../tilegrid.js";function quadKey(e){var t=e[0];const r=new Array(t);let i=1<<t-1,o,s;for(o=0;o<t;++o)s=48,e[1]&i&&(s+=1),e[2]&i&&(s+=2),r[o]=String.fromCharCode(s),i>>=1;return r.join("")}const TOS_ATTRIBUTION='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html">Terms of Use</a>';class BingMaps extends TileImage{constructor(e){var t=void 0!==e.hidpi&&e.hidpi,t=(super({cacheSize:e.cacheSize,crossOrigin:"anonymous",opaque:!0,projection:getProjection("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:SourceState.LOADING,tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:void 0===e.wrapX||e.wrapX,transition:e.transition}),this.hidpi_=t,this.culture_=void 0!==e.culture?e.culture:"en-us",this.maxZoom_=void 0!==e.maxZoom?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_);requestJSONP(t,this.handleImageryMetadataResponse.bind(this),void 0,"jsonp")}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(200!=e.statusCode||"OK"!=e.statusDescription||"ValidCredentials"!=e.authenticationResultCode||1!=e.resourceSets.length||1!=e.resourceSets[0].resources.length)this.setState(SourceState.ERROR);else{const n=e.resourceSets[0].resources[0];var e=-1==this.maxZoom_?n.zoomMax:this.maxZoom_,t=this.getProjection(),t=extentFromProjection(t),r=this.hidpi_?2:1,r=n.imageWidth==n.imageHeight?n.imageWidth/r:[n.imageWidth/r,n.imageHeight/r],t=createXYZ({extent:t,minZoom:n.zoomMin,maxZoom:e,tileSize:r});this.tileGrid=t;const s=this.culture_,a=this.hidpi_;if(this.tileUrlFunction=createFromTileUrlFunctions(n.imageUrlSubdomains.map(function(e){const i=[0,0,0],o=n.imageUrl.replace("{subdomain}",e).replace("{culture}",s);return function(t,e,r){if(t){createOrUpdate(t[0],t[1],t[2],i);let e=o;return a&&(e+="&dpi=d1&device=mobile"),e.replace("{quadkey}",quadKey(i))}}})),n.imageryProviders){const c=getTransformFromProjections(getProjection("EPSG:4326"),this.getProjection());this.setAttributions(function(s){const t=[];var e=s.viewState;const r=this.getTileGrid();var i=r.getZForResolution(e.resolution,this.zDirection);const a=r.getTileCoordForCoordAndZ(e.center,i)[0];return n.imageryProviders.map(function(e){let r=!1;var i=e.coverageAreas;for(let e=0,t=i.length;e<t;++e){var o=i[e];if(a>=o.zoomMin&&a<=o.zoomMax){o=o.bbox,o=[o[1],o[0],o[3],o[2]],o=applyTransform(o,c);if(intersects(o,s.extent)){r=!0;break}}}r&&t.push(e.attribution)}),t.push(TOS_ATTRIBUTION),t}.bind(this))}this.setState(SourceState.READY)}}}export default BingMaps;export{quadKey};