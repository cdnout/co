import{DEFAULT_TILE_SIZE}from"../tilegrid/common.js";import ImageTile from"../ImageTile.js";import TileState from"../TileState.js";import{expandUrl,createFromTileUrlFunctions}from"../tileurlfunction.js";import{assert}from"../asserts.js";import{createCanvasContext2D}from"../dom.js";import{getTopLeft}from"../extent.js";import{toSize}from"../size.js";import TileImage from"./TileImage.js";import TileGrid from"../tilegrid/TileGrid.js";const TierSizeCalculation={DEFAULT:"default",TRUNCATED:"truncated"};class CustomTile extends ImageTile{constructor(i,e,t,r,o,a,l,s){super(t,r,o,a,l,s),this.zoomifyImage_=null,this.tileSize_=toSize(e.getTileSize(t[0])).map(function(e){return e*i})}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;var e=super.getImage();if(this.state!=TileState.LOADED)return e;var i=this.tileSize_;if(e.width==i[0]&&e.height==i[1])return this.zoomifyImage_=e;{const t=createCanvasContext2D(i[0],i[1]);return t.drawImage(e,0,0),this.zoomifyImage_=t.canvas,t.canvas}}}class Zoomify extends TileImage{constructor(e){var e=e||{},i=e.size,t=void 0!==e.tierSizeCalculation?e.tierSizeCalculation:TierSizeCalculation.DEFAULT,r=i[0],o=i[1],i=e.extent||[0,-i[1],i[0],0];const c=[];var a=e.tileSize||DEFAULT_TILE_SIZE,l=e.tilePixelRatio||1;let s=a;switch(t){case TierSizeCalculation.DEFAULT:for(;r>s||o>s;)c.push([Math.ceil(r/s),Math.ceil(o/s)]),s+=s;break;case TierSizeCalculation.TRUNCATED:let e=r,i=o;for(;e>s||i>s;)c.push([Math.ceil(e/s),Math.ceil(i/s)]),e>>=1,i>>=1;break;default:assert(!1,53)}c.push([1,1]),c.reverse();const n=[1],m=[0];for(let e=1,i=c.length;e<i;e++)n.push(1<<e),m.push(c[e-1][0]*c[e-1][1]+m[e-1]);n.reverse();const u=new TileGrid({tileSize:a,extent:i,origin:getTopLeft(i),resolutions:n});let T=e.url;T&&-1==T.indexOf("{TileGroup}")&&-1==T.indexOf("{tileIndex}")&&(T+="{TileGroup}/{z}-{x}-{y}.jpg");const f=expandUrl(T);t=createFromTileUrlFunctions(f.map(function(n){return function(e,i,t){if(e){var r=e[0],o=e[1],e=e[2],a=o+e*c[r][0],l=u.getTileSize(r),l=Array.isArray(l)?l[0]:l;const s={z:r,x:o,y:e,tileIndex:a,TileGroup:"TileGroup"+((a+m[r])/l|0)};return n.replace(/\{(\w+?)\}/g,function(e,i){return s[i]})}}})),a=CustomTile.bind(null,l,u);super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,projection:e.projection,tilePixelRatio:l,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:a,tileGrid:u,tileUrlFunction:t,transition:e.transition}),this.zDirection=e.zDirection}}export default Zoomify;export{CustomTile};