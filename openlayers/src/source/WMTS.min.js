import{expandUrl,createFromTileUrlFunctions,nullTileUrlFunction}from"../tileurlfunction.js";import{find,findIndex,includes}from"../array.js";import{containsExtent}from"../extent.js";import{assign}from"../obj.js";import{get as getProjection,equivalent,transformExtent}from"../proj.js";import TileImage from"./TileImage.js";import WMTSRequestEncoding from"./WMTSRequestEncoding.js";import{createFromCapabilitiesMatrixSet}from"../tilegrid/WMTS.js";import{appendParams}from"../uri.js";class WMTS extends TileImage{constructor(e){var t=void 0!==e.requestEncoding?e.requestEncoding:WMTSRequestEncoding.KVP,i=e.tileGrid;let n=e.urls;void 0===n&&void 0!==e.url&&(n=expandUrl(e.url)),super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:e.tileClass,tileGrid:i,tileLoadFunction:e.tileLoadFunction,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:nullTileUrlFunction,urls:n,wrapX:void 0!==e.wrapX&&e.wrapX,transition:e.transition}),this.version_=void 0!==e.version?e.version:"1.0.0",this.format_=void 0!==e.format?e.format:"image/jpeg",this.dimensions_=void 0!==e.dimensions?e.dimensions:{},this.layer_=e.layer,this.matrixSet_=e.matrixSet,this.style_=e.style,this.requestEncoding_=t,this.setKey(this.getKeyForDimensions_()),n&&0<n.length&&(this.tileUrlFunction=createFromTileUrlFunctions(n.map(createFromWMTSTemplate.bind(this))))}setUrls(e){var t=(this.urls=e).join("\n");this.setTileUrlFunction(createFromTileUrlFunctions(e.map(createFromWMTSTemplate.bind(this))),t)}getDimensions(){return this.dimensions_}getFormat(){return this.format_}getLayer(){return this.layer_}getMatrixSet(){return this.matrixSet_}getRequestEncoding(){return this.requestEncoding_}getStyle(){return this.style_}getVersion(){return this.version_}getKeyForDimensions_(){let e=0;const t=[];for(const i in this.dimensions_)t[e++]=i+"-"+this.dimensions_[i];return t.join("/")}updateDimensions(e){assign(this.dimensions_,e),this.setKey(this.getKeyForDimensions_())}}export default WMTS;function optionsFromCapabilities(e,s){var t=e.Contents.Layer;const i=find(t,function(e,t,i){return e.Identifier==s.layer});if(null===i)return null;const a=e.Contents.TileMatrixSet;let n;(n=1<i.TileMatrixSetLink.length?"projection"in s?findIndex(i.TileMatrixSetLink,function(t,e,i){const n=find(a,function(e){return e.Identifier==t.TileMatrixSet}).SupportedCRS;var r=getProjection(n.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"))||getProjection(n),o=getProjection(s.projection);return r&&o?equivalent(r,o):n==s.projection}):findIndex(i.TileMatrixSetLink,function(e,t,i){return e.TileMatrixSet==s.matrixSet}):0)<0&&(n=0);const r=i.TileMatrixSetLink[n].TileMatrixSet;t=i.TileMatrixSetLink[n].TileMatrixSetLimits;let o=i.Format[0];"format"in s&&(o=s.format),(n=findIndex(i.Style,function(e,t,i){return"style"in s?e.Title==s.style:e.isDefault}))<0&&(n=0);var l=i.Style[n].Identifier;const c={};"Dimension"in i&&i.Dimension.forEach(function(e,t,i){var n=e.Identifier;let r=e.Default;void 0===r&&(r=e.Value[0]),c[n]=r});var u=e.Contents.TileMatrixSet,u=find(u,function(e,t,i){return e.Identifier==r});let d;const m=u.SupportedCRS;m&&(d=getProjection(m.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"))||getProjection(m)),"projection"in s&&(!(g=getProjection(s.projection))||d&&!equivalent(g,d)||(d=g));var f,g=i.WGS84BoundingBox;let p,T;void 0!==g&&(f=getProjection("EPSG:4326").getExtent(),T=g[0]==f[0]&&g[2]==f[2],p=transformExtent(g,"EPSG:4326",d),(f=d.getExtent())&&!containsExtent(f,p)&&(p=void 0));g=createFromCapabilitiesMatrixSet(u,p,t);const h=[];let S=s.requestEncoding;if(S=void 0!==S?S:"","OperationsMetadata"in e&&"GetTile"in e.OperationsMetadata){var x=e.OperationsMetadata.GetTile.DCP.HTTP.Get;for(let e=0,t=x.length;e<t;++e)if(x[e].Constraint){var M=find(x[e].Constraint,function(e){return"GetEncoding"==e.name}).AllowedValues.Value;if((S=""===S?M[0]:S)!==WMTSRequestEncoding.KVP)break;includes(M,WMTSRequestEncoding.KVP)&&h.push(x[e].href)}else x[e].href&&(S=WMTSRequestEncoding.KVP,h.push(x[e].href))}return 0===h.length&&(S=WMTSRequestEncoding.REST,i.ResourceURL.forEach(function(e){"tile"===e.resourceType&&(o=e.format,h.push(e.template))})),{urls:h,layer:s.layer,matrixSet:r,format:o,projection:d,requestEncoding:S,tileGrid:g,style:l,dimensions:c,wrapX:T,crossOrigin:s.crossOrigin}}function createFromWMTSTemplate(r){const o=this.requestEncoding_,i={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_},s=(o==WMTSRequestEncoding.KVP&&assign(i,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),r=o==WMTSRequestEncoding.KVP?appendParams(r,i):r.replace(/\{(\w+?)\}/g,function(e,t){return t.toLowerCase()in i?i[t.toLowerCase()]:e}),this.tileGrid),a=this.dimensions_;return function(t,e,i){if(t){const n={TileMatrix:s.getMatrixId(t[0]),TileCol:t[1],TileRow:t[2]};assign(n,a);let e=r;return e=o==WMTSRequestEncoding.KVP?appendParams(e,n):e.replace(/\{(\w+?)\}/g,function(e,t){return n[t]})}}}export{optionsFromCapabilities};