import{ENABLE_RASTER_REPROJECTION}from"../reproj/common.js";import{getUid}from"../util.js";import ImageTile from"../ImageTile.js";import TileCache from"../TileCache.js";import TileState from"../TileState.js";import EventType from"../events/EventType.js";import{equivalent,get as getProjection}from"../proj.js";import ReprojTile from"../reproj/Tile.js";import UrlTile from"./UrlTile.js";import{getKey,getKeyZXY}from"../tilecoord.js";import{getForProjection as getTileGridForProjection}from"../tilegrid.js";class TileImage extends UrlTile{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,opaque:e.opaque,projection:e.projection,state:e.state,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction||defaultTileLoadFunction,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX,transition:e.transition,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection}),this.crossOrigin=void 0!==e.crossOrigin?e.crossOrigin:null,this.tileClass=void 0!==e.tileClass?e.tileClass:ImageTile,this.tileCacheForProjection={},this.tileGridForProjection={},this.reprojectionErrorThreshold_=e.reprojectionErrorThreshold,this.renderReprojectionEdges_=!1}canExpireCache(){if(!ENABLE_RASTER_REPROJECTION)return super.canExpireCache();if(this.tileCache.canExpireCache())return!0;for(const e in this.tileCacheForProjection)if(this.tileCacheForProjection[e].canExpireCache())return!0;return!1}expireCache(e,i){if(ENABLE_RASTER_REPROJECTION){var t=this.getTileCacheForProjection(e);this.tileCache.expireCache(this.tileCache==t?i:{});for(const r in this.tileCacheForProjection){const o=this.tileCacheForProjection[r];o.expireCache(o==t?i:{})}}else super.expireCache(e,i)}getGutterForProjection(e){return ENABLE_RASTER_REPROJECTION&&this.getProjection()&&e&&!equivalent(this.getProjection(),e)?0:this.getGutter()}getGutter(){return 0}getOpaque(e){return!(ENABLE_RASTER_REPROJECTION&&this.getProjection()&&e&&!equivalent(this.getProjection(),e))&&super.getOpaque(e)}getTileGridForProjection(e){if(!ENABLE_RASTER_REPROJECTION)return super.getTileGridForProjection(e);var i=this.getProjection();return!this.tileGrid||i&&!equivalent(i,e)?((i=getUid(e))in this.tileGridForProjection||(this.tileGridForProjection[i]=getTileGridForProjection(e)),this.tileGridForProjection[i]):this.tileGrid}getTileCacheForProjection(e){if(!ENABLE_RASTER_REPROJECTION)return super.getTileCacheForProjection(e);var i=this.getProjection();return!i||equivalent(i,e)?this.tileCache:((i=getUid(e))in this.tileCacheForProjection||(this.tileCacheForProjection[i]=new TileCache(this.tileCache.highWaterMark)),this.tileCacheForProjection[i])}createTile_(e,i,t,r,o,n){e=[e,i,t],i=this.getTileCoordForTileUrlFunction(e,o),t=i?this.tileUrlFunction(i,r,o):void 0;const s=new this.tileClass(e,void 0!==t?TileState.IDLE:TileState.EMPTY,void 0!==t?t:"",this.crossOrigin,this.tileLoadFunction,this.tileOptions);return s.key=n,s.addEventListener(EventType.CHANGE,this.handleTileChange.bind(this)),s}getTile(i,t,r,o,n){const s=this.getProjection();if(ENABLE_RASTER_REPROJECTION&&s&&n&&!equivalent(s,n)){const g=this.getTileCacheForProjection(n);var l=[i,t,r];let e;var c=getKey(l),a=(g.containsKey(c)&&(e=g.get(c)),this.getKey());if(e&&e.key==a)return e;{var h=this.getTileGridForProjection(s),T=this.getTileGridForProjection(n),E=this.getTileCoordForTileUrlFunction(l,n);const j=new ReprojTile(s,h,n,T,l,E,this.getTilePixelRatio(o),this.getGutter(),function(e,i,t,r){return this.getTileInternal(e,i,t,r,s)}.bind(this),this.reprojectionErrorThreshold_,this.renderReprojectionEdges_);return j.key=a,e?(j.interimTile=e,j.refreshInterimChain(),g.replace(c,j)):g.set(c,j),j}}return this.getTileInternal(i,t,r,o,s||n)}getTileInternal(e,i,t,r,o){let n=null;var s=getKeyZXY(e,i,t),l=this.getKey();if(this.tileCache.containsKey(s)){if((n=this.tileCache.get(s)).key!=l){const c=n;n=this.createTile_(e,i,t,r,o,l),c.getState()==TileState.IDLE?n.interimTile=c.interimTile:n.interimTile=c,n.refreshInterimChain(),this.tileCache.replace(s,n)}}else n=this.createTile_(e,i,t,r,o,l),this.tileCache.set(s,n);return n}setRenderReprojectionEdges(e){if(ENABLE_RASTER_REPROJECTION&&this.renderReprojectionEdges_!=e){this.renderReprojectionEdges_=e;for(const i in this.tileCacheForProjection)this.tileCacheForProjection[i].clear();this.changed()}}setTileGridForProjection(e,i){!ENABLE_RASTER_REPROJECTION||!(e=getProjection(e))||(e=getUid(e))in this.tileGridForProjection||(this.tileGridForProjection[e]=i)}}function defaultTileLoadFunction(e,i){e.getImage().src=i}export default TileImage;