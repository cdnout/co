import{DEFAULT_TILE_SIZE}from"./common.js";import{assert}from"../asserts.js";import TileRange,{createOrUpdate as createOrUpdateTileRange}from"../TileRange.js";import{isSorted,linearFindNearest}from"../array.js";import{createOrUpdate,getTopLeft}from"../extent.js";import{clamp}from"../math.js";import{toSize}from"../size.js";import{createOrUpdate as createOrUpdateTileCoord}from"../tilecoord.js";const tmpTileCoord=[0,0,0];class TileGrid{constructor(t){this.minZoom=void 0!==t.minZoom?t.minZoom:0,this.resolutions_=t.resolutions,assert(isSorted(this.resolutions_,function(t,e){return e-t},!0),17);let i;if(!t.origins)for(let t=0,e=this.resolutions_.length-1;t<e;++t)if(i){if(this.resolutions_[t]/this.resolutions_[t+1]!==i){i=void 0;break}}else i=this.resolutions_[t]/this.resolutions_[t+1];this.zoomFactor_=i,this.maxZoom=this.resolutions_.length-1,this.origin_=void 0!==t.origin?t.origin:null,this.origins_=null,void 0!==t.origins&&(this.origins_=t.origins,assert(this.origins_.length==this.resolutions_.length,20));var e=t.extent;void 0===e||this.origin_||this.origins_||(this.origin_=getTopLeft(e)),assert(!this.origin_&&this.origins_||this.origin_&&!this.origins_,18),this.tileSizes_=null,void 0!==t.tileSizes&&(this.tileSizes_=t.tileSizes,assert(this.tileSizes_.length==this.resolutions_.length,19)),this.tileSize_=void 0!==t.tileSize?t.tileSize:this.tileSizes_?null:DEFAULT_TILE_SIZE,assert(!this.tileSize_&&this.tileSizes_||this.tileSize_&&!this.tileSizes_,22),this.extent_=void 0!==e?e:null,this.fullTileRanges_=null,this.tmpSize_=[0,0],void 0!==t.sizes?this.fullTileRanges_=t.sizes.map(function(t,e){return new TileRange(Math.min(0,t[0]),Math.max(t[0]-1,-1),Math.min(0,t[1]),Math.max(t[1]-1,-1))},this):e&&this.calculateTileRanges_(e)}forEachTileCoord(t,o,r){var s=this.getTileRangeForExtentAndZ(t,o);for(let i=s.minX,t=s.maxX;i<=t;++i)for(let t=s.minY,e=s.maxY;t<=e;++t)r([o,i,t])}forEachTileCoordParentTileRange(t,e,i,o){let r,s,n,l=null,h=t[0]-1;for(2===this.zoomFactor_?(s=t[1],n=t[2]):l=this.getTileCoordExtent(t,o);h>=this.minZoom;){if(r=2===this.zoomFactor_?(s=Math.floor(s/2),n=Math.floor(n/2),createOrUpdateTileRange(s,s,n,n,i)):this.getTileRangeForExtentAndZ(l,h,i),e(h,r))return!0;--h}return!1}getExtent(){return this.extent_}getMaxZoom(){return this.maxZoom}getMinZoom(){return this.minZoom}getOrigin(t){return this.origin_||this.origins_[t]}getResolution(t){return this.resolutions_[t]}getResolutions(){return this.resolutions_}getTileCoordChildTileRange(t,e,i){if(t[0]<this.maxZoom){var o;if(2===this.zoomFactor_)return r=2*t[1],o=2*t[2],createOrUpdateTileRange(r,1+r,o,1+o,e);var r=this.getTileCoordExtent(t,i);return this.getTileRangeForExtentAndZ(r,t[0]+1,e)}return null}getTileRangeExtent(t,e,i){var o=this.getOrigin(t),r=this.getResolution(t),t=toSize(this.getTileSize(t),this.tmpSize_),s=o[0]+e.minX*t[0]*r,n=o[0]+(e.maxX+1)*t[0]*r,l=o[1]+e.minY*t[1]*r,o=o[1]+(e.maxY+1)*t[1]*r;return createOrUpdate(s,l,n,o,i)}getTileRangeForExtentAndZ(t,e,i){var o=tmpTileCoord,r=(this.getTileCoordForXYAndZ_(t[0],t[3],e,!1,o),o[1]),s=o[2];return this.getTileCoordForXYAndZ_(t[2],t[1],e,!0,o),createOrUpdateTileRange(r,o[1],s,o[2],i)}getTileCoordCenter(t){var e=this.getOrigin(t[0]),i=this.getResolution(t[0]),o=toSize(this.getTileSize(t[0]),this.tmpSize_);return[e[0]+(t[1]+.5)*o[0]*i,e[1]-(t[2]+.5)*o[1]*i]}getTileCoordExtent(t,e){var i=this.getOrigin(t[0]),o=this.getResolution(t[0]),r=toSize(this.getTileSize(t[0]),this.tmpSize_),s=i[0]+t[1]*r[0]*o,i=i[1]-(t[2]+1)*r[1]*o,t=s+r[0]*o,r=i+r[1]*o;return createOrUpdate(s,i,t,r,e)}getTileCoordForCoordAndResolution(t,e,i){return this.getTileCoordForXYAndResolution_(t[0],t[1],e,!1,i)}getTileCoordForXYAndResolution_(t,e,i,o,r){var s=this.getZForResolution(i),n=i/this.getResolution(s),l=this.getOrigin(s),h=toSize(this.getTileSize(s),this.tmpSize_),a=o?.5:0,t=Math.floor((t-l[0])/i+(o?.5:0)),l=Math.floor((l[1]-e)/i+a);let g=n*t/h[0],u=n*l/h[1];return u=o?(g=Math.ceil(g)-1,Math.ceil(u)-1):(g=Math.floor(g),Math.floor(u)),createOrUpdateTileCoord(s,g,u,r)}getTileCoordForXYAndZ_(t,e,i,o,r){var s=this.getOrigin(i),n=this.getResolution(i),l=toSize(this.getTileSize(i),this.tmpSize_),h=o?.5:0,t=Math.floor((t-s[0])/n+(o?.5:0)),s=Math.floor((s[1]-e)/n+h);let a=t/l[0],g=s/l[1];return g=o?(a=Math.ceil(a)-1,Math.ceil(g)-1):(a=Math.floor(a),Math.floor(g)),createOrUpdateTileCoord(i,a,g,r)}getTileCoordForCoordAndZ(t,e,i){return this.getTileCoordForXYAndZ_(t[0],t[1],e,!1,i)}getTileCoordResolution(t){return this.resolutions_[t[0]]}getTileSize(t){return this.tileSize_||this.tileSizes_[t]}getFullTileRange(t){return this.fullTileRanges_?this.fullTileRanges_[t]:null}getZForResolution(t,e){t=linearFindNearest(this.resolutions_,t,e||0);return clamp(t,this.minZoom,this.maxZoom)}calculateTileRanges_(e){var i=this.resolutions_.length;const o=new Array(i);for(let t=this.minZoom;t<i;++t)o[t]=this.getTileRangeForExtentAndZ(e,t);this.fullTileRanges_=o}}export default TileGrid;