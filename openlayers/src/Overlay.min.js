import MapEventType from"./MapEventType.js";import BaseObject,{getChangeEventType}from"./Object.js";import OverlayPositioning from"./OverlayPositioning.js";import{CLASS_SELECTABLE}from"./css.js";import{removeNode,removeChildren,outerWidth,outerHeight}from"./dom.js";import{listen,unlistenByKey}from"./events.js";import{containsExtent}from"./extent.js";const Property={ELEMENT:"element",MAP:"map",OFFSET:"offset",POSITION:"position",POSITIONING:"positioning"};class Overlay extends BaseObject{constructor(e){super(),this.options=e,this.id=e.id,this.insertFirst=void 0===e.insertFirst||e.insertFirst,this.stopEvent=void 0===e.stopEvent||e.stopEvent,this.element=document.createElement("div"),this.element.className=void 0!==e.className?e.className:"ol-overlay-container "+CLASS_SELECTABLE,this.element.style.position="absolute",this.autoPan=void 0!==e.autoPan&&e.autoPan,this.autoPanAnimation=e.autoPanAnimation||{},this.autoPanMargin=void 0!==e.autoPanMargin?e.autoPanMargin:20,this.rendered={bottom_:"",left_:"",right_:"",top_:"",visible:!0},this.mapPostrenderListenerKey=null,this.addEventListener(getChangeEventType(Property.ELEMENT),this.handleElementChanged),this.addEventListener(getChangeEventType(Property.MAP),this.handleMapChanged),this.addEventListener(getChangeEventType(Property.OFFSET),this.handleOffsetChanged),this.addEventListener(getChangeEventType(Property.POSITION),this.handlePositionChanged),this.addEventListener(getChangeEventType(Property.POSITIONING),this.handlePositioningChanged),void 0!==e.element&&this.setElement(e.element),this.setOffset(void 0!==e.offset?e.offset:[0,0]),this.setPositioning(void 0!==e.positioning?e.positioning:OverlayPositioning.TOP_LEFT),void 0!==e.position&&this.setPosition(e.position)}getElement(){return this.get(Property.ELEMENT)}getId(){return this.id}getMap(){return this.get(Property.MAP)}getOffset(){return this.get(Property.OFFSET)}getPosition(){return this.get(Property.POSITION)}getPositioning(){return this.get(Property.POSITIONING)}handleElementChanged(){removeChildren(this.element);var e=this.getElement();e&&this.element.appendChild(e)}handleMapChanged(){this.mapPostrenderListenerKey&&(removeNode(this.element),unlistenByKey(this.mapPostrenderListenerKey),this.mapPostrenderListenerKey=null);const e=this.getMap();if(e){this.mapPostrenderListenerKey=listen(e,MapEventType.POSTRENDER,this.render,this),this.updatePixelPosition();const t=this.stopEvent?e.getOverlayContainerStopEvent():e.getOverlayContainer();this.insertFirst?t.insertBefore(this.element,t.childNodes[0]||null):t.appendChild(this.element)}}render(){this.updatePixelPosition()}handleOffsetChanged(){this.updatePixelPosition()}handlePositionChanged(){this.updatePixelPosition(),this.get(Property.POSITION)&&this.autoPan&&this.panIntoView()}handlePositioningChanged(){this.updatePixelPosition()}setElement(e){this.set(Property.ELEMENT,e)}setMap(e){this.set(Property.MAP,e)}setOffset(e){this.set(Property.OFFSET,e)}setPosition(e){this.set(Property.POSITION,e)}panIntoView(){const e=this.getMap();if(e&&e.getTargetElement()){var t=this.getRect(e.getTargetElement(),e.getSize()),i=this.getElement(),i=this.getRect(i,[outerWidth(i),outerHeight(i)]),n=this.autoPanMargin;if(!containsExtent(t,i)){var s=i[0]-t[0],o=t[2]-i[2],r=i[1]-t[1],t=t[3]-i[3];const a=[0,0];s<0?a[0]=s-n:o<0&&(a[0]=Math.abs(o)+n),r<0?a[1]=r-n:t<0&&(a[1]=Math.abs(t)+n),0===a[0]&&0===a[1]||(i=e.getView().getCenterInternal(),o=[(s=e.getPixelFromCoordinate(i))[0]+a[0],s[1]+a[1]],e.getView().animateInternal({center:e.getCoordinateFromPixel(o),duration:this.autoPanAnimation.duration,easing:this.autoPanAnimation.easing}))}}}getRect(e,t){var e=e.getBoundingClientRect(),i=e.left+window.pageXOffset,e=e.top+window.pageYOffset;return[i,e,i+t[0],e+t[1]]}setPositioning(e){this.set(Property.POSITIONING,e)}setVisible(e){this.rendered.visible!==e&&(this.element.style.display=e?"":"none",this.rendered.visible=e)}updatePixelPosition(){const e=this.getMap();var t,i=this.getPosition();e&&e.isRendered()&&i?(i=e.getPixelFromCoordinate(i),t=e.getSize(),this.updateRenderedPosition(i,t)):this.setVisible(!1)}updateRenderedPosition(e,t){const i=this.element.style;var n=this.getOffset(),s=this.getPositioning();this.setVisible(!0);let o=n[0],r=n[1];s==OverlayPositioning.BOTTOM_RIGHT||s==OverlayPositioning.CENTER_RIGHT||s==OverlayPositioning.TOP_RIGHT?(""!==this.rendered.left_&&(this.rendered.left_=i.left=""),n=Math.round(t[0]-e[0]-o)+"px",this.rendered.right_!=n&&(this.rendered.right_=i.right=n)):(""!==this.rendered.right_&&(this.rendered.right_=i.right=""),s!=OverlayPositioning.BOTTOM_CENTER&&s!=OverlayPositioning.CENTER_CENTER&&s!=OverlayPositioning.TOP_CENTER||(o-=this.element.offsetWidth/2),n=Math.round(e[0]+o)+"px",this.rendered.left_!=n&&(this.rendered.left_=i.left=n)),s==OverlayPositioning.BOTTOM_LEFT||s==OverlayPositioning.BOTTOM_CENTER||s==OverlayPositioning.BOTTOM_RIGHT?(""!==this.rendered.top_&&(this.rendered.top_=i.top=""),n=Math.round(t[1]-e[1]-r)+"px",this.rendered.bottom_!=n&&(this.rendered.bottom_=i.bottom=n)):(""!==this.rendered.bottom_&&(this.rendered.bottom_=i.bottom=""),s!=OverlayPositioning.CENTER_LEFT&&s!=OverlayPositioning.CENTER_CENTER&&s!=OverlayPositioning.CENTER_RIGHT||(r-=this.element.offsetHeight/2),t=Math.round(e[1]+r)+"px",this.rendered.top_!=t&&(this.rendered.top_=i.top=t))}getOptions(){return this.options}}export default Overlay;