import PluggableMap from"../PluggableMap.js";import CompositeMapRenderer from"../renderer/Composite.js";import MapEventType from"../MapEventType.js";import MapProperty from"../MapProperty.js";import{getChangeEventType}from"../Object.js";import ObjectEventType from"../ObjectEventType.js";import Overlay from"../Overlay.js";import OverlayPositioning from"../OverlayPositioning.js";import ViewProperty from"../ViewProperty.js";import Control from"./Control.js";import{fromExtent as polygonFromExtent}from"../geom/Polygon.js";import{CLASS_CONTROL,CLASS_UNSELECTABLE,CLASS_COLLAPSED}from"../css.js";import{replaceNode}from"../dom.js";import{listen,listenOnce}from"../events.js";import EventType from"../events/EventType.js";import{containsExtent,equals as equalsExtent,getBottomRight,getTopLeft,scaleFromCenter}from"../extent.js";const MAX_RATIO=.75,MIN_RATIO=.1;class ControlledMap extends PluggableMap{createRenderer(){return new CompositeMapRenderer(this)}}class OverviewMap extends Control{constructor(e){const t=e||{};super({element:document.createElement("div"),render:t.render||render,target:t.target}),this.boundHandleRotationChanged_=this.handleRotationChanged_.bind(this),this.collapsed_=void 0===t.collapsed||t.collapsed,this.collapsible_=void 0===t.collapsible||t.collapsible,this.collapsible_||(this.collapsed_=!1),this.rotateWithView_=void 0!==t.rotateWithView&&t.rotateWithView;var e=(this.viewExtent_=void 0)!==t.className?t.className:"ol-overviewmap",i=void 0!==t.tipLabel?t.tipLabel:"Overview map",o=void 0!==t.collapseLabel?t.collapseLabel:"«",o=("string"==typeof o?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=o):this.collapseLabel_=o,void 0!==t.label?t.label:"»"),o=("string"==typeof o?(this.label_=document.createElement("span"),this.label_.textContent=o):this.label_=o,this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_);const s=document.createElement("button"),a=(s.setAttribute("type","button"),s.title=i,s.appendChild(o),s.addEventListener(EventType.CLICK,this.handleClick_.bind(this),!1),this.ovmapDiv_=document.createElement("div"),this.ovmapDiv_.className="ol-overviewmap-map",this.ovmap_=new ControlledMap({view:t.view}),this.ovmap_),n=(t.layers&&t.layers.forEach(function(e){a.addLayer(e)}),document.createElement("div"));n.className="ol-overviewmap-box",n.style.boxSizing="border-box",this.boxOverlay_=new Overlay({position:[0,0],positioning:OverlayPositioning.CENTER_CENTER,element:n}),this.ovmap_.addOverlay(this.boxOverlay_);i=e+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(this.collapsed_&&this.collapsible_?" "+CLASS_COLLAPSED:"")+(this.collapsible_?"":" ol-uncollapsible");const l=this.element,r=(l.className=i,l.appendChild(this.ovmapDiv_),l.appendChild(s),this),p=this.boxOverlay_,h=this.boxOverlay_.getElement(),d=function(e){return{clientX:e.clientX-h.offsetWidth/2,clientY:e.clientY+h.offsetHeight/2}},_=function(e){e=d(e),e=a.getEventCoordinate(e);p.setPosition(e)},v=function(e){e=a.getEventCoordinate(e);r.getMap().getView().setCenterInternal(e),window.removeEventListener("mousemove",_),window.removeEventListener("mouseup",v)};h.addEventListener("mousedown",function(){window.addEventListener("mousemove",_),window.addEventListener("mouseup",v)})}setMap(e){const t=this.getMap();var i;if(e!==t&&(t&&((i=t.getView())&&this.unbindView_(i),this.ovmap_.setTarget(null)),super.setMap(e),e)){this.ovmap_.setTarget(this.ovmapDiv_),this.listenerKeys.push(listen(e,ObjectEventType.PROPERTYCHANGE,this.handleMapPropertyChange_,this));const o=e.getView();o&&(this.bindView_(o),o.isDef()&&(this.ovmap_.updateSize(),this.resetExtent_()))}}handleMapPropertyChange_(e){e.key===MapProperty.VIEW&&((e=e.oldValue)&&this.unbindView_(e),e=this.getMap().getView(),this.bindView_(e))}bindView_(e){e.addEventListener(getChangeEventType(ViewProperty.ROTATION),this.boundHandleRotationChanged_)}unbindView_(e){e.removeEventListener(getChangeEventType(ViewProperty.ROTATION),this.boundHandleRotationChanged_)}handleRotationChanged_(){this.rotateWithView_&&this.ovmap_.getView().setRotation(this.getMap().getView().getRotation())}validateExtent_(){const e=this.getMap(),t=this.ovmap_;if(e.isRendered()&&t.isRendered()){var i=e.getSize();const r=e.getView();i=r.calculateExtentInternal(i);if(!this.viewExtent_||!equalsExtent(i,this.viewExtent_)){this.viewExtent_=i;var o=t.getSize();const p=t.getView();var s=p.calculateExtentInternal(o),a=t.getPixelFromCoordinate(getTopLeft(i)),n=t.getPixelFromCoordinate(getBottomRight(i)),l=Math.abs(a[0]-n[0]),a=Math.abs(a[1]-n[1]),n=o[0],o=o[1];l<n*MIN_RATIO||a<o*MIN_RATIO||l>n*MAX_RATIO||a>o*MAX_RATIO?this.resetExtent_():containsExtent(s,i)||this.recenter_()}}}resetExtent_(){if(0!==MAX_RATIO&&0!==MIN_RATIO){const i=this.getMap(),o=this.ovmap_;var e=i.getSize();const s=i.getView();e=s.calculateExtentInternal(e);const a=o.getView();var t=Math.log(MAX_RATIO/MIN_RATIO)/Math.LN2,t=1/(Math.pow(2,t/2)*MIN_RATIO);scaleFromCenter(e,t),a.fitInternal(polygonFromExtent(e))}}recenter_(){const e=this.getMap(),t=this.ovmap_,i=e.getView(),o=t.getView();o.setCenterInternal(i.getCenterInternal())}updateBox_(){const e=this.getMap(),t=this.ovmap_;if(e.isRendered()&&t.isRendered()){var i=e.getSize();const r=e.getView(),p=t.getView();var o=this.rotateWithView_?0:-r.getRotation();const h=this.boxOverlay_,d=this.boxOverlay_.getElement();var s=r.getCenterInternal(),a=r.getResolution(),n=p.getResolution(),l=i[0]*a/n,i=i[1]*a/n;h.setPosition(s),d&&(d.style.width=l+"px",d.style.height=i+"px",a="rotate("+o+"rad)",d.style.msTransform=a,d.style.webkitTransform=a,d.style.transform=a)}}handleClick_(e){e.preventDefault(),this.handleToggle_()}handleToggle_(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_;const e=this.ovmap_;if(!this.collapsed_){if(e.isRendered())return this.viewExtent_=void 0,void e.render();e.updateSize(),this.resetExtent_(),listenOnce(e,MapEventType.POSTRENDER,function(e){this.updateBox_()},this)}}getCollapsible(){return this.collapsible_}setCollapsible(e){this.collapsible_!==e&&(this.collapsible_=e,this.element.classList.toggle("ol-uncollapsible"),!e&&this.collapsed_&&this.handleToggle_())}setCollapsed(e){this.collapsible_&&this.collapsed_!==e&&this.handleToggle_()}getCollapsed(){return this.collapsed_}getRotateWithView(){return this.rotateWithView_}setRotateWithView(e){this.rotateWithView_!==e&&(this.rotateWithView_=e,0!==this.getMap().getView().getRotation()&&(this.rotateWithView_?this.handleRotationChanged_():this.ovmap_.getView().setRotation(0),this.viewExtent_=void 0,this.validateExtent_(),this.updateBox_()))}getOverviewMap(){return this.ovmap_}}function render(e){this.validateExtent_(),this.updateBox_()}export default OverviewMap;export{render};