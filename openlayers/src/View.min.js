import{DEFAULT_TILE_SIZE}from"./tilegrid/common.js";import{getUid}from"./util.js";import{VOID}from"./functions.js";import{createExtent,none as centerNone}from"./centerconstraint.js";import BaseObject from"./Object.js";import{createSnapToResolutions,createSnapToPower}from"./resolutionconstraint.js";import{createSnapToZero,createSnapToN,none as rotationNone,disable}from"./rotationconstraint.js";import ViewHint from"./ViewHint.js";import ViewProperty from"./ViewProperty.js";import{linearFindNearest}from"./array.js";import{assert}from"./asserts.js";import{add as addCoordinate,rotate as rotateCoordinate,equals as coordinatesEqual}from"./coordinate.js";import{inAndOut}from"./easing.js";import{getForViewAndSize,getCenter,getHeight,getWidth,isEmpty}from"./extent.js";import GeometryType from"./geom/GeometryType.js";import{fromExtent as polygonFromExtent}from"./geom/Polygon.js";import{clamp,modulo}from"./math.js";import{assign}from"./obj.js";import{createProjection,METERS_PER_UNIT,toUserCoordinate,toUserExtent,fromUserCoordinate,fromUserExtent,getUserProjection}from"./proj.js";import Units from"./proj/Units.js";import{equals}from"./coordinate.js";import{easeOut}from"./easing.js";import{createMinMaxResolution}from"./resolutionconstraint.js";const DEFAULT_MIN_ZOOM=0;class View extends BaseObject{constructor(t){super();const e=assign({},t);this.hints_=[0,0],this.animations_=[],this.updateAnimationKey_,this.projection_=createProjection(e.projection,"EPSG:3857"),this.targetCenter_=null,this.targetResolution_,this.targetRotation_,e.center&&(e.center=fromUserCoordinate(e.center,this.projection_)),e.extent&&(e.extent=fromUserExtent(e.extent,this.projection_)),this.applyOptions_(e)}applyOptions_(t){var e=createResolutionConstraint(t),o=(this.maxResolution_=e.maxResolution,this.minResolution_=e.minResolution,this.zoomFactor_=e.zoomFactor,this.resolutions_=t.resolutions,this.minZoom_=e.minZoom,createCenterConstraint(t)),e=e.constraint,i=createRotationConstraint(t);this.constraints_={center:o,resolution:e,rotation:i},this.setRotation(void 0!==t.rotation?t.rotation:0),this.setCenterInternal(void 0!==t.center?t.center:null),void 0!==t.resolution?this.setResolution(t.resolution):void 0!==t.zoom&&this.setZoom(t.zoom),this.resolveConstraints(0),this.setProperties({}),this.options_=t}getUpdatedOptions_(t){const e=assign({},this.options_);return void 0!==e.resolution?e.resolution=this.getResolution():e.zoom=this.getZoom(),e.center=this.getCenterInternal(),e.rotation=this.getRotation(),assign({},e,t)}animate(t){this.isDef()&&!this.getAnimating()&&this.resolveConstraints(0);const o=new Array(arguments.length);for(let e=0;e<o.length;++e){let t=arguments[e];t.center&&((t=assign({},t)).center=fromUserCoordinate(t.center,this.getProjection())),t.anchor&&((t=assign({},t)).anchor=fromUserCoordinate(t.anchor,this.getProjection())),o[e]=t}this.animateInternal.apply(this,o)}animateInternal(t){let e=arguments.length,o;var i,n;if(1<e&&"function"==typeof arguments[e-1]&&(o=arguments[e-1],--e),!this.isDef())return(i=arguments[e-1]).center&&this.setCenterInternal(i.center),void 0!==i.zoom&&this.setZoom(i.zoom),void 0!==i.rotation&&this.setRotation(i.rotation),void(o&&animationCallback(o,!0));let r=Date.now(),s=this.targetCenter_.slice(),a=this.targetResolution_,h=this.targetRotation_;const l=[];for(let t=0;t<e;++t){const u=arguments[t],g={start:r,complete:!1,anchor:u.anchor,duration:void 0!==u.duration?u.duration:1e3,easing:u.easing||inAndOut,callback:o};u.center&&(g.sourceCenter=s,g.targetCenter=u.center.slice(),s=g.targetCenter),void 0!==u.zoom?(g.sourceResolution=a,g.targetResolution=this.getResolutionForZoom(u.zoom),a=g.targetResolution):u.resolution&&(g.sourceResolution=a,g.targetResolution=u.resolution,a=g.targetResolution),void 0!==u.rotation&&(g.sourceRotation=h,n=modulo(u.rotation-h+Math.PI,2*Math.PI)-Math.PI,g.targetRotation=h+n,h=g.targetRotation),isNoopAnimation(g)?g.complete=!0:r+=g.duration,l.push(g)}this.animations_.push(l),this.setHint(ViewHint.ANIMATING,1),this.updateAnimations_()}getAnimating(){return 0<this.hints_[ViewHint.ANIMATING]}getInteracting(){return 0<this.hints_[ViewHint.INTERACTING]}cancelAnimations(){this.setHint(ViewHint.ANIMATING,-this.hints_[ViewHint.ANIMATING]);for(let t=0,e=this.animations_.length;t<e;++t){var o=this.animations_[t];o[0].callback&&animationCallback(o[0].callback,!1)}this.animations_.length=0}updateAnimations_(){if(void 0!==this.updateAnimationKey_&&(cancelAnimationFrame(this.updateAnimationKey_),this.updateAnimationKey_=void 0),this.getAnimating()){var n=Date.now();let i=!1;for(let t=this.animations_.length-1;0<=t;--t){var e,r=this.animations_[t];let o=!0;for(let t=0,e=r.length;t<e;++t){const g=r[t];if(!g.complete){var s=n-g.start;let t=0<g.duration?s/g.duration:1;1<=t?(g.complete=!0,t=1):o=!1;var a,h,l,u,s=g.easing(t);if(g.sourceCenter&&(h=g.sourceCenter[0],u=g.sourceCenter[1],a=g.targetCenter[0],l=g.targetCenter[1],this.targetCenter_=[h+s*(a-h),u+s*(l-u)]),g.sourceResolution&&g.targetResolution&&(a=1===s?g.targetResolution:g.sourceResolution+s*(g.targetResolution-g.sourceResolution),g.anchor&&(h=this.getSizeFromViewport_(this.getRotation()),l=this.constraints_.resolution(a,0,h,!0),this.targetCenter_=this.calculateCenterZoom(l,g.anchor)),this.targetResolution_=a,this.applyTargetState_(!0)),void 0!==g.sourceRotation&&void 0!==g.targetRotation&&(u=1===s?modulo(g.targetRotation+Math.PI,2*Math.PI)-Math.PI:g.sourceRotation+s*(g.targetRotation-g.sourceRotation),g.anchor&&(s=this.constraints_.rotation(u,!0),this.targetCenter_=this.calculateCenterRotate(s,g.anchor)),this.targetRotation_=u),this.applyTargetState_(!0),i=!0,!g.complete)break}}o&&(this.animations_[t]=null,this.setHint(ViewHint.ANIMATING,-1),(e=r[0].callback)&&animationCallback(e,!0))}this.animations_=this.animations_.filter(Boolean),i&&void 0===this.updateAnimationKey_&&(this.updateAnimationKey_=requestAnimationFrame(this.updateAnimations_.bind(this)))}}calculateCenterRotate(t,e){let o;var i=this.getCenterInternal();return void 0!==i&&(o=[i[0]-e[0],i[1]-e[1]],rotateCoordinate(o,t-this.getRotation()),addCoordinate(o,e)),o}calculateCenterZoom(t,e){let o;var i,n=this.getCenterInternal(),r=this.getResolution();return void 0!==n&&void 0!==r&&(i=e[0]-t*(e[0]-n[0])/r,t=e[1]-t*(e[1]-n[1])/r,o=[i,t]),o}getSizeFromViewport_(t){const e=[100,100];var o,i='.ol-viewport[data-view="'+getUid(this)+'"]',i=document.querySelector(i);return i&&(i=getComputedStyle(i),e[0]=parseInt(i.width,10),e[1]=parseInt(i.height,10)),t&&(i=e[0],o=e[1],e[0]=Math.abs(i*Math.cos(t))+Math.abs(o*Math.sin(t)),e[1]=Math.abs(i*Math.sin(t))+Math.abs(o*Math.cos(t))),e}getCenter(){var t=this.getCenterInternal();return t&&toUserCoordinate(t,this.getProjection())}getCenterInternal(){return this.get(ViewProperty.CENTER)}getConstraints(){return this.constraints_}getHints(t){return void 0!==t?(t[0]=this.hints_[0],t[1]=this.hints_[1],t):this.hints_.slice()}calculateExtent(t){t=this.calculateExtentInternal(t);return toUserExtent(t,this.getProjection())}calculateExtentInternal(t){var t=t||this.getSizeFromViewport_(),e=this.getCenterInternal(),o=(assert(e,1),this.getResolution()),i=(assert(void 0!==o,2),this.getRotation());return assert(void 0!==i,3),getForViewAndSize(e,o,i,t)}getMaxResolution(){return this.maxResolution_}getMinResolution(){return this.minResolution_}getMaxZoom(){return this.getZoomForResolution(this.minResolution_)}setMaxZoom(t){this.applyOptions_(this.getUpdatedOptions_({maxZoom:t}))}getMinZoom(){return this.getZoomForResolution(this.maxResolution_)}setMinZoom(t){this.applyOptions_(this.getUpdatedOptions_({minZoom:t}))}setConstrainResolution(t){this.applyOptions_(this.getUpdatedOptions_({constrainResolution:t}))}getProjection(){return this.projection_}getResolution(){return this.get(ViewProperty.RESOLUTION)}getResolutions(){return this.resolutions_}getResolutionForExtent(t,e){return this.getResolutionForExtentInternal(fromUserExtent(t,this.getProjection()),e)}getResolutionForExtentInternal(t,e){var e=e||this.getSizeFromViewport_(),o=getWidth(t)/e[0],t=getHeight(t)/e[1];return Math.max(o,t)}getResolutionForValueFunction(t){const e=t||2,o=this.maxResolution_;t=this.minResolution_;const i=Math.log(o/t)/Math.log(e);return function(t){return o/Math.pow(e,t*i)}}getRotation(){return this.get(ViewProperty.ROTATION)}getValueForResolutionFunction(t){const e=t||2,o=this.maxResolution_;t=this.minResolution_;const i=Math.log(o/t)/Math.log(e);return function(t){return Math.log(o/t)/Math.log(e)/i}}getState(){const t=this.getCenterInternal();var e=this.getProjection(),o=this.getResolution(),i=this.getRotation();return{center:t.slice(0),projection:void 0!==e?e:null,resolution:o,rotation:i,zoom:this.getZoom()}}getZoom(){let t;var e=this.getResolution();return t=void 0!==e?this.getZoomForResolution(e):t}getZoomForResolution(t){let e=this.minZoom_||0,o,i;var n;return i=this.resolutions_?(n=linearFindNearest(this.resolutions_,t,1),e=n,o=this.resolutions_[n],n==this.resolutions_.length-1?2:o/this.resolutions_[n+1]):(o=this.maxResolution_,this.zoomFactor_),e+Math.log(o/t)/Math.log(i)}getResolutionForZoom(t){if(this.resolutions_){if(this.resolutions_.length<=1)return 0;var e=clamp(Math.floor(t),0,this.resolutions_.length-2),o=this.resolutions_[e]/this.resolutions_[e+1];return this.resolutions_[e]/Math.pow(o,clamp(t-e,0,1))}return this.maxResolution_/Math.pow(this.zoomFactor_,t-this.minZoom_)}fit(t,e){var o,e=assign({size:this.getSizeFromViewport_()},e||{});let i;assert(Array.isArray(t)||"function"==typeof t.getSimplifiedGeometry,24),Array.isArray(t)?(assert(!isEmpty(t),25),o=fromUserExtent(t,this.getProjection()),i=polygonFromExtent(o)):t.getType()===GeometryType.CIRCLE?(o=fromUserExtent(t.getExtent(),this.getProjection()),(i=polygonFromExtent(o)).rotate(this.getRotation(),getCenter(o))):(o=getUserProjection(),i=o?i.clone().transform(o,this.getProjection()):t),this.fitInternal(i,e)}fitInternal(t,e){e=e||{};let o=e.size;o=o||this.getSizeFromViewport_();var i=void 0!==e.padding?e.padding:[0,0,0,0],n=void 0!==e.nearest&&e.nearest;let r;r=void 0!==e.minResolution?e.minResolution:void 0!==e.maxZoom?this.getResolutionForZoom(e.maxZoom):0;var s=t.getFlatCoordinates(),a=this.getRotation(),h=Math.cos(-a);let l=Math.sin(-a),u=1/0,g=1/0,m=-1/0,c=-1/0;var p=t.getStride();for(let t=0,e=s.length;t<e;t+=p){var R=s[t]*h-s[t+1]*l,_=s[t]*l+s[t+1]*h;u=Math.min(u,R),g=Math.min(g,_),m=Math.max(m,R),c=Math.max(c,_)}let d=this.getResolutionForExtentInternal([u,g,m,c],[o[0]-i[1]-i[3],o[1]-i[0]-i[2]]);d=isNaN(d)?r:Math.max(d,r),d=this.getConstrainedResolution(d,n?0:1),l=-l;a=(u+m)/2,t=(g+c)/2,n=[(a+=(i[1]-i[3])/2*d)*h-(t+=(i[0]-i[2])/2*d)*l,t*h+a*l],i=e.callback||VOID;void 0!==e.duration?this.animateInternal({resolution:d,center:this.getConstrainedCenter(n,d),duration:e.duration,easing:e.easing},i):(this.targetResolution_=d,this.targetCenter_=n,this.applyTargetState_(!1,!0),animationCallback(i,!0))}centerOn(t,e,o){this.centerOnInternal(fromUserCoordinate(t,this.getProjection()),e,o)}centerOnInternal(t,e,o){var i=this.getRotation(),n=Math.cos(-i),i=Math.sin(-i),r=t[0]*n-t[1]*i,t=t[1]*n+t[0]*i,s=this.getResolution(),o=(r+=(e[0]/2-o[0])*s)*n-(t+=(o[1]-e[1]/2)*s)*(i=-i);this.setCenterInternal([o,t*n+r*i])}isDef(){return!!this.getCenterInternal()&&void 0!==this.getResolution()}adjustCenter(t){var e=toUserCoordinate(this.targetCenter_,this.getProjection());this.setCenter([e[0]+t[0],e[1]+t[1]])}adjustCenterInternal(t){var e=this.targetCenter_;this.setCenterInternal([e[0]+t[0],e[1]+t[1]])}adjustResolution(t,e){var o=this.getAnimating()||this.getInteracting(),i=this.getSizeFromViewport_(this.getRotation()),i=this.constraints_.resolution(this.targetResolution_*t,0,i,o);void 0!==e&&(this.targetCenter_=this.calculateCenterZoom(i,e)),this.targetResolution_*=t,this.applyTargetState_()}adjustZoom(t,e){this.adjustResolution(Math.pow(this.zoomFactor_,-t),e)}adjustRotation(t,e){e=e&&fromUserCoordinate(e,this.getProjection()),this.adjustRotationInternal(t,e)}adjustRotationInternal(t,e){var o=this.getAnimating()||this.getInteracting(),o=this.constraints_.rotation(this.targetRotation_+t,o);void 0!==e&&(this.targetCenter_=this.calculateCenterRotate(o,e)),this.targetRotation_+=t,this.applyTargetState_()}setCenter(t){this.setCenterInternal(fromUserCoordinate(t,this.getProjection()))}setCenterInternal(t){this.targetCenter_=t,this.applyTargetState_()}setHint(t,e){return this.hints_[t]+=e,this.changed(),this.hints_[t]}setResolution(t){this.targetResolution_=t,this.applyTargetState_()}setRotation(t){this.targetRotation_=t,this.applyTargetState_()}setZoom(t){this.setResolution(this.getResolutionForZoom(t))}applyTargetState_(t,e){var e=this.getAnimating()||this.getInteracting()||e,o=this.constraints_.rotation(this.targetRotation_,e),i=this.getSizeFromViewport_(o),n=this.constraints_.resolution(this.targetResolution_,0,i,e),i=this.constraints_.center(this.targetCenter_,n,i,e);this.get(ViewProperty.ROTATION)!==o&&this.set(ViewProperty.ROTATION,o),this.get(ViewProperty.RESOLUTION)!==n&&this.set(ViewProperty.RESOLUTION,n),this.get(ViewProperty.CENTER)&&equals(this.get(ViewProperty.CENTER),i)||this.set(ViewProperty.CENTER,i),this.getAnimating()&&!t&&this.cancelAnimations()}resolveConstraints(t,e,o){var t=void 0!==t?t:200,e=e||0,i=this.constraints_.rotation(this.targetRotation_),n=this.getSizeFromViewport_(i),e=this.constraints_.resolution(this.targetResolution_,e,n),n=this.constraints_.center(this.targetCenter_,e,n);if(0===t)return this.targetResolution_=e,this.targetRotation_=i,this.targetCenter_=n,void this.applyTargetState_();this.getResolution()===e&&this.getRotation()===i&&this.getCenterInternal()&&equals(this.getCenterInternal(),n)||(this.getAnimating()&&this.cancelAnimations(),this.animateInternal({rotation:i,center:n,resolution:e,duration:t,easing:easeOut,anchor:o}))}beginInteraction(){this.resolveConstraints(0),this.setHint(ViewHint.INTERACTING,1)}endInteraction(t,e,o){this.setHint(ViewHint.INTERACTING,-1),this.resolveConstraints(t,e,o)}getConstrainedCenter(t,e){var o=this.getSizeFromViewport_(this.getRotation());return this.constraints_.center(t,e||this.getResolution(),o)}getConstrainedZoom(t,e){t=this.getResolutionForZoom(t);return this.getZoomForResolution(this.getConstrainedResolution(t,e))}getConstrainedResolution(t,e){var e=e||0,o=this.getSizeFromViewport_(this.getRotation());return this.constraints_.resolution(t,e,o)}}function animationCallback(t,e){setTimeout(function(){t(e)},0)}function createCenterConstraint(t){var e;if(void 0!==t.extent)return e=void 0===t.smoothExtentConstraint||t.smoothExtentConstraint,createExtent(t.extent,t.constrainOnlyCenter,e);const o=createProjection(t.projection,"EPSG:3857");if(!0!==t.multiWorld&&o.isGlobal()){const i=o.getExtent().slice();return i[0]=-1/0,i[2]=1/0,createExtent(i,!1,!1)}return centerNone}function createResolutionConstraint(t){let e,o,i;let n=void 0!==t.minZoom?t.minZoom:DEFAULT_MIN_ZOOM,r=void 0!==t.maxZoom?t.maxZoom:28;var s=void 0!==t.zoomFactor?t.zoomFactor:2,a=void 0!==t.multiWorld&&t.multiWorld,h=void 0===t.smoothResolutionConstraint||t.smoothResolutionConstraint;const l=createProjection(t.projection,"EPSG:3857");var u=l.getExtent();let g=t.constrainOnlyCenter,m=t.extent;return a||m||!l.isGlobal()||(g=!1,m=u),{constraint:e=void 0!==t.resolutions?(a=t.resolutions,o=a[n],i=void 0!==a[r]?a[r]:a[a.length-1],t.constrainResolution?createSnapToResolutions(a,h,!g&&m):createMinMaxResolution(o,i,h,!g&&m)):(u=(a=(u?Math.max(getWidth(u),getHeight(u)):360*METERS_PER_UNIT[Units.DEGREES]/l.getMetersPerUnit())/DEFAULT_TILE_SIZE/Math.pow(2,DEFAULT_MIN_ZOOM))/Math.pow(2,28-DEFAULT_MIN_ZOOM),void 0!==(o=t.maxResolution)?n=0:o=a/Math.pow(s,n),void 0===(i=t.minResolution)&&(i=void 0!==t.maxZoom?void 0!==t.maxResolution?o/Math.pow(s,r):a/Math.pow(s,r):u),r=n+Math.floor(Math.log(o/i)/Math.log(s)),i=o/Math.pow(s,r-n),t.constrainResolution?createSnapToPower(s,o,i,h,!g&&m):createMinMaxResolution(o,i,h,!g&&m)),maxResolution:o,minResolution:i,minZoom:n,zoomFactor:s}}function createRotationConstraint(t){return void 0===t.enableRotation||t.enableRotation?void 0===(t=t.constrainRotation)||!0===t?createSnapToZero():!1!==t&&"number"==typeof t?createSnapToN(t):rotationNone:disable}function isNoopAnimation(t){return!(t.sourceCenter&&t.targetCenter&&!coordinatesEqual(t.sourceCenter,t.targetCenter))&&(t.sourceResolution===t.targetResolution&&t.sourceRotation===t.targetRotation)}export default View;export{createCenterConstraint,createResolutionConstraint,createRotationConstraint,isNoopAnimation};