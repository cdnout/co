import{getUid}from"../../util.js";import ViewHint from"../../ViewHint.js";import{buffer,createEmpty,containsExtent,getWidth,intersects as intersectsExtent}from"../../extent.js";import{fromUserExtent}from"../../proj.js";import CanvasBuilderGroup from"../../render/canvas/BuilderGroup.js";import ExecutorGroup,{replayDeclutter}from"../../render/canvas/ExecutorGroup.js";import CanvasLayerRenderer from"./Layer.js";import{defaultOrder as defaultRenderOrder,getTolerance as getRenderTolerance,getSquaredTolerance as getSquaredRenderTolerance,renderFeature}from"../vector.js";import{toString as transformToString,makeScale,makeInverse}from"../../transform.js";class CanvasVectorLayerRenderer extends CanvasLayerRenderer{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.dirty_=!1,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=createEmpty(),this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0}useContainer(e,t,r){super.useContainer(e=r<1?null:e,t,r)}renderFrame(n,e){var i=n.pixelRatio,t=n.layerStatesArray[n.layerIndex];makeScale(this.pixelTransform,1/i,1/i),makeInverse(this.inversePixelTransform,this.pixelTransform),this.useContainer(e,this.pixelTransform,t.opacity);const a=this.context,r=a.canvas,s=this.replayGroup_;if(!s||s.isEmpty())return!this.containerReused&&0<r.width&&(r.width=0),this.container;var o=Math.round(n.size[0]*i),d=Math.round(n.size[1]*i),i=(r.width!=o||r.height!=d?(r.width=o,r.height=d,e=transformToString(this.pixelTransform),r.style.transform!==e&&(r.style.transform=e)):this.containerReused||a.clearRect(0,0,o,d),this.preRender(a,n),n.extent),e=n.viewState;const l=e.projection;var h=e.rotation,u=l.getExtent();const c=this.getLayer().getSource();let p=!1;t.extent&&(e=fromUserExtent(t.extent,l),(p=!containsExtent(e,n.extent)&&intersectsExtent(e,n.extent))&&this.clip(a,n,e));const g=n.viewHints;var f=!(g[ViewHint.ANIMATING]||g[ViewHint.INTERACTING]);const y=this.getRenderTransform(n,o,d,0);var m=this.getLayer().getDeclutter()?{}:null;if(s.execute(a,y,h,f,void 0,m),c.getWrapX()&&l.canWrapX()&&!containsExtent(u,i)){let e=i[0];var x=getWidth(u);let t=0,r;for(;e<u[0];){--t,r=x*t;const y=this.getRenderTransform(n,o,d,r);s.execute(a,y,h,f,void 0,m),e+=x}for(t=0,e=i[2];e>u[2];){++t,r=x*t;const y=this.getRenderTransform(n,o,d,r);s.execute(a,y,h,f,void 0,m),e-=x}}if(m){const g=n.viewHints;e=!(g[ViewHint.ANIMATING]||g[ViewHint.INTERACTING]);replayDeclutter(m,a,h,1,e,n.declutterItems)}p&&a.restore(),this.postRender(a,n);i=t.opacity;const v=this.container;return i!==parseFloat(v.style.opacity)&&(v.style.opacity=1===i?"":i),this.container}forEachFeatureAtCoordinate(e,t,r,n,i){if(this.replayGroup_){var a=t.viewState.resolution,t=t.viewState.rotation;const s=this.getLayer(),o={};return this.replayGroup_.forEachFeatureAtCoordinate(e,a,t,r,function(e){var t=getUid(e);if(!(t in o))return o[t]=!0,n(e,s)},s.getDeclutter()?i:null)}}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const n=this.getLayer(),t=n.getSource();var r=e.viewHints[ViewHint.ANIMATING],i=e.viewHints[ViewHint.INTERACTING],a=n.getUpdateWhileAnimating(),s=n.getUpdateWhileInteracting();if(!this.dirty_&&!a&&r||!s&&i)return!0;a=e.extent;const o=e.viewState;r=o.projection;const d=o.resolution;var s=e.pixelRatio,i=n.getRevision(),l=n.getRenderBuffer();let h=n.getRenderOrder();void 0===h&&(h=defaultRenderOrder);const u=buffer(a,l*d);a=o.projection.getExtent();if(t.getWrapX()&&o.projection.canWrapX()&&!containsExtent(a,e.extent)&&(l=getWidth(a),e=Math.max(getWidth(u)/2,l),u[0]=a[0]-e,u[2]=a[2]+e),!this.dirty_&&this.renderedResolution_==d&&this.renderedRevision_==i&&this.renderedRenderOrder_==h&&containsExtent(this.renderedExtent_,u))return!(this.replayGroupChanged=!1);this.replayGroup_&&this.replayGroup_.dispose(),this.replayGroup_=null,this.dirty_=!1;const c=new CanvasBuilderGroup(getRenderTolerance(d,s),u,d,s,n.getDeclutter()),p=(t.loadFeatures(u,d,r),getSquaredRenderTolerance(d,s)),g=function(e){let t;const r=e.getStyleFunction()||n.getStyleFunction();(t=r?r(e,d):t)&&(e=this.renderFeature(e,p,t,c),this.dirty_=this.dirty_||e)}.bind(this);if(h){const f=[];t.forEachFeatureInExtent(u,function(e){f.push(e)}),f.sort(h);for(let e=0,t=f.length;e<t;++e)g(f[e])}else t.forEachFeatureInExtent(u,g);l=c.finish(),a=new ExecutorGroup(u,d,s,t.getOverlaps(),l,n.getRenderBuffer());return this.renderedResolution_=d,this.renderedRevision_=i,this.renderedRenderOrder_=h,this.renderedExtent_=u,this.replayGroup_=a,this.replayGroupChanged=!0}renderFeature(r,n,i,a){if(!i)return!1;let s=!1;if(Array.isArray(i))for(let e=0,t=i.length;e<t;++e)s=renderFeature(a,r,i[e],n,this.boundHandleStyleImageChange_)||s;else s=renderFeature(a,r,i,n,this.boundHandleStyleImageChange_);return s}}export default CanvasVectorLayerRenderer;