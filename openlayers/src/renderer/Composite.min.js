import{CLASS_UNSELECTABLE}from"../css.js";import{inView}from"../layer/Layer.js";import RenderEvent from"../render/Event.js";import RenderEventType from"../render/EventType.js";import MapRenderer from"./Map.js";import SourceState from"../source/State.js";import{replaceChildren}from"../dom.js";import{labelCache}from"../render/canvas.js";import EventType from"../events/EventType.js";import{listen,unlistenByKey}from"../events.js";class CompositeMapRenderer extends MapRenderer{constructor(e){super(e),this.labelCacheKey_=listen(labelCache,EventType.CLEAR,e.redrawText.bind(e)),this.element_=document.createElement("div");const t=this.element_.style,r=(t.position="absolute",t.width="100%",t.height="100%",t.zIndex="0",this.element_.className=CLASS_UNSELECTABLE+" ol-layers",e.getViewport());r.insertBefore(this.element_,r.firstChild||null),this.children_=[],this.renderedVisible_=!0}dispatchRenderEvent(e,t){const r=this.getMap();r.hasListener(e)&&(e=new RenderEvent(e,void 0,t),r.dispatchEvent(e))}disposeInternal(){unlistenByKey(this.labelCacheKey_),super.disposeInternal()}renderFrame(i){if(i){this.calculateMatrices2D(i),this.dispatchRenderEvent(RenderEventType.PRECOMPOSE,i);var s=i.layerStatesArray.sort(function(e,t){return e.zIndex-t.zIndex}),l=i.viewState;let r=!1,n=null;for(let e=this.children_.length=0,t=s.length;e<t;++e){var a=s[e];if(r=r||a.hasOverlay,i.layerIndex=e,inView(a,l)&&(a.sourceState==SourceState.READY||a.sourceState==SourceState.UNDEFINED)){const d=a.layer,o=d.render(i,n);o&&(a=o.childElementCount,o===n&&e!=t-1||2!==a||r||o.removeChild(o.lastElementChild),o!==n&&(this.children_.push(o),r=2===a,n=o))}}super.renderFrame(i),replaceChildren(this.element_,this.children_),this.dispatchRenderEvent(RenderEventType.POSTCOMPOSE,i),this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0),this.scheduleExpireIconCache(i)}else this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1)}forEachLayerAtPixel(t,r,n,i,s){var l=r.viewState,a=r.layerStatesArray;for(let e=a.length-1;0<=e;--e){var d=a[e];const o=d.layer;if(o.hasRenderer()&&inView(d,l)&&s(o)){const h=o.getRenderer();d=h.getDataAtPixel(t,r,n);if(d){d=i(o,d);if(d)return d}}}}}export default CompositeMapRenderer;