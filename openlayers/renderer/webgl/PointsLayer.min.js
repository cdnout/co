var __extends=this&&this.__extends||function(){var i=function(e,r){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};return function(e,r){function t(){this.constructor=e}i(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}}();import WebGLArrayBuffer from"../../webgl/Buffer.js";import{DYNAMIC_DRAW,ARRAY_BUFFER,ELEMENT_ARRAY_BUFFER,FLOAT}from"../../webgl.js";import{DefaultAttrib,DefaultUniform}from"../../webgl/Helper.js";import GeometryType from"../../geom/GeometryType.js";import WebGLLayerRenderer,{colorDecodeId,colorEncodeId,getBlankImageData,POINT_INSTRUCTIONS_COUNT,POINT_VERTEX_STRIDE,WebGLWorkerMessageType,writePointFeatureInstructions}from"./Layer.js";import ViewHint from"../../ViewHint.js";import{createEmpty,equals}from"../../extent.js";import{create as createTransform,makeInverse as makeInverseTransform,multiply as multiplyTransform,apply as applyTransform}from"../../transform.js";import{create as createWebGLWorker}from"../../worker/webgl.js";import{getUid}from"../../util.js";import WebGLRenderTarget from"../../webgl/RenderTarget.js";var VERTEX_SHADER="\n  precision mediump float;\n  attribute vec2 a_position;\n  attribute vec2 a_texCoord;\n  attribute float a_rotateWithView;\n  attribute vec2 a_offsets;\n  attribute float a_opacity;\n  attribute vec4 a_color;\n\n  uniform mat4 u_projectionMatrix;\n  uniform mat4 u_offsetScaleMatrix;\n  uniform mat4 u_offsetRotateMatrix;\n\n  varying vec2 v_texCoord;\n  varying float v_opacity;\n  varying vec4 v_color;\n\n  void main(void) {\n    mat4 offsetMatrix = u_offsetScaleMatrix;\n    if (a_rotateWithView == 1.0) {\n      offsetMatrix = u_offsetScaleMatrix * u_offsetRotateMatrix;\n    }\n    vec4 offsets = offsetMatrix * vec4(a_offsets, 0.0, 0.0);\n    gl_Position = u_projectionMatrix * vec4(a_position, 0.0, 1.0) + offsets;\n    v_texCoord = a_texCoord;\n    v_opacity = a_opacity;\n    v_color = a_color;\n  }",FRAGMENT_SHADER="\n  precision mediump float;\n\n  uniform sampler2D u_texture;\n\n  varying vec2 v_texCoord;\n  varying float v_opacity;\n  varying vec4 v_color;\n\n  void main(void) {\n    if (v_opacity == 0.0) {\n      discard;\n    }\n    vec4 textureColor = texture2D(u_texture, v_texCoord);\n    gl_FragColor = v_color * textureColor;\n    gl_FragColor.a *= v_opacity;\n    gl_FragColor.rgb *= gl_FragColor.a;\n  }",HIT_FRAGMENT_SHADER="\n  precision mediump float;\n\n  uniform sampler2D u_texture;\n\n  varying vec2 v_texCoord;\n  varying float v_opacity;\n  varying vec4 v_color;\n\n  void main(void) {\n    if (v_opacity == 0.0) {\n      discard;\n    }\n    vec4 textureColor = texture2D(u_texture, v_texCoord);\n    if (textureColor.a < 0.1) {\n      discard;\n    }\n    gl_FragColor = v_color;\n  }",WebGLPointsLayerRenderer=function(n){function e(e,r){var t=this,r=r||{},i=r.uniforms||{},o=(i.u_texture=r.texture||getBlankImageData(),createTransform());return i[DefaultUniform.PROJECTION_MATRIX]=o,(t=n.call(this,e,{uniforms:i,postProcesses:r.postProcesses})||this).sourceRevision_=-1,t.verticesBuffer_=new WebGLArrayBuffer(ARRAY_BUFFER,DYNAMIC_DRAW),t.hitVerticesBuffer_=new WebGLArrayBuffer(ARRAY_BUFFER,DYNAMIC_DRAW),t.indicesBuffer_=new WebGLArrayBuffer(ELEMENT_ARRAY_BUFFER,DYNAMIC_DRAW),t.program_=t.helper.getProgram(r.fragmentShader||FRAGMENT_SHADER,r.vertexShader||VERTEX_SHADER),t.hitProgram_=t.helper.getProgram(HIT_FRAGMENT_SHADER,VERTEX_SHADER),t.sizeCallback_=r.sizeCallback||function(){return 1},t.coordCallback_=r.coordCallback||function(e,r){return e.getGeometry().getCoordinates()[r]},t.opacityCallback_=r.opacityCallback||function(){return 1},t.texCoordCallback_=r.texCoordCallback||function(e,r){return r<2?0:1},t.colorArray_=[1,1,1,1],t.colorCallback_=r.colorCallback||function(e,r){return this.colorArray_},t.rotateWithViewCallback_=r.rotateWithViewCallback||function(){return!1},t.previousExtent_=createEmpty(),t.currentTransform_=o,t.renderTransform_=createTransform(),t.invertRenderTransform_=createTransform(),t.renderInstructions_=new Float32Array(0),t.hitRenderInstructions_=new Float32Array(0),t.hitRenderTarget_=new WebGLRenderTarget(t.helper),t.worker_=createWebGLWorker(),t.worker_.addEventListener("message",function(e){var r,t=e.data;t.type===WebGLWorkerMessageType.GENERATE_BUFFERS&&(r=t.projectionTransform,t.hitDetection?(this.hitVerticesBuffer_.fromArrayBuffer(t.vertexBuffer),this.helper.flushBufferData(this.hitVerticesBuffer_)):(this.verticesBuffer_.fromArrayBuffer(t.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_)),this.indicesBuffer_.fromArrayBuffer(t.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=r,makeInverseTransform(this.invertRenderTransform_,this.renderTransform_),t.hitDetection?this.hitRenderInstructions_=new Float32Array(e.data.renderInstructions):this.renderInstructions_=new Float32Array(e.data.renderInstructions),this.getLayer().changed())}.bind(t)),t}return __extends(e,n),e.prototype.renderFrame=function(e){var r=this.indicesBuffer_.getSize(),r=(this.helper.drawElements(0,r),this.helper.finalizeDraw(e),this.helper.getCanvas()),t=e.layerStatesArray[e.layerIndex].opacity;return t!==parseFloat(r.style.opacity)&&(r.style.opacity=t),this.renderHitDetection(e),this.hitRenderTarget_.clearCachedData(),r},e.prototype.prepareFrame=function(e){var r=this.getLayer().getSource(),t=e.viewState,i=POINT_VERTEX_STRIDE,o=this.sourceRevision_<r.getRevision(),r=(o&&(this.sourceRevision_=r.getRevision(),n=t.projection,t=t.resolution,r.loadFeatures([-1/0,-1/0,1/0,1/0],t,n)),!e.viewHints[ViewHint.ANIMATING]&&!e.viewHints[ViewHint.INTERACTING]),t=!equals(this.previousExtent_,e.extent),n=((o||t)&&r&&(this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()),this.helper.makeProjectionTransform(e,this.currentTransform_),multiplyTransform(this.currentTransform_,this.invertRenderTransform_),this.helper.useProgram(this.program_),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),Float32Array.BYTES_PER_ELEMENT);return this.helper.enableAttributeArray(DefaultAttrib.POSITION,2,FLOAT,n*i,0),this.helper.enableAttributeArray(DefaultAttrib.OFFSETS,2,FLOAT,n*i,2*n),this.helper.enableAttributeArray(DefaultAttrib.TEX_COORD,2,FLOAT,n*i,4*n),this.helper.enableAttributeArray(DefaultAttrib.OPACITY,1,FLOAT,n*i,6*n),this.helper.enableAttributeArray(DefaultAttrib.ROTATE_WITH_VIEW,1,FLOAT,n*i,7*n),this.helper.enableAttributeArray(DefaultAttrib.COLOR,4,FLOAT,n*i,8*n),!0},e.prototype.rebuildBuffers_=function(e){for(var r,t,i,o,n,a,s,f,l,u=this.getLayer().getSource(),c=createTransform(),_=(this.helper.makeProjectionTransform(e,c),u.getFeatures()),e=POINT_INSTRUCTIONS_COUNT*_.length,h=(this.renderInstructions_&&this.renderInstructions_.length===e||(this.renderInstructions_=new Float32Array(e)),this.hitRenderInstructions_&&this.hitRenderInstructions_.length===e||(this.hitRenderInstructions_=new Float32Array(e)),[]),p=[],d=0,T=0;T<_.length;T++)(r=_[T]).getGeometry()&&r.getGeometry().getType()===GeometryType.POINT&&(h[0]=this.coordCallback_(r,0),h[1]=this.coordCallback_(r,1),applyTransform(c,h),t=this.texCoordCallback_(r,0),i=this.texCoordCallback_(r,1),o=this.texCoordCallback_(r,2),n=this.texCoordCallback_(r,3),a=this.sizeCallback_(r),s=this.opacityCallback_(r),f=this.rotateWithViewCallback_(r),l=this.colorCallback_(r,this.colorArray_),writePointFeatureInstructions(this.renderInstructions_,d,h[0],h[1],t,i,o,n,a,s,f,l),d=writePointFeatureInstructions(this.hitRenderInstructions_,d,h[0],h[1],t,i,o,n,a,0<s?Number(getUid(r)):0,f,colorEncodeId(d+7,p)));u={type:WebGLWorkerMessageType.GENERATE_BUFFERS,renderInstructions:this.renderInstructions_.buffer},u.projectionTransform=c,this.worker_.postMessage(u,[this.renderInstructions_.buffer]),this.renderInstructions_=null,e={type:WebGLWorkerMessageType.GENERATE_BUFFERS,renderInstructions:this.hitRenderInstructions_.buffer};e.projectionTransform=c,e.hitDetection=!0,this.worker_.postMessage(e,[this.hitRenderInstructions_.buffer]),this.hitRenderInstructions_=null},e.prototype.forEachFeatureAtCoordinate=function(e,r,t,i,o){if(this.hitRenderInstructions_)return r=applyTransform(r.coordinateToPixelTransform,e.slice()),e=this.hitRenderTarget_.readPixel(r[0],r[1]),r=[e[0]/255,e[1]/255,e[2]/255,e[3]/255],e=colorDecodeId(r),r=this.hitRenderInstructions_[e],e=Math.floor(r).toString(),r=this.getLayer().getSource().getFeatureByUid(e),r?i(r,this.getLayer()):void 0},e.prototype.renderHitDetection=function(e){var r;this.hitVerticesBuffer_.getSize()===this.verticesBuffer_.getSize()&&(this.hitRenderTarget_.setSize(e.size),this.helper.useProgram(this.hitProgram_),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0),this.helper.bindBuffer(this.hitVerticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),e=POINT_VERTEX_STRIDE,r=Float32Array.BYTES_PER_ELEMENT,this.helper.enableAttributeArray(DefaultAttrib.POSITION,2,FLOAT,r*e,0),this.helper.enableAttributeArray(DefaultAttrib.OFFSETS,2,FLOAT,r*e,2*r),this.helper.enableAttributeArray(DefaultAttrib.TEX_COORD,2,FLOAT,r*e,4*r),this.helper.enableAttributeArray(DefaultAttrib.OPACITY,1,FLOAT,r*e,6*r),this.helper.enableAttributeArray(DefaultAttrib.ROTATE_WITH_VIEW,1,FLOAT,r*e,7*r),this.helper.enableAttributeArray(DefaultAttrib.COLOR,4,FLOAT,r*e,8*r),e=this.indicesBuffer_.getSize(),this.helper.drawElements(0,e))},e}(WebGLLayerRenderer);export default WebGLPointsLayerRenderer;