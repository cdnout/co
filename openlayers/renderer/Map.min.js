var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{abstract}from"../util.js";import Disposable from"../Disposable.js";import{getWidth}from"../extent.js";import{TRUE}from"../functions.js";import{inView}from"../layer/Layer.js";import{shared as iconImageCache}from"../style/IconImageCache.js";import{compose as composeTransform,makeInverse}from"../transform.js";import{renderDeclutterItems}from"../render.js";var MapRenderer=function(r){function e(e){var t=r.call(this)||this;return t.map_=e,t.declutterTree_=null,t}return __extends(e,r),e.prototype.dispatchRenderEvent=function(e,t){abstract()},e.prototype.calculateMatrices2D=function(e){var t=e.viewState,r=e.coordinateToPixelTransform,o=e.pixelToCoordinateTransform;composeTransform(r,e.size[0]/2,e.size[1]/2,1/t.resolution,-1/t.resolution,-t.rotation,-t.center[0],-t.center[1]),makeInverse(o,r)},e.prototype.forEachFeatureAtCoordinate=function(e,t,r,o,n,a,i){var c=t.viewState;function s(e,t,r){if(e)return o.call(n,t,r)}var p,u,f,l,m=c.projection,h=e,d=(m.canWrapX()&&(m=m.getExtent(),p=getWidth(m),((u=e[0])<m[0]||u>m[2])&&(h=[u+p*Math.ceil((m[0]-u)/p),e[1]])),t.layerStatesArray),m=d.length;for(this.declutterTree_&&(f=this.declutterTree_.all().map(function(e){return e.value})),l=m-1;0<=l;--l){var y=d[l],_=y.layer;if(_.hasRenderer()&&inView(y,c)&&a.call(i,_)){var v,x=_.getRenderer(),_=_.getSource();if(x&&_&&(y=s.bind(null,y.managed),v=x.forEachFeatureAtCoordinate(_.getWrapX()?h:e,t,r,y,f)),v)return v}}},e.prototype.forEachLayerAtPixel=function(e,t,r,o,n){return abstract()},e.prototype.hasFeatureAtCoordinate=function(e,t,r,o,n){return void 0!==this.forEachFeatureAtCoordinate(e,t,r,TRUE,this,o,n)},e.prototype.getMap=function(){return this.map_},e.prototype.renderFrame=function(e){this.declutterTree_=renderDeclutterItems(e,this.declutterTree_)},e.prototype.scheduleExpireIconCache=function(e){iconImageCache.canExpireCache()&&e.postRenderFunctions.push(expireIconCache)},e}(Disposable);function expireIconCache(e,t){iconImageCache.expire()}export default MapRenderer;