var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{getUid}from"../../util.js";import{createCanvasContext2D}from"../../dom.js";import TileState from"../../TileState.js";import ViewHint from"../../ViewHint.js";import{listen,unlistenByKey}from"../../events.js";import EventType from"../../events/EventType.js";import{buffer,containsCoordinate,equals,getIntersection,intersects}from"../../extent.js";import VectorTileRenderType from"../../layer/VectorTileRenderType.js";import ReplayType from"../../render/canvas/BuilderType.js";import CanvasBuilderGroup from"../../render/canvas/BuilderGroup.js";import CanvasTileLayerRenderer from"./TileLayer.js";import{getSquaredTolerance as getSquaredRenderTolerance,renderFeature}from"../vector.js";import{apply as applyTransform,create as createTransform,reset as resetTransform,scale as scaleTransform,translate as translateTransform,toString as transformToString,makeScale,makeInverse}from"../../transform.js";import CanvasExecutorGroup,{replayDeclutter}from"../../render/canvas/ExecutorGroup.js";import{clear}from"../../obj.js";var IMAGE_REPLAYS={image:[ReplayType.POLYGON,ReplayType.CIRCLE,ReplayType.LINE_STRING,ReplayType.IMAGE,ReplayType.TEXT],hybrid:[ReplayType.POLYGON,ReplayType.LINE_STRING]},VECTOR_REPLAYS={image:[ReplayType.DEFAULT],hybrid:[ReplayType.IMAGE,ReplayType.TEXT,ReplayType.DEFAULT]},CanvasVectorTileLayerRenderer=function(P){function e(e){e=P.call(this,e)||this;return e.boundHandleStyleImageChange_=e.handleStyleImageChange_.bind(e),e.overlayContext_=null,e.overlayContextUid_,e.overlayPixelTransform_=createTransform(),e.inverseOverlayPixelTransform_=createTransform(),e.dirty_=!1,e.renderedLayerRevision_,e.renderTileImageQueue_={},e.tileListenerKeys_={},e.tmpTransform_=createTransform(),e}return __extends(e,P),e.prototype.useContainer=function(e,t,r){e&&2===e.childElementCount&&!(i=e.lastElementChild.getContext("2d"))&&(e=null);var i,n=this.containerReused;P.prototype.useContainer.call(this,e,t,r),n&&(this.overlayContext_=i||null,this.overlayContextUid_=i?getUid(i):void 0),this.overlayContext_||((t=(e=createCanvasContext2D()).canvas.style).position="absolute",t.transformOrigin="top left",this.overlayContext_=e,this.overlayContextUid_=getUid(e)),1===this.container.childElementCount&&this.container.appendChild(this.overlayContext_.canvas)},e.prototype.prepareTile=function(e,t,r,i){var n=!1,o=getUid(e),a=e.getState();return(a===TileState.LOADED&&e.hifi||a===TileState.ERROR||a===TileState.ABORT)&&o in this.tileListenerKeys_&&(unlistenByKey(this.tileListenerKeys_[o]),delete this.tileListenerKeys_[o]),a!==TileState.LOADED&&a!==TileState.ERROR||(this.updateExecutorGroup_(e,t,r),this.tileImageNeedsRender_(e,t,r)&&(n=!0,i&&(this.renderTileImageQueue_[o]=e))),n},e.prototype.getTile=function(e,t,r,i){var n,o,e=P.prototype.getTile.call(this,e,t,r,i),t=i.pixelRatio,r=i.viewState,a=r.resolution,r=r.projection;return e.getState()<TileState.LOADED?(e.wantedResolution=a,(o=getUid(e))in this.tileListenerKeys_||(n=listen(e,EventType.CHANGE,this.prepareTile.bind(this,e,t,r,!0)),this.tileListenerKeys_[o]=n)):(!!((o=i.viewHints)[ViewHint.ANIMATING]||o[ViewHint.INTERACTING])&&e.wantedResolution||(e.wantedResolution=a),this.prepareTile(e,t,r,!1)&&this.renderTileImage_(e,i)),e},e.prototype.isDrawableTile=function(e){return P.prototype.isDrawableTile.call(this,e)&&e.hasContext(this.getLayer())},e.prototype.getTileImage=function(e){return e.getImage(this.getLayer())},e.prototype.prepareFrame=function(e){e.layerStatesArray[e.layerIndex].hasOverlay=!0;var t=this.getLayer().getRevision();return this.renderedLayerRevision_!=t&&(this.renderedTiles.length=0),this.renderedLayerRevision_=t,P.prototype.prepareFrame.call(this,e)},e.prototype.updateExecutorGroup_=function(y,T,e){var c=this.getLayer(),t=c.getRevision(),g=c.getRenderOrder()||null,h=y.wantedResolution,f=y.getReplayState(c);if(f.dirty||f.renderedResolution!==h||f.renderedRevision!=t||f.renderedRenderOrder!=g||f.renderedZ!==y.sourceZ){var v=c.getSource(),m=v.getTileGrid(),R=v.getTileGridForProjection(e).getTileCoordExtent(y.wrappedTileCoord),_=v.getSourceTiles(T,e,y),C=getUid(c),r=y.executorGroups[C];if(r)for(var i=0,n=r.length;i<n;++i)r[i].dispose();y.executorGroups[C]=[];function o(e,t){e=_[e];if(e.getState()!=TileState.LOADED)return"continue";function r(e){var t,r=e.getStyleFunction()||c.getStyleFunction();(t=r?r(e,h):t)&&(r=this.renderFeature(e,s,t,a),this.dirty_=this.dirty_||r,f.dirty=f.dirty||r)}var i=e.tileCoord,i=m.getTileCoordExtent(i),n=getIntersection(R,i),o=equals(i,n)?null:buffer(n,c.getRenderBuffer()*h,x.tmpExtent),a=(f.dirty=!1,new CanvasBuilderGroup(0,n,h,T,c.getDeclutter())),s=getSquaredRenderTolerance(h,T),l=e.getFeatures();g&&g!==f.renderedRenderOrder&&l.sort(g);for(var d=0,u=l.length;d<u;++d){var p=l[d];o&&!intersects(o,p.getGeometry().getExtent())||r.call(x,p)}i=a.finish(),e=c.getDeclutter()&&1===_.length?null:n,n=new CanvasExecutorGroup(e,h,T,v.getOverlaps(),i,c.getRenderBuffer());y.executorGroups[C].push(n)}for(var x=this,a=0,s=_.length;a<s;++a)o(a);f.renderedRevision=t,f.renderedZ=y.sourceZ,f.renderedRenderOrder=g,f.renderedResolution=h}},e.prototype.forEachFeatureAtCoordinate=function(s,e,l,d,u){for(var p,y=e.viewState.resolution,T=e.viewState.rotation,c=(l=null==l?0:l,this.getLayer()),g=c.getDeclutter(),h=c.getSource().getTileGridForProjection(e.viewState.projection),f={},v=this.renderedTiles,m=0,t=v.length;m<t;++m)!function(){var e=v[m],t=h.getTileCoordExtent(e.wrappedTileCoord),r=containsCoordinate(t,s);if(!g&&!r)return;for(var i=e.executorGroups[getUid(c)],n=0,o=i.length;n<o;++n){var a=i[n];p=p||a.forEachFeatureAtCoordinate(s,y,T,l,function(e){if(r||u&&-1!==u.indexOf(e)){var t=e.getId();if(!((t=void 0===t?getUid(e):t)in f))return f[t]=!0,d(e,c)}},c.getDeclutter()?u:null)}}();return p},e.prototype.handleFontsChanged=function(){clear(this.renderTileImageQueue_);var e=this.getLayer();e.getVisible()&&void 0!==this.renderedLayerRevision_&&e.changed()},e.prototype.handleStyleImageChange_=function(e){this.renderIfReadyAndVisible()},e.prototype.renderFrame=function(e,t){var r=e.viewHints,i=!(r[ViewHint.ANIMATING]||r[ViewHint.INTERACTING]),n=(this.renderQueuedTileImages_(i,e),P.prototype.renderFrame.call(this,e,t),this.getLayer()),r=n.getRenderMode();if(r===VectorTileRenderType.IMAGE)return this.container;var o,t=n.getSource(),a=e.usedTiles[getUid(t)];for(o in this.renderTileImageQueue_)a&&o in a||delete this.renderTileImageQueue_[o];for(var s=this.overlayContext_,l=n.getDeclutter()?{}:null,d=VECTOR_REPLAYS[r],r=e.pixelRatio,u=e.viewState.rotation,p=e.size,y=(makeScale(this.overlayPixelTransform_,1/r,1/r),makeInverse(this.inverseOverlayPixelTransform_,this.overlayPixelTransform_),s.canvas),T=Math.round(p[0]*r),c=Math.round(p[1]*r),g=(y.width!=T||y.height!=c?(y.width=T,y.height=c,p=transformToString(this.overlayPixelTransform_),y.style.transform!==p&&(y.style.transform=p)):getUid(s)===this.overlayContextUid_&&s.clearRect(0,0,T,c),this.renderedTiles),h=t.getTileGridForProjection(e.viewState.projection),f=[],v=[],m=g.length-1;0<=m;--m){var R=g[m];if(R.getState()!=TileState.ABORT)for(var _=R.tileCoord,C=h.getTileCoordExtent(R.wrappedTileCoord),_=h.getTileCoordExtent(_,this.tmpExtent)[0]-C[0],x=this.getRenderTransform(e,T,c,_),S=R.executorGroups[getUid(n)],E=!1,I=0,L=S.length;I<L;++I){var w=S[I];if(w.hasExecutors(d)){var A=R.tileCoord[0],G=void 0;if(!l&&!E){G=w.getClipCoords(x),s.save();for(var O=0,j=f.length;O<j;++O){var D=f[O];A<v[O]&&(s.beginPath(),s.moveTo(G[0],G[1]),s.lineTo(G[2],G[3]),s.lineTo(G[4],G[5]),s.lineTo(G[6],G[7]),s.moveTo(D[6],D[7]),s.lineTo(D[4],D[5]),s.lineTo(D[2],D[3]),s.lineTo(D[0],D[1]),s.clip())}}w.execute(s,x,u,i,d,l),l||E||(s.restore(),f.push(G),v.push(A),E=!0)}}}return l&&(r=e.layerStatesArray[e.layerIndex],replayDeclutter(l,s,u,r.opacity,i,e.declutterItems)),this.container},e.prototype.renderQueuedTileImages_=function(e,t){for(var r in this.renderTileImageQueue_){if(!e&&8<Date.now()-t.time){t.animate=!0;break}var i=this.renderTileImageQueue_[r];delete this.renderTileImageQueue_[r],this.renderTileImage_(i,t)}},e.prototype.renderFeature=function(e,t,r,i){if(!r)return!1;var n=!1;if(Array.isArray(r))for(var o=0,a=r.length;o<a;++o)n=renderFeature(i,e,r[o],t,this.boundHandleStyleImageChange_)||n;else n=renderFeature(i,e,r,t,this.boundHandleStyleImageChange_);return n},e.prototype.tileImageNeedsRender_=function(e,t,r){var i=this.getLayer(),n=e.getReplayState(i),i=i.getRevision(),o=e.sourceZ,e=e.wantedResolution;return n.renderedTileResolution!==e||n.renderedTileRevision!==i||n.renderedTileZ!==o},e.prototype.renderTileImage_=function(e,t){var r=this.getLayer(),i=e.getReplayState(r),n=r.getRevision(),o=e.executorGroups[getUid(r)],n=(i.renderedTileRevision=n,i.renderedTileZ=e.sourceZ,e.wrappedTileCoord),a=n[0],s=r.getSource(),l=t.pixelRatio,d=t.viewState.projection,u=s.getTileGridForProjection(d),p=u.getResolution(e.tileCoord[0]),t=t.pixelRatio/e.wantedResolution*p,p=u.getResolution(a),y=e.getContext(r),l=Math.max(l,t/l),s=s.getTilePixelSize(a,l,d),a=(y.canvas.width=s[0],y.canvas.height=s[1],l/t),s=(1!=a&&(d=resetTransform(this.tmpTransform_),scaleTransform(d,a,a),y.setTransform.apply(y,d)),u.getTileCoordExtent(n,this.tmpExtent)),l=t/p,T=resetTransform(this.tmpTransform_);scaleTransform(T,l,-l),translateTransform(T,-s[0],-s[3]);for(var c=0,g=o.length;c<g;++c)o[c].execute(y,T,0,!0,IMAGE_REPLAYS[r.getRenderMode()]);i.renderedTileResolution=e.wantedResolution},e.prototype.getDataAtPixel=function(e,t,r){t=P.prototype.getDataAtPixel.call(this,e,t,r);if(t)return t;r=applyTransform(this.inverseOverlayPixelTransform_,e.slice()),e=this.overlayContext_;try{t=e.getImageData(Math.round(r[0]),Math.round(r[1]),1,1).data}catch(e){return"SecurityError"===e.name?new Uint8Array:t}return 0===t[3]?null:t},e}(CanvasTileLayerRenderer);export default CanvasVectorTileLayerRenderer;