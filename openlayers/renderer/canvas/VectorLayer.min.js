var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{getUid}from"../../util.js";import ViewHint from"../../ViewHint.js";import{buffer,createEmpty,containsExtent,getWidth,intersects as intersectsExtent}from"../../extent.js";import{fromUserExtent}from"../../proj.js";import CanvasBuilderGroup from"../../render/canvas/BuilderGroup.js";import ExecutorGroup,{replayDeclutter}from"../../render/canvas/ExecutorGroup.js";import CanvasLayerRenderer from"./Layer.js";import{defaultOrder as defaultRenderOrder,getTolerance as getRenderTolerance,getSquaredTolerance as getSquaredRenderTolerance,renderFeature}from"../vector.js";import{toString as transformToString,makeScale,makeInverse}from"../../transform.js";var CanvasVectorLayerRenderer=function(n){function e(e){e=n.call(this,e)||this;return e.boundHandleStyleImageChange_=e.handleStyleImageChange_.bind(e),e.dirty_=!1,e.renderedRevision_=-1,e.renderedResolution_=NaN,e.renderedExtent_=createEmpty(),e.renderedRenderOrder_=null,e.replayGroup_=null,e.replayGroupChanged=!0,e}return __extends(e,n),e.prototype.useContainer=function(e,t,r){n.prototype.useContainer.call(this,e=r<1?null:e,t,r)},e.prototype.renderFrame=function(e,t){var r=e.pixelRatio,n=e.layerStatesArray[e.layerIndex],i=(makeScale(this.pixelTransform,1/r,1/r),makeInverse(this.inversePixelTransform,this.pixelTransform),this.useContainer(t,this.pixelTransform,n.opacity),this.context),t=i.canvas,a=this.replayGroup_;if(!a||a.isEmpty())return!this.containerReused&&0<t.width&&(t.width=0),this.container;var o=Math.round(e.size[0]*r),s=Math.round(e.size[1]*r),t=(t.width!=o||t.height!=s?(t.width=o,t.height=s,r=transformToString(this.pixelTransform),t.style.transform!==r&&(t.style.transform=r)):this.containerReused||i.clearRect(0,0,o,s),this.preRender(i,e),e.extent),r=e.viewState,d=r.projection,u=r.rotation,p=d.getExtent(),r=this.getLayer().getSource(),l=!1,h=(n.extent&&(h=fromUserExtent(n.extent,d),(l=!containsExtent(h,e.extent)&&intersectsExtent(h,e.extent))&&this.clip(i,e,h)),e.viewHints),c=!(h[ViewHint.ANIMATING]||h[ViewHint.INTERACTING]),h=this.getRenderTransform(e,o,s,0),f=this.getLayer().getDeclutter()?{}:null;if(a.execute(i,h,u,c,void 0,f),r.getWrapX()&&d.canWrapX()&&!containsExtent(p,t)){for(var y=t[0],g=getWidth(p),v=0,m=void 0;y<p[0];){var m=g*--v,_=this.getRenderTransform(e,o,s,m);a.execute(i,_,u,c,void 0,f),y+=g}for(v=0,y=t[2];y>p[2];){++v;var x=this.getRenderTransform(e,o,s,m=g*v);a.execute(i,x,u,c,void 0,f),y-=g}}f&&(r=!((h=e.viewHints)[ViewHint.ANIMATING]||h[ViewHint.INTERACTING]),replayDeclutter(f,i,u,1,r,e.declutterItems)),l&&i.restore(),this.postRender(i,e);d=n.opacity,t=this.container;return d!==parseFloat(t.style.opacity)&&(t.style.opacity=1===d?"":d),this.container},e.prototype.forEachFeatureAtCoordinate=function(e,t,r,n,i){var a,o,s;if(this.replayGroup_)return a=t.viewState.resolution,t=t.viewState.rotation,o=this.getLayer(),s={},this.replayGroup_.forEachFeatureAtCoordinate(e,a,t,r,function(e){var t=getUid(e);if(!(t in s))return s[t]=!0,n(e,o)},o.getDeclutter()?i:null)},e.prototype.handleFontsChanged=function(){var e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()},e.prototype.handleStyleImageChange_=function(e){this.renderIfReadyAndVisible()},e.prototype.prepareFrame=function(e){var n=this.getLayer(),t=n.getSource(),r=e.viewHints[ViewHint.ANIMATING],i=e.viewHints[ViewHint.INTERACTING],a=n.getUpdateWhileAnimating(),o=n.getUpdateWhileInteracting();if(!this.dirty_&&!a&&r||!o&&i)return!0;var a=e.extent,r=e.viewState,o=r.projection,s=r.resolution,i=e.pixelRatio,d=n.getRevision(),u=n.getRenderBuffer(),p=n.getRenderOrder(),a=(void 0===p&&(p=defaultRenderOrder),buffer(a,u*s)),u=r.projection.getExtent();if(t.getWrapX()&&r.projection.canWrapX()&&!containsExtent(u,e.extent)&&(r=getWidth(u),e=Math.max(getWidth(a)/2,r),a[0]=u[0]-e,a[2]=u[2]+e),!this.dirty_&&this.renderedResolution_==s&&this.renderedRevision_==d&&this.renderedRenderOrder_==p&&containsExtent(this.renderedExtent_,a))return!(this.replayGroupChanged=!1);this.replayGroup_&&this.replayGroup_.dispose(),this.replayGroup_=null,this.dirty_=!1;var l=new CanvasBuilderGroup(getRenderTolerance(s,i),a,s,i,n.getDeclutter()),h=(t.loadFeatures(a,s,o),getSquaredRenderTolerance(s,i)),c=function(e){var t,r=e.getStyleFunction()||n.getStyleFunction();(t=r?r(e,s):t)&&(r=this.renderFeature(e,h,t,l),this.dirty_=this.dirty_||r)}.bind(this);if(p){var f=[];t.forEachFeatureInExtent(a,function(e){f.push(e)}),f.sort(p);for(var y=0,g=f.length;y<g;++y)c(f[y])}else t.forEachFeatureInExtent(a,c);r=l.finish(),u=new ExecutorGroup(a,s,i,t.getOverlaps(),r,n.getRenderBuffer());return this.renderedResolution_=s,this.renderedRevision_=d,this.renderedRenderOrder_=p,this.renderedExtent_=a,this.replayGroup_=u,this.replayGroupChanged=!0},e.prototype.renderFeature=function(e,t,r,n){if(!r)return!1;var i=!1;if(Array.isArray(r))for(var a=0,o=r.length;a<o;++a)i=renderFeature(n,e,r[a],t,this.boundHandleStyleImageChange_)||i;else i=renderFeature(n,e,r,t,this.boundHandleStyleImageChange_);return i},e}(CanvasLayerRenderer);export default CanvasVectorLayerRenderer;