var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();import{getBottomLeft,getBottomRight,getTopLeft,getTopRight}from"../../extent.js";import{createCanvasContext2D}from"../../dom.js";import RenderEvent from"../../render/Event.js";import RenderEventType from"../../render/EventType.js";import{rotateAtOffset}from"../../render/canvas.js";import LayerRenderer from"../Layer.js";import{create as createTransform,apply as applyTransform,compose as composeTransform,toString as transformToString}from"../../transform.js";var CanvasLayerRenderer=function(e){function t(t){t=e.call(this,t)||this;return t.container=null,t.renderedResolution,t.tempTransform_=createTransform(),t.pixelTransform=createTransform(),t.inversePixelTransform=createTransform(),t.context=null,t.containerReused=!1,t}return __extends(t,e),t.prototype.useContainer=function(t,e,r){var o,n,a=this.getLayer().getClassName();(o=t&&""===t.style.opacity&&t.className===a&&(n=t.firstElementChild)instanceof HTMLCanvasElement?n.getContext("2d"):o)&&o.canvas.style.transform===transformToString(e)?(this.container=t,this.context=o,this.containerReused=!0):this.containerReused&&(this.container=null,this.context=null,this.containerReused=!1),this.container||((e=document.createElement("div")).className=a,(t=e.style).position="absolute",t.width="100%",t.height="100%",n=(o=createCanvasContext2D()).canvas,e.appendChild(n),(t=n.style).position="absolute",t.transformOrigin="top left",this.container=e,this.context=o)},t.prototype.clip=function(t,e,r){var o=e.pixelRatio,n=e.size[0]*o/2,a=e.size[1]*o/2,i=e.viewState.rotation,s=getTopLeft(r),p=getTopRight(r),f=getBottomRight(r),r=getBottomLeft(r);applyTransform(e.coordinateToPixelTransform,s),applyTransform(e.coordinateToPixelTransform,p),applyTransform(e.coordinateToPixelTransform,f),applyTransform(e.coordinateToPixelTransform,r),t.save(),rotateAtOffset(t,-i,n,a),t.beginPath(),t.moveTo(s[0]*o,s[1]*o),t.lineTo(p[0]*o,p[1]*o),t.lineTo(f[0]*o,f[1]*o),t.lineTo(r[0]*o,r[1]*o),t.clip(),rotateAtOffset(t,i,n,a)},t.prototype.clipUnrotated=function(t,e,r){var o=getTopLeft(r),n=getTopRight(r),a=getBottomRight(r),r=getBottomLeft(r),e=(applyTransform(e.coordinateToPixelTransform,o),applyTransform(e.coordinateToPixelTransform,n),applyTransform(e.coordinateToPixelTransform,a),applyTransform(e.coordinateToPixelTransform,r),this.inversePixelTransform);applyTransform(e,o),applyTransform(e,n),applyTransform(e,a),applyTransform(e,r),t.save(),t.beginPath(),t.moveTo(Math.round(o[0]),Math.round(o[1])),t.lineTo(Math.round(n[0]),Math.round(n[1])),t.lineTo(Math.round(a[0]),Math.round(a[1])),t.lineTo(Math.round(r[0]),Math.round(r[1])),t.clip()},t.prototype.dispatchRenderEvent_=function(t,e,r){var o=this.getLayer();o.hasListener(t)&&(t=new RenderEvent(t,this.inversePixelTransform,r,e),o.dispatchEvent(t))},t.prototype.preRender=function(t,e){this.dispatchRenderEvent_(RenderEventType.PRERENDER,t,e)},t.prototype.postRender=function(t,e){this.dispatchRenderEvent_(RenderEventType.POSTRENDER,t,e)},t.prototype.getRenderTransform=function(t,e,r,o){var n=t.viewState,t=t.pixelRatio/n.resolution,o=-n.center[0]+o,a=-n.center[1];return composeTransform(this.tempTransform_,e/2,r/2,t,-t,-n.rotation,o,a)},t.prototype.getDataAtPixel=function(t,e,r){var o,t=applyTransform(this.inversePixelTransform,t.slice()),n=this.context;try{o=n.getImageData(Math.round(t[0]),Math.round(t[1]),1,1).data}catch(t){return"SecurityError"===t.name?new Uint8Array:o}return 0===o[3]?null:o},t}(LayerRenderer);export default CanvasLayerRenderer;