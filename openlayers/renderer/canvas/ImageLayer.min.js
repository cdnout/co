var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();import{ENABLE_RASTER_REPROJECTION}from"../../reproj/common.js";import ViewHint from"../../ViewHint.js";import{containsExtent,intersects}from"../../extent.js";import{fromUserExtent}from"../../proj.js";import{getIntersection,isEmpty}from"../../extent.js";import CanvasLayerRenderer from"./Layer.js";import{compose as composeTransform,makeInverse,toString as transformToString}from"../../transform.js";var CanvasImageLayerRenderer=function(e){function t(t){t=e.call(this,t)||this;return t.image_=null,t}return __extends(t,e),t.prototype.getImage=function(){return this.image_?this.image_.getImage():null},t.prototype.prepareFrame=function(t){var e=t.layerStatesArray[t.layerIndex],r=t.pixelRatio,n=t.viewState,o=n.resolution,i=this.getLayer().getSource(),a=t.viewHints,t=t.extent;return void 0!==e.extent&&(t=getIntersection(t,fromUserExtent(e.extent,n.projection))),a[ViewHint.ANIMATING]||a[ViewHint.INTERACTING]||isEmpty(t)||(e=n.projection,ENABLE_RASTER_REPROJECTION||(a=i.getProjection())&&(e=a),(n=i.getImage(t,o,r,e))&&this.loadImage(n)&&(this.image_=n)),!!this.image_},t.prototype.renderFrame=function(t,e){var r=this.image_,n=r.getExtent(),o=r.getResolution(),i=r.getPixelRatio(),a=t.layerStatesArray[t.layerIndex],s=t.pixelRatio,m=t.viewState,h=m.center,p=m.resolution,c=t.size,p=s*o/(p*i),f=Math.round(c[0]*s),c=Math.round(c[1]*s),l=m.rotation,l=(l&&(f=c=Math.round(Math.sqrt(f*f+c*c))),composeTransform(this.pixelTransform,t.size[0]/2,t.size[1]/2,1/s,1/s,l,-f/2,-c/2),makeInverse(this.inversePixelTransform,this.pixelTransform),this.useContainer(e,this.pixelTransform,a.opacity),this.context),e=l.canvas,u=(e.width!=f||e.height!=c?(e.width=f,e.height=c):this.containerReused||l.clearRect(0,0,f,c),!1),m=(a.extent&&(m=fromUserExtent(a.extent,m.projection),(u=!containsExtent(m,t.extent)&&intersects(m,t.extent))&&this.clipUnrotated(l,t,m)),r.getImage()),r=composeTransform(this.tempTransform_,f/2,c/2,p,p,0,i*(n[0]-h[0])/o,i*(h[1]-n[3])/o),f=(this.renderedResolution=o*s/i,r[4]),c=r[5],p=m.width*r[0],h=m.height*r[3],s=(this.preRender(l,t),.5<=p&&.5<=h&&(n=void 0,1!==(o=a.opacity)&&(n=this.context.globalAlpha,this.context.globalAlpha=o),this.context.drawImage(m,0,0,+m.width,+m.height,Math.round(f),Math.round(c),Math.round(p),Math.round(h)),1!==o&&(this.context.globalAlpha=n)),this.postRender(l,t),u&&l.restore(),transformToString(this.pixelTransform));return s!==e.style.transform&&(e.style.transform=s),this.container},t}(CanvasLayerRenderer);export default CanvasImageLayerRenderer;