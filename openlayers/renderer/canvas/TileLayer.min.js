var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{getUid}from"../../util.js";import{fromUserExtent}from"../../proj.js";import TileRange from"../../TileRange.js";import TileState from"../../TileState.js";import{createEmpty,equals,getIntersection,getTopLeft}from"../../extent.js";import CanvasLayerRenderer from"./Layer.js";import{apply as applyTransform,compose as composeTransform,makeInverse,toString as transformToString}from"../../transform.js";import{numberSafeCompareFunction}from"../../array.js";var CanvasTileLayerRenderer=function(i){function e(e){e=i.call(this,e)||this;return e.extentChanged=!0,e.renderedExtent_=null,e.renderedRevision,e.renderedTiles=[],e.newTiles_=!1,e.tmpExtent=createEmpty(),e.tmpTileRange_=new TileRange(0,0,0,0),e}return __extends(e,i),e.prototype.isDrawableTile=function(e){var t=this.getLayer(),e=e.getState(),t=t.getUseInterimTilesOnError();return e==TileState.LOADED||e==TileState.EMPTY||e==TileState.ERROR&&!t},e.prototype.getTile=function(e,t,r,i){var n=i.pixelRatio,i=i.viewState.projection,o=this.getLayer(),e=o.getSource().getTile(e,t,r,n,i);return e.getState()==TileState.ERROR&&(o.getUseInterimTilesOnError()?0<o.getPreload()&&(this.newTiles_=!0):e.setState(TileState.LOADED)),e=this.isDrawableTile(e)?e:e.getInterimTile()},e.prototype.loadedTileCallback=function(e,t,r){return!!this.isDrawableTile(r)&&i.prototype.loadedTileCallback.call(this,e,t,r)},e.prototype.prepareFrame=function(e){return!!this.getLayer().getSource()},e.prototype.renderFrame=function(e,F){var t=e.layerStatesArray[e.layerIndex],r=e.viewState,i=r.projection,M=r.resolution,n=r.center,r=r.rotation,o=e.pixelRatio,k=this.getLayer(),a=k.getSource(),z=a.getRevision(),s=a.getTileGridForProjection(i),l=s.getZForResolution(M,a.zDirection),d=s.getResolution(l),h=e.extent,p=t.extent&&fromUserExtent(t.extent,i),T=(p&&(h=getIntersection(h,fromUserExtent(t.extent,i))),a.getTilePixelRatio(o)),g=Math.round(e.size[0]*T),u=Math.round(e.size[1]*T),c=d*(g=r?u=Math.round(Math.sqrt(g*g+u*u)):g)/2/T,q=d*u/2/T,m=[n[0]-c,n[1]-q,n[0]+c,n[1]+q],f=s.getTileRangeForExtentAndZ(h,l),y={},Y=(y[l]={},this.createLoadedTileFinder(a,i,y)),Z=this.tmpExtent,K=this.tmpTileRange_;this.newTiles_=!1;for(var x=f.minX;x<=f.maxX;++x)for(var v=f.minY;v<=f.maxY;++v){var R=this.getTile(l,x,v,e);if(this.isDrawableTile(R)){var C=getUid(this);if(R.getState()==TileState.LOADED&&(L=(y[l][R.tileCoord.toString()]=R).inTransition(C),this.newTiles_||!L&&-1!==this.renderedTiles.indexOf(R)||(this.newTiles_=!0)),1===R.getAlpha(C,e.time))continue}var C=s.getTileCoordChildTileRange(R.tileCoord,K,Z),X=!1;(X=C?Y(l+1,C):X)||s.forEachTileCoordParentTileRange(R.tileCoord,Y,K,Z)}var S,G,_=d/M,w=(composeTransform(this.pixelTransform,e.size[0]/2,e.size[1]/2,1/T,1/T,r,-g/2,-u/2),this.useContainer(F,this.pixelTransform,t.opacity),this.context),c=w.canvas,E=(makeInverse(this.inversePixelTransform,this.pixelTransform),composeTransform(this.tempTransform_,g/2,u/2,_,_,0,-g/2,-u/2),c.width!=g||c.height!=u?(c.width=g,c.height=u):this.containerReused||w.clearRect(0,0,g,u),p&&this.clipUnrotated(w,e,p),this.preRender(w,e),this.renderedTiles.length=0,Object.keys(y).map(Number));E.sort(numberSafeCompareFunction),1!==t.opacity||this.containerReused&&!a.getOpaque(e.viewState.projection)?(S=[],G=[]):E=E.reverse();for(var Q=E.length-1;0<=Q;--Q){var W,j=E[Q],b=a.getTilePixelSize(j,o,i),N=s.getResolution(j)/d,B=b[0]*N*_,H=b[1]*N*_,J=s.getTileCoordForCoordAndZ(getTopLeft(m),j),b=s.getTileCoordExtent(J),V=applyTransform(this.tempTransform_,[T*(b[0]-m[0])/d,T*(m[3]-b[3])/d]),$=T*a.getGutterForProjection(i),ee=y[j];for(W in ee){var L,I=(R=ee[W]).tileCoord,O=V[0]-(J[1]-I[1])*B,U=Math.round(O+B),I=V[1]-(J[2]-I[2])*H,te=Math.round(I+H),U=U-(x=Math.round(O)),O=te-(v=Math.round(I)),te=l===j;if(!(L=te&&1!==R.getAlpha(getUid(this),e.time)))if(S){w.save();for(var P,A=[x,v,x+U,v,x+U,v+O,x,v+O],D=0,re=S.length;D<re;++D)l!==j&&j<G[D]&&(P=S[D],w.beginPath(),w.moveTo(A[0],A[1]),w.lineTo(A[2],A[3]),w.lineTo(A[4],A[5]),w.lineTo(A[6],A[7]),w.moveTo(P[6],P[7]),w.lineTo(P[4],P[5]),w.lineTo(P[2],P[3]),w.lineTo(P[0],P[1]),w.clip());S.push(A),G.push(j)}else w.clearRect(x,v,U,O);this.drawTileImage(R,e,x,v,U,O,$,te,t.opacity),S&&!L&&w.restore(),this.renderedTiles.push(R),this.updateUsedTiles(e.usedTiles,a,R)}}this.renderedRevision=z,this.renderedResolution=d,this.extentChanged=!this.renderedExtent_||!equals(this.renderedExtent_,m),this.renderedExtent_=m,this.manageTilePyramid(e,a,s,o,i,h,l,k.getPreload()),this.updateCacheSize_(e,a),this.scheduleExpireCache(e,a),this.postRender(w,e),t.extent&&w.restore();n=transformToString(this.pixelTransform);return n!==c.style.transform&&(c.style.transform=n),this.container},e.prototype.drawTileImage=function(e,t,r,i,n,o,a,s,l){var d,h,p,T=this.getTileImage(e);T&&(d=getUid(this),(p=(h=l*(l=s?e.getAlpha(d,t.time):1))!==this.context.globalAlpha)&&(this.context.save(),this.context.globalAlpha=h),this.context.drawImage(T,a,a,T.width-2*a,T.height-2*a,r,i,n,o),p&&this.context.restore(),1!==l?t.animate=!0:s&&e.endTransition(d))},e.prototype.getImage=function(){var e=this.context;return e?e.canvas:null},e.prototype.getTileImage=function(e){return e.getImage()},e.prototype.scheduleExpireCache=function(e,t){t.canExpireCache()&&(t=function(e,t,r){var i=getUid(e);i in r.usedTiles&&e.expireCache(r.viewState.projection,r.usedTiles[i])}.bind(null,t),e.postRenderFunctions.push(t))},e.prototype.updateUsedTiles=function(e,t,r){t=getUid(t);t in e||(e[t]={}),e[t][r.getKey()]=!0},e.prototype.updateCacheSize_=function(e,t){var r=getUid(t),i=0,e=(r in e.usedTiles&&(i+=Object.keys(e.usedTiles[r]).length),r in e.wantedTiles&&(i+=Object.keys(e.wantedTiles[r]).length),t.tileCache);e.highWaterMark<i&&(e.highWaterMark=i)},e.prototype.manageTilePyramid=function(e,t,r,i,n,o,a,s,l){for(var d,h,p,T,g,u=getUid(t),c=(u in e.wantedTiles||(e.wantedTiles[u]={}),e.wantedTiles[u]),m=e.tileQueue,f=r.getMinZoom();f<=a;++f)for(h=r.getTileRangeForExtentAndZ(o,f,h),p=r.getResolution(f),T=h.minX;T<=h.maxX;++T)for(g=h.minY;g<=h.maxY;++g)a-f<=s?((d=t.getTile(f,T,g,i,n)).getState()==TileState.IDLE&&(c[d.getKey()]=!0,m.isKeyQueued(d.getKey())||m.enqueue([d,u,r.getTileCoordCenter(d.tileCoord),p])),void 0!==l&&l(d)):t.useTile(f,T,g,n)},e}(CanvasLayerRenderer);CanvasTileLayerRenderer.prototype.getLayer;export default CanvasTileLayerRenderer;