var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};return function(e,t){function o(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}();import EventType from"../events/EventType.js";import Feature from"../Feature.js";import MapBrowserEventType from"../MapBrowserEventType.js";import MapBrowserPointerEvent from"../MapBrowserPointerEvent.js";import{getChangeEventType}from"../Object.js";import{squaredDistance as squaredCoordinateDistance}from"../coordinate.js";import Event from"../events/Event.js";import{noModifierKeys,always,shiftKeyOnly}from"../events/condition.js";import{boundingExtent,getBottomLeft,getBottomRight,getTopLeft,getTopRight}from"../extent.js";import{TRUE,FALSE}from"../functions.js";import Circle from"../geom/Circle.js";import GeometryType from"../geom/GeometryType.js";import LineString from"../geom/LineString.js";import MultiLineString from"../geom/MultiLineString.js";import MultiPoint from"../geom/MultiPoint.js";import MultiPolygon from"../geom/MultiPolygon.js";import Point from"../geom/Point.js";import Polygon,{fromCircle,makeRegular}from"../geom/Polygon.js";import PointerInteraction from"./Pointer.js";import InteractionProperty from"./Property.js";import VectorLayer from"../layer/Vector.js";import VectorSource from"../source/Vector.js";import{createEditingStyle}from"../style/Style.js";var Mode={POINT:"Point",LINE_STRING:"LineString",POLYGON:"Polygon",CIRCLE:"Circle"},DrawEventType={DRAWSTART:"drawstart",DRAWEND:"drawend"},DrawEvent=function(o){function e(e,t){e=o.call(this,e)||this;return e.feature=t,e}return __extends(e,o),e}(Event),Draw=function(r){function e(e){var o,i,t=this,n=e,n=(n.stopDown||(n.stopDown=FALSE),(t=r.call(this,n)||this).shouldHandle_=!1,t.downPx_=null,t.downTimeout_,t.lastDragTime_,t.freehand_=!1,t.source_=e.source||null,t.features_=e.features||null,t.snapTolerance_=e.snapTolerance||12,t.type_=e.type,t.mode_=getMode(t.type_),t.stopClick_=!!e.stopClick,t.minPoints_=e.minPoints||(t.mode_===Mode.POLYGON?3:2),t.maxPoints_=e.maxPoints||1/0,t.finishCondition_=e.finishCondition||TRUE,e.geometryFunction);return n=n||(t.type_===GeometryType.CIRCLE?function(e,t){var t=t||new Circle([NaN,NaN]),o=squaredCoordinateDistance(e[0],e[1]);return t.setCenterAndRadius(e[0],Math.sqrt(o)),t}:((i=t.mode_)===Mode.POINT?o=Point:i===Mode.LINE_STRING?o=LineString:i===Mode.POLYGON&&(o=Polygon),function(e,t){return t?i===Mode.POLYGON?e[0].length?t.setCoordinates([e[0].concat([e[0][0]])]):t.setCoordinates([]):t.setCoordinates(e):t=new o(e),t})),t.geometryFunction_=n,t.dragVertexDelay_=void 0!==e.dragVertexDelay?e.dragVertexDelay:500,t.finishCoordinate_=null,t.sketchFeature_=null,t.sketchPoint_=null,t.sketchCoords_=null,t.sketchLine_=null,t.sketchLineCoords_=null,t.squaredClickTolerance_=e.clickTolerance?e.clickTolerance*e.clickTolerance:36,t.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:e.wrapX||!1}),style:e.style||getDefaultStyleFunction(),updateWhileInteracting:!0}),t.geometryName_=e.geometryName,t.condition_=e.condition||noModifierKeys,t.freehandCondition_,e.freehand?t.freehandCondition_=always:t.freehandCondition_=e.freehandCondition||shiftKeyOnly,t.addEventListener(getChangeEventType(InteractionProperty.ACTIVE),t.updateState_),t}return __extends(e,r),e.prototype.setMap=function(e){r.prototype.setMap.call(this,e),this.updateState_()},e.prototype.getOverlay=function(){return this.overlay_},e.prototype.handleEvent=function(e){e.originalEvent.type===EventType.CONTEXTMENU&&e.preventDefault(),this.freehand_=this.mode_!==Mode.POINT&&this.freehandCondition_(e);var t=e.type===MapBrowserEventType.POINTERMOVE,o=!0;return!this.freehand_&&this.lastDragTime_&&e.type===MapBrowserEventType.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=e.pixel,this.shouldHandle_=!this.freehand_,t=!0):this.lastDragTime_=void 0,this.shouldHandle_&&void 0!==this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&e.type===MapBrowserEventType.POINTERDRAG&&null!==this.sketchFeature_?(this.addToDrawing_(e),o=!1):this.freehand_&&e.type===MapBrowserEventType.POINTERDOWN?o=!1:t?(o=e.type===MapBrowserEventType.POINTERMOVE)&&this.freehand_?o=this.handlePointerMove_(e):("mouse"==e.pointerEvent.pointerType||e.type===MapBrowserEventType.POINTERDRAG&&void 0===this.downTimeout_)&&this.handlePointerMove_(e):e.type===MapBrowserEventType.DBLCLICK&&(o=!1),r.prototype.handleEvent.call(this,e)&&o},e.prototype.handleDownEvent=function(e){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=e.pixel,this.finishCoordinate_||this.startDrawing_(e),!0):this.condition_(e)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(function(){this.handlePointerMove_(new MapBrowserPointerEvent(MapBrowserEventType.POINTERMOVE,e.map,e.pointerEvent,!1,e.frameState))}.bind(this),this.dragVertexDelay_),this.downPx_=e.pixel,!0):(this.lastDragTime_=void 0,!1)},e.prototype.handleUpEvent=function(e){var t=!0,o=(this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(e),this.mode_===Mode.CIRCLE);return this.shouldHandle_?(this.finishCoordinate_?this.freehand_||o?this.finishDrawing():this.atFinish_(e)?this.finishCondition_(e)&&this.finishDrawing():this.addToDrawing_(e):(this.startDrawing_(e),this.mode_===Mode.POINT&&this.finishDrawing()),t=!1):this.freehand_&&(this.finishCoordinate_=null,this.abortDrawing_()),!t&&this.stopClick_&&e.stopPropagation(),t},e.prototype.handlePointerMove_=function(e){if(this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){var t=this.downPx_,o=e.pixel,i=t[0]-o[0],t=t[1]-o[1],o=i*i+t*t;if(this.shouldHandle_=this.freehand_?o>this.squaredClickTolerance_:o<=this.squaredClickTolerance_,!this.shouldHandle_)return!0}return this.finishCoordinate_?this.modifyDrawing_(e):this.createOrUpdateSketchPoint_(e),!0},e.prototype.atFinish_=function(e){var t=!1;if(this.sketchFeature_){var o,i=!1,n=[this.finishCoordinate_];if(this.mode_===Mode.LINE_STRING?i=this.sketchCoords_.length>this.minPoints_:this.mode_===Mode.POLYGON&&(i=(o=this.sketchCoords_)[0].length>this.minPoints_,n=[o[0][0],o[0][o[0].length-2]]),i)for(var r=e.map,s=0,h=n.length;s<h;s++){var a=n[s],_=r.getPixelFromCoordinate(a),d=e.pixel,c=d[0]-_[0],d=d[1]-_[1],_=this.freehand_?1:this.snapTolerance_;if(t=Math.sqrt(c*c+d*d)<=_){this.finishCoordinate_=a;break}}}return t},e.prototype.createOrUpdateSketchPoint_=function(e){e=e.coordinate.slice();this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(e):(this.sketchPoint_=new Feature(new Point(e)),this.updateSketchFeatures_())},e.prototype.startDrawing_=function(e){e=e.coordinate,this.finishCoordinate_=e,this.mode_===Mode.POINT?this.sketchCoords_=e.slice():this.mode_===Mode.POLYGON?(this.sketchCoords_=[[e.slice(),e.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[e.slice(),e.slice()],this.sketchLineCoords_&&(this.sketchLine_=new Feature(new LineString(this.sketchLineCoords_))),e=this.geometryFunction_(this.sketchCoords_);this.sketchFeature_=new Feature,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(e),this.updateSketchFeatures_(),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWSTART,this.sketchFeature_))},e.prototype.modifyDrawing_=function(e){var t,o,i,n=e.coordinate,r=this.sketchFeature_.getGeometry();this.mode_===Mode.POINT?o=this.sketchCoords_:this.mode_===Mode.POLYGON?(o=(t=this.sketchCoords_[0])[t.length-1],this.atFinish_(e)&&(n=this.finishCoordinate_.slice())):o=(t=this.sketchCoords_)[t.length-1],o[0]=n[0],o[1]=n[1],this.geometryFunction_(this.sketchCoords_,r),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(n),r.getType()==GeometryType.POLYGON&&this.mode_!==Mode.POLYGON?(this.sketchLine_||(this.sketchLine_=new Feature),e=r.getLinearRing(0),(i=this.sketchLine_.getGeometry())?(i.setFlatCoordinates(e.getLayout(),e.getFlatCoordinates()),i.changed()):(i=new LineString(e.getFlatCoordinates(),e.getLayout()),this.sketchLine_.setGeometry(i))):this.sketchLineCoords_&&(i=this.sketchLine_.getGeometry()).setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()},e.prototype.addToDrawing_=function(e){var t,o,e=e.coordinate,i=this.sketchFeature_.getGeometry();this.mode_===Mode.LINE_STRING?(this.finishCoordinate_=e.slice(),(o=this.sketchCoords_).length>=this.maxPoints_&&(this.freehand_?o.pop():t=!0),o.push(e.slice()),this.geometryFunction_(o,i)):this.mode_===Mode.POLYGON&&((o=this.sketchCoords_[0]).length>=this.maxPoints_&&(this.freehand_?o.pop():t=!0),o.push(e.slice()),t&&(this.finishCoordinate_=o[0]),this.geometryFunction_(this.sketchCoords_,i)),this.updateSketchFeatures_(),t&&this.finishDrawing()},e.prototype.removeLastPoint=function(){var e,t;this.sketchFeature_&&(e=this.sketchFeature_.getGeometry(),this.mode_===Mode.LINE_STRING?((t=this.sketchCoords_).splice(-2,1),this.geometryFunction_(t,e),2<=t.length&&(this.finishCoordinate_=t[t.length-2].slice())):this.mode_===Mode.POLYGON&&((t=this.sketchCoords_[0]).splice(-2,1),this.sketchLine_.getGeometry().setCoordinates(t),this.geometryFunction_(this.sketchCoords_,e)),0===t.length&&(this.finishCoordinate_=null),this.updateSketchFeatures_())},e.prototype.finishDrawing=function(){var e,t,o=this.abortDrawing_();o&&(e=this.sketchCoords_,t=o.getGeometry(),this.mode_===Mode.LINE_STRING?(e.pop(),this.geometryFunction_(e,t)):this.mode_===Mode.POLYGON&&(e[0].pop(),this.geometryFunction_(e,t),e=t.getCoordinates()),this.type_===GeometryType.MULTI_POINT?o.setGeometry(new MultiPoint([e])):this.type_===GeometryType.MULTI_LINE_STRING?o.setGeometry(new MultiLineString([e])):this.type_===GeometryType.MULTI_POLYGON&&o.setGeometry(new MultiPolygon([e])),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWEND,o)),this.features_&&this.features_.push(o),this.source_&&this.source_.addFeature(o))},e.prototype.abortDrawing_=function(){this.finishCoordinate_=null;var e=this.sketchFeature_;return e&&(this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0)),e},e.prototype.extend=function(e){var t=e.getGeometry(),e=(this.sketchFeature_=e,this.sketchCoords_=t.getCoordinates(),this.sketchCoords_[this.sketchCoords_.length-1]);this.finishCoordinate_=e.slice(),this.sketchCoords_.push(e.slice()),this.updateSketchFeatures_(),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWSTART,this.sketchFeature_))},e.prototype.updateSketchFeatures_=function(){var e=[],t=(this.sketchFeature_&&e.push(this.sketchFeature_),this.sketchLine_&&e.push(this.sketchLine_),this.sketchPoint_&&e.push(this.sketchPoint_),this.overlay_.getSource());t.clear(!0),t.addFeatures(e)},e.prototype.updateState_=function(){var e=this.getMap(),t=this.getActive();e&&t||this.abortDrawing_(),this.overlay_.setMap(t?e:null)},e}(PointerInteraction);function getDefaultStyleFunction(){var o=createEditingStyle();return function(e,t){return o[e.getGeometry().getType()]}}function createRegularPolygon(s,h){return function(e,t){var o,i=e[0],e=e[1],n=Math.sqrt(squaredCoordinateDistance(i,e)),t=t||fromCircle(new Circle(i),s),r=h;return h||(o=e[0]-i[0],e=e[1]-i[1],r=Math.atan(e/o)-(o<0?Math.PI:0)),makeRegular(t,i,n,r),t}}function createBox(){return function(e,t){e=boundingExtent(e),e=[[getBottomLeft(e),getBottomRight(e),getTopRight(e),getTopLeft(e),getBottomLeft(e)]];return t?t.setCoordinates(e):t=new Polygon(e),t}}function getMode(e){var t;return e===GeometryType.POINT||e===GeometryType.MULTI_POINT?t=Mode.POINT:e===GeometryType.LINE_STRING||e===GeometryType.MULTI_LINE_STRING?t=Mode.LINE_STRING:e===GeometryType.POLYGON||e===GeometryType.MULTI_POLYGON?t=Mode.POLYGON:e===GeometryType.CIRCLE&&(t=Mode.CIRCLE),t}export default Draw;export{createRegularPolygon,createBox};