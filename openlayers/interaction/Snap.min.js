var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{getUid}from"../util.js";import CollectionEventType from"../CollectionEventType.js";import{distance as coordinateDistance,squaredDistance as squaredCoordinateDistance,closestOnCircle,closestOnSegment,squaredDistanceToSegment}from"../coordinate.js";import{listen,unlistenByKey}from"../events.js";import EventType from"../events/EventType.js";import{boundingExtent,createEmpty}from"../extent.js";import{TRUE,FALSE}from"../functions.js";import GeometryType from"../geom/GeometryType.js";import{fromCircle}from"../geom/Polygon.js";import PointerInteraction from"./Pointer.js";import{getValues}from"../obj.js";import VectorEventType from"../source/VectorEventType.js";import RBush from"../structs/RBush.js";function getFeatureFromEvent(e){return e.feature||e.element||void 0}var Snap=function(o){function e(e){var t=this,e=e||{},r=e;return r.handleDownEvent||(r.handleDownEvent=TRUE),r.stopDown||(r.stopDown=FALSE),(t=o.call(this,r)||this).source_=e.source||null,t.vertex_=void 0===e.vertex||e.vertex,t.edge_=void 0===e.edge||e.edge,t.features_=e.features||null,t.featuresListenerKeys_=[],t.featureChangeListenerKeys_={},t.indexedFeaturesExtents_={},t.pendingFeatures_={},t.pixelCoordinate_=null,t.pixelTolerance_=void 0!==e.pixelTolerance?e.pixelTolerance:10,t.sortByDistance_=sortByDistance.bind(t),t.rBush_=new RBush,t.SEGMENT_WRITERS_={Point:t.writePointGeometry_,LineString:t.writeLineStringGeometry_,LinearRing:t.writeLineStringGeometry_,Polygon:t.writePolygonGeometry_,MultiPoint:t.writeMultiPointGeometry_,MultiLineString:t.writeMultiLineStringGeometry_,MultiPolygon:t.writeMultiPolygonGeometry_,GeometryCollection:t.writeGeometryCollectionGeometry_,Circle:t.writeCircleGeometry_},t}return __extends(e,o),e.prototype.addFeature=function(e,t){var r,t=void 0===t||t,n=getUid(e),o=e.getGeometry();o&&(r=this.SEGMENT_WRITERS_[o.getType()])&&(this.indexedFeaturesExtents_[n]=o.getExtent(createEmpty()),r.call(this,e,o)),t&&(this.featureChangeListenerKeys_[n]=listen(e,EventType.CHANGE,this.handleFeatureChange_,this))},e.prototype.forEachFeatureAdd_=function(e){this.addFeature(e)},e.prototype.forEachFeatureRemove_=function(e){this.removeFeature(e)},e.prototype.getFeatures_=function(){var e;return this.features_?e=this.features_:this.source_&&(e=this.source_.getFeatures()),e},e.prototype.handleEvent=function(e){var t=this.snapTo(e.pixel,e.coordinate,e.map);return t.snapped&&(e.coordinate=t.vertex.slice(0,2),e.pixel=t.vertexPixel),o.prototype.handleEvent.call(this,e)},e.prototype.handleFeatureAdd_=function(e){e=getFeatureFromEvent(e);this.addFeature(e)},e.prototype.handleFeatureRemove_=function(e){e=getFeatureFromEvent(e);this.removeFeature(e)},e.prototype.handleFeatureChange_=function(e){var t,e=e.target;this.handlingDownUpSequence?(t=getUid(e))in this.pendingFeatures_||(this.pendingFeatures_[t]=e):this.updateFeature_(e)},e.prototype.handleUpEvent=function(e){var t=getValues(this.pendingFeatures_);return t.length&&(t.forEach(this.updateFeature_.bind(this)),this.pendingFeatures_={}),!1},e.prototype.removeFeature=function(t,e){var e=void 0===e||e,r=getUid(t),n=this.indexedFeaturesExtents_[r];if(n){var o=this.rBush_,i=[];o.forEachInExtent(n,function(e){t===e.feature&&i.push(e)});for(var s=i.length-1;0<=s;--s)o.remove(i[s])}e&&(unlistenByKey(this.featureChangeListenerKeys_[r]),delete this.featureChangeListenerKeys_[r])},e.prototype.setMap=function(e){var t=this.getMap(),r=this.featuresListenerKeys_,n=this.getFeatures_();t&&(r.forEach(unlistenByKey),r.length=0,n.forEach(this.forEachFeatureRemove_.bind(this))),o.prototype.setMap.call(this,e),e&&(this.features_?r.push(listen(this.features_,CollectionEventType.ADD,this.handleFeatureAdd_,this),listen(this.features_,CollectionEventType.REMOVE,this.handleFeatureRemove_,this)):this.source_&&r.push(listen(this.source_,VectorEventType.ADDFEATURE,this.handleFeatureAdd_,this),listen(this.source_,VectorEventType.REMOVEFEATURE,this.handleFeatureRemove_,this)),n.forEach(this.forEachFeatureAdd_.bind(this)))},e.prototype.snapTo=function(e,t,r){var n,o,i,s,a,u,h=r.getCoordinateFromPixel([e[0]-this.pixelTolerance_,e[1]+this.pixelTolerance_]),l=r.getCoordinateFromPixel([e[0]+this.pixelTolerance_,e[1]-this.pixelTolerance_]),h=boundingExtent([h,l]),l=this.rBush_.getInExtent(h),h=!1,p=null,c=null;return 0<(l=this.vertex_&&!this.edge_?l.filter(function(e){return e.feature.getGeometry().getType()!==GeometryType.CIRCLE}):l).length&&(this.pixelCoordinate_=t,l.sort(this.sortByDistance_),a=l[0].segment,u=l[0].feature.getGeometry().getType()===GeometryType.CIRCLE,this.vertex_&&!this.edge_?(n=r.getPixelFromCoordinate(a[0]),o=r.getPixelFromCoordinate(a[1]),i=squaredCoordinateDistance(e,n),s=squaredCoordinateDistance(e,o),Math.sqrt(Math.min(i,s))<=this.pixelTolerance_&&(h=!0,p=s<i?a[1]:a[0],c=r.getPixelFromCoordinate(p))):this.edge_&&(p=u?closestOnCircle(t,l[0].feature.getGeometry()):closestOnSegment(t,a),c=r.getPixelFromCoordinate(p),coordinateDistance(e,c)<=this.pixelTolerance_&&(h=!0,this.vertex_&&!u&&(n=r.getPixelFromCoordinate(a[0]),o=r.getPixelFromCoordinate(a[1]),i=squaredCoordinateDistance(c,n),s=squaredCoordinateDistance(c,o),Math.sqrt(Math.min(i,s))<=this.pixelTolerance_&&(p=s<i?a[1]:a[0],c=r.getPixelFromCoordinate(p))))),h&&(c=[Math.round(c[0]),Math.round(c[1])])),{snapped:h,vertex:p,vertexPixel:c}},e.prototype.updateFeature_=function(e){this.removeFeature(e,!1),this.addFeature(e,!1)},e.prototype.writeCircleGeometry_=function(e,t){for(var r=fromCircle(t).getCoordinates()[0],n=0,o=r.length-1;n<o;++n){var i=r.slice(n,n+2),s={feature:e,segment:i};this.rBush_.insert(boundingExtent(i),s)}},e.prototype.writeGeometryCollectionGeometry_=function(e,t){for(var r=t.getGeometriesArray(),n=0;n<r.length;++n){var o=this.SEGMENT_WRITERS_[r[n].getType()];o&&o.call(this,e,r[n])}},e.prototype.writeLineStringGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length-1;n<o;++n){var i=r.slice(n,n+2),s={feature:e,segment:i};this.rBush_.insert(boundingExtent(i),s)}},e.prototype.writeMultiLineStringGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],s=0,a=i.length-1;s<a;++s){var u=i.slice(s,s+2),h={feature:e,segment:u};this.rBush_.insert(boundingExtent(u),h)}},e.prototype.writeMultiPointGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n){var i=r[n],i={feature:e,segment:[i,i]};this.rBush_.insert(t.getExtent(),i)}},e.prototype.writeMultiPolygonGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],s=0,a=i.length;s<a;++s)for(var u=i[s],h=0,l=u.length-1;h<l;++h){var p=u.slice(h,h+2),c={feature:e,segment:p};this.rBush_.insert(boundingExtent(p),c)}},e.prototype.writePointGeometry_=function(e,t){var r=t.getCoordinates(),e={feature:e,segment:[r,r]};this.rBush_.insert(t.getExtent(),e)},e.prototype.writePolygonGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],s=0,a=i.length-1;s<a;++s){var u=i.slice(s,s+2),h={feature:e,segment:u};this.rBush_.insert(boundingExtent(u),h)}},e}(PointerInteraction);function sortByDistance(e,t){return squaredDistanceToSegment(this.pixelCoordinate_,e.segment)-squaredDistanceToSegment(this.pixelCoordinate_,t.segment)}export default Snap;