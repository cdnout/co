var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};return function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}}();import Feature from"../Feature.js";import MapBrowserEventType from"../MapBrowserEventType.js";import{squaredDistanceToSegment,closestOnSegment,distance as coordinateDistance,squaredDistance as squaredCoordinateDistance}from"../coordinate.js";import Event from"../events/Event.js";import{boundingExtent,getArea}from"../extent.js";import GeometryType from"../geom/GeometryType.js";import Point from"../geom/Point.js";import{fromExtent as polygonFromExtent}from"../geom/Polygon.js";import PointerInteraction from"./Pointer.js";import VectorLayer from"../layer/Vector.js";import VectorSource from"../source/Vector.js";import{createEditingStyle}from"../style/Style.js";var ExtentEventType={EXTENTCHANGED:"extentchanged"},ExtentEvent=function(n){function e(e){var t=n.call(this,ExtentEventType.EXTENTCHANGED)||this;return t.extent=e,t}return __extends(e,n),e}(Event),Extent=function(r){function e(e){var t=this,n=e||{};return(t=r.call(this,n)||this).extent_=null,t.pointerHandler_=null,t.pixelTolerance_=void 0!==n.pixelTolerance?n.pixelTolerance:10,t.snappedToVertex_=!1,t.extentFeature_=null,t.vertexFeature_=null,t.extentOverlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:!!(e=e||{}).wrapX}),style:e.boxStyle||getDefaultExtentStyleFunction(),updateWhileAnimating:!0,updateWhileInteracting:!0}),t.vertexOverlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:!!e.wrapX}),style:e.pointerStyle||getDefaultPointerStyleFunction(),updateWhileAnimating:!0,updateWhileInteracting:!0}),e.extent&&t.setExtent(e.extent),t}return __extends(e,r),e.prototype.snapToVertex_=function(e,t){var n=t.getCoordinateFromPixel(e),r=this.getExtent();if(r){var r=getSegments(r),r=(r.sort(function(e,t){return squaredDistanceToSegment(n,e)-squaredDistanceToSegment(n,t)}),r[0]),o=closestOnSegment(n,r),i=t.getPixelFromCoordinate(o);if(coordinateDistance(e,i)<=this.pixelTolerance_)return e=t.getPixelFromCoordinate(r[0]),t=t.getPixelFromCoordinate(r[1]),e=squaredCoordinateDistance(i,e),i=squaredCoordinateDistance(i,t),t=Math.sqrt(Math.min(e,i)),this.snappedToVertex_=t<=this.pixelTolerance_,this.snappedToVertex_?i<e?r[1]:r[0]:o}return null},e.prototype.handlePointerMove_=function(e){var t=e.pixel,e=e.map,n=(n=this.snapToVertex_(t,e))||e.getCoordinateFromPixel(t);this.createOrUpdatePointerFeature_(n)},e.prototype.createOrUpdateExtentFeature_=function(e){var t=this.extentFeature_;return t?e?t.setGeometry(polygonFromExtent(e)):t.setGeometry(void 0):(t=new Feature(e?polygonFromExtent(e):{}),this.extentFeature_=t,this.extentOverlay_.getSource().addFeature(t)),t},e.prototype.createOrUpdatePointerFeature_=function(e){var t=this.vertexFeature_;return t?t.getGeometry().setCoordinates(e):(t=new Feature(new Point(e)),this.vertexFeature_=t,this.vertexOverlay_.getSource().addFeature(t)),t},e.prototype.handleEvent=function(e){return!e.pointerEvent||(e.type!=MapBrowserEventType.POINTERMOVE||this.handlingDownUpSequence||this.handlePointerMove_(e),r.prototype.handleEvent.call(this,e),!1)},e.prototype.handleDownEvent=function(e){function t(e){var t=null,n=null;return e[0]==i[0]?t=i[2]:e[0]==i[2]&&(t=i[0]),e[1]==i[1]?n=i[3]:e[1]==i[3]&&(n=i[1]),null!==t&&null!==n?[t,n]:null}var n,r,o=e.pixel,e=e.map,i=this.getExtent(),a=this.snapToVertex_(o,e);return a&&i?(n=a[0]==i[0]||a[0]==i[2]?a[0]:null,r=a[1]==i[1]||a[1]==i[3]?a[1]:null,null!==n&&null!==r?this.pointerHandler_=getPointHandler(t(a)):null!==n?this.pointerHandler_=getEdgeHandler(t([n,i[1]]),t([n,i[3]])):null!==r&&(this.pointerHandler_=getEdgeHandler(t([i[0],r]),t([i[2],r])))):(a=e.getCoordinateFromPixel(o),this.setExtent([a[0],a[1],a[0],a[1]]),this.pointerHandler_=getPointHandler(a)),!0},e.prototype.handleDragEvent=function(e){return this.pointerHandler_&&(e=e.coordinate,this.setExtent(this.pointerHandler_(e)),this.createOrUpdatePointerFeature_(e)),!0},e.prototype.handleUpEvent=function(e){this.pointerHandler_=null;var t=this.getExtent();return t&&0!==getArea(t)||this.setExtent(null),!1},e.prototype.setMap=function(e){this.extentOverlay_.setMap(e),this.vertexOverlay_.setMap(e),r.prototype.setMap.call(this,e)},e.prototype.getExtent=function(){return this.extent_},e.prototype.setExtent=function(e){this.extent_=e||null,this.createOrUpdateExtentFeature_(e),this.dispatchEvent(new ExtentEvent(this.extent_))},e}(PointerInteraction);function getDefaultExtentStyleFunction(){var n=createEditingStyle();return function(e,t){return n[GeometryType.POLYGON]}}function getDefaultPointerStyleFunction(){var n=createEditingStyle();return function(e,t){return n[GeometryType.POINT]}}function getPointHandler(t){return function(e){return boundingExtent([t,e])}}function getEdgeHandler(t,n){return t[0]==n[0]?function(e){return boundingExtent([t,[e[0],n[1]]])}:t[1]==n[1]?function(e){return boundingExtent([t,[n[0],e[1]]])}:null}function getSegments(e){return[[[e[0],e[1]],[e[0],e[3]]],[[e[0],e[3]],[e[2],e[3]]],[[e[2],e[3]],[e[2],e[1]]],[[e[2],e[1]],[e[0],e[1]]]]}export default Extent;