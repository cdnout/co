var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();import{TRUE}from"../functions.js";import{listen,unlistenByKey}from"../events.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import Interaction from"./Interaction.js";import{get as getProjection}from"../proj.js";var DragAndDropEventType={ADD_FEATURES:"addfeatures"},DragAndDropEvent=function(o){function t(t,e,r,n){t=o.call(this,t)||this;return t.features=r,t.file=e,t.projection=n,t}return __extends(t,o),t}(Event),DragAndDrop=function(r){function t(t){var e=this,t=t||{};return(e=r.call(this,{handleEvent:TRUE})||this).formatConstructors_=t.formatConstructors||[],e.projection_=t.projection?getProjection(t.projection):null,e.dropListenKeys_=null,e.source_=t.source||null,e.target=t.target||null,e}return __extends(t,r),t.prototype.handleResult_=function(t,e){for(var r=e.target.result,e=this.getMap(),n=this.projection_,o=(n=n||e.getView().getProjection(),this.formatConstructors_),s=[],i=0,a=o.length;i<a;++i){var p=new o[i];if((s=this.tryReadFeatures_(p,r,{featureProjection:n}))&&0<s.length)break}this.source_&&(this.source_.clear(),this.source_.addFeatures(s)),this.dispatchEvent(new DragAndDropEvent(DragAndDropEventType.ADD_FEATURES,t,s,n))},t.prototype.registerListeners_=function(){var t=this.getMap();t&&(t=this.target||t.getViewport(),this.dropListenKeys_=[listen(t,EventType.DROP,handleDrop,this),listen(t,EventType.DRAGENTER,handleStop,this),listen(t,EventType.DRAGOVER,handleStop,this),listen(t,EventType.DROP,handleStop,this)])},t.prototype.setActive=function(t){!this.getActive()&&t&&this.registerListeners_(),this.getActive()&&!t&&this.unregisterListeners_(),r.prototype.setActive.call(this,t)},t.prototype.setMap=function(t){this.unregisterListeners_(),r.prototype.setMap.call(this,t),this.getActive()&&this.registerListeners_()},t.prototype.tryReadFeatures_=function(t,e,r){try{return t.readFeatures(e,r)}catch(t){return null}},t.prototype.unregisterListeners_=function(){this.dropListenKeys_&&(this.dropListenKeys_.forEach(unlistenByKey),this.dropListenKeys_=null)},t}(Interaction);function handleDrop(t){for(var e=t.dataTransfer.files,r=0,n=e.length;r<n;++r){var o=e.item(r),s=new FileReader;s.addEventListener(EventType.LOAD,this.handleResult_.bind(this,o)),s.readAsText(o)}}function handleStop(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"}export default DragAndDrop;