var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{getUid}from"../util.js";import Collection from"../Collection.js";import CollectionEventType from"../CollectionEventType.js";import Feature from"../Feature.js";import MapBrowserEventType from"../MapBrowserEventType.js";import{equals}from"../array.js";import{equals as coordinatesEqual,distance as coordinateDistance,squaredDistance as squaredCoordinateDistance,squaredDistanceToSegment,closestOnSegment}from"../coordinate.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import{always,primaryAction,altKeyOnly,singleClick}from"../events/condition.js";import{boundingExtent,buffer,createOrUpdateFromCoordinate}from"../extent.js";import GeometryType from"../geom/GeometryType.js";import Point from"../geom/Point.js";import PointerInteraction from"./Pointer.js";import VectorLayer from"../layer/Vector.js";import VectorSource from"../source/Vector.js";import VectorEventType from"../source/VectorEventType.js";import RBush from"../structs/RBush.js";import{createEditingStyle}from"../style/Style.js";var CIRCLE_CENTER_INDEX=0,CIRCLE_CIRCUMFERENCE_INDEX=1,ModifyEventType={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"},ModifyEvent=function(n){function e(e,t,r){e=n.call(this,e)||this;return e.features=t,e.mapBrowserEvent=r,e}return __extends(e,n),e}(Event),Modify=function(n){function e(e){var t,r=n.call(this,e)||this;if(r.boundHandleFeatureChange_=r.handleFeatureChange_.bind(r),r.condition_=e.condition||primaryAction,r.defaultDeleteCondition_=function(e){return altKeyOnly(e)&&singleClick(e)},r.deleteCondition_=e.deleteCondition||r.defaultDeleteCondition_,r.insertVertexCondition_=e.insertVertexCondition||always,r.vertexFeature_=null,r.vertexSegments_=null,r.lastPixel_=[0,0],r.ignoreNextSingleClick_=!1,r.modified_=!1,r.rBush_=new RBush,r.pixelTolerance_=void 0!==e.pixelTolerance?e.pixelTolerance:10,r.snappedToVertex_=!1,r.changingFeature_=!1,r.dragSegments_=[],r.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:!!e.wrapX}),style:e.style||getDefaultStyleFunction(),updateWhileAnimating:!0,updateWhileInteracting:!0}),r.SEGMENT_WRITERS_={Point:r.writePointGeometry_,LineString:r.writeLineStringGeometry_,LinearRing:r.writeLineStringGeometry_,Polygon:r.writePolygonGeometry_,MultiPoint:r.writeMultiPointGeometry_,MultiLineString:r.writeMultiLineStringGeometry_,MultiPolygon:r.writeMultiPolygonGeometry_,Circle:r.writeCircleGeometry_,GeometryCollection:r.writeGeometryCollectionGeometry_},r.source_=null,e.source?(r.source_=e.source,t=new Collection(r.source_.getFeatures()),r.source_.addEventListener(VectorEventType.ADDFEATURE,r.handleSourceAdd_.bind(r)),r.source_.addEventListener(VectorEventType.REMOVEFEATURE,r.handleSourceRemove_.bind(r))):t=e.features,t)return r.features_=t,r.features_.forEach(r.addFeature_.bind(r)),r.features_.addEventListener(CollectionEventType.ADD,r.handleFeatureAdd_.bind(r)),r.features_.addEventListener(CollectionEventType.REMOVE,r.handleFeatureRemove_.bind(r)),r.lastPointerEvent_=null,r;throw new Error("The modify interaction requires features or a source")}return __extends(e,n),e.prototype.addFeature_=function(e){var t=e.getGeometry(),t=(t&&t.getType()in this.SEGMENT_WRITERS_&&this.SEGMENT_WRITERS_[t.getType()].call(this,e,t),this.getMap());t&&t.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(this.lastPixel_,t),e.addEventListener(EventType.CHANGE,this.boundHandleFeatureChange_)},e.prototype.willModifyFeatures_=function(e){this.modified_||(this.modified_=!0,this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYSTART,this.features_,e)))},e.prototype.removeFeature_=function(e){this.removeFeatureSegmentData_(e),this.vertexFeature_&&0===this.features_.getLength()&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.removeEventListener(EventType.CHANGE,this.boundHandleFeatureChange_)},e.prototype.removeFeatureSegmentData_=function(t){var e=this.rBush_,r=[];e.forEach(function(e){t===e.feature&&r.push(e)});for(var n=r.length-1;0<=n;--n){for(var o=r[n],i=this.dragSegments_.length-1;0<=i;--i)this.dragSegments_[i][0]===o&&this.dragSegments_.splice(i,1);e.remove(o)}},e.prototype.setActive=function(e){this.vertexFeature_&&!e&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),n.prototype.setActive.call(this,e)},e.prototype.setMap=function(e){this.overlay_.setMap(e),n.prototype.setMap.call(this,e)},e.prototype.getOverlay=function(){return this.overlay_},e.prototype.handleSourceAdd_=function(e){e.feature&&this.features_.push(e.feature)},e.prototype.handleSourceRemove_=function(e){e.feature&&this.features_.remove(e.feature)},e.prototype.handleFeatureAdd_=function(e){this.addFeature_(e.element)},e.prototype.handleFeatureChange_=function(e){this.changingFeature_||(e=e.target,this.removeFeature_(e),this.addFeature_(e))},e.prototype.handleFeatureRemove_=function(e){e=e.element;this.removeFeature_(e)},e.prototype.writePointGeometry_=function(e,t){var r=t.getCoordinates(),e={feature:e,geometry:t,segment:[r,r]};this.rBush_.insert(t.getExtent(),e)},e.prototype.writeMultiPointGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n){var i=r[n],i={feature:e,geometry:t,depth:[n],index:n,segment:[i,i]};this.rBush_.insert(t.getExtent(),i)}},e.prototype.writeLineStringGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length-1;n<o;++n){var i=r.slice(n,n+2),s={feature:e,geometry:t,index:n,segment:i};this.rBush_.insert(boundingExtent(i),s)}},e.prototype.writeMultiLineStringGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],s=0,a=i.length-1;s<a;++s){var u=i.slice(s,s+2),d={feature:e,geometry:t,depth:[n],index:s,segment:u};this.rBush_.insert(boundingExtent(u),d)}},e.prototype.writePolygonGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],s=0,a=i.length-1;s<a;++s){var u=i.slice(s,s+2),d={feature:e,geometry:t,depth:[n],index:s,segment:u};this.rBush_.insert(boundingExtent(u),d)}},e.prototype.writeMultiPolygonGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],s=0,a=i.length;s<a;++s)for(var u=i[s],d=0,h=u.length-1;d<h;++d){var g=u.slice(d,d+2),p={feature:e,geometry:t,depth:[s,n],index:d,segment:g};this.rBush_.insert(boundingExtent(g),p)}},e.prototype.writeCircleGeometry_=function(e,t){var r=t.getCenter(),n={feature:e,geometry:t,index:CIRCLE_CENTER_INDEX,segment:[r,r]},e={feature:e,geometry:t,index:CIRCLE_CIRCUMFERENCE_INDEX,segment:[r,r]};n.featureSegments=e.featureSegments=[n,e],this.rBush_.insert(createOrUpdateFromCoordinate(r),n),this.rBush_.insert(t.getExtent(),e)},e.prototype.writeGeometryCollectionGeometry_=function(e,t){for(var r=t.getGeometriesArray(),n=0;n<r.length;++n)this.SEGMENT_WRITERS_[r[n].getType()].call(this,e,r[n])},e.prototype.createOrUpdateVertexFeature_=function(e){var t=this.vertexFeature_;return t?t.getGeometry().setCoordinates(e):(t=new Feature(new Point(e)),this.vertexFeature_=t,this.overlay_.getSource().addFeature(t)),t},e.prototype.handleEvent=function(e){return!e.pointerEvent||((this.lastPointerEvent_=e).map.getView().getInteracting()||e.type!=MapBrowserEventType.POINTERMOVE||this.handlingDownUpSequence||this.handlePointerMove_(e),this.vertexFeature_&&this.deleteCondition_(e)&&(t=!(e.type!=MapBrowserEventType.SINGLECLICK||!this.ignoreNextSingleClick_)||this.removePoint()),e.type==MapBrowserEventType.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),n.prototype.handleEvent.call(this,e)&&!t);var t},e.prototype.handleDragEvent=function(e){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(e);for(var t=e.coordinate,r=0,n=this.dragSegments_.length;r<n;++r){for(var o=this.dragSegments_[r],i=o[0],s=i.depth,a=i.geometry,u=void 0,d=i.segment,h=o[1];t.length<a.getStride();)t.push(d[h][t.length]);switch(a.getType()){case GeometryType.POINT:d[0]=d[1]=u=t;break;case GeometryType.MULTI_POINT:(u=a.getCoordinates())[i.index]=t,d[0]=d[1]=t;break;case GeometryType.LINE_STRING:(u=a.getCoordinates())[i.index+h]=t,d[h]=t;break;case GeometryType.MULTI_LINE_STRING:case GeometryType.POLYGON:(u=a.getCoordinates())[s[0]][i.index+h]=t,d[h]=t;break;case GeometryType.MULTI_POLYGON:(u=a.getCoordinates())[s[1]][s[0]][i.index+h]=t,d[h]=t;break;case GeometryType.CIRCLE:d[0]=d[1]=t,i.index===CIRCLE_CENTER_INDEX?(this.changingFeature_=!0,a.setCenter(t)):(this.changingFeature_=!0,a.setRadius(coordinateDistance(a.getCenter(),t))),this.changingFeature_=!1}u&&this.setGeometryCoordinates_(a,u)}this.createOrUpdateVertexFeature_(t)},e.prototype.handleDownEvent=function(e){if(!this.condition_(e))return!1;this.handlePointerAtPixel_(e.pixel,e.map);var t=e.map.getCoordinateFromPixel(e.pixel),r=(this.dragSegments_.length=0,this.modified_=!1,this.vertexFeature_);if(r){var n=[],o=r.getGeometry().getCoordinates(),r=boundingExtent([o]),i=this.rBush_.getInExtent(r),s={};i.sort(compareIndexes);for(var a=0,u=i.length;a<u;++a){var d=i[a],h=d.segment,g=getUid(d.feature),p=d.depth;p&&(g+="-"+p.join("-")),s[g]||(s[g]=new Array(2)),d.geometry.getType()===GeometryType.CIRCLE&&d.index===CIRCLE_CIRCUMFERENCE_INDEX?(p=closestOnSegmentData(t,d),coordinatesEqual(p,o)&&!s[g][0]&&(this.dragSegments_.push([d,0]),s[g][0]=d)):coordinatesEqual(h[0],o)&&!s[g][0]?(this.dragSegments_.push([d,0]),s[g][0]=d):coordinatesEqual(h[1],o)&&!s[g][1]?(d.geometry.getType()===GeometryType.LINE_STRING||d.geometry.getType()===GeometryType.MULTI_LINE_STRING)&&s[g][0]&&0===s[g][0].index||(this.dragSegments_.push([d,1]),s[g][1]=d):getUid(h)in this.vertexSegments_&&!s[g][0]&&!s[g][1]&&this.insertVertexCondition_(e)&&n.push([d,o])}n.length&&this.willModifyFeatures_(e);for(var l=n.length-1;0<=l;--l)this.insertVertex_.apply(this,n[l])}return!!this.vertexFeature_},e.prototype.handleUpEvent=function(e){for(var t=this.dragSegments_.length-1;0<=t;--t){var r,n,o,i=this.dragSegments_[t][0],s=i.geometry;s.getType()===GeometryType.CIRCLE?(r=s.getCenter(),n=i.featureSegments[0],o=i.featureSegments[1],n.segment[0]=n.segment[1]=r,o.segment[0]=o.segment[1]=r,this.rBush_.update(createOrUpdateFromCoordinate(r),n),this.rBush_.update(s.getExtent(),o)):this.rBush_.update(boundingExtent(i.segment),i)}return this.modified_&&(this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.features_,e)),this.modified_=!1),!1},e.prototype.handlePointerMove_=function(e){this.lastPixel_=e.pixel,this.handlePointerAtPixel_(e.pixel,e.map)},e.prototype.handlePointerAtPixel_=function(e,t){var r=t.getCoordinateFromPixel(e),n=buffer(createOrUpdateFromCoordinate(r),t.getView().getResolution()*this.pixelTolerance_),o=this.rBush_.getInExtent(n);if(0<o.length){o.sort(function(e,t){return pointDistanceToSegmentDataSquared(r,e)-pointDistanceToSegmentDataSquared(r,t)});var n=o[0],i=n.segment,s=closestOnSegmentData(r,n),a=t.getPixelFromCoordinate(s);if(coordinateDistance(e,a)<=this.pixelTolerance_){var u={};if(n.geometry.getType()===GeometryType.CIRCLE&&n.index===CIRCLE_CIRCUMFERENCE_INDEX)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(s);else{e=t.getPixelFromCoordinate(i[0]),n=t.getPixelFromCoordinate(i[1]),t=squaredCoordinateDistance(a,e),e=squaredCoordinateDistance(a,n),a=Math.sqrt(Math.min(t,e));this.snappedToVertex_=a<=this.pixelTolerance_,this.snappedToVertex_&&(s=e<t?i[1]:i[0]),this.createOrUpdateVertexFeature_(s);for(var d=1,h=o.length;d<h;++d){var g=o[d].segment;if(!(coordinatesEqual(i[0],g[0])&&coordinatesEqual(i[1],g[1])||coordinatesEqual(i[0],g[1])&&coordinatesEqual(i[1],g[0])))break;u[getUid(g)]=!0}}return u[getUid(i)]=!0,void(this.vertexSegments_=u)}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)},e.prototype.insertVertex_=function(e,t){for(var r,n=e.segment,o=e.feature,i=e.geometry,s=e.depth,a=e.index;t.length<i.getStride();)t.push(0);switch(i.getType()){case GeometryType.MULTI_LINE_STRING:case GeometryType.POLYGON:(r=i.getCoordinates())[s[0]].splice(a+1,0,t);break;case GeometryType.MULTI_POLYGON:(r=i.getCoordinates())[s[1]][s[0]].splice(a+1,0,t);break;case GeometryType.LINE_STRING:(r=i.getCoordinates()).splice(a+1,0,t);break;default:return}this.setGeometryCoordinates_(i,r);var u=this.rBush_,e=(u.remove(e),this.updateSegmentIndices_(i,a,s,1),{segment:[n[0],t],feature:o,geometry:i,depth:s,index:a}),e=(u.insert(boundingExtent(e.segment),e),this.dragSegments_.push([e,1]),{segment:[t,n[1]],feature:o,geometry:i,depth:s,index:a+1});u.insert(boundingExtent(e.segment),e),this.dragSegments_.push([e,0]),this.ignoreNextSingleClick_=!0},e.prototype.removePoint=function(){var e,t;return!(!this.lastPointerEvent_||this.lastPointerEvent_.type==MapBrowserEventType.POINTERDRAG)&&(e=this.lastPointerEvent_,this.willModifyFeatures_(e),t=this.removeVertex_(),this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.features_,e)),this.modified_=!1,t)},e.prototype.removeVertex_=function(){for(var e,t,r,n,o,i,s,a,u,d,h,g=this.dragSegments_,p={},l=!1,_=g.length-1;0<=_;--_)a=(r=g[_])[0],u=getUid(a.feature),a.depth&&(u+="-"+a.depth.join("-")),u in p||(p[u]={}),0===r[1]?(p[u].right=a,p[u].index=a.index):1==r[1]&&(p[u].left=a,p[u].index=a.index+1);for(u in p){switch(s=p[u].right,h=p[u].left,(i=(o=p[u].index)-1)<0&&(i=0),e=t=(n=(a=void 0!==h?h:s).geometry).getCoordinates(),l=!1,n.getType()){case GeometryType.MULTI_LINE_STRING:2<t[a.depth[0]].length&&(t[a.depth[0]].splice(o,1),l=!0);break;case GeometryType.LINE_STRING:2<t.length&&(t.splice(o,1),l=!0);break;case GeometryType.MULTI_POLYGON:e=e[a.depth[1]];case GeometryType.POLYGON:4<(e=e[a.depth[0]]).length&&(o==e.length-1&&(o=0),e.splice(o,1),l=!0,0===o&&(e.pop(),e.push(e[0]),i=e.length-1))}l&&(this.setGeometryCoordinates_(n,t),d=[],void 0!==h&&(this.rBush_.remove(h),d.push(h.segment[0])),void 0!==s&&(this.rBush_.remove(s),d.push(s.segment[1])),void 0!==h&&void 0!==s&&(h={depth:a.depth,feature:a.feature,geometry:a.geometry,index:i,segment:d},this.rBush_.insert(boundingExtent(h.segment),h)),this.updateSegmentIndices_(n,o,a.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),g.length=0)}return l},e.prototype.setGeometryCoordinates_=function(e,t){this.changingFeature_=!0,e.setCoordinates(t),this.changingFeature_=!1},e.prototype.updateSegmentIndices_=function(t,r,n,o){this.rBush_.forEachInExtent(t.getExtent(),function(e){e.geometry===t&&(void 0===n||void 0===e.depth||equals(e.depth,n))&&e.index>r&&(e.index+=o)})},e}(PointerInteraction);function compareIndexes(e,t){return e.index-t.index}function pointDistanceToSegmentDataSquared(e,t){var r=t.geometry;if(r.getType()===GeometryType.CIRCLE){var n;if(t.index===CIRCLE_CIRCUMFERENCE_INDEX)return n=squaredCoordinateDistance(r.getCenter(),e),(n=Math.sqrt(n)-r.getRadius())*n}return squaredDistanceToSegment(e,t.segment)}function closestOnSegmentData(e,t){var r=t.geometry;return r.getType()===GeometryType.CIRCLE&&t.index===CIRCLE_CIRCUMFERENCE_INDEX?r.getClosestPoint(e):closestOnSegment(e,t.segment)}function getDefaultStyleFunction(){var r=createEditingStyle();return function(e,t){return r[GeometryType.POINT]}}export default Modify;export{ModifyEvent};