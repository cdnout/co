var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import Tile from"../Tile.js";import TileState from"../TileState.js";import{createFromTemplates,nullTileUrlFunction}from"../tileurlfunction.js";import{assert}from"../asserts.js";import{listenOnce}from"../events.js";import EventType from"../events/EventType.js";import{applyTransform,intersects}from"../extent.js";import{jsonp as requestJSONP}from"../net.js";import{get as getProjection,getTransformFromProjections}from"../proj.js";import SourceState from"./State.js";import TileSource from"./Tile.js";import{getKeyZXY}from"../tilecoord.js";import{createXYZ,extentFromProjection}from"../tilegrid.js";var CustomTile=function(s){function t(t,e,i,o,r,n){t=s.call(this,t,e)||this;return t.src_=i,t.extent_=o,t.preemptive_=r,t.grid_=null,t.keys_=null,t.data_=null,t.jsonp_=n,t}return __extends(t,s),t.prototype.getImage=function(){return null},t.prototype.getData=function(t){if(!this.grid_||!this.keys_)return null;var e=(t[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),t=(t[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),t=this.grid_[Math.floor((1-t)*this.grid_.length)];if("string"!=typeof t)return null;var e=t.charCodeAt(Math.floor(e*t.length)),t=(93<=e&&e--,35<=e&&e--,null);return(e-=32)in this.keys_&&(e=this.keys_[e],t=this.data_&&e in this.data_?this.data_[e]:e),t},t.prototype.forDataAtCoordinate=function(e,i,t){this.state==TileState.IDLE&&!0===t?(listenOnce(this,EventType.CHANGE,function(t){i(this.getData(e))},this),this.loadInternal_()):!0===t?setTimeout(function(){i(this.getData(e))}.bind(this),0):i(this.getData(e))},t.prototype.getKey=function(){return this.src_},t.prototype.handleError_=function(){this.state=TileState.ERROR,this.changed()},t.prototype.handleLoad_=function(t){this.grid_=t.grid,this.keys_=t.keys,this.data_=t.data,this.state=TileState.EMPTY,this.changed()},t.prototype.loadInternal_=function(){var t;this.state==TileState.IDLE&&(this.state=TileState.LOADING,this.jsonp_?requestJSONP(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this)):((t=new XMLHttpRequest).addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",this.src_),t.send()))},t.prototype.onXHRLoad_=function(t){t=t.target;if(!t.status||200<=t.status&&t.status<300){var e=void 0;try{e=JSON.parse(t.responseText)}catch(t){return void this.handleError_()}this.handleLoad_(e)}else this.handleError_()},t.prototype.onXHRError_=function(t){this.handleError_()},t.prototype.load=function(){this.preemptive_&&this.loadInternal_()},t}(Tile),UTFGrid=function(o){function t(t){var e,i=o.call(this,{projection:getProjection("EPSG:3857"),state:SourceState.LOADING})||this;return i.preemptive_=void 0===t.preemptive||t.preemptive,i.tileUrlFunction_=nullTileUrlFunction,i.template_=void 0,i.jsonp_=t.jsonp||!1,t.url?i.jsonp_?requestJSONP(t.url,i.handleTileJSONResponse.bind(i),i.handleTileJSONError.bind(i)):((e=new XMLHttpRequest).addEventListener("load",i.onXHRLoad_.bind(i)),e.addEventListener("error",i.onXHRError_.bind(i)),e.open("GET",t.url),e.send()):t.tileJSON?i.handleTileJSONResponse(t.tileJSON):assert(!1,51),i}return __extends(t,o),t.prototype.onXHRLoad_=function(t){t=t.target;if(!t.status||200<=t.status&&t.status<300){var e=void 0;try{e=JSON.parse(t.responseText)}catch(t){return void this.handleTileJSONError()}this.handleTileJSONResponse(e)}else this.handleTileJSONError()},t.prototype.onXHRError_=function(t){this.handleTileJSONError()},t.prototype.getTemplate=function(){return this.template_},t.prototype.forDataAtCoordinateAndResolution=function(t,e,i,o){this.tileGrid?(e=this.tileGrid.getZForResolution(e,this.zDirection),e=this.tileGrid.getTileCoordForCoordAndZ(t,e),this.getTile(e[0],e[1],e[2],1,this.getProjection()).forDataAtCoordinate(t,i,o)):!0===o?setTimeout(function(){i(null)},0):i(null)},t.prototype.handleTileJSONError=function(){this.setState(SourceState.ERROR)},t.prototype.handleTileJSONResponse=function(e){var t,i,o=getProjection("EPSG:4326"),r=this.getProjection(),n=(void 0!==e.bounds&&(t=getTransformFromProjections(o,r),t=applyTransform(e.bounds,t)),e.minzoom||0),s=e.maxzoom||22,r=createXYZ({extent:extentFromProjection(r),maxZoom:s,minZoom:n}),s=(this.tileGrid=r,this.template_=e.template,e.grids);s?(this.tileUrlFunction_=createFromTemplates(s,r),void 0!==e.attribution&&(i=void 0!==t?t:o.getExtent(),this.setAttributions(function(t){return intersects(i,t.extent)?[e.attribution]:null})),this.setState(SourceState.READY)):this.setState(SourceState.ERROR)},t.prototype.getTile=function(t,e,i,o,r){var n=getKeyZXY(t,e,i);return this.tileCache.containsKey(n)?this.tileCache.get(n):(e=this.getTileCoordForTileUrlFunction(t=[t,e,i],r),i=this.tileUrlFunction_(e,o,r),e=new CustomTile(t,void 0!==i?TileState.IDLE:TileState.EMPTY,void 0!==i?i:"",this.tileGrid.getTileCoordExtent(t),this.preemptive_,this.jsonp_),this.tileCache.set(n,e),e)},t.prototype.useTile=function(t,e,i){t=getKeyZXY(t,e,i);this.tileCache.containsKey(t)&&this.tileCache.get(t)},t}(TileSource);export default UTFGrid;export{CustomTile};