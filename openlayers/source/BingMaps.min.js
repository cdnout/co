var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{createFromTileUrlFunctions}from"../tileurlfunction.js";import{applyTransform,intersects}from"../extent.js";import{jsonp as requestJSONP}from"../net.js";import{get as getProjection,getTransformFromProjections}from"../proj.js";import SourceState from"./State.js";import TileImage from"./TileImage.js";import{createOrUpdate}from"../tilecoord.js";import{createXYZ,extentFromProjection}from"../tilegrid.js";function quadKey(e){for(var t,r=e[0],o=new Array(r),i=1<<r-1,n=0;n<r;++n)t=48,e[1]&i&&(t+=1),e[2]&i&&(t+=2),o[n]=String.fromCharCode(t),i>>=1;return o.join("")}var TOS_ATTRIBUTION='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html">Terms of Use</a>',BingMaps=function(o){function e(e){var t=this,r=void 0!==e.hidpi&&e.hidpi,r=((t=o.call(this,{cacheSize:e.cacheSize,crossOrigin:"anonymous",opaque:!0,projection:getProjection("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:SourceState.LOADING,tileLoadFunction:e.tileLoadFunction,tilePixelRatio:r?2:1,wrapX:void 0===e.wrapX||e.wrapX,transition:e.transition})||this).hidpi_=r,t.culture_=void 0!==e.culture?e.culture:"en-us",t.maxZoom_=void 0!==e.maxZoom?e.maxZoom:-1,t.apiKey_=e.key,t.imagerySet_=e.imagerySet,"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+t.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+t.apiKey_+"&c="+t.culture_);return requestJSONP(r,t.handleImageryMetadataResponse.bind(t),void 0,"jsonp"),t}return __extends(e,o),e.prototype.getApiKey=function(){return this.apiKey_},e.prototype.getImagerySet=function(){return this.imagerySet_},e.prototype.handleImageryMetadataResponse=function(e){var n,t,r,a,s,u;200!=e.statusCode||"OK"!=e.statusDescription||"ValidCredentials"!=e.authenticationResultCode||1!=e.resourceSets.length||1!=e.resourceSets[0].resources.length?this.setState(SourceState.ERROR):(n=e.resourceSets[0].resources[0],e=-1==this.maxZoom_?n.zoomMax:this.maxZoom_,r=this.getProjection(),r=extentFromProjection(r),t=this.hidpi_?2:1,t=n.imageWidth==n.imageHeight?n.imageWidth/t:[n.imageWidth/t,n.imageHeight/t],r=createXYZ({extent:r,minZoom:n.zoomMin,maxZoom:e,tileSize:t}),this.tileGrid=r,a=this.culture_,s=this.hidpi_,this.tileUrlFunction=createFromTileUrlFunctions(n.imageUrlSubdomains.map(function(e){var o=[0,0,0],i=n.imageUrl.replace("{subdomain}",e).replace("{culture}",a);return function(e,t,r){if(e)return createOrUpdate(e[0],e[1],e[2],o),e=i,s&&(e+="&dpi=d1&device=mobile"),e.replace("{quadkey}",quadKey(o))}})),n.imageryProviders&&(u=getTransformFromProjections(getProjection("EPSG:4326"),this.getProjection()),this.setAttributions(function(a){var s=[],e=a.viewState,t=this.getTileGrid(),r=t.getZForResolution(e.resolution,this.zDirection),c=t.getTileCoordForCoordAndZ(e.center,r)[0];return n.imageryProviders.map(function(e){for(var t=!1,r=e.coverageAreas,o=0,i=r.length;o<i;++o){var n=r[o];if(c>=n.zoomMin&&c<=n.zoomMax){n=n.bbox,n=[n[1],n[0],n[3],n[2]],n=applyTransform(n,u);if(intersects(n,a.extent)){t=!0;break}}}t&&s.push(e.attribution)}),s.push(TOS_ATTRIBUTION),s}.bind(this))),this.setState(SourceState.READY))},e}(TileImage);export default BingMaps;export{quadKey};