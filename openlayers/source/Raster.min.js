var __extends=this&&this.__extends||function(){var a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import ImageCanvas from"../ImageCanvas.js";import TileQueue from"../TileQueue.js";import{createCanvasContext2D}from"../dom.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import{Processor}from"pixelworks/lib/index.js";import{equals,getCenter,getHeight,getWidth}from"../extent.js";import ImageLayer from"../layer/Image.js";import TileLayer from"../layer/Tile.js";import{assign}from"../obj.js";import{create as createTransform}from"../transform.js";import ImageSource from"./Image.js";import TileSource from"./Tile.js";import SourceState from"./State.js";import Source from"./Source.js";var RasterEventType={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"},RasterOperationType={PIXEL:"pixel",IMAGE:"image"},RasterSourceEvent=function(a){function e(e,t,r){e=a.call(this,e)||this;return e.extent=t.extent,e.resolution=t.viewState.resolution/t.pixelRatio,e.data=r,e}return __extends(e,a),e}(Event),RasterSource=function(n){function e(o){for(var e=n.call(this,{projection:null})||this,t=(e.worker_=null,e.operationType_=void 0!==o.operationType?o.operationType:RasterOperationType.PIXEL,e.threads_=void 0!==o.threads?o.threads:1,e.layers_=createLayers(o.sources),e.changed.bind(e)),r=0,a=e.layers_.length;r<a;++r)e.layers_[r].addEventListener(EventType.CHANGE,t);return e.tileQueue_=new TileQueue(function(){return 1},e.changed.bind(e)),e.requestedFrameState_,e.renderedImageCanvas_=null,e.renderedRevision_,e.frameState_={animate:!1,coordinateToPixelTransform:createTransform(),extent:null,index:0,layerIndex:0,layerStatesArray:getLayerStatesArray(e.layers_),pixelRatio:1,pixelToCoordinateTransform:createTransform(),postRenderFunctions:[],size:[0,0],tileQueue:e.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},declutterItems:[]},e.setAttributions(function(e){for(var t=[],r=0,a=o.sources.length;r<a;++r){var n=o.sources[r],n=(n instanceof Source?n:n.getSource()).getAttributions();"function"==typeof n&&(n=n(e),t.push.apply(t,n))}return 0!==t.length?t:null}),void 0!==o.operation&&e.setOperation(o.operation,o.lib),e}return __extends(e,n),e.prototype.setOperation=function(e,t){this.worker_=new Processor({operation:e,imageOps:this.operationType_===RasterOperationType.IMAGE,queue:1,lib:t,threads:this.threads_}),this.changed()},e.prototype.updateFrameState_=function(e,t,r){var a=assign({},this.frameState_),n=(a.viewState=assign({},a.viewState),getCenter(e)),e=(a.extent=e.slice(),a.size[0]=Math.round(getWidth(e)/t),a.size[1]=Math.round(getHeight(e)/t),a.time=1/0,a.viewState);return e.center=n,e.projection=r,e.resolution=t,a},e.prototype.allSourcesReady_=function(){for(var e=!0,t=0,r=this.layers_.length;t<r;++t)if(this.layers_[t].getSource().getState()!==SourceState.READY){e=!1;break}return e},e.prototype.getImage=function(e,t,r,a){if(!this.allSourcesReady_())return null;var n,o,a=this.updateFrameState_(e,t,a);return this.requestedFrameState_=a,this.renderedImageCanvas_&&(n=this.renderedImageCanvas_.getResolution(),o=this.renderedImageCanvas_.getExtent(),t===n&&equals(e,o)||(this.renderedImageCanvas_=null)),this.renderedImageCanvas_&&this.getRevision()===this.renderedRevision_||this.processSources_(),a.tileQueue.loadMoreTiles(16,16),a.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_},e.prototype.processSources_=function(){for(var e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t),a=0;a<t;++a){e.layerIndex=a;var n=getImageData(this.layers_[a],e);if(!n)return;r[a]=n}var o={};this.dispatchEvent(new RasterSourceEvent(RasterEventType.BEFOREOPERATIONS,e,o)),this.worker_.process(r,o,this.onWorkerComplete_.bind(this,e))},e.prototype.onWorkerComplete_=function(e,t,r,a){var n,o,s,i;!t&&r&&(t=e.extent,(n=e.viewState.resolution)===this.requestedFrameState_.viewState.resolution&&equals(t,this.requestedFrameState_.extent)&&(this.renderedImageCanvas_?i=this.renderedImageCanvas_.getImage().getContext("2d"):(o=Math.round(getWidth(t)/n),s=Math.round(getHeight(t)/n),i=createCanvasContext2D(o,s),this.renderedImageCanvas_=new ImageCanvas(t,n,1,i.canvas)),i.putImageData(r,0,0),this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new RasterSourceEvent(RasterEventType.AFTEROPERATIONS,e,a))))},e.prototype.getImageInternal=function(){return null},e}(ImageSource),sharedContext=null;function getImageData(e,t){var r=e.getRenderer();if(!r)throw new Error("Unsupported layer type: "+e);if(!r.prepareFrame(t))return null;var a,e=t.size[0],n=t.size[1],r=r.renderFrame(t,null);if((a=r?r.firstElementChild:a)instanceof HTMLCanvasElement)return a.width===e&&a.height===n?a.getContext("2d").getImageData(0,0,e,n):(!sharedContext||(t=sharedContext.canvas).width!==e||t.height!==n?sharedContext=createCanvasContext2D(e,n):sharedContext.clearRect(0,0,e,n),sharedContext.drawImage(a,0,0,e,n),sharedContext.getImageData(0,0,e,n));throw new Error("Unsupported rendered element: "+a)}function getLayerStatesArray(e){return e.map(function(e){return e.getLayerState()})}function createLayers(e){for(var t=e.length,r=new Array(t),a=0;a<t;++a)r[a]=createLayer(e[a]);return r}function createLayer(e){var t;return e instanceof Source?e instanceof TileSource?t=new TileLayer({source:e}):e instanceof ImageSource&&(t=new ImageLayer({source:e})):t=e,t}export default RasterSource;export{RasterSourceEvent};