var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();import{getUid}from"../util.js";import{assert}from"../asserts.js";import Feature from"../Feature.js";import GeometryType from"../geom/GeometryType.js";import{scale as scaleCoordinate,add as addCoordinate}from"../coordinate.js";import EventType from"../events/EventType.js";import{buffer,createEmpty,createOrUpdateFromCoordinate}from"../extent.js";import Point from"../geom/Point.js";import VectorSource from"./Vector.js";var Cluster=function(r){function t(t){var e=r.call(this,{attributions:t.attributions,wrapX:t.wrapX})||this;return e.resolution=void 0,e.distance=void 0!==t.distance?t.distance:20,e.features=[],e.geometryFunction=t.geometryFunction||function(t){t=t.getGeometry();return assert(t.getType()==GeometryType.POINT,10),t},e.source=t.source,e.source.addEventListener(EventType.CHANGE,e.refresh.bind(e)),e}return __extends(t,r),t.prototype.getDistance=function(){return this.distance},t.prototype.getSource=function(){return this.source},t.prototype.loadFeatures=function(t,e,r){this.source.loadFeatures(t,e,r),e!==this.resolution&&(this.clear(),this.resolution=e,this.cluster(),this.addFeatures(this.features))},t.prototype.setDistance=function(t){this.distance=t,this.refresh()},t.prototype.refresh=function(){this.clear(),this.cluster(),this.addFeatures(this.features)},t.prototype.cluster=function(){if(void 0!==this.resolution){this.features.length=0;for(var t=createEmpty(),e=this.distance*this.resolution,r=this.source.getFeatures(),o={},s=0,n=r.length;s<n;s++){var i=r[s];getUid(i)in o||(i=this.geometryFunction(i))&&(i=i.getCoordinates(),createOrUpdateFromCoordinate(i,t),buffer(t,e,t),i=(i=this.source.getFeaturesInExtent(t)).filter(function(t){t=getUid(t);return!(t in o)&&(o[t]=!0)}),this.features.push(this.createCluster(i)))}}},t.prototype.createCluster=function(t){for(var e=[0,0],r=t.length-1;0<=r;--r){var o=this.geometryFunction(t[r]);o?addCoordinate(e,o.getCoordinates()):t.splice(r,1)}scaleCoordinate(e,1/t.length);var s=new Feature(new Point(e));return s.set("features",t),s},t}(VectorSource);export default Cluster;