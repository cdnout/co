var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();import{createEmpty}from"../extent.js";import{modulo}from"../math.js";import{assign}from"../obj.js";import{toSize,scale as scaleSize}from"../size.js";import TileImage from"./TileImage.js";import{hash as tileCoordHash}from"../tilecoord.js";import{appendParams}from"../uri.js";var TileArcGISRest=function(r){function t(t){var e=this,t=t||{};return(e=r.call(this,{attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileGrid:t.tileGrid,tileLoadFunction:t.tileLoadFunction,tileUrlFunction:tileUrlFunction,url:t.url,urls:t.urls,wrapX:void 0===t.wrapX||t.wrapX,transition:t.transition})||this).params_=t.params||{},e.hidpi_=void 0===t.hidpi||t.hidpi,e.tmpExtent_=createEmpty(),e.setKey(e.getKeyForParams_()),e}return __extends(t,r),t.prototype.getKeyForParams_=function(){var t,e=0,r=[];for(t in this.params_)r[e++]=t+"-"+this.params_[t];return r.join("/")},t.prototype.getParams=function(){return this.params_},t.prototype.getRequestUrl_=function(t,e,r,i,o,n){var s=this.urls;if(s)return o=o.getCode().split(":").pop(),n.SIZE=e[0]+","+e[1],n.BBOX=r.join(","),n.BBOXSR=o,n.IMAGESR=o,n.DPI=Math.round(n.DPI?n.DPI*i:90*i),e=(1==s.length?s[0]:s[modulo(tileCoordHash(t),s.length)]).replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage"),appendParams(e,n)},t.prototype.getTilePixelRatio=function(t){return this.hidpi_?t:1},t.prototype.updateParams=function(t){assign(this.params_,t),this.setKey(this.getKeyForParams_())},t}(TileImage);function tileUrlFunction(t,e,r){var i,o,n=(n=this.getTileGrid())||this.getTileGridForProjection(r);if(!(n.getResolutions().length<=t[0]))return 1==e||this.hidpi_||(e=1),i=n.getTileCoordExtent(t,this.tmpExtent_),n=toSize(n.getTileSize(t[0]),this.tmpSize),1!=e&&(n=scaleSize(n,e,this.tmpSize)),o={F:"image",FORMAT:"PNG32",TRANSPARENT:!0},assign(o,this.params_),this.getRequestUrl_(t,n,i,e,r,o)}export default TileArcGISRest;