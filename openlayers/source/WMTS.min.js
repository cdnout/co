var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import{expandUrl,createFromTileUrlFunctions,nullTileUrlFunction}from"../tileurlfunction.js";import{find,findIndex,includes}from"../array.js";import{containsExtent}from"../extent.js";import{assign}from"../obj.js";import{get as getProjection,equivalent,transformExtent}from"../proj.js";import TileImage from"./TileImage.js";import WMTSRequestEncoding from"./WMTSRequestEncoding.js";import{createFromCapabilitiesMatrixSet}from"../tilegrid/WMTS.js";import{appendParams}from"../uri.js";var WMTS=function(o){function t(t){var e=this,i=void 0!==t.requestEncoding?t.requestEncoding:WMTSRequestEncoding.KVP,n=t.tileGrid,r=t.urls;return void 0===r&&void 0!==t.url&&(r=expandUrl(t.url)),(e=o.call(this,{attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileClass:t.tileClass,tileGrid:n,tileLoadFunction:t.tileLoadFunction,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:nullTileUrlFunction,urls:r,wrapX:void 0!==t.wrapX&&t.wrapX,transition:t.transition})||this).version_=void 0!==t.version?t.version:"1.0.0",e.format_=void 0!==t.format?t.format:"image/jpeg",e.dimensions_=void 0!==t.dimensions?t.dimensions:{},e.layer_=t.layer,e.matrixSet_=t.matrixSet,e.style_=t.style,e.requestEncoding_=i,e.setKey(e.getKeyForDimensions_()),r&&0<r.length&&(e.tileUrlFunction=createFromTileUrlFunctions(r.map(createFromWMTSTemplate.bind(e)))),e}return __extends(t,o),t.prototype.setUrls=function(t){var e=(this.urls=t).join("\n");this.setTileUrlFunction(createFromTileUrlFunctions(t.map(createFromWMTSTemplate.bind(this))),e)},t.prototype.getDimensions=function(){return this.dimensions_},t.prototype.getFormat=function(){return this.format_},t.prototype.getLayer=function(){return this.layer_},t.prototype.getMatrixSet=function(){return this.matrixSet_},t.prototype.getRequestEncoding=function(){return this.requestEncoding_},t.prototype.getStyle=function(){return this.style_},t.prototype.getVersion=function(){return this.version_},t.prototype.getKeyForDimensions_=function(){var t,e=0,i=[];for(t in this.dimensions_)i[e++]=t+"-"+this.dimensions_[t];return i.join("/")},t.prototype.updateDimensions=function(t){assign(this.dimensions_,t),this.setKey(this.getKeyForDimensions_())},t}(TileImage);export default WMTS;function optionsFromCapabilities(t,s){var e=t.Contents.Layer,e=find(e,function(t,e,i){return t.Identifier==s.layer});if(null===e)return null;var i,n,r,a=t.Contents.TileMatrixSet,o=1<e.TileMatrixSetLink.length?"projection"in s?findIndex(e.TileMatrixSetLink,function(e,t,i){var n=find(a,function(t){return t.Identifier==e.TileMatrixSet}).SupportedCRS,r=getProjection(n.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"))||getProjection(n),o=getProjection(s.projection);return r&&o?equivalent(r,o):n==s.projection}):findIndex(e.TileMatrixSetLink,function(t,e,i){return t.TileMatrixSet==s.matrixSet}):0,l=e.TileMatrixSetLink[o=o<0?0:o].TileMatrixSet,u=e.TileMatrixSetLink[o].TileMatrixSetLimits,c=e.Format[0],o=("format"in s&&(c=s.format),o=findIndex(e.Style,function(t,e,i){return"style"in s?t.Title==s.style:t.isDefault}),e.Style[o=o<0?0:o].Identifier),p={},d=("Dimension"in e&&e.Dimension.forEach(function(t,e,i){var n=t.Identifier,r=t.Default;void 0===r&&(r=t.Value[0]),p[n]=r}),t.Contents.TileMatrixSet),d=find(d,function(t,e,i){return t.Identifier==l}),f=d.SupportedCRS,f=(f&&(i=getProjection(f.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"))||getProjection(f)),"projection"in s&&(!(f=getProjection(s.projection))||i&&!equivalent(f,i)||(i=f)),e.WGS84BoundingBox),f=(void 0!==f&&(n=getProjection("EPSG:4326").getExtent(),n=f[0]==n[0]&&f[2]==n[2],r=transformExtent(f,"EPSG:4326",i),(f=i.getExtent())&&!containsExtent(f,r)&&(r=void 0)),createFromCapabilitiesMatrixSet(d,r,u)),m=[],g=void 0!==(g=s.requestEncoding)?g:"";if("OperationsMetadata"in t&&"GetTile"in t.OperationsMetadata)for(var T=t.OperationsMetadata.GetTile.DCP.HTTP.Get,S=0,h=T.length;S<h;++S)if(T[S].Constraint){var x=find(T[S].Constraint,function(t){return"GetEncoding"==t.name}).AllowedValues.Value;if((g=""===g?x[0]:g)!==WMTSRequestEncoding.KVP)break;includes(x,WMTSRequestEncoding.KVP)&&m.push(T[S].href)}else T[S].href&&(g=WMTSRequestEncoding.KVP,m.push(T[S].href));return 0===m.length&&(g=WMTSRequestEncoding.REST,e.ResourceURL.forEach(function(t){"tile"===t.resourceType&&(c=t.format,m.push(t.template))})),{urls:m,layer:s.layer,matrixSet:l,format:c,projection:i,requestEncoding:g,tileGrid:f,style:o,dimensions:p,wrapX:n,crossOrigin:s.crossOrigin}}function createFromWMTSTemplate(r){var o=this.requestEncoding_,i={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_},s=(o==WMTSRequestEncoding.KVP&&assign(i,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),r=o==WMTSRequestEncoding.KVP?appendParams(r,i):r.replace(/\{(\w+?)\}/g,function(t,e){return e.toLowerCase()in i?i[e.toLowerCase()]:t}),this.tileGrid),a=this.dimensions_;return function(t,e,i){var n;if(t)return n={TileMatrix:s.getMatrixId(t[0]),TileCol:t[1],TileRow:t[2]},assign(n,a),t=r,o==WMTSRequestEncoding.KVP?appendParams(t,n):t.replace(/\{(\w+?)\}/g,function(t,e){return n[e]})}}export{optionsFromCapabilities};