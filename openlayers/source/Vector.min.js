var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import{getUid}from"../util.js";import Collection from"../Collection.js";import CollectionEventType from"../CollectionEventType.js";import ObjectEventType from"../ObjectEventType.js";import{extend}from"../array.js";import{assert}from"../asserts.js";import{listen,unlistenByKey}from"../events.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import{containsExtent,equals}from"../extent.js";import{xhr}from"../featureloader.js";import{TRUE,VOID}from"../functions.js";import{all as allStrategy}from"../loadingstrategy.js";import{isEmpty,getValues}from"../obj.js";import Source from"./Source.js";import SourceState from"./State.js";import VectorEventType from"./VectorEventType.js";import RBush from"../structs/RBush.js";var VectorSourceEvent=function(r){function e(e,t){e=r.call(this,e)||this;return e.feature=t,e}return __extends(e,r),e}(Event),VectorSource=function(i){function e(e){var t,r,n=this,e=e||{},o=((n=i.call(this,{attributions:e.attributions,projection:void 0,state:SourceState.READY,wrapX:void 0===e.wrapX||e.wrapX})||this).loader_=VOID,n.format_=e.format,n.overlaps_=null==e.overlaps||e.overlaps,n.url_=e.url,void 0!==e.loader?n.loader_=e.loader:void 0!==n.url_&&(assert(n.format_,7),n.loader_=xhr(n.url_,n.format_)),n.strategy_=void 0!==e.strategy?e.strategy:allStrategy,void 0===e.useSpatialIndex||e.useSpatialIndex);return n.featuresRtree_=o?new RBush:null,n.loadedExtentsRtree_=new RBush,n.nullGeometryFeatures_={},n.idIndex_={},n.uidIndex_={},n.featureChangeKeys_={},n.featuresCollection_=null,Array.isArray(e.features)?r=e.features:e.features&&(r=(t=e.features).getArray()),o||void 0!==t||(t=new Collection(r)),void 0!==r&&n.addFeaturesInternal(r),void 0!==t&&n.bindFeaturesCollection_(t),n}return __extends(e,i),e.prototype.addFeature=function(e){this.addFeatureInternal(e),this.changed()},e.prototype.addFeatureInternal=function(e){var t,r=getUid(e);this.addToIndex_(r,e)?(this.setupChangeEvents_(r,e),(t=e.getGeometry())?(t=t.getExtent(),this.featuresRtree_&&this.featuresRtree_.insert(t,e)):this.nullGeometryFeatures_[r]=e,this.dispatchEvent(new VectorSourceEvent(VectorEventType.ADDFEATURE,e))):this.featuresCollection_&&this.featuresCollection_.remove(e)},e.prototype.setupChangeEvents_=function(e,t){this.featureChangeKeys_[e]=[listen(t,EventType.CHANGE,this.handleFeatureChange_,this),listen(t,ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_,this)]},e.prototype.addToIndex_=function(e,t){var r=!0,n=t.getId();return void 0!==n&&(n.toString()in this.idIndex_?r=!1:this.idIndex_[n.toString()]=t),r&&(assert(!(e in this.uidIndex_),30),this.uidIndex_[e]=t),r},e.prototype.addFeatures=function(e){this.addFeaturesInternal(e),this.changed()},e.prototype.addFeaturesInternal=function(e){for(var t=[],r=[],n=[],o=0,i=e.length;o<i;o++){var s=e[o],a=getUid(s);this.addToIndex_(a,s)&&r.push(s)}for(var o=0,u=r.length;o<u;o++){var s=r[o],a=getUid(s),h=(this.setupChangeEvents_(a,s),s.getGeometry());h?(h=h.getExtent(),t.push(h),n.push(s)):this.nullGeometryFeatures_[a]=s}this.featuresRtree_&&this.featuresRtree_.load(t,n);for(var o=0,l=r.length;o<l;o++)this.dispatchEvent(new VectorSourceEvent(VectorEventType.ADDFEATURE,r[o]))},e.prototype.bindFeaturesCollection_=function(t){var r=!1;this.addEventListener(VectorEventType.ADDFEATURE,function(e){r||(r=!0,t.push(e.feature),r=!1)}),this.addEventListener(VectorEventType.REMOVEFEATURE,function(e){r||(r=!0,t.remove(e.feature),r=!1)}),t.addEventListener(CollectionEventType.ADD,function(e){r||(r=!0,this.addFeature(e.element),r=!1)}.bind(this)),t.addEventListener(CollectionEventType.REMOVE,function(e){r||(r=!0,this.removeFeature(e.element),r=!1)}.bind(this)),this.featuresCollection_=t},e.prototype.clear=function(e){if(e){for(var t in this.featureChangeKeys_)this.featureChangeKeys_[t].forEach(unlistenByKey);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_)for(var r in this.featuresRtree_.forEach(this.removeFeatureInternal.bind(this)),this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[r]);this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};e=new VectorSourceEvent(VectorEventType.CLEAR);this.dispatchEvent(e),this.changed()},e.prototype.forEachFeature=function(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)},e.prototype.forEachFeatureAtCoordinateDirect=function(t,r){var e=[t[0],t[1],t[0],t[1]];return this.forEachFeatureInExtent(e,function(e){if(e.getGeometry().intersectsCoordinate(t))return r(e)})},e.prototype.forEachFeatureInExtent=function(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)},e.prototype.forEachFeatureIntersectingExtent=function(t,r){return this.forEachFeatureInExtent(t,function(e){if(e.getGeometry().intersectsExtent(t)){e=r(e);if(e)return e}})},e.prototype.getFeaturesCollection=function(){return this.featuresCollection_},e.prototype.getFeatures=function(){var e;return this.featuresCollection_?e=this.featuresCollection_.getArray():this.featuresRtree_&&(e=this.featuresRtree_.getAll(),isEmpty(this.nullGeometryFeatures_)||extend(e,getValues(this.nullGeometryFeatures_))),e},e.prototype.getFeaturesAtCoordinate=function(e){var t=[];return this.forEachFeatureAtCoordinateDirect(e,function(e){t.push(e)}),t},e.prototype.getFeaturesInExtent=function(e){return this.featuresRtree_.getInExtent(e)},e.prototype.getClosestFeatureToCoordinate=function(e,t){var n=e[0],o=e[1],i=null,s=[NaN,NaN],a=1/0,u=[-1/0,-1/0,1/0,1/0],h=t||TRUE;return this.featuresRtree_.forEachInExtent(u,function(e){var t,r;h(e)&&(r=e.getGeometry(),t=a,(a=r.closestPointXY(n,o,s,a))<t&&(i=e,r=Math.sqrt(a),u[0]=n-r,u[1]=o-r,u[2]=n+r,u[3]=o+r))}),i},e.prototype.getExtent=function(e){return this.featuresRtree_.getExtent(e)},e.prototype.getFeatureById=function(e){e=this.idIndex_[e.toString()];return void 0!==e?e:null},e.prototype.getFeatureByUid=function(e){e=this.uidIndex_[e];return void 0!==e?e:null},e.prototype.getFormat=function(){return this.format_},e.prototype.getOverlaps=function(){return this.overlaps_},e.prototype.getUrl=function(){return this.url_},e.prototype.handleFeatureChange_=function(e){var e=e.target,t=getUid(e),r=e.getGeometry(),r=(r?(r=r.getExtent(),t in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[t],this.featuresRtree_&&this.featuresRtree_.insert(r,e)):this.featuresRtree_&&this.featuresRtree_.update(r,e)):t in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(e),this.nullGeometryFeatures_[t]=e),e.getId());void 0!==r?(r=r.toString(),this.idIndex_[r]!==e&&(this.removeFromIdIndex_(e),this.idIndex_[r]=e)):(this.removeFromIdIndex_(e),this.uidIndex_[t]=e),this.changed(),this.dispatchEvent(new VectorSourceEvent(VectorEventType.CHANGEFEATURE,e))},e.prototype.hasFeature=function(e){var t=e.getId();return void 0!==t?t in this.idIndex_:getUid(e)in this.uidIndex_},e.prototype.isEmpty=function(){return this.featuresRtree_.isEmpty()&&isEmpty(this.nullGeometryFeatures_)},e.prototype.loadFeatures=function(e,r,n){for(var o=this.loadedExtentsRtree_,i=this.strategy_(e,r),s=(this.loading=!1,this),t=0,a=i.length;t<a;++t)!function(e){var t=i[e];o.forEachInExtent(t,function(e){return containsExtent(e.extent,t)})||(s.loader_.call(s,t,r,n),o.insert(t,{extent:t.slice()}),s.loading=s.loader_!==VOID)}(t)},e.prototype.refresh=function(){this.clear(!0),this.loadedExtentsRtree_.clear(),i.prototype.refresh.call(this)},e.prototype.removeLoadedExtent=function(t){var r,e=this.loadedExtentsRtree_;e.forEachInExtent(t,function(e){if(equals(e.extent,t))return r=e,!0}),r&&e.remove(r)},e.prototype.removeFeature=function(e){var t=getUid(e);t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.removeFeatureInternal(e),this.changed()},e.prototype.removeFeatureInternal=function(e){var t=getUid(e),r=(this.featureChangeKeys_[t].forEach(unlistenByKey),delete this.featureChangeKeys_[t],e.getId());void 0!==r&&delete this.idIndex_[r.toString()],delete this.uidIndex_[t],this.dispatchEvent(new VectorSourceEvent(VectorEventType.REMOVEFEATURE,e))},e.prototype.removeFromIdIndex_=function(e){var t,r=!1;for(t in this.idIndex_)if(this.idIndex_[t]===e){delete this.idIndex_[t],r=!0;break}return r},e.prototype.setLoader=function(e){this.loader_=e},e.prototype.setUrl=function(e){assert(this.format_,7),this.setLoader(xhr(e,this.format_))},e}(Source);export default VectorSource;export{VectorSourceEvent};