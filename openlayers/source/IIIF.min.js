var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}();import{DEFAULT_TILE_SIZE}from"../tilegrid/common.js";import{getTopLeft}from"../extent.js";import{CustomTile}from"./Zoomify.js";import{Versions}from"../format/IIIFInfo.js";import{assert}from"../asserts.js";import TileGrid from"../tilegrid/TileGrid.js";import TileImage from"./TileImage.js";function formatPercentage(e){return e.toLocaleString("en",{maximumFractionDigits:10})}var IIIF=function(a){function e(e){var h,g,t=this,e=e||{},m=e.url||"",p=(m+=m.lastIndexOf("/")===m.length-1||""===m?"":"/",e.version||Versions.VERSION2),d=e.sizes||[],i=e.size,y=(assert(null!=i&&Array.isArray(i)&&2==i.length&&!isNaN(i[0])&&0<i[0]&&!isNaN(i[1])&&0<i[1],60),i[0]),I=i[1],i=e.tileSize,r=e.tilePixelRatio||1,v=e.format||"jpg",x=e.quality||(e.version==Versions.VERSION1?"native":"default"),N=e.resolutions||[],_=e.supports||[],n=e.extent||[0,-I,y,0],b=null!=d&&Array.isArray(d)&&0<d.length,z=null!=i&&("number"==typeof i&&Number.isInteger(i)&&0<i||Array.isArray(i)&&0<i.length),M=null!=_&&Array.isArray(_)&&(_.includes("regionByPx")||_.includes("regionByPct"))&&(_.includes("sizeByWh")||_.includes("sizeByH")||_.includes("sizeByW")||_.includes("sizeByPct"));if(N.sort(function(e,t){return t-e}),z||M)if(null!=i&&("number"==typeof i&&Number.isInteger(i)&&0<i?g=h=i:Array.isArray(i)&&0<i.length&&((1==i.length||null==i[1]&&Number.isInteger(i[0]))&&(h=i[0],g=i[0]),2==i.length&&(Number.isInteger(i[0])&&Number.isInteger(i[1])?(h=i[0],g=i[1]):null==i[0]&&Number.isInteger(i[1])&&(h=i[1],g=i[1])))),void 0!==h&&void 0!==g||(g=h=DEFAULT_TILE_SIZE),0==N.length)for(var P,o=P=Math.max(Math.ceil(Math.log(y/h)/Math.LN2),Math.ceil(Math.log(I/g)/Math.LN2));0<=o;o--)N.push(Math.pow(2,o));else{i=Math.max.apply(Math,N);P=Math.round(Math.log(i)/Math.LN2)}else if(h=y,g=I,N=[],b){d.sort(function(e,t){return e[0]-t[0]}),P=-1;for(var s=[],o=0;o<d.length;o++){var l=y/d[o][0];0<N.length&&N[N.length-1]==l?s.push(o):(N.push(l),P++)}if(0<s.length)for(o=0;o<s.length;o++)d.splice(s[o]-o,1)}else N.push(1),d.push([y,I]),P=0;i=new TileGrid({tileSize:[h,g],extent:n,origin:getTopLeft(n),resolutions:N}),n=CustomTile.bind(null,r,i);return(t=a.call(this,{attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:e.state,tileClass:n,tileGrid:i,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:function(e,t,i){var r=e[0];if(!(P<r)){var n,o,s,l,a,u,c=e[1],e=e[2],f=N[r];if(!(void 0===c||void 0===e||void 0===f||c<0||Math.ceil(y/f/h)<=c||e<0||Math.ceil(I/f/g)<=e))return M||z?(y<(c=c*h*f)+(n=h*f)&&(n=y-c),I<(a=e*(e=g)*f)+(o=g*f)&&(o=I-a),y<c+(s=h)*f&&(s=Math.floor((y-c+f-1)/f)),I<a+g*f&&(e=Math.floor((I-a+f-1)/f)),0==c&&n==y&&0==a&&o==I?l="full":!M||_.includes("regionByPx")?l=c+","+a+","+n+","+o:_.includes("regionByPct")&&(l="pct:"+formatPercentage(c/y*100)+","+formatPercentage(a/I*100)+","+formatPercentage(n/y*100)+","+formatPercentage(o/I*100)),p!=Versions.VERSION3||M&&!_.includes("sizeByWh")?!M||_.includes("sizeByW")?u=s+",":_.includes("sizeByH")?u=","+e:_.includes("sizeByWh")?u=s+","+e:_.includes("sizeByPct")&&(u="pct:"+formatPercentage(100/f)):u=s+","+e):(l="full",u=b?(c=d[r][0],a=d[r][1],p==Versions.VERSION3?c==y&&a==I?"max":c+","+a:c==y?"full":c+","):p==Versions.VERSION3?"max":"full"),m+l+"/"+u+"/0/"+x+"."+v}},transition:e.transition})||this).zDirection=e.zDirection,t}return __extends(e,a),e}(TileImage);export default IIIF;