var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();import{DEFAULT_WMS_VERSION}from"./common.js";import{assert}from"../asserts.js";import{buffer,createEmpty}from"../extent.js";import{assign}from"../obj.js";import{modulo}from"../math.js";import{get as getProjection,transform,transformExtent}from"../proj.js";import{calculateSourceResolution}from"../reproj.js";import{toSize,buffer as bufferSize,scale as scaleSize}from"../size.js";import TileImage from"./TileImage.js";import WMSServerType from"./WMSServerType.js";import{hash as tileCoordHash}from"../tilecoord.js";import{compareVersions}from"../string.js";import{appendParams}from"../uri.js";var TileWMS=function(o){function t(t){var e=this,t=t||{},r=t.params||{},i=!("TRANSPARENT"in r)||r.TRANSPARENT;return(e=o.call(this,{attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,opaque:!i,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileClass:t.tileClass,tileGrid:t.tileGrid,tileLoadFunction:t.tileLoadFunction,tileUrlFunction:tileUrlFunction,url:t.url,urls:t.urls,wrapX:void 0===t.wrapX||t.wrapX,transition:t.transition})||this).gutter_=void 0!==t.gutter?t.gutter:0,e.params_=r,e.v13_=!0,e.serverType_=t.serverType,e.hidpi_=void 0===t.hidpi||t.hidpi,e.tmpExtent_=createEmpty(),e.updateV13_(),e.setKey(e.getKeyForParams_()),e}return __extends(t,o),t.prototype.getFeatureInfoUrl=function(t,e,r,i){var o,s,n,r=getProjection(r),a=this.getProjection(),p=this.getTileGrid(),e=(p=p||this.getTileGridForProjection(r)).getZForResolution(e,this.zDirection),e=p.getTileCoordForCoordAndZ(t,e);if(!(p.getResolutions().length<=e[0]))return o=p.getResolution(e[0]),s=p.getTileCoordExtent(e,this.tmpExtent_),p=toSize(p.getTileSize(e[0]),this.tmpSize),n=this.gutter_,0!==n&&(p=bufferSize(p,n,this.tmpSize),s=buffer(s,o*n,s)),a&&a!==r&&(o=calculateSourceResolution(a,r,t,o),s=transformExtent(s,r,a),t=transform(t,r,a)),n={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetFeatureInfo",FORMAT:"image/png",TRANSPARENT:!0,QUERY_LAYERS:this.params_.LAYERS},assign(n,this.params_,i),i=Math.floor((t[0]-s[0])/o),t=Math.floor((s[3]-t[1])/o),n[this.v13_?"I":"X"]=i,n[this.v13_?"J":"Y"]=t,this.getRequestUrl_(e,p,s,1,a||r,n)},t.prototype.getLegendUrl=function(t,e){if(void 0!==this.urls[0]){var r={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(void 0===e||void 0===e.LAYER){var i=this.params_.LAYERS;if(!(!Array.isArray(i)||1===i.length))return;r.LAYER=i}return void 0!==t&&(i=this.getProjection()?this.getProjection().getMetersPerUnit():1,r.SCALE=t*i*39.37*(25.4/.28)),assign(r,e),appendParams(this.urls[0],r)}},t.prototype.getGutter=function(){return this.gutter_},t.prototype.getParams=function(){return this.params_},t.prototype.getRequestUrl_=function(t,e,r,i,o,s){var n=this.urls;if(n){if(s.WIDTH=e[0],s.HEIGHT=e[1],s[this.v13_?"CRS":"SRS"]=o.getCode(),"STYLES"in this.params_||(s.STYLES=""),1!=i)switch(this.serverType_){case WMSServerType.GEOSERVER:var a=90*i+.5|0;"FORMAT_OPTIONS"in s?s.FORMAT_OPTIONS+=";dpi:"+a:s.FORMAT_OPTIONS="dpi:"+a;break;case WMSServerType.MAPSERVER:s.MAP_RESOLUTION=90*i;break;case WMSServerType.CARMENTA_SERVER:case WMSServerType.QGIS:s.DPI=90*i;break;default:assert(!1,52)}var e=o.getAxisOrientation(),o=r;return this.v13_&&"ne"==e.substr(0,2)&&(e=void 0,e=r[0],o[0]=r[1],o[1]=e,e=r[2],o[2]=r[3],o[3]=e),s.BBOX=o.join(","),r=1==n.length?n[0]:n[modulo(tileCoordHash(t),n.length)],appendParams(r,s)}},t.prototype.getTilePixelRatio=function(t){return this.hidpi_&&void 0!==this.serverType_?t:1},t.prototype.getKeyForParams_=function(){var t,e=0,r=[];for(t in this.params_)r[e++]=t+"-"+this.params_[t];return r.join("/")},t.prototype.updateParams=function(t){assign(this.params_,t),this.updateV13_(),this.setKey(this.getKeyForParams_())},t.prototype.updateV13_=function(){var t=this.params_.VERSION||DEFAULT_WMS_VERSION;this.v13_=0<=compareVersions(t,"1.3")},t}(TileImage);function tileUrlFunction(t,e,r){var i,o,s,n=(n=this.getTileGrid())||this.getTileGridForProjection(r);if(!(n.getResolutions().length<=t[0]))return 1==e||this.hidpi_&&void 0!==this.serverType_||(e=1),s=n.getResolution(t[0]),i=n.getTileCoordExtent(t,this.tmpExtent_),n=toSize(n.getTileSize(t[0]),this.tmpSize),o=this.gutter_,0!==o&&(n=bufferSize(n,o,this.tmpSize),i=buffer(i,s*o,i)),1!=e&&(n=scaleSize(n,e,this.tmpSize)),s={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetMap",FORMAT:"image/png",TRANSPARENT:!0},assign(s,this.params_),this.getRequestUrl_(t,n,i,e,r,s)}export default TileWMS;