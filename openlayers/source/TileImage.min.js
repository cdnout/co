var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}();import{ENABLE_RASTER_REPROJECTION}from"../reproj/common.js";import{getUid}from"../util.js";import ImageTile from"../ImageTile.js";import TileCache from"../TileCache.js";import TileState from"../TileState.js";import EventType from"../events/EventType.js";import{equivalent,get as getProjection}from"../proj.js";import ReprojTile from"../reproj/Tile.js";import UrlTile from"./UrlTile.js";import{getKey,getKeyZXY}from"../tilecoord.js";import{getForProjection as getTileGridForProjection}from"../tilegrid.js";var TileImage=function(n){function e(e){var t=n.call(this,{attributions:e.attributions,cacheSize:e.cacheSize,opaque:e.opaque,projection:e.projection,state:e.state,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction||defaultTileLoadFunction,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX,transition:e.transition,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection})||this;return t.crossOrigin=void 0!==e.crossOrigin?e.crossOrigin:null,t.tileClass=void 0!==e.tileClass?e.tileClass:ImageTile,t.tileCacheForProjection={},t.tileGridForProjection={},t.reprojectionErrorThreshold_=e.reprojectionErrorThreshold,t.renderReprojectionEdges_=!1,t}return __extends(e,n),e.prototype.canExpireCache=function(){if(!ENABLE_RASTER_REPROJECTION)return n.prototype.canExpireCache.call(this);if(this.tileCache.canExpireCache())return!0;for(var e in this.tileCacheForProjection)if(this.tileCacheForProjection[e].canExpireCache())return!0;return!1},e.prototype.expireCache=function(e,t){if(ENABLE_RASTER_REPROJECTION){var i,r=this.getTileCacheForProjection(e);for(i in this.tileCache.expireCache(this.tileCache==r?t:{}),this.tileCacheForProjection){var o=this.tileCacheForProjection[i];o.expireCache(o==r?t:{})}}else n.prototype.expireCache.call(this,e,t)},e.prototype.getGutterForProjection=function(e){return ENABLE_RASTER_REPROJECTION&&this.getProjection()&&e&&!equivalent(this.getProjection(),e)?0:this.getGutter()},e.prototype.getGutter=function(){return 0},e.prototype.getOpaque=function(e){return!(ENABLE_RASTER_REPROJECTION&&this.getProjection()&&e&&!equivalent(this.getProjection(),e))&&n.prototype.getOpaque.call(this,e)},e.prototype.getTileGridForProjection=function(e){if(!ENABLE_RASTER_REPROJECTION)return n.prototype.getTileGridForProjection.call(this,e);var t=this.getProjection();return!this.tileGrid||t&&!equivalent(t,e)?((t=getUid(e))in this.tileGridForProjection||(this.tileGridForProjection[t]=getTileGridForProjection(e)),this.tileGridForProjection[t]):this.tileGrid},e.prototype.getTileCacheForProjection=function(e){if(!ENABLE_RASTER_REPROJECTION)return n.prototype.getTileCacheForProjection.call(this,e);var t=this.getProjection();return!t||equivalent(t,e)?this.tileCache:((t=getUid(e))in this.tileCacheForProjection||(this.tileCacheForProjection[t]=new TileCache(this.tileCache.highWaterMark)),this.tileCacheForProjection[t])},e.prototype.createTile_=function(e,t,i,r,o,n){e=[e,t,i],t=this.getTileCoordForTileUrlFunction(e,o),i=t?this.tileUrlFunction(t,r,o):void 0,t=new this.tileClass(e,void 0!==i?TileState.IDLE:TileState.EMPTY,void 0!==i?i:"",this.crossOrigin,this.tileLoadFunction,this.tileOptions);return t.key=n,t.addEventListener(EventType.CHANGE,this.handleTileChange.bind(this)),t},e.prototype.getTile=function(e,t,i,r,o){var n,l,c,s,a,h,p,u,T=this.getProjection();return ENABLE_RASTER_REPROJECTION&&T&&o&&!equivalent(T,o)?(n=this.getTileCacheForProjection(o),c=void 0,s=getKey(l=[e,t,i]),n.containsKey(s)&&(c=n.get(s)),a=this.getKey(),c&&c.key==a?c:(u=this.getTileGridForProjection(T),h=this.getTileGridForProjection(o),p=this.getTileCoordForTileUrlFunction(l,o),(u=new ReprojTile(T,u,o,h,l,p,this.getTilePixelRatio(r),this.getGutter(),function(e,t,i,r){return this.getTileInternal(e,t,i,r,T)}.bind(this),this.reprojectionErrorThreshold_,this.renderReprojectionEdges_)).key=a,c?(u.interimTile=c,u.refreshInterimChain(),n.replace(s,u)):n.set(s,u),u)):this.getTileInternal(e,t,i,r,T||o)},e.prototype.getTileInternal=function(e,t,i,r,o){var n,l=null,c=getKeyZXY(e,t,i),s=this.getKey();return this.tileCache.containsKey(c)?(l=this.tileCache.get(c)).key!=s&&(n=l,l=this.createTile_(e,t,i,r,o,s),n.getState()==TileState.IDLE?l.interimTile=n.interimTile:l.interimTile=n,l.refreshInterimChain(),this.tileCache.replace(c,l)):(l=this.createTile_(e,t,i,r,o,s),this.tileCache.set(c,l)),l},e.prototype.setRenderReprojectionEdges=function(e){if(ENABLE_RASTER_REPROJECTION&&this.renderReprojectionEdges_!=e){for(var t in this.renderReprojectionEdges_=e,this.tileCacheForProjection)this.tileCacheForProjection[t].clear();this.changed()}},e.prototype.setTileGridForProjection=function(e,t){!ENABLE_RASTER_REPROJECTION||!(e=getProjection(e))||(e=getUid(e))in this.tileGridForProjection||(this.tileGridForProjection[e]=t)},e}(UrlTile);function defaultTileLoadFunction(e,t){e.getImage().src=t}export default TileImage;