var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import{DEFAULT_WMS_VERSION}from"./common.js";import ImageWrapper from"../Image.js";import{assert}from"../asserts.js";import EventType from"../events/EventType.js";import{containsExtent,getCenter,getForViewAndSize,getHeight,getWidth}from"../extent.js";import{assign}from"../obj.js";import{get as getProjection,transform}from"../proj.js";import{calculateSourceResolution}from"../reproj.js";import ImageSource,{defaultImageLoadFunction}from"./Image.js";import WMSServerType from"./WMSServerType.js";import{compareVersions}from"../string.js";import{appendParams}from"../uri.js";var GETFEATUREINFO_IMAGE_SIZE=[101,101],ImageWMS=function(i){function t(t){var e=this,t=t||{};return(e=i.call(this,{attributions:t.attributions,projection:t.projection,resolutions:t.resolutions})||this).crossOrigin_=void 0!==t.crossOrigin?t.crossOrigin:null,e.url_=t.url,e.imageLoadFunction_=void 0!==t.imageLoadFunction?t.imageLoadFunction:defaultImageLoadFunction,e.params_=t.params||{},e.v13_=!0,e.updateV13_(),e.serverType_=t.serverType,e.hidpi_=void 0===t.hidpi||t.hidpi,e.image_=null,e.imageSize_=[0,0],e.renderedRevision_=0,e.ratio_=void 0!==t.ratio?t.ratio:1.5,e}return __extends(t,i),t.prototype.getFeatureInfoUrl=function(t,e,i,r){var o,n,s;if(void 0!==this.url_)return i=getProjection(i),o=this.getProjection(),o&&o!==i&&(e=calculateSourceResolution(o,i,t,e),t=transform(t,i,o)),n=getForViewAndSize(t,e,0,GETFEATUREINFO_IMAGE_SIZE),s={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetFeatureInfo",FORMAT:"image/png",TRANSPARENT:!0,QUERY_LAYERS:this.params_.LAYERS},assign(s,this.params_,r),r=Math.floor((t[0]-n[0])/e),t=Math.floor((n[3]-t[1])/e),s[this.v13_?"I":"X"]=r,s[this.v13_?"J":"Y"]=t,this.getRequestUrl_(n,GETFEATUREINFO_IMAGE_SIZE,1,o||i,s)},t.prototype.getLegendUrl=function(t,e){if(void 0!==this.url_){var i={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(void 0===e||void 0===e.LAYER){var r=this.params_.LAYERS;if(!(!Array.isArray(r)||1===r.length))return;i.LAYER=r}return void 0!==t&&(r=this.getProjection()?this.getProjection().getMetersPerUnit():1,i.SCALE=t*r*39.37*(25.4/.28)),assign(i,e),appendParams(this.url_,i)}},t.prototype.getParams=function(){return this.params_},t.prototype.getImageInternal=function(t,e,i,r){if(void 0===this.url_)return null;var o=(e=this.findNearestResolution(e))/(i=1==i||this.hidpi_&&void 0!==this.serverType_?i:1),n=getCenter(t),s=Math.ceil(getWidth(t)/o),a=Math.ceil(getHeight(t)/o),s=getForViewAndSize(n,o,0,[s,a]),a=Math.ceil(this.ratio_*getWidth(t)/o),t=Math.ceil(this.ratio_*getHeight(t)/o),n=getForViewAndSize(n,o,0,[a,t]),a=this.image_;if(a&&this.renderedRevision_==this.getRevision()&&a.getResolution()==e&&a.getPixelRatio()==i&&containsExtent(a.getExtent(),s))return a;t={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetMap",FORMAT:"image/png",TRANSPARENT:!0},assign(t,this.params_),this.imageSize_[0]=Math.round(getWidth(n)/o),this.imageSize_[1]=Math.round(getHeight(n)/o),s=this.getRequestUrl_(n,this.imageSize_,i,r,t);return this.image_=new ImageWrapper(n,e,i,s,this.crossOrigin_,this.imageLoadFunction_),this.renderedRevision_=this.getRevision(),this.image_.addEventListener(EventType.CHANGE,this.handleImageChange.bind(this)),this.image_},t.prototype.getImageLoadFunction=function(){return this.imageLoadFunction_},t.prototype.getRequestUrl_=function(t,e,i,r,o){if(assert(void 0!==this.url_,9),o[this.v13_?"CRS":"SRS"]=r.getCode(),"STYLES"in this.params_||(o.STYLES=""),1!=i)switch(this.serverType_){case WMSServerType.GEOSERVER:var n=90*i+.5|0;"FORMAT_OPTIONS"in o?o.FORMAT_OPTIONS+=";dpi:"+n:o.FORMAT_OPTIONS="dpi:"+n;break;case WMSServerType.MAPSERVER:o.MAP_RESOLUTION=90*i;break;case WMSServerType.CARMENTA_SERVER:case WMSServerType.QGIS:o.DPI=90*i;break;default:assert(!1,8)}o.WIDTH=e[0],o.HEIGHT=e[1];e=r.getAxisOrientation(),r=this.v13_&&"ne"==e.substr(0,2)?[t[1],t[0],t[3],t[2]]:t;return o.BBOX=r.join(","),appendParams(this.url_,o)},t.prototype.getUrl=function(){return this.url_},t.prototype.setImageLoadFunction=function(t){this.image_=null,this.imageLoadFunction_=t,this.changed()},t.prototype.setUrl=function(t){t!=this.url_&&(this.url_=t,this.image_=null,this.changed())},t.prototype.updateParams=function(t){assign(this.params_,t),this.updateV13_(),this.image_=null,this.changed()},t.prototype.updateV13_=function(){var t=this.params_.VERSION||DEFAULT_WMS_VERSION;this.v13_=0<=compareVersions(t,"1.3")},t}(ImageSource);export default ImageWMS;