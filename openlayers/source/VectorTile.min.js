var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}();import TileState from"../TileState.js";import VectorRenderTile from"../VectorRenderTile.js";import Tile from"../VectorTile.js";import{toSize}from"../size.js";import UrlTile from"./UrlTile.js";import{getKeyZXY,getKey}from"../tilecoord.js";import{createXYZ,extentFromProjection,createForProjection}from"../tilegrid.js";import{buffer as bufferExtent,getIntersection,intersects}from"../extent.js";import{listen,unlistenByKey}from"../events.js";import EventType from"../events/EventType.js";import{loadFeaturesXhr}from"../featureloader.js";import{isEmpty}from"../obj.js";import{equals}from"../array.js";var VectorTile=function(r){function e(e){var t=this,i=e.projection||"EPSG:3857",o=e.extent||extentFromProjection(i),o=e.tileGrid||createXYZ({extent:o,maxZoom:e.maxZoom||22,minZoom:e.minZoom,tileSize:e.tileSize||512});return(t=r.call(this,{attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,opaque:!1,projection:i,state:e.state,tileGrid:o,tileLoadFunction:e.tileLoadFunction||defaultLoadFunction,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:void 0===e.wrapX||e.wrapX,transition:e.transition,zDirection:void 0===e.zDirection?1:e.zDirection})||this).format_=e.format||null,t.loadingTiles_={},t.sourceTileByCoordKey_={},t.sourceTilesByTileKey_={},t.overlaps_=null==e.overlaps||e.overlaps,t.tileClass=e.tileClass||Tile,t.tileGrids_={},t}return __extends(e,r),e.prototype.getOverlaps=function(){return this.overlaps_},e.prototype.clear=function(){this.tileCache.clear(),this.sourceTileByCoordKey_={},this.sourceTilesByTileKey_={}},e.prototype.getSourceTiles=function(l,n,s){var a,u,c,T,e=s.wrappedTileCoord,t=this.getTileGridForProjection(n),i=t.getTileCoordExtent(e),e=e[0],t=t.getResolution(e),d=(bufferExtent(i,-t,i),this.tileGrid),e=d.getExtent(),h=(e&&getIntersection(i,e,i),d.getZForResolution(t,1)),o=d.getMinZoom(),e=this.sourceTilesByTileKey_[s.getKey()];if(e&&0<e.length&&e[0].tileCoord[0]===h)a=e,c=!(u=!0),T=h;else for(a=[],T=h+1;--T,c=u=!0,d.forEachTileCoord(i,T,function(e){var i,t=getKey(e);if(t in this.sourceTileByCoordKey_){var o,r=(o=this.sourceTileByCoordKey_[t]).getState();if(r===TileState.LOADED||r===TileState.ERROR||r===TileState.EMPTY)return c=c&&r===TileState.EMPTY,void a.push(o)}else T===h?void 0!==(r=this.tileUrlFunction(e,l,n))?((o=new this.tileClass(e,TileState.IDLE,r,this.format_,this.tileLoadFunction)).extent=d.getTileCoordExtent(e),o.projection=n,o.resolution=d.getResolution(e[0]),this.sourceTileByCoordKey_[t]=o,c=!1,o.addEventListener(EventType.CHANGE,this.handleTileChange.bind(this)),o.load()):o=null:c=!1;u=!1,null!=o&&s.getState()===TileState.IDLE&&(s.loadingSourceTiles++,i=listen(o,EventType.CHANGE,function(){var e=o.getState(),t=o.getKey();e!==TileState.LOADED&&e!==TileState.ERROR||(e===TileState.LOADED?(unlistenByKey(i),s.loadingSourceTiles--,delete s.errorSourceTileKeys[t]):e===TileState.ERROR&&(s.errorSourceTileKeys[t]=!0),s.loadingSourceTiles-Object.keys(s.errorSourceTileKeys).length==0&&(s.hifi=!0,s.sourceZ=h,s.setState(isEmpty(s.errorSourceTileKeys)?TileState.LOADED:TileState.ERROR)))}))}.bind(this)),u||(a.length=0),!u&&o<T;);return c||s.getState()!==TileState.IDLE||s.setState(TileState.LOADING),(u||c)&&(s.hifi=h===T,s.sourceZ=T,s.getState()<TileState.LOADED?s.setState(c?TileState.EMPTY:TileState.LOADED):e&&equals(a,e)||(this.removeSourceTiles(s),this.addSourceTiles(s,a))),a},e.prototype.addSourceTiles=function(e,t){for(var i=0,o=(this.sourceTilesByTileKey_[e.getKey()]=t).length;i<o;++i)t[i].consumers++},e.prototype.removeSourceTiles=function(e){e=e.getKey();if(e in this.sourceTilesByTileKey_)for(var t=this.sourceTilesByTileKey_[e],i=0,o=t.length;i<o;++i){var r=t[i];r.consumers--,0===r.consumers&&(r.dispose(),delete this.sourceTileByCoordKey_[getKey(r.tileCoord)])}delete this.sourceTilesByTileKey_[e]},e.prototype.getTile=function(e,t,i,o,r){var l,n=getKeyZXY(e,t,i),s=this.getKey();if(this.tileCache.containsKey(n)&&(l=this.tileCache.get(n)).key===s)return l;var a,t=[e,t,i],i=this.getTileCoordForTileUrlFunction(t,r),u=this.getTileGrid().getExtent(),c=(i&&u&&(a=(c=this.getTileGridForProjection(r)).getTileCoordExtent(i),bufferExtent(a,-c.getResolution(e),a),intersects(u,a)||(i=null)),new VectorRenderTile(t,null!==i?TileState.IDLE:TileState.EMPTY,i,this.tileGrid,this.getSourceTiles.bind(this,o,r),this.removeSourceTiles.bind(this)));return c.key=s,l?(c.interimTile=l,c.refreshInterimChain(),this.tileCache.replace(n,c)):this.tileCache.set(n,c),c},e.prototype.getTileGridForProjection=function(e){var t,i=e.getCode(),o=this.tileGrids_[i];return o||(t=this.tileGrid,o=this.tileGrids_[i]=createForProjection(e,void 0,t?t.getTileSize(t.getMinZoom()):void 0)),o},e.prototype.getTilePixelRatio=function(e){return e},e.prototype.getTilePixelSize=function(e,t,i){i=this.getTileGridForProjection(i),i=toSize(i.getTileSize(e),this.tmpSize);return[Math.round(i[0]*t),Math.round(i[1]*t)]},e}(UrlTile);export default VectorTile;function defaultLoadFunction(e,t){t=loadFeaturesXhr(t,e.getFormat(),e.onLoad.bind(e),e.onError.bind(e));e.setLoader(t)}export{defaultLoadFunction};