var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import ImageWrapper from"../Image.js";import{assert}from"../asserts.js";import EventType from"../events/EventType.js";import{containsExtent,getHeight,getWidth}from"../extent.js";import{assign}from"../obj.js";import ImageSource,{defaultImageLoadFunction}from"./Image.js";import{appendParams}from"../uri.js";var ImageArcGISRest=function(i){function t(t){var e=this,t=t||{};return(e=i.call(this,{attributions:t.attributions,projection:t.projection,resolutions:t.resolutions})||this).crossOrigin_=void 0!==t.crossOrigin?t.crossOrigin:null,e.hidpi_=void 0===t.hidpi||t.hidpi,e.url_=t.url,e.imageLoadFunction_=void 0!==t.imageLoadFunction?t.imageLoadFunction:defaultImageLoadFunction,e.params_=t.params||{},e.image_=null,e.imageSize_=[0,0],e.renderedRevision_=0,e.ratio_=void 0!==t.ratio?t.ratio:1.5,e}return __extends(t,i),t.prototype.getParams=function(){return this.params_},t.prototype.getImageInternal=function(t,e,i,r){if(void 0===this.url_)return null;e=this.findNearestResolution(e),i=this.hidpi_?i:1;var n=this.image_;if(n&&this.renderedRevision_==this.getRevision()&&n.getResolution()==e&&n.getPixelRatio()==i&&containsExtent(n.getExtent(),t))return n;var n={F:"image",FORMAT:"PNG32",TRANSPARENT:!0},o=(assign(n,this.params_),((t=t.slice())[0]+t[2])/2),a=(t[1]+t[3])/2,s=(1!=this.ratio_&&(s=this.ratio_*getWidth(t)/2,g=this.ratio_*getHeight(t)/2,t[0]=o-s,t[1]=a-g,t[2]=o+s,t[3]=a+g),e/i),g=Math.ceil(getWidth(t)/s),u=Math.ceil(getHeight(t)/s),o=(t[0]=o-s*g/2,t[2]=o+s*g/2,t[1]=a-s*u/2,t[3]=a+s*u/2,this.imageSize_[0]=g,this.imageSize_[1]=u,this.getRequestUrl_(t,this.imageSize_,i,r,n));return this.image_=new ImageWrapper(t,e,i,o,this.crossOrigin_,this.imageLoadFunction_),this.renderedRevision_=this.getRevision(),this.image_.addEventListener(EventType.CHANGE,this.handleImageChange.bind(this)),this.image_},t.prototype.getImageLoadFunction=function(){return this.imageLoadFunction_},t.prototype.getRequestUrl_=function(t,e,i,r,n){r=r.getCode().split(":").pop(),n.SIZE=e[0]+","+e[1],n.BBOX=t.join(","),n.BBOXSR=r,n.IMAGESR=r,n.DPI=Math.round(90*i),e=this.url_,t=e.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return t==e&&assert(!1,50),appendParams(t,n)},t.prototype.getUrl=function(){return this.url_},t.prototype.setImageLoadFunction=function(t){this.image_=null,this.imageLoadFunction_=t,this.changed()},t.prototype.setUrl=function(t){t!=this.url_&&(this.url_=t,this.image_=null,this.changed())},t.prototype.updateParams=function(t){assign(this.params_,t),this.image_=null,this.changed()},t}(ImageSource);export default ImageArcGISRest;