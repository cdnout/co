var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();import MapEventType from"./MapEventType.js";import BaseObject,{getChangeEventType}from"./Object.js";import OverlayPositioning from"./OverlayPositioning.js";import{CLASS_SELECTABLE}from"./css.js";import{removeNode,removeChildren,outerWidth,outerHeight}from"./dom.js";import{listen,unlistenByKey}from"./events.js";import{containsExtent}from"./extent.js";var Property={ELEMENT:"element",MAP:"map",OFFSET:"offset",POSITION:"position",POSITIONING:"positioning"},Overlay=function(n){function t(t){var e=n.call(this)||this;return e.options=t,e.id=t.id,e.insertFirst=void 0===t.insertFirst||t.insertFirst,e.stopEvent=void 0===t.stopEvent||t.stopEvent,e.element=document.createElement("div"),e.element.className=void 0!==t.className?t.className:"ol-overlay-container "+CLASS_SELECTABLE,e.element.style.position="absolute",e.autoPan=void 0!==t.autoPan&&t.autoPan,e.autoPanAnimation=t.autoPanAnimation||{},e.autoPanMargin=void 0!==t.autoPanMargin?t.autoPanMargin:20,e.rendered={bottom_:"",left_:"",right_:"",top_:"",visible:!0},e.mapPostrenderListenerKey=null,e.addEventListener(getChangeEventType(Property.ELEMENT),e.handleElementChanged),e.addEventListener(getChangeEventType(Property.MAP),e.handleMapChanged),e.addEventListener(getChangeEventType(Property.OFFSET),e.handleOffsetChanged),e.addEventListener(getChangeEventType(Property.POSITION),e.handlePositionChanged),e.addEventListener(getChangeEventType(Property.POSITIONING),e.handlePositioningChanged),void 0!==t.element&&e.setElement(t.element),e.setOffset(void 0!==t.offset?t.offset:[0,0]),e.setPositioning(void 0!==t.positioning?t.positioning:OverlayPositioning.TOP_LEFT),void 0!==t.position&&e.setPosition(t.position),e}return __extends(t,n),t.prototype.getElement=function(){return this.get(Property.ELEMENT)},t.prototype.getId=function(){return this.id},t.prototype.getMap=function(){return this.get(Property.MAP)},t.prototype.getOffset=function(){return this.get(Property.OFFSET)},t.prototype.getPosition=function(){return this.get(Property.POSITION)},t.prototype.getPositioning=function(){return this.get(Property.POSITIONING)},t.prototype.handleElementChanged=function(){removeChildren(this.element);var t=this.getElement();t&&this.element.appendChild(t)},t.prototype.handleMapChanged=function(){this.mapPostrenderListenerKey&&(removeNode(this.element),unlistenByKey(this.mapPostrenderListenerKey),this.mapPostrenderListenerKey=null);var t=this.getMap();t&&(this.mapPostrenderListenerKey=listen(t,MapEventType.POSTRENDER,this.render,this),this.updatePixelPosition(),t=this.stopEvent?t.getOverlayContainerStopEvent():t.getOverlayContainer(),this.insertFirst?t.insertBefore(this.element,t.childNodes[0]||null):t.appendChild(this.element))},t.prototype.render=function(){this.updatePixelPosition()},t.prototype.handleOffsetChanged=function(){this.updatePixelPosition()},t.prototype.handlePositionChanged=function(){this.updatePixelPosition(),this.get(Property.POSITION)&&this.autoPan&&this.panIntoView()},t.prototype.handlePositioningChanged=function(){this.updatePixelPosition()},t.prototype.setElement=function(t){this.set(Property.ELEMENT,t)},t.prototype.setMap=function(t){this.set(Property.MAP,t)},t.prototype.setOffset=function(t){this.set(Property.OFFSET,t)},t.prototype.setPosition=function(t){this.set(Property.POSITION,t)},t.prototype.panIntoView=function(){var t,e,n,i,o,r,s=this.getMap();s&&s.getTargetElement()&&(e=this.getRect(s.getTargetElement(),s.getSize()),n=this.getElement(),n=this.getRect(n,[outerWidth(n),outerHeight(n)]),t=this.autoPanMargin,containsExtent(e,n)||(i=n[0]-e[0],o=e[2]-n[2],r=n[1]-e[1],e=e[3]-n[3],n=[0,0],i<0?n[0]=i-t:o<0&&(n[0]=Math.abs(o)+t),r<0?n[1]=r-t:e<0&&(n[1]=Math.abs(e)+t),0===n[0]&&0===n[1]||(i=s.getView().getCenterInternal(),r=[(o=s.getPixelFromCoordinate(i))[0]+n[0],o[1]+n[1]],s.getView().animateInternal({center:s.getCoordinateFromPixel(r),duration:this.autoPanAnimation.duration,easing:this.autoPanAnimation.easing}))))},t.prototype.getRect=function(t,e){var t=t.getBoundingClientRect(),n=t.left+window.pageXOffset,t=t.top+window.pageYOffset;return[n,t,n+e[0],t+e[1]]},t.prototype.setPositioning=function(t){this.set(Property.POSITIONING,t)},t.prototype.setVisible=function(t){this.rendered.visible!==t&&(this.element.style.display=t?"":"none",this.rendered.visible=t)},t.prototype.updatePixelPosition=function(){var t=this.getMap(),e=this.getPosition();t&&t.isRendered()&&e?(e=t.getPixelFromCoordinate(e),t=t.getSize(),this.updateRenderedPosition(e,t)):this.setVisible(!1)},t.prototype.updateRenderedPosition=function(t,e){var n,i=this.element.style,o=this.getOffset(),r=this.getPositioning(),s=(this.setVisible(!0),o[0]),o=o[1];r==OverlayPositioning.BOTTOM_RIGHT||r==OverlayPositioning.CENTER_RIGHT||r==OverlayPositioning.TOP_RIGHT?(""!==this.rendered.left_&&(this.rendered.left_=i.left=""),n=Math.round(e[0]-t[0]-s)+"px",this.rendered.right_!=n&&(this.rendered.right_=i.right=n)):(""!==this.rendered.right_&&(this.rendered.right_=i.right=""),r!=OverlayPositioning.BOTTOM_CENTER&&r!=OverlayPositioning.CENTER_CENTER&&r!=OverlayPositioning.TOP_CENTER||(s-=this.element.offsetWidth/2),n=Math.round(t[0]+s)+"px",this.rendered.left_!=n&&(this.rendered.left_=i.left=n)),r==OverlayPositioning.BOTTOM_LEFT||r==OverlayPositioning.BOTTOM_CENTER||r==OverlayPositioning.BOTTOM_RIGHT?(""!==this.rendered.top_&&(this.rendered.top_=i.top=""),s=Math.round(e[1]-t[1]-o)+"px",this.rendered.bottom_!=s&&(this.rendered.bottom_=i.bottom=s)):(""!==this.rendered.bottom_&&(this.rendered.bottom_=i.bottom=""),r!=OverlayPositioning.CENTER_LEFT&&r!=OverlayPositioning.CENTER_CENTER&&r!=OverlayPositioning.CENTER_RIGHT||(o-=this.element.offsetHeight/2),n=Math.round(t[1]+o)+"px",this.rendered.top_!=n&&(this.rendered.top_=i.top=n))},t.prototype.getOptions=function(){return this.options},t}(BaseObject);export default Overlay;