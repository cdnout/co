!function(e,n){"function"==typeof define&&define.amd?define(n):"undefined"!=typeof exports?module.exports=n():e.atmosphere=n()}(this,function(){"use strict";var e,n,te={},oe=!1,r=[],re=[],ae=0;Object.prototype.hasOwnProperty;return(te={version:"3.0.6-javascript",onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,n){},onMessagePublished:function(e){},onTransportFailure:function(e,n){},onLocalMessage:function(e){},onFailureToReconnect:function(e,n){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(e){var n,t;return e.onMessage=function(e){t.onmessage({data:e.responseBody})},e.onMessagePublished=function(e){t.onmessage({data:e.responseBody})},e.onOpen=function(e){t.onopen(e)},t={close:function(){n.close()},send:function(e){n.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},n=new te.subscribe(e),t},AtmosphereRequest:function(e){var f,p,g,m={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,disableDisconnect:!1,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,reconnectOnServerError:!0,handleOnlineOffline:!0,maxWebsocketErrorRetries:1,curWebsocketErrorRetries:0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,n){},onReconnect:function(e,n){},onMessagePublished:function(e){},onTransportFailure:function(e,n){},onLocalMessage:function(e){},onFailureToReconnect:function(e,n){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},h={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},o=null,r=null,t=null,a=null,s=null,u=!0,b=0,i=0,c="X",d=!1,v=null,l=null,w=te.util.now();function n(){d=!(u=!0),b=0,a=t=r=o=null}function y(e){return"debug"==e?"debug"===m.logLevel:"info"==e?"info"===m.logLevel||"debug"===m.logLevel:"warn"==e?"warn"===m.logLevel||"info"===m.logLevel||"debug"===m.logLevel:"error"==e&&("error"===m.logLevel||"warn"===m.logLevel||"info"===m.logLevel||"debug"===m.logLevel)}function T(e){y("debug")&&te.util.debug(new Date+" Atmosphere: "+e)}function k(e,n){return""===h.partialMessage&&"streaming"===n.transport&&e.responseText.length>n.maxStreamingLength}function R(){var o,e,n;!m.enableProtocol||m.disableDisconnect||m.firstMessage||(o="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+m.uuid,te.util.each(m.headers,function(e,n){var t=te.util.isFunction(n)?n.call(this,m,m,h):n;null!=t&&(o+="&"+encodeURIComponent(e)+"="+encodeURIComponent(t))}),e=m.url.replace(/([?&])_=[^&]*/,o),e+=e===m.url?(/\?/.test(m.url)?"&":"?")+o:"",(n=new te.AtmosphereRequest({connected:!1})).connectTimeout=m.connectTimeout,n.attachHeadersAsQueryString=!1,n.dropHeaders=!0,n.url=e,n.contentType="text/plain",n.transport="polling",n.method="GET",n.data="",n.heartbeat=null,m.enableXDR&&(n.enableXDR=m.enableXDR),function(e,n){n=n||G(e);n.transport="polling",n.method="GET",n.withCredentials=!1,n.reconnect=!1,n.force=!0,n.suspend=!1,n.timeout=1e3,X(n)}("",n))}function S(){T("Closing (AtmosphereRequest._close() called)"),d=!0,m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),m.reconnect=!1,h.request=m,h.state="unsubscribe",h.responseBody="",h.status=408,h.partialMessage="",m.curWebsocketErrorRetries=0,ne(),R(),C()}function C(){h.partialMessage="",m.id&&clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId),null!=a&&(a.close(),a=null),null!=s&&(s.abort(),s=null),null!=t&&(t.abort(),t=null),null!=o&&(o.canSendMessage&&(T("invoking .close() on WebSocket object"),o.close()),o=null),null!=r&&(r.close(),r=null),function(){null!=f&&(clearInterval(p),document.cookie=g+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",f.signal("close",{reason:"",heir:d?(f.get("children")||[])[0]:w}),f.close());null!=l&&l.close()}()}function x(e){C(),n(),(m=te.util.extend(m,e)).mrequest=m.reconnect,m.reconnect||(m.reconnect=!0)}function I(){if(m.shared){if(null!=(l=function(a){var n,t,o,i="atmosphere-"+a.url,e=function(){function n(e){e.key===i&&e.newValue&&c(e.newValue)}if(te.util.storage){var t=window.localStorage,o=function(e){var n=t.getItem(i+"-"+e);return null===n?[]:JSON.parse(n)},r=function(e,n){t.setItem(i+"-"+e,JSON.stringify(n))};return{init:function(){return r("children",o("children").concat([w])),te.util.on(window,"storage",n),o("opened")},signal:function(e,n){t.setItem(i,JSON.stringify({target:"p",type:e,data:n}))},close:function(){var e=o("children");te.util.off(window,"storage",n),e&&s(e,a.id)&&r("children",e)}}}},r=function(){var t=window.open("",i.replace(/\W/g,""));if(t&&!t.closed&&t.callbacks)return{init:function(){return t.callbacks.push(c),t.children.push(w),t.opened},signal:function(e,n){!t.closed&&t.fire&&t.fire(JSON.stringify({target:"p",type:e,data:n}))},close:function(){o||(s(t.callbacks,c),s(t.children,w))}}};function s(e,n){for(var t=e.length,o=0;o<t;o++)e[o]===n&&e.splice(o,1);return t!==e.length}function c(e){var n=JSON.parse(e),t=n.data;if("c"===n.target)switch(n.type){case"open":O("opening","local",m);break;case"close":o||(o=!0,"aborted"===t.reason?S():t.heir===w?I():setTimeout(function(){I()},100));break;case"message":Q(t,"messageReceived",200,a.transport);break;case"localMessage":K(t)}}function l(){var e=new RegExp("(?:^|; )("+encodeURIComponent(i)+")=([^;]*)").exec(document.cookie);if(e)return JSON.parse(decodeURIComponent(e[2]))}if(!(n=l())||1e3<te.util.now()-n.ts)return;return(t=e()||r())?{open:function(){var e;return p=setInterval(function(){var e=n;(n=l())&&e.ts!==n.ts||c(JSON.stringify({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),(e=t.init())&&setTimeout(function(){O("opening","local",a)},50),e},send:function(e){t.signal("send",e)},localSend:function(e){t.signal("localSend",JSON.stringify({id:w,event:e}))},close:function(){d||(clearInterval(p),t.signal("close"),t.close())}}:void 0}(m))&&(y("debug")&&te.util.debug("Storage service available. All communication will be local"),l.open(m)))return;y("debug")&&te.util.debug("No Storage service available."),l=null}var e,n,t;m.firstMessage=0==ae,m.isOpen=!1,m.ctime=te.util.now(),0===m.uuid&&(m.uuid=ae),h.closedByClientTimeout=!1,"websocket"!==m.transport&&"sse"!==m.transport?X(m):"websocket"===m.transport?null!=m.webSocketImpl||window.WebSocket||window.MozWebSocket?A(!1):D("Websocket is not supported, using request.fallbackTransport ("+m.fallbackTransport+")"):"sse"===m.transport&&(e=te.util.getAbsoluteURL(m.url.toLowerCase()),n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(e),t=!(!n||n[1]==window.location.protocol&&n[2]==window.location.hostname&&(n[3]||("http:"===n[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443))),!window.EventSource||t&&te.util.browser.safari&&!(7<=te.util.browser.vmajor)?D("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+m.fallbackTransport+")"):function n(t){h.transport="sse";var e=(o=P(m),o);var o;y("debug")&&(te.util.debug("Invoking executeSSE"),te.util.debug("Using URL: "+e));if(t&&!m.reconnect)return void(null!=r&&C());try{r=new EventSource(e,{withCredentials:m.withCredentials})}catch(e){return U(0,e),void D("SSE failed. Downgrading to fallback transport and resending")}0<m.connectTimeout&&(m.id=setTimeout(function(){t||C()},m.connectTimeout));r.onopen=function(e){T("sse.onopen"),B(m),y("debug")&&te.util.debug("SSE successfully opened"),m.enableProtocol?m.isReopen&&(m.isReopen=!1,O("re-opening",m.transport,m)):O(t?"re-opening":"opening","sse",m),t=!0,"POST"===m.method&&(h.state="messageReceived",_(m.data))};r.onmessage=function(e){T("sse.onmessage"),B(m),!m.enableXDR&&window.location.host&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host?te.util.log(m.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):(h.state="messageReceived",h.status=200,M(e=e.data,m,h)||(ne(),h.responseBody="",h.messages=[]))};r.onerror=function(e){T("sse.onerror"),clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),h.closedByClientTimeout||(ee(t),C(),d?te.util.log(m.logLevel,["SSE closed normally"]):t?m.reconnect&&"sse"===h.transport&&(b++<m.maxReconnectOnClose?(O("re-connecting",m.transport,m),0<m.reconnectInterval?m.reconnectId=setTimeout(function(){n(!0)},m.reconnectInterval):n(!0),h.responseBody="",h.messages=[]):(te.util.log(m.logLevel,["SSE reconnect maximum try reached "+b]),U(0,"maxReconnectOnClose reached"))):D("SSE failed. Downgrading to fallback transport and resending"))}}(!1))}function O(e,n,t){function o(e){var n=JSON.parse(e),t=n.data;if("p"===n.target)switch(n.type){case"send":_(t);break;case"localSend":K(t);break;case"close":S()}}function r(){document.cookie=g+"="+encodeURIComponent(JSON.stringify({ts:te.util.now()+1,heir:(a.get("children")||[])[0]}))+"; path=/"}var a,i,s,c,l,u,d;m.shared&&"local"!==n&&(i="atmosphere-"+m.url,s=function(){var t,e=i.replace(/\W/g,""),n=document.getElementById(e);return n||((n=document.createElement("div")).id=e,n.style.display="none",n.innerHTML='<iframe name="'+e+'"></iframe>',document.body.appendChild(n)),t=n.firstChild.contentWindow,{init:function(){t.callbacks=[o],t.fire=function(e){for(var n=0;n<t.callbacks.length;n++)t.callbacks[n](e)}},signal:function(e,n){!t.closed&&t.fire&&t.fire(JSON.stringify({target:"c",type:e,data:n}))},get:function(e){return t.closed?null:t[e]},set:function(e,n){t.closed||(t[e]=n)},close:function(){}}},v=function(e){a.signal("message",e)},(a=function(){function e(e){e.key===i&&e.newValue&&o(e.newValue)}if(te.util.storage){var t=window.localStorage;return{init:function(){te.util.on(window,"storage",e)},signal:function(e,n){t.setItem(i,JSON.stringify({target:"c",type:e,data:n}))},get:function(e){return JSON.parse(t.getItem(i+"-"+e))},set:function(e,n){t.setItem(i+"-"+e,JSON.stringify(n))},close:function(){te.util.off(window,"storage",e),t.removeItem(i),t.removeItem(i+"-opened"),t.removeItem(i+"-children")}}}}()||s()).init(),y("debug")&&te.util.debug("Installed StorageService "+a),a.set("children",[]),null==a.get("opened")||a.get("opened")||a.set("opened",!1),g=encodeURIComponent(i),r(),p=setInterval(r,1e3),f=a),null!=f&&f.set("opened",!0),t.close=function(){S()},0<b&&"re-connecting"===e?(t.isReopen=!0,(d=h).state="re-connecting",Y(d)):null==h.error&&(h.request=t,c=h.state,h.state=e,l=h.transport,h.transport=n,u=h.responseBody,ne(),h.responseBody=u,h.state=c,h.transport=l)}function L(r){r.transport="jsonp";var a,i=null!=r&&void 0!==r?r:m;(s={open:function(){var o="atmosphere"+ ++w;function e(){var e=i.url;null!=i.dispatchUrl&&(e+=i.dispatchUrl);var n=i.data;i.attachHeadersAsQueryString&&(e=P(i),""!==n&&(e+="&X-Atmosphere-Post-Body="+encodeURIComponent(n)),n="");var t=document.head||document.getElementsByTagName("head")[0]||document.documentElement;(a=document.createElement("script")).src=e+"&jsonpTransport="+o,a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),2==++r.scriptCount&&(r.scriptCount=1,i.lastIndex=0,i.openId&&clearTimeout(i.openId),i.heartbeatTimer&&clearTimeout(i.heartbeatTimer),i.reconnect&&b++<i.maxReconnectOnClose?(O("re-connecting",i.transport,i),b===i.maxReconnectOnClose||j(s,i,r.reconnectInterval),i.openId=setTimeout(function(){H(i)},i.reconnectInterval+1e3)):U(0,"maxReconnectOnClose reached"))},a.onload=a.onreadystatechange=function(){T("jsonp.onload"),a.readyState&&!/loaded|complete/.test(a.readyState)||a.clean()},a.onerror=function(){T("jsonp.onerror"),r.scriptCount=1,a.clean()},t.insertBefore(a,t.firstChild)}window[o]=function(e){if(T("jsonp.window"),r.scriptCount=0,i.reconnect&&-1===i.maxRequest||i.requestCount++<i.maxRequest){if(i.executeCallbackBeforeReconnect||j(s,i,i.pollingInterval),null!=e&&"string"!=typeof e)try{e=e.message}catch(e){}M(e,i,h)||Q(h.responseBody,"messageReceived",200,i.transport),i.executeCallbackBeforeReconnect&&j(s,i,i.pollingInterval),B(i)}else te.util.log(m.logLevel,["JSONP reconnect maximum try reached "+m.requestCount]),U(0,"maxRequest reached")},setTimeout(function(){e()},50)},abort:function(){a&&a.clean&&a.clean()}}).open()}function A(t){h.transport="websocket";var e,n=(m.url,P(m,te.util.getAbsoluteURL(m.webSocketUrl||m.url)).replace(/^http/,"ws"));y("debug")&&te.util.debug("Invoking executeWebSocket, using URL: "+n),!t||m.reconnect?(e=n,o=null!=m.webSocketImpl?m.webSocketImpl:new(window.WebSocket?WebSocket:MozWebSocket)(e),null!=m.webSocketBinaryType&&(o.binaryType=m.webSocketBinaryType),0<m.connectTimeout&&(m.id=setTimeout(function(){if(!t){var e={code:1002,reason:"Connection timeout after "+m.connectTimeout+"ms.",wasClean:!1},n=o;try{C()}catch(e){}n.onclose(e)}},m.connectTimeout)),o.onopen=function(){if(null==o)return this.close(),void("websocket"==m.transport&&S());T("websocket.onopen"),B(m),oe=!1,y("debug")&&te.util.debug("Websocket successfully opened");var e=t;o.canSendMessage=!0,m.enableProtocol||(t=!0,O(e?"re-opening":"opening","websocket",m)),"POST"===m.method&&(h.state="messageReceived",o.send(m.data))},o.onmessage=function(e){if(null==o)return this.close(),void("websocket"==m.transport&&S());if(T("websocket.onmessage"),B(m),m.enableProtocol&&(t=!0),h.state="messageReceived",h.status=200,"string"==typeof(e=e.data)){M(e,m,h)||(ne(),h.responseBody="",h.messages=[])}else{if(""===(e=E(m,e)))return;h.responseBody=e,ne(),h.responseBody=null}},o.onerror=function(){T("websocket.onerror"),clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),h.error=!0},o.onclose=function(e){if(T("websocket.onclose"),clearTimeout(m.id),"closed"!==h.state){var n=e.reason;if(""===n)switch(e.code){case 1e3:n="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:n="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:n="The endpoint is terminating the connection due to a protocol error.";break;case 1003:n="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:n="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:n="Unknown: no status code was provided even though one was expected.";break;case 1006:n="Connection was closed abnormally (that is, with no close frame being sent)."}y("warn")&&te.util.warn("Websocket closed, reason: "+n+" - wasClean: "+e.wasClean),h.closedByClientTimeout||m.handleOnlineOffline&&oe?m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId):(ee(t),h.state="closed",d?te.util.log(m.logLevel,["Websocket closed normally"]):h.error?(h.error=!1,m.curWebsocketErrorRetries<m.maxWebsocketErrorRetries&&(m.curWebsocketErrorRetries=m.curWebsocketErrorRetries+1,q())):t||"websocket"!==h.transport||"websocket"===m.fallbackTransport?m.reconnect&&"websocket"===h.transport&&q():D("Websocket failed on first connection attempt. Downgrading to "+m.fallbackTransport+" and resending"))}},-1<navigator.userAgent.toLowerCase().indexOf("android")&&void 0===o.url&&o.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})):null!=o&&C()}function E(e,n){var t=n;if("polling"===e.transport)return t;if(e.enableProtocol&&e.firstMessage&&0!==te.util.trim(n).length){var o=e.trackMessageLength?1:0,r=n.split(e.messageDelimiter);if(r.length<=o+1)return t;if(e.firstMessage=!1,e.uuid=te.util.trim(r[o]),r.length<=o+2&&te.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),i=parseInt(te.util.trim(r[o+1]),10),c=r[o+2],"long-polling"!==e.transport&&H(e),ae=e.uuid,t="",o=e.trackMessageLength?4:3,r.length>o+1)for(var a=o;a<r.length;a++)t+=r[a],a+1!==r.length&&(t+=e.messageDelimiter);0!==e.ackInterval&&setTimeout(function(){_("...ACK...")},e.ackInterval)}else e.enableProtocol&&e.firstMessage&&te.util.browser.msie&&+te.util.browser.version.split(".")[0]<10?te.util.log(m.logLevel,["Receiving unexpected data from IE"]):H(e);return t}function B(e){clearTimeout(e.id),0<e.timeout&&"polling"!==e.transport&&(e.id=setTimeout(function(){h.closedByClientTimeout=!0,h.state="closedByClient",h.responseBody="",h.status=408,h.messages=[],ne(),R(),C()},e.timeout))}function U(e,n){C(),clearTimeout(m.id),h.state="error",h.reasonPhrase=n,h.responseBody="",h.status=e,h.messages=[],ne()}function M(e,n,t){if(0===(e=E(n,e)).length)return!0;if(t.responseBody=e,n.trackMessageLength){var o=[],r=(e=t.partialMessage+e).indexOf(n.messageDelimiter);if(-1!=r){for(;-1!==r;){var a=e.substring(0,r),i=+a;if(isNaN(i))throw t.partialMessage="",new Error('message length "'+a+'" is not a number');r=(r+=n.messageDelimiter.length)+i>e.length?-1:(o.push(e.substring(r,r+i)),(e=e.substring(r+i,e.length)).indexOf(n.messageDelimiter))}return t.partialMessage=e,0!==o.length?(t.responseBody=o.join(n.messageDelimiter),t.messages=o,!1):(t.responseBody="",t.messages=[],!0)}}return t.responseBody=e,!(t.messages=[e])}function q(){C(),b++<m.maxReconnectOnClose?(O("re-connecting",m.transport,m),0<m.reconnectInterval?m.reconnectId=setTimeout(function(){h.responseBody="",h.messages=[],A(!0)},m.reconnectInterval):(h.responseBody="",h.messages=[],A(!0))):(te.util.log(m.logLevel,["Websocket reconnect maximum try reached "+b]),y("warn")&&te.util.warn("Websocket error, reason: "+message.reason),U(0,"maxReconnectOnClose reached"))}function D(e){te.util.log(m.logLevel,[e]),void 0!==m.onTransportFailure?m.onTransportFailure(e,m):void 0!==te.util.onTransportFailure&&te.util.onTransportFailure(e,m);var n=-1===m.connectTimeout?0:m.connectTimeout;m.reconnect&&"none"!==m.transport||null==m.transport?(m.transport=m.fallbackTransport,m.method=m.fallbackMethod,h.transport=m.fallbackTransport,h.state="",m.fallbackTransport="none",0<n?m.reconnectId=setTimeout(function(){I()},n):I()):U(500,"Unable to reconnect with fallback transport")}function P(o,r){var a=null!=o&&void 0!==o?o:m;return null==r&&(r=a.url),a.attachHeadersAsQueryString&&(-1!==r.indexOf("X-Atmosphere-Framework")||(r+=-1!==r.indexOf("?")?"&":"?",r+="X-Atmosphere-tracking-id="+a.uuid,r+="&X-Atmosphere-Framework="+te.version,r+="&X-Atmosphere-Transport="+a.transport,a.trackMessageLength&&(r+="&X-Atmosphere-TrackMessageSize=true"),null!==a.heartbeat&&null!==a.heartbeat.server&&(r+="&X-Heartbeat-Server="+a.heartbeat.server),""!==a.contentType&&(r+="&Content-Type="+("websocket"===a.transport?a.contentType:encodeURIComponent(a.contentType))),a.enableProtocol&&(r+="&X-atmo-protocol=true"),te.util.each(a.headers,function(e,n){var t=te.util.isFunction(n)?n.call(this,a,o,h):n;null!=t&&(r+="&"+encodeURIComponent(e)+"="+encodeURIComponent(t))}))),r}function H(e){if(e.isOpen)if(e.isReopen)e.isReopen=!1,O("re-opening",e.transport,e);else{if("messageReceived"!==h.state||"jsonp"!==e.transport&&"long-polling"!==e.transport)return;(n=h).state="openAfterResume",Y(n),n.state="messageReceived"}else e.isOpen=!0,O("opening",e.transport,e);var n;!function(e){null!=e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);{var n;!isNaN(i)&&0<i&&(n=function(){y("debug")&&te.util.debug("Sending heartbeat"),_(c),e.heartbeatTimer=setTimeout(n,i)},e.heartbeatTimer=setTimeout(n,i))}}(e)}function X(i){var s=null==i&&void 0===i?m:i;if(s.lastIndex=0,s.readyState=0,"jsonp"===s.transport||s.enableXDR&&te.util.checkCORSSupport())L(s);else{if(te.util.browser.msie&&+te.util.browser.version.split(".")[0]<10){if("streaming"===s.transport)return void(s.enableXDR&&window.XDomainRequest?F:J)(s);if(s.enableXDR&&window.XDomainRequest)return void F(s)}var n=function(e){var n;s.lastIndex=0,b++,e||s.reconnect&&b<=s.maxReconnectOnClose?(n=e?0:i.reconnectInterval,h.ffTryingReconnect=!0,O("re-connecting",i.transport,i),j(l,s,n)):U(0,"maxReconnectOnClose reached")},c=function(e){te._beforeUnloadState?(te.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){n(e)},5e3)):n(e)};if(s.force||s.reconnect&&(-1===s.maxRequest||s.requestCount++<s.maxRequest)){s.force=!1;var l=te.util.xhr();l.hasData=!1,function(o,r,a){var e=r.url;null!=r.dispatchUrl&&"POST"===r.method&&(e+=r.dispatchUrl);e=P(r,e),e=te.util.prepareURL(e),a&&(o.open(r.method,e,!0),0<r.connectTimeout&&(r.id=setTimeout(function(){0===r.requestCount&&(C(),Q("Connect timeout","closed",200,r.transport))},r.connectTimeout)));m.withCredentials&&"websocket"!==m.transport&&"withCredentials"in o&&(o.withCredentials=!0);m.dropHeaders||(o.setRequestHeader("X-Atmosphere-Framework",te.version),o.setRequestHeader("X-Atmosphere-Transport",r.transport),null!==r.heartbeat&&null!==r.heartbeat.server&&o.setRequestHeader("X-Heartbeat-Server",o.heartbeat.server),r.trackMessageLength&&o.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),o.setRequestHeader("X-Atmosphere-tracking-id",r.uuid),te.util.each(r.headers,function(e,n){var t=te.util.isFunction(n)?n.call(this,o,r,a,h):n;null!=t&&o.setRequestHeader(e,t)}));""!==r.contentType&&o.setRequestHeader("Content-Type",r.contentType)}(l,s,!0),s.suspend&&(t=l),"polling"!==s.transport&&(h.transport=s.transport,l.onabort=function(){T("ajaxrequest.onabort"),ee(!0)},l.onerror=function(){T("ajaxrequest.onerror"),h.error=!0,h.ffTryingReconnect=!0;try{h.status=XMLHttpRequest.status}catch(e){h.status=500}h.status||(h.status=500),h.errorHandled||(C(),c(!1))}),l.onreadystatechange=function(){if(T("ajaxRequest.onreadystatechange, new state: "+l.readyState),d)T("onreadystatechange has been ignored due to _abortingConnection flag");else{h.error=null;var n=!1,e=!1;if("streaming"===s.transport&&2<s.readyState&&4===l.readyState)return C(),void c(!1);if(s.readyState=l.readyState,("streaming"===s.transport&&3<=l.readyState||"long-polling"===s.transport&&4===l.readyState)&&(e=!0),B(m),"polling"!==s.transport){var t=200;if(4===l.readyState&&(t=1e3<l.status?0:l.status),!s.reconnectOnServerError&&300<=t&&t<600)return void U(t,l.statusText);if(300<=t||0===t)return h.errorHandled=!0,C(),void c(!1);s.enableProtocol&&i.firstMessage||2!==l.readyState||(te.util.browser.mozilla&&h.ffTryingReconnect?(h.ffTryingReconnect=!1,setTimeout(function(){h.ffTryingReconnect||H(s)},500)):H(s))}else 4===l.readyState&&(e=!0);if(e){var o=l.responseText;if(h.errorHandled=!1,"long-polling"===s.transport&&0===te.util.trim(o).length)return void(l.hasData?l.hasData=!1:c(!0));if(l.hasData=!0,V(l,m),"streaming"===s.transport)if(te.util.browser.opera)te.util.iterate(function(){if(500!==h.status&&l.responseText.length>s.lastIndex){try{h.status=l.status,h.headers=te.util.parseHeaders(l.getAllResponseHeaders()),V(l,m)}catch(e){h.status=404}B(m),h.state="messageReceived";var e=l.responseText.substring(s.lastIndex);if(s.lastIndex=l.responseText.length,(n=M(e,s,h))||ne(),k(l,s))return void N(l,s)}else if(400<h.status)return s.lastIndex=l.responseText.length,!1},0);else{n=M(o.substring(s.lastIndex,o.length),s,h);if(s.lastIndex=o.length,n)return}else n=M(o,s,h);var r=k(l,s);try{h.status=l.status,h.headers=te.util.parseHeaders(l.getAllResponseHeaders()),V(l,s)}catch(e){h.status=404}s.suspend?h.state=0===h.status?"closed":"messageReceived":h.state="messagePublished";var a=!r&&"streaming"!==i.transport&&"polling"!==i.transport;a&&!s.executeCallbackBeforeReconnect&&j(l,s,s.pollingInterval),0===h.responseBody.length||n||ne(),a&&s.executeCallbackBeforeReconnect&&j(l,s,s.pollingInterval),r&&N(l,s)}}};try{l.send(s.data),u=!0}catch(e){te.util.log(s.logLevel,["Unable to connect to "+s.url]),U(0,e)}}else"debug"===s.logLevel&&te.util.log(s.logLevel,["Max re-connection reached."]),U(0,"maxRequest reached")}}function N(e,n){h.messages=[],n.isReopen=!0,S(),d=!1,j(e,n,500)}function j(e,n,t){var o;h.closedByClientTimeout||(n.reconnect||n.suspend&&u)&&(o=0,e&&1<e.readyState&&(o=1e3<e.status?0:e.status),h.status=0===o?204:o,h.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(n.id),n.reconnectId&&(clearTimeout(n.reconnectId),delete n.reconnectId),0<t?m.reconnectId=setTimeout(function(){X(n)},t):X(n))}function F(e){"polling"!==e.transport?(a=W(e)).open():W(e).open()}function W(e){var o=m;null!=e&&void 0!==e&&(o=e);function r(){"long-polling"===o.transport&&o.reconnect&&(-1===o.maxRequest||o.requestCount++<o.maxRequest)&&(n.status=200,F(o))}var a=o.transport,i=0,n=new window.XDomainRequest,t=o.rewriteURL||function(e){var n=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(n&&n[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+n[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+n[2]+"&").replace(/&$/,"")}return e};n.onprogress=function(){s(n)},n.onerror=function(){"polling"!==o.transport&&(C(),b++<o.maxReconnectOnClose?0<o.reconnectInterval?o.reconnectId=setTimeout(function(){O("re-connecting",e.transport,e),F(o)},o.reconnectInterval):(O("re-connecting",e.transport,e),F(o)):U(0,"maxReconnectOnClose reached"))},n.onload=function(){};var s=function(e){clearTimeout(o.id);var n=(n=e.responseText).substring(i);if(i+=n.length,"polling"!==a){B(o);var t=M(n,o,h);if("long-polling"===a&&0===te.util.trim(n).length)return;o.executeCallbackBeforeReconnect&&r(),t||Q(h.responseBody,"messageReceived",200,a),o.executeCallbackBeforeReconnect||r()}};return{open:function(){var e=o.url;null!=o.dispatchUrl&&(e+=o.dispatchUrl),e=P(o,e),n.open(o.method,t(e)),"GET"===o.method?n.send():n.send(o.data),0<o.connectTimeout&&(o.id=setTimeout(function(){0===o.requestCount&&(C(),Q("Connect timeout","closed",200,o.transport))},o.connectTimeout))},close:function(){n.abort()}}}function J(e){(a=function(e){var r,a=m;null!=e&&void 0!==e&&(a=e);var i=new window.ActiveXObject("htmlfile");i.open(),i.close();var n=a.url;null!=a.dispatchUrl&&(n+=a.dispatchUrl);"polling"!==a.transport&&(h.transport=a.transport);return{open:function(){var e=i.createElement("iframe");n=P(a),""!==a.data&&(n+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data)),n=te.util.prepareURL(n),e.src=n,i.body.appendChild(e);var o=e.contentDocument||e.contentWindow.document;r=te.util.iterate(function(){try{if(!o.firstChild)return;var t=o.body?o.body.lastChild:o;t.omgThisIsBroken;var e,n;return o.body&&o.body.firstChild&&"pre"===o.body.firstChild.nodeName.toLowerCase()||(e=o.head||o.getElementsByTagName("head")[0]||o.documentElement||o,(n=o.createElement("script")).text="document.write('<plaintext>')",e.insertBefore(n,e.firstChild),e.removeChild(n),t=o.body.lastChild),a.closed&&(a.isReopen=!0),r=te.util.iterate(function(){var e=function(){var e=t.cloneNode(!0);e.appendChild(o.createTextNode("."));var n=e.innerText;return n=n.substring(0,n.length-1)}();if(e.length>a.lastIndex){if(B(m),h.status=200,h.error=null,t.innerText="",M(e,a,h))return"";Q(h.responseBody,"messageReceived",200,a.transport)}if(a.lastIndex=0,"complete"===o.readyState)return ee(!0),O("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){J(a)},a.reconnectInterval):J(a),!1},null),!1}catch(e){return h.error=!0,O("re-connecting",a.transport,a),b++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){J(a)},a.reconnectInterval):J(a):U(0,"maxReconnectOnClose reached"),i.execCommand("Stop"),i.close(),!1}})},close:function(){r&&r(),i.execCommand("Stop"),ee(!0)}}}(e)).open()}function _(e){var n;null!=l?(n=e,l.send(n)):null!=t||null!=r?$(e):null!=a?function(e){{var n;m.enableXDR&&te.util.checkCORSSupport()?((n=G(e)).reconnect=!1,L(n)):$(e)}}(e):null!=s?$(e):null!=o?function(n){var e,t=te.util.isBinary(n)?n:z(n);try{if(e=null!=m.dispatchUrl?m.webSocketPathDelimiter+m.dispatchUrl+m.webSocketPathDelimiter+t:t,!o.canSendMessage)return te.util.error("WebSocket not connected.");o.send(e)}catch(e){o.onclose=function(e){},C(),D("Websocket failed. Downgrading to "+m.fallbackTransport+" and resending "+n),$(n)}}(e):(U(0,"No suspended connection available"),te.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function $(e){X(G(e))}function z(e){var n=e;return"object"==typeof n&&(n=e.data),n}function G(e){var n=z(e),t={connected:!1,timeout:6e4,method:"POST",url:m.url,contentType:m.contentType,headers:m.headers,reconnect:!0,callback:null,data:n,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:m.withCredentials,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:m.enableXDR,uuid:m.uuid,dispatchUrl:m.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:m.trackMessageLength,maxReconnectOnClose:m.maxReconnectOnClose,heartbeatTimer:m.heartbeatTimer,heartbeat:m.heartbeat};return"object"==typeof e&&(t=te.util.extend(t,e)),t}function K(e){var n=JSON.parse(e);n.id!==w&&(void 0!==m.onLocalMessage?m.onLocalMessage(n.event):void 0!==te.util.onLocalMessage&&te.util.onLocalMessage(n.event))}function Q(e,n,t,o){h.responseBody=e,h.transport=o,h.status=t,h.state=n,ne()}function V(e,n){if(n.readResponsesHeaders)try{var t=e.getResponseHeader("X-Atmosphere-tracking-id");t&&null!=t&&(n.uuid=t.split(" ").pop())}catch(e){}else n.enableProtocol||(n.uuid=w)}function Y(e){Z(e,m),Z(e,te.util)}function Z(e,n){switch(e.state){case"messageReceived":T("Firing onMessage"),void(b=0)!==n.onMessage&&n.onMessage(e),void 0!==n.onmessage&&n.onmessage(e);break;case"error":T("Firing onError, reasonPhrase: "+(void 0!==e.reasonPhrase?e.reasonPhrase:"n/a")),void 0!==n.onError&&n.onError(e),void 0!==n.onerror&&n.onerror(e);break;case"opening":delete m.closed,T("Firing onOpen"),void 0!==n.onOpen&&n.onOpen(e),void 0!==n.onopen&&n.onopen(e);break;case"messagePublished":T("Firing messagePublished"),void 0!==n.onMessagePublished&&n.onMessagePublished(e);break;case"re-connecting":T("Firing onReconnect"),void 0!==n.onReconnect&&n.onReconnect(m,e);break;case"closedByClient":T("Firing closedByClient"),void 0!==n.onClientTimeout&&n.onClientTimeout(m);break;case"re-opening":delete m.closed,T("Firing onReopen"),void 0!==n.onReopen&&n.onReopen(m,e);break;case"fail-to-reconnect":T("Firing onFailureToReconnect"),void 0!==n.onFailureToReconnect&&n.onFailureToReconnect(m,e);break;case"unsubscribe":case"closed":void 0!==m.closed&&m.closed?T("Request already closed, not firing onClose ("+e.state+" case)"):(T("Firing onClose ("+e.state+" case)"),void 0!==n.onClose&&n.onClose(e),void 0!==n.onclose&&n.onclose(e)),m.closed=!0;break;case"openAfterResume":void 0!==n.onOpenAfterResume&&n.onOpenAfterResume(m)}}function ee(e){"closed"!==h.state&&(h.state="closed",h.responseBody="",h.messages=[],h.status=e?200:501,ne())}function ne(){function e(e,n){n(h)}null==l&&null!=v&&v(h.responseBody),m.reconnect=m.mrequest;for(var n="string"==typeof h.responseBody,t=n&&m.trackMessageLength?0<h.messages.length?h.messages:[""]:new Array(h.responseBody),o=0;o<t.length;o++)if(!(1<t.length&&0===t[o].length)){if(h.responseBody=n?te.util.trim(t[o]):t[o],null==l&&null!=v&&v(h.responseBody),"messageReceived"===h.state){if(0===h.responseBody.length)continue;if(n&&c===h.responseBody){b=0;continue}}if(Y(h),0<re.length){y("debug")&&te.util.debug("Invoking "+re.length+" global callbacks: "+h.state);try{te.util.each(re,e)}catch(e){te.util.log(m.logLevel,["Callback exception"+e])}}if("function"==typeof m.callback){y("debug")&&te.util.debug("Invoking request callbacks");try{m.callback(h)}catch(e){te.util.log(m.logLevel,["Callback exception"+e])}}}}x(e),this.subscribe=function(e){x(e),I()},this.execute=function(){I()},this.close=function(){S()},this.disconnect=function(){R()},this.getUrl=function(){return m.url},this.push=function(e,n){var t;null!=n?(t=m.dispatchUrl,m.dispatchUrl=n,_(e),m.dispatchUrl=t):_(e)},this.getUUID=function(){return m.uuid},this.pushLocal=function(e){!function(e){if(0!==e.length)try{l?l.localSend(e):f&&f.signal("localMessage",JSON.stringify({id:w,event:e}))}catch(e){te.util.error(e)}}(e)},this.enableProtocol=function(e){return m.enableProtocol},this.init=function(){n()},this.request=m,this.response=h},subscribe:function(e,n,t){"function"==typeof n&&te.addCallback(n),"string"!=typeof e?t=e:t.url=e,ae=void 0!==t&&void 0!==t.uuid?t.uuid:0;var o=new te.AtmosphereRequest(t);return o.execute(),r[r.length]=o},unsubscribe:function(){if(0<r.length)for(var e=[].concat(r),n=0;n<e.length;n++){var t=e[n];t.close(),clearTimeout(t.response.request.id),t.heartbeatTimer&&clearTimeout(t.heartbeatTimer)}r=[],re=[]},unsubscribeUrl:function(e){var n=-1;if(0<r.length)for(var t=0;t<r.length;t++){var o=r[t];if(o.getUrl()===e){o.close(),clearTimeout(o.response.request.id),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),n=t;break}}0<=n&&r.splice(n,1)},addCallback:function(e){-1===te.util.inArray(e,re)&&re.push(e)},removeCallback:function(e){var n=te.util.inArray(e,re);-1!==n&&re.splice(n,1)}}).util={browser:{},parseHeaders:function(e){for(var n,t=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};n=t.exec(e);)o[n[1]]=n[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,n){if(Array.prototype.indexOf)return n.indexOf(e);for(var t=n.length,o=0;o<t;++o)if(n[o]===e)return o;return-1},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){if(void 0===document.createElement)return e;var n=document.createElement("div");n.innerHTML='<a href="'+e+'"></a>';var t=window.navigator.userAgent;return 0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")?te.util.fixedEncodeURI(decodeURI(n.firstChild.href)):n.firstChild.href},fixedEncodeURI:function(e){return encodeURI(e).replace(/%5B/g,"[").replace(/%5D/g,"]")},prepareURL:function(e){var n=te.util.now(),t=e.replace(/([?&])_=[^&]*/,"$1_="+n);return t+(t===e?(/\?/.test(e)?"&":"?")+"_="+n:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){var n,t=[];function o(e,n){n=te.util.isFunction(n)?n():null==n?"":n,t.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}function r(t,e){var n;if(te.util.isArray(e))te.util.each(e,function(e,n){/\[\]$/.test(t)?o(t,n):r(t+"["+("object"==typeof n?e:"")+"]",n)});else if("[object Object]"===Object.prototype.toString.call(e))for(n in e)r(t+"["+n+"]",e[n]);else o(t,e)}for(n in e)r(n,e[n]);return t.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(n,t){var o;return t=t||0,function e(){o=setTimeout(function(){!1!==n()&&e()},t)}(),function(){clearTimeout(o)}},each:function(e,n,t){if(e){var o=0,r=e.length,a=te.util.isArray(e);if(t){if(a)for(;o<r&&!1!==n.apply(e[o],t);o++);else for(o in e)if(!1===n.apply(e[o],t))break}else if(a)for(;o<r&&!1!==n.call(e[o],o,e[o]);o++);else for(o in e)if(!1===n.call(e[o],o,e[o]))break;return e}},extend:function(e){for(var n,t,o=1;o<arguments.length;o++)if(null!=(n=arguments[o]))for(t in n)e[t]=n[t];return e},on:function(e,n,t){e.addEventListener?e.addEventListener(n,t,!1):e.attachEvent&&e.attachEvent("on"+n,t)},off:function(e,n,t){e.removeEventListener?e.removeEventListener(n,t,!1):e.detachEvent&&e.detachEvent("on"+n,t)},log:function(e,n){var t;!window.console||"function"==typeof(t=window.console[e])&&t.apply(window.console,n)},warn:function(){te.util.log("warn",arguments)},info:function(){te.util.log("info",arguments)},debug:function(){te.util.log("debug",arguments)},error:function(){te.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},checkCORSSupport:function(){if(te.util.browser.msie&&!window.XDomainRequest&&+te.util.browser.version.split(".")[0]<11)return!0;if(te.util.browser.opera&&+te.util.browser.version.split(".")<12)return!0;if("KreaTVWebKit/531"===te.util.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===te.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var e=navigator.userAgent.toLowerCase().match(/.+android ([0-9]{1,2})/i),n=parseInt(e&&e[0]||-1,10);return!isNaN(n)&&-1<n&&n<3}},te.util.now(),e=navigator.userAgent.toLowerCase(),"safari"===(n=/(chrome)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("android")<0&&/version\/(.+) (safari)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[])[2]&&(n[2]=n[1],n[1]="safari"),te.util.browser[n[1]||""]=!0,te.util.browser.version=n[2]||"0",te.util.browser.vmajor=te.util.browser.version.split(".")[0],te.util.browser.trident&&(te.util.browser.msie=!0),(te.util.browser.msie||te.util.browser.mozilla&&1==+te.util.browser.version.split(".")[0])&&(te.util.storage=!1),te.callbacks={unload:function(){te.util.debug(new Date+" Atmosphere: unload event"),te.unsubscribe()},beforeUnload:function(){te.util.debug(new Date+" Atmosphere: beforeunload event"),te._beforeUnloadState=!0,setTimeout(function(){te.util.debug(new Date+" Atmosphere: beforeunload event timeout reached. Reset _beforeUnloadState flag"),te._beforeUnloadState=!1},5e3)},offline:function(){if(te.util.debug(new Date+" Atmosphere: offline event"),oe=!0,0<r.length)for(var e=[].concat(r),n=0;n<e.length;n++){var t=e[n];t.request.handleOnlineOffline&&(t.close(),clearTimeout(t.response.request.id),t.heartbeatTimer&&clearTimeout(t.heartbeatTimer))}},online:function(){if(te.util.debug(new Date+" Atmosphere: online event"),0<r.length)for(var e=0;e<r.length;e++)r[e].request.handleOnlineOffline&&(r[e].init(),r[e].execute());oe=!1}},te.bindEvents=function(){te.util.on(window,"unload",te.callbacks.unload),te.util.on(window,"beforeunload",te.callbacks.beforeUnload),te.util.on(window,"offline",te.callbacks.offline),te.util.on(window,"online",te.callbacks.online)},te.unbindEvents=function(){te.util.off(window,"unload",te.callbacks.unload),te.util.off(window,"beforeunload",te.callbacks.beforeUnload),te.util.off(window,"offline",te.callbacks.offline),te.util.off(window,"online",te.callbacks.online)},te.bindEvents(),te});