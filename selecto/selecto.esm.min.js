import EventEmitter from"@scena/event-emitter";import Gesto from"gesto";import{Properties}from"framework-utils";import{hasClass,addClass,calculateBoundSize,isString,removeEvent,addEvent,between,isObject,isArray,camelize}from"@daybrush/utils";import{diff}from"@egjs/children-differ";import DragScroll from"@scena/dragscroll";import KeyController,{getCombi}from"keycon";import{fitPoints,isInside,getOverlapPoints,getAreaSize}from"overlap-area";import styled from"css-styled";var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function __extends(t,e){function n(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var __assign=function(){return(__assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function __rest(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]])}return n}function __decorate(t,e,n,r){var o,i=arguments.length,s=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(s=(i<3?o(s):i>3?o(e,n,s):o(e,n))||s);return i>3&&s&&Object.defineProperty(e,n,s),s}function __spreadArrays(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var i=arguments[e],s=0,a=i.length;s<a;s++,o++)r[o]=i[s];return r}function getClient(t){if("touches"in t){var e=t.touches[0]||t.changedTouches[0];return{clientX:e.clientX,clientY:e.clientY}}return{clientX:t.clientX,clientY:t.clientY}}function createElement(t,e,n){var r=t.tag,o=t.children,i=t.attributes,s=t.className,a=t.style,c=e||document.createElement(r);for(var l in i)c.setAttribute(l,i[l]);var u=c.children;if(o.forEach(function(t,e){createElement(t,u[e],c)}),s&&s.split(" ").forEach(function(t){hasClass(c,t)||addClass(c,t)}),a){var g=c.style;for(var l in a)g[l]=a[l]}return!e&&n&&n.appendChild(c),c}function h(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o=e||{},i=o.className,s=void 0===i?"":i,a=o.style;return{tag:t,className:s,style:void 0===a?{}:a,attributes:__rest(o,["className","style"]),children:n}}function diffValue(t,e,n){t!==e&&n(t,e)}function getRect(t,e,n){var r;void 0===n&&(n=t.datas.boundArea);var o=t.distX,i=void 0===o?0:o,s=t.distY,a=void 0===s?0:s,c=t.datas,l=c.startX,u=c.startY;if(e>0){var g=Math.sqrt((i*i+a*a)/(1+e*e));i=(i>=0?1:-1)*(e*g),a=(a>=0?1:-1)*g}var d=Math.abs(i),f=Math.abs(a),p=i<0?l-n.left:n.right-l,h=a<0?u-n.top:n.bottom-u;i=(i>=0?1:-1)*(d=(r=calculateBoundSize([d,f],[0,0],[p,h],!!e))[0]),a=(a>=0?1:-1)*(f=r[1]);var v=l+Math.min(0,i),m=u+Math.min(0,a);return{left:v,top:m,right:v+d,bottom:m+f,width:d,height:f}}function getDefaultElementRect(t){var e=t.getBoundingClientRect(),n=e.left,r=e.top,o=e.width,i=e.height;return{pos1:[n,r],pos2:[n+o,r],pos3:[n,r+i],pos4:[n+o,r+i]}}function passTargets(t,e){var n=diff(t,e),r=n.list,o=n.prevList,i=n.added,s=n.removed;return i.map(function(t){return r[t]}).concat(s.map(function(t){return o[t]}))}var injector=styled("\n:host {\n    position: fixed;\n    display: none;\n    border: 1px solid #4af;\n    background: rgba(68, 170, 255, 0.5);\n    z-index: 100;\n}\n"),CLASS_NAME="selecto-selection "+injector.className,PROPERTIES=["boundContainer","selectableTargets","selectByClick","selectFromInside","continueSelect","toggleContinueSelect","keyContainer","hitRate","scrollOptions","checkInput","preventDefault","ratio","getElementRect","preventDragFromInside"],OPTIONS=__spreadArrays(["dragContainer","cspNonce"],PROPERTIES),OPTION_TYPES={boundContainer:null,target:null,container:null,dragContainer:null,selectableTargets:Array,selectByClick:Boolean,selectFromInside:Boolean,continueSelect:Boolean,toggleContinueSelect:Array,keyContainer:null,hitRate:Number,scrollOptions:Object,checkInput:Boolean,preventDefault:Boolean,cspNonce:String,ratio:Number,getElementRect:Function,preventDragFromInside:Boolean},EVENTS=["dragStart","drag","dragEnd","selectStart","select","selectEnd","keydown","keyup","scroll"],METHODS=["clickTarget","setSelectedTargets","getElementPoints","getSelectedTargets","findSelectableTargets","triggerDragStart"],Selecto=function(t){function e(e){void 0===e&&(e={});var n=t.call(this)||this;return n.selectedTargets=[],n.dragScroll=new DragScroll,n.onDragStart=function(t,e){var r=t.datas,o=t.clientX,i=t.clientY,s=t.inputEvent,a=n.options,c=a.continueSelect,l=a.selectFromInside,u=a.selectByClick,g=a.boundContainer,d=a.preventDragFromInside,f=void 0===d||d;n.findSelectableTargets(r),r.startSelectedTargets=n.selectedTargets;var p={left:-1/0,top:-1/0,right:1/0,bottom:1/0};if(g){var h=(isString(g)?document.querySelector(g):!0===g?n.container:g).getBoundingClientRect();p={left:h.left,top:h.top,right:h.right,bottom:h.bottom}}r.boundArea=p;var v={left:o,top:i,right:o,bottom:i,width:0,height:0},m=[];if(!l||u){for(var y=e||document.elementFromPoint(o,i);y&&!(r.selectableTargets.indexOf(y)>-1);)y=y.parentElement;m=y?[y]:[]}var S=m.length>0,E=!l&&S;if(E&&!u)return t.stop(),!1;var b=s.type,T="mousedown"===b||"touchstart"===b;if(!(!(!t.isClick&&T)||n.trigger("dragStart",__assign({},t))))return t.stop(),!1;if(c?(m=passTargets(n.selectedTargets,m),r.startPassedTargets=n.selectedTargets):r.startPassedTargets=[],n.select(n.selectedTargets,m,v,s,!0),r.startX=o,r.startY=i,r.selectFlag=!1,r.preventDragFromInside=!1,r.boundsArea=n.target.style.cssText+="left:0px;top:0px;transform: translate("+o+"px, "+i+"px)",E&&u)s.preventDefault(),f&&(n.selectEnd(r.startSelectedTargets,r.startPassedTargets,v,t),r.preventDragFromInside=!0);else{r.selectFlag=!0,"touchstart"===b&&s.preventDefault();var C=n.options.scrollOptions;C&&C.container&&n.dragScroll.dragStart(t,C)}return!0},n.onDrag=function(t){if(t.datas.selectFlag){var e=n.options.scrollOptions;if(e&&e.container&&n.dragScroll.drag(t,e))return}n.check(t)},n.onDragEnd=function(t){var e=t.datas,r=t.inputEvent,o=getRect(t,n.options.ratio),i=e.selectFlag;r&&!t.isClick&&n.trigger("dragEnd",__assign(__assign({isDouble:!!t.isDouble,isDrag:!1,isSelect:i},t),{rect:o})),n.target.style.cssText+="display: none;",i&&(e.selectFlag=!1,n.dragScroll.dragEnd()),e.preventDragFromInside||n.selectEnd(e.startSelectedTargets,e.startPassedTargets,o,t)},n.onKeyDown=function(t){n.sameCombiKey(t)&&(n.continueSelect=!0,n.trigger("keydown",{}))},n.onKeyUp=function(t){n.sameCombiKey(t,!0)&&(n.continueSelect=!1,n.trigger("keyup",{}))},n.onBlur=function(){n.toggleContinueSelect&&n.continueSelect&&(n.continueSelect=!1,n.trigger("keyup",{}))},n.onDocumentSelectStart=function(t){if(n.gesto.isFlag()){var e=n.dragContainer;e===window&&(e=document.documentElement);var r=e instanceof Element?[e]:[].slice.call(e),o=t.target;r.some(function(e){if(e===o||e.contains(o))return t.preventDefault(),!0})}},n.target=e.target,n.container=e.container||document.body,n.options=__assign({target:null,container:null,dragContainer:null,selectableTargets:[],selectByClick:!0,selectFromInside:!0,hitRate:100,continueSelect:!1,toggleContinueSelect:null,keyContainer:null,scrollOptions:void 0,checkInput:!1,preventDefault:!1,boundContainer:!1,preventDragFromInside:!0,getElementRect:getDefaultElementRect,cspNonce:"",ratio:0},e),n.initElement(),n.initDragScroll(),n.setKeyController(),n}__extends(e,t);var n=e.prototype;return n.setSelectedTargets=function(t){return this.selectedTargets=t,this},n.getSelectedTargets=function(){return this.selectedTargets},n.setKeyContainer=function(t){var e=this,n=this.options;diffValue(n.keyContainer,t,function(){n.keyContainer=t,e.setKeyController()})},n.setToggleContinueSelect=function(t){var e=this,n=this.options;diffValue(n.toggleContinueSelect,t,function(){n.toggleContinueSelect=t,e.setKeyEvent()})},n.setPreventDefault=function(t){this.gesto.options.preventDefault=t},n.setCheckInput=function(t){this.gesto.options.checkInput=t},n.triggerDragStart=function(t){return this.gesto.triggerDragStart(t),this},n.destroy=function(){this.off(),this.keycon&&this.keycon.destroy(),this.gesto.unset(),this.injectResult.destroy(),removeEvent(document,"selectstart",this.onDocumentSelectStart),this.keycon=null,this.gesto=null,this.injectResult=null,this.target=null,this.container=null,this.options=null},n.getElementPoints=function(t){var e=this.getElementRect||getDefaultElementRect,n=e(t),r=[n.pos1,n.pos2,n.pos4,n.pos3];if(e!==getDefaultElementRect){var o=t.getBoundingClientRect();return fitPoints(r,o)}return r},n.findSelectableTargets=function(t){var e=this;void 0===t&&(t=this.gesto.getEventDatas());var n=this.getSelectableTargets(),r=n.map(function(t){return e.getElementPoints(t)});t.selectableTargets=n,t.selectablePoints=r},n.clickTarget=function(t,e){var n=getClient(t),r={datas:{selectFlag:!1},clientX:n.clientX,clientY:n.clientY,inputEvent:t,isClick:!0,stop:function(){return!1}};return this.onDragStart(r,e)&&this.onDragEnd(r),this},n.setKeyController=function(){var t=this.options,e=t.keyContainer,n=t.toggleContinueSelect;this.keycon&&(this.keycon.destroy(),this.keycon=null),n&&(this.keycon=new KeyController(e||window),this.keycon.keydown(this.onKeyDown).keyup(this.onKeyUp).on("blur",this.onBlur))},n.setKeyEvent=function(){this.options.toggleContinueSelect&&!this.keycon&&this.setKeyController()},n.initElement=function(){this.target=createElement(h("div",{className:CLASS_NAME}),this.target,this.container);var t=this.target,e=this.options,n=e.dragContainer,r=e.checkInput,o=e.preventDefault;this.dragContainer="string"==typeof n?[].slice.call(document.querySelectorAll(n)):this.options.dragContainer||this.target.parentNode,this.gesto=new Gesto(this.dragContainer,{checkWindowBlur:!0,container:window,checkInput:r,preventDefault:o}).on({dragStart:this.onDragStart,drag:this.onDrag,dragEnd:this.onDragEnd}),addEvent(document,"selectstart",this.onDocumentSelectStart),this.injectResult=injector.inject(t,{nonce:this.options.cspNonce})},n.hitTest=function(t,e,n,r,o){var i=this.options,s=i.hitRate,a=i.selectByClick,c=t.left,l=t.top,u=t.right,g=t.bottom,d=[[c,l],[u,l],[u,g],[c,g]];return r.filter(function(t,r){var i=o[r],c=isInside([e,n],i);if(a&&c)return!0;var l=getOverlapPoints(d,i);if(!l.length)return!1;var u=getAreaSize(l),g=getAreaSize(i);return between(Math.round(u/g*100),0,100)>=Math.min(100,s)})},n.initDragScroll=function(){var t=this;this.dragScroll.on("scroll",function(e){var n=e.container,r=e.direction;t.trigger("scroll",{container:n,direction:r})}).on("move",function(e){var n=e.offsetX,r=e.offsetY,o=e.inputEvent,i=o.datas;i.startX-=n,i.startY-=r,i.selectablePoints.forEach(function(t){t.forEach(function(t){t[0]-=n,t[1]-=r})}),t.gesto.scrollBy(n,r,o.inputEvent,!1),o.distX+=n,o.distY+=r,t.check(o)})},n.getSelectableTargets=function(){var t=[];return this.options.selectableTargets.forEach(function(e){isObject(e)?t.push(e):[].slice.call(document.querySelectorAll(e)).forEach(function(e){t.push(e)})}),t},n.select=function(t,e,n,r,o){var i=diff(t,e),s=i.added,a=i.removed,c=i.prevList,l=i.list;this.selectedTargets=e,o&&this.trigger("selectStart",{selected:e,added:s.map(function(t){return l[t]}),removed:a.map(function(t){return c[t]}),rect:n,inputEvent:r}),(s.length||a.length)&&this.trigger("select",{selected:e,added:s.map(function(t){return l[t]}),removed:a.map(function(t){return c[t]}),rect:n,inputEvent:r})},n.selectEnd=function(t,e,n,r){var o=r.inputEvent,i=r.isDouble,s=diff(t,this.selectedTargets),a=s.added,c=s.removed,l=s.prevList,u=s.list,g=diff(e,this.selectedTargets),d=g.added,f=g.removed,p=g.prevList,h=g.list,v=o&&o.type,m="mousedown"===v||"touchstart"===v;this.trigger("selectEnd",{selected:this.selectedTargets,added:a.map(function(t){return u[t]}),removed:c.map(function(t){return l[t]}),afterAdded:d.map(function(t){return h[t]}),afterRemoved:f.map(function(t){return p[t]}),isDragStart:m,isDouble:!!i,rect:n,inputEvent:o})},n.check=function(t,e){void 0===e&&(e=getRect(t,this.options.ratio));var n=t.datas,r=t.inputEvent,o=e.top,i=e.left,s=e.width,a=e.height,c=n.selectFlag,l=[],u=[];if(c){this.target.style.cssText+="display: block;left:0px;top:0px;transform: translate("+i+"px, "+o+"px);width:"+s+"px;height:"+a+"px;";var g=this.hitTest(e,n.startX,n.startY,n.selectableTargets,n.selectablePoints);l=this.selectedTargets,u=passTargets(n.startPassedTargets,g),this.selectedTargets=u}this.trigger("drag",__assign(__assign({},t),{isSelect:c,rect:e})),c&&this.select(l,u,e,r)},n.sameCombiKey=function(t,e){var n=[].concat(this.options.toggleContinueSelect),r=getCombi(t.inputEvent,t.key),o=isArray(n[0])?n:[n];if(e){var i=t.key;return o.some(function(t){return t.some(function(t){return t===i})})}return o.some(function(t){return t.every(function(t){return r.indexOf(t)>-1})})},e=__decorate([Properties(PROPERTIES,function(t,e){var n={enumerable:!0,configurable:!0,get:function(){return this.options[e]}},r=camelize("set "+e);t[r]?n.set=function(t){this[r](t)}:n.set=function(t){this.options[e]=t},Object.defineProperty(t,e,n)})],e)}(EventEmitter),Selecto$1=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Selecto);export default Selecto$1;export{CLASS_NAME,EVENTS,METHODS,OPTIONS,OPTION_TYPES,PROPERTIES};