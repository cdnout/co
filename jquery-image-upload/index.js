(function($){var defaults={wrapContent:"<div class='jQuery-imageUpload'>",inputFileName:"inputFile",inputFileClass:"inputFile",uploadButtonValue:"Upload",uploadButtonClass:"uploadButton",browseButtonValue:"Browse",browseButtonClass:"browseButton",deleteButtonValue:"Delete image",deleteButtonClass:"deleteButton",automaticUpload:false,formClass:"controlForm",hideFileInput:true,hideDeleteButton:false,hover:true,addClass:"jQuery-image-upload"};$.fn.imageUpload=function(options){var $self=this;if(!$self.length){return $self}var settings=$.extend(defaults,options);if($self.length>1){$self.each(function(){$(this).imageUpload(settings)});return $self}if($self.data("imageUpload")){$self.trigger("imageUpload.reload");return $self}$self.addClass(settings.addClass);$self.data("imageUpload",options);if(!settings.formAction){throw new Error("Form action was not provided. Please provide it: $(...).imageUpload({formAction: '...'})")}if(!settings.hover){$self.wrap(settings.wrapContent)}var $controls=$("<div>").addClass("controls");var $fileInput=$("<input>").attr({type:"file",name:settings.inputFileName}).addClass(settings.inputFileClass);var $uploadButton=$("<button>").attr("type","submit").addClass(settings.uploadButtonClass).html(settings.uploadButtonValue);var $browseButton=$("<button>").addClass(settings.browseButtonClass).html(settings.browseButtonValue).on("click",function(){$fileInput.click();return false});var $deleteButton=$("<button>").addClass(settings.deleteButtonClass).html(settings.deleteButtonValue).on("click",function(){$self.trigger("imageUpload.destroy");$self.trigger("imageUpload.imageRemoved");$self.remove();return false});var iframeId="uploadIframe-"+Math.random().toString(36).substring(5,20).toLowerCase();var $uploadIframe=$("<iframe>").attr({id:iframeId,name:iframeId}).hide();var $uploadForm=$("<form>").addClass(settings.formClass).attr({target:$uploadIframe.attr("id"),enctype:"multipart/form-data",method:"post",action:settings.formAction});$uploadForm.append([$browseButton,$fileInput,$uploadButton,$deleteButton,$uploadIframe]);if(settings.hideDeleteButton){$deleteButton.remove()}if(settings.automaticUpload){$uploadButton.hide();$fileInput.on("change",function(){if(!$(this).val()){return}$uploadButton.click()})}if(settings.hideFileInput){$fileInput.hide()}else{$browseButton.hide()}$controls.append($uploadForm);$uploadForm.on("submit",function(){var $form=$(this);$uploadIframe.off("load");var oldSrc=$self.attr("src");if(typeof settings.waiter==="string"){$self.attr("src",settings.waiter)}$self.addClass("loading");$controls.hide();$uploadIframe.on("load",function(){var result=$(this.contentWindow.document).text();if(!/^https?|^\//.test(result)){loadImage($self,oldSrc);$self.trigger("imageUpload.uploadFailed",[result]);return}if(!result){loadImage($self,oldSrc);$self.trigger("imageUpload.uploadFailed",[result]);return}if(settings.hideFileInput){$self.trigger("imageUpload.reload")}if(!$fileInput.val()){loadImage($self,oldSrc);return}$uploadIframe.attr("src","");loadImage($self,result,function(){$self.trigger("imageUpload.imageChanged")});$fileInput.replaceWith($fileInput.clone(true))})});if(!settings.hover){$self.parent().append($controls)}else{$controls.css({position:"absolute"});$controls.addClass("jQuery-image-upload-controls");$("body").append($controls.hide());$self.on("mouseenter",function(){if($self.hasClass("loading")){return}var offset=$self.offset();$controls.css({top:offset.top,left:offset.left});$controls.show()});$("body").on("mouseleave","."+settings.addClass,function(e){var o=$self.offset();var w=$self.width();var h=$self.height();if(e.pageX<o.left||e.pageX>o.left+w||(e.pageY<o.top||e.pageY>o.top+h)){$controls.hide()}})}$self.on("imageUpload.destroy",function(){$controls.remove();$self.off("imageUpload.destroy");$self.off("imageUpload.reload");$self.data("imageUpload",null)});$self.on("imageUpload.reload",function(){$self.trigger("imageUpload.destroy");$self.imageUpload(options)});return $self};function loadImage($imageElement,newSource,callback){$imageElement.fadeOut(function(){$imageElement.attr("src",newSource);imgLoad($imageElement,function(){$imageElement.removeClass("loading");$imageElement.fadeIn();if(typeof callback==="function"){callback()}})})}function imgLoad(selector,callback){$(selector).each(function(){if(this.complete){callback.apply(this)}else{$(this).on("load",function(){callback.apply(this)})}})}$.imageUpload=$.fn.imageUpload;$.imageUpload.defaults=defaults})($);