/*! CAF: cag.mjs
	v12.0.1 (c) 2021 Kyle Simpson
	MIT License: http://getify.mit-license.org
*/
import{TIMEOUT_TOKEN,cancelToken,signalPromise,processTokenOrSignal}from"./shared.mjs";export default CAG;var awaiteds=new WeakSet;const unset=Symbol("unset"),returned=Symbol("returned"),canceled=Symbol("canceled");function CAG(e){return function instance(r,...n){var t,a;if(({tokenOrSignal:r,signal:t,signalPr:a}=processTokenOrSignal(r)),t.aborted)throw t.reason||"Aborted";var o=deferred(),{it:l,ait:i}=runner(e,o.pr,onComplete,t,...n),u=i.return;return i.return=function doReturn(e){try{return o.pr.resolved=!0,o.resolve(returned),Promise.resolve(l.return(e))}finally{u.call(i),onComplete()}},i;function onComplete(){r&&r!==t&&r[TIMEOUT_TOKEN]&&r.abort(),i&&(i.return=u,r=o=l=i=u=null)}}}function isPromise(e){return e&&"object"==typeof e&&"function"==typeof e.then}function deferred(){var e;return{pr:new Promise((function c(r){e=r})),resolve:e}}function pwait(e){var r=Promise.resolve(e);return awaiteds.add(r),r}function runner(e,r,n,t,...a){var o=e.call(this,{signal:t,pwait:pwait},...a);e=a=null;var l=t.pr.catch((e=>{throw{[canceled]:!0,reason:e}}));return{it:o,ait:async function*runner(){var e,t=unset;try{for(;!r.resolved;)if(t!==unset?(e=t,t=unset,e=o.throw(e)):e=o.next(e),isPromise(e.value))if(awaiteds.has(e.value)){awaiteds.delete(e.value);try{if((e=await Promise.race([r,l,e.value]))===returned)return}catch(e){if(e[canceled]){let r=o.return();throw void 0!==r.value?r.value:e.reason}t=e}}else e=yield e.value;else{if(e.done)return e.value;e=yield e.value}}finally{o=r=null,n()}}()}}