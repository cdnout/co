"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Stack=void 0;const config_1=require("../config/config"),resolved_config_1=require("../config/resolved-config"),header_1=require("../controls/header"),internal_error_1=require("../errors/internal-error"),event_emitter_1=require("../utils/event-emitter"),jquery_legacy_1=require("../utils/jquery-legacy"),types_1=require("../utils/types"),utils_1=require("../utils/utils"),component_item_1=require("./component-item"),component_parentable_item_1=require("./component-parentable-item"),content_item_1=require("./content-item");class Stack extends component_parentable_item_1.ComponentParentableItem{constructor(e,t,i){var n,s,o,r,h,a,d,l,m,c,_,u,p,g,v,C,y,x,f,E,I,k;super(e,t,i,Stack.createElement(document)),this._stackParent=i,this._headerSideChanged=!1,this._elementMouseEnterEventListener=(()=>this.onElementMouseEnter()),this._elementMouseLeaveEventListener=(()=>this.onElementMouseLeave()),this._resizeListener=(()=>this.handleResize()),this._maximisedListener=(()=>this.handleMaximised()),this._minimisedListener=(()=>this.handleMinimised()),this._headerConfig=t.header;const S=e.layoutConfig.header,b=t.content;let w;if(1!==b.length)w=void 0;else{w=b[0].header}this._initialWantMaximise=t.maximised,this._initialActiveItemIndex=null!==(n=t.activeItemIndex)&&void 0!==n?n:0;const A=null!==(r=null!==(o=null===(s=this._headerConfig)||void 0===s?void 0:s.show)&&void 0!==o?o:null==w?void 0:w.show)&&void 0!==r?r:S.show,D=null!==(d=null!==(a=null===(h=this._headerConfig)||void 0===h?void 0:h.popout)&&void 0!==a?a:null==w?void 0:w.popout)&&void 0!==d?d:S.popout,M=null!==(c=null!==(m=null===(l=this._headerConfig)||void 0===l?void 0:l.dock)&&void 0!==m?m:null==w?void 0:w.dock)&&void 0!==c?c:S.dock,H=null!==(p=null!==(u=null===(_=this._headerConfig)||void 0===_?void 0:_.maximise)&&void 0!==u?u:null==w?void 0:w.maximise)&&void 0!==p?p:S.maximise,P=null!==(C=null!==(v=null===(g=this._headerConfig)||void 0===g?void 0:g.close)&&void 0!==v?v:null==w?void 0:w.close)&&void 0!==C?C:S.close,L=null!==(f=null!==(x=null===(y=this._headerConfig)||void 0===y?void 0:y.minimise)&&void 0!==x?x:null==w?void 0:w.minimise)&&void 0!==f?f:S.minimise,T=null!==(k=null!==(I=null===(E=this._headerConfig)||void 0===E?void 0:E.tabDropdown)&&void 0!==I?I:null==w?void 0:w.tabDropdown)&&void 0!==k?k:S.tabDropdown;this._maximisedEnabled=!1!==H;const z={show:!1!==A,side:!1===A?types_1.Side.top:A,popoutEnabled:!1!==D,popoutLabel:!1===D?"":D,dockEnabled:!1!==M,dockLabel:!1===M?"":M,maximiseEnabled:this._maximisedEnabled,maximiseLabel:!1===H?"":H,closeEnabled:!1!==P,closeLabel:!1===P?"":P,minimiseEnabled:!0,minimiseLabel:L,tabDropdownEnabled:!1!==T,tabDropdownLabel:!1===T?"":T};this._header=new header_1.Header(e,this,z,t.isClosable&&!1!==P,()=>this.getActiveComponentItem(),()=>this.remove(),()=>this.handleDockEvent(),()=>this.handlePopoutEvent(),()=>this.toggleMaximise(),e=>this.handleHeaderClickEvent(e),e=>this.handleHeaderTouchStartEvent(e),e=>this.handleHeaderComponentRemoveEvent(e),e=>this.handleHeaderComponentFocusEvent(e),(e,t,i,n)=>this.handleHeaderComponentStartDragEvent(e,t,i,n)),this.isStack=!0,this._childElementContainer=document.createElement("section"),this._childElementContainer.classList.add("lm_items"),this.on("resize",this._resizeListener),this._maximisedEnabled&&(this.on("maximised",this._maximisedListener),this.on("minimised",this._minimisedListener)),this.element.addEventListener("mouseenter",this._elementMouseEnterEventListener,{passive:!0}),this.element.addEventListener("mouseleave",this._elementMouseLeaveEventListener,{passive:!0}),this.element.appendChild(this._header.element),this.element.appendChild(this._childElementContainer),this.setUndocked(),this.setupHeaderPosition(),this._header.updateClosability()}get childElementContainer(){return this._childElementContainer}get headerShow(){return this._header.show}get headerSide(){return this._header.side}get headerLeftRightSided(){return this._header.leftRightSided}get dockEnabled(){return this._header.dockEnabled}get docker(){return this._docker}get contentAreaDimensions(){return this._contentAreaDimensions}get initialWantMaximise(){return this._initialWantMaximise}get isMaximised(){return this===this.layoutManager.maximisedStack}dock(e){this._header.dockEnabled&&(this._stackParent.isColumn||this._stackParent.isColumn)&&this._stackParent.dock(this,e)}updateSize(){this.updateNodeSize(),this.updateContentItemsSize()}init(){if(!0===this.isInitialised)return;this.updateNodeSize();for(let e=0;e<this.contentItems.length;e++)this._childElementContainer.appendChild(this.contentItems[e].element);super.init();const e=this.contentItems,t=e.length;if(t>0){if(this._initialActiveItemIndex<0||this._initialActiveItemIndex>=t)throw new Error(`ActiveItemIndex out of range: ${this._initialActiveItemIndex} id: ${this.id}`);for(let i=0;i<t;i++){const t=e[i];if(!(t instanceof component_item_1.ComponentItem))throw new Error(`Stack Content Item is not of type ComponentItem: ${i} id: ${this.id}`);this._header.createTab(t,i),t.hide()}this.setActiveComponentItem(e[this._initialActiveItemIndex],!1),this._header.updateTabSizes()}this._header.updateClosability(),(this._stackParent.isRow||this._stackParent.isColumn)&&this._stackParent.validateDocking(),this.initContentItems()}setActiveContentItem(e){if(!content_item_1.ContentItem.isComponentItem(e))throw new Error("Stack.setActiveContentItem: item is not a ComponentItem");this.setActiveComponentItem(e,!1)}setActiveComponentItem(e,t,i=!1){if(this._activeComponentItem!==e){if(-1===this.contentItems.indexOf(e))throw new Error("componentItem is not a child of this stack");void 0!==this._activeComponentItem&&this._activeComponentItem.hide(),this._activeComponentItem=e,this._header.processActiveComponentChanged(e),e.show(),this.emit("activeContentItemChanged",e),this.layoutManager.emit("activeContentItemChanged",e),this.emitStateChangedEvent()}(this.focused||t)&&this.layoutManager.setFocusedComponentItem(e,i)}getActiveContentItem(){let e;return void 0===(e=this.getActiveComponentItem())&&(e=null),e}getActiveComponentItem(){return this._activeComponentItem}focusActiveContentItem(){this._activeComponentItem.focus()}setFocusedValue(e){this._header.applyFocusedValue(e),super.setFocusedValue(e)}setDocked(e){if(!e.docked)throw new internal_error_1.AssertError("SSD3396");this._docker=e}setUndocked(){this._docker={docked:!1,dimension:"width",size:0,realSize:0}}setDockable(e){this._header.setDockable(e)}setRowColumnClosable(e){this._header.setRowColumnClosable(e)}newComponent(e,t,i,n){const s={type:"component",componentType:e,componentState:t,title:i};return this.newItem(s,n)}addComponent(e,t,i,n){const s={type:"component",componentType:e,componentState:t,title:i};return this.addItem(s,n)}newItem(e,t){return t=this.addItem(e,t),this.contentItems[t]}addItem(e,t){this.layoutManager.checkMinimiseMaximisedStack();const i=config_1.ItemConfig.resolve(e),n=this.layoutManager.createAndInitContentItem(i,this);return this.addChild(n,t)}addChild(e,t,i=!1){if(void 0!==t&&t>this.contentItems.length)throw t-=1,new internal_error_1.AssertError("SAC99728");if(e instanceof component_item_1.ComponentItem)return t=super.addChild(e,t),this._childElementContainer.appendChild(e.element),this._header.createTab(e,t),this.setActiveComponentItem(e,i),this._header.updateTabSizes(),this.updateSize(),this._header.updateClosability(),(this._stackParent.isRow||this._stackParent.isColumn)&&this._stackParent.validateDocking(),this.emitStateChangedEvent(),t;throw new internal_error_1.AssertError("SACC88532")}removeChild(e,t){const i=e,n=this.contentItems.indexOf(i),s=1===this.contentItems.length;this._activeComponentItem===i&&(i.focused&&i.blur(),s||this.setActiveComponentItem(this.contentItems[Math.max(n-1,0)],!1)),this._header.removeTab(i),super.removeChild(i,t),s||(this._header.updateClosability(),(this._stackParent.isRow||this._stackParent.isColumn)&&this._stackParent.validateDocking()),this.emitStateChangedEvent()}toggleMaximise(){this.isMaximised?this.minimise():this.maximise()}maximise(){this.isMaximised||(this.dock(!1),this.layoutManager.setMaximisedStack(this),this.emitStateChangedEvent())}minimise(){this.isMaximised&&(this.layoutManager.setMaximisedStack(void 0),this.emitStateChangedEvent())}destroy(){this._activeComponentItem.focused&&this._activeComponentItem.blur(),super.destroy(),this.off("resize",this._resizeListener),this._maximisedEnabled&&(this.off("maximised",this._maximisedListener),this.off("minimised",this._minimisedListener)),this.element.removeEventListener("mouseenter",this._elementMouseEnterEventListener),this.element.removeEventListener("mouseleave",this._elementMouseLeaveEventListener),this._header.destroy()}toConfig(){const e=this.contentItems.indexOf(this._activeComponentItem);if(e<0)throw new internal_error_1.AssertError("STC69221");return{type:"stack",content:this.calculateConfigContent(),width:this.width,minWidth:this.minWidth,height:this.height,minHeight:this.minHeight,id:this.id,isClosable:this.isClosable,maximised:this.isMaximised,header:this.createHeaderConfig(),activeItemIndex:e}}onDrop(e,t){if("header"===this._dropSegment){if(this.resetHeaderDropZone(),void 0===this._dropIndex)throw new internal_error_1.UnexpectedUndefinedError("SODDI68990");return void this.addChild(e,this._dropIndex)}if("body"===this._dropSegment)return void this.addChild(e,0,!0);const i="top"===this._dropSegment||"bottom"===this._dropSegment,n="left"===this._dropSegment||"right"===this._dropSegment,s="top"===this._dropSegment||"left"===this._dropSegment,o=i&&this._stackParent.isColumn||n&&this._stackParent.isRow,r=i?"height":"width";if(e.isComponent){const t=resolved_config_1.ResolvedStackItemConfig.createDefault();t.header=this.createHeaderConfig();const i=this.layoutManager.createAndInitContentItem(t,this);i.addChild(e),e=i}if(e.type===types_1.ItemType.row||e.type===types_1.ItemType.column){const t=resolved_config_1.ResolvedStackItemConfig.createDefault();t.header=this.createHeaderConfig();const i=this.layoutManager.createContentItem(t,this);i.addChild(e),e=i}if(o){const t=this._stackParent.contentItems.indexOf(this);this._stackParent.addChild(e,s?t:t+1,!0),this[r]*=.5,e[r]=this[r],this._stackParent.updateSize()}else{const t=i?types_1.ItemType.column:types_1.ItemType.row,n=resolved_config_1.ResolvedItemConfig.createDefault(t),o=this.layoutManager.createContentItem(n,this);this._stackParent.replaceChild(this,o),o.addChild(e,s?0:void 0,!0),o.addChild(this,s?void 0:0,!0),this[r]=50,e[r]=50,o.updateSize()}this._stackParent.validateDocking()}highlightDropZone(e,t){for(const i in this._contentAreaDimensions){const n=i,s=this._contentAreaDimensions[n].hoverArea;if(s.x1<e&&s.x2>e&&s.y1<t&&s.y2>t)return void("header"===n?(this._dropSegment="header",this.highlightHeaderDropZone(this._header.leftRightSided?t:e)):(this.resetHeaderDropZone(),this.highlightBodyDropZone(n)))}}getArea(){if("none"===this.element.style.display)return null;const e=super.getElementArea(this._header.element),t=super.getElementArea(this._childElementContainer);if(null===e||null===t)throw new internal_error_1.UnexpectedNullError("SGAHC13086");const i=t.x2-t.x1,n=t.y2-t.y1;return this._contentAreaDimensions={header:{hoverArea:{x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2},highlightArea:{x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}}},0===this.contentItems.length?(this._contentAreaDimensions.body={hoverArea:{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2},highlightArea:{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2}},super.getElementArea(this.element)):(this._contentAreaDimensions.left={hoverArea:{x1:t.x1,y1:t.y1,x2:t.x1+.25*i,y2:t.y2},highlightArea:{x1:t.x1,y1:t.y1,x2:t.x1+.5*i,y2:t.y2}},this._contentAreaDimensions.top={hoverArea:{x1:t.x1+.25*i,y1:t.y1,x2:t.x1+.75*i,y2:t.y1+.5*n},highlightArea:{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y1+.5*n}},this._contentAreaDimensions.right={hoverArea:{x1:t.x1+.75*i,y1:t.y1,x2:t.x2,y2:t.y2},highlightArea:{x1:t.x1+.5*i,y1:t.y1,x2:t.x2,y2:t.y2}},this._contentAreaDimensions.bottom={hoverArea:{x1:t.x1+.25*i,y1:t.y1+.5*n,x2:t.x1+.75*i,y2:t.y2},highlightArea:{x1:t.x1,y1:t.y1+.5*n,x2:t.x2,y2:t.y2}},super.getElementArea(this.element))}positionHeader(e){if(this._docker.docked)throw new Error("Can't change header position in docked stack");this._header.side!==e&&(this._header.setSide(e),this._headerSideChanged=!0,this.setupHeaderPosition())}setParent(e){this._stackParent=e,super.setParent(e)}updateNodeSize(){if("none"!==this.element.style.display){const e=this._docker.docked,t=utils_1.getElementWidthAndHeight(this.element);if(this._header.show){t[this._header.leftRightSided?types_1.WidthOrHeightPropertyName.width:types_1.WidthOrHeightPropertyName.height]-=this.layoutManager.layoutConfig.dimensions.headerHeight}e&&(t[this._docker.dimension]=this._docker.realSize),e&&this._docker.dimension!==types_1.WidthOrHeightPropertyName.height||(this._childElementContainer.style.width=utils_1.numberToPixels(t.width)),e&&this._docker.dimension!==types_1.WidthOrHeightPropertyName.width||(this._childElementContainer.style.height=utils_1.numberToPixels(t.height));for(let e=0;e<this.contentItems.length;e++)this.contentItems[e].element.style.width=utils_1.numberToPixels(t.width),this.contentItems[e].element.style.height=utils_1.numberToPixels(t.height);this.emit("resize"),this.emitStateChangedEvent()}}highlightHeaderDropZone(e){const t=this._header.tabs.length,i=this.layoutManager.dropTargetIndicator;if(null===i)throw new internal_error_1.UnexpectedNullError("SHHDZDTI97110");let n;if(0===t){const e=jquery_legacy_1.getJQueryOffset(this._header.element),t=utils_1.getElementHeight(this._header.element);n={x1:e.left,x2:e.left+100,y1:e.top+t-20,y2:e.top+t}}else{let i,s,o,r,h=0,a=!1;do{r=this._header.tabs[h].element;const t=jquery_legacy_1.getJQueryOffset(r);this._header.leftRightSided?(s=t.top,i=t.left,o=utils_1.getElementHeight(r)):(s=t.left,i=t.top,o=utils_1.getElementWidth(r)),e>s&&e<s+o?a=!0:h++}while(h<t&&!a);if(!1===a&&e<s)return;e<s+o/2?(this._dropIndex=h,r.insertAdjacentElement("beforebegin",this.layoutManager.tabDropPlaceholder)):(this._dropIndex=Math.min(h+1,t),r.insertAdjacentElement("afterend",this.layoutManager.tabDropPlaceholder));const d=jquery_legacy_1.getJQueryOffset(this.layoutManager.tabDropPlaceholder),l=utils_1.getElementWidth(this.layoutManager.tabDropPlaceholder);if(this._header.leftRightSided){const e=d.top;n={x1:i,x2:i+r.clientHeight,y1:e,y2:e+l}}else{const e=d.left;n={x1:e,x2:e+l,y1:i,y2:i+r.clientHeight}}}i.highlightArea(n)}resetHeaderDropZone(){this.layoutManager.tabDropPlaceholder.remove()}setupHeaderPosition(){utils_1.setElementDisplayVisibility(this._header.element,this._header.show),this.element.classList.remove("lm_left","lm_right","lm_bottom"),this._header.leftRightSided&&this.element.classList.add("lm_"+this._header.side);const e=[types_1.Side.right,types_1.Side.bottom].includes(this._header.side)?"beforeend":"afterend";this._header.element.insertAdjacentElement(e,this._childElementContainer),this.updateSize()}highlightBodyDropZone(e){if(void 0===this._contentAreaDimensions)throw new internal_error_1.UnexpectedUndefinedError("SHBDZC82265");{const t=this._contentAreaDimensions[e].highlightArea,i=this.layoutManager.dropTargetIndicator;if(null===i)throw new internal_error_1.UnexpectedNullError("SHBDZD96110");i.highlightArea(t),this._dropSegment=e}}handleResize(){this._header.updateTabSizes()}handleMaximised(){this._header.processMaximised()}handleMinimised(){this._header.processMinimised()}onElementMouseEnter(){this._docker.docked&&(this._childElementContainer.style[this._docker.dimension]=utils_1.numberToPixels(this._docker.realSize))}onElementMouseLeave(){this._docker.docked&&(this._childElementContainer.style[this._docker.dimension]=utils_1.numberToPixels(0))}handleDockEvent(){this.dock()}handlePopoutEvent(){this.popout()}handleHeaderClickEvent(e){const t=event_emitter_1.EventEmitter.headerClickEventName,i=new event_emitter_1.EventEmitter.ClickBubblingEvent(t,this,e);this.emit(t,i)}handleHeaderTouchStartEvent(e){const t=event_emitter_1.EventEmitter.headerTouchStartEventName,i=new event_emitter_1.EventEmitter.TouchStartBubblingEvent(t,this,e);this.emit(t,i)}handleHeaderComponentRemoveEvent(e){this.removeChild(e,!1)}handleHeaderComponentFocusEvent(e){this.setActiveComponentItem(e,!0)}handleHeaderComponentStartDragEvent(e,t,i,n){!0===this.isMaximised&&this.toggleMaximise(),this.layoutManager.startComponentDrag(e,t,i,n,this)}createHeaderConfig(){if(this._headerSideChanged){const e=!!this._header.show&&this._header.side;let t=resolved_config_1.ResolvedHeaderedItemConfig.Header.createCopy(this._headerConfig,e);return void 0===t&&(t={show:e,popout:void 0,dock:void 0,maximise:void 0,close:void 0,minimise:void 0,tabDropdown:void 0}),t}return resolved_config_1.ResolvedHeaderedItemConfig.Header.createCopy(this._headerConfig)}emitStateChangedEvent(){this.emitBaseBubblingEvent("stateChanged")}}exports.Stack=Stack,function(e){e.createElement=function(e){const t=e.createElement("div");return t.classList.add("lm_item"),t.classList.add("lm_stack"),t}}(Stack=exports.Stack||(exports.Stack={}));