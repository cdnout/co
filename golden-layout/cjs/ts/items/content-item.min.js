"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ContentItem=void 0;const internal_error_1=require("../errors/internal-error"),event_emitter_1=require("../utils/event-emitter"),jquery_legacy_1=require("../utils/jquery-legacy"),utils_1=require("../utils/utils");class ContentItem extends event_emitter_1.EventEmitter{constructor(t,e,n,i){super(),this.layoutManager=t,this._parent=n,this._element=i,this._popInParentIds=[],this._type=e.type,this._id=e.id,this._isInitialised=!1,this.isGround=!1,this.isRow=!1,this.isColumn=!1,this.isStack=!1,this.isComponent=!1,this.width=e.width,this.minWidth=e.minWidth,this.height=e.height,this.minHeight=e.minHeight,this._isClosable=e.isClosable,this._pendingEventPropagations={},this._throttledEvents=["stateChanged"],this._contentItems=this.createContentItems(e.content)}get type(){return this._type}get id(){return this._id}get popInParentIds(){return this._popInParentIds}get parent(){return this._parent}get contentItems(){return this._contentItems}get isClosable(){return this._isClosable}get element(){return this._element}get isInitialised(){return this._isInitialised}static isStack(t){return t.isStack}static isComponentItem(t){return t.isComponent}static isComponentParentableItem(t){return t.isStack||t.isGround}removeChild(t,e=!1){const n=this._contentItems.indexOf(t);if(-1===n)throw new Error("Can't remove child item. Unknown content item");if(e||this._contentItems[n].destroy(),this._contentItems.splice(n,1),this._contentItems.length>0)this.updateSize();else if(!this.isGround&&!0===this._isClosable){if(null===this._parent)throw new internal_error_1.UnexpectedNullError("CIUC00874");this._parent.removeChild(this)}}addChild(t,e,n){return null!=e||(e=this._contentItems.length),this._contentItems.splice(e,0,t),t.setParent(this),!0===this._isInitialised&&!1===t._isInitialised&&t.init(),e}replaceChild(t,e,n=!1){const i=this._contentItems.indexOf(t),s=t._element.parentNode;if(-1===i)throw new internal_error_1.AssertError("CIRCI23232","Can't replace child. oldChild is not child of this");if(null===s)throw new internal_error_1.UnexpectedNullError("CIRCP23232");if(s.replaceChild(e._element,t._element),!0===n&&(t._parent=null,t.destroy()),this._contentItems[i]=e,e.setParent(this),null===e._parent)throw new internal_error_1.UnexpectedNullError("CIRCNC45699");!0===e._parent._isInitialised&&!1===e._isInitialised&&e.init(),this.updateSize()}remove(){if(null===this._parent)throw new internal_error_1.UnexpectedNullError("CIR11110");this._parent.removeChild(this)}popout(){const t=utils_1.getUniqueId(),e=this.layoutManager.createPopoutFromContentItem(this,void 0,t,void 0);return this.emitBaseBubblingEvent("stateChanged"),e}calculateConfigContent(){const t=this._contentItems,e=t.length,n=new Array(e);for(let i=0;i<e;i++){const e=t[i];n[i]=e.toConfig()}return n}highlightDropZone(t,e,n){const i=this.layoutManager.dropTargetIndicator;if(null===i)throw new internal_error_1.UnexpectedNullError("ACIHDZ5593");i.highlightArea(n)}onDrop(t,e){this.addChild(t)}show(){utils_1.setElementDisplayVisibility(this._element,!0),this.layoutManager.updateSizeFromContainer();for(let t=0;t<this._contentItems.length;t++)this._contentItems[t].show()}destroy(){for(let t=0;t<this._contentItems.length;t++)this._contentItems[t].destroy();this._contentItems=[],this.emitBaseBubblingEvent("beforeItemDestroyed"),this._element.remove(),this.emitBaseBubblingEvent("itemDestroyed")}getElementArea(t){t=null!=t?t:this._element;const e=jquery_legacy_1.getJQueryOffset(t),n=t.offsetWidth,i=t.offsetHeight;return{x1:e.left+1,y1:e.top+1,x2:e.left+n-1,y2:e.top+i-1,surface:n*i,contentItem:this}}init(){this._isInitialised=!0,this.emitBaseBubblingEvent("itemCreated"),this.emitUnknownBubblingEvent(this.type+"Created")}setParent(t){this._parent=t}addPopInParentId(t){this.popInParentIds.includes(t)||this.popInParentIds.push(t)}initContentItems(){for(let t=0;t<this._contentItems.length;t++)this._contentItems[t].init()}hide(){utils_1.setElementDisplayVisibility(this._element,!1),this.layoutManager.updateSizeFromContainer()}updateContentItemsSize(){for(let t=0;t<this._contentItems.length;t++)this._contentItems[t].updateSize()}createContentItems(t){const e=t.length,n=new Array(e);for(let e=0;e<t.length;e++)n[e]=this.layoutManager.createContentItem(t[e],this);return n}propagateEvent(t,e){if(1===e.length){const n=e[0];n instanceof event_emitter_1.EventEmitter.BubblingEvent&&!1===n.isPropagationStopped&&!0===this._isInitialised&&(!1===this.isGround&&this._parent?this._parent.emitUnknown(t,n):this.scheduleEventPropagationToLayoutManager(t,n))}}tryBubbleEvent(t,e){if(1===e.length){const n=e[0];n instanceof event_emitter_1.EventEmitter.BubblingEvent&&!1===n.isPropagationStopped&&!0===this._isInitialised&&(!1===this.isGround&&this._parent?this._parent.emitUnknown(t,n):this.scheduleEventPropagationToLayoutManager(t,n))}}scheduleEventPropagationToLayoutManager(t,e){-1===this._throttledEvents.indexOf(t)?this.layoutManager.emitUnknown(t,e):!0!==this._pendingEventPropagations[t]&&(this._pendingEventPropagations[t]=!0,globalThis.requestAnimationFrame(()=>this.propagateEventToLayoutManager(t,e)))}propagateEventToLayoutManager(t,e){this._pendingEventPropagations[t]=!1,this.layoutManager.emitUnknown(t,e)}}exports.ContentItem=ContentItem;