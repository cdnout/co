"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RowOrColumn=void 0;const config_1=require("../config/config"),splitter_1=require("../controls/splitter"),internal_error_1=require("../errors/internal-error"),types_1=require("../utils/types"),utils_1=require("../utils/utils"),content_item_1=require("./content-item"),stack_1=require("./stack");class RowOrColumn extends content_item_1.ContentItem{constructor(t,e,i,n){switch(super(e,i,n,RowOrColumn.createElement(document,t)),this._rowOrColumnParent=n,this._splitter=[],this.isRow=!t,this.isColumn=t,this._childElementContainer=this.element,this._splitterSize=e.layoutConfig.dimensions.borderWidth,this._splitterGrabSize=e.layoutConfig.dimensions.borderGrabWidth,this._isColumn=t,this._dimension=t?"height":"width",this._splitterPosition=null,this._splitterMinPosition=null,this._splitterMaxPosition=null,i.type){case types_1.ItemType.row:case types_1.ItemType.column:this._configType=i.type;break;default:throw new internal_error_1.AssertError("ROCCCT00925")}}newComponent(t,e,i,n){const s={type:"component",componentType:t,componentState:e,title:i};return this.newItem(s,n)}addComponent(t,e,i,n){const s={type:"component",componentType:t,componentState:e,title:i};return this.addItem(s,n)}newItem(t,e){e=this.addItem(t,e);const i=this.contentItems[e];return content_item_1.ContentItem.isStack(i)&&config_1.ItemConfig.isComponent(t)?i.contentItems[0]:i}addItem(t,e){this.layoutManager.checkMinimiseMaximisedStack();const i=config_1.ItemConfig.resolve(t),n=this.layoutManager.createAndInitContentItem(i,this);return this.addChild(n,e,!1)}addChild(t,e,i){if(void 0===e&&(e=this.contentItems.length),this.contentItems.length>0){const i=this.createSplitter(Math.max(0,e-1)).element;e>0?(this.contentItems[e-1].element.insertAdjacentElement("afterend",i),i.insertAdjacentElement("afterend",t.element),this.isDocked(e-1)&&(utils_1.setElementDisplayVisibility(this._splitter[e-1].element,!1),utils_1.setElementDisplayVisibility(this._splitter[e].element,!0))):(this.contentItems[0].element.insertAdjacentElement("beforebegin",i),i.insertAdjacentElement("beforebegin",t.element))}else this._childElementContainer.appendChild(t.element);super.addChild(t,e);const n=1/this.contentItems.length*100;if(!0===i)return this.emitBaseBubblingEvent("stateChanged"),e;for(let e=0;e<this.contentItems.length;e++)if(this.contentItems[e]===t)t[this._dimension]=n;else{const t=this.contentItems[e][this._dimension]*=(100-n)/100;this.contentItems[e][this._dimension]=t}return this.updateSize(),this.emitBaseBubblingEvent("stateChanged"),this.validateDocking(),e}removeChild(t,e){const i=t[this._dimension],n=this.contentItems.indexOf(t),s=Math.max(n-1,0);if(-1===n)throw new Error("Can't remove child. ContentItem is not child of this Row or Column");this._splitter[s]&&(this._splitter[s].destroy(),this._splitter.splice(s,1)),s<this._splitter.length&&this.isDocked(s)&&utils_1.setElementDisplayVisibility(this._splitter[s].element,!1);const o=this.calculateDockedCount();for(let e=0;e<this.contentItems.length;e++)this.contentItems[e]!==t&&(this.isDocked(e)||(this.contentItems[e][this._dimension]+=i/(this.contentItems.length-1-o)));if(super.removeChild(t,e),1===this.contentItems.length&&!0===this.isClosable){const t=this.contentItems[0];this.contentItems.length=0,this._rowOrColumnParent.replaceChild(this,t,!0),this._rowOrColumnParent instanceof RowOrColumn&&this._rowOrColumnParent.validateDocking()}else this.updateSize(),this.emitBaseBubblingEvent("stateChanged"),this.validateDocking()}replaceChild(t,e){const i=t[this._dimension];super.replaceChild(t,e),e[this._dimension]=i,this.updateSize(),this.emitBaseBubblingEvent("stateChanged")}updateSize(){this.updateNodeSize(),this.updateContentItemsSize()}dock(t,e,i){if(1===this.contentItems.length)throw new Error("Can't dock child when it single");const n=t[this._dimension],s=!1===this.layoutManager.layoutConfig.header.show?0:this.layoutManager.layoutConfig.dimensions.headerHeight,o=this.contentItems.indexOf(t),l=Math.max(o-1,0);if(-1===o)throw new Error("Can't dock child. ContentItem is not child of this Row or Column");const h=t.docker.docked;if(void 0===e||e!==h){if(h){this._splitter[l].element.style.display="";for(let e=0;e<this.contentItems.length;e++){const i=t.docker.size;if(this.contentItems[e]===t)t[this._dimension]=i;else{const t=this.contentItems[e][this._dimension]*=(100-i)/100;this.contentItems[e][this._dimension]=t}}t.setUndocked()}else{if(this.contentItems.length-this.calculateDockedCount()<2)throw new internal_error_1.AssertError("Can't dock child when it is last in "+this.type);const e={column:{first:types_1.Side.top,last:types_1.Side.bottom},row:{first:types_1.Side.left,last:types_1.Side.right}}[this._configType][o?"last":"first"];t.headerSide!==e&&t.positionHeader(e),this._splitter[l]&&utils_1.setElementDisplayVisibility(this._splitter[l].element,!1);const h=this.calculateDockedCount();for(let e=0;e<this.contentItems.length;e++)this.contentItems[e]!==t?this.isDocked(e)||(this.contentItems[e][this._dimension]+=n/(this.contentItems.length-1-h)):this.contentItems[e][this._dimension]=0;t.setDocked({docked:!0,dimension:this._dimension,size:n,realSize:RowOrColumn.getElementDimensionSize(t.element,this._dimension)-s}),i&&RowOrColumn.setElementDimensionSize(t.childElementContainer,this._dimension,0)}t.element.classList.toggle("lm_docked",t.docker.docked),this.updateSize(),this.emitBaseBubblingEvent("stateChanged"),this.validateDocking()}}validateDocking(){var t;const e=this.contentItems.length-this.calculateDockedCount()>1;for(let i=0;i<this.contentItems.length;++i){const n=this.contentItems[i];n instanceof stack_1.Stack&&(n.setDockable(null!==(t=this.isDocked(i))&&void 0!==t?t:e),n.setRowColumnClosable(e))}}init(){if(!0!==this.isInitialised){this.updateNodeSize();for(let t=0;t<this.contentItems.length;t++)this._childElementContainer.appendChild(this.contentItems[t].element);super.init();for(let t=0;t<this.contentItems.length-1;t++)this.contentItems[t].element.insertAdjacentElement("afterend",this.createSplitter(t).element);for(let t=0;t<this.contentItems.length;t++){const e=this.contentItems[t];e instanceof stack_1.Stack&&e.docker.docked&&this.dock(e,!0,!0)}this.initContentItems()}}toConfig(){return{type:this.type,content:this.calculateConfigContent(),width:this.width,minWidth:this.minWidth,height:this.height,minHeight:this.minHeight,id:this.id,isClosable:this.isClosable}}setParent(t){this._rowOrColumnParent=t,super.setParent(t)}updateNodeSize(){this.contentItems.length>0&&(this.calculateRelativeSizes(),this.setAbsoluteSizes()),this.emitBaseBubblingEvent("stateChanged"),this.emit("resize")}setAbsoluteSizes(){const t=this.calculateAbsoluteSizes();for(let e=0;e<this.contentItems.length;e++)t.additionalPixel-e>0&&t.itemSizes[e]++,this._isColumn?(utils_1.setElementWidth(this.contentItems[e].element,t.totalWidth),utils_1.setElementHeight(this.contentItems[e].element,t.itemSizes[e])):(utils_1.setElementWidth(this.contentItems[e].element,t.itemSizes[e]),utils_1.setElementHeight(this.contentItems[e].element,t.totalHeight))}calculateAbsoluteSizes(){const t=(this.contentItems.length-1)*this._splitterSize,e=this.layoutManager.layoutConfig.dimensions.headerHeight;let{width:i,height:n}=utils_1.getElementWidthAndHeight(this.element);this._isColumn?n-=t:i-=t;for(let t=0;t<this.contentItems.length;t++)this.isDocked(t)&&(this._isColumn?n-=e-this._splitterSize:i-=e-this._splitterSize);let s=0;const o=[];for(let t=0;t<this.contentItems.length;t++){let l;l=this._isColumn?Math.floor(n*(this.contentItems[t].height/100)):Math.floor(i*(this.contentItems[t].width/100)),this.isDocked(t)&&(l=e),s+=l,o.push(l)}return{itemSizes:o,additionalPixel:Math.floor((this._isColumn?n:i)-s),totalWidth:i,totalHeight:n}}calculateRelativeSizes(){let t=0;const e=[];for(let i=0;i<this.contentItems.length;i++)void 0!==this.contentItems[i][this._dimension]?t+=this.contentItems[i][this._dimension]:e.push(this.contentItems[i]);if(100!==Math.round(t))if(Math.round(t)<100&&e.length>0){for(let i=0;i<e.length;i++)e[i][this._dimension]=(100-t)/e.length;this.respectMinItemWidth()}else{if(Math.round(t)>100)for(let i=0;i<e.length;i++)e[i][this._dimension]=50,t+=50;for(let e=0;e<this.contentItems.length;e++)this.contentItems[e][this._dimension]=this.contentItems[e][this._dimension]/t*100;this.respectMinItemWidth()}else this.respectMinItemWidth()}respectMinItemWidth(){const t=this.layoutManager.layoutConfig.dimensions.minItemWidth;let e=0,i=0;const n=[],s=[];if(this._isColumn||!t||this.contentItems.length<=1)return;const o=this.calculateAbsoluteSizes();for(let l=0;l<o.itemSizes.length;l++){const h=o.itemSizes[l];let r;h<t?(i+=t-h,r={width:t}):(e+=h-t,r={width:h},n.push(r)),s.push(r)}if(0===i||i>e)return;const l=i/e;let h=i;for(let e=0;e<n.length;e++){const i=n[e],s=Math.round((i.width-t)*l);h-=s,i.width-=s}0!==h&&(s[s.length-1].width-=h);for(let t=0;t<this.contentItems.length;t++)this.contentItems[t].width=s[t].width/o.totalWidth*100}createSplitter(t){const e=new splitter_1.Splitter(this._isColumn,this._splitterSize,this._splitterGrabSize);return e.on("drag",(t,i)=>this.onSplitterDrag(e,t,i)),e.on("dragStop",()=>this.onSplitterDragStop(e)),e.on("dragStart",()=>this.onSplitterDragStart(e)),this._splitter.splice(t,0,e),e}getItemsForSplitter(t){const e=this._splitter.indexOf(t);return{before:this.contentItems[e],after:this.contentItems[e+1]}}isDocked(t){if(t>=this.contentItems.length)return!1;{const e=this.contentItems[t];return e instanceof stack_1.Stack&&e.docker.docked}}calculateDockedCount(){let t=0;for(let e=0;e<this.contentItems.length;++e)this.isDocked(e)&&t++;return t}getMinimumDimensions(t){var e,i;let n=0,s=0;for(let o=0;o<t.length;++o)n=Math.max(null!==(e=t[o].minWidth)&&void 0!==e?e:0,n),s=Math.max(null!==(i=t[o].minHeight)&&void 0!==i?i:0,s);return{horizontal:n,vertical:s}}onSplitterDragStart(t){const e=this.getItemsForSplitter(t),i=this.layoutManager.layoutConfig.dimensions[this._isColumn?"minItemHeight":"minItemWidth"],n=this.getMinimumDimensions(e.before.contentItems),s=this._isColumn?n.vertical:n.horizontal,o=this.getMinimumDimensions(e.after.contentItems),l=this._isColumn?o.vertical:o.horizontal;this._splitterPosition=0,this._splitterMinPosition=-1*(utils_1.pixelsToNumber(e.before.element.style[this._dimension])-(s||i)),this._splitterMaxPosition=utils_1.pixelsToNumber(e.after.element.style[this._dimension])-(l||i)}onSplitterDrag(t,e,i){const n=this._isColumn?i:e;if(null===this._splitterMinPosition||null===this._splitterMaxPosition)throw new internal_error_1.UnexpectedNullError("ROCOSD59226");if(n>this._splitterMinPosition&&n<this._splitterMaxPosition){this._splitterPosition=n;const e=utils_1.numberToPixels(n);this._isColumn?t.element.style.top=e:t.element.style.left=e}}onSplitterDragStop(t){if(null===this._splitterPosition)throw new internal_error_1.UnexpectedNullError("ROCOSDS66932");{const e=this.getItemsForSplitter(t),i=utils_1.pixelsToNumber(e.before.element.style[this._dimension]),n=utils_1.pixelsToNumber(e.after.element.style[this._dimension]),s=(this._splitterPosition+i)/(i+n),o=e.before[this._dimension]+e.after[this._dimension];e.before[this._dimension]=s*o,e.after[this._dimension]=(1-s)*o,t.element.style.top=utils_1.numberToPixels(0),t.element.style.left=utils_1.numberToPixels(0),globalThis.requestAnimationFrame(()=>this.updateSize())}}}exports.RowOrColumn=RowOrColumn,function(t){t.getElementDimensionSize=function(t,e){return"width"===e?utils_1.getElementWidth(t):utils_1.getElementHeight(t)},t.setElementDimensionSize=function(t,e,i){return"width"===e?utils_1.setElementWidth(t,i):utils_1.setElementHeight(t,i)},t.createElement=function(t,e){const i=t.createElement("div");return i.classList.add("lm_item"),e?i.classList.add("lm_column"):i.classList.add("lm_row"),i}}(RowOrColumn=exports.RowOrColumn||(exports.RowOrColumn={}));