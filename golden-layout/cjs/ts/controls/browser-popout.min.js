"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BrowserPopout=void 0;const resolved_config_1=require("../config/resolved-config"),external_error_1=require("../errors/external-error"),internal_error_1=require("../errors/internal-error"),event_emitter_1=require("../utils/event-emitter"),utils_1=require("../utils/utils");class BrowserPopout extends event_emitter_1.EventEmitter{constructor(t,e,i){super(),this._config=t,this._initialWindowSize=e,this._layoutManager=i,this._isInitialised=!1,this._popoutWindow=null,this.createWindow()}toConfig(){var t,e;if(!1===this._isInitialised)throw new Error("Can't create config, layout not yet initialised");const i=this.getGlInstance().saveLayout();let o,n;null===this._popoutWindow?(o=null,n=null):(o=null!==(t=this._popoutWindow.screenX)&&void 0!==t?t:this._popoutWindow.screenLeft,n=null!==(e=this._popoutWindow.screenY)&&void 0!==e?e:this._popoutWindow.screenTop);const r={width:this.getGlInstance().width,height:this.getGlInstance().height,left:o,top:n};return{root:i.root,openPopouts:i.openPopouts,settings:i.settings,dimensions:i.dimensions,header:i.header,window:r,parentId:this._config.parentId,indexInParent:this._config.indexInParent,resolved:!0}}getGlInstance(){if(null===this._popoutWindow)throw new internal_error_1.UnexpectedNullError("BPGGI24693");return this._popoutWindow.__glInstance}getWindow(){if(null===this._popoutWindow)throw new internal_error_1.UnexpectedNullError("BPGW087215");return this._popoutWindow}close(){if(this.getGlInstance())this.getGlInstance().closeWindow();else try{this.getWindow().close()}catch(t){}}popIn(){let t,e=this._config.indexInParent;if(this._config.parentId){const i=this.getGlInstance().saveLayout(),o=utils_1.deepExtend({},i).root;if(void 0===o)throw new internal_error_1.UnexpectedUndefinedError("BPPIR19998");{const i=this._layoutManager.groundItem;if(void 0===i)throw new internal_error_1.UnexpectedUndefinedError("BPPIG34972");{(t=i.getItemsByPopInParentId(this._config.parentId)[0])||(t=i.contentItems.length>0?i.contentItems[0]:i,e=0);const n=this._layoutManager.createAndInitContentItem(o,t);t.addChild(n,e),this.close()}}}}createWindow(){const t=this.createUrl(),e=Math.floor(1e6*Math.random()).toString(36),i=this.serializeWindowFeatures({width:this._initialWindowSize.width,height:this._initialWindowSize.height,innerWidth:this._initialWindowSize.width,innerHeight:this._initialWindowSize.height,menubar:"no",toolbar:"no",location:"no",personalbar:"no",resizable:"yes",scrollbars:"no",status:"no"});if(this._popoutWindow=globalThis.open(t,e,i),this._popoutWindow)this._popoutWindow.addEventListener("load",()=>this.positionWindow(),{passive:!0}),this._popoutWindow.addEventListener("beforeunload",()=>this._onClose(),{passive:!0}),this._checkReadyInterval=setInterval(()=>this.checkReady(),10);else if(!0===this._layoutManager.layoutConfig.settings.blockedPopoutsThrowError){throw new external_error_1.PopoutBlockedError("Popout blocked")}}checkReady(){if(null===this._popoutWindow)throw new internal_error_1.UnexpectedNullError("BPCR01844");this._popoutWindow.__glInstance&&this._popoutWindow.__glInstance.isInitialised&&(this.onInitialised(),void 0!==this._checkReadyInterval&&(clearInterval(this._checkReadyInterval),this._checkReadyInterval=void 0))}serializeWindowFeatures(t){const e=[];for(const i in t)e.push(i+"="+t[i].toString());return e.join(",")}createUrl(){const t="gl-window-config-"+utils_1.getUniqueId(),e=resolved_config_1.ResolvedLayoutConfig.minifyConfig(this._config);try{localStorage.setItem(t,JSON.stringify(e))}catch(t){throw new Error("Error while writing to localStorage "+t.toString())}const i=document.location.href.split("?");return 1===i.length?i[0]+"?gl-window="+t:document.location.href+"&gl-window="+t}positionWindow(){if(null===this._popoutWindow)throw new Error("BrowserPopout.positionWindow: null popoutWindow");this._popoutWindow.moveTo(this._initialWindowSize.left,this._initialWindowSize.top),this._popoutWindow.focus()}onInitialised(){this._isInitialised=!0,this.getGlInstance().on("popIn",()=>this.popIn()),this.emit("initialised")}_onClose(){setTimeout(()=>this.emit("closed"),50)}}exports.BrowserPopout=BrowserPopout;