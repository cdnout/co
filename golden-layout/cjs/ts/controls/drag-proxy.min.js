"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DragProxy=void 0;const internal_error_1=require("../errors/internal-error"),stack_1=require("../items/stack"),event_emitter_1=require("../utils/event-emitter"),jquery_legacy_1=require("../utils/jquery-legacy"),types_1=require("../utils/types"),utils_1=require("../utils/utils");class DragProxy extends event_emitter_1.EventEmitter{constructor(t,e,i,n,s,o){super(),this._dragListener=i,this._layoutManager=n,this._componentItem=s,this._originalParent=o,this._area=null,this._lastValidArea=null,this._dragListener.on("drag",(t,e,i)=>this.onDrag(t,e,i)),this._dragListener.on("dragStop",()=>this.onDrop()),this._element=document.createElement("div"),this._element.classList.add("lm_dragProxy");const r=document.createElement("div");r.classList.add("lm_header");const a=document.createElement("div");a.classList.add("lm_tabs");const l=document.createElement("div");l.classList.add("lm_tab");const h=document.createElement("span");if(h.classList.add("lm_title"),l.appendChild(h),a.appendChild(l),r.appendChild(a),this._proxyContainerElement=document.createElement("div"),this._proxyContainerElement.classList.add("lm_content"),this._element.appendChild(r),this._element.appendChild(this._proxyContainerElement),this._originalParent instanceof stack_1.Stack&&this._originalParent.headerShow&&(this._sided=this._originalParent.headerLeftRightSided,this._element.classList.add("lm_"+this._originalParent.headerSide),[types_1.Side.right,types_1.Side.bottom].indexOf(this._originalParent.headerSide)>=0&&this._proxyContainerElement.insertAdjacentElement("afterend",r)),this._element.style.left=utils_1.numberToPixels(t),this._element.style.top=utils_1.numberToPixels(e),l.setAttribute("title",utils_1.stripTags(this._componentItem.title)),h.insertAdjacentText("afterbegin",this._componentItem.title),this._proxyContainerElement.appendChild(this._componentItem.element),null===this._componentItem.parent)throw new internal_error_1.UnexpectedNullError("DPC10097");{this._componentItemFocused=this._componentItem.focused,this._componentItemFocused&&this._componentItem.blur(),this._componentItem.parent.removeChild(this._componentItem,!0),this._layoutManager.calculateItemAreas(),this.setDimensions(),document.body.appendChild(this._element);const i=jquery_legacy_1.getJQueryOffset(this._layoutManager.container);this._minX=i.left,this._minY=i.top;const{width:n,height:s}=utils_1.getElementWidthAndHeight(this._layoutManager.container);this._maxX=n+this._minX,this._maxY=s+this._minY;const{width:o,height:r}=utils_1.getElementWidthAndHeight(this._element);this._width=o,this._height=r,this._layoutManager.layoutConfig.settings.constrainDragToContainer&&(t<=this._minX?t=Math.ceil(this._minX+1):t>=this._maxX&&(t=Math.floor(this._maxX-1)),e<=this._minY?e=Math.ceil(this._minY+1):e>=this._maxY&&(e=Math.floor(this._maxY-1))),this.setDropPosition(t,e)}}get element(){return this._element}onDrag(t,e,i){const n=i.pageX,s=i.pageY;if(this._layoutManager.layoutConfig.settings.constrainDragToContainer){n>this._minX&&n<this._maxX&&s>this._minY&&s<this._maxY&&this.setDropPosition(n,s)}else this.setDropPosition(n,s)}setDropPosition(t,e){this._element.style.left=utils_1.numberToPixels(t),this._element.style.top=utils_1.numberToPixels(e),this._area=this._layoutManager.getArea(t,e),null!==this._area&&(this._lastValidArea=this._area,this._area.contentItem.highlightDropZone(t,e,this._area))}onDrop(){const t=this._layoutManager.dropTargetIndicator;if(null===t)throw new internal_error_1.UnexpectedNullError("DPOD30011");let e;if(t.hide(),null!==this._area)e=this._componentItem,this._area.contentItem.onDrop(e,this._area);else if(null!==this._lastValidArea){e=this._componentItem,this._lastValidArea.contentItem.onDrop(e,this._lastValidArea)}else this._originalParent?(e=this._componentItem,this._originalParent.addChild(e)):this._componentItem.destroy();this._element.remove(),this._layoutManager.emit("itemDropped",this._componentItem),this._componentItemFocused&&void 0!==e&&e.focus()}setDimensions(){const t=this._layoutManager.layoutConfig.dimensions;if(void 0===t)throw new Error("DragProxy.setDimensions: dimensions undefined");{let e=t.dragProxyWidth,i=t.dragProxyHeight;if(void 0===e||void 0===i)throw new Error("DragProxy.setDimensions: width and/or height undefined");{const n=!1===this._layoutManager.layoutConfig.header.show?0:t.headerHeight;this._element.style.width=utils_1.numberToPixels(e),this._element.style.height=utils_1.numberToPixels(i),e-=this._sided?n:0,i-=this._sided?0:n,this._proxyContainerElement.style.width=utils_1.numberToPixels(e),this._proxyContainerElement.style.height=utils_1.numberToPixels(i),this._componentItem.setDragSize(e,i),this._componentItem.show()}}}}exports.DragProxy=DragProxy;