"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DragListener=void 0;const event_emitter_1=require("./event-emitter");class DragListener extends event_emitter_1.EventEmitter{constructor(e,t){super(),this._eElement=e,this._mouseTouchTracking=!1,this._mouseDownEventListener=(e=>this.onMouseDown(e)),this._mouseMoveEventListener=(e=>this.onMouseMove(e)),this._mouseUpEventListener=(e=>this.onMouseUp(e)),this._touchStartEventListener=(e=>this.onTouchStart(e)),this._touchMoveEventListener=(e=>this.onTouchMove(e)),this._touchEndEventListener=(e=>this.onTouchEnd(e)),this._timeout=void 0,this._allowableTargets=[e,...t],this._oDocument=document,this._eBody=document.body,this._nDelay=1800,this._nDistance=10,this._nX=0,this._nY=0,this._nOriginalX=0,this._nOriginalY=0,this._dragging=!1,this._eElement.addEventListener("mousedown",this._mouseDownEventListener,{passive:!0}),this._eElement.addEventListener("touchstart",this._touchStartEventListener,{passive:!0})}destroy(){this.checkRemoveMouseTouchTrackingEventListeners(),this._eElement.removeEventListener("mousedown",this._mouseDownEventListener),this._eElement.removeEventListener("touchstart",this._touchStartEventListener)}cancelDrag(){const e={mouseEvent:void 0,touchEvent:void 0,pageX:-1,pageY:-1};this.processDragStop(e)}onMouseDown(e){if(this._allowableTargets.includes(e.target)&&0===e.button){const t=this.getMouseCoordinates(e);this.processMouseDownTouchStart(t)}}onTouchStart(e){if(this._allowableTargets.includes(e.target)){const t=this.getTouchCoordinates(e);void 0!==t&&this.processMouseDownTouchStart(t)}}processMouseDownTouchStart(e){this._nOriginalX=e.x,this._nOriginalY=e.y,this._oDocument.addEventListener("mousemove",this._mouseMoveEventListener),this._oDocument.addEventListener("touchmove",this._touchMoveEventListener,{passive:!0}),this._oDocument.addEventListener("mouseup",this._mouseUpEventListener,{passive:!0}),this._oDocument.addEventListener("touchend",this._touchEndEventListener,{passive:!0}),this._mouseTouchTracking=!0,this._timeout=setTimeout(()=>this.startDrag(),this._nDelay)}onMouseMove(e){if(this._mouseTouchTracking){e.preventDefault();const t=this.getMouseCoordinates(e),s={mouseEvent:e,touchEvent:void 0,pageX:t.x,pageY:t.y};this.processDragMove(s)}}onTouchMove(e){if(this._mouseTouchTracking){const t=this.getTouchCoordinates(e);if(void 0!==t){const s={mouseEvent:void 0,touchEvent:e,pageX:t.x,pageY:t.y};this.processDragMove(s)}}}processDragMove(e){this._nX=e.pageX-this._nOriginalX,this._nY=e.pageY-this._nOriginalY,!1===this._dragging&&(Math.abs(this._nX)>this._nDistance||Math.abs(this._nY)>this._nDistance)&&this.startDrag(),this._dragging&&this.emit("drag",this._nX,this._nY,e)}onMouseUp(e){const t=this.getMouseCoordinates(e),s={mouseEvent:e,touchEvent:void 0,pageX:t.x,pageY:t.y};this.processDragStop(s)}onTouchEnd(e){let t=this.getTouchCoordinates(e);void 0===t&&(t={x:this._nOriginalX,y:this._nOriginalY});const s={mouseEvent:void 0,touchEvent:e,pageX:t.x,pageY:t.y};this.processDragStop(s)}processDragStop(e){var t;void 0!==this._timeout&&(clearTimeout(this._timeout),this._timeout=void 0),this.checkRemoveMouseTouchTrackingEventListeners(),!0===this._dragging&&(this._eBody.classList.remove("lm_dragging"),this._eElement.classList.remove("lm_dragging"),null===(t=this._oDocument.querySelector("iframe"))||void 0===t||t.style.setProperty("pointer-events",""),this._dragging=!1,this.emit("dragStop",e))}checkRemoveMouseTouchTrackingEventListeners(){this._mouseTouchTracking&&(this._oDocument.removeEventListener("mousemove",this._mouseMoveEventListener),this._oDocument.removeEventListener("touchmove",this._touchMoveEventListener),this._oDocument.removeEventListener("mouseup",this._mouseUpEventListener),this._oDocument.removeEventListener("touchend",this._touchEndEventListener),this._mouseTouchTracking=!1)}startDrag(){var e;void 0!==this._timeout&&(clearTimeout(this._timeout),this._timeout=void 0),this._dragging=!0,this._eBody.classList.add("lm_dragging"),this._eElement.classList.add("lm_dragging"),null===(e=this._oDocument.querySelector("iframe"))||void 0===e||e.style.setProperty("pointer-events","none"),this.emit("dragStart",this._nOriginalX,this._nOriginalY)}getMouseCoordinates(e){return{x:e.pageX,y:e.pageY}}getTouchCoordinates(e){if(0!==e.targetTouches.length){const t=e.targetTouches[0];return{x:t.pageX,y:t.pageY}}}}exports.DragListener=DragListener;