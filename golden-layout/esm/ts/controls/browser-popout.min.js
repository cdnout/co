import{ResolvedLayoutConfig}from"../config/resolved-config";import{PopoutBlockedError}from"../errors/external-error";import{UnexpectedNullError,UnexpectedUndefinedError}from"../errors/internal-error";import{EventEmitter}from"../utils/event-emitter";import{deepExtend,getUniqueId}from"../utils/utils";export class BrowserPopout extends EventEmitter{constructor(t,i,o){super(),this._config=t,this._initialWindowSize=i,this._layoutManager=o,this._isInitialised=!1,this._popoutWindow=null,this.createWindow()}toConfig(){var t,i;if(!1===this._isInitialised)throw new Error("Can't create config, layout not yet initialised");const o=this.getGlInstance().saveLayout();let e,n;null===this._popoutWindow?(e=null,n=null):(e=null!==(t=this._popoutWindow.screenX)&&void 0!==t?t:this._popoutWindow.screenLeft,n=null!==(i=this._popoutWindow.screenY)&&void 0!==i?i:this._popoutWindow.screenTop);const s={width:this.getGlInstance().width,height:this.getGlInstance().height,left:e,top:n};return{root:o.root,openPopouts:o.openPopouts,settings:o.settings,dimensions:o.dimensions,header:o.header,window:s,parentId:this._config.parentId,indexInParent:this._config.indexInParent,resolved:!0}}getGlInstance(){if(null===this._popoutWindow)throw new UnexpectedNullError("BPGGI24693");return this._popoutWindow.__glInstance}getWindow(){if(null===this._popoutWindow)throw new UnexpectedNullError("BPGW087215");return this._popoutWindow}close(){if(this.getGlInstance())this.getGlInstance().closeWindow();else try{this.getWindow().close()}catch(t){}}popIn(){let t,i=this._config.indexInParent;if(this._config.parentId){const o=this.getGlInstance().saveLayout(),e=deepExtend({},o).root;if(void 0===e)throw new UnexpectedUndefinedError("BPPIR19998");{const o=this._layoutManager.groundItem;if(void 0===o)throw new UnexpectedUndefinedError("BPPIG34972");{(t=o.getItemsByPopInParentId(this._config.parentId)[0])||(t=o.contentItems.length>0?o.contentItems[0]:o,i=0);const n=this._layoutManager.createAndInitContentItem(e,t);t.addChild(n,i),this.close()}}}}createWindow(){const t=this.createUrl(),i=Math.floor(1e6*Math.random()).toString(36),o=this.serializeWindowFeatures({width:this._initialWindowSize.width,height:this._initialWindowSize.height,innerWidth:this._initialWindowSize.width,innerHeight:this._initialWindowSize.height,menubar:"no",toolbar:"no",location:"no",personalbar:"no",resizable:"yes",scrollbars:"no",status:"no"});if(this._popoutWindow=globalThis.open(t,i,o),this._popoutWindow)this._popoutWindow.addEventListener("load",()=>this.positionWindow(),{passive:!0}),this._popoutWindow.addEventListener("beforeunload",()=>this._onClose(),{passive:!0}),this._checkReadyInterval=setInterval(()=>this.checkReady(),10);else if(!0===this._layoutManager.layoutConfig.settings.blockedPopoutsThrowError){throw new PopoutBlockedError("Popout blocked")}}checkReady(){if(null===this._popoutWindow)throw new UnexpectedNullError("BPCR01844");this._popoutWindow.__glInstance&&this._popoutWindow.__glInstance.isInitialised&&(this.onInitialised(),void 0!==this._checkReadyInterval&&(clearInterval(this._checkReadyInterval),this._checkReadyInterval=void 0))}serializeWindowFeatures(t){const i=[];for(const o in t)i.push(o+"="+t[o].toString());return i.join(",")}createUrl(){const t="gl-window-config-"+getUniqueId(),i=ResolvedLayoutConfig.minifyConfig(this._config);try{localStorage.setItem(t,JSON.stringify(i))}catch(t){throw new Error("Error while writing to localStorage "+t.toString())}const o=document.location.href.split("?");return 1===o.length?o[0]+"?gl-window="+t:document.location.href+"&gl-window="+t}positionWindow(){if(null===this._popoutWindow)throw new Error("BrowserPopout.positionWindow: null popoutWindow");this._popoutWindow.moveTo(this._initialWindowSize.left,this._initialWindowSize.top),this._popoutWindow.focus()}onInitialised(){this._isInitialised=!0,this.getGlInstance().on("popIn",()=>this.popIn()),this.emit("initialised")}_onClose(){setTimeout(()=>this.emit("closed"),50)}};