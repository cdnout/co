import{UnexpectedNullError}from"../errors/internal-error";import{Stack}from"../items/stack";import{EventEmitter}from"../utils/event-emitter";import{getJQueryOffset}from"../utils/jquery-legacy";import{Side}from"../utils/types";import{getElementWidthAndHeight,numberToPixels,stripTags}from"../utils/utils";export class DragProxy extends EventEmitter{constructor(t,e,i,n,s,o){super(),this._dragListener=i,this._layoutManager=n,this._componentItem=s,this._originalParent=o,this._area=null,this._lastValidArea=null,this._dragListener.on("drag",(t,e,i)=>this.onDrag(t,e,i)),this._dragListener.on("dragStop",()=>this.onDrop()),this._element=document.createElement("div"),this._element.classList.add("lm_dragProxy");const r=document.createElement("div");r.classList.add("lm_header");const a=document.createElement("div");a.classList.add("lm_tabs");const h=document.createElement("div");h.classList.add("lm_tab");const l=document.createElement("span");if(l.classList.add("lm_title"),h.appendChild(l),a.appendChild(h),r.appendChild(a),this._proxyContainerElement=document.createElement("div"),this._proxyContainerElement.classList.add("lm_content"),this._element.appendChild(r),this._element.appendChild(this._proxyContainerElement),this._originalParent instanceof Stack&&this._originalParent.headerShow&&(this._sided=this._originalParent.headerLeftRightSided,this._element.classList.add("lm_"+this._originalParent.headerSide),[Side.right,Side.bottom].indexOf(this._originalParent.headerSide)>=0&&this._proxyContainerElement.insertAdjacentElement("afterend",r)),this._element.style.left=numberToPixels(t),this._element.style.top=numberToPixels(e),h.setAttribute("title",stripTags(this._componentItem.title)),l.insertAdjacentText("afterbegin",this._componentItem.title),this._proxyContainerElement.appendChild(this._componentItem.element),null===this._componentItem.parent)throw new UnexpectedNullError("DPC10097");{this._componentItemFocused=this._componentItem.focused,this._componentItemFocused&&this._componentItem.blur(),this._componentItem.parent.removeChild(this._componentItem,!0),this._layoutManager.calculateItemAreas(),this.setDimensions(),document.body.appendChild(this._element);const i=getJQueryOffset(this._layoutManager.container);this._minX=i.left,this._minY=i.top;const{width:n,height:s}=getElementWidthAndHeight(this._layoutManager.container);this._maxX=n+this._minX,this._maxY=s+this._minY;const{width:o,height:r}=getElementWidthAndHeight(this._element);this._width=o,this._height=r,this._layoutManager.layoutConfig.settings.constrainDragToContainer&&(t<=this._minX?t=Math.ceil(this._minX+1):t>=this._maxX&&(t=Math.floor(this._maxX-1)),e<=this._minY?e=Math.ceil(this._minY+1):e>=this._maxY&&(e=Math.floor(this._maxY-1))),this.setDropPosition(t,e)}}get element(){return this._element}onDrag(t,e,i){const n=i.pageX,s=i.pageY;if(this._layoutManager.layoutConfig.settings.constrainDragToContainer){n>this._minX&&n<this._maxX&&s>this._minY&&s<this._maxY&&this.setDropPosition(n,s)}else this.setDropPosition(n,s)}setDropPosition(t,e){this._element.style.left=numberToPixels(t),this._element.style.top=numberToPixels(e),this._area=this._layoutManager.getArea(t,e),null!==this._area&&(this._lastValidArea=this._area,this._area.contentItem.highlightDropZone(t,e,this._area))}onDrop(){const t=this._layoutManager.dropTargetIndicator;if(null===t)throw new UnexpectedNullError("DPOD30011");let e;if(t.hide(),null!==this._area)e=this._componentItem,this._area.contentItem.onDrop(e,this._area);else if(null!==this._lastValidArea){e=this._componentItem,this._lastValidArea.contentItem.onDrop(e,this._lastValidArea)}else this._originalParent?(e=this._componentItem,this._originalParent.addChild(e)):this._componentItem.destroy();this._element.remove(),this._layoutManager.emit("itemDropped",this._componentItem),this._componentItemFocused&&void 0!==e&&e.focus()}setDimensions(){const t=this._layoutManager.layoutConfig.dimensions;if(void 0===t)throw new Error("DragProxy.setDimensions: dimensions undefined");{let e=t.dragProxyWidth,i=t.dragProxyHeight;if(void 0===e||void 0===i)throw new Error("DragProxy.setDimensions: width and/or height undefined");{const n=!1===this._layoutManager.layoutConfig.header.show?0:t.headerHeight;this._element.style.width=numberToPixels(e),this._element.style.height=numberToPixels(i),e-=this._sided?n:0,i-=this._sided?0:n,this._proxyContainerElement.style.width=numberToPixels(e),this._proxyContainerElement.style.height=numberToPixels(i),this._componentItem.setDragSize(e,i),this._componentItem.show()}}}};