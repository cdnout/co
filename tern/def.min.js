!function(e){"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):tern.def={init:e}}(function(e,P){"use strict";function f(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var h=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};function O(e,t,r){return e.call?e(t,r):e}function a(e,t){if("!ret"!=t)return e.getProp(t);if(e.retval)return e.retval;var r=new P.AVal;return e.propagate(new P.IsCallee(P.ANull,[],null,r)),r}function i(e){if(e instanceof P.Fn&&e.args)for(var t=0;t<e.args.length;++t){var r=e.args[t];r instanceof P.Fn&&r.args&&r.args.length&&n(e,t)}}function n(r,n){g(r,function(e,t){t[n]&&t[n].propagate(new P.IsCallee(P.cx().topScope,r.args[n].args,null,P.ANull))})}function c(e,t,r,n){var a=new h(e,null,r,n).parseType(!1,t,!0);return a instanceof P.AVal?a.types.forEach(i):i(a),a}function g(e,i,o){var s=e.computeRet,p=e.retval;e.computeRet=function(e,t,r){var n=i(e,t,r),a=s?s(e,t,r):p;return o?n:a}}h.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){var t,r="";for(e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,t,r,n){var a,i,o,s,p,l,u,f,c=[],h=[],g=!1;if(!this.eat(")"))for(;;0){var v,y=this.spec.indexOf(": ",this.pos);-1!=y&&(v=this.spec.slice(this.pos,y),/^(\.\.\.)?[$\w?]+$/.test(v)?this.pos=y+2:v=null),h.push(v);var d=this.parseType(e);if(d.call&&(g=!0),c.push(d),!this.eat(", ")){this.eat(")")||this.error();break}}if(this.eat(" -> ")){var w=this.pos;(a=this.parseType(!0)).call&&!g&&(i=a,a=P.ANull,o=w)}else a=P.ANull;return g?(p=t,l=c,u=a,f=n,function(e,t){for(var r=[],n=0;n<l.length;n++)r.push(O(l[n],e,t));return new P.Fn(p,P.ANull,r,O(u,e,t),f)}):(r&&(s=this.base)?P.Fn.call(this.base,t,P.ANull,c,h,a,n):s=new P.Fn(t,P.ANull,c,h,a,n),i&&(s.computeRet=i),null!=o&&(s.computeRetSource=this.spec.slice(o,this.pos)),s)},parseType:function(e,t,r){var n=this.parseTypeMaybeProp(e,t,r);if(!this.eat("|"))return n;for(var a,i=[n],o=n.call;;){var s=this.parseTypeMaybeProp(e,t,r);if(i.push(s),s.call&&(o=!0),!this.eat("|"))break}if(o)return a=i,function(e,t){for(var r=new P.AVal,n=0;n<a.length;n++)O(a[n],e,t).propagate(r);return r.maxWeight=1e5,r};for(var p=new P.AVal,l=0;l<i.length;l++)i[l].propagate(p);return p.maxWeight=1e5,p},parseTypeMaybeProp:function(e,t,r){for(var n=this.parseTypeInner(e,t,r);e&&this.eat(".");)n=this.extendWithProp(n);return n},extendWithProp:function(r){var n=this.word(/[\w<>$!:]/)||this.error();return r.apply?function(e,t){return a(r(e,t),n)}:a(r,n)},parseTypeInner:function(e,t,r){var n,i,o,a,s;if(this.eat("fn(")||(n=this.eat("fn*(")))return this.parseFnType(e,t,r,n);if(this.eat("[")){for(var p=this.parseType(e),l=p.call;this.eat(", ");){f=f||[p];var u=this.parseType(e);f.push(u),l=l||u.call}return this.eat("]")||this.error(),l?f?(s=f,function(t,r){return new P.Arr(s.map(function(e){return O(e,t,r)}))}):(a=p,function(e,t){return new P.Arr(a(e,t))}):r&&this.base?(P.Arr.call(this.base,f||p),this.base):new P.Arr(f||p)}if(this.eat("{")){var f=[],c=[];l=!1;if(!this.eat("}"))for(;;0){var h,g=this.spec.indexOf(": ",this.pos);-1!=g&&(h=this.spec.slice(this.pos,g),/^[$\w?]+$/.test(h)?this.pos=g+2:h=null);var v=this.parseType(e);if(v.call&&(l=!0),c.push(h),f.push(v),!this.eat(", ")){this.eat("}")||this.error();break}}if(l)return i=c,o=f,function(r,n){var a=new P.Obj;return i.forEach(function(e,t){a.defProp(e).addType(O(o[t],r,n))}),a};var y=new P.Obj;return c.forEach(function(e,t){y.defProp(e).addType(f[t])}),y}if(this.eat("+")){var d=this.word(/[\w$<>\.:!]/);if(!(w=P.cx().localDefs[d+".prototype"])){var w;if(!((w=T(d))instanceof P.Obj))return w;var A=N(w,["prototype"]);(A=A&&A.getObjType())&&(w=A)}return e&&this.eat("[")?this.parsePoly(w):r&&this.base?((t=(this.base.proto=w).hasCtor&&w.hasCtor.name||w.name)&&(this.base.name=t),this.base):r&&this.forceNew?new P.Obj(w):P.getInstance(w)}if(this.eat(":")){t=this.word(/[\w$\.]/);return P.getSymbol(t)}if(e&&this.eat("!")){var b=this.word(/\d/);if(b)return b=Number(b),function(e,t){return t[b]||P.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var m=this.word(/[\w$]/);return j[m]||function(){return P.ANull}}return this.fromWord("!"+this.word(/[\w$<>\.!:]/))}return this.eat("?")?P.ANull:this.fromWord(this.word(/[\w$<>\.!:`]/))},fromWord:function(e){var t=P.cx();switch(e){case"number":return t.num;case"string":return t.str;case"bool":return t.bool;case"<top>":return t.topScope}return t.localDefs&&e in t.localDefs?t.localDefs[e]:T(e)},parsePoly:function(n){var e,a="<i>";(e=this.spec.slice(this.pos).match(/^\s*([\w$:]+)\s*=\s*/))&&(a=e[1],this.pos+=e[0].length);var i=this.parseType(!0);if(this.eat("]")||this.error(),i.call)return function(e,t){var r=new P.Obj(n);return i(e,t).propagate(r.defProp(a)),r};var t=new P.Obj(n);return i.propagate(t.defProp(a)),t}};var p,v=e.parseEffect=function(e,t){var r;if(0==e.indexOf("propagate ")){var n=(o=new h(e,10)).parseType(!0);o.eat(" ")||o.error();var a=o.parseType(!0);g(t,function(e,t){O(n,e,t).propagate(O(a,e,t))})}else if(0==e.indexOf("call ")){var s=5==e.indexOf("and return ",5),p=(o=new h(e,s?16:5)).parseType(!0),l=null,u=[];for(o.eat(" this=")&&(l=o.parseType(!0));o.eat(" ");)u.push(o.parseType(!0));g(t,function(e,t){for(var r=O(p,e,t),n=l?O(l,e,t):P.ANull,a=[],i=0;i<u.length;++i)a.push(O(u[i],e,t));var o=s?new P.AVal:P.ANull;return r.propagate(new P.IsCallee(n,a,null,o)),o},s)}else if(r=e.match(/^custom (\S+)\s*(.*)/)){var i=j[r[1]];i&&g(t,r[2]?i(r[2]):i)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var o,f=(o=new h(e,5)).parseType(!0);o.eat(" ");var c=o.parseType(!0);g(t,function(e,t){var r=O(f,e,t),n=O(c,e,t);r.forAllProps(function(e,t,r){r&&"<i>"!=e&&n.propagate(new P.DefProp(e,t))})})}},T=e.parsePath=function(e,t){var r=P.cx(),n=r.paths[e],a=e;if(null!=n)return n;r.paths[e]=P.ANull;var i=t||p||r.topScope;if(r.localDefs)for(var o in r.localDefs)if(0==e.indexOf(o)){if(e==o)return r.paths[e]=r.localDefs[e];if("."==e.charAt(o.length)){i=r.localDefs[o],e=e.slice(o.length+1);break}}var s=N(i,e.split("."));return r.paths[a]=s==P.ANull?null:s,s};function N(e,t){for(var r=0;r<t.length&&e!=P.ANull;++r){var n=t[r];if("!"==n.charAt(0))if("!proto"==n)e=e instanceof P.Obj&&e.proto||P.ANull;else{var a=e.getFunctionType();if(a)if("!ret"==n)e=a.retval&&a.retval.getType(!1)||P.ANull;else{var i=a.args&&a.args[Number(n.slice(1))];e=i&&i.getType(!1)||P.ANull}else e=P.ANull}else if(e instanceof P.Obj&&("prototype"==n&&e instanceof P.Fn||e.hasProp(n))){var o=e.getProp(n);e=!o||o.isEmpty()?P.ANull:o.types[0]}else e=P.ANull}return e}function s(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function y(e){if(e["!type"]&&!/^(fn\(|\[|\+)/.test(e["!type"])){for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return;return 1}}function l(e,t,r){if(!e){var n=t["!type"];if(n)if(/^fn\(/.test(n))e=s(P.Fn);else if("["==n.charAt(0))e=s(P.Arr);else{if("+"!=n.charAt(0))throw new Error("Invalid !type spec: "+n);e=s(P.Obj)}else e=t["!stdProto"]?P.cx().protos[t["!stdProto"]]:s(P.Obj);e.name=r}for(var a in t)if(f(t,a)&&33!=a.charCodeAt(0)){var i=t[a];if("string"==typeof i||y(i))continue;var o=e.defProp(a);l(o.getObjType(),i,r?r+"."+a:a).propagate(o)}return e}function d(e,t,r){if(e.isShell){delete e.isShell;var n=t["!type"];if(n)c(n,r,e);else{var a=t["!proto"]&&c(t["!proto"]);P.Obj.call(e,!(a instanceof P.Obj)||a,r)}}var i=t["!effects"];if(i&&e instanceof P.Fn)for(var o=0;o<i.length;++o)v(i[o],e);for(var s in!function(e,t){e["!doc"]&&(t.doc=e["!doc"]);e["!url"]&&(t.url=e["!url"]);e["!span"]&&(t.span=e["!span"]);e["!data"]&&(t.metaData=e["!data"])}(t,e),t)if(f(t,s)&&33!=s.charCodeAt(0)){var p=t[s],l=e.defProp(s),u=r?r+"."+s:s;if("string"==typeof p)l.isEmpty()&&c(p,u).propagate(l);else{if(y(p)){if(!l.isEmpty())continue;c(p["!type"],u,null,!0).propagate(l)}else d(l.getObjType(),p,u);p["!doc"]&&(l.doc=p["!doc"]),p["!url"]&&(l.url=p["!url"]),p["!span"]&&(l.span=p["!span"])}}return e}e.load=function(e,t){t=t||P.cx().topScope;var r=p;p=t;try{!function(e,t){var r=P.cx(),n=r.parent;P.addOrigin(r.curOrigin=e["!name"]||"env#"+r.origins.length),r.localDefs=r.definitions[r.curOrigin]=Object.create(null),n&&n.signal("preLoadDef",e),l(t,e);var a=e["!define"];if(a){for(var i in a){var o=a[i];r.localDefs[i]="string"==typeof o?T(o):l(null,o,i)}for(var i in a){"string"!=typeof(o=a[i])&&d(r.localDefs[i],a[i],i)}}d(t,e),n&&n.signal("postLoadDef",e),r.curOrigin=r.localDefs=null}(e,t)}finally{p=r}},e.parse=function(e,t,r){var n=P.cx();t&&(n.origin=t,n.localDefs=n.definitions[t]);try{return"string"==typeof e?c(e,r):d(l(null,e,r),e,r)}finally{t&&(n.origin=n.localDefs=null)}};var j=Object.create(null);P.registerFunction=function(e,t){j[e]=t};var o=P.constraint({construct:function(e,t,r){this.created=e,this.target=t,this.spec=r},addType:function(e){if(e instanceof P.Obj&&this.created++<5){var t=new P.Obj(e),r=this.spec;if(r instanceof P.AVal&&(r=r.getObjType(!1)),r instanceof P.Obj)for(var n in r.props){var a=r.props[n].types[0],i=t.defProp(n);if(a&&a instanceof P.Obj&&a.props.value){var o=a.props.value.getType(!1);o&&i.addType(o)}}this.target.addType(t)}}});P.registerFunction("Object_create",function(e,t,r){if(r&&r.length&&"Literal"==r[0].type&&null==r[0].value)return new P.Obj;var n=new P.AVal;return t[0]&&t[0].propagate(new o(0,n,t[1])),n});var u=P.constraint({construct:function(e){this.target=e},addType:function(e){e instanceof P.Obj&&(e.hasProp("value")?e.getProp("value").propagate(this.target):e.hasProp("get")&&e.getProp("get").propagate(new P.IsCallee(P.ANull,[],null,this.target)))}});P.registerFunction("Object_defineProperty",function(e,t,r){if(r&&3<=r.length&&"Literal"==r[1].type&&"string"==typeof r[1].value){var n=t[0],a=new P.AVal;n.propagate(new P.DefProp(r[1].value,a,r[1])),t[2].propagate(new u(a))}return P.ANull}),P.registerFunction("Object_defineProperties",function(e,t,a){if(2<=t.length){var i=t[0];t[1].forAllProps(function(e,t,r){if(r){var n=new P.AVal;i.propagate(new P.DefProp(e,n,a&&a[1])),t.propagate(new u(n))}})}return P.ANull});var w=P.constraint({construct:function(e,t,r){this.self=e,this.args=t,this.target=r},addType:function(e){if(e instanceof P.Fn){this.target.addType(new P.Fn(e.name,P.ANull,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval,e.generator)),this.self.propagate(e.self);for(var t=0;t<Math.min(e.args.length,this.args.length);++t)this.args[t].propagate(e.args[t])}}});function A(){var e=P.cx().definitions.ecmascript;return e&&new P.Obj(e["Promise.prototype"])}P.registerFunction("Function_bind",function(e,t){if(!t.length)return P.ANull;var r=new P.AVal;return e.propagate(new w(t[0],t.slice(1),r)),r}),P.registerFunction("Array_ctor",function(e,t){var r=new P.Arr;if(1!=t.length||!t[0].hasType(P.cx().num))for(var n=r.getProp("<i>"),a=0;a<t.length;++a)t[a].propagate(n);return r}),P.registerFunction("Promise_ctor",function(e,t,r){var n=A();if(!n||t.length<1)return P.ANull;var a=n.defProp(":t",r&&r[0]),i=new P.AVal;i.propagate(a);var o=new P.Fn("execute",P.ANull,[i],["value"],P.ANull),s=P.cx().definitions.ecmascript.Promise_reject;return t[0].propagate(new P.IsCallee(P.ANull,[o,s],null,P.ANull)),n}),P.registerFunction("Promise_resolve",function(e,t,r){var n=A();if(!n)return P.ANull;if(t.length){var a=n.defProp(":t",r&&r[0]),i=new P.AVal;i.propagate(a),t[0].propagate(new b(i))}return n});var b=P.constraint({construct:function(e){this.output=e},addType:function(e){e.constructor==P.Obj&&"Promise"==e.name&&e.hasProp(":t")?e.getProp(":t").propagate(this.output):e.propagate(this.output)}});return P.registerFunction("Promise_then",function(e,t,r){var n=t.length&&t[0].getFunctionType(),a=P.cx().definitions.ecmascript;if(!n||!a)return e;var i,o=new P.Obj(a["Promise.prototype"]),s=o.defProp(":t",r&&r[0]);return n.retval.isEmpty()&&(i=e.getType())instanceof P.Obj&&i.hasProp(":t")&&i.getProp(":t").propagate(s,50),n.retval.propagate(new b(s)),o}),P.registerFunction("getOwnPropertySymbols",function(e,t){if(!t.length)return P.ANull;var n=new P.AVal;return t[0].forAllProps(function(e,t,r){r&&":"==e.charAt(0)&&n.addType(P.getSymbol(e.slice(1)))}),n}),P.registerFunction("getSymbol",function(e,t,r){return r&&r.length&&"Literal"==r[0].type&&"string"==typeof r[0].value?P.getSymbol(r[0].value):P.ANull}),e});