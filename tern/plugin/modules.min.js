!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../lib/infer"),require("../lib/tern"),require("../lib/signal"),require):"function"==typeof define&&define.amd?define(["../lib/infer","../lib/tern","../lib/signal"],e):e(tern,tern,tern.signal)}(function(d,p,e,t){"use strict";function n(e,t){this.server=e,this.options=t||{},this.modules=Object.create(null),this.nonRelative=Object.create(null),this.knownModules=Object.create(null),this.resolvers=[],this.modNameTests=[],this.importTests=[],this.completableTypes=Object.create(null)}function c(e,t){if(/^https?:|^\//.test(t))return t;var n;for(e&&!/\/$/.test(e)&&(e+="/");n=/^\.(\.)?\//.exec(t);){if(n[1]&&1<e.length){var o=e.lastIndexOf("/",e.length-2);e=-1==o?"":e.slice(0,o+1)}t=t.slice(n[0].length)}return e+t}function f(e){var t=e.lastIndexOf("/");return-1==t?"":e.slice(0,t+1)}var m,v;function a(e){return/^\.\.?\//.test(e)}function h(e,t,n){return!1===n.filter||!e||0==(n.caseInsensitive?t.toLowerCase():t).indexOf(e)}function o(e){var t=d.cx().parent.mod.modules.modules,n=e.roots["!modules"]=new d.Obj(null);for(var o in t){var r=t[o],i=r.origin||o,s=n.defProp(i.replace(/\./g,"`"));s.origin=r.origin,r.propagate(s)}}function r(e){var t=d.cx(),n=t.parent.mod.modules,o=t.definitions[e["!name"]]["!modules"];if(o)for(var r in o.props){var i=r.replace(/`/g,"."),s=n.get(i);s.origin=i,o.props[r].propagate(s)}var l=t.definitions[e["!name"]]["!known_modules"];if(l)for(var r in l.props)n.knownModules[r.replace(/`/g,".")]=l.props[r]}function i(e,t,n,o){if(!n)return o;var r=d.cx().parent.mod.modules.getModType(n.node);if(!r)return o;var i=r.getType(!1)||{};return(o=Object.create(o)).origin=r.origin||i.origin,o.originNode=r.originNode||i.originNode,r.doc?o.doc=r.doc:i.doc&&(o.doc=i.doc),r.url?o.url=r.url:i.url&&(o.url=i.url),o}function s(e,t){var n=d.cx().parent.mod.modules,o=p.resolvePos(e,t.end),r=n.completableTypes,i=d.findExpressionAround(e.ast,null,o,e.scope,function(e){return e in r});if(!i)return null;if(null!=n.isModName(i.node,o))return function(e,t,n,o,r){if("Literal"!=o.type||"string"!=typeof o.value||o.start>r||o.end<r)return;var i=o.raw.slice(1,r-o.start),s=o.raw.charAt(0);i&&i.charAt(i.length-1)==s&&(i=i.slice(0,i.length-1));n.caseInsensitive&&(i=i.toLowerCase());var l=[];a(i)?e.completeFileName(l,n,t.name,i):e.completeModuleName(l,n,i);o.end==r+1&&t.text.charAt(r)==s&&++r;return{start:p.outputPos(n,t,o.start),end:p.outputPos(n,t,r),isProperty:!1,completions:l.map(function(e){var t="string"==typeof e?e:e.name,n=JSON.stringify(t);return"'"==s&&(n=s+n.slice(1,n.length-1).replace(/'/g,"\\'")+s),"string"==typeof e?n:(e.displayName=t,e.name=n,e)})}}(n,e,t,i.node,o);var s=n.isImport(i.node,o);return s&&s.name&&null!=s.prop?function(e,t,o,n,r,i){var s=[],l=n.name?n.name.slice(0,i-n.start):"";o.caseInsensitive&&(l=l.toLowerCase());var a=e.resolveModule(r.name,n.sourceFile.name).getType();return a?(d.forAllPropertiesOf(a,function(e,t,n){t!=d.cx().protos.Object&&(!1!==o.filter&&l&&0!==(o.caseInsensitive?e.toLowerCase():e).indexOf(l)||p.addCompletion(o,s,e,t&&t.props[e],n))}),{start:p.outputPos(o,t,n.name?n.start:i),end:p.outputPos(o,t,i),completions:s,isSpecifier:!0}):null}(n,e,t,i.node,s,o):void 0}n.prototype=e.mixin({buildWrappingScope:function(e,t,n){var o=new d.Scope(e,n);return o.origin=t,this.signal("wrapScope",o),o},maybeOverride:function(e){if(!this.options.modules||!this.options.modules.hasOwnProperty(e))return!1;if(this.modules[e])return this.modules[e];var t=this.options.modules[e];if("string"==typeof t&&"="==t.charAt(0))return d.def.parsePath(t.slice(1));var n=this.buildWrappingScope(d.cx().topScope,e);return d.def.load(t,n),this.modules[e]=n.exports},resolveModule:function(e,t){var n,o=this.maybeOverride(e);if(o)return o;if(n=this.knownModules[e])return n;if(1==this.options.dontLoad||this.options.dontLoad&&new RegExp(this.options.dontLoad).test(e)||this.options.load&&!new RegExp(this.options.load).test(e))return d.ANull;for(var r,i=a(e),s=0;!r&&s<this.resolvers.length;s++)r=this.resolvers[s](e,t);return(r=r||function(e,t){if(!/^\.\.?\//.test(e))return;var n=c(f(t),e),o=d.cx().parent;if(o.findFile(n))return n;if(o.findFile(n+".js"))return n+".js"}(e,t))?"string"!=typeof r?(i||(this.nonRelative[e]=!0),r):(n=this.modules[r])?n:(/\.js$|(?:^\/)[^\.]+$/.test(r)&&this.server.addFile(r,null,t),i||(this.nonRelative[e]=r),this.modules[r]=new d.AVal):d.ANull},findIn:function(e,t,n){for(var o=0;o<e.length;o++){var r=e[o](t,n);if(null!=r)return r}},isModName:function(e,t){return this.findIn(this.modNameTests,e,t)},isImport:function(e,t){return this.findIn(this.importTests,e,t)},get:function(e){return this.modules[e]||(this.modules[e]=new d.AVal)},completeModuleName:function(o,r,i){function e(e,t){for(var n in e)h(i,n,r)&&p.addCompletion(r,o,n,t&&e[n])}e(this.knownModules,!0),this.options.modules&&e(this.options.modules,!1);var t=Object.create(null);for(var n in this.nonRelative){var s=this.nonRelative[n];if(1==s||-1==n.indexOf("/"))h(i,n,r)&&p.addCompletion(r,o,n);else if(0==n.indexOf(i)&&-1<i.indexOf("/")){var l=/.*?\/(.*)/.exec(n)[1],a=s.indexOf(l);if(-1<a){var u=s.slice(0,a)+(/.*?\/(.*\/)?/.exec(i)[1]||"");if(u in t)continue;t[u]=!0,this.completeFileName(o,r,null,i,u)}}}},completeFileName:function(e,t,n,o,r){var i,s,l=n?c(f(n),o):-1==(s=(i=o).lastIndexOf("/"))?i:i.slice(s+1);for(var a in this.modules)if(a!=n&&h(l,a,t)){/\.js$/.test(a)&&(a=a.slice(0,a.length-3));var u=a.slice(l.length);p.addCompletion(t,e,o+u,this.modules[a])}},getModType:function(e){var t,n,o=this.isModName(e);if(null==o&&(t=this.isImport(e))&&(o=t.name,n=t.prop),null!=o){var r=this.resolveModule(o,e.sourceFile.name);if(n){var i=r.getObjType();r=i&&i.hasProp(n)||r.getProp(n)}return r}}}),t&&(m=t("fs"),v=t("path"),n.prototype.completeFileName=function(o,r,i,e,s){var l=this.server.projectDir,t=/\/$/.test(e);if(i){var n=v.resolve(l,v.dirname(i),e);s=t?n:v.dirname(n)}var a=t?e:v.dirname(e)+"/",u=t?"":v.basename(e),d=this;m.readdirSync(s).forEach(function(e){if(!/^\./.test(e)&&h(u,e,r)){var t=d.server.normalizeFilename(v.relative(l,v.resolve(s,e)));if(t==i)return;var n=d.modules[t];/\.js$/.test(e)&&(e=e.slice(0,e.length-3)),p.addCompletion(r,o,a+e,n)}})}),p.registerPlugin("modules",function(e,t){e.mod.modules=new n(e,t),e.on("beforeLoad",function(e){e.scope=this.mod.modules.buildWrappingScope(e.scope,e.name,e.ast)}),e.on("afterLoad",function(e){var t=this.mod.modules.get(e.name);t.origin=e.name,this.mod.modules.signal("getExports",e,t)}),e.on("reset",function(){this.mod.modules.modules=Object.create(null)}),e.on("preCondenseReach",o),e.on("postLoadDef",r),e.on("typeAt",i),e.on("completion",s)}),p.defineQueryType("exports",{takesFile:!0,run:function(s,l,e){function t(e){var t={},n=e.getType(!1);t.type=d.toString(n,3);var o=e.doc||n&&n.doc,r=e.url||n&&n.url;o&&(t.doc=o),r&&(t.url=r);var i=p.getSpan(e)||n&&p.getSpan(n);return i&&p.storeSpan(s,l,i,t),t}var n=s.mod.modules,o=n&&n.modules[e.name];if(!o)return{};var r=t(o),i=o.getType(!1);if(i instanceof d.Obj){var a=r.props={};for(var u in i.props)a[u]=t(i.props[u])}return r}})});