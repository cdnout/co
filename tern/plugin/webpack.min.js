if("object"!=typeof exports||"object"!=typeof module)throw new Error("This plugin works only in a CommonJS environment");var infer=require("../lib/infer"),tern=require("../lib/tern");function isArray(e){return"[object Array]"==Object.prototype.toString.call(e)}require("./commonjs"),require("./es_modules");var fs=require("fs"),path=require("path"),ResolverFactory=require("enhanced-resolve").ResolverFactory,SyncNodeJsInputFileSystem=require("enhanced-resolve/lib/SyncNodeJsInputFileSystem");function getResolver(e,r){var s={unsafeCache:!0,modules:e||["node_modules"],extensions:[".js",".jsx",".json"],aliasFields:["browser"],mainFields:["browser","web","browserify","main"],fileSystem:new SyncNodeJsInputFileSystem},o=r&&fs.existsSync(r)?require(r):null;"function"==typeof o&&(o=o());var n=o&&o.resolve;return n&&Object.keys(n).forEach(function(e){if("packageMains"===e)s.mainFields=n[e];else if("root"===e){var r=n[e];isArray(r)?s.modules=r.concat(s.modules):s.modules.unshift(r)}else if("fallback"===e){var o=n[e];isArray(o)?s.modules=s.modules.concat(o):s.modules.push(o)}else"modules"===e?s.modules=s.modules.concat(n[e]):s[e]=n[e]}),ResolverFactory.createResolver(s)}function resolveToFile(e,r,o){var s=infer.cx().parent.projectDir,n=path.resolve(s,o);try{return e.resolveSync({},path.dirname(n),r)}catch(e){return console.log(e.stack),""}}tern.registerPlugin("webpack",function(e,r){var o=r.configPath||"./webpack.config.js",s=getResolver(r.modules||["node_modules"],o=path.resolve(e.options.projectDir,o));e.loadPlugin("commonjs"),e.loadPlugin("es_modules"),e.mod.modules.resolvers.push(function(e,r){var o=resolveToFile(s,e,r);return o&&infer.cx().parent.normalizeFilename(o)})});