!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../lib/infer"),require("../lib/tern"),require("../lib/comment"),require("acorn"),require("acorn-walk")):"function"==typeof define&&define.amd?define(["../lib/infer","../lib/tern","../lib/comment","acorn/dist/acorn","acorn-walk/dist/walk"],e):e(tern,tern,tern.comment,acorn,acorn.walk)}(function(j,e,n,x,a){"use strict";var o=1;function t(e,r){function t(e){n.ensureCommentsBefore(r,e)}a.simple(e,{VariableDeclaration:t,FunctionDeclaration:t,MethodDefinition:t,Property:t,AssignmentExpression:function(e){"="==e.operator&&t(e)},CallExpression:function(e){i(e)&&t(e)},ExportNamedDeclaration:t,ExportDefaultDeclaration:t,ClassDeclaration:t})}function i(e){return"MemberExpression"==e.callee.type&&"Object"==e.callee.object.name&&"defineProperty"==e.callee.property.name&&3<=e.arguments.length&&"string"==typeof e.arguments[1].value}function l(e,r){!function(e,r){var t,n=j.cx(),a=/\s@typedef\s+(.*)/g;for(;t=a.exec(e);){var o=D(r,t[1]),i=o&&t[1].slice(o.end).match(/^\s*(\S+)/);if(i&&o.type instanceof j.Obj){for(var l=e.slice(t.index+t[0].length);t=/\s+@prop(?:erty)?\s+(.*)/.exec(l);){var c,s=D(r,t[1]);s&&(c=t[1].slice(s.end).match(/^\s*(\S+)/))&&s.type.propagate(o.type.defProp(c[1])),l=l.slice(t[0].length)}n.parent.mod.jsdocTypedefs[i[1]]=o.type}}}(e.sourceFile.text,r),a.simple(e,{VariableDeclaration:function(e,r){var t=e.declarations[0].id;e.commentsBefore&&"Identifier"==t.type&&f(e,e.commentsBefore,r,r.getProp(e.declarations[0].id.name))},FunctionDeclaration:function(e,r){e.commentsBefore&&f(e,e.commentsBefore,r,r.getProp(e.id.name),e.scope.fnType)},ClassDeclaration:function(e,r){e.commentsBefore&&f(e,e.commentsBefore,r,r.getProp(e.id.name),e.objType)},AssignmentExpression:function(e,r){e.commentsBefore&&f(e,e.commentsBefore,r,j.expressionType({node:e.left,state:r}))},ObjectExpression:function(e,r){for(var t=0;t<e.properties.length;++t){var n=e.properties[t];if("SpreadElement"!=n.type){var a=j.propName(n);"<i>"!=a&&n.commentsBefore&&f(n,n.commentsBefore,r,e.objType.getProp(a))}}},Class:function(e,r){if(e.objType){var t=e.objType.getProp("prototype").getObjType();if(t)for(var n=0;n<e.body.body.length;n++){var a,o=e.body.body[n];o.commentsBefore&&("constructor"==o.kind?f(o,o.commentsBefore,r,e.objType):"<i>"!=(a=j.propName(o))&&f(o,o.commentsBefore,r,t.getProp(a)))}}},CallExpression:function(e,r){if(e.commentsBefore&&i(e)){var t=j.expressionType({node:e.arguments[0],state:r}).getObjType();if(t&&t instanceof j.Obj){var n=t.props[e.arguments[1].value];n&&f(e,e.commentsBefore,r,n)}}},ExportNamedDeclaration:function(e,r){e.commentsBefore&&e.declaration&&"FunctionDeclaration"===e.declaration.type&&f(e.declaration,e.commentsBefore,r,r.getProp(e.declaration.id.name),e.declaration.scope.fnType)},ExportDefaultDeclaration:function(e,r){e.commentsBefore&&e.declaration&&"FunctionDeclaration"===e.declaration.type&&f(e.declaration,e.commentsBefore,r,r.getProp(e.declaration.id.name),e.declaration.scope.fnType)}},j.searchVisitor,r)}function c(e){var r=e["!typedef"],t=j.cx(),n=e["!name"];if(r)for(var a in r)t.parent.mod.jsdocTypedefs[a]=C(j.def.parse(r[a],n,a),a)}function s(e){for(var n,r=1;r<e.length;r++){var t=e[r],a=t.match(/^[\s\*]*/)[0];if(a!=t)if(null==n)n=a;else{for(var o=0;o<n.length&&n.charCodeAt(o)==a.charCodeAt(o);)++o;o<n.length&&(n=n.slice(0,o))}}for(e=e.map(function(e,r){if(e=e.replace(/\s+$/,""),0==r&&null!=n)for(var t=0;t<n.length;t++){if(0==e.indexOf(n.slice(t)))return e.slice(n.length-t)}return null==n||0==r?e.replace(/^[\s\*]*/,""):e.length<n.length?"":e.slice(n.length)});e.length&&!e[e.length-1];)e.pop();for(;e.length&&!e[0];)e.shift();return e}function f(e,r,t,n,a){!function(e,r,t,n){for(var a,o,i,l,c,s,f=0;f<n.length;++f)for(var p,u=n[f],d=/(?:\n|\*)\s*@(type|param|arg(?:ument)?|returns?|this|class|constructor)(?:\s*?\n|\s+(.*))/g;p=d.exec(u);)if("class"!=p[1]&&"constructor"!=p[1]){if(void 0!==p[2])if("this"==p[1]&&(s=T(r,p[2],0)))c=s,l=!0;else if(s=D(r,p[2]))switch(l=!0,p[1]){case"returns":case"return":i=s;break;case"type":a=s;break;case"param":case"arg":case"argument":var m=p[2].slice(s.end).match(/^\s*(\[?)\s*([^\[\]\s=]+(\[\][^\[\]\s=]+)?)\s*(?:=[^\]]+\s*)?(\]?).*/);if(!m)continue;var y=m[2]+(s.isOptional||"["===m[1]&&"]"===m[4]?"?":""),g=!1,h=y.split(".");if(o&&2==h.length){var v,b,A=h[0];for(v in y=h[1],o)b=o[v],v===A&&b.type instanceof j.Obj?(g=!0,s.type.propagate(b.type.defProp(y))):v+"[]"===A&&b.type instanceof j.Arr&&(g=!0,s.type.propagate(b.type.getProp("<i>").getType().defProp(y)))}g||((o=o||Object.create(null))[y]=s)}}else c=l=!0;l&&function(e,r,t,n,a,o){var i;if("VariableDeclaration"==a.type){var l=a.declarations[0];l.init&&w(l.init)&&(i=l.init.scope.fnType)}else"FunctionDeclaration"==a.type?i=a.scope.fnType:"AssignmentExpression"==a.type?w(a.right)&&(i=a.right.scope.fnType):"CallExpression"==a.type||"ClassDeclaration"===a.type||w(a.value)&&(i=a.value.scope.fnType);if(i&&(t||n||r)){if(t)for(var c=0;c<i.argNames.length;++c){var s=i.argNames[c],f=t[s];!f&&(f=t[s+"?"])&&(i.argNames[c]+="?"),f&&B(f,i.args[c])}if(n&&(i.retval==j.ANull&&(i.retval=new j.AVal),B(n,i.retval)),!0===r){var p=i.getProp("prototype").getObjType();r=p&&{type:j.getInstance(p,i)}}r&&B(r,i.self)}else e&&B(e,o)}(a,c,o,i,e,t)}(e,t,n,r);var o=j.cx();!a&&n instanceof j.AVal&&n.types.length&&((a=n.types[n.types.length-1])instanceof j.Obj&&a.origin==o.curOrigin&&!a.doc||(a=null));for(var i=r.length-1;0<=i;i--){var l=s(r[i].split(/\r\n?|\n/)).join("\n");if(l){n instanceof j.AVal&&(n.doc=l),a&&(a.doc=l);break}}}function P(e,r){for(;/\s/.test(e.charAt(r));)++r;return r}function u(e){if(x.isIdentifierStart(e.charCodeAt(0))){for(var r=1;r<e.length;r++)if(!x.isIdentifierChar(e.charCodeAt(r)))return;return 1}}function O(e,r,t,n){for(var a=[],o=[],i=!1,l=!0;t=P(r,t),!l||r.charAt(t)!=n;l=!1){var c=r.indexOf(":",t);if(c<0)return null;var s=r.slice(t,c);if(!u(s))return null;a.push(s);var f=T(e,r,t=c+1);if(!f)return null;t=f.end,i=i||f.madeUp,o.push(f.type),t=P(r,t);var p=r.charAt(t);if(++t,p==n)break;if(","!=p)return null}return{labels:a,types:o,end:t,madeUp:i}}function p(e,r,t){var n=function(e,r,t){t=P(r,t),/[?!]/.test(r.charAt(t))&&t++;var n,a=!1;if(r.indexOf("function(",t)==t){var o=O(e,r,t+9,")"),i=j.ANull;if(!o)return null;if(t=P(r,o.end),":"==r.charAt(t)){var l=T(e,r,++t+1);if(!l)return null;t=l.end,i=l.type,a=l.madeUp}n=new j.Fn(null,j.ANull,o.types,o.labels,i)}else if("["==r.charAt(t)){if(!(d=T(e,r,t+1)))return null;if(t=P(r,d.end),a=d.madeUp,"]"!=r.charAt(t))return null;++t,n=new j.Arr(d.type)}else if("{"==r.charAt(t)){var c=O(e,r,t+1,"}");if(!c)return null;n=new j.Obj(!0);for(var s=0;s<c.types.length;++s){var f=n.defProp(c.labels[s]);f.initializer=!0,c.types[s].propagate(f)}t=c.end,a=c.madeUp}else if("("==r.charAt(t)){if(!(d=T(e,r,t+1)))return null;if(t=P(r,d.end),")"!=r.charAt(t))return null;++t,n=d.type}else{var p=t;if(!x.isIdentifierStart(r.charCodeAt(t)))return null;for(;x.isIdentifierChar(r.charCodeAt(t));)++t;if(p==t)return null;var u=r.slice(p,t);if(/^(number|integer)$/i.test(u))n=j.cx().num;else if(/^bool(ean)?$/i.test(u))n=j.cx().bool;else if(/^string$/i.test(u))n=j.cx().str;else if(/^(null|undefined)$/i.test(u))n=j.ANull;else if(/^array$/i.test(u)){var d=null;if("."==r.charAt(t)&&"<"==r.charAt(t+1)){var m=T(e,r,t+2);if(!m)return null;if(t=P(r,m.end),a=m.madeUp,">"!=r.charAt(t++))return null;d=m.type}n=new j.Arr(d)}else if(/^object$/i.test(u)){if(n=new j.Obj(!0),"."==r.charAt(t)&&"<"==r.charAt(t+1)){var y=T(e,r,t+2);if(!y)return null;if(t=P(r,y.end),","!=r.charAt(t++))return null;var g=T(e,r,t);if(!g)return null;if(t=P(r,g.end),a=y.madeUp||g.madeUp,">"!=r.charAt(t++))return null;g.type.propagate(n.defProp("<i>"))}}else{for(;46==r.charCodeAt(t)||x.isIdentifierChar(r.charCodeAt(t));)++t;var h,v=r.slice(p,t),b=j.cx(),A=b.parent&&b.parent.mod.jsdocTypedefs;A&&v in A?n=A[v]:(h=j.def.parsePath(v,e).getObjType())?n=C(h,v):(b.jsdocPlaceholders||(b.jsdocPlaceholders=Object.create(null)),n=v in b.jsdocPlaceholders?b.jsdocPlaceholders[v]:b.jsdocPlaceholders[v]=new j.Obj(null,v),a=!0)}}return{type:n,end:t,madeUp:a}}(e,r,t);return n?"[]"==r.slice(n.end,n.end+2)?{madeUp:n.madeUp,end:n.end+2,type:new j.Arr(n.type)}:n:null}function T(e,r,t){for(var n,a=!1,o=!1;;){var i=p(e,r,t);if(!i)return null;if(o=o||i.madeUp,a?i.type.propagate(a):n=i.type,t=P(r,i.end),"|"!=r.charAt(t))break;t++,a||(a=new j.AVal,n.propagate(a),n=a)}var l=!1;return"="==r.charAt(t)&&(++t,l=!0),{type:n,end:t,isOptional:l,madeUp:o}}function C(e,r){if(e instanceof j.Fn&&/(?:^|\.)[A-Z][^\.]*$/.test(r)){var t=e.getProp("prototype").getObjType();if(t instanceof j.Obj)return j.getInstance(t)}return e}function D(e,r,t){if(t=P(r,t||0),"{"!=r.charAt(t))return null;var n=T(e,r,t+1);if(!n)return null;var a=P(r,n.end);return"}"!=r.charAt(a)?null:(n.end=a+1,n)}function B(e,r){var t=j.cx().parent.mod.docComment.weight;e.type.propagate(r,t||(e.madeUp?o:void 0))}function w(e){return"FunctionExpression"==e.type||"ArrowFunctionExpression"==e.type}e.registerPlugin("doc_comment",function(e,r){e.mod.jsdocTypedefs=Object.create(null),e.on("reset",function(){e.mod.jsdocTypedefs=Object.create(null)}),e.mod.docComment={weight:r&&r.strong?101:void 0,fullDocs:r&&r.fullDocs},e.on("postParse",t),e.on("postInfer",l),e.on("postLoadDef",c)})});