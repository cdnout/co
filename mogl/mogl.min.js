(function(W){(function(){var test=function test(){};if(!("name"in test)||test.name!="test")Object.defineProperty(Function.prototype,"name",{get:function(){var f;if(!("__name"in this)){f=this.toString();this.__name=f.substring(f.indexOf("function")+8,f.indexOf("(")).trim()||undefined}return this.__name}});if(!("requestAnimationFrame"in window))window.requestAnimationFrame=window["webkitRequestAnimationFrame"]||window["mozRequestAnimationFrame"]||window["msRequestAnimationFrame"];var nowOffset;if(!("performance"in
    window))window.performance={};if(!("now"in Date))Date.now=function(){return+new Date};if(!("now"in window.performance)){nowOffset=Date.now();if(window.performance.timing&&window.performance.timing.navigationStart)nowOffset=window.performance.timing.navigationStart;window.performance.now=function now(){return Date.now()-nowOffset}}})();var $setPrivate,$getPrivate,$writable,$readonly,$getter,$setter,$color,$md,$ease,GLMAT_EPSILON,SIN,COS,TAN,ATAN,ATAN2,ASIN,SQRT,CEIL,ABS,PI,PIH,PID,D2R,R2D;(function(){var VAR=
{},value={};$setPrivate=function $setPrivate(cls,v){$readonly.value=v,Object.defineProperty(VAR,cls,$readonly)},$getPrivate=function $getPrivate(cls){if(arguments.length==2)return VAR[cls][arguments[1]];else return VAR[cls]}})(),$writable={value:true,writable:true},$readonly={value:null},$getter=function(prop,key){var defaultValue=arguments.length==3?arguments[2]:null;if(key)return function getter(){var p=prop[this];return key in p?p[key]:defaultValue};else return function getter(){return this.uuid in
prop?prop[this]:defaultValue}},$setter=function(prop,key){if(key)return function setter(v){prop[this][key]=v};else return function setter(v){prop[this]=v}},$color=function(){var co=[];return function(v){if(typeof v=="string"&&v.charAt(0)=="#"){if(v.length==4){v=v.substr(1,3);v="#"+v[0]+v[0]+v[1]+v[1]+v[2]+v[2]}co[0]=parseInt(v.substr(1,2),16)/255,co[1]=parseInt(v.substr(3,2),16)/255,co[2]=parseInt(v.substr(5,2),16)/255;if(v.length>7){co[3]=parseFloat(v.substr(7));if(co[3]>1)co[3]=1}else co[3]=1}else if("r"in
    v)co[0]=v.r,co[1]=v.g,co[2]=v.b,co[3]="a"in v?v.a:1;else co[0]=v[0],co[1]=v[1],co[2]=v[2],co[3]="3"in v?v[3]:1;return co}}();GLMAT_EPSILON=1E-6,SIN=Math.sin,COS=Math.cos,TAN=Math.tan,ATAN=Math.atan,ATAN2=Math.atan2,ASIN=Math.asin,SQRT=Math.sqrt,CEIL=Math.ceil,ABS=Math.abs,PI=Math.PI,PIH=PI*.5,PID=PI*2,D2R=PI/180,R2D=180/PI;Object.freeze($ease={linear:function(a,c,b){return b*a+c},backIn:function(a,c,b){return b*a*a*(2.70158*a-1.70158)+c},backOut:function(a,c,b){a-=1;return b*(a*a*(2.70158*a+1.70158)+
    1)+c},backInOut:function(a,c,b){a*=2;if(1>a)return.5*b*a*a*(3.5949095*a-2.5949095)+c;a-=2;return.5*b*(a*a*(3.70158*a+2.70158)+2)+c},bounceOut:function(a,c,b){if(.363636>a)return 7.5625*b*a*a+c;if(.727272>a)return a-=.545454,b*(7.5625*a*a+.75)+c;if(.90909>a)return a-=.818181,b*(7.5625*a*a+.9375)+c;a-=.95454;return b*(7.5625*a*a+.984375)+c},sineIn:function(a,c,b){return-b*Math.cos(a*PIH)+b+c},sineOut:function(a,c,b){return b*Math.sin(a*PIH)+c},sineInOut:function(a,c,b){return.5*-b*(Math.cos(PI*a)-1)+
    c},circleIn:function(a,c,b){return-b*(Math.sqrt(1-a*a)-1)+c},circleOut:function(a,c,b){a-=1;return b*Math.sqrt(1-a*a)+c},circleInOut:function(a,c,b){a*=2;if(1>a)return.5*-b*(Math.sqrt(1-a*a)-1)+c;a-=2;return.5*b*(Math.sqrt(1-a*a)+1)+c},quadraticIn:function(a,c,b){return b*a*a+c},quadraticOut:function(a,c,b){return-b*a*(a-2)+c}});var makeUtil=function(){var makeBuffer=function makeBuffer(gl,target,data,stribe){var buffer=gl.createBuffer();gl.bindBuffer(target,buffer),gl.bufferData(target,data,gl.STATIC_DRAW),
    buffer.data=data,buffer.stride=stribe,buffer.numItem=data.length/stribe,gl.bindBuffer(target,null);return buffer};return{makeVBO:function makeVBO(gpu,geo,data,stribe){var gl,buffer;gl=gpu.gl,buffer=gpu.vbo[geo];if(buffer)return;if(Array.isArray(data))data=new Float32Array(data);buffer=makeBuffer(gl,gl.ARRAY_BUFFER,data,stribe),buffer.name=geo,buffer.type="VBO",gpu.vbo[geo]=buffer},makeVNBO:function makeVNVO(gpu,geo,data,stribe){var gl,buffer;gl=gpu.gl,buffer=gpu.vnbo[geo];if(buffer)return;if(Array.isArray(data))data=
    new Float32Array(data);buffer=makeBuffer(gl,gl.ARRAY_BUFFER,data,stribe),buffer.name=geo,buffer.type="VNBO";gpu.vnbo[geo]=buffer},makeIBO:function makeIBO(gpu,geo,data,stribe){var gl,buffer;gl=gpu.gl,buffer=gpu.ibo[geo];if(buffer)return;if(Array.isArray(data))data=new Uint16Array(data);buffer=makeBuffer(gl,gl.ELEMENT_ARRAY_BUFFER,data,stribe),buffer.name=geo,buffer.type="IBO";gpu.ibo[geo]=buffer},makeUVBO:function makeUVBO(gpu,geo,data,stribe){var gl,buffer;gl=gpu.gl,buffer=gpu.uvbo[geo];if(buffer)return;
    if(Array.isArray(data))data=new Float32Array(data);buffer=makeBuffer(gl,gl.ARRAY_BUFFER,data,stribe),buffer.name=geo,buffer.type="UVBO";gpu.uvbo[geo]=buffer},makeProgram:function makeProgram(gpu,name,vSource,fSource){var gl,vShader,fShader,program,i,len,tList;gl=gpu.gl,vShader=gl.createShader(gl.VERTEX_SHADER),fShader=gl.createShader(gl.FRAGMENT_SHADER),gl.shaderSource(vShader,vSource.shaderStr),gl.compileShader(vShader),gl.shaderSource(fShader,fSource.shaderStr),gl.compileShader(fShader);program=
    gl.createProgram(),gl.attachShader(program,vShader),gl.attachShader(program,fShader),gl.linkProgram(program),vShader.name=vSource.id,fShader.name=fSource.id,program.name=name;if(!gl.getProgramParameter(program,gl.LINK_STATUS))throw new Error("\ud504\ub85c\uadf8\ub7a8 \uc170\uc774\ub354 \ucd08\uae30\ud654 \uc2e4\ud328");gl.useProgram(program),tList=vSource.attributes,len=tList.length;for(i=0;i<len;i++)gl.bindBuffer(gl.ARRAY_BUFFER,gpu.vbo["null"]),gl.enableVertexAttribArray(program[tList[i]]=gl.getAttribLocation(program,
    tList[i])),gl.vertexAttribPointer(program[tList[i]],gpu.vbo["null"].stride,gl.FLOAT,false,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,null);tList=vSource.uniforms,i=tList.length;while(i--)program[tList[i]]=gl.getUniformLocation(program,tList[i]);tList=fSource.uniforms,i=tList.length;while(i--)program[tList[i]]=gl.getUniformLocation(program,tList[i]);gpu.programs[name]=program},makeTexture:function makeTexture(gpu,texture){var gl,glTexture;gl=gpu.gl;glTexture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,
    glTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,texture.img),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.generateMipmap(gl.TEXTURE_2D),glTexture.textrue=texture,gpu.textures[texture]=glTexture,gl.bindTexture(gl.TEXTURE_2D,null)},makeFrameBuffer:function makeFrameBuffer(gpu,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       camera,cvs){var gl,texture,fBuffer,rBuffer,tArea,cvsW,cvsH,pRatio;if(!cvs)return;cvsW=cvs.width,cvsH=cvs.height,pRatio=window.devicePixelRatio;if(camera.renderArea)tArea=camera.renderArea;else tArea=[0,0,cvsW,cvsH];gl=gpu.gl,fBuffer=gl.createFramebuffer(),fBuffer.x=tArea[0],fBuffer.y=tArea[1],fBuffer.width=Math.min(tArea[2]*pRatio,cvsW),fBuffer.height=Math.min(tArea[3]*pRatio,cvsH),gl.bindFramebuffer(gl.FRAMEBUFFER,fBuffer),texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,texture),gl.texParameteri(gl.TEXTURE_2D,
    gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,fBuffer.width,fBuffer.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null),rBuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,rBuffer),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,fBuffer.width,fBuffer.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,
    gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,rBuffer),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gpu.framebuffers[camera]={frameBuffer:fBuffer,texture:texture}},vertexShaderParser:function vertexShaderParser(source){var i,temp,str,resultObject,code;code=source.code,resultObject={uniforms:[],attributes:[],id:code.id,shaderStr:null},str="",temp=code.attributes,
    i=temp.length;while(i--)str+="attribute "+temp[i]+";\n",resultObject.attributes.push(temp[i].split(" ")[1]);temp=code.uniforms,i=temp.length;while(i--)str+="uniform "+temp[i]+";\n",resultObject.uniforms.push(temp[i].split(" ")[1]);temp=code.varyings,i=temp.length;while(i--)str+="varying "+temp[i]+";\n";str+=VertexShader.baseFunction,str+="void main(void){\n",str+=code.main+";\n",str+="}\n";resultObject.shaderStr=str;return resultObject},fragmentShaderParser:function fragmentShaderParser(source){var i,
    temp,str,resultObject,code;code=source.code,resultObject={uniforms:[],id:code.id,shaderStr:null},str="";if(code.precision)str+="precision "+code.precision+";\n";else str+="precision mediump float;\n";temp=code.uniforms,i=temp.length;while(i--)str+="uniform "+temp[i]+";\n",resultObject.uniforms.push(temp[i].split(" ")[1]);temp=code.varyings,i=temp.length;while(i--)str+="varying "+temp[i]+";\n";str+="void main(void){\n",str+=code.main+";\n",str+="}\n";resultObject.shaderStr=str;return resultObject}}}();
    var MoGL=function(){var Definer,build,func,keys,val,param,checker,MoGL,idProp,destroy,classGet,totalCount,error;checker={};param=function(v){var i;v=Function.prototype.toString.call(v),v=v.substring(v.indexOf("(")+1,v.indexOf(")")).trim().split(","),i=v.length;if(i){while(i--)v[i]=v[i].trim();return v}},Definer=function(k,v,parent,check){var p,i;if(check!==checker)throw new Error("Definer\ub294 extend\ub97c \ud1b5\ud574\uc11c\ub9cc \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4");this.parent=
        parent;if(typeof v=="function")this._construct={name:k,description:"Constructor of "+k,param:param(v),value:v};else this._construct={name:k,description:v.description,param:v.param,ret:v.ret,sample:v.sample,value:v.value};this._info={_method:{},_static:{},_field:{},_constant:{},_event:{}},this._method={},this._static={},this._field={},this._constant={},this._event={},Object.freeze(this)},build=function(){var wrap,method,prev,methodSet,fieldSet,readonly,writable,isFactory,isSuperChain,inheritedStatic,
        md,uuid,allInstance,ids,counter,total,classes;uuid=0,allInstance={},ids={},total=0,counter={},classes={},isFactory={factory:1},isSuperChain={superChain:1},readonly={},writable={writable:true},prev=[],md={};if($md)md.value=$md(classes);else md.value=function(){return""};inheritedStatic={extend:{value:function extend(k){var v;if(arguments.length==1)v=k,k=k.name;else v=arguments[1];return new Definer(k,v,this,checker)}},getInstance:{value:function getInstance(v){var inst,p,k;if(v in allInstance){inst=
        allInstance[v];if(inst.classId==this.uuid)return inst}else{p=ids[this.uuid];for(k in p)if(p[k]==v)return allInstance[k]}this.error("getInstance",0)}},count:{value:function count(){return counter[this.uuid]}},error:{value:function error(method,id){throw new Error(this.className+"."+method+":"+id);}},getMD:md},wrap=function wrap(key,f){return function(){var result;if(!this.isAlive)throw new Error("Destroyed Object:"+this);prev[prev.length]=method,method=key,result=f.apply(this,arguments),method=prev.pop();
        return result}},methodSet=function(target,prop,unwrap){var k,v;for(k in prop)if(prop.hasOwnProperty(k)){v=prop[k];if(!unwrap)v.value=wrap(k,v.value),Object.defineProperty(target,k,v);else target[k]=v.value}},fieldSet=function(target,prop,unwrap){var k,v;for(k in prop)if(prop.hasOwnProperty(k)){v=prop[k];if(!unwrap){if(v.get)v.get=wrap(k+"Get",v.get);if(v.set)v.set=wrap(k+"Set",v.set)}Object.defineProperty(target,k,v)}},idProp={get:function idGet(){if(ids[this.classId]&&this.uuid in ids[this.classId])return ids[this.classId][this];
        return null},set:function idSet(v){if(!ids[this.classId])ids[this.classId]={ref:{}};else if(v in ids[this.classId].ref)throw new Error(this.className+".idSetter:0");if(v===null&&this.uuid in ids[this.classId])v=ids[this.classId][this],delete ids[this.classId][this],delete ids[this.classId].ref[v];else{ids[this.classId][this]=v;ids[this.classId].ref[v]=this.uuid}}},destroy=function destroy(){var key;for(key in this)if(this.hasOwnProperty(key))this[key]=null;if(ids[this.classId]&&this.uuid in ids[this.classId])key=
        ids[this.classId][this],delete ids[this.classId][this],delete ids[this.classId].ref[key];delete allInstance[this],this.isAlive=false,counter[this.classId]--,total--},classGet=function classGet(context){var k;if(!context)context={};for(k in classes)if(classes.hasOwnProperty(k))context[k]=classes[k].cls;return context},totalCount=function totalCount(){return total},error=function error(id){throw new Error(this.className+"."+method+":"+id);},MoGL=function MoGL(){readonly.value="uuid:"+uuid++,Object.defineProperty(this,
        "uuid",readonly),allInstance[this]=this,writable.value=true,Object.defineProperty(this,"isAlive",writable),counter[this.classId]++,total++};return function(){var cls,parent,child,fn,prop,i,k,v;parent=this.parent,child=this._construct.value,cls=function(){var arg,arg0=arguments[0],result;prev[prev.length]=method,method="constructor";if(arg0===isSuperChain){if(parent)parent.call(this,isSuperChain,arguments[1]);child.apply(this,arguments[1])}else if(this instanceof cls){if(arg0===isFactory)arg=arguments[1];
    else arg=arguments;if(parent)parent.call(this,isSuperChain,arg),child.apply(this,arg),Object.seal(this),result=this}else result=cls.call(Object.create(cls.prototype),isFactory,arguments);method=prev.pop();return result},classes[this._construct.value.name]={cls:cls,define:this};if(parent)fn=Object.create(parent.prototype);else fn=cls.prototype;readonly.value=cls.uuid="uuid:"+uuid++,Object.defineProperty(fn,"classId",readonly);readonly.value=cls.className=this._construct.value.name,Object.defineProperty(fn,
        "className",readonly);if(!(cls.uuid in counter))counter[cls.uuid]=0;for(k in inheritedStatic)this["static"](k,inheritedStatic[k]);fieldSet(fn,this._field),methodSet(fn,this._method),fieldSet(cls,this._constant,true),fieldSet(cls,this._event,true),methodSet(cls,this._static,true),cls.prototype=fn,Object.freeze(cls);if(parent)Object.freeze(fn);return cls}}(),func=function(type){return{value:function(k,v,isdoc){if(typeof v=="function"){if(!isdoc)this[type][k]={value:v},this._info[type][k]={description:(type==
    "_static"?"Static method":"Method")+" of "+this._construct.value.name,param:param(v),ret:"?"}}else{if(!isdoc)this[type][k]={value:v.value};this._info[type][k]={description:v.description,param:v.param||(!isdoc?param(v.value):""),ret:v.ret,sample:v.sample,exception:v.exception}}return this}}},keys="configurable,enumerable,writable,get,set,value".split(","),val=function(type){return{value:function(k,v,isdoc){var p,i;if(!v||typeof v!=="object"){if(v===undefined)p={},this[type][k]={get:function(){return p[this.uuid]},
        set:function(v){p[this.uuid]=v}};else this[type][k]={value:k};this._info[type][k]={description:(type=="_constant"?"Const":type=="_event"?"Event":"Field")+" of "+this._construct.value.name}}else{if(!isdoc){this[type][k]=p={},i=keys.length;while(i--)if(keys[i]in v)p[keys[i]]=v[keys[i]]}this._info[type][k]={type:v.type,description:v.description||(type=="_constant"?"Const":type=="_event"?"Event":"Field")+" of "+this._construct.value.name,defaultValue:v.defaultValue,sample:v.sample,exception:v.exception}}if(!isdoc&&
        "value"in this[type][k])this._info[type][k].value=this[type][k].value;return this}}},Object.defineProperties(Definer.prototype,{method:func("_method"),"static":func("_static"),field:val("_field"),constant:val("_constant"),event:val("_event"),build:{value:build}});Object.freeze(Definer),Object.freeze(Definer.prototype);MoGL=function(){var init,updated,listener;listener={},updated={},init=(new Definer("MoGL",{value:MoGL},null,checker)).field("id",idProp).field("isUpdated",{get:function isUpdatedGet(){return updated[this]||
        false},set:function isUpdatedSet(v){this.dispatch("updated",updated[this]=v)}}).field("uuid",{},true).field("className",{},true).field("classId",{},true).method("error",{},true).method("toString",{},true).method("destroy",{value:destroy}).method("setId",{value:function setId(v){this.id=v;return this}}).method("setProperties",{value:function(){var loopstart,loop,target,aid=0;loop=function loop(t){var k0,k1,ani,inst,prop,init,rate;for(k0 in target){ani=target[k0];if(t>ani.start){inst=ani.target,init=
        ani.init,prop=ani.prop;if(t>ani.end)if(ani.repeat>1){ani.repeat--,ani.start=t,ani.end=t+ani.term;if(ani.yoyo)ani.init=prop,ani.prop=init}else{for(k1 in prop)inst[k1]=prop[k1];delete target[k0];inst.dispatch(MoGL.propertyChanged)}else{var ease=ani.ease,rate=(t-ani.start)/ani.term;for(k1 in prop)inst[k1]=ease(rate,init[k1],prop[k1]-init[k1])}}}requestAnimationFrame(loop)},target={};return function setProperties(v,opt){var k,ani,start,end,term;if(opt){target[aid++]=ani={ease:opt.ease||($ease?$ease.linear:
        function(){}),repeat:opt.repeat||0,yoyo:opt.yoyo||false,target:this,prop:v,init:{},start:performance.now()+("delay"in opt?opt.delay*1E3:0),term:opt.time*1E3};ani.end=ani.start+ani.term;for(k in v)ani.init[k]=this[k];if(!loopstart){loopstart=true;requestAnimationFrame(loop)}}else{for(k in v)this[k]=v[k];this.dispatch(MoGL.propertyChanged)}}}()}).method("addEventListener",{value:function addEventListener(ev,f){var target;if(!listener[this])listener[this]={};target=listener[this];if(!target[ev])target[ev]=
        [];target=target[ev];target[target.length]={f:f,cx:arguments[2]||this,arg:arguments.length>3?Array.prototype.slice.call(arguments,3):null};return this}}).method("removeEventListener",{value:function removeEventListener(ev,f){var target,i;if(f){if(listener[this]&&listener[this][ev]){target=listener[this][ev],i=target.length;while(i--)if(typeof f=="string"&&target[i].f.name==f||target[i].f===f)target.splice(i,1)}}else if(listener[this]&&listener[this][ev])delete listener[this][ev];return this}}).method("dispatch",
        {value:function dispatch(ev){var target,arg,i,j,k,l;if(listener[this]&&listener[this][ev]){if(arguments.length>1)arg=Array.prototype.slice.call(arguments,1);for(target=listener[this][ev],i=0,j=target.length;i<j;i++){k=target[i];if(arg)if(k.arg)k.f.apply(k.cx,arg.concat(k.arg));else k.f.apply(k.cx,arg);else if(k.arg)k.f.apply(k.cx,k.arg);else k.f.call(k.cx)}}return this}})["static"]("classes",{value:classGet})["static"]("totalCount",{value:totalCount}).event("updated",{value:"updated"}).event("propertyChanged",
        {value:"propertyChanged"}).constant("ease",{value:$ease});return init.build()}(),function(){var fn=MoGL.prototype;fn.error=error,fn.toString=function(){return this.uuid},Object.freeze(fn)}();return MoGL}();var Vector=MoGL.extend("Vector",{value:function Vector(x,y,z){if(x instanceof Float32Array||Array.isArray(x))this.x=x[0],this.y=x[1],this.z=x[2];else if(x==undefined)this.x=this.y=this.z=0;else this.x=x,this.y=y,this.z=z}}).method("add",{value:function add(v){var a=this;a.x+=v.x,a.y+=v.y,a.z+=v.z;
        return this}}).method("addXYZ",{value:function addXYZ(x,y,z){var a=this;a.x+=x||0,a.y+=y||0,a.z+=z||0;return this}}).method("subtract",{value:function subtract(v){var a=this;a.x-=v.x,a.y-=v.y,a.z-=v.z;return this}}).method("subtractXYZ",{value:function subtractXYZ(x,y,z){var a=this;a.x-=x||0,a.y-=y||0,a.z-=z||0;return this}}).method("scaleBy",{value:function scaleBy(s){var a=this;a.x*=s,a.y*=s,a.z*=s;return this}}).method("distance",{value:function distance(v){var a=this;var x=v.x-a.x,y=v.y-a.y,z=
        v.z-a.z;return SQRT(x*x+y*y+z*z)}}).method("negate",{value:function negate(){var a=this;a.x=-a.x,a.y=-a.y,a.z=-a.z;return this}}).method("normalize",{value:function normalize(){var a=this;var x=a.x,y=a.y,z=a.z;var len=x*x+y*y+z*z;if(len>0)len=1/SQRT(len),a.x*=len,a.y*=len,a.z*=len;return this}}).method("dot",{value:function(v){var a=this;return a.x*v.x+a.y*v.y+a.z*v.z}}).method("cross",{value:function(v){var a=this,out=new Float32Array([0,0,0]);var ax=a.x,ay=a.y,az=a.z,bx=v.x,by=v.y,bz=v.z;out.x=
        ay*bz-az*by,out.y=az*bx-ax*bz,out.z=ax*by-ay*bx;return new Vector(out.x,out.y,out.z)}}).build();var Filter={anaglyph:"anaglyph",bevel:"bevel",bloom:"bloom",blur:"blur",colorMatrix:"colorMatrix",convolution:"convolution",displacementMap:"displacementMap",fxaa:"fxaa",glow:"glow",invert:"invert",mono:"mono",sepia:"sepia",shadow:"shadow"};Object.freeze(Filter);var Vertex=MoGL.extend("Vertex",{value:function Vertex(){}}).constant("x",{value:"x"}).constant("y",{value:"y"}).constant("z",{value:"z"}).constant("r",
        {value:"r"}).constant("g",{value:"g"}).constant("b",{value:"b"}).constant("a",{value:"a"}).constant("normalX",{value:"normalX"}).constant("normalY",{value:"normalY"}).constant("normalZ",{value:"normalZ"}).constant("u",{value:"u"}).constant("v",{value:"v"}).build();var BlendMode=MoGL.extend("BlendMode",{value:function BlendMode(){}}).constant("add",{value:"add"}).constant("alpha",{value:"alpha"}).constant("darken",{value:"darken"}).constant("difference",{value:"difference"}).constant("erase",{value:"erase"}).constant("hardlight",
        {value:"hardlight"}).constant("invert",{value:"invert"}).constant("lighten",{value:"lighten"}).constant("multiply",{value:"multiply"}).constant("screen",{value:"screen"}).constant("subtract",{value:"subtract"}).build();var Primitive=function(){return MoGL.extend("Primitive",{value:function Primitive(){}})["static"]("plane",{value:function plane(splitX,splitY){var _splitX=arguments[0]||1,_splitY=arguments[1]||1;var vs,is,x,y,base,tw;var index,numIndices;if(splitX==0||splitY==0)this.error(0);tw=_splitX+
    1,index=0,numIndices=0,vs=[],is=[];for(var yi=0;yi<=_splitY;++yi)for(var xi=0;xi<=_splitX;++xi){x=xi/_splitX-.5,y=yi/_splitY-.5,vs[index++]=x,vs[index++]=0,vs[index++]=y,vs[index++]=xi/_splitX,vs[index++]=yi/_splitY;if(xi!=_splitX&&yi!=_splitY){base=xi+yi*tw;is[numIndices++]=base,is[numIndices++]=base+tw,is[numIndices++]=base+tw+1,is[numIndices++]=base,is[numIndices++]=base+tw+1,is[numIndices++]=base+1}}var result=new Geometry(vs,is,[Vertex.x,Vertex.y,Vertex.z,Vertex.u,Vertex.v]);return result}})["static"]("polygon",
        {value:function polygon(n){n=arguments[0]||3;if(n<3)this.error(0);var i,j,angle=2*PI/n,x,y,z,u,v,vs=[0,1,0,.5,0],is=[],vertCoords=vs.length,result;for(i=0;i<n-1;i=i/vertCoords+1){x=vs[i*=vertCoords]*COS(angle)-vs[++i]*SIN(angle),y=vs[--i]*SIN(angle)+vs[++i]*COS(angle),z=vs[--i+2],u=.5+x/1/2,v=.5-y/1/2,vs.push(x,y,z,u,v);if(i>0){j=i/vertCoords;is.push(0,j,j+1)}}result=new Geometry(vs,is,[Vertex.x,Vertex.y,Vertex.z,Vertex.u,Vertex.v]);return result}})["static"]("cube",{value:function cube(splitX,splitY,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    splitZ){var _segmentsW,_segmentsH,_segmentsD;var vs,is;var tl,tr,bl,br,i,j,inc=0;var vidx,fidx;var hw,hh,hd;var dw,dh,dd;var outer_pos;var u_tile_dim,v_tile_dim,u_tile_step,v_tile_step;var tl0u,tl0v,tl1u,tl1v,du,dv;_segmentsW=arguments[0]||1,_segmentsH=arguments[1]||1,_segmentsD=arguments[2]||1,vs=[],is=[],vidx=0,fidx=0,hw=1/2,hh=1/2,hd=1/2,dw=1/_segmentsW,dh=1/_segmentsH,dd=1/_segmentsD,u_tile_dim=1,v_tile_dim=1,u_tile_step=0,v_tile_step=0;tl0u=u_tile_step,tl0v=v_tile_step,tl1u=2*u_tile_step,tl1v=
        0,du=u_tile_dim/_segmentsW,dv=v_tile_dim/_segmentsH;if(_segmentsW==0&&_segmentsH==0,_segmentsD==0)this.error(0);for(i=0;i<=_segmentsW;i++){outer_pos=-hw+i*dw;for(j=0;j<=_segmentsH;j++){vs[vidx++]=outer_pos,vs[vidx++]=-hh+j*dh,vs[vidx++]=-hd,vs[vidx++]=1-(tl0u+i*du),vs[vidx++]=tl0v+(v_tile_dim-j*dv),vs[vidx++]=outer_pos,vs[vidx++]=-hh+j*dh,vs[vidx++]=hd,vs[vidx++]=1-(tl1u+(u_tile_dim-i*du)),vs[vidx++]=tl1v+(v_tile_dim-j*dv);if(i&&j)tl=2*((i-1)*(_segmentsH+1)+(j-1)),tr=2*(i*(_segmentsH+1)+(j-1)),bl=
        tl+2,br=tr+2,is[fidx++]=tl,is[fidx++]=bl,is[fidx++]=br,is[fidx++]=tl,is[fidx++]=br,is[fidx++]=tr,is[fidx++]=tr+1,is[fidx++]=br+1,is[fidx++]=bl+1,is[fidx++]=tr+1,is[fidx++]=bl+1,is[fidx++]=tl+1}}inc+=2*(_segmentsW+1)*(_segmentsH+1),tl0u=u_tile_step,tl0v=0,tl1u=0,tl1v=0,du=u_tile_dim/_segmentsW,dv=v_tile_dim/_segmentsD;for(i=0;i<=_segmentsW;i++){outer_pos=-hw+i*dw;for(j=0;j<=_segmentsD;j++){vs[vidx++]=outer_pos,vs[vidx++]=hh,vs[vidx++]=-hd+j*dd,vs[vidx++]=1-(tl0u+i*du),vs[vidx++]=tl0v+(v_tile_dim-j*
    dv),vs[vidx++]=outer_pos,vs[vidx++]=-hh,vs[vidx++]=-hd+j*dd,vs[vidx++]=1-(tl1u+i*du),vs[vidx++]=tl1v+j*dv;if(i&&j)tl=inc+2*((i-1)*(_segmentsD+1)+(j-1)),tr=inc+2*(i*(_segmentsD+1)+(j-1)),bl=tl+2,br=tr+2,is[fidx++]=tl,is[fidx++]=bl,is[fidx++]=br,is[fidx++]=tl,is[fidx++]=br,is[fidx++]=tr,is[fidx++]=tr+1,is[fidx++]=br+1,is[fidx++]=bl+1,is[fidx++]=tr+1,is[fidx++]=bl+1,is[fidx++]=tl+1}}inc+=2*(_segmentsW+1)*(_segmentsD+1),tl0u=0,tl0v=v_tile_step,tl1u=2*u_tile_step,tl1v=v_tile_step,du=u_tile_dim/_segmentsD,
        dv=v_tile_dim/_segmentsH;for(i=0;i<=_segmentsD;i++){outer_pos=hd-i*dd;for(j=0;j<=_segmentsH;j++){vs[vidx++]=-hw,vs[vidx++]=-hh+j*dh,vs[vidx++]=outer_pos,vs[vidx++]=1-(tl0u+i*du),vs[vidx++]=tl0v+(v_tile_dim-j*dv);vs[vidx++]=hw,vs[vidx++]=-hh+j*dh,vs[vidx++]=outer_pos;vs[vidx++]=1-(tl1u+(u_tile_dim-i*du)),vs[vidx++]=tl1v+(v_tile_dim-j*dv);if(i&&j)tl=inc+2*((i-1)*(_segmentsH+1)+(j-1)),tr=inc+2*(i*(_segmentsH+1)+(j-1)),bl=tl+2,br=tr+2,is[fidx++]=tl,is[fidx++]=bl,is[fidx++]=br,is[fidx++]=tl,is[fidx++]=
        br,is[fidx++]=tr,is[fidx++]=tr+1,is[fidx++]=br+1,is[fidx++]=bl+1,is[fidx++]=tr+1,is[fidx++]=bl+1,is[fidx++]=tl+1}}var result=new Geometry(vs,is,[Vertex.x,Vertex.y,Vertex.z,Vertex.u,Vertex.v]);return result}})["static"]("sphere",{value:function sphere(splitLatitude,splitLongitude){var vs=[];var is=[];var latitudeBands=splitLatitude;var longitudeBands=splitLongitude;var radius=1;if(splitLatitude==0||splitLongitude==0)this.error(0);for(var latNumber=0;latNumber<=latitudeBands;++latNumber){var theta=
        latNumber*PI/latitudeBands;var sinTheta=SIN(theta);var cosTheta=COS(theta);for(var longNumber=0;longNumber<=longitudeBands;++longNumber){var phi=longNumber*2*PI/longitudeBands;var sinPhi=SIN(phi);var cosPhi=COS(phi);var x=cosPhi*sinTheta;var y=cosTheta;var z=sinPhi*sinTheta;var u=1-longNumber/longitudeBands;var v=1-latNumber/latitudeBands;vs.push(radius*x,radius*y,radius*z,u,v)}}for(latNumber=0;latNumber<latitudeBands;++latNumber)for(longNumber=0;longNumber<longitudeBands;++longNumber){var first=
        latNumber*(longitudeBands+1)+longNumber;var second=first+longitudeBands+1;is.push(second,first,first+1,second+1,second,first+1)}var result=new Geometry(vs,is,[Vertex.x,Vertex.y,Vertex.z,Vertex.u,Vertex.v]);return result}})["static"]("geodesic",{value:function geodesic(){var radius=.5,fractures=arguments[0]||30,yUp=true;var hnLat=fractures;var nLat=2*hnLat;var nLon;var lon;var lat;var dLat=180/nLat*D2R;var dLon;var i,j,x,y,z,sinLat,cosLat,sinLon,cosLon,u,v;var _vertices=[],_indices=[];x=0,y=0,z=-radius;
        yUp?_vertices.push(x,-z,y,0,0):_vertices.push(x,y,z,0,0);for(i=0;i<hnLat;i++){nLon=4*(i+1);dLon=360/nLon*D2R,lat=-PIH+(i+1)*dLat,v=(PIH+lat)/PI,sinLat=SIN(lat),cosLat=COS(lat),z=radius*sinLat;for(j=0;j<=nLon;j++)lon=j*dLon,sinLon=SIN(lon),cosLon=COS(lon),x=radius*cosLat*cosLon,y=radius*cosLat*sinLon,u=1-lon/PID,yUp?_vertices.push(x,-z,y,u,v):_vertices.push(x,y,z,u,v)}for(i=1;i<hnLat;i++){nLon=4*(hnLat-i),dLon=360/nLon*D2R,lat=dLat*i,v=(PIH+lat)/PI,sinLat=SIN(lat),cosLat=COS(lat),z=radius*sinLat;for(j=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0;j<=nLon;j++)lon=j*dLon,sinLon=SIN(lon),cosLon=COS(lon),x=radius*cosLat*cosLon,y=radius*cosLat*sinLon,u=1-lon/PID,yUp?_vertices.push(x,-z,y,u,v):_vertices.push(x,y,z,u,v)}x=0,y=0,z=radius,yUp?_vertices.push(x,-z,y,u,v):_vertices.push(x,y,z,u,v);var k,pt0,pt1,pt2,u_idx_start,u_idx_end,u_idx,l_idx_start,l_idx_end,l_idx,isUp,tris,triIdx;tris=1,u_idx_start=0,u_idx_end=0;for(i=0;i<hnLat;++i){l_idx_start=u_idx_start,l_idx_end=u_idx_end,u_idx_start+=4*i+1,u_idx_end+=4*(i+1)+1,l_idx=l_idx_start,u_idx=u_idx_start;
            for(k=0;k<4;++k){isUp=1;for(triIdx=0;triIdx<tris;++triIdx){if(isUp===1)pt0=l_idx,pt2=u_idx,u_idx++,pt1=u_idx,isUp=0;else pt0=u_idx,pt1=l_idx,l_idx++,pt2=l_idx,isUp=1;_indices.push(pt0,pt1,pt2)}}tris+=2}for(i=hnLat-1;i>=0;i--){l_idx_start=u_idx_start,l_idx_end=u_idx_end,u_idx_start=u_idx_start+4*(i+1)+1,u_idx_end=u_idx_end+4*i+1,tris-=2,u_idx=u_idx_start,l_idx=l_idx_start;for(k=0;k<4;++k){isUp=0;for(triIdx=0;triIdx<tris;triIdx++){if(isUp===1)pt0=l_idx,pt2=u_idx,u_idx++,pt1=u_idx,isUp=0;else pt0=u_idx,
            pt1=l_idx,l_idx++,pt2=l_idx,isUp=1;_indices.push(pt0,pt1,pt2)}}}var result=new Geometry(_vertices,_indices,[Vertex.x,Vertex.y,Vertex.z,Vertex.u,Vertex.v]);return result}})["static"]("skybox",{value:function skybox(splitX,splitY,splitZ){if(splitX==0||splitY==0||splitZ==0)this.error(0)}}).build()}();var Shading=MoGL.extend("Shading",{value:function Shading(){}}).constant("none",{value:"none"}).constant("gouraud",{value:"gouraud"}).constant("phong",{value:"phong"}).constant("blinn",{value:"blinn"}).constant("flat",
        {value:"flat"}).constant("toon",{value:"toon"}).build();var VertexShader={baseFunction:"mat4 positionMTX(vec3 t)"+"{\n"+"   return mat4( 1,0,0,0, 0,1,0,0, 0,0,1,0, t[0],t[1],t[2],1);\n"+"}\n"+"mat4 scaleMTX(vec3 t)"+"{\n"+"   return mat4( t[0],0,0,0, 0,t[1],0,0, 0,0,t[2],0, 0,0,0,1);\n"+"}\n"+"mat4 rotationMTX(vec3 t)"+"{\n"+"   float s = sin(t[0]);float c = cos(t[0]);\n"+"   mat4 m1 = mat4( 1,0,0,0, 0,c,s,0, 0,-s,c,0, 0,0,0,1);s = sin(t[1]);c = cos(t[1]);\n"+"   mat4 m2 = mat4(c,0,-s,0, 0,1,0,0, s,0,c,0,  0,0,0,1);s = sin(t[2]);c = cos(t[2]);\n"+
    "   mat4 m3 = mat4(c,s,0,0, -s,c,0,0, 0,0,1,0,  0,0,0,1);\n"+"   return m3*m2*m1;\n"+"}\n"};Object.freeze(VertexShader);var Shader=function(){var code;code={};$setPrivate("Shader",{});return MoGL.extend("Shader",{value:function Shader(v){code[this]=v}}).field("code",{get:$getter(code)}).constant("colorVertexShader",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"colorVertexShader",attributes:["vec3 aVertexPosition"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix",
            "vec3 uRotate","vec3 uScale","vec3 uPosition","vec4 uColor"],varyings:["vec4 vColor"],"function":[VertexShader.baseFunction],main:["gl_Position = uPixelMatrix*uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale)*vec4(aVertexPosition, 1.0);\n"+"vColor = uColor;"]}))}}()}).constant("colorFragmentShader",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"colorFragmentShader",precision:"mediump float",uniforms:[],varyings:["vec4 vColor"],"function":[],
            main:["gl_FragColor =  vColor"]}))}}()}).constant("wireFrameVertexShader",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"wireFrameVertexShader",attributes:["vec3 aVertexPosition"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix","vec3 uRotate","vec3 uScale","vec3 uPosition","vec4 uColor"],varyings:["vec4 vColor"],"function":[VertexShader.baseFunction],main:["gl_Position = uPixelMatrix*uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale)*vec4(aVertexPosition, 1.0);\n"+
        "vColor = uColor ;"]}))}}()}).constant("wireFrameFragmentShader",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"wireFrameFragmentShader",precision:"mediump float",uniforms:[],varyings:["vec4 vColor"],"function":[],main:["gl_FragColor =  vColor;"]}))}}()}).constant("bitmapVertexShader",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"bitmapVertexShader",attributes:["vec3 aVertexPosition","vec2 aUV"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix",
            "vec3 uRotate","vec3 uScale","vec3 uPosition"],varyings:["vec2 vUV"],"function":[VertexShader.baseFunction],main:["gl_Position = uPixelMatrix*uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale)*vec4(aVertexPosition, 1.0);\n"+"vUV = aUV;"]}))}}()}).constant("bitmapFragmentShader",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"bitmapFragmentShader",precision:"mediump float",uniforms:["sampler2D uSampler"],varyings:["vec2 vUV"],"function":[],main:["gl_FragColor =  texture2D(uSampler, vec2(vUV.s, vUV.t))"]}))}}()}).constant("colorVertexShaderGouraud",
        {get:function(){var cache;return function(){return cache||(cache=new Shader({id:"colorVertexShaderGouraud",attributes:["vec3 aVertexPosition","vec3 aVertexNormal"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix","vec3 uDLite","float uLambert","vec3 uRotate","vec3 uScale","vec3 uPosition","vec4 uColor"],varyings:["vec4 vColor"],"function":[VertexShader.baseFunction],main:[" mat4 mv = uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale);\n"+" gl_Position = uPixelMatrix*mv*vec4(aVertexPosition, 1.0);\n"+
            " vec3 N = (mv * vec4(aVertexNormal, 0.0)).xyz;\n"+" vec3 LD = normalize(vec4(uDLite, 0.0)).xyz;\n"+" float df = max(0.1,dot(N,-LD)*uLambert);\n"+" vColor = uColor*df;"+" vColor[3] = uColor[3];"]}))}}()}).constant("colorFragmentShaderGouraud",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"colorFragmentShaderGouraud",precision:"mediump float",uniforms:["sampler2D uSampler"],varyings:["vec4 vColor"],"function":[],main:["gl_FragColor =  vColor;\n"]}))}}()}).constant("bitmapVertexShaderGouraud",
        {get:function(){var cache;return function(){return cache||(cache=new Shader({id:"bitmapVertexShaderGouraud",attributes:["vec3 aVertexPosition","vec2 aUV","vec3 aVertexNormal"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix","vec3 uDLite","float uLambert","vec3 uRotate","vec3 uScale","vec3 uPosition"],varyings:["vec2 vUV","vec4 vLight"],"function":[VertexShader.baseFunction],main:[" mat4 mv = uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale);\n"+" gl_Position = uPixelMatrix*mv*vec4(aVertexPosition, 1.0);\n"+
            " vec3 N = (mv * vec4(aVertexNormal, 0.0)).xyz;\n"+" vec3 LD = normalize(vec4(uDLite, 0.0)).xyz;\n"+" float df = max(0.1,dot(N,-LD)*uLambert);\n"+" vLight = vec4(1.0,1.0,1.0,1.0)*df;\n"+" vLight[3] = 1.0;\n"+" vUV = aUV;"]}))}}()}).constant("bitmapFragmentShaderGouraud",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"bitmapFragmentShaderGouraud",precision:"mediump float",uniforms:["sampler2D uSampler"],varyings:["vec2 vUV","vec4 vLight"],"function":[],main:["gl_FragColor =  (vLight*texture2D(uSampler, vec2(vUV.s, vUV.t)));\n"+
            "gl_FragColor.a = 1.0;"]}))}}()}).constant("colorVertexShaderPhong",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"colorVertexShaderPhong",attributes:["vec3 aVertexPosition","vec3 aVertexNormal"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix","vec3 uRotate","vec3 uScale","vec3 uPosition","vec4 uColor"],varyings:["vec3 vNormal","vec3 vPosition","vec4 vColor"],"function":[VertexShader.baseFunction],main:[""+"mat4 mv = uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale);\n"+
            "gl_Position = uPixelMatrix*mv*vec4(aVertexPosition, 1.0);\n"+"vPosition = vec3(mv * vec4(aVertexPosition, 1.0));\n"+"vNormal = vec3(mv * vec4(-aVertexNormal, 0.0));\n"+"vColor = uColor;"]}))}}()}).constant("colorFragmentShaderPhong",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"colorFragmentShaderPhong",precision:"mediump float",uniforms:["float uLambert","vec3 uDLite"],varyings:["vec3 vNormal","vec3 vPosition","vec4 vColor"],"function":[],main:["vec3 ambientColor = vec3(0.0, 0.0, 0.0);\n"+
            "vec3 diffuseColor = vec3(1.0, 1.0, 1.0);\n"+"vec3 specColor = vec3(1.0, 1.0, 1.0);\n"+"vec3 normal = normalize(vNormal);\n"+"vec3 lightDir = uDLite;\n"+"vec3 reflectDir = reflect(lightDir, normal);\n"+"vec3 viewDir = normalize(-vPosition);\n"+"float lambertian = max(dot(lightDir,normal), 0.1)*uLambert;\n"+"float specular = 0.0;\n"+"if(lambertian > 0.0) {\n"+"float specAngle = max(dot(reflectDir, viewDir), 0.0);\n"+"   specular = pow(specAngle, 4.0);\n"+"}\n"+"gl_FragColor = vColor*vec4(ambientColor +lambertian*diffuseColor +specular*specColor, 1.0);\n"+
            "gl_FragColor.a = vColor[3];"]}))}}()}).constant("toonVertexShaderPhong",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"toonVertexShaderPhong",attributes:["vec3 aVertexPosition","vec3 aVertexNormal"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix","vec3 uRotate","vec3 uScale","vec3 uPosition","vec4 uColor"],varyings:["vec3 vNormal","vec3 vPosition","vec4 vColor"],"function":[VertexShader.baseFunction],main:["mat4 mv = uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale);\n"+
            "gl_Position = uPixelMatrix*mv*vec4(aVertexPosition, 1.0);\n"+"vPosition = vec3(mv * vec4(aVertexPosition, 1.0));\n"+"vNormal = (vec3( mv * vec4(-aVertexNormal, 0.0)));\n"+"vColor = uColor;"]}))}}()}).constant("toonFragmentShaderPhong",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"toonFragmentShaderPhong",precision:"mediump float",uniforms:["float uLambert","vec3 uDLite"],varyings:["vec3 vNormal","vec3 vPosition","vec4 vColor"],"function":[],main:["vec3 ambientColor = vec3(0.0, 0.0, 0.0);\n"+
            "vec3 diffuseColor = vec3(1.0, 1.0, 1.0);\n"+"vec3 specColor = vec3(1.0, 1.0, 1.0);\n"+"vec3 normal = normalize(vNormal);\n"+"vec3 lightDir = uDLite;\n"+"vec3 reflectDir = reflect(lightDir, normal);\n"+"vec3 viewDir = normalize(-vPosition);\n"+"float lambertian = max(dot(lightDir,normal), 0.1)*uLambert;\n"+"float specular = 0.0;\n"+"vec3 src = vColor.rgb;\n"+"if(lambertian > 0.0) {\n"+"float specAngle = max(dot(reflectDir, viewDir), 0.0);\n"+"   specular = pow(specAngle, 4.0);\n"+"}\n"+"src = src*(ambientColor +lambertian*diffuseColor +specular*specColor);\n"+
            " if(lambertian>0.95-0.5) src.rgb*=0.95;\n"+" else if(lambertian>0.4-0.5) src.rgb*=0.5;\n"+" else if(lambertian>0.3-0.5) src.rgb*=0.3;\n"+" else src.rgb*=0.1;\n"+"gl_FragColor.rgb = src.rgb;\n"+"gl_FragColor.a = vColor[3];"]}))}}()}).constant("bitmapVertexShaderPhong",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"bitmapVertexShaderPhong",attributes:["vec3 aVertexPosition","vec2 aUV","vec3 aVertexNormal"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix","vec3 uRotate",
                "vec3 uScale","vec3 uPosition"],varyings:["vec2 vUV","vec3 vNormal","vec3 vPosition"],"function":[VertexShader.baseFunction],main:["mat4 mv = uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale);\n"+"gl_Position = uPixelMatrix*mv*vec4(aVertexPosition, 1.0);\n"+"vPosition = vec3(mv * vec4(aVertexPosition, 1.0));\n"+"vNormal = (vec3( mv * vec4(-aVertexNormal, 0.0)));\n"+"vUV = aUV;"]}))}}()}).constant("bitmapFragmentShaderPhong",{get:function(){var cache;return function(){return cache||
            (cache=new Shader({id:"bitmapFragmentShaderPhong",precision:"mediump float",uniforms:["sampler2D uSampler","float uLambert","vec3 uDLite"],varyings:["vec2 vUV","vec3 vNormal","vec3 vPosition"],"function":[],main:["vec3 ambientColor = vec3(0.0, 0.0, 0.0);\n"+"vec3 diffuseColor = vec3(1.0, 1.0, 1.0);\n"+"vec3 specColor = vec3(1.0, 1.0, 1.0);\n"+"vec3 normal = normalize(vNormal);\n"+"vec3 lightDir = uDLite;\n"+"vec3 reflectDir = reflect(lightDir, normal);\n"+"vec3 viewDir = normalize(-vPosition);\n"+
            "float lambertian = max(dot(lightDir,normal), 0.1)*uLambert;\n"+"float specular = 0.0;\n"+"if(lambertian > 0.0) {\n"+"float specAngle = max(dot(reflectDir, viewDir), 0.1);\n"+"   specular = pow(specAngle, 4.0)*uLambert;\n"+"}\n"+"gl_FragColor = texture2D(uSampler, vec2(vUV.s, vUV.t))*vec4(ambientColor +lambertian*diffuseColor +specular*specColor, 1.0);\n"+"gl_FragColor.a = 1.0;"]}))}}()}).constant("bitmapVertexShaderBlinn",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"bitmapVertexShaderBlinn",
                attributes:["vec3 aVertexPosition","vec2 aUV","vec3 aVertexNormal"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix","vec3 uRotate","vec3 uScale","vec3 uPosition"],varyings:["vec2 vUV","vec3 vNormal","vec3 vPosition"],"function":[VertexShader.baseFunction],main:[""+"mat4 mv = uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale);\n"+"gl_Position = uPixelMatrix*mv*vec4(aVertexPosition, 1.0);\n"+"vPosition = vec3(mv * vec4(aVertexPosition, 1.0));\n"+"vNormal = vec3( mv * vec4(-aVertexNormal, 0.0));\n"+
                "vUV = aUV;"]}))}}()}).constant("bitmapFragmentShaderBlinn",{get:function(){var cache;return function(){return cache||(cache=new Shader({id:"bitmapFragmentShaderBlinn",precision:"mediump float",uniforms:["sampler2D uSampler","float uLambert","vec3 uDLite"],varyings:["vec2 vUV","vec3 vNormal","vec3 vPosition"],"function":[],main:[""+"vec3 ambientColor = vec3(0.0, 0.0, 0.0);\n"+"vec3 diffuseColor = vec3(1.0, 1.0, 1.0);\n"+"vec3 specColor = vec3(1.0, 1.0, 1.0);\n"+"vec3 normal = normalize(vNormal);\n"+
            "vec3 lightDir = uDLite;\n"+"float lambertian = max(dot(lightDir,normal), 0.1)*uLambert;\n"+"float specular = 0.0;\n"+"vec3 viewDir = normalize(vPosition);\n"+"if(lambertian > 0.0) {\n"+"   vec3 halfDir = normalize(lightDir + viewDir);\n"+"   float specAngle = max(dot(halfDir, normal), 0.0);\n"+"   specular = pow(specAngle, 16.0);\n"+"}\n"+"gl_FragColor = texture2D(uSampler, vec2(vUV.s, vUV.t))*vec4(ambientColor +lambertian*diffuseColor +specular*specColor, 1.0);\n"+"gl_FragColor.a = 1.0;"]}))}}()}).constant("postBaseVertexShader",
        {get:function(){var cache;return function(){return cache||(cache=new Shader({id:"postBaseVertexShader",attributes:["vec3 aVertexPosition","vec2 aUV"],uniforms:["mat4 uPixelMatrix","mat4 uCameraMatrix","vec3 uRotate","vec3 uScale","vec3 uPosition"],varyings:["vec2 vUV"],"function":[VertexShader.baseFunction],main:[""+"gl_Position = uPixelMatrix*uCameraMatrix*positionMTX(uPosition)*rotationMTX(uRotate)*scaleMTX(uScale)*vec4(aVertexPosition, 1.0);\n"+"vUV = aUV;"]}))}}()}).constant("postBaseFragmentShader",
        {get:function(){var cache;return function(){return cache||(cache=new Shader({id:"postBaseFragmentShader",precision:"mediump float",uniforms:["sampler2D uSampler","vec2 uTexelSize","int uFXAA"],varyings:["vec2 vUV"],"function":[],main:[""+"if(uFXAA==1){\n"+"float FXAA_REDUCE_MIN = (1.0/128.0);\n"+"float FXAA_REDUCE_MUL = (1.0/8.0);\n"+"float FXAA_SPAN_MAX = 8.0;\n"+"vec4 rgbNW = texture2D(uSampler, (vUV + vec2(-1.0, -1.0) * uTexelSize));\n"+"vec4 rgbNE = texture2D(uSampler, (vUV + vec2(1.0, -1.0) * uTexelSize));\n"+
            "vec4 rgbSW = texture2D(uSampler, (vUV + vec2(-1.0, 1.0) * uTexelSize));\n"+"vec4 rgbSE = texture2D(uSampler, (vUV + vec2(1.0, 1.0) * uTexelSize));\n"+"vec4 rgbM = texture2D(uSampler, vUV);\n"+"vec4 luma = vec4(0.299, 0.587, 0.114, 1.0);\n"+"float lumaNW = dot(rgbNW, luma);\n"+"float lumaNE = dot(rgbNE, luma);\n"+"float lumaSW = dot(rgbSW, luma);\n"+"float lumaSE = dot(rgbSE, luma);\n"+"float lumaM = dot(rgbM, luma);\n"+"float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n"+
            "float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n"+"vec2 dir = vec2(-((lumaNW + lumaNE) - (lumaSW + lumaSE)), ((lumaNW + lumaSW) - (lumaNE + lumaSE)));\n"+"float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),FXAA_REDUCE_MIN);\n"+"float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n"+"dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n"+"max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n"+"dir * rcpDirMin)) * uTexelSize;\n"+"vec4 rgbA = 0.5 * ("+
            "   texture2D(uSampler, vUV + dir * (1.0 / 3.0 - 0.5))+"+"   texture2D(uSampler, vUV + dir * (2.0 / 3.0 - 0.5))"+");\n"+"vec4 rgbB = rgbA * 0.5 + 0.25 * (texture2D(uSampler, vUV + dir *  -0.5)+texture2D(uSampler, vUV + dir * 0.5));\n"+"float lumaB = dot(rgbB, luma);\n"+"if ((lumaB < lumaMin) || (lumaB > lumaMax)) {\n"+"   gl_FragColor = rgbA;\n"+"}\n"+"else {\n"+"   gl_FragColor = rgbB;\n"+"}\n"+"}else{\n"+"   gl_FragColor =  texture2D(uSampler, vec2(vUV.s, vUV.t));"+"}"+""]}))}}()}).build()}();var Matrix=
        function(){var temp,setter,getter,raw;raw={},temp=new Float32Array(16),setter=function(x,y,z){return function(v){if(v)if("0"in v)this[x]=v[0],this[y]=v[1],this[z]=v[2];else{if(x in arg)this[x]=v[x],this[y]=v[y],this[z]=v[z]}else this[x]=this[y]=this[z]=0}},getter=function(x,y,z){var result=new Float32Array(3);return function(v){result[0]=this[x],result[1]=this[y],result[2]=this[z];return result}};return MoGL.extend("Matrix",{value:function Matrix(){raw[this]=new Float32Array(16);this.matIdentity();
            this.x=this.y=this.z=this.rotateX=this.rotateY=this.rotateZ=0,this.scaleX=this.scaleY=this.scaleZ=1}}).field("position",{set:setter("x","y","z"),get:getter("x","y","z")}).field("scale",{set:setter("scaleX","scaleY","scaleZ"),get:getter("scaleX","scaleY","scaleZ")}).field("rotate",{set:setter("rotateX","rotateY","rotateZ"),get:getter("rotateX","rotateY","rotateZ")}).field("matrix",{get:function matrixGet(){if(this instanceof Camera)this.matIdentity().matScale(this.scaleX,this.scaleY,this.scaleZ).matRotateX(this.rotateX).matRotateY(this.rotateY).matRotateZ(this.rotateZ).matTranslate(this.x,
            this.y,-this.z);else this.matIdentity().matScale(this.scaleX,this.scaleY,this.scaleZ).matRotateX(this.rotateX).matRotateY(this.rotateY).matRotateZ(this.rotateZ).matTranslate(this.x,this.y,this.z);return this}}).field("raw",{get:function rawGet(){return raw[this]}}).method("lookAt",{value:function(){var A=new Float32Array(3),B=new Float32Array(3);return function lookAt(x,y,z){var d,d11,d12,d13,d21,d22,d23,d31,d32,d33,md31,radianX,radianY,radianZ,cosY;this.matIdentity(),A[0]=this.x,A[1]=this.y,A[2]=
            this.z,B[0]=x,B[1]=y,B[2]=z,this.matLookAt(A,B,[0,1,0]),d=raw[this],d11=d[0],d12=d[1],d13=d[2],d21=d[4],d22=d[5],d23=d[6],d31=d[8],d32=d[9],d33=d[10],md31=-d31;if(md31<=-1)radianY=-PIH;else if(1<=md31)radianY=PIH;else radianY=ASIN(md31);cosY=COS(radianY);if(cosY<=.001)radianZ=0,radianX=ATAN2(-d23,d22);else radianZ=ATAN2(d21,d11),radianX=ATAN2(d32,d33);this.rotateX=radianX,this.rotateY=radianY,this.rotateZ=radianZ}}()}).method("matIdentity",{value:function matIdentity(){var a=raw[this];a[0]=1,a[1]=
            0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1;return this}}).method("matClone",{value:function matClone(){var a,b,out;a=raw[this],out=new Matrix,b=raw[out];b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15];return out}}).method("matCopy",{value:function matCopy(t){var a=raw[this];t=raw[t];t[0]=a[0],t[1]=a[1],t[2]=a[2],
            t[3]=a[3],t[4]=a[4],t[5]=a[5],t[6]=a[6],t[7]=a[7],t[8]=a[8],t[9]=a[9],t[10]=a[10],t[11]=a[11],t[12]=a[12],t[13]=a[13],t[14]=a[14],t[15]=a[15];return this}}).method("matMultiply",{value:function matMultiply(t){var a=raw[this];t=raw[t];var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=t[0],b1=t[1],b2=t[2],b3=t[3];a[0]=a00*b0+a10*b1+a20*b2+a30*b3,a[1]=a01*b0+a11*b1+a21*b2+a31*b3,a[2]=a02*b0+
        a12*b1+a22*b2+a32*b3,a[3]=a03*b0+a13*b1+a23*b2+a33*b3,b0=t[4],b1=t[5],b2=t[6],b3=t[7],a[4]=a00*b0+a10*b1+a20*b2+a30*b3,a[5]=a01*b0+a11*b1+a21*b2+a31*b3,a[6]=a02*b0+a12*b1+a22*b2+a32*b3,a[7]=a03*b0+a13*b1+a23*b2+a33*b3,b0=t[8],b1=t[9],b2=t[10],b3=t[11],a[8]=a00*b0+a10*b1+a20*b2+a30*b3,a[9]=a01*b0+a11*b1+a21*b2+a31*b3,a[10]=a02*b0+a12*b1+a22*b2+a32*b3,a[11]=a03*b0+a13*b1+a23*b2+a33*b3,b0=t[12],b1=t[13],b2=t[14],b3=t[15],a[12]=a00*b0+a10*b1+a20*b2+a30*b3,a[13]=a01*b0+a11*b1+a21*b2+a31*b3,a[14]=a02*b0+
        a12*b1+a22*b2+a32*b3,a[15]=a03*b0+a13*b1+a23*b2+a33*b3;return this}}).method("matTranslate",{value:function matTranslate(x,y,z){var a=raw[this];a[12]=a[0]*x+a[4]*y+a[8]*z+a[12];a[13]=a[1]*x+a[5]*y+a[9]*z+a[13];a[14]=a[2]*x+a[6]*y+a[10]*z+a[14];a[15]=a[3]*x+a[7]*y+a[11]*z+a[15];return this}}).method("matScale",{value:function matScale(x,y,z){var a=raw[this];a[0]=a[0]*x,a[1]=a[1]*x,a[2]=a[2]*x,a[3]=a[3]*x,a[4]=a[4]*y,a[5]=a[5]*y,a[6]=a[6]*y,a[7]=a[7]*y,a[8]=a[8]*z,a[9]=a[9]*z,a[10]=a[10]*z,a[11]=a[11]*
        z,a[12]=a[12],a[13]=a[13],a[14]=a[14],a[15]=a[15];return this}}).method("matRotateX",{value:function matRotateX(rad){var a=raw[this],s=SIN(rad),c=COS(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];a[4]=a10*c+a20*s,a[5]=a11*c+a21*s,a[6]=a12*c+a22*s,a[7]=a13*c+a23*s,a[8]=a20*c-a10*s,a[9]=a21*c-a11*s,a[10]=a22*c-a12*s,a[11]=a23*c-a13*s;return this}}).method("matRotateY",{value:function matRotateY(rad){var a=raw[this],s=SIN(rad),c=COS(rad),a00=a[0],a01=a[1],a02=a[2],a03=
            a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];a[0]=a00*c-a20*s,a[1]=a01*c-a21*s,a[2]=a02*c-a22*s,a[3]=a03*c-a23*s,a[8]=a00*s+a20*c,a[9]=a01*s+a21*c,a[10]=a02*s+a22*c,a[11]=a03*s+a23*c;return this}}).method("matRotateZ",{value:function matRotateZ(rad){var a=raw[this],s=SIN(rad),c=COS(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];a[0]=a00*c+a10*s,a[1]=a01*c+a11*s,a[2]=a02*c+a12*s,a[3]=a03*c+a13*s,a[4]=a10*c-a00*s,a[5]=a11*c-a01*s,a[6]=a12*c-a02*s,a[7]=a13*c-a03*s;return this}}).method("matRotate",
            {value:function matRotate(rad,axis){var a=raw[this];var x=axis[0],y=axis[1],z=axis[2],len=SQRT(x*x+y*y+z*z),s,c,t,a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(ABS(len)<GLMAT_EPSILON)return null;len=1/len,x*=len,y*=len,z*=len,s=SIN(rad),c=COS(rad),t=1-c,a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],b00=x*x*t+c,b01=y*x*t+z*s,b02=z*x*t-y*s,b10=x*y*t-z*s,b11=y*y*t+c,b12=z*y*t+x*s,b20=x*z*t+y*s,b21=
                y*z*t-x*s,b22=z*z*t+c,a[0]=a00*b00+a10*b01+a20*b02,a[1]=a01*b00+a11*b01+a21*b02,a[2]=a02*b00+a12*b01+a22*b02,a[3]=a03*b00+a13*b01+a23*b02,a[4]=a00*b10+a10*b11+a20*b12,a[5]=a01*b10+a11*b11+a21*b12,a[6]=a02*b10+a12*b11+a22*b12,a[7]=a03*b10+a13*b11+a23*b12,a[8]=a00*b20+a10*b21+a20*b22,a[9]=a01*b20+a11*b21+a21*b22,a[10]=a02*b20+a12*b21+a22*b22,a[11]=a03*b20+a13*b21+a23*b22;if(a!==a)a[12]=a[12],a[13]=a[13],a[14]=a[14],a[15]=a[15];return this}}).method("frustum",{value:function frustum(a,b,c,d,e,g){var f=
                raw[this];var h=b-a,i=d-c,j=g-e;f[0]=e*2/h,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=e*2/i,f[6]=0,f[7]=0,f[8]=(b+a)/h,f[9]=(d+c)/i,f[10]=-(g+e)/j,f[11]=-1,f[12]=0,f[13]=0,f[14]=-(g*e*2)/j,f[15]=0;return this}}).method("matPerspective",{value:function matPerspective(fov,aspect,near,far){fov=near*Math.tan(fov*Math.PI/360),aspect=fov*aspect,this.frustum(-aspect,aspect,-fov,fov,near,far);return this}}).method("matLookAt",{value:function matLookAt(eye,center,up){var a=raw[this];var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,
                eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];if(ABS(eyex-centerx)<GLMAT_EPSILON&&ABS(eyey-centery)<GLMAT_EPSILON&&ABS(eyez-centerz)<GLMAT_EPSILON)return this.matIdentity();z0=eyex-centerx,z1=eyey-centery,z2=eyez-centerz,len=1/SQRT(z0*z0+z1*z1+z2*z2),z0*=len,z1*=len,z2*=len,x0=upy*z2-upz*z1,x1=upz*z0-upx*z2,x2=upx*z1-upy*z0,len=SQRT(x0*x0+x1*x1+x2*x2);if(!len)x0=0,x1=0,x2=0;else len=1/len,x0*=len,x1*=len,x2*=len;y0=z1*x2-z2*
            x1,y1=z2*x0-z0*x2,y2=z0*x1-z1*x0,len=SQRT(y0*y0+y1*y1+y2*y2);if(!len)y0=0,y1=0,y2=0;else len=1/len,y0*=len,y1*=len,y2*=len;a[0]=x0,a[1]=y0,a[2]=z0,a[3]=0,a[4]=x1,a[5]=y1,a[6]=z1,a[7]=0,a[8]=x2,a[9]=y2,a[10]=z2,a[11]=0,a[12]=-(x0*eyex+x1*eyey+x2*eyez),a[13]=-(y0*eyex+y1*eyey+y2*eyez),a[14]=-(z0*eyex+z1*eyey+z2*eyez),a[15]=1;return this}}).method("matStr",{value:function matStr(){var a=raw[this];return"Matrix("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+
                a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"}}).build()}();var Texture=function(){var imgType,canvas,context,empty,resizer,resize,imgs,loaded,isLoaded;resize={},imgs={},isLoaded={},$setPrivate("Texture",{imgs:imgs}),imgType={".jpg":1,".png":1,".gif":1},canvas=document.createElement("canvas"),context=canvas.getContext("2d"),canvas.width=canvas.height=2,context.clearRect(0,0,2,2),empty=document.createElement("img"),empty.src=canvas.toDataURL(),resizer=function(resizeType,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             v){var tw,th;tw=th=1;while(v.width>tw)tw*=2;while(v.height>th)th*=2;if(resizeType==Texture.zoomOut){if(v.width<tw)tw/=2;if(v.height<th)th/=2}canvas.width=tw,canvas.height=th,context.clearRect(0,0,tw,th);switch(resizeType){case Texture.crop:var ratio=v.height/v.width;if(v.height<th){v.height=th;v.width=v.height/ratio}context.drawImage(v,0,0,v.width,v.height);break;case Texture.addSpace:if(v.width<tw)tw=Math.round(v.width);if(v.height<th)th=Math.round(v.height);context.drawImage(v,0,0,tw,th);break;
        default:context.drawImage(v,0,0,tw,th)}v.src=canvas.toDataURL();return v},loaded=function(e){var texture=Texture.getInstance(this.dataset.texture);isLoaded[texture]=true,imgs[texture]=resizer(texture.resizeType,this),this.removeEventListener("load",loaded);texture.dispatch("load")};return MoGL.extend("Texture",{value:function Texture(){}}).field("resizeType",{get:$getter(resize,false,"zoomOut"),set:function resizeTypeSet(v){if(Texture[v])resize[this]=v;else this.error(0)}}).field("isLoaded",{get:$getter(isLoaded,
        false,false)}).field("img",{get:$getter(imgs,false,empty),set:function imgSet(v){var complete,img,w,h;complete=false,img=document.createElement("img");if(v instanceof HTMLImageElement){img.src=v.src;if(img.complete)complete=true}else if(v instanceof ImageData)complete=true,canvas.width=w=v.width,canvas.height=h=v.height,context.clearRect(0,0,w,h),context.putImageData(v,0,0),img.src=context.toDataURL();else if(typeof v=="string"){if(v.substring(0,10)=="data:image"&&v.indexOf("base64")>-1)complete=
        true;else if(!imgType[v.substring(-4)])this.error(1);img.src=v}else this.error(0);if(complete){isLoaded[this]=true,img.dataset.cls=Texture;img.dataset.texture=this.uuid;imgs[this]=resizer(this.resizeType,img),this.dispatch("load")}else{img.dataset.cls=Texture;img.dataset.texture=this.uuid;img.addEventListener("load",loaded)}}}).event("load",{value:"load"}).constant("zoomOut",{value:"zoomOut"}).constant("zoomIn",{value:"zoomIn"}).constant("crop",{value:"crop"}).constant("addSpace",{value:"addSpace"}).constant("diffuse",
        {value:"diffuse"}).constant("specular",{value:"specular"}).constant("diffuseWrap",{value:"diffuseWrap"}).constant("normal",{value:"normal"}).constant("specularNormal",{value:"specularNormal"}).build()}();var Geometry=function(){var position,vertexCount,triangleCount,vertexShaders,normal,index,uv,color,volume,key;position={},normal={},uv={},color={},index={},vertexCount={},triangleCount={},vertexShaders={},volume={};$setPrivate("Geometry",{});return MoGL.extend("Geometry",{value:function(){var calcNormal,
        infoCheck,pos,nm,tUV,tCo;calcNormal=function(){var sqr,v1,v2;sqr=Math.sqrt,v1={x:0,y:0,z:0},v2={x:0,y:0,z:0};return function calcNormal(ns,pos,idx){var i,j,k,l;for(ns.length=0,i=0,j=pos.length;i<j;i++)ns[i]=0;for(i=0,j=idx.length;i<j;i+=3){k=3*idx[i+1],l=3*idx[i],v1.x=pos[k]-pos[l],v1.y=pos[k+1]-pos[l+1],v1.z=pos[k+2]-pos[l+2],l=3*idx[i+2],v2.x=pos[l]-pos[k],v2.y=pos[l+1]-pos[k+1],v2.z=pos[l+2]-pos[k+2];for(k=0;k<3;k++)l=3*idx[i+k],ns[l]+=v1.y*v2.z-v1.z*v2.y,ns[l+1]+=v1.z*v2.x-v1.x*v2.z,ns[l+2]+=
        v1.x*v2.y-v1.y*v2.x}for(i=0,j=pos.length;i<j;i+=3)v1.x=ns[i],v1.y=ns[i+1],v1.z=ns[i+2],k=sqr(v1.x*v1.x+v1.y*v1.y+v1.z*v1.z)||1E-5,ns[i]=v1.x/k,ns[i+1]=v1.y/k,ns[i+2]=v1.z/k;return ns}}(),infoCheck=function(v){return Vertex[v]},pos=[],nm=[],tUV=[],tCo=[];return function Geometry(vertex,tIndex,info){var len,i,j,k,isNormal,isUV,isColor;if(!Array.isArray(vertex)&&!(vertex instanceof Float32Array))this.error(0);else if(!Array.isArray(tIndex)&&!(tIndex instanceof Uint16Array))this.error(1);pos.length=nm.length=
        tUV.length=tCo.length=0;if(info){if(!Array.isArray(info))this.error(3);else if(!info.some(infoCheck))this.error(4);len=info.length;if(vertex.length%len)this.error(2);i=len;while(i--)info[info[i]]=i;isNormal=info.normalX&&info.normalY&&info.normalZ,isUV=info.u&&info.v,isColor=info.r&&info.g&&info.b&&info.a;for(i=0,j=vertex.length/len;i<j;i++){k=len*i,pos.push(vertex[k+info.x],vertex[k+info.y],vertex[k+info.z]);if(isNormal)nm.push(vertex[k+info.normalX],vertex[k+info.normalY],vertex[k+info.normalZ]);
        if(isUV)tUV.push(vertex[k+info.u],vertex[k+info.v]);if(isColor)tCo.push(vertex[k+info.r],vertex[k+info.g],vertex[k+info.b],vertex[k+info.a])}position[this]=new Float32Array(pos)}else{len=3;position[this]=vertex instanceof Float32Array?vertex:new Float32Array(vertex)}if(!isNormal)calcNormal(nm,info?pos:vertex,tIndex);normal[this]=new Float32Array(nm);vertexCount[this]=vertex.length/len,triangleCount[this]=tIndex.length/3,uv[this]=new Float32Array(tUV),color[this]=new Float32Array(tCo),index[this]=
        tIndex instanceof Uint16Array?tIndex:new Uint16Array(tIndex)}}()}).field("vertexCount",{get:$getter(vertexCount)}).field("triangleCount",{get:$getter(triangleCount)}).field("volume",{get:function volumeGet(){var minX,minY,minZ,maxX,maxY,maxZ,t0,t1,t2,t,i;if(!volume[this]){minX=minY=minZ=maxX=maxY=maxZ=0,t=position[this],i=t.length;while(i--)t0=i*3,t1=t0+1,t2=t0+2,minX=t[t0]<minX?t[t0]:minX,maxX=t[t0]>maxX?t[t0]:maxX,minY=t[t1]<minY?t[t1]:minY,maxY=t[t1]>maxY?t[t1]:maxY,minZ=t[t2]<minZ?t[t2]:minZ,
        maxZ=t[t2]>maxZ?t[t2]:maxZ;volume[this]=[maxX-minX,maxY-minY,maxZ-minZ]}return volume[this]}}).field("position",{get:$getter(position)}).field("normal",{get:$getter(normal)}).field("uv",{get:$getter(uv)}).field("color",{get:$getter(color)}).field("index",{get:$getter(index)}).build()}();var Material=function(){var textureLoaded,texType,diffuse,normal,specular,diffuseWrap,specularNormal,shading,lambert,wireFrame,wireFrameColor,count,color;shading={},lambert={},diffuse={},normal={},specular={},diffuseWrap=
    {},specularNormal={},wireFrame={},wireFrameColor={},count={},color={},$setPrivate("Material",{color:color,wireFrame:wireFrame,wireFrameColor:wireFrameColor,shading:shading,lambert:lambert,diffuse:diffuse}),textureLoaded=function(mat){this.removeEventListener(Texture.load,textureLoaded),mat.dispatch(Material.changed);if(mat.isLoaded)mat.dispatch(Material.load)},texType={diffuse:diffuse,specular:specular,diffuseWrap:diffuseWrap,normal:normal,specularNormal:specularNormal};return MoGL.extend("Material",
        {value:function Material(){color[this]=[1,1,1,1];if(arguments.length)this.color=arguments.length>1?arguments:arguments[0];wireFrameColor[this]=[Math.random(),Math.random(),Math.random(),1];wireFrame[this]=false;lambert[this]=1;shading[this]=Shading.none}}).field("count",{get:$getter(count,false,0)}).field("color",{get:$getter(color),set:function colorSet(v){var p=color[this];v=$color(v);p[0]=v[0],p[1]=v[1],p[2]=v[2],p[3]=v[3]}}).field("wireFrame",{get:$getter(wireFrame),set:$setter(wireFrame)}).field("wireFrameColor",
        {get:$getter(wireFrameColor),set:function wireFrameColorSet(v){var p=wireFrameColor[this];v=$color(v);p[0]=v[0],p[1]=v[1],p[2]=v[2],p[3]=v[3]}}).field("shading",{get:$getter(shading),set:$setter(shading)}).field("lambert",{get:$getter(lambert),set:$setter(lambert)}).field("diffuse",{get:$getter(diffuse)}).field("isLoaded",{get:function(mat){var type,tex,i;for(type in texType)if(tex=texType[type][mat]){i=tex.length;while(i--)if(!tex[i].tex.isLoaded)return false}return true}}).method("addTexture",{value:function addTexture(type,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       texture){var p,i=arguments[2];if(!texType[type])this.error(0);if(!(texture instanceof Texture))this.error(1);p=texType[type];if(this in p){p=p[this];if(p[texture])this.error(2)}else p=p[this]=[];p[texture]=1;if(!texture.isLoaded)texture.addEventListener(Texture.load,textureLoaded,null,this);texture={tex:texture};if(arguments.length>3)texture.blendMode=arguments[3];if(i===undefined||i===null)p[p.length]=texture;else if(typeof i=="number")if(i<0||i>p.length-1)this.error(4);else p.splice(i,0,texture);
        else if(i instanceof Texture){i=p.indexOf(i);if(i>-1)p.splice(i,0,texture);else this.error(5)}else this.error(3);this.dispatch(Material.changed);if(this.isLoaded)this.dispatch(Material.load);return this}}).method("removeTexture",{value:function removeTexture(type,texture){var p,key,i;if(texType[type]){p=texType[type][this];if(p[texture]){p[texture]=0;i=p.length;p.splice(p.indexOf(texture),1);delete p[texture]}}else for(key in texType){p=texType[key][this];if(p[texture]){p[texture]=0;p.splice(p.indexOf(texture),
            1);delete p[texture]}}this.dispatch(Material.changed);return this}}).event("changed","changed").build()}();var Mesh=function(){var geometry,material,culling;geometry={},material={},culling={};$setPrivate("Mesh",{geometry:geometry,material:material,culling:culling});return Matrix.extend("Mesh",{value:function Mesh(geometry,material){this.geometry=geometry;this.material=material}}).field("culling",{get:$getter(culling,false,"cullingNone"),set:function cullingSet(v){if(Mesh[v])culling[this]=v;else this.error(0)}}).field("geometry",
        {get:$getter(geometry),set:function geometrySet(v){if(v instanceof Geometry){geometry[this]=v;this.dispatch("changed")}else this.error(0)}}).field("material",{get:$getter(material),set:function materialSet(v){if(v instanceof Material){material[this]=v;this.dispatch("changed")}else this.error(0)}}).constant("cullingNone",{value:"cullingNone"}).constant("cullingFront",{value:"cullingFront"}).constant("cullingBack",{value:"cullingBack"}).event("changed","changed").build()}();var Group=Matrix.extend("Group",
        {value:function Group(){}}).method("addChild",{value:function addChild(mesh){return this}}).method("getChild",{value:function getChild(id){return null}}).method("removeChild",{value:function removeChild(id){return this}}).build();var Camera=function(){var PERPIR,prop;PERPIR=D2R*.5,prop={},$setPrivate("Camera",{});return Matrix.extend("Camera",{value:function Camera(){Object.seal(prop[this]={r:0,g:0,b:0,a:1,fov:55,near:.1,far:1E4,fog:false,fogColor:null,fogNear:0,fogFar:0,visible:true,antialias:false,
        mode:Camera.perspective,renderArea:null,projectionMatrix:Matrix()}),this.z=10,this.lookAt(0,0,0)}}).field("clipPlaneNear",{get:$getter(prop,"near"),set:$setter(prop,"near")}).field("clipPlaneFar",{get:$getter(prop,"far"),set:$setter(prop,"far")}).field("visible",{get:$getter(prop,"visible"),set:function visibleSet(v){if(typeof v=="number")v=v?true:false;prop[this].visible=v}}).field("antialias",{get:$getter(prop,"antialias"),set:function antialiasSet(v){if(typeof v=="number")v=v?true:false;prop[this].antialias=
        v}}).field("fogColor",{get:$getter(prop,"fogColor"),set:function fogColorSet(v){var p=prop[this];p.fogColor=$color(v).slice(0),p.fog=true}}).field("fogNear",{get:$getter(prop,"fogNear"),set:function fogNearSet(v){var p=prop[this];p.fogNear=v,p.fog=true}}).field("fogFar",{get:$getter(prop,"fogFar"),set:function fogFarSet(v){var p=prop[this];p.fogFar=v,p.fog=true}}).field("fov",{get:$getter(prop,"fov"),set:function fovSet(v){var p=prop[this];if(typeof v=="number")p.fov=v;else if("0"in v&&"1"in v)p.fov=
        CEIL(2*ATAN(TAN(v[2]*PERPIR)*(v[1]/v[0]))*R2D)}}).field("backgroundColor",{get:function(){var a=[];return function backgroundColorGet(){var p=prop[this];a[0]=p.r,a[1]=p.g,a[2]=p.b,a[3]=p.a;return a}}(),set:function backgroundColorSet(v){var p=prop[this];v=$color(v);p.r=v[0],p.g=v[1],p.b=v[2],p.a=v[3]}}).field("fog",{get:function fogGet(){return prop[this].fog?true:false}}).field("mode",{get:$getter(prop,"mode"),set:function modeSet(v){if(Camera[v])prop[this].mode=v;else this.error(0)}}).field("renderArea",
        {get:$getter(prop,"renderArea"),set:function renderAreaSet(v){prop[this].renderArea=v}}).field("projectionMatrix",{get:function projectionMatrixGet(){return prop[this].projectionMatrix}}).method("resetProjectionMatrix",{value:function resetProjectionMatrix(){var tMatrix,tArea,p;p=prop[this];tMatrix=p.projectionMatrix,tArea=p.renderArea,tMatrix.matIdentity();if(this._mode=="2d"){tMatrix.raw[0]=2/tArea[2];tMatrix.raw[5]=-2/tArea[3];tMatrix.raw[10]=0;tMatrix.raw[12]=-1;tMatrix.raw[13]=1}else tMatrix.matPerspective(p.fov,
            tArea[2]/tArea[3],p.near,p.far);return this}}).constant("orthogonal",{value:"orthogonal"}).constant("perspective",{value:"perspective"}).build()}();var Scene=function(){var vertexShaderParser,fragmentShaderParser,children,childrenArray,cameras,textures,materials,geometrys,vertexShaders,fragmentShaders,updateList,baseLightRotate;children={},childrenArray={},cameras={},baseLightRotate={},textures={},materials={},geometrys={},vertexShaders={},fragmentShaders={},updateList={},$setPrivate("Scene",{children:children,
        childrenArray:childrenArray}),vertexShaderParser=makeUtil.vertexShaderParser,fragmentShaderParser=makeUtil.fragmentShaderParser;return MoGL.extend({value:function Scene(){children[this]={},childrenArray[this]=[],cameras[this]={},textures[this]={},materials[this]={},geometrys[this]={},vertexShaders[this]={},fragmentShaders[this]={},updateList[this]={mesh:[],material:[],camera:[]},baseLightRotate[this]=[0,-1,-1];this.addVertexShader(Shader.colorVertexShader),this.addFragmentShader(Shader.colorFragmentShader),
        this.addVertexShader(Shader.wireFrameVertexShader),this.addFragmentShader(Shader.wireFrameFragmentShader),this.addVertexShader(Shader.bitmapVertexShader),this.addFragmentShader(Shader.bitmapFragmentShader),this.addVertexShader(Shader.bitmapVertexShaderGouraud),this.addFragmentShader(Shader.bitmapFragmentShaderGouraud),this.addVertexShader(Shader.colorVertexShaderGouraud),this.addFragmentShader(Shader.colorFragmentShaderGouraud),this.addVertexShader(Shader.colorVertexShaderPhong),this.addFragmentShader(Shader.colorFragmentShaderPhong),
        this.addVertexShader(Shader.toonVertexShaderPhong),this.addFragmentShader(Shader.toonFragmentShaderPhong),this.addVertexShader(Shader.bitmapVertexShaderPhong),this.addFragmentShader(Shader.bitmapFragmentShaderPhong),this.addVertexShader(Shader.bitmapVertexShaderBlinn),this.addFragmentShader(Shader.bitmapFragmentShaderBlinn),this.addVertexShader(Shader.postBaseVertexShader),this.addFragmentShader(Shader.postBaseFragmentShader)}}).field("updateList",{get:$getter(updateList)}).field("vertexShaders",
        {get:$getter(vertexShaders)}).field("fragmentShaders",{get:$getter(fragmentShaders)}).field("baseLightRotate",{set:$setter(baseLightRotate),get:$getter(baseLightRotate)}).field("cameras",{get:$getter(cameras)}).field("children",{get:$getter(children)}).method("addMesh",{value:function(v){var p=children[this],p2=updateList[this],mat;if(p[v])this.error(0);if(!(v instanceof Mesh))this.error(1);p[v]=v;p2.mesh.push(v);mat=v.material;mat.addEventListener(Material.load,function(){var t=this.diffuse;if(t){var i=
            t.length;while(i--)if(p2.material.indexOf(t[i].tex)==-1)p2.material.push(t[i].tex)}});v.addEventListener(Mesh.changed,function(){p2.mesh.push(v)});mat.dispatch(Material.load,mat);if(childrenArray[this].indexOf(v)==-1)childrenArray[this].push(v);return this}}).method("addCamera",{value:function addCamera(v){var p=cameras[this];if(p[v])this.error(0);if(!(v instanceof Camera))this.error(1);p[v]=v;updateList[this].camera.push(v);return this}}).method("addChild",{value:function addChild(v){if(v instanceof
            Mesh)this.addMesh(v);else if(v instanceof Camera)this.addCamera(v);else this.error(0);return this}}).method("addGeometry",{value:function(v){var p=geometrys[this];if(p[v])this.error(0);if(!(v instanceof Geometry))this.error(1);p[v]=v;return this}}).method("addMaterial",{value:function addMaterial(v){var p=materials[this];if(p[v])this.error(0);if(!(v instanceof Material))this.error(1);p[v]=v;return this}}).method("addTexture",{value:function addTexture(v){var p=textures[this];if(p[v])this.error(0);
            if(!(v instanceof Texture))this.error(1);p[v]=v;return this}}).method("addFragmentShader",{value:function addFragmentShader(v){var p=fragmentShaders[this];if(p[v.code.id])this.error(0);p[v.code.id]=fragmentShaderParser(v);return this}}).method("addVertexShader",{value:function addVertexShader(v){var p=vertexShaders[this];if(p[v.code.id])this.error(0);p[v.code.id]=vertexShaderParser(v);return this}}).method("getMesh",{value:function getMesh(id){var p=children[this],k;for(k in p)if(p[k].id==id)return p[k];
            return null}}).method("getCamera",{value:function getCamera(id){var p=cameras[this],k;for(k in p)if(p[k].id==id)return p[k];return null}}).method("getChild",{value:function getChild(id){var t;if(t=this.getMesh(id))return t;if(t=this.getCamera(id))return t;return null}}).method("getGeometry",{value:function getGeometry(id){var p=geometrys[this],k;for(k in p)if(p[k].id==id)return p[k];return null}}).method("getMaterial",{value:function getMaterial(id){var p=materials[this],k;for(k in p)if(p[k].id==
            id)return p[k];return null}}).method("getTexture",{value:function getTexture(id){var p=textures[this],k;for(k in p)if(p[k].id==id)return p[k];return null}}).method("removeChild",{value:function removeChild(id){var p,k,result;p=children[this],result=false;for(k in p)if(p[k].id==id){childrenArray[this].splice(childrenArray[this].indexOf(p[k]),1);delete p[k],result=true}return result}}).method("removeGeometry",{value:function removeGeometry(id){var p,k,result;p=geometrys[this],result=false;for(k in p)if(p[k].id==
            id)delete p[k],result=true;return result}}).method("removeMaterial",{value:function removeMaterial(id){var p,k,result;p=materials[this],result=false;for(k in p)if(p[k].id==id)delete p[k],result=true;return result}}).method("removeTexture",{value:function removeTexture(id){var p,result;p=textures[this],result=false;if(p[id])delete p[id],result=true;return result}}).build()}();var World=function(makeUtil){var getGL,glSetting,glContext,rectMatrix=Matrix();var makeVBO,makeVNBO,makeIBO,makeUVBO,makeProgram,
        makeTexture,makeFrameBuffer;var baseUpdate,baseShaderUpdate,cameraRenderAreaUpdate;glSetting={alpha:true,depth:true,stencil:false,antialias:true,premultipliedAlpha:true,preserveDrawingBuffer:false},getGL=function(canvas){var gl,keys,i;if(glContext)gl=canvas.getContext(glContext,glSetting);else{keys="experimental-webgl,webgl,webkit-3d,moz-webgl,3d".split(","),i=keys.length;while(i--)if(gl=canvas.getContext(keys[i],glSetting)){glContext=keys[i];break}}return gl};var renderList={},sceneList=[],cvsList=
    {},autoSizer={},started={},gpu={};makeVBO=makeUtil.makeVBO,makeVNBO=makeUtil.makeVNBO,makeIBO=makeUtil.makeIBO,makeUVBO=makeUtil.makeUVBO,makeProgram=makeUtil.makeProgram,makeTexture=makeUtil.makeTexture,makeFrameBuffer=makeUtil.makeFrameBuffer,baseUpdate=function(gpu){makeVBO(gpu,"null",[0,0,0],3);if(!gpu.vbo["_FRAMERECT_"])makeVBO(gpu,"_FRAMERECT_",[-1,1,0,1,1,0,-1,-1,0,1,-1,0],3),makeUVBO(gpu,"_FRAMERECT_",[0,0,1,0,0,1,1,1],2),makeIBO(gpu,"_FRAMERECT_",[0,1,2,1,2,3],1)},baseShaderUpdate=function(gpu,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            scene){var vS,fS;vS=scene.vertexShaders;fS=scene.fragmentShaders;makeProgram(gpu,"color",vS.colorVertexShader,fS.colorFragmentShader);makeProgram(gpu,"wireFrame",vS.wireFrameVertexShader,fS.wireFrameFragmentShader);makeProgram(gpu,"bitmap",vS.bitmapVertexShader,fS.bitmapFragmentShader);makeProgram(gpu,"bitmapGouraud",vS.bitmapVertexShaderGouraud,fS.bitmapFragmentShaderGouraud);makeProgram(gpu,"colorGouraud",vS.colorVertexShaderGouraud,fS.colorFragmentShaderGouraud);makeProgram(gpu,"colorPhong",vS.colorVertexShaderPhong,
        fS.colorFragmentShaderPhong);makeProgram(gpu,"toonPhong",vS.toonVertexShaderPhong,fS.toonFragmentShaderPhong);makeProgram(gpu,"bitmapPhong",vS.bitmapVertexShaderPhong,fS.bitmapFragmentShaderPhong);makeProgram(gpu,"bitmapBlinn",vS.bitmapVertexShaderBlinn,fS.bitmapFragmentShaderBlinn);makeProgram(gpu,"postBase",vS.postBaseVertexShader,fS.postBaseFragmentShader)},cameraRenderAreaUpdate=function(self){var p,p2,k,k2;p=sceneList[self];for(k in p){p2=p[k].cameras;for(k2 in p2){var camera,tRenderArea,cvs,
        pixelRatio;camera=p2[k2],cvs=cvsList[self];tRenderArea=camera.renderArea;pixelRatio=window.devicePixelRatio;if(tRenderArea&&!camera.renderArea.byAutoArea){var tw,th;tw=cvs.width,th=cvs.height;var wRatio=tRenderArea[2]/tw;var hRatio=tRenderArea[3]/th;tRenderArea=[typeof tRenderArea[0]=="string"?tw*tRenderArea[0].replace("%","")*.01:tRenderArea[0],typeof tRenderArea[1]=="string"?th*tRenderArea[1].replace("%","")*.01:tRenderArea[1],typeof tRenderArea[2]=="string"?tw*tRenderArea[2].replace("%","")*.01:
        tRenderArea[2],typeof tRenderArea[3]=="string"?th*tRenderArea[3].replace("%","")*.01:tRenderArea[3]];camera.renderArea=[tRenderArea[0],tRenderArea[1],tw*wRatio,th*hRatio];camera.renderArea.byAutoArea=false}else{camera.renderArea=[0,0,cvs.width,cvs.height];camera.renderArea.byAutoArea=true}camera.resetProjectionMatrix();makeFrameBuffer(gpu[self],camera,cvs)}}};return MoGL.extend("World",{value:function World(id){if(!id)this.error(0);cvsList[this]=document.getElementById(id);gpu[this]={gl:null,vbo:{},
        vnbo:{},uvbo:{},ibo:{},programs:{},textures:{},framebuffers:{}};if(!cvsList[this])this.error(1);if(gpu[this].gl=getGL(cvsList[this]))renderList[this]={},sceneList[this]=[],autoSizer[this]=null;else this.error(2)}}).method("setAutoSize",{value:function setAutoSize(isAutoSize){var canvas,scenes,self;if(isAutoSize){if(!this._autoSizer)self=this,canvas=cvsList[this],scenes=sceneList[this],autoSizer[this]=function(){var width,height,pixelRatio,k;width=window.innerWidth,height=window.innerHeight,pixelRatio=
        window.devicePixelRatio,canvas.width=width*pixelRatio,canvas.height=height*pixelRatio,canvas.style.width=width+"px",canvas.style.height=height+"px",canvas._autoSize=isAutoSize,cameraRenderAreaUpdate(self)};window.addEventListener("resize",autoSizer[this]),window.addEventListener("orientationchange",autoSizer[this]);autoSizer[this]()}else if(autoSizer[this])window.removeEventListener("resize",autoSizer[this]),window.removeEventListener("orientationchange",autoSizer[this]);return this}}).method("addScene",
        {value:function addScene(scene){var tSceneList,i;tSceneList=sceneList[this],i=tSceneList.length;if(!(scene instanceof Scene))this.error(1);console.log(tSceneList);while(i--)if(tSceneList[i]==scene)this.error(0);tSceneList.push(scene);var p=gpu[this];baseUpdate(p),baseShaderUpdate(p,scene),cameraRenderAreaUpdate(this);return this}}).method("getScene",{value:function getScene(sceneID){var i,tSceneList;tSceneList=sceneList[this],i=tSceneList.length;if(typeof sceneID==="undefined")return null;while(i--)if(tSceneList[i].id==
            sceneID)return tSceneList[i];return null}}).method("getRenderer",{value:function getRenderer(isRequestAnimationFrame){var p,self;p=renderList[this];if(!p)p={};self=this;if(isRequestAnimationFrame)if(p[1])return p[1];else return p[1]=function requestAni(currentTime){self.render(currentTime);started[self.uuid]=requestAnimationFrame(p[1])};else if(p[0])return p[0];else{p[0]=function intervalAni(currentTime){self.render(currentTime)};return p[0]}}}).method("start",{value:function start(){var renderFunc=
            this.getRenderer(1);started[this.uuid]=requestAnimationFrame(renderFunc);return this}}).method("stop",{value:function stop(){cancelAnimationFrame(started[this.uuid]);return this}}).method("removeScene",{value:function removeScene(sceneID){var i,tSceneList;tSceneList=sceneList[this],i=tSceneList.length;if(typeof sceneID==="undefined")return null;while(i--)if(tSceneList[i].id==sceneID){tSceneList.splice(i,1),console.log(sceneList);return this}this.error("0")}}).method("render",{value:function render(){var i,
            i2,j,k,len=0;var f3=new Float32Array(3),f4=new Float32Array(4);var tScene,tSceneList,tCameraList,tCamera,tGPU,tGL,tChildren,tChildrenArray;var tCvs,tCvsW,tCvsH;var tItem,tMaterial;var tProgram,tCulling,tVBO,tVNBO,tUVBO,tIBO,tDiffuseID,tFrameBuffer,tShading;var pProgram,pCulling,pVBO,pVNBO,pUVBO,pIBO,pDiffuseID;var tMatUUID;var privateChildren;var privateChildrenArray;var priGeo;var priMat;var priCull;var priMatColor;var priMatWireFrame;var priMatWireFrameColor;var priMatShading;var priMatLambert;
            var priMatDiffuse;var tGeo;var tItemUUID;var baseLightRotate,useNormalBuffer,useTexture;var tColor;privateChildren=$getPrivate("Scene","children"),privateChildrenArray=$getPrivate("Scene","childrenArray"),priGeo=$getPrivate("Mesh","geometry"),priMat=$getPrivate("Mesh","material"),priCull=$getPrivate("Mesh","culling"),priMatColor=$getPrivate("Material","color"),priMatWireFrame=$getPrivate("Material","wireFrame"),priMatWireFrameColor=$getPrivate("Material","wireFrameColor"),priMatShading=$getPrivate("Material",
                "shading"),priMatLambert=$getPrivate("Material","lambert"),priMatDiffuse=$getPrivate("Material","diffuse");return function(currentTime){len=0,pProgram=null,pCulling=null,pVBO=null,pVNBO=null,pUVBO=null,pIBO=null,pDiffuseID=null,tCvs=cvsList[this.uuid],tSceneList=sceneList[this.uuid],tGPU=gpu[this.uuid],tGL=tGPU.gl,tCvsW=tCvs.width,tCvsH=tCvs.height,i=tSceneList.length;this.dispatch(World.renderBefore,currentTime);while(i--){tScene=tSceneList[i];j=tScene.updateList.mesh.length;while(j--){var updateItem,
                geo;updateItem=tScene.updateList.mesh[j],geo=updateItem.geometry;if(geo)if(!tGPU.vbo[geo])makeVBO(tGPU,geo,geo.position,3),makeVNBO(tGPU,geo,geo.normal,3),makeUVBO(tGPU,geo,geo.uv,2),makeIBO(tGPU,geo,geo.index,1)}j=tScene.updateList.material.length;while(j--)makeTexture(tGPU,tScene.updateList.material[j]);if(tScene.updateList.camera.length)cameraRenderAreaUpdate(this);tScene.updateList.mesh.length=0,tScene.updateList.material.length=0,tScene.updateList.camera.length=0,tCameraList=tScene.cameras,baseLightRotate=
                tScene.baseLightRotate;for(k in tCameraList)len++;for(k in tCameraList){tCamera=tCameraList[k];if(tCamera.visible){if(len>1){tFrameBuffer=tGPU.framebuffers[tCamera.uuid].frameBuffer;tGL.bindFramebuffer(tGL.FRAMEBUFFER,tFrameBuffer);tGL.viewport(0,0,tFrameBuffer.width,tFrameBuffer.height)}else tGL.viewport(0,0,tCvsW,tCvsH);tChildren=privateChildren[tScene.uuid];tChildrenArray=privateChildrenArray[tScene.uuid];tGL.enable(tGL.DEPTH_TEST),tGL.depthFunc(tGL.LESS),tGL.enable(tGL.BLEND),tGL.blendFunc(tGL.SRC_ALPHA,
                tGL.ONE_MINUS_SRC_ALPHA),tColor=tCamera.backgroundColor,tGL.clearColor(tColor[0],tColor[1],tColor[2],tColor[3]),tGL.clear(tGL.COLOR_BUFFER_BIT|tGL.DEPTH_BUFFER_BIT);var tProjectionMtx=tCamera.projectionMatrix.raw;var tCameraMtx=tCamera.matrix.raw;for(k in tGPU.programs){tProgram=tGPU.programs[k],tGL.useProgram(tProgram),tGL.uniformMatrix4fv(tProgram.uPixelMatrix,false,tProjectionMtx),tGL.uniformMatrix4fv(tProgram.uCameraMatrix,false,tCameraMtx);if(tProgram["uDLite"])tGL.uniform3fv(tProgram.uDLite,
                baseLightRotate)}tItem=tMaterial=tProgram=tVBO=tIBO=null;i2=tChildrenArray.length;while(i2--){tItem=tChildrenArray[i2],tItemUUID=tItem.uuid,tGeo=priGeo[tItemUUID].uuid,tVBO=tGPU.vbo[tGeo],tVNBO=tGPU.vnbo[tGeo],tUVBO=tGPU.uvbo[tGeo],tIBO=tGPU.ibo[tGeo],tMaterial=priMat[tItemUUID],tCulling=priCull[tItemUUID];if(tCulling!=pCulling)if(tCulling==Mesh.cullingNone)tGL.disable(tGL.CULL_FACE);else if(tCulling==Mesh.cullingBack)tGL.enable(tGL.CULL_FACE),tGL.frontFace(tGL.CCW);else if(tCulling==Mesh.cullingFront)tGL.enable(tGL.CULL_FACE),
                tGL.frontFace(tGL.CW);useNormalBuffer=0,useTexture=0;tMatUUID=tMaterial.uuid,tShading=priMatShading[tMatUUID];if(priMatDiffuse[tMatUUID])useTexture=1;switch(tShading){case Shading.none:if(useTexture)tProgram=tGPU.programs["bitmap"];else tProgram=tGPU.programs["color"];break;case Shading.gouraud:if(useTexture)tProgram=tGPU.programs["bitmapGouraud"];else tProgram=tGPU.programs["colorGouraud"];useNormalBuffer=1;break;case Shading.toon:tProgram=tGPU.programs["toonPhong"];useNormalBuffer=1;break;case Shading.phong:if(useTexture)tProgram=
                tGPU.programs["bitmapPhong"];else tProgram=tGPU.programs["colorPhong"];useNormalBuffer=1;break;case Shading.blinn:tProgram=tGPU.programs["bitmapBlinn"],useNormalBuffer=1;break}if(pProgram!=tProgram)pProgram=null,pVBO=null,pVNBO=null,pUVBO=null,pIBO=null,tGL.useProgram(tProgram);if(tVBO!=pVBO)tGL.bindBuffer(tGL.ARRAY_BUFFER,tVBO),tGL.vertexAttribPointer(tProgram.aVertexPosition,tVBO.stride,tGL.FLOAT,false,0,0);tColor=priMatColor[tMatUUID],tGL.uniform4fv(tProgram.uColor,tColor);if(useNormalBuffer){if(tVNBO!=
                pVNBO)tGL.bindBuffer(tGL.ARRAY_BUFFER,tVNBO),tGL.vertexAttribPointer(tProgram.aVertexNormal,tVNBO.stride,tGL.FLOAT,false,0,0);tGL.uniform1f(tProgram.uLambert,priMatLambert[tMatUUID])}if(useTexture){if(tUVBO!=pUVBO)tGL.bindBuffer(tGL.ARRAY_BUFFER,tUVBO),tGL.vertexAttribPointer(tProgram.aUV,tUVBO.stride,tGL.FLOAT,false,0,0);var imsi=priMatDiffuse[tMatUUID];if(imsi.length){tDiffuseID=tGPU.textures[imsi[imsi.length-1].tex.uuid];if(tDiffuseID!=pDiffuseID)tGL.bindTexture(tGL.TEXTURE_2D,tDiffuseID);tGL.uniform1i(tProgram.uSampler,
                0)}}f3[0]=tItem.rotateX,f3[1]=tItem.rotateY,f3[2]=tItem.rotateZ,tGL.uniform3fv(tProgram.uRotate,f3),f3[0]=tItem.x,f3[1]=tItem.y,f3[2]=tItem.z,tGL.uniform3fv(tProgram.uPosition,f3),f3[0]=tItem.scaleX,f3[1]=tItem.scaleY,f3[2]=tItem.scaleZ,tGL.uniform3fv(tProgram.uScale,f3),tIBO!=pIBO?tGL.bindBuffer(tGL.ELEMENT_ARRAY_BUFFER,tIBO):0,tGL.drawElements(tGL.TRIANGLES,tIBO.numItem,tGL.UNSIGNED_SHORT,0);if(priMatWireFrame[tMatUUID])tGL.enable(tGL.DEPTH_TEST),tGL.depthFunc(tGL.LEQUAL),tProgram=tGPU.programs["wireFrame"],
                tGL.useProgram(tProgram),tVBO!=pVBO?tGL.bindBuffer(tGL.ARRAY_BUFFER,tVBO):0,tVBO!=pVBO?tGL.vertexAttribPointer(tProgram.aVertexPosition,tVBO.stride,tGL.FLOAT,false,0,0):0,f3[0]=tItem.rotateX,f3[1]=tItem.rotateY,f3[2]=tItem.rotateZ,tGL.uniform3fv(tProgram.uRotate,f3),f3[0]=tItem.x,f3[1]=tItem.y,f3[2]=tItem.z,tGL.uniform3fv(tProgram.uPosition,f3),f3[0]=tItem.scaleX,f3[1]=tItem.scaleY,f3[2]=tItem.scaleZ,tGL.uniform3fv(tProgram.uScale,f3),tColor=priMatWireFrameColor[tMatUUID],tGL.uniform4fv(tProgram.uColor,
                tColor),tGL.drawElements(tGL.LINES,tIBO.numItem,tGL.UNSIGNED_SHORT,0),tGL.enable(tGL.DEPTH_TEST),tGL.depthFunc(tGL.LESS);pProgram=tProgram,pCulling=tCulling,pVBO=tVBO,pVNBO=tVNBO,pUVBO=tUVBO,pIBO=tIBO,pDiffuseID=tDiffuseID}if(len>1){tGL.bindFramebuffer(tGL.FRAMEBUFFER,null);pProgram=null,pVBO=null,pVNBO=null,pUVBO=null,pIBO=null}}}}if(len>1){tGL.viewport(0,0,tCvs.width,tCvs.height);tGL.clearColor(0,0,0,1);tGL.enable(tGL.DEPTH_TEST),tGL.depthFunc(tGL.LEQUAL);tGL.enable(tGL.BLEND);tGL.blendFunc(tGL.SRC_ALPHA,
                tGL.ONE_MINUS_SRC_ALPHA);tGL.clear(tGL.COLOR_BUFFER_BIT|tGL.DEPTH_BUFFER_BIT);tVBO=tGPU.vbo["_FRAMERECT_"],tUVBO=tGPU.uvbo["_FRAMERECT_"],tIBO=tGPU.ibo["_FRAMERECT_"],tProgram=tGPU.programs["postBase"];if(!tVBO)return;tGL.useProgram(tProgram);tGL.uniformMatrix4fv(tProgram.uPixelMatrix,false,[2/tCvs.clientWidth,0,0,0,0,-2/tCvs.clientHeight,0,0,0,0,0,0,-1,1,0,1]);tGL.bindBuffer(tGL.ARRAY_BUFFER,tVBO),tGL.vertexAttribPointer(tProgram.aVertexPosition,tVBO.stride,tGL.FLOAT,false,0,0),tGL.bindBuffer(tGL.ARRAY_BUFFER,
                tUVBO),tGL.vertexAttribPointer(tProgram.aUV,tUVBO.stride,tGL.FLOAT,false,0,0),tGL.uniform3fv(tProgram.uRotate,[0,0,0]),tGL.uniformMatrix4fv(tProgram.uCameraMatrix,false,rectMatrix.raw);for(k in tCameraList){tCamera=tCameraList[k];if(tCamera.visible){tFrameBuffer=tGPU.framebuffers[tCamera.uuid].frameBuffer;tGL.uniform1i(tProgram.uFXAA,tCamera.antialias);if(tCamera.antialias)if(tCamera.renderArea)tGL.uniform2fv(tProgram.uTexelSize,[1/tFrameBuffer.width,1/tFrameBuffer.height]);else tGL.uniform2fv(tProgram.uTexelSize,
                [1/tCvs.width,1/tCvs.height]);f3[0]=tFrameBuffer.x+tFrameBuffer.width/2/window.devicePixelRatio,f3[1]=tFrameBuffer.y+tFrameBuffer.height/2/window.devicePixelRatio,f3[2]=0;tGL.uniform3fv(tProgram.uPosition,f3),f3[0]=tFrameBuffer.width/2/window.devicePixelRatio,f3[1]=tFrameBuffer.height/2/window.devicePixelRatio,f3[2]=1,tGL.uniform3fv(tProgram.uScale,f3),tGL.bindTexture(tGL.TEXTURE_2D,tGPU.framebuffers[tCamera.uuid].texture),tGL.uniform1i(tProgram.uSampler,0),tGL.bindBuffer(tGL.ELEMENT_ARRAY_BUFFER,
                tIBO),tGL.drawElements(tGL.TRIANGLES,tIBO.numItem,tGL.UNSIGNED_SHORT,0)}}}this.dispatch(World.renderAfter,currentTime)}}()}).constant("renderBefore",{value:"WORLD_RENDER_BEFORE"}).constant("renderAfter",{value:"WORLD_RENDER_AFTER"}).build()}(makeUtil);window["MoGL"]=MoGL})();if(this.hasOwnProperty("exports"))exports.mogl=MoGL;