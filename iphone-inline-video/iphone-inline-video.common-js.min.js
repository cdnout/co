"use strict";var intervalometer=require("intervalometer");function preventEvent(r,t,n){function e(e){n&&!n(r,t)||e.stopImmediatePropagation()}return r.addEventListener(t,e),e}function proxyProperty(e,r,t,n){function i(e){t[r]=e}n&&i(e[r]),Object.defineProperty(e,r,{get:function(){return t[r]},set:i})}function proxyEvent(e,r,t){t.addEventListener(r,function(){return e.dispatchEvent(new Event(r))})}function dispatchEventAsync(e,r){Promise.resolve().then(function(){e.dispatchEvent(new Event(r))})}var iOS8or9="object"==typeof document&&"object-fit"in document.head.style&&!matchMedia("(-webkit-video-playable-inline)").matches,IIV="bfred-it:iphone-inline-video",IIVEvent="bfred-it:iphone-inline-video:event",IIVPlay="bfred-it:iphone-inline-video:nativeplay",IIVPause="bfred-it:iphone-inline-video:nativepause";function getAudioFromVideo(e){var r=new Audio;return proxyEvent(e,"play",r),proxyEvent(e,"playing",r),proxyEvent(e,"pause",r),r.crossOrigin=e.crossOrigin,r.src=e.src||e.currentSrc||"data:",r}var lastTimeupdateEvent,lastRequests=[],requestIndex=0;function setTime(e,r,t){(lastTimeupdateEvent||0)+200<Date.now()&&(e[IIVEvent]=!0,lastTimeupdateEvent=Date.now()),t||(e.currentTime=r),lastRequests[++requestIndex%3]=100*r|0}function isPlayerEnded(e){return e.driver.currentTime>=e.video.duration}function update(e){var r=this;r.video.readyState>=r.video.HAVE_FUTURE_DATA?(r.hasAudio||(r.driver.currentTime=r.video.currentTime+e*r.video.playbackRate/1e3,r.video.loop&&isPlayerEnded(r)&&(r.driver.currentTime=0)),setTime(r.video,r.driver.currentTime)):r.video.networkState===r.video.NETWORK_IDLE&&0===r.video.buffered.length&&r.video.load(),r.video.ended&&(delete r.video[IIVEvent],r.video.pause(!0))}function play(){var e=this,r=e[IIV];e.webkitDisplayingFullscreen?e[IIVPlay]():("data:"!==r.driver.src&&r.driver.src!==e.src&&(setTime(e,0,!0),r.driver.src=e.src),e.paused&&(r.paused=!1,0===e.buffered.length&&e.load(),r.driver.play(),r.updater.start(),r.hasAudio||(dispatchEventAsync(e,"play"),r.video.readyState>=r.video.HAVE_ENOUGH_DATA&&dispatchEventAsync(e,"playing"))))}function pause(e){var r=this,t=r[IIV];t.driver.pause(),t.updater.stop(),r.webkitDisplayingFullscreen&&r[IIVPause](),t.paused&&!e||(t.paused=!0,t.hasAudio||dispatchEventAsync(r,"pause"),r.ended&&!r.webkitDisplayingFullscreen&&(r[IIVEvent]=!0,dispatchEventAsync(r,"ended")))}function addPlayer(r,t){var n={};(r[IIV]=n).paused=!0,n.hasAudio=t,n.video=r,n.updater=intervalometer.frameIntervalometer(update.bind(n)),t?n.driver=getAudioFromVideo(r):(r.addEventListener("canplay",function(){r.paused||dispatchEventAsync(r,"playing")}),n.driver={src:r.src||r.currentSrc||"data:",muted:!0,paused:!0,pause:function(){n.driver.paused=!0},play:function(){n.driver.paused=!1,isPlayerEnded(n)&&setTime(r,0)},get ended(){return isPlayerEnded(n)}}),r.addEventListener("emptied",function(){var e=!n.driver.src||"data:"===n.driver.src;n.driver.src&&n.driver.src!==r.src&&(setTime(r,0,!0),n.driver.src=r.src,e||!t&&r.autoplay?n.driver.play():n.updater.stop())},!1),r.addEventListener("webkitbeginfullscreen",function(){r.paused?t&&0===n.driver.buffered.length&&n.driver.load():(r.pause(),r[IIVPlay]())}),t&&(r.addEventListener("webkitendfullscreen",function(){n.driver.currentTime=r.currentTime}),r.addEventListener("seeking",function(){lastRequests.indexOf(100*r.currentTime|0)<0&&(n.driver.currentTime=r.currentTime)}))}function preventWithPropOrFullscreen(e){var r=e[IIVEvent];return delete e[IIVEvent],!e.webkitDisplayingFullscreen&&!r}function overloadAPI(e){var r=e[IIV];e[IIVPlay]=e.play,e[IIVPause]=e.pause,e.play=play,e.pause=pause,proxyProperty(e,"paused",r.driver),proxyProperty(e,"muted",r.driver,!0),proxyProperty(e,"playbackRate",r.driver,!0),proxyProperty(e,"ended",r.driver),proxyProperty(e,"loop",r.driver,!0),preventEvent(e,"seeking",function(e){return!e.webkitDisplayingFullscreen}),preventEvent(e,"seeked",function(e){return!e.webkitDisplayingFullscreen}),preventEvent(e,"timeupdate",preventWithPropOrFullscreen),preventEvent(e,"ended",preventWithPropOrFullscreen)}function enableInlineVideo(r,e){if(void 0===e&&(e={}),!r[IIV]){if(!e.everywhere){if(!iOS8or9)return;if(!(e.iPad||e.ipad?/iPhone|iPod|iPad/:/iPhone|iPod/).test(navigator.userAgent))return}r.pause();var t=r.autoplay;r.autoplay=!1,addPlayer(r,!r.muted),overloadAPI(r),r.classList.add("IIV"),r.muted&&t&&(r.play(),r.addEventListener("playing",function e(){r.autoplay=!0,r.removeEventListener("playing",e)})),/iPhone|iPod|iPad/.test(navigator.platform)||console.warn("iphone-inline-video is not guaranteed to work in emulated environments")}}module.exports=enableInlineVideo;