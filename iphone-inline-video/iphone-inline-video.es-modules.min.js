import{frameIntervalometer}from"intervalometer";function preventEvent(e,t,i){function r(r){i&&!i(e,t)||r.stopImmediatePropagation()}return e.addEventListener(t,r),r}function proxyProperty(e,t,i,r){function n(e){i[t]=e}r&&n(e[t]),Object.defineProperty(e,t,{get:function(){return i[t]},set:n})}function proxyEvent(e,t,i){i.addEventListener(t,function(){return e.dispatchEvent(new Event(t))})}function dispatchEventAsync(e,t){Promise.resolve().then(function(){e.dispatchEvent(new Event(t))})}var iOS8or9="object"==typeof document&&"object-fit"in document.head.style&&!matchMedia("(-webkit-video-playable-inline)").matches,IIV="bfred-it:iphone-inline-video",IIVEvent="bfred-it:iphone-inline-video:event",IIVPlay="bfred-it:iphone-inline-video:nativeplay",IIVPause="bfred-it:iphone-inline-video:nativepause";function getAudioFromVideo(e){var t=new Audio;return proxyEvent(e,"play",t),proxyEvent(e,"playing",t),proxyEvent(e,"pause",t),t.crossOrigin=e.crossOrigin,t.src=e.src||e.currentSrc||"data:",t}var lastTimeupdateEvent,lastRequests=[],requestIndex=0;function setTime(e,t,i){(lastTimeupdateEvent||0)+200<Date.now()&&(e[IIVEvent]=!0,lastTimeupdateEvent=Date.now()),i||(e.currentTime=t),lastRequests[++requestIndex%3]=100*t|0}function isPlayerEnded(e){return e.driver.currentTime>=e.video.duration}function update(e){this.video.readyState>=this.video.HAVE_FUTURE_DATA?(this.hasAudio||(this.driver.currentTime=this.video.currentTime+e*this.video.playbackRate/1e3,this.video.loop&&isPlayerEnded(this)&&(this.driver.currentTime=0)),setTime(this.video,this.driver.currentTime)):this.video.networkState===this.video.NETWORK_IDLE&&0===this.video.buffered.length&&this.video.load(),this.video.ended&&(delete this.video[IIVEvent],this.video.pause(!0))}function play(){var e=this[IIV];this.webkitDisplayingFullscreen?this[IIVPlay]():("data:"!==e.driver.src&&e.driver.src!==this.src&&(setTime(this,0,!0),e.driver.src=this.src),this.paused&&(e.paused=!1,0===this.buffered.length&&this.load(),e.driver.play(),e.updater.start(),e.hasAudio||(dispatchEventAsync(this,"play"),e.video.readyState>=e.video.HAVE_ENOUGH_DATA&&dispatchEventAsync(this,"playing"))))}function pause(e){var t=this[IIV];t.driver.pause(),t.updater.stop(),this.webkitDisplayingFullscreen&&this[IIVPause](),t.paused&&!e||(t.paused=!0,t.hasAudio||dispatchEventAsync(this,"pause"),this.ended&&!this.webkitDisplayingFullscreen&&(this[IIVEvent]=!0,dispatchEventAsync(this,"ended")))}function addPlayer(e,t){var i={};e[IIV]=i,i.paused=!0,i.hasAudio=t,i.video=e,i.updater=frameIntervalometer(update.bind(i)),t?i.driver=getAudioFromVideo(e):(e.addEventListener("canplay",function(){e.paused||dispatchEventAsync(e,"playing")}),i.driver={src:e.src||e.currentSrc||"data:",muted:!0,paused:!0,pause:function(){i.driver.paused=!0},play:function(){i.driver.paused=!1,isPlayerEnded(i)&&setTime(e,0)},get ended(){return isPlayerEnded(i)}}),e.addEventListener("emptied",function(){var r=!i.driver.src||"data:"===i.driver.src;i.driver.src&&i.driver.src!==e.src&&(setTime(e,0,!0),i.driver.src=e.src,r||!t&&e.autoplay?i.driver.play():i.updater.stop())},!1),e.addEventListener("webkitbeginfullscreen",function(){e.paused?t&&0===i.driver.buffered.length&&i.driver.load():(e.pause(),e[IIVPlay]())}),t&&(e.addEventListener("webkitendfullscreen",function(){i.driver.currentTime=e.currentTime}),e.addEventListener("seeking",function(){lastRequests.indexOf(100*e.currentTime|0)<0&&(i.driver.currentTime=e.currentTime)}))}function preventWithPropOrFullscreen(e){var t=e[IIVEvent];return delete e[IIVEvent],!e.webkitDisplayingFullscreen&&!t}function overloadAPI(e){var t=e[IIV];e[IIVPlay]=e.play,e[IIVPause]=e.pause,e.play=play,e.pause=pause,proxyProperty(e,"paused",t.driver),proxyProperty(e,"muted",t.driver,!0),proxyProperty(e,"playbackRate",t.driver,!0),proxyProperty(e,"ended",t.driver),proxyProperty(e,"loop",t.driver,!0),preventEvent(e,"seeking",function(e){return!e.webkitDisplayingFullscreen}),preventEvent(e,"seeked",function(e){return!e.webkitDisplayingFullscreen}),preventEvent(e,"timeupdate",preventWithPropOrFullscreen),preventEvent(e,"ended",preventWithPropOrFullscreen)}function enableInlineVideo(e,t){if(void 0===t&&(t={}),!e[IIV]){if(!t.everywhere){if(!iOS8or9)return;if(!(t.iPad||t.ipad?/iPhone|iPod|iPad/:/iPhone|iPod/).test(navigator.userAgent))return}e.pause();var i=e.autoplay;e.autoplay=!1,addPlayer(e,!e.muted),overloadAPI(e),e.classList.add("IIV"),e.muted&&i&&(e.play(),e.addEventListener("playing",function t(){e.autoplay=!0,e.removeEventListener("playing",t)})),/iPhone|iPod|iPad/.test(navigator.platform)||console.warn("iphone-inline-video is not guaranteed to work in emulated environments")}}export default enableInlineVideo;